<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-folder-tree"></i> Anki / AI Agent 系统</h1>
            <!-- NEW NAVIGATION BUTTONS -->
            <div class="app-nav">
                <button id="nav-anki-btn" class="app-nav-btn active">
                    <i class="fas fa-book-open"></i> Anki 笔记
                </button>
                <button id="nav-agent-btn" class="app-nav-btn">
                    <i class="fas fa-robot"></i> AI Agents
                </button>
            </div>
            <p class="subtitle">创建、组织、预览Markdown笔记, 并与AI助手互动</p>
        </header>
        
        <!-- 新增的AI Agent导航栏 -->
        <nav class="ai-agent-nav">
            <div class="nav-title">
                <i class="fas fa-robot"></i> AI Agent管理
            </div>
            <div class="agent-list">
                <div class="agent-item active" data-agent="1">
                    <div class="agent-avatar">AI</div>
                    <span>数学学习助手</span>
                </div>
                <div class="agent-item" data-agent="2">
                    <div class="agent-avatar">MD</div>
                    <span>语言学习助手</span>
                </div>
                <div class="agent-item" data-agent="3">
                    <div class="agent-avatar">CS</div>
                    <span>计算机科学助手</span>
                </div>
                <div class="agent-item">
                    <div class="agent-avatar">+</div>
                    <span>添加新Agent</span>
                </div>
            </div>
            <div class="nav-actions">
                <button class="nav-action-btn">
                    <i class="fas fa-history"></i> 历史记录
                </button>
                <button class="nav-action-btn">
                    <i class="fas fa-cog"></i> 设置
                </button>
            </div>
        </nav>
        
        <div class="audio-controls" id="audioControls">
            <div class="audio-title" id="audioTitle">音频播放</div>
            <div class="audio-progress">
                <div class="audio-progress-bar" id="audioProgress"></div>
            </div>
            <div class="audio-buttons">
                <button class="audio-btn" id="playBtn"><i class="fas fa-play"></i> 播放</button>
                <button class="audio-btn" id="pauseBtn"><i class="fas fa-pause"></i> 暂停</button>
                <button class="audio-btn" id="stopBtn"><i class="fas fa-stop"></i> 停止</button>
            </div>
        </div>
        
        <!-- AI Agent内容区域 -->
        <div class="agent-content-container">
            <div class="topics-panel">
                <div class="topics-header">
                    <i class="fas fa-book"></i> 聊天主题
                </div>
                <div class="topics-content">
                    <ul class="topic-list">
                        <li class="topic-item active">
                            <div class="topic-icon"><i class="fas fa-calculator"></i></div>
                            <span>线性代数</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-infinity"></i></div>
                            <span>微积分</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-project-diagram"></i></div>
                            <span>概率统计</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-cube"></i></div>
                            <span>几何学</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-plus-circle"></i></div>
                            <span>添加新主题</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="history-panel">
    <div class="history-header">
        <div class="history-title">
            <i class="fas fa-comments"></i>
            <span id="historyHeaderTitle">历史对话记录</span> 
        </div>
        <div class="history-header-actions">
            <button id="agentSettingsTriggerBtn" class="header-action-btn" title="当前Agent设置" style="display: none;">
                <i class="fas fa-cog"></i>
            </button>
            <input type="text" class="history-search" placeholder="搜索历史记录...">
        </div>
    </div>
                <div class="history-content">
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-15 14:30</span>
                            <span>线性代数 - 矩阵运算</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 请解释矩阵的逆是什么？</p>
                            <p><strong>AI助手:</strong> 矩阵的逆类似于数字的倒数。对于一个n×n矩阵A，如果存在另一个n×n矩阵B，使得AB = BA = I（单位矩阵），那么B就是A的逆矩阵，记作A⁻¹。只有方阵且行列式不为零的矩阵才有逆矩阵。</p>
                            <img src="https://via.placeholder.com/600x150/4361ee/ffffff?text=矩阵逆运算示例" alt="矩阵逆运算示例">
                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                    
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-14 09:15</span>
                            <span>线性代数 - 特征值与特征向量</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 特征值和特征向量有什么实际应用？</p>
                            <p><strong>AI助手:</strong> 特征值和特征向量在多个领域有广泛应用：</p>
                            <ol>
                                <li>物理学：分析振动系统的主振动模式</li>
                                <li>计算机图形学：用于图像压缩和特征提取</li>
                                <li>机器学习：主成分分析(PCA)的核心</li>
                                <li>工程学：结构稳定性分析</li>
                            </ol>
                            <p>例如，在PCA中，我们通过计算协方差矩阵的特征值和特征向量来降低数据维度。</p>
                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                    
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-12 16:45</span>
                            <span>微积分 - 极限与连续</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 请证明lim(x→0) sin(x)/x = 1</p>
                            <p><strong>AI助手:</strong> 这个重要极限可以通过几何方法或泰勒级数证明。几何证明如下：</p>
                            <p>考虑单位圆中的扇形OAB，其中OA和OB是半径，角AOB为x弧度。三角形OAB的面积小于扇形OAB的面积，后者又小于直角三角形OAC的面积（AC是切线）。</p>

                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                </div>
                <div class="chat-navigation">
                    <button id="chatNavUp" class="chat-nav-btn" title="上一轮对话"><i class="fas fa-arrow-up"></i></button>
                    <button id="chatNavDown" class="chat-nav-btn" title="下一轮对话"><i class="fas fa-arrow-down"></i></button>
                </div>
                <!-- ==================== 新增的聊天输入区域 ==================== -->
                <div class="chat-input-area">
                    <div class="attachment-preview-container" id="attachmentPreview">
                        <!-- 附件预览将动态添加到这里 -->
                        <!-- 示例: 
                        <div class="attachment-preview-item">
                            <span><i class="fas fa-file-image"></i> image_01.jpg</span>
                            <button class="remove-attachment-btn">×</button>
                        </div> 
                        -->
                    </div>
                    <div class="input-controls">
                        <textarea id="chatInput" class="chat-textarea" rows="3" placeholder="输入消息... (Shift + Enter 换行)"></textarea>
                        <!-- 隐藏的文件输入框，通过JS点击附件按钮来触发 -->
                        <input type="file" id="attachmentInput" multiple style="display: none;">
                        <button id="attachFileBtn" class="chat-action-btn" title="添加附件" onclick="document.getElementById('attachmentInput').click();">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button id="sendMessageBtn" class="chat-action-btn send" title="发送">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <!-- ==================== 聊天输入区域结束 ==================== -->
            </div>
        </div>
        
        <div class="main-layout">
            <div class="session-sidebar">
                <div class="session-header">
                    <div class="session-title">
                        <span><i class="fas fa-layer-group"></i> 会话管理</span>
                    </div>
                    <div class="session-controls">
                        <button id="newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                        <button id="newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                        <button id="openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                        <button id="moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                        <button id="deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="select-controls">
                        <label class="select-all">
                            <input type="checkbox" id="selectAllCheckbox"> 全选
                        </label>
                    </div>
                    <div class="current-folder" id="currentFolderContainer"></div>
                </div>
                <div class="session-content">
                    <div class="session-list-container">
                        <ul class="session-list" id="sessionList"></ul>
                        <div class="empty-session" id="emptySession">
                            <i class="fas fa-folder-open"></i>
                            <p>没有打开的会话</p>
                            <p>点击"新建文件"或"打开文件"开始</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="app-container">
                <div class="panel" id="editorPanel">
                    <div class="editor-toolbar">
                        <div class="toolbar-left">
                            <button id="toggleSessionBtn" class="editor-btn" title="显示/隐藏会话栏"><i class="fas fa-arrow-left"></i></button>
                            <button id="toggleEditorBtn" class="editor-btn" title="收起编辑器"><i class="fas fa-chevron-up"></i></button>
                        </div>
                        <div class="toolbar-middle">
                            <button id="clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
                            <button id="boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
                            <button id="italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
                            <!-- [MODIFIED] 新增按钮 -->
                            <button id="insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
                            <button id="codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
                            <button id="linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
                            <button id="audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
                        </div>
                        <div class="toolbar-right">
                            <button id="saveBtn" class="editor-btn editor-btn-text" title="保存"><i class="fas fa-save"></i> 保存</button>
                            <button id="exportFileBtn" class="editor-btn editor-btn-text" title="导出"><i class="fas fa-download"></i> 导出</button>
                            <button id="helpBtn" class="editor-btn editor-btn-text" title="帮助"><i class="fas fa-question-circle"></i> 帮助</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="editor-container">
                            <textarea id="editor" class="editor"># Anki MD管理系统

## 使用说明

### 目录结构
- 创建目录来组织您的会话
- 在目录中创建文件
- 将文件移动到不同的目录

### 操作指南
1. 点击"新建目录"按钮创建新目录
2. 选择一个目录后，新建的文件会自动放入该目录
3. 使用移动按钮将项目移动到其他目录
4. 选中目录时会选中其下所有内容
5. 删除目录时会删除其下所有内容

### 数学公式示例
行内公式：\\( E = mc^2 \\)

块级公式：
\\[ 
x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} 
\\]

### Cloze 记忆卡片
牛顿第二定律：--\\( F = ma \\)--
量子力学基础：--\\( \psi = \psi(x,t) \\)--
相对论：--\\( E = \gamma m c^2 \\)--
电磁学：--\\( \nabla \times \mathbf{B} = \mu_0 \mathbf{J} + \mu_0 \epsilon_0 \frac{\partial \mathbf{E}}{\partial t} \\)--</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><i class="fas fa-eye"></i> 预览</div>
                        <div class="panel-actions">
            <!-- 新的合并后的按钮 -->
            <button id="toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏">
                <i class="fas fa-eye-slash"></i>
            </button>
            <button id="invertClozeBtn" class="panel-btn" title="反向显示/隐藏">
                <i class="fas fa-exchange-alt"></i>
            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div id="preview"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
             <h2><i class="fas fa-info-circle"></i> 使用说明</h2>
            <div class="instructions-grid">
                <div class="instruction-card">
                    <h3><i class="fas fa-folder"></i> 目录管理</h3>
                    <p>• <strong>新建目录</strong>：点击文件夹+图标创建新目录<br>
                    • <strong>选择目录</strong>：点击目录名称设为当前目录<br>
                    • <strong>移动项目</strong>：使用移动按钮将项目移动到其他目录<br>
                    • <strong>删除目录</strong>：删除目录会同时删除其下所有内容</p>
                </div>
                
                <div class="instruction-card">
                    <h3><i class="fas fa-file"></i> 文件管理</h3>
                    <p>• <strong>新建文件</strong>：在当前目录下创建新文件<br>
                    • <strong>打开文件</strong>：导入外部文件到当前目录<br>
                    • <strong>移动文件</strong>：可将文件移动到其他目录<br>
                    • <strong>编辑内容</strong>：点击文件名称编辑其内容</p>
                </div>
                
                <div class="instruction-card">
                    <h3><i class="fas fa-check-square"></i> 批量操作</h3>
                    <p>• <strong>全选</strong>：选中所有可见项目<br>
                    • <strong>目录选择</strong>：选中目录会自动选中其下所有内容<br>
                    • <strong>批量删除</strong>：删除所有选中的项目<br>
                    • <strong>跨目录操作</strong>：可同时选择不同目录下的项目</p>
                </div>
                
                <div class="instruction-card">
                    <h3><i class="fas fa-edit"></i> 编辑器工具</h3>
                    <p>• <strong>转换为Cloze</strong>：将选中文本转换为记忆卡片<br>
                    • <strong>格式工具</strong>：支持加粗、斜体、代码块等格式<br>
                    • <strong>保存/导出</strong>：保存当前内容或导出为Markdown文件<br>
                    • <strong>收起/展开</strong>：优化工作区空间管理</p>
                </div>
            </div>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept=".md, .txt">
        
        <div class="move-modal" id="moveModal">
            <div class="move-modal-content">
                <div class="move-modal-header">
                    <div class="move-modal-title">移动到目录</div>
                    <button class="move-modal-close" id="closeMoveModalBtn">×</button>
                </div>
                <p>请选择目标目录：</p>
                <div class="folder-list" id="folderList"></div>
                <div class="move-modal-actions">
                    <button class="move-modal-btn cancel" id="cancelMoveBtn">取消</button>
                    <button class="move-modal-btn confirm" id="confirmMoveBtn">确认移动</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2024 Anki MD管理系统 | 数据保存在浏览器本地存储中</p>
        </div>
    </div>

    <script type="module" src="/src/main.js"></script>
    <!-- ====================================================== -->
    <!--          AGENT SETTINGS MODAL (Initially Hidden)       -->
    <!-- ====================================================== -->
    <div class="modal-overlay" id="agentSettingsModal" style="display: none;">
        <div class="modal-content agent-settings-modal">
            <div class="modal-header">
                <h2 id="agentSettingsModalTitle">Agent 设置</h2>
                <button class="modal-close" id="agentSettingsCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <form id="agentSettingsForm" novalidate>
                    <input type="hidden" id="agentSettingsId">

                    <div class="form-group">
                        <label for="agentSettingsName">Agent名 (内部标识) <i class="fas fa-info-circle" title="唯一标识，仅限字母、数字、下划线。"></i></label>
                        <input type="text" id="agentSettingsName" class="form-control" required pattern="[a-zA-Z0-9_]+">
                        <div class="invalid-feedback">名称已被使用或格式不正确。</div>
                    </div>

                    <div class="form-group">
                        <label for="agentSettingsDisplayName">会话显示名</label>
                        <input type="text" id="agentSettingsDisplayName" class="form-control" required>
                    </div>
                    <!-- 新增 Avatar 输入框 -->
                    <div class="form-group">
                        <label for="agentSettingsAvatar">头像 (2个字符)</label>
                        <input type="text" id="agentSettingsAvatar" class="form-control" required maxlength="2" placeholder="例如：AI, 数, 语">
                    </div>
                    <hr>

                    <h4>模型配置</h4>

                    <div class="form-group">
                        <label for="agentSettingsProvider">提供商</label>
                        <select id="agentSettingsProvider" class="form-control" required>
                            <!-- 选项将由JS动态填充 -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="agentSettingsApiPath">API 地址</label>
                        <input type="url" id="agentSettingsApiPath" class="form-control">
                    </div>
                    
                    <div class="form-group api-key-group">
                        <label for="agentSettingsApiKey">API Key</label>
                        <div class="input-group">
                            <input type="password" id="agentSettingsApiKey" class="form-control">
                            <button type="button" id="toggleApiKeyVisibility" class="input-group-btn" title="显示/隐藏"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="agentSettingsModel">模型名</label>
                        <select id="agentSettingsModel" class="form-control" required>
                            <!-- 选项将由JS动态填充 -->
                        </select>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="agentSettingsIsLocal" class="form-check-input">
                        <label for="agentSettingsIsLocal">这是一个本地推理模型 (无需API Key)</label>
                    </div>

                    <hr>

                    <h4>危险操作区</h4>
                    <button type="button" class="btn-danger" id="deleteAgentBtn"><i class="fas fa-trash"></i> 删除此 Agent</button>
                    <div class="delete-confirm-zone" style="display:none;">
                        <p>请输入Agent名 "<b><span id="agentNameToConfirm"></span></b>" 以确认删除：</p>
                        <input type="text" id="deleteConfirmInput" class="form-control">
                        <button type="button" class="btn-danger" id="finalDeleteBtn" disabled>我已了解后果，永久删除</button>
                    </div>
                    <hr>
                    <h4>Agent 行为设定</h4>
                    <div class="form-group">
                        <label for="agentSettingsSystemPrompt">System Prompt (系统提示词)</label>
                        <textarea id="agentSettingsSystemPrompt" class="form-control" rows="5" placeholder="定义Agent的角色和行为，例如：你是一个专业的数学学习助手..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="agentSettingsCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="agentSettingsSaveBtn" form="agentSettingsForm">保存更改</button>
            </div>
        </div>
    </div>
</body>
</html>
