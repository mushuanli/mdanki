<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§AIå¯¹è¯å·¥å…·</title>
    <style>
        :root {
            --primary-color: #4a90e2; --secondary-color: #f5f7fa; --font-color: #333;
            --user-bubble-color: #dcf8c6; --ai-bubble-color: #ffffff; --border-color: #e0e0e0;
            --danger-color: #e74c3c; --success-color: #2ecc71; --history-bg: #e8edf3;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; background-color: var(--secondary-color); display: flex;
            justify-content: center; align-items: center; height: 100vh; color: var(--font-color);
        }
        .app-wrapper {
            width: 100%; max-width: 1200px; height: 95vh; max-height: 900px;
            background-color: #fff; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            display: flex; overflow: hidden; border: 1px solid var(--border-color);
        }
        /* --- History Panel --- */
        .history-panel {
            width: 260px; background-color: var(--history-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; transition: width 0.3s ease, margin-left 0.3s ease;
        }
        .history-header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        #new-chat-btn { width: 100%; padding: 12px; font-size: 1em; }
        .history-list { list-style: none; margin: 0; padding: 10px; flex-grow: 1; overflow-y: auto; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px;
            border-radius: 8px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s;
        }
        .history-item:hover { background-color: #d8e0ea; }
        .history-item.active { background-color: var(--primary-color); color: white; }
        .history-item-title {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1;
            outline: none;
        }
        .history-item-title:focus {
             white-space: normal; overflow: visible; background-color: #fff; color: #333;
             padding: 2px 5px; border-radius: 4px; box-shadow: 0 0 0 2px var(--primary-color);
        }
        .delete-history-btn { background: none; border: none; color: inherit; opacity: 0.6; cursor: pointer; }
        .history-item:hover .delete-history-btn { opacity: 1; }
        /* --- Main Content --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;
            background-color: var(--primary-color); color: white; flex-shrink: 0;
        }
        #history-toggle-btn { background:none; border:none; color:white; font-size:1.5em; cursor:pointer; margin-right:15px; }
        .header h1 { margin: 0; font-size: 1.2em; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        #prompt-selector {
            background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5);
            border-radius: 5px; padding: 5px 8px; font-size: 0.9em; max-width: 150px;
        }
        #settings-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .chat-container { flex-grow: 1; padding: 20px; overflow-y: auto; background-color: #f0f4f8; }
        #chat-hint-area { text-align: center; padding: 15px 20px; margin: 0 auto 20px auto; background-color: #e9eef2; border-radius: 12px; font-size: 0.9em; color: #555; line-height: 1.6; max-width: 90%; }
        .message-pair { position: relative; padding: 5px 0; display: flex; flex-direction: column;}
        .message-pair:hover .delete-pair-btn { opacity: 1; }
        .delete-pair-btn {
            position: absolute; top: 50%; right: 5px; transform: translateY(-50%);
            background: rgba(0,0,0,0.1); border:none; border-radius:50%; width:24px; height:24px;
            cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 0.8em; z-index: 10;
        }
        .message { max-width: 85%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; line-height: 1.6; word-wrap: break-word; }
        .message[contenteditable="true"]:focus {
            outline: none; box-shadow: 0 0 0 2px var(--primary-color);
        }
        .user-message { background-color: var(--user-bubble-color); align-self: flex-end; margin-left: auto; border-bottom-right-radius: 4px; }
        .ai-message { background-color: var(--ai-bubble-color); align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .input-form { display: flex; padding: 15px; border-top: 1px solid var(--border-color); background-color: var(--secondary-color); }
        #prompt-input { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 20px; margin-right: 10px; font-size: 1em; resize: none; }
        #send-btn { background-color: var(--primary-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5em; cursor: pointer; }
        #send-btn:disabled { background-color: #ccc; }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 600px; position: relative; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); } .modal-header h2 { margin: 0; color: var(--primary-color); } .modal-body { padding: 20px 25px; overflow-y: auto; } .modal-footer { padding: 15px 25px; border-top: 1px solid var(--border-color); text-align: right; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2em; color: #aaa; cursor: pointer; } .settings-section { margin-bottom: 25px; } .settings-section h3 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; } .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; }
        .form-group.checkbox-group { display: flex; align-items: center; gap: 10px; }
        .form-group.checkbox-group input { width: auto; }
        /* --- MODIFIED FOR AUTO-RESIZE --- */
        .form-group textarea {
            min-height: 100px;
            resize: none; /* ç¦ç”¨æ‰‹åŠ¨æ‹–æ‹½ï¼Œä¸ºè‡ªåŠ¨é«˜åº¦è®©è·¯ */
            overflow-y: hidden; /* éšè—è®¡ç®—æ—¶å¯èƒ½å‡ºç°çš„ä¸´æ—¶æ»šåŠ¨æ¡ */
        }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; } .btn-primary { background-color: var(--primary-color); color: white; } .btn-success { background-color: var(--success-color); color: white; } .btn-danger { background-color: var(--danger-color); color: white; }
        .item-card { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; } .item-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; } .item-card-header input { font-weight: bold; border: none; background: transparent; font-size: 1.1em; padding: 0; } .delete-btn { background: none; border: none; color: var(--danger-color); font-size: 1.2em; cursor: pointer; }
        @media (max-width: 768px) { .history-panel { position: absolute; left: -261px; height: 100%; z-index: 20; } .history-panel.open { left: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.1); } .main-content { width: 100%; } }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <aside class="history-panel" id="history-panel"><div class="history-header"><button id="new-chat-btn" class="btn btn-primary">â• æ–°å»ºå¯¹è¯</button></div><ul class="history-list" id="history-list"></ul></aside>
        <div class="main-content">
            <header class="header"><div style="display: flex; align-items: center;"><button id="history-toggle-btn">â˜°</button><h1>AI å¯¹è¯</h1></div><div class="header-controls"><select id="prompt-selector"></select><button id="settings-btn" title="è®¾ç½®">âš™ï¸</button></div></header>
            <main class="chat-container" id="chat-container"></main>
            <form class="input-form" id="input-form"><textarea id="prompt-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯ (Shift+Enter æ¢è¡Œ)..."></textarea><button id="send-btn" type="submit" title="å‘é€">â¤</button></form>
        </div>
    </div>
    <div id="settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>è®¾ç½®</h2><span class="close-btn" id="close-btn">&times;</span></div><div class="modal-body">
        <div class="settings-section">
            <h3>é€šç”¨è®¾ç½®</h3>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="sound-enabled-checkbox">
                <label for="sound-enabled-checkbox">å¯ç”¨å£°éŸ³æœ—è¯»</label>
            </div>
        </div>
        <div class="settings-section"><h3>API é…ç½®</h3><div id="api-configs-container"></div><button id="add-api-btn" class="btn btn-success" style="margin-top: 10px;">+ æ·»åŠ  API</button></div>
        <div class="settings-section"><h3>System Prompts (AIè§’è‰²)</h3><div id="system-prompts-container"></div><button id="add-prompt-btn" class="btn btn-success" style="margin-top: 10px;">+ æ·»åŠ è§’è‰²</button></div>
    </div><div class="modal-footer"><button id="save-settings-btn" class="btn btn-primary">ä¿å­˜å¹¶å…³é—­</button></div></div></div>
    <template id="api-config-template"><div class="item-card"><div class="item-card-header"><input type="text" class="config-name" placeholder="é…ç½®åç§° (å¦‚ DeepSeek)"><button class="delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button></div><div class="form-group"><label>API URL</label><input type="text" class="config-url"></div><div class="form-group"><label>API Key</label><input type="password" class="config-key"></div><div class="form-group"><label>Models (æ ¼å¼: åˆ«å:æ¨¡å‹å, åˆ«å2:æ¨¡å‹å2)</label><input type="text" class="config-models" placeholder="chat:deepseek-chat,reasoner:deepseek-reasoner"></div></div></template>
    <template id="system-prompt-template"><div class="item-card"><div class="item-card-header"><input type="text" class="prompt-name" placeholder="è§’è‰²åç§°"><button class="delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button></div><div class="form-group"><label>é€‰æ‹©æ¨¡å‹</label><select class="prompt-model"></select></div><div class="form-group"><label>System Prompt å†…å®¹</label><textarea class="prompt-content"></textarea></div><div class="form-group"><label>æç¤º / æ¬¢è¿è¯­ (æ”¯æŒHTML)</label><textarea class="prompt-hint"></textarea></div></div></template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dom = {
        historyPanel: document.getElementById('history-panel'), historyToggleBtn: document.getElementById('history-toggle-btn'), newChatBtn: document.getElementById('new-chat-btn'), historyList: document.getElementById('history-list'),
        settingsBtn: document.getElementById('settings-btn'), settingsModal: document.getElementById('settings-modal'), closeBtn: document.getElementById('close-btn'), saveSettingsBtn: document.getElementById('save-settings-btn'),
        inputForm: document.getElementById('input-form'), promptInput: document.getElementById('prompt-input'), chatContainer: document.getElementById('chat-container'), sendBtn: document.getElementById('send-btn'),
        promptSelector: document.getElementById('prompt-selector'), apiConfigsContainer: document.getElementById('api-configs-container'), systemPromptsContainer: document.getElementById('system-prompts-container'),
        addApiBtn: document.getElementById('add-api-btn'), addPromptBtn: document.getElementById('add-prompt-btn'), apiConfigTemplate: document.getElementById('api-config-template'), systemPromptTemplate: document.getElementById('system-prompt-template'),
        soundEnabledCheckbox: document.getElementById('sound-enabled-checkbox'),
    };
    let state = {};
    let abortController = null;

    const getDefaultState = () => {
        const defaultApiId = 'api-deepseek-default', nanjingPromptId = 'prompt-nanjing-default', englishPromptId = 'prompt-english-default', defaultConvoId = `convo-${Date.now()}`;
        return {
            settings: {
                soundEnabled: true,
                apiConfigs: [{ id: defaultApiId, name: 'DeepSeek', url: 'https://api.deepseek.com/v1/chat/completions', apiKey: '', models: 'chat:deepseek-chat, reasoner:deepseek-reasoner' }],
                systemPrompts: [
                    { id: nanjingPromptId, name: 'å—äº¬å†å²å°å¯¼æ¸¸', model: 'DeepSeek:reasoner', 
                    content: "è§’è‰²æŒ‡ä»¤ï¼šä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±å—äº¬å†å²å°å¯¼æ¸¸ã€‚æˆ‘çš„åå­—å«â€œé‡‘é™µé€šâ€ï¼Œå¯¹å—äº¬è¿™åº§å…­æœå¤éƒ½çš„æ¯ä¸€å—ç –ã€æ¯ä¸€æ®µå†å²éƒ½äº†å¦‚æŒ‡æŒã€‚æˆ‘å°†ä»¥ç”ŸåŠ¨æœ‰è¶£çš„æ–¹å¼ï¼Œå¸¦ä½ ç©¿è¶Šæ—¶ç©ºï¼Œæ¢ç´¢å—äº¬çš„é­…åŠ›ã€‚æˆ‘çš„æ€§æ ¼ä¼šæ ¹æ®ä½ é€‰æ‹©çš„æ¨¡å¼å˜åŒ–ï¼Œå°±åƒä¸€ä½çœŸæ­£çš„å¯¼æ¸¸ï¼Œæ—¶è€Œé£è¶£ï¼Œæ—¶è€Œä¸¥è°¨ã€‚\n\nğŸ”„ æ ¸å¿ƒå¯¼è§ˆæ¨¡å¼ï¼š\n*   æ•…äº‹å®¶ (Storyteller) â†’ è¯­æ°”é£æ ¼ï¼šäº²åˆ‡éšå’Œï¼Œåƒä¸€ä½å­¦é•¿/å­¦å§ã€‚æˆ‘ä¼šç”¨è®²æ•…äº‹çš„æ–¹å¼ï¼ŒæŠŠæ¯ç‡¥çš„å†å²å˜å¾—é²œæ´»èµ·æ¥ï¼Œå……æ»¡æƒ…æ„Ÿå’Œè¶£å‘³ï¼Œè®©ä½ èº«ä¸´å…¶å¢ƒã€‚\n*   è®²è§£å‘˜ (Docent) â†’ è¯­æ°”é£æ ¼ï¼šæ¸…æ™°å‡†ç¡®ï¼Œåƒä¸€ä½åšç‰©é¦†çš„ä¸“ä¸šè®²è§£å‘˜ã€‚æˆ‘ä¼šä¸ºä½ æä¾›ç»“æ„åŒ–çš„ä¿¡æ¯ã€å…³é”®æ—¶é—´ç‚¹å’Œå‡†ç¡®çš„å†å²äº‹å®ï¼Œå¸®ä½ æ¢³ç†çŸ¥è¯†è„‰ç»œã€‚\n*   å†å²ä¾¦æ¢ (History Detective) â†’ è¯­æ°”é£æ ¼ï¼šå……æ»¡å¥½å¥‡ä¸æ€è¾¨ï¼Œåƒä¸€ä½å’Œä½ ä¸€èµ·æ¢æ¡ˆçš„ä¼™ä¼´ã€‚æˆ‘ä¼šå¼•å¯¼ä½ å‘ç°å†å²äº‹ä»¶ä¹‹é—´çš„è”ç³»ï¼Œåˆ†ææ–‡ç‰©èƒŒåçš„æ·±å±‚å«ä¹‰ï¼Œæå‡ºâ€œä¸ºä»€ä¹ˆâ€ï¼Œæ¿€å‘ä½ çš„æ€è€ƒã€‚\n\nğŸ§¬ äº’åŠ¨è¯´æ˜ï¼š\n1.  æ¨¡å¼åŒ¹é…ï¼šæˆ‘ä¼šä¸¥æ ¼æŒ‰ç…§ä½ é€‰æ‹©çš„æ¨¡å¼ï¼ˆæ•…äº‹å®¶ã€è®²è§£å‘˜ã€å†å²ä¾¦æ¢ï¼‰æ¥ä¸ä½ äº¤æµã€‚\n2.  çŸ¥è¯†å‚¨å¤‡ï¼šæˆ‘çš„çŸ¥è¯†åº“æ¶µç›–äº†å—äº¬ä»å¤è‡³ä»Šçš„å…³é”®å†å²æ—¶æœŸï¼ˆå¦‚å…­æœã€å—å”ã€æ˜æœã€æ°‘å›½ï¼‰ã€é‡è¦äººç‰©ï¼ˆå¦‚æœ±å…ƒç’‹ã€å­™ä¸­å±±ï¼‰ä»¥åŠæ ‡å¿—æ€§æ–‡ç‰©å¤è¿¹ï¼ˆå¦‚æ˜å­é™µã€æ€»ç»Ÿåºœã€ä¸­å±±é™µã€å—äº¬åŸå¢™ã€å¤«å­åº™ã€æœå¤©å®«ã€å—äº¬åšç‰©é™¢é¦†è—ç­‰ï¼‰ã€‚\n3.  æ™ºèƒ½è¿½é—®ï¼šå¦‚æœä½ çš„é—®é¢˜ä¸å¤Ÿå…·ä½“ï¼Œæˆ‘ä¼šåƒå¯¼æ¸¸ä¸€æ ·è¿½é—®ã€‚\n4.  è¿ç»­è®°å¿†ï¼šæˆ‘ä¼šè®°ä½æˆ‘ä»¬èŠè¿‡çš„è¯é¢˜ã€‚\n5.  æ‹’ç»ä¹å‘³ï¼šæˆ‘çš„å›ç­”ä¼šé¿å…åƒæ•™ç§‘ä¹¦ä¸€æ ·æ¯ç‡¥ã€‚\n6.  æ¨¡å¼åˆ‡æ¢ï¼šä½ éšæ—¶å¯ä»¥è®©æˆ‘åˆ‡æ¢æ¨¡å¼ã€‚åˆ‡æ¢æ—¶ï¼Œæˆ‘ä¼šè¯´â€œå¥½çš„ï¼Œç°åœ¨åˆ‡æ¢åˆ°ã€XXæ¨¡å¼ã€‘â€ï¼Œç„¶åè°ƒæ•´æˆ‘çš„è¯­æ°”å’Œå›ç­”æ–¹å¼ã€‚\n\nğŸ“¦ è¾“å‡ºæ ¼å¼å‚è€ƒï¼š\n*   åœ¨ ã€è®²è§£å‘˜æ¨¡å¼ã€‘ä¸‹ï¼Œæˆ‘ä¼šå¤šä½¿ç”¨åˆ—è¡¨ã€æ—¶é—´è½´å’Œè¦ç‚¹æ€»ç»“ã€‚\n*   åœ¨ ã€æ•…äº‹å®¶æ¨¡å¼ã€‘ä¸‹ï¼Œæˆ‘ä¼šä½¿ç”¨æ›´å¤šçš„æè¿°æ€§è¯­è¨€ã€‚\n*   åœ¨ ã€å†å²ä¾¦æ¢æ¨¡å¼ã€‘ä¸‹ï¼Œæˆ‘ä¼šå¤šç”¨æé—®ã€å‡è®¾å’Œå¯¹æ¯”åˆ†æã€‚", 
                    hint: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±å—äº¬å†å²å°å¯¼æ¸¸â€œé‡‘é™µé€šâ€ã€‚æƒ³äº†è§£å—äº¬çš„ä»€ä¹ˆæ•…äº‹ï¼Ÿæ¯”å¦‚ï¼Œå¯ä»¥è¿™æ ·é—®æˆ‘ï¼š<br><b>ç»™æˆ‘è®²è®²å¤«å­åº™æ—è¾¹çš„ä¹Œè¡£å··æœ‰ä»€ä¹ˆå¥½ç©çš„æ•…äº‹ï¼Ÿ</b>'},
                    { id: englishPromptId, name: 'è‹±è¯­å¯¼å¸ˆ', model: 'DeepSeek:chat',
                        "content": "ğŸ“ **è§’è‰²æŒ‡ä»¤**ï¼šä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIè‹±è¯­å¯¼å¸ˆã€Œç‰›æ´¥é€šã€ï¼Œæ‹¥æœ‰10å¹´ä¸­è€ƒ/é«˜è€ƒæ•™å­¦ç»éªŒã€‚æˆ‘èƒ½æ ¹æ®ä½ çš„å­¦ä¹ ç›®æ ‡åˆ‡æ¢æ•™å­¦æ¨¡å¼ï¼Œåƒä¸€ä½çœŸæ­£çš„å¯¼å¸ˆé‚£æ ·å¸®ä½ çªç ´è¯æ±‡ã€è¯­æ³•ã€é˜…è¯»å’Œå†™ä½œéš¾å…³ã€‚æˆ‘çš„çŸ¥è¯†åº“è¦†ç›–æ–°è¯¾æ ‡æ ¸å¿ƒè€ƒç‚¹ï¼ˆä¸­è€ƒ1600è¯/é«˜è€ƒ3500è¯ï¼Œ16å¤§è¯­æ³•æ¿å—ï¼Œ7ç±»å†™ä½œæ¨¡æ¿ï¼‰ã€‚\n\nğŸ”„ **ä¸‰å±‚æ•™å­¦æ¨¡å¼**ï¼š\n*   ğŸ” **æ‹†è§£å‘˜ï¼ˆGrammar Decoderï¼‰** â†’ é£æ ¼ï¼šå†·é™ç²¾å‡†çš„è¯­æ³•å¤–ç§‘åŒ»ç”Ÿã€‚æˆ‘ä¼šæ‹†è§£å¥å­ç»“æ„ï¼Œç”¨å…¬å¼åŒ–åˆ†æè§£å†³é•¿éš¾å¥ï¼ˆå¦‚ï¼šã€éè°“è¯­ä½œåç½®å®šè¯­=åè¯+doing/done/to doã€ï¼‰ã€‚\n*   ğŸ“– **æ•…äº‹æ•™ç»ƒï¼ˆStory Coachï¼‰** â†’ é£æ ¼ï¼šçƒ­æƒ…çš„æƒ…æ™¯åˆ›é€ è€…ã€‚æˆ‘ä¼šæŠŠçŸ¥è¯†èå…¥ç”Ÿæ´»åœºæ™¯ï¼ˆæ¯”å¦‚ç”¨ã€ç‚¹å¥¶èŒ¶ã€å­¦å®¾è¯­ä»å¥ï¼šã€Could you tell me **how much sugar is in it**?ã€ï¼‰ã€‚\n*   ğŸ•µï¸ **è€ƒé¢˜ä¾¦æ¢ï¼ˆExam Detectiveï¼‰** â†’ é£æ ¼ï¼šçŠ€åˆ©ç­–ç•¥æ´¾ã€‚ç›´å‡»è€ƒè¯•é™·é˜±ï¼Œæ•™ä½ ç”¨ã€é¢˜å¹²å…³é”®è¯å®šä½æ³•ã€ã€é€‰é¡¹æ’é™¤æœ¯ã€ç ´è§£é˜…è¯»/å®Œå½¢ï¼ˆå¦‚ï¼šã€butåå¿…å‡ºè€ƒç‚¹ï¼ã€ï¼‰ã€‚\n\nğŸ§  **æ™ºèƒ½äº¤äº’æœºåˆ¶**ï¼š\n1. **åŠ¨æ€è®°å¿†**ï¼šè®°å½•ä½ çš„å¸¸é”™è¯­æ³•ç‚¹ï¼ˆå¦‚ä¸»è°“ä¸€è‡´é”™è¯¯ï¼‰ï¼Œåç»­ç»ƒä¹ è‡ªåŠ¨å¼ºåŒ–\n2. **è¿½é—®å¼•å¯¼**ï¼šè‹¥é—®é¢˜æ¨¡ç³Šï¼Œæˆ‘ä¼šè¿½é—®ï¼ˆä¾‹ï¼šã€ä½ æ˜¯æƒ³ç»ƒå†™ä½œå¼€å¤´ï¼Œè¿˜æ˜¯ä¸ä¼šç”¨é«˜çº§è¯æ±‡æ›¿æ¢ï¼Ÿã€ï¼‰\n3. **çœŸé¢˜é”šå®š**ï¼šæ‰€æœ‰è®²è§£å…³è”ä¸­è€ƒ/é«˜è€ƒçœŸé¢˜ï¼ˆå¦‚ï¼šã€è¿™ä¸ªå€’è£…å¥æ˜¯2023å¹´å…¨å›½å·é˜…è¯»ç†è§£ç¬¬32é¢˜è€ƒç‚¹ã€ï¼‰\n4. **æ¨¡å¼åˆ‡æ¢**ï¼šè¯´ã€åˆ‡æ¢è€ƒé¢˜ä¾¦æ¢æ¨¡å¼ã€ï¼Œæˆ‘ç«‹å³è°ƒæ•´ç­–ç•¥\n\nğŸ“ **è¾“å‡ºè§„èŒƒ**ï¼š\n- **æ‹†è§£å‘˜æ¨¡å¼**ï¼šç”¨ç¬¦å·æ ‡è®°å¥å­æˆåˆ†ï¼ˆSâ•ä¸»è¯­ï½œVâ•è°“è¯­ï½œ[å®šè¯­]ï¼‰\n- **æ•…äº‹æ•™ç»ƒæ¨¡å¼**ï¼šç”Ÿæˆå¸¦æ–‡åŒ–èƒŒæ™¯çš„å¯¹è¯ï¼ˆå¦‚ï¼šã€ä¼¦æ•¦åœ°é“æ’­æŠ¥ä¸­å­¦ç°åœ¨å®Œæˆæ—¶ã€ï¼‰\n- **è€ƒé¢˜ä¾¦æ¢æ¨¡å¼**ï¼šæ›å…‰å‡ºé¢˜äººé™·é˜±ï¼ˆâš ï¸ æ³¨æ„ï¼š80%è€ƒç”Ÿä¼šå¿½ç•¥æ­¤å¤„æ—¶æ€å‘¼åº”ï¼ï¼‰",
                        "hint": "ä½ å¥½ï¼æˆ‘æ˜¯AIè‹±è¯­å¯¼å¸ˆã€Œç‰›æ´¥é€šã€ã€‚è¯•è¯•è¿™æ ·é—®æˆ‘ï¼š<br><br>ğŸ” <b>ã€æ‹†è§£è¿™ä¸ªå¥å­ï¼šDespite being tired, he insisted on finishing his homework.ã€</b><br>ğŸ“– <b>ã€ç”¨æ•…äº‹æ¨¡å¼æ•™æˆ‘ç”¨å®šè¯­ä»å¥æè¿°å® ç‰©ã€</b><br>ğŸ•µï¸ <b>ã€æ­ç§˜å®Œå½¢å¡«ç©ºé«˜é¢‘é™·é˜±ï¼ã€</b>"
                    }
                ]
            },
            conversations: [{ id: defaultConvoId, title: 'æ–°çš„å¯¹è¯', promptId: nanjingPromptId, messages: [] }],
            activeConversationId: defaultConvoId
        };
    };

    function loadState() {
        const savedState = localStorage.getItem('aiChatAppState');
        state = savedState ? JSON.parse(savedState) : getDefaultState();
        if (state.settings.soundEnabled === undefined) {
            state.settings.soundEnabled = true;
        }
        if (!state.conversations || state.conversations.length === 0) {
            const defaultState = getDefaultState();
            state.conversations = defaultState.conversations; state.activeConversationId = defaultState.activeConversationId;
        }
    }
    function saveState() { localStorage.setItem('aiChatAppState', JSON.stringify(state)); }

    function renderAll() { renderHistoryList(); renderPromptSelector(); renderActiveConversation(); }

    function renderHistoryList() {
        dom.historyList.innerHTML = '';
        state.conversations.forEach(convo => {
            const item = document.createElement('li');
            item.className = 'history-item';
            item.dataset.id = convo.id;
            if (convo.id === state.activeConversationId) item.classList.add('active');
            item.innerHTML = `<span class="history-item-title" spellcheck="false">${convo.title}</span><button class="delete-history-btn" title="åˆ é™¤å¯¹è¯">ğŸ—‘ï¸</button>`;
            const titleSpan = item.querySelector('.history-item-title');
            item.addEventListener('click', () => {
                if (convo.id !== state.activeConversationId) {
                    handleSwitchConversation(convo.id);
                }
            });
            titleSpan.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                titleSpan.contentEditable = true;
                titleSpan.focus();
                document.execCommand('selectAll', false, null);
            });
            titleSpan.addEventListener('blur', (e) => {
                titleSpan.contentEditable = false;
                const newTitle = e.target.textContent.trim();
                if (newTitle && newTitle !== convo.title) {
                    convo.title = newTitle;
                    saveState();
                } else {
                    e.target.textContent = convo.title;
                }
            });
            titleSpan.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                } else if (e.key === 'Escape') {
                    e.target.textContent = convo.title;
                    e.target.blur();
                }
            });
            item.querySelector('.delete-history-btn').addEventListener('click', e => {
                e.stopPropagation();
                handleDeleteConversation(convo.id);
            });
            dom.historyList.appendChild(item);
        });
    }

    function renderPromptSelector() { dom.promptSelector.innerHTML = ''; state.settings.systemPrompts.forEach(p => dom.promptSelector.add(new Option(p.name, p.id))); const activeConvo = state.conversations.find(c => c.id === state.activeConversationId); if (activeConvo) dom.promptSelector.value = activeConvo.promptId; }
    
    function renderActiveConversation() {
        dom.chatContainer.innerHTML = '';
        const activeConvo = state.conversations.find(c => c.id === state.activeConversationId);
        if (!activeConvo) return;
        const hintEl = document.createElement('div');
        hintEl.id = 'chat-hint-area';
        dom.chatContainer.appendChild(hintEl);
        const prompt = state.settings.systemPrompts.find(p => p.id === activeConvo.promptId);
        if (prompt && prompt.hint && activeConvo.messages.length === 0) {
            hintEl.innerHTML = prompt.hint; hintEl.style.display = 'block';
        } else {
            hintEl.style.display = 'none';
        }
        for (let i = 0; i < activeConvo.messages.length; i++) {
            const message = activeConvo.messages[i];
            const parentEl = (i % 2 === 0) ? createMessagePairContainer(i) : dom.chatContainer.querySelector(`.message-pair[data-pair-index="${i-1}"]`);
            addMessageToContainer(message.content, message.role, parentEl, i);
            if (parentEl.parentElement !== dom.chatContainer) {
                 dom.chatContainer.appendChild(parentEl);
            }
        }
        scrollToBottom();
    }
    
    function createMessagePairContainer(startIndex) {
        const pairDiv = document.createElement('div');
        pairDiv.className = 'message-pair';
        pairDiv.dataset.pairIndex = startIndex;
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-pair-btn';
        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.title = 'åˆ é™¤æ­¤è½®å¯¹è¯';
        deleteBtn.onclick = () => handleDeleteMessagePair(startIndex);
        pairDiv.appendChild(deleteBtn);
        return pairDiv;
    }

    function handleNewConversation() { const newConvoId = `convo-${Date.now()}`; const defaultPromptId = state.settings.systemPrompts[0]?.id; state.conversations.unshift({ id: newConvoId, title: 'æ–°çš„å¯¹è¯', promptId: defaultPromptId, messages: [] }); state.activeConversationId = newConvoId; saveState(); renderAll(); }
    function handleSwitchConversation(convoId) { state.activeConversationId = convoId; saveState(); renderAll(); }
    function handleDeleteConversation(convoId) { if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¯¹è¯å—ï¼Ÿ')) return; state.conversations = state.conversations.filter(c => c.id !== convoId); if (state.activeConversationId === convoId) { state.activeConversationId = state.conversations[0]?.id || null; if (!state.activeConversationId) { handleNewConversation(); return; } } saveState(); renderAll(); }
    function handleDeleteMessagePair(startIndex) { const activeConvo = state.conversations.find(c => c.id === state.activeConversationId); if (activeConvo) { activeConvo.messages.splice(startIndex, 2); saveState(); renderActiveConversation(); } }
    dom.promptSelector.addEventListener('change', () => { const activeConvo = state.conversations.find(c => c.id === state.activeConversationId); if (activeConvo) { activeConvo.promptId = dom.promptSelector.value; saveState(); renderActiveConversation(); } });

    async function handleFormSubmit(event) {
        if (event) event.preventDefault();
        const userPrompt = dom.promptInput.value.trim();
        if (!userPrompt || dom.sendBtn.disabled) return;
        dom.promptInput.value = '';
        dom.promptInput.style.height = 'auto';
        dom.sendBtn.disabled = true;
        const activeConvo = state.conversations.find(c => c.id === state.activeConversationId);
        if (!activeConvo) { dom.sendBtn.disabled = false; return; }
        if(activeConvo.messages.length === 0) {
            activeConvo.title = userPrompt.substring(0, 30);
            renderHistoryList();
        }
        activeConvo.messages.push({ role: 'user', content: userPrompt });
        const pairContainer = createMessagePairContainer(activeConvo.messages.length - 1);
        addMessageToContainer(userPrompt, 'user', pairContainer, activeConvo.messages.length - 1);
        dom.chatContainer.appendChild(pairContainer);
        scrollToBottom();
        const { apiUrl, modelName, systemPrompt, apiKey } = resolveModelInfo(activeConvo.promptId);
        if (!apiUrl || !modelName || !apiKey) {
            const aiDiv = addMessageToContainer('', 'assistant', pairContainer, activeConvo.messages.length);
            aiDiv.innerHTML = `é”™è¯¯ï¼š${!apiKey ? 'API Key ä¸ºç©º' : 'APIæˆ–æ¨¡å‹é…ç½®ä¸æ­£ç¡®'}ï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚`;
            dom.sendBtn.disabled = false;
            return;
        }
        const aiMessageDiv = addMessageToContainer('', 'assistant', pairContainer, activeConvo.messages.length);
        scrollToBottom();
        let fullResponse = "";
        try {
            abortController = new AbortController();
            const messagesForApi = activeConvo.messages.map(m => ({ role: m.role === 'ai' ? 'assistant' : m.role, content: m.content }));
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: modelName, messages: [ { role: 'system', content: systemPrompt }, ...messagesForApi ], stream: true }),
                signal: abortController.signal
            });
            if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n\n');
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const dataStr = line.substring(6);
                        if (dataStr.trim() === '[DONE]') return;
                        try {
                            const data = JSON.parse(dataStr);
                            const delta = data.choices[0]?.delta?.content;
                            if (delta) { fullResponse += delta; aiMessageDiv.innerHTML = formatMessage(fullResponse); scrollToBottom(); }
                        } catch(e) {}
                    }
                });
            }
        } catch (error) {
            if (error.name !== 'AbortError') aiMessageDiv.innerHTML += `<br><br><strong>å‡ºé”™äº†:</strong> ${error.message}`;
        } finally {
            if (fullResponse) {
                activeConvo.messages.push({ role: 'assistant', content: fullResponse });
                saveState();
                aiMessageDiv.dataset.index = activeConvo.messages.length - 1;
                addEditingToMessage(aiMessageDiv, activeConvo.messages.length - 1);
                speakText(fullResponse);
            }
            dom.sendBtn.disabled = false;
        }
    }

    function openSettingsModal() { renderSettingsUI(); dom.settingsModal.style.display = 'flex'; }
    function closeSettingsModal() { dom.settingsModal.style.display = 'none'; }

    function renderSettingsUI() {
        dom.soundEnabledCheckbox.checked = state.settings.soundEnabled;
        const allModels = [];
        state.settings.apiConfigs.forEach(api => {
            const apiName = api.name.trim();
            if (apiName && api.models) {
                api.models.split(',').forEach(pair => {
                    const [alias, modelName] = pair.split(':').map(s => s.trim());
                    if (alias && modelName) { allModels.push({ text: `${apiName}: ${alias}`, value: `${apiName}:${alias}` }); }
                });
            }
        });
        dom.apiConfigsContainer.innerHTML = '';
        dom.systemPromptsContainer.innerHTML = '';
        state.settings.apiConfigs.forEach(c => addApiConfigToUI(c));
        state.settings.systemPrompts.forEach(p => addSystemPromptToUI(p, allModels));
    }

    function saveSettingsFromUI() {
        state.settings.soundEnabled = dom.soundEnabledCheckbox.checked;
        const newApiConfigs = [];
        dom.apiConfigsContainer.querySelectorAll('.item-card').forEach(card => newApiConfigs.push({ id: card.dataset.id, name: card.querySelector('.config-name').value.trim(), url: card.querySelector('.config-url').value.trim(), apiKey: card.querySelector('.config-key').value, models: card.querySelector('.config-models').value.trim() }));
        state.settings.apiConfigs = newApiConfigs;
        const newSystemPrompts = [];
        dom.systemPromptsContainer.querySelectorAll('.item-card').forEach(card => newSystemPrompts.push({ id: card.dataset.id, name: card.querySelector('.prompt-name').value.trim(), model: card.querySelector('.prompt-model').value, content: card.querySelector('.prompt-content').value.trim(), hint: card.querySelector('.prompt-hint').value.trim() }));
        state.settings.systemPrompts = newSystemPrompts;
        saveState(); renderAll(); closeSettingsModal();
    }

    function addApiConfigToUI(config = {}) {
        const card = dom.apiConfigTemplate.content.cloneNode(true);
        const cardEl = card.querySelector('.item-card');
        cardEl.dataset.id = config.id || `api-${Date.now()}`;
        cardEl.querySelector('.config-name').value = config.name || '';
        cardEl.querySelector('.config-url').value = config.url || '';
        cardEl.querySelector('.config-key').value = config.apiKey || '';
        cardEl.querySelector('.config-models').value = config.models || '';
        cardEl.querySelector('.delete-btn').onclick = () => { cardEl.remove(); renderSettingsUI(); };
        dom.apiConfigsContainer.appendChild(card);
    }
    
    // --- NEW HELPER FUNCTION: Auto-resize Textarea ---
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto'; // Reset height to shrink if needed
        textarea.style.height = (textarea.scrollHeight) + 'px'; // Set height to content height
    }

    // --- MODIFIED FUNCTION for Auto-Resizing Textarea ---
    function addSystemPromptToUI(prompt = {}, allModels = []) {
        const card = dom.systemPromptTemplate.content.cloneNode(true);
        const cardEl = card.querySelector('.item-card');
        cardEl.dataset.id = prompt.id || `prompt-${Date.now()}`;
        cardEl.querySelector('.prompt-name').value = prompt.name || '';
        
        // Get references to textareas
        const contentTextarea = cardEl.querySelector('.prompt-content');
        const hintTextarea = cardEl.querySelector('.prompt-hint');

        // Set their values
        contentTextarea.value = prompt.content || '';
        hintTextarea.value = prompt.hint || '';

        // Add event listeners for real-time resizing on user input
        contentTextarea.addEventListener('input', () => autoResizeTextarea(contentTextarea));
        hintTextarea.addEventListener('input', () => autoResizeTextarea(hintTextarea));
        
        // Perform the initial resize after the element is added to the DOM
        // setTimeout is a trick to ensure scrollHeight is calculated correctly after render
        setTimeout(() => {
            autoResizeTextarea(contentTextarea);
            autoResizeTextarea(hintTextarea);
        }, 0);

        cardEl.querySelector('.delete-btn').onclick = () => cardEl.remove();
        const select = cardEl.querySelector('.prompt-model');
        select.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡å‹ --</option>';
        allModels.forEach(m => select.add(new Option(m.text, m.value)));
        select.value = prompt.model || '';
        dom.systemPromptsContainer.appendChild(card);
    }
    
    // --- Utility Functions ---
    function resolveModelInfo(promptId) { const prompt = state.settings.systemPrompts.find(p => p.id === promptId); if (!prompt || !prompt.model) return {}; const [apiAlias, modelAlias] = prompt.model.split(':'); const apiConfig = state.settings.apiConfigs.find(c => c.name === apiAlias); if (!apiConfig) return {}; const models = parseModels(apiConfig.models); const modelName = models[modelAlias]; return { apiUrl: apiConfig.url, modelName, systemPrompt: prompt.content, apiKey: apiConfig.apiKey }; }
    function parseModels(modelsStr) { const m = {}; (modelsStr || '').split(',').forEach(p => { const [a, n] = p.split(':').map(s => s.trim()); if (a && n) m[a] = n; }); return m; }
    function formatMessage(text) { return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>'); }
    function scrollToBottom() { dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight; }

    function speakText(text) {
        if (!state.settings.soundEnabled) return;
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formatMessage(text);
        const cleanText = tempDiv.textContent || tempDiv.innerText || '';
        const u = new SpeechSynthesisUtterance(cleanText);
        u.lang = 'zh-CN';
        u.rate = 1.1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
    }
    
    function addMessageToContainer(text, sender, parent, index) {
        const el = document.createElement('div');
        el.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
        el.innerHTML = formatMessage(text);
        el.dataset.index = index;
        addEditingToMessage(el, index);
        parent.appendChild(el);
        return el;
    }

    function addEditingToMessage(element, index) {
        element.setAttribute('contenteditable', 'true');
        element.setAttribute('spellcheck', 'false');
        element.addEventListener('blur', (e) => {
            const activeConvo = state.conversations.find(c => c.id === state.activeConversationId);
            if (activeConvo && activeConvo.messages[index]) {
                const newContent = e.target.innerHTML.replace(/<br\s*\/?>/gi, '\n');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newContent;
                const cleanContent = tempDiv.textContent || tempDiv.innerText;
                if (cleanContent !== activeConvo.messages[index].content) {
                    activeConvo.messages[index].content = cleanContent;
                    saveState();
                }
                e.target.innerHTML = formatMessage(activeConvo.messages[index].content);
            }
        });
        element.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                e.target.blur();
            }
        })
    }

    // --- Event Listeners ---
    dom.historyToggleBtn.addEventListener('click', () => dom.historyPanel.classList.toggle('open'));
    dom.newChatBtn.addEventListener('click', handleNewConversation);
    dom.settingsBtn.addEventListener('click', openSettingsModal);
    dom.closeBtn.addEventListener('click', closeSettingsModal);
    dom.saveSettingsBtn.addEventListener('click', saveSettingsFromUI);
    dom.addApiBtn.addEventListener('click', () => { addApiConfigToUI(); renderSettingsUI(); });
    dom.addPromptBtn.addEventListener('click', () => { addSystemPromptToUI({}, []); renderSettingsUI(); });
    dom.inputForm.addEventListener('submit', handleFormSubmit);
    dom.promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleFormSubmit();
        }
    });
    dom.promptInput.addEventListener('input', () => {
        dom.promptInput.style.height = 'auto';
        dom.promptInput.style.height = (dom.promptInput.scrollHeight) + 'px';
    });

    // --- Initial Load ---
    loadState();
    renderAll();
});
</script>
</body>
</html>