<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能学习套件</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script> 
    <!-- [新增] 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        loader: {load: ['[tex]/mhchem']},
        tex: {
          packages: {'[+]': ['mhchem']}
        },
        startup: {
          pageReady: () => {
            return window.MathJax.startup.defaultPageReady();
          }
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
  <script type="module" crossorigin>import{marked as mr}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();const _e=n=>document.querySelector(n),V=n=>document.getElementById(n),Bo=V("anki-view"),jo=V("agent-view"),Ko=V("mistakes-view"),qo=V("settings-view"),Gn=document.querySelector(".ai-agent-nav"),zl=Object.freeze(Object.defineProperty({__proto__:null,$:_e,$id:V,agentNav:Gn,agentView:jo,ankiView:Bo,mistakesView:Ko,settingsView:qo},Symbol.toStringTag,{value:"Module"}));let Ro={activeView:"anki",sessions:[],folders:[],clozeStates:{},fileSubsessions:{},undoStack:[],redoStack:[],currentSessionId:null,currentFolderId:null,currentSubsessionId:null,folderStack:[],agents:[],topics:[],history:[],currentAgentId:null,currentTopicId:null,currentConversationAgentId:null,isLoading:!0,isAiThinking:!1,agentFilters:{type:"all",tags:[]},isSessionSidebarHidden:!1,areAllClozeVisible:!1,movingItems:[],selectedMoveTarget:null};const $=new Proxy(Ro,{get(n,e){if(e in n){const t=n[e];return typeof t=="object"&&t!==null?JSON.parse(JSON.stringify(t)):t}},set(){return console.warn("Direct mutation of appState is not allowed. Use a data service function."),!1}});function ie(n){Object.assign(Ro,n)}const to=10*60*1e3,Vl=2.5;function Fo(n,e){const t=Date.now();let{interval:s=0,easeFactor:r=Vl,state:a="new"}=n;if(a==="new"||a==="learning")switch(e){case 0:return{due:t+to,interval:0,easeFactor:r,state:"learning"};case 1:return{due:t+1*24*3600*1e3,interval:1,easeFactor:r,state:"review"};case 2:return{due:t+3*24*3600*1e3,interval:3,easeFactor:r,state:"review"};case 3:return{due:t+5*24*3600*1e3,interval:5,easeFactor:r,state:"review"}}switch(e){case 0:return r=Math.max(1.3,r-.2),{due:t+to,interval:0,easeFactor:r,state:"learning"};case 1:s=Math.max(1,s*1.2),r=Math.max(1.3,r-.15);break;case 2:break;case 3:r+=.15;break}const c=Math.max(s+1,s*r);return{due:t+c*24*3600*1e3,interval:c,easeFactor:r,state:"review"}}var no=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Yl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Ho={exports:{}};(function(n,e){(function(t,s){n.exports=s()})(no,function(){var t=function(i,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(l,u){l.__proto__=u}||function(l,u){for(var d in u)Object.prototype.hasOwnProperty.call(u,d)&&(l[d]=u[d])})(i,o)},s=function(){return(s=Object.assign||function(i){for(var o,l=1,u=arguments.length;l<u;l++)for(var d in o=arguments[l])Object.prototype.hasOwnProperty.call(o,d)&&(i[d]=o[d]);return i}).apply(this,arguments)};function r(i,o,l){for(var u,d=0,p=o.length;d<p;d++)!u&&d in o||((u=u||Array.prototype.slice.call(o,0,d))[d]=o[d]);return i.concat(u||Array.prototype.slice.call(o))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:no,c=Object.keys,f=Array.isArray;function h(i,o){return typeof o!="object"||c(o).forEach(function(l){i[l]=o[l]}),i}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var m=Object.getPrototypeOf,_={}.hasOwnProperty;function b(i,o){return _.call(i,o)}function E(i,o){typeof o=="function"&&(o=o(m(i))),(typeof Reflect>"u"?c:Reflect.ownKeys)(o).forEach(function(l){B(i,l,o[l])})}var L=Object.defineProperty;function B(i,o,l,u){L(i,o,h(l&&b(l,"get")&&typeof l.get=="function"?{get:l.get,set:l.set,configurable:!0}:{value:l,configurable:!0,writable:!0},u))}function C(i){return{from:function(o){return i.prototype=Object.create(o.prototype),B(i.prototype,"constructor",i),{extend:E.bind(null,i.prototype)}}}}var D=Object.getOwnPropertyDescriptor,Y=[].slice;function W(i,o,l){return Y.call(i,o,l)}function X(i,o){return o(i)}function Q(i){if(!i)throw new Error("Assertion Failed")}function ee(i){a.setImmediate?setImmediate(i):setTimeout(i,0)}function te(i,o){if(typeof o=="string"&&b(i,o))return i[o];if(!o)return i;if(typeof o!="string"){for(var l=[],u=0,d=o.length;u<d;++u){var p=te(i,o[u]);l.push(p)}return l}var y=o.indexOf(".");if(y!==-1){var g=i[o.substr(0,y)];return g==null?void 0:te(g,o.substr(y+1))}}function oe(i,o,l){if(i&&o!==void 0&&!("isFrozen"in Object&&Object.isFrozen(i)))if(typeof o!="string"&&"length"in o){Q(typeof l!="string"&&"length"in l);for(var u=0,d=o.length;u<d;++u)oe(i,o[u],l[u])}else{var p,y,g=o.indexOf(".");g!==-1?(p=o.substr(0,g),(y=o.substr(g+1))===""?l===void 0?f(i)&&!isNaN(parseInt(p))?i.splice(p,1):delete i[p]:i[p]=l:oe(g=!(g=i[p])||!b(i,p)?i[p]={}:g,y,l)):l===void 0?f(i)&&!isNaN(parseInt(o))?i.splice(o,1):delete i[o]:i[o]=l}}function G(i){var o,l={};for(o in i)b(i,o)&&(l[o]=i[o]);return l}var ye=[].concat;function Ve(i){return ye.apply([],i)}var Ct="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ve([8,16,32,64].map(function(i){return["Int","Uint","Float"].map(function(o){return o+i+"Array"})}))).filter(function(i){return a[i]}),nt=new Set(Ct.map(function(i){return a[i]})),ge=null;function Ge(i){return ge=new WeakMap,i=function o(l){if(!l||typeof l!="object")return l;var u=ge.get(l);if(u)return u;if(f(l)){u=[],ge.set(l,u);for(var d=0,p=l.length;d<p;++d)u.push(o(l[d]))}else if(nt.has(l.constructor))u=l;else{var y,g=m(l);for(y in u=g===Object.prototype?{}:Object.create(g),ge.set(l,u),l)b(l,y)&&(u[y]=o(l[y]))}return u}(i),ge=null,i}var fl={}.toString;function Ci(i){return fl.call(i).slice(8,-1)}var Oi=typeof Symbol<"u"?Symbol.iterator:"@@iterator",dl=typeof Oi=="symbol"?function(i){var o;return i!=null&&(o=i[Oi])&&o.apply(i)}:function(){return null};function Tt(i,o){return o=i.indexOf(o),0<=o&&i.splice(o,1),0<=o}var Gt={};function st(i){var o,l,u,d;if(arguments.length===1){if(f(i))return i.slice();if(this===Gt&&typeof i=="string")return[i];if(d=dl(i)){for(l=[];!(u=d.next()).done;)l.push(u.value);return l}if(i==null)return[i];if(typeof(o=i.length)!="number")return[i];for(l=new Array(o);o--;)l[o]=i[o];return l}for(o=arguments.length,l=new Array(o);o--;)l[o]=arguments[o];return l}var Ni=typeof Symbol<"u"?function(i){return i[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},xn=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],He=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(xn),hl={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Wt(i,o){this.name=i,this.message=o}function wa(i,o){return i+". Errors: "+Object.keys(o).map(function(l){return o[l].toString()}).filter(function(l,u,d){return d.indexOf(l)===u}).join(`
`)}function us(i,o,l,u){this.failures=o,this.failedKeys=u,this.successCount=l,this.message=wa(i,o)}function Qt(i,o){this.name="BulkError",this.failures=Object.keys(o).map(function(l){return o[l]}),this.failuresByPos=o,this.message=wa(i,this.failures)}C(Wt).from(Error).extend({toString:function(){return this.name+": "+this.message}}),C(us).from(Wt),C(Qt).from(Wt);var $i=He.reduce(function(i,o){return i[o]=o+"Error",i},{}),pl=Wt,se=He.reduce(function(i,o){var l=o+"Error";function u(d,p){this.name=l,d?typeof d=="string"?(this.message="".concat(d).concat(p?`
 `+p:""),this.inner=p||null):typeof d=="object"&&(this.message="".concat(d.name," ").concat(d.message),this.inner=d):(this.message=hl[o]||l,this.inner=null)}return C(u).from(pl),i[o]=u,i},{});se.Syntax=SyntaxError,se.Type=TypeError,se.Range=RangeError;var Sa=xn.reduce(function(i,o){return i[o+"Error"]=se[o],i},{}),fs=He.reduce(function(i,o){return["Syntax","Type","Range"].indexOf(o)===-1&&(i[o+"Error"]=se[o]),i},{});function pe(){}function Nn(i){return i}function ml(i,o){return i==null||i===Nn?o:function(l){return o(i(l))}}function Lt(i,o){return function(){i.apply(this,arguments),o.apply(this,arguments)}}function yl(i,o){return i===pe?o:function(){var l=i.apply(this,arguments);l!==void 0&&(arguments[0]=l);var u=this.onsuccess,d=this.onerror;this.onsuccess=null,this.onerror=null;var p=o.apply(this,arguments);return u&&(this.onsuccess=this.onsuccess?Lt(u,this.onsuccess):u),d&&(this.onerror=this.onerror?Lt(d,this.onerror):d),p!==void 0?p:l}}function gl(i,o){return i===pe?o:function(){i.apply(this,arguments);var l=this.onsuccess,u=this.onerror;this.onsuccess=this.onerror=null,o.apply(this,arguments),l&&(this.onsuccess=this.onsuccess?Lt(l,this.onsuccess):l),u&&(this.onerror=this.onerror?Lt(u,this.onerror):u)}}function vl(i,o){return i===pe?o:function(l){var u=i.apply(this,arguments);h(l,u);var d=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,l=o.apply(this,arguments),d&&(this.onsuccess=this.onsuccess?Lt(d,this.onsuccess):d),p&&(this.onerror=this.onerror?Lt(p,this.onerror):p),u===void 0?l===void 0?void 0:l:h(u,l)}}function bl(i,o){return i===pe?o:function(){return o.apply(this,arguments)!==!1&&i.apply(this,arguments)}}function xi(i,o){return i===pe?o:function(){var l=i.apply(this,arguments);if(l&&typeof l.then=="function"){for(var u=this,d=arguments.length,p=new Array(d);d--;)p[d]=arguments[d];return l.then(function(){return o.apply(u,p)})}return o.apply(this,arguments)}}fs.ModifyError=us,fs.DexieError=Wt,fs.BulkError=Qt;var We=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function ka(i){We=i}var $n={},Ea=100,Ct=typeof Promise>"u"?[]:function(){var i=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[i,m(i),i];var o=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[o,m(o),i]}(),xn=Ct[0],He=Ct[1],Ct=Ct[2],He=He&&He.then,Ot=xn&&xn.constructor,Mi=!!Ct,Mn=function(i,o){Pn.push([i,o]),ds&&(queueMicrotask(Sl),ds=!1)},Pi=!0,ds=!0,Nt=[],hs=[],Di=Nn,dt={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:pe,pgp:!1,env:{},finalize:pe},Z=dt,Pn=[],$t=0,ps=[];function z(i){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var o=this._PSD=Z;if(typeof i!="function"){if(i!==$n)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&ji(this,this._value))}this._state=null,this._value=null,++o.ref,function l(u,d){try{d(function(p){if(u._state===null){if(p===u)throw new TypeError("A promise cannot be resolved with itself.");var y=u._lib&&Xt();p&&typeof p.then=="function"?l(u,function(g,w){p instanceof z?p._then(g,w):p.then(g,w)}):(u._state=!0,u._value=p,_a(u)),y&&Zt()}},ji.bind(null,u))}catch(p){ji(u,p)}}(this,i)}var Bi={get:function(){var i=Z,o=vs;function l(u,d){var p=this,y=!i.global&&(i!==Z||o!==vs),g=y&&!pt(),w=new z(function(k,T){Ki(p,new Ia(Ta(u,i,y,g),Ta(d,i,y,g),k,T,i))});return this._consoleTask&&(w._consoleTask=this._consoleTask),w}return l.prototype=$n,l},set:function(i){B(this,"then",i&&i.prototype===$n?Bi:{get:function(){return i},set:Bi.set})}};function Ia(i,o,l,u,d){this.onFulfilled=typeof i=="function"?i:null,this.onRejected=typeof o=="function"?o:null,this.resolve=l,this.reject=u,this.psd=d}function ji(i,o){var l,u;hs.push(o),i._state===null&&(l=i._lib&&Xt(),o=Di(o),i._state=!1,i._value=o,u=i,Nt.some(function(d){return d._value===u._value})||Nt.push(u),_a(i),l&&Zt())}function _a(i){var o=i._listeners;i._listeners=[];for(var l=0,u=o.length;l<u;++l)Ki(i,o[l]);var d=i._PSD;--d.ref||d.finalize(),$t===0&&(++$t,Mn(function(){--$t==0&&qi()},[]))}function Ki(i,o){if(i._state!==null){var l=i._state?o.onFulfilled:o.onRejected;if(l===null)return(i._state?o.resolve:o.reject)(i._value);++o.psd.ref,++$t,Mn(wl,[l,i,o])}else i._listeners.push(o)}function wl(i,o,l){try{var u,d=o._value;!o._state&&hs.length&&(hs=[]),u=We&&o._consoleTask?o._consoleTask.run(function(){return i(d)}):i(d),o._state||hs.indexOf(d)!==-1||function(p){for(var y=Nt.length;y;)if(Nt[--y]._value===p._value)return Nt.splice(y,1)}(o),l.resolve(u)}catch(p){l.reject(p)}finally{--$t==0&&qi(),--l.psd.ref||l.psd.finalize()}}function Sl(){xt(dt,function(){Xt()&&Zt()})}function Xt(){var i=Pi;return ds=Pi=!1,i}function Zt(){var i,o,l;do for(;0<Pn.length;)for(i=Pn,Pn=[],l=i.length,o=0;o<l;++o){var u=i[o];u[0].apply(null,u[1])}while(0<Pn.length);ds=Pi=!0}function qi(){var i=Nt;Nt=[],i.forEach(function(u){u._PSD.onunhandled.call(null,u._value,u)});for(var o=ps.slice(0),l=o.length;l;)o[--l]()}function ms(i){return new z($n,!1,i)}function be(i,o){var l=Z;return function(){var u=Xt(),d=Z;try{return mt(l,!0),i.apply(this,arguments)}catch(p){o&&o(p)}finally{mt(d,!1),u&&Zt()}}}E(z.prototype,{then:Bi,_then:function(i,o){Ki(this,new Ia(null,null,i,o,Z))},catch:function(i){if(arguments.length===1)return this.then(null,i);var o=i,l=arguments[1];return typeof o=="function"?this.then(null,function(u){return(u instanceof o?l:ms)(u)}):this.then(null,function(u){return(u&&u.name===o?l:ms)(u)})},finally:function(i){return this.then(function(o){return z.resolve(i()).then(function(){return o})},function(o){return z.resolve(i()).then(function(){return ms(o)})})},timeout:function(i,o){var l=this;return i<1/0?new z(function(u,d){var p=setTimeout(function(){return d(new se.Timeout(o))},i);l.then(u,d).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&B(z.prototype,Symbol.toStringTag,"Dexie.Promise"),dt.env=Aa(),E(z,{all:function(){var i=st.apply(null,arguments).map(bs);return new z(function(o,l){i.length===0&&o([]);var u=i.length;i.forEach(function(d,p){return z.resolve(d).then(function(y){i[p]=y,--u||o(i)},l)})})},resolve:function(i){return i instanceof z?i:i&&typeof i.then=="function"?new z(function(o,l){i.then(o,l)}):new z($n,!0,i)},reject:ms,race:function(){var i=st.apply(null,arguments).map(bs);return new z(function(o,l){i.map(function(u){return z.resolve(u).then(o,l)})})},PSD:{get:function(){return Z},set:function(i){return Z=i}},totalEchoes:{get:function(){return vs}},newPSD:ht,usePSD:xt,scheduler:{get:function(){return Mn},set:function(i){Mn=i}},rejectionMapper:{get:function(){return Di},set:function(i){Di=i}},follow:function(i,o){return new z(function(l,u){return ht(function(d,p){var y=Z;y.unhandleds=[],y.onunhandled=p,y.finalize=Lt(function(){var g,w=this;g=function(){w.unhandleds.length===0?d():p(w.unhandleds[0])},ps.push(function k(){g(),ps.splice(ps.indexOf(k),1)}),++$t,Mn(function(){--$t==0&&qi()},[])},y.finalize),i()},o,l,u)})}}),Ot&&(Ot.allSettled&&B(z,"allSettled",function(){var i=st.apply(null,arguments).map(bs);return new z(function(o){i.length===0&&o([]);var l=i.length,u=new Array(l);i.forEach(function(d,p){return z.resolve(d).then(function(y){return u[p]={status:"fulfilled",value:y}},function(y){return u[p]={status:"rejected",reason:y}}).then(function(){return--l||o(u)})})})}),Ot.any&&typeof AggregateError<"u"&&B(z,"any",function(){var i=st.apply(null,arguments).map(bs);return new z(function(o,l){i.length===0&&l(new AggregateError([]));var u=i.length,d=new Array(u);i.forEach(function(p,y){return z.resolve(p).then(function(g){return o(g)},function(g){d[y]=g,--u||l(new AggregateError(d))})})})}),Ot.withResolvers&&(z.withResolvers=Ot.withResolvers));var Ae={awaits:0,echoes:0,id:0},kl=0,ys=[],gs=0,vs=0,El=0;function ht(i,o,l,u){var d=Z,p=Object.create(d);return p.parent=d,p.ref=0,p.global=!1,p.id=++El,dt.env,p.env=Mi?{Promise:z,PromiseProp:{value:z,configurable:!0,writable:!0},all:z.all,race:z.race,allSettled:z.allSettled,any:z.any,resolve:z.resolve,reject:z.reject}:{},o&&h(p,o),++d.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},u=xt(p,i,l,u),p.ref===0&&p.finalize(),u}function en(){return Ae.id||(Ae.id=++kl),++Ae.awaits,Ae.echoes+=Ea,Ae.id}function pt(){return!!Ae.awaits&&(--Ae.awaits==0&&(Ae.id=0),Ae.echoes=Ae.awaits*Ea,!0)}function bs(i){return Ae.echoes&&i&&i.constructor===Ot?(en(),i.then(function(o){return pt(),o},function(o){return pt(),Ee(o)})):i}function Il(){var i=ys[ys.length-1];ys.pop(),mt(i,!1)}function mt(i,o){var l,u=Z;(o?!Ae.echoes||gs++&&i===Z:!gs||--gs&&i===Z)||queueMicrotask(o?(function(d){++vs,Ae.echoes&&--Ae.echoes!=0||(Ae.echoes=Ae.awaits=Ae.id=0),ys.push(Z),mt(d,!0)}).bind(null,i):Il),i!==Z&&(Z=i,u===dt&&(dt.env=Aa()),Mi&&(l=dt.env.Promise,o=i.env,(u.global||i.global)&&(Object.defineProperty(a,"Promise",o.PromiseProp),l.all=o.all,l.race=o.race,l.resolve=o.resolve,l.reject=o.reject,o.allSettled&&(l.allSettled=o.allSettled),o.any&&(l.any=o.any))))}function Aa(){var i=a.Promise;return Mi?{Promise:i,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:i.all,race:i.race,allSettled:i.allSettled,any:i.any,resolve:i.resolve,reject:i.reject}:{}}function xt(i,o,l,u,d){var p=Z;try{return mt(i,!0),o(l,u,d)}finally{mt(p,!1)}}function Ta(i,o,l,u){return typeof i!="function"?i:function(){var d=Z;l&&en(),mt(o,!0);try{return i.apply(this,arguments)}finally{mt(d,!1),u&&queueMicrotask(pt)}}}function Ri(i){Promise===Ot&&Ae.echoes===0?gs===0?i():enqueueNativeMicroTask(i):setTimeout(i,0)}(""+He).indexOf("[native code]")===-1&&(en=pt=pe);var Ee=z.reject,Mt="￿",it="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",La="String expected.",tn=[],ws="__dbnames",Fi="readonly",Hi="readwrite";function Pt(i,o){return i?o?function(){return i.apply(this,arguments)&&o.apply(this,arguments)}:i:o}var Ca={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Ss(i){return typeof i!="string"||/\./.test(i)?function(o){return o}:function(o){return o[i]===void 0&&i in o&&delete(o=Ge(o))[i],o}}function Oa(){throw se.Type()}function fe(i,o){try{var l=Na(i),u=Na(o);if(l!==u)return l==="Array"?1:u==="Array"?-1:l==="binary"?1:u==="binary"?-1:l==="string"?1:u==="string"?-1:l==="Date"?1:u!=="Date"?NaN:-1;switch(l){case"number":case"Date":case"string":return o<i?1:i<o?-1:0;case"binary":return function(d,p){for(var y=d.length,g=p.length,w=y<g?y:g,k=0;k<w;++k)if(d[k]!==p[k])return d[k]<p[k]?-1:1;return y===g?0:y<g?-1:1}($a(i),$a(o));case"Array":return function(d,p){for(var y=d.length,g=p.length,w=y<g?y:g,k=0;k<w;++k){var T=fe(d[k],p[k]);if(T!==0)return T}return y===g?0:y<g?-1:1}(i,o)}}catch{}return NaN}function Na(i){var o=typeof i;return o!="object"?o:ArrayBuffer.isView(i)?"binary":(i=Ci(i),i==="ArrayBuffer"?"binary":i)}function $a(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i)}var xa=(ve.prototype._trans=function(i,o,l){var u=this._tx||Z.trans,d=this.name,p=We&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(i==="readonly"?"read":"write"," ").concat(this.name));function y(k,T,v){if(!v.schema[d])throw new se.NotFound("Table "+d+" not part of transaction");return o(v.idbtrans,v)}var g=Xt();try{var w=u&&u.db._novip===this.db._novip?u===Z.trans?u._promise(i,y,l):ht(function(){return u._promise(i,y,l)},{trans:u,transless:Z.transless||Z}):function k(T,v,N,S){if(T.idbdb&&(T._state.openComplete||Z.letThrough||T._vip)){var A=T._createTransaction(v,N,T._dbSchema);try{A.create(),T._state.PR1398_maxLoop=3}catch(O){return O.name===$i.InvalidState&&T.isOpen()&&0<--T._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),T.close({disableAutoOpen:!1}),T.open().then(function(){return k(T,v,N,S)})):Ee(O)}return A._promise(v,function(O,I){return ht(function(){return Z.trans=A,S(O,I,A)})}).then(function(O){if(v==="readwrite")try{A.idbtrans.commit()}catch{}return v==="readonly"?O:A._completion.then(function(){return O})})}if(T._state.openComplete)return Ee(new se.DatabaseClosed(T._state.dbOpenError));if(!T._state.isBeingOpened){if(!T._state.autoOpen)return Ee(new se.DatabaseClosed);T.open().catch(pe)}return T._state.dbReadyPromise.then(function(){return k(T,v,N,S)})}(this.db,i,[this.name],y);return p&&(w._consoleTask=p,w=w.catch(function(k){return console.trace(k),Ee(k)})),w}finally{g&&Zt()}},ve.prototype.get=function(i,o){var l=this;return i&&i.constructor===Object?this.where(i).first(o):i==null?Ee(new se.Type("Invalid argument to Table.get()")):this._trans("readonly",function(u){return l.core.get({trans:u,key:i}).then(function(d){return l.hook.reading.fire(d)})}).then(o)},ve.prototype.where=function(i){if(typeof i=="string")return new this.db.WhereClause(this,i);if(f(i))return new this.db.WhereClause(this,"[".concat(i.join("+"),"]"));var o=c(i);if(o.length===1)return this.where(o[0]).equals(i[o[0]]);var l=this.schema.indexes.concat(this.schema.primKey).filter(function(g){if(g.compound&&o.every(function(k){return 0<=g.keyPath.indexOf(k)})){for(var w=0;w<o.length;++w)if(o.indexOf(g.keyPath[w])===-1)return!1;return!0}return!1}).sort(function(g,w){return g.keyPath.length-w.keyPath.length})[0];if(l&&this.db._maxKey!==Mt){var p=l.keyPath.slice(0,o.length);return this.where(p).equals(p.map(function(w){return i[w]}))}!l&&We&&console.warn("The query ".concat(JSON.stringify(i)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(o.join("+"),"]"));var u=this.schema.idxByName;function d(g,w){return fe(g,w)===0}var y=o.reduce(function(v,w){var k=v[0],T=v[1],v=u[w],N=i[w];return[k||v,k||!v?Pt(T,v&&v.multi?function(S){return S=te(S,w),f(S)&&S.some(function(A){return d(N,A)})}:function(S){return d(N,te(S,w))}):T]},[null,null]),p=y[0],y=y[1];return p?this.where(p.name).equals(i[p.keyPath]).filter(y):l?this.filter(y):this.where(o).equals("")},ve.prototype.filter=function(i){return this.toCollection().and(i)},ve.prototype.count=function(i){return this.toCollection().count(i)},ve.prototype.offset=function(i){return this.toCollection().offset(i)},ve.prototype.limit=function(i){return this.toCollection().limit(i)},ve.prototype.each=function(i){return this.toCollection().each(i)},ve.prototype.toArray=function(i){return this.toCollection().toArray(i)},ve.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},ve.prototype.orderBy=function(i){return new this.db.Collection(new this.db.WhereClause(this,f(i)?"[".concat(i.join("+"),"]"):i))},ve.prototype.reverse=function(){return this.toCollection().reverse()},ve.prototype.mapToClass=function(i){var o,l=this.db,u=this.name;function d(){return o!==null&&o.apply(this,arguments)||this}(this.schema.mappedClass=i).prototype instanceof Oa&&(function(w,k){if(typeof k!="function"&&k!==null)throw new TypeError("Class extends value "+String(k)+" is not a constructor or null");function T(){this.constructor=w}t(w,k),w.prototype=k===null?Object.create(k):(T.prototype=k.prototype,new T)}(d,o=i),Object.defineProperty(d.prototype,"db",{get:function(){return l},enumerable:!1,configurable:!0}),d.prototype.table=function(){return u},i=d);for(var p=new Set,y=i.prototype;y;y=m(y))Object.getOwnPropertyNames(y).forEach(function(w){return p.add(w)});function g(w){if(!w)return w;var k,T=Object.create(i.prototype);for(k in w)if(!p.has(k))try{T[k]=w[k]}catch{}return T}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=g,this.hook("reading",g),i},ve.prototype.defineClass=function(){return this.mapToClass(function(i){h(this,i)})},ve.prototype.add=function(i,o){var l=this,u=this.schema.primKey,d=u.auto,p=u.keyPath,y=i;return p&&d&&(y=Ss(p)(i)),this._trans("readwrite",function(g){return l.core.mutate({trans:g,type:"add",keys:o!=null?[o]:null,values:[y]})}).then(function(g){return g.numFailures?z.reject(g.failures[0]):g.lastResult}).then(function(g){if(p)try{oe(i,p,g)}catch{}return g})},ve.prototype.update=function(i,o){return typeof i!="object"||f(i)?this.where(":id").equals(i).modify(o):(i=te(i,this.schema.primKey.keyPath),i===void 0?Ee(new se.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(i).modify(o))},ve.prototype.put=function(i,o){var l=this,u=this.schema.primKey,d=u.auto,p=u.keyPath,y=i;return p&&d&&(y=Ss(p)(i)),this._trans("readwrite",function(g){return l.core.mutate({trans:g,type:"put",values:[y],keys:o!=null?[o]:null})}).then(function(g){return g.numFailures?z.reject(g.failures[0]):g.lastResult}).then(function(g){if(p)try{oe(i,p,g)}catch{}return g})},ve.prototype.delete=function(i){var o=this;return this._trans("readwrite",function(l){return o.core.mutate({trans:l,type:"delete",keys:[i]})}).then(function(l){return l.numFailures?z.reject(l.failures[0]):void 0})},ve.prototype.clear=function(){var i=this;return this._trans("readwrite",function(o){return i.core.mutate({trans:o,type:"deleteRange",range:Ca})}).then(function(o){return o.numFailures?z.reject(o.failures[0]):void 0})},ve.prototype.bulkGet=function(i){var o=this;return this._trans("readonly",function(l){return o.core.getMany({keys:i,trans:l}).then(function(u){return u.map(function(d){return o.hook.reading.fire(d)})})})},ve.prototype.bulkAdd=function(i,o,l){var u=this,d=Array.isArray(o)?o:void 0,p=(l=l||(d?void 0:o))?l.allKeys:void 0;return this._trans("readwrite",function(y){var k=u.schema.primKey,g=k.auto,k=k.keyPath;if(k&&d)throw new se.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(d&&d.length!==i.length)throw new se.InvalidArgument("Arguments objects and keys must have the same length");var w=i.length,k=k&&g?i.map(Ss(k)):i;return u.core.mutate({trans:y,type:"add",keys:d,values:k,wantResults:p}).then(function(A){var v=A.numFailures,N=A.results,S=A.lastResult,A=A.failures;if(v===0)return p?N:S;throw new Qt("".concat(u.name,".bulkAdd(): ").concat(v," of ").concat(w," operations failed"),A)})})},ve.prototype.bulkPut=function(i,o,l){var u=this,d=Array.isArray(o)?o:void 0,p=(l=l||(d?void 0:o))?l.allKeys:void 0;return this._trans("readwrite",function(y){var k=u.schema.primKey,g=k.auto,k=k.keyPath;if(k&&d)throw new se.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(d&&d.length!==i.length)throw new se.InvalidArgument("Arguments objects and keys must have the same length");var w=i.length,k=k&&g?i.map(Ss(k)):i;return u.core.mutate({trans:y,type:"put",keys:d,values:k,wantResults:p}).then(function(A){var v=A.numFailures,N=A.results,S=A.lastResult,A=A.failures;if(v===0)return p?N:S;throw new Qt("".concat(u.name,".bulkPut(): ").concat(v," of ").concat(w," operations failed"),A)})})},ve.prototype.bulkUpdate=function(i){var o=this,l=this.core,u=i.map(function(y){return y.key}),d=i.map(function(y){return y.changes}),p=[];return this._trans("readwrite",function(y){return l.getMany({trans:y,keys:u,cache:"clone"}).then(function(g){var w=[],k=[];i.forEach(function(v,N){var S=v.key,A=v.changes,O=g[N];if(O){for(var I=0,x=Object.keys(A);I<x.length;I++){var M=x[I],P=A[M];if(M===o.schema.primKey.keyPath){if(fe(P,S)!==0)throw new se.Constraint("Cannot update primary key in bulkUpdate()")}else oe(O,M,P)}p.push(N),w.push(S),k.push(O)}});var T=w.length;return l.mutate({trans:y,type:"put",keys:w,values:k,updates:{keys:u,changeSpecs:d}}).then(function(v){var N=v.numFailures,S=v.failures;if(N===0)return T;for(var A=0,O=Object.keys(S);A<O.length;A++){var I,x=O[A],M=p[Number(x)];M!=null&&(I=S[x],delete S[x],S[M]=I)}throw new Qt("".concat(o.name,".bulkUpdate(): ").concat(N," of ").concat(T," operations failed"),S)})})})},ve.prototype.bulkDelete=function(i){var o=this,l=i.length;return this._trans("readwrite",function(u){return o.core.mutate({trans:u,type:"delete",keys:i})}).then(function(y){var d=y.numFailures,p=y.lastResult,y=y.failures;if(d===0)return p;throw new Qt("".concat(o.name,".bulkDelete(): ").concat(d," of ").concat(l," operations failed"),y)})},ve);function ve(){}function Dn(i){function o(y,g){if(g){for(var w=arguments.length,k=new Array(w-1);--w;)k[w-1]=arguments[w];return l[y].subscribe.apply(null,k),i}if(typeof y=="string")return l[y]}var l={};o.addEventType=p;for(var u=1,d=arguments.length;u<d;++u)p(arguments[u]);return o;function p(y,g,w){if(typeof y!="object"){var k;g=g||bl;var T={subscribers:[],fire:w=w||pe,subscribe:function(v){T.subscribers.indexOf(v)===-1&&(T.subscribers.push(v),T.fire=g(T.fire,v))},unsubscribe:function(v){T.subscribers=T.subscribers.filter(function(N){return N!==v}),T.fire=T.subscribers.reduce(g,w)}};return l[y]=o[y]=T}c(k=y).forEach(function(v){var N=k[v];if(f(N))p(v,k[v][0],k[v][1]);else{if(N!=="asap")throw new se.InvalidArgument("Invalid event config");var S=p(v,Nn,function(){for(var A=arguments.length,O=new Array(A);A--;)O[A]=arguments[A];S.subscribers.forEach(function(I){ee(function(){I.apply(null,O)})})})}})}}function Bn(i,o){return C(o).from({prototype:i}),o}function nn(i,o){return!(i.filter||i.algorithm||i.or)&&(o?i.justLimit:!i.replayFilter)}function Ui(i,o){i.filter=Pt(i.filter,o)}function zi(i,o,l){var u=i.replayFilter;i.replayFilter=u?function(){return Pt(u(),o())}:o,i.justLimit=l&&!u}function ks(i,o){if(i.isPrimKey)return o.primaryKey;var l=o.getIndexByKeyPath(i.index);if(!l)throw new se.Schema("KeyPath "+i.index+" on object store "+o.name+" is not indexed");return l}function Ma(i,o,l){var u=ks(i,o.schema);return o.openCursor({trans:l,values:!i.keysOnly,reverse:i.dir==="prev",unique:!!i.unique,query:{index:u,range:i.range}})}function Es(i,o,l,u){var d=i.replayFilter?Pt(i.filter,i.replayFilter()):i.filter;if(i.or){var p={},y=function(g,w,k){var T,v;d&&!d(w,k,function(N){return w.stop(N)},function(N){return w.fail(N)})||((v=""+(T=w.primaryKey))=="[object ArrayBuffer]"&&(v=""+new Uint8Array(T)),b(p,v)||(p[v]=!0,o(g,w,k)))};return Promise.all([i.or._iterate(y,l),Pa(Ma(i,u,l),i.algorithm,y,!i.keysOnly&&i.valueMapper)])}return Pa(Ma(i,u,l),Pt(i.algorithm,d),o,!i.keysOnly&&i.valueMapper)}function Pa(i,o,l,u){var d=be(u?function(p,y,g){return l(u(p),y,g)}:l);return i.then(function(p){if(p)return p.start(function(){var y=function(){return p.continue()};o&&!o(p,function(g){return y=g},function(g){p.stop(g),y=pe},function(g){p.fail(g),y=pe})||d(p.value,p,function(g){return y=g}),y()})})}var jn=(Da.prototype.execute=function(i){var o=this["@@propmod"];if(o.add!==void 0){var l=o.add;if(f(l))return r(r([],f(i)?i:[],!0),l).sort();if(typeof l=="number")return(Number(i)||0)+l;if(typeof l=="bigint")try{return BigInt(i)+l}catch{return BigInt(0)+l}throw new TypeError("Invalid term ".concat(l))}if(o.remove!==void 0){var u=o.remove;if(f(u))return f(i)?i.filter(function(d){return!u.includes(d)}).sort():[];if(typeof u=="number")return Number(i)-u;if(typeof u=="bigint")try{return BigInt(i)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return l=(l=o.replacePrefix)===null||l===void 0?void 0:l[0],l&&typeof i=="string"&&i.startsWith(l)?o.replacePrefix[1]+i.substring(l.length):i},Da);function Da(i){this["@@propmod"]=i}var _l=(de.prototype._read=function(i,o){var l=this._ctx;return l.error?l.table._trans(null,Ee.bind(null,l.error)):l.table._trans("readonly",i).then(o)},de.prototype._write=function(i){var o=this._ctx;return o.error?o.table._trans(null,Ee.bind(null,o.error)):o.table._trans("readwrite",i,"locked")},de.prototype._addAlgorithm=function(i){var o=this._ctx;o.algorithm=Pt(o.algorithm,i)},de.prototype._iterate=function(i,o){return Es(this._ctx,i,o,this._ctx.table.core)},de.prototype.clone=function(i){var o=Object.create(this.constructor.prototype),l=Object.create(this._ctx);return i&&h(l,i),o._ctx=l,o},de.prototype.raw=function(){return this._ctx.valueMapper=null,this},de.prototype.each=function(i){var o=this._ctx;return this._read(function(l){return Es(o,i,l,o.table.core)})},de.prototype.count=function(i){var o=this;return this._read(function(l){var u=o._ctx,d=u.table.core;if(nn(u,!0))return d.count({trans:l,query:{index:ks(u,d.schema),range:u.range}}).then(function(y){return Math.min(y,u.limit)});var p=0;return Es(u,function(){return++p,!1},l,d).then(function(){return p})}).then(i)},de.prototype.sortBy=function(i,o){var l=i.split(".").reverse(),u=l[0],d=l.length-1;function p(w,k){return k?p(w[l[k]],k-1):w[u]}var y=this._ctx.dir==="next"?1:-1;function g(w,k){return fe(p(w,d),p(k,d))*y}return this.toArray(function(w){return w.sort(g)}).then(o)},de.prototype.toArray=function(i){var o=this;return this._read(function(l){var u=o._ctx;if(u.dir==="next"&&nn(u,!0)&&0<u.limit){var d=u.valueMapper,p=ks(u,u.table.core.schema);return u.table.core.query({trans:l,limit:u.limit,values:!0,query:{index:p,range:u.range}}).then(function(g){return g=g.result,d?g.map(d):g})}var y=[];return Es(u,function(g){return y.push(g)},l,u.table.core).then(function(){return y})},i)},de.prototype.offset=function(i){var o=this._ctx;return i<=0||(o.offset+=i,nn(o)?zi(o,function(){var l=i;return function(u,d){return l===0||(l===1?--l:d(function(){u.advance(l),l=0}),!1)}}):zi(o,function(){var l=i;return function(){return--l<0}})),this},de.prototype.limit=function(i){return this._ctx.limit=Math.min(this._ctx.limit,i),zi(this._ctx,function(){var o=i;return function(l,u,d){return--o<=0&&u(d),0<=o}},!0),this},de.prototype.until=function(i,o){return Ui(this._ctx,function(l,u,d){return!i(l.value)||(u(d),o)}),this},de.prototype.first=function(i){return this.limit(1).toArray(function(o){return o[0]}).then(i)},de.prototype.last=function(i){return this.reverse().first(i)},de.prototype.filter=function(i){var o;return Ui(this._ctx,function(l){return i(l.value)}),(o=this._ctx).isMatch=Pt(o.isMatch,i),this},de.prototype.and=function(i){return this.filter(i)},de.prototype.or=function(i){return new this.db.WhereClause(this._ctx.table,i,this)},de.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},de.prototype.desc=function(){return this.reverse()},de.prototype.eachKey=function(i){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(l,u){i(u.key,u)})},de.prototype.eachUniqueKey=function(i){return this._ctx.unique="unique",this.eachKey(i)},de.prototype.eachPrimaryKey=function(i){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(l,u){i(u.primaryKey,u)})},de.prototype.keys=function(i){var o=this._ctx;o.keysOnly=!o.isMatch;var l=[];return this.each(function(u,d){l.push(d.key)}).then(function(){return l}).then(i)},de.prototype.primaryKeys=function(i){var o=this._ctx;if(o.dir==="next"&&nn(o,!0)&&0<o.limit)return this._read(function(u){var d=ks(o,o.table.core.schema);return o.table.core.query({trans:u,values:!1,limit:o.limit,query:{index:d,range:o.range}})}).then(function(u){return u.result}).then(i);o.keysOnly=!o.isMatch;var l=[];return this.each(function(u,d){l.push(d.primaryKey)}).then(function(){return l}).then(i)},de.prototype.uniqueKeys=function(i){return this._ctx.unique="unique",this.keys(i)},de.prototype.firstKey=function(i){return this.limit(1).keys(function(o){return o[0]}).then(i)},de.prototype.lastKey=function(i){return this.reverse().firstKey(i)},de.prototype.distinct=function(){var i=this._ctx,i=i.index&&i.table.schema.idxByName[i.index];if(!i||!i.multi)return this;var o={};return Ui(this._ctx,function(d){var u=d.primaryKey.toString(),d=b(o,u);return o[u]=!0,!d}),this},de.prototype.modify=function(i){var o=this,l=this._ctx;return this._write(function(u){var d,p,y;y=typeof i=="function"?i:(d=c(i),p=d.length,function(I){for(var x=!1,M=0;M<p;++M){var P=d[M],j=i[P],K=te(I,P);j instanceof jn?(oe(I,P,j.execute(K)),x=!0):K!==j&&(oe(I,P,j),x=!0)}return x});var g=l.table.core,v=g.schema.primaryKey,w=v.outbound,k=v.extractKey,T=200,v=o.db._options.modifyChunkSize;v&&(T=typeof v=="object"?v[g.name]||v["*"]||200:v);function N(I,P){var M=P.failures,P=P.numFailures;A+=I-P;for(var j=0,K=c(M);j<K.length;j++){var H=K[j];S.push(M[H])}}var S=[],A=0,O=[];return o.clone().primaryKeys().then(function(I){function x(P){var j=Math.min(T,I.length-P);return g.getMany({trans:u,keys:I.slice(P,P+j),cache:"immutable"}).then(function(K){for(var H=[],q=[],R=w?[]:null,U=[],F=0;F<j;++F){var J=K[F],ce={value:Ge(J),primKey:I[P+F]};y.call(ce,ce.value,ce)!==!1&&(ce.value==null?U.push(I[P+F]):w||fe(k(J),k(ce.value))===0?(q.push(ce.value),w&&R.push(I[P+F])):(U.push(I[P+F]),H.push(ce.value)))}return Promise.resolve(0<H.length&&g.mutate({trans:u,type:"add",values:H}).then(function(le){for(var ue in le.failures)U.splice(parseInt(ue),1);N(H.length,le)})).then(function(){return(0<q.length||M&&typeof i=="object")&&g.mutate({trans:u,type:"put",keys:R,values:q,criteria:M,changeSpec:typeof i!="function"&&i,isAdditionalChunk:0<P}).then(function(le){return N(q.length,le)})}).then(function(){return(0<U.length||M&&i===Vi)&&g.mutate({trans:u,type:"delete",keys:U,criteria:M,isAdditionalChunk:0<P}).then(function(le){return N(U.length,le)})}).then(function(){return I.length>P+j&&x(P+T)})})}var M=nn(l)&&l.limit===1/0&&(typeof i!="function"||i===Vi)&&{index:l.index,range:l.range};return x(0).then(function(){if(0<S.length)throw new us("Error modifying one or more objects",S,A,O);return I.length})})})},de.prototype.delete=function(){var i=this._ctx,o=i.range;return nn(i)&&(i.isPrimKey||o.type===3)?this._write(function(l){var u=i.table.core.schema.primaryKey,d=o;return i.table.core.count({trans:l,query:{index:u,range:d}}).then(function(p){return i.table.core.mutate({trans:l,type:"deleteRange",range:d}).then(function(y){var g=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new us("Could not delete some values",Object.keys(g).map(function(w){return g[w]}),p-y);return p-y})})}):this.modify(Vi)},de);function de(){}var Vi=function(i,o){return o.value=null};function Al(i,o){return i<o?-1:i===o?0:1}function Tl(i,o){return o<i?-1:i===o?0:1}function qe(i,o,l){return i=i instanceof ja?new i.Collection(i):i,i._ctx.error=new(l||TypeError)(o),i}function sn(i){return new i.Collection(i,function(){return Ba("")}).limit(0)}function Is(i,o,l,u){var d,p,y,g,w,k,T,v=l.length;if(!l.every(function(A){return typeof A=="string"}))return qe(i,La);function N(A){d=A==="next"?function(I){return I.toUpperCase()}:function(I){return I.toLowerCase()},p=A==="next"?function(I){return I.toLowerCase()}:function(I){return I.toUpperCase()},y=A==="next"?Al:Tl;var O=l.map(function(I){return{lower:p(I),upper:d(I)}}).sort(function(I,x){return y(I.lower,x.lower)});g=O.map(function(I){return I.upper}),w=O.map(function(I){return I.lower}),T=(k=A)==="next"?"":u}N("next"),i=new i.Collection(i,function(){return yt(g[0],w[v-1]+u)}),i._ondirectionchange=function(A){N(A)};var S=0;return i._addAlgorithm(function(A,O,I){var x=A.key;if(typeof x!="string")return!1;var M=p(x);if(o(M,w,S))return!0;for(var P=null,j=S;j<v;++j){var K=function(H,q,R,U,F,J){for(var ce=Math.min(H.length,U.length),le=-1,ue=0;ue<ce;++ue){var Re=q[ue];if(Re!==U[ue])return F(H[ue],R[ue])<0?H.substr(0,ue)+R[ue]+R.substr(ue+1):F(H[ue],U[ue])<0?H.substr(0,ue)+U[ue]+R.substr(ue+1):0<=le?H.substr(0,le)+q[le]+R.substr(le+1):null;F(H[ue],Re)<0&&(le=ue)}return ce<U.length&&J==="next"?H+R.substr(H.length):ce<H.length&&J==="prev"?H.substr(0,R.length):le<0?null:H.substr(0,le)+U[le]+R.substr(le+1)}(x,M,g[j],w[j],y,k);K===null&&P===null?S=j+1:(P===null||0<y(P,K))&&(P=K)}return O(P!==null?function(){A.continue(P+T)}:I),!1}),i}function yt(i,o,l,u){return{type:2,lower:i,upper:o,lowerOpen:l,upperOpen:u}}function Ba(i){return{type:1,lower:i,upper:i}}var ja=(Object.defineProperty(Te.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Te.prototype.between=function(i,o,l,u){l=l!==!1,u=u===!0;try{return 0<this._cmp(i,o)||this._cmp(i,o)===0&&(l||u)&&(!l||!u)?sn(this):new this.Collection(this,function(){return yt(i,o,!l,!u)})}catch{return qe(this,it)}},Te.prototype.equals=function(i){return i==null?qe(this,it):new this.Collection(this,function(){return Ba(i)})},Te.prototype.above=function(i){return i==null?qe(this,it):new this.Collection(this,function(){return yt(i,void 0,!0)})},Te.prototype.aboveOrEqual=function(i){return i==null?qe(this,it):new this.Collection(this,function(){return yt(i,void 0,!1)})},Te.prototype.below=function(i){return i==null?qe(this,it):new this.Collection(this,function(){return yt(void 0,i,!1,!0)})},Te.prototype.belowOrEqual=function(i){return i==null?qe(this,it):new this.Collection(this,function(){return yt(void 0,i)})},Te.prototype.startsWith=function(i){return typeof i!="string"?qe(this,La):this.between(i,i+Mt,!0,!0)},Te.prototype.startsWithIgnoreCase=function(i){return i===""?this.startsWith(i):Is(this,function(o,l){return o.indexOf(l[0])===0},[i],Mt)},Te.prototype.equalsIgnoreCase=function(i){return Is(this,function(o,l){return o===l[0]},[i],"")},Te.prototype.anyOfIgnoreCase=function(){var i=st.apply(Gt,arguments);return i.length===0?sn(this):Is(this,function(o,l){return l.indexOf(o)!==-1},i,"")},Te.prototype.startsWithAnyOfIgnoreCase=function(){var i=st.apply(Gt,arguments);return i.length===0?sn(this):Is(this,function(o,l){return l.some(function(u){return o.indexOf(u)===0})},i,Mt)},Te.prototype.anyOf=function(){var i=this,o=st.apply(Gt,arguments),l=this._cmp;try{o.sort(l)}catch{return qe(this,it)}if(o.length===0)return sn(this);var u=new this.Collection(this,function(){return yt(o[0],o[o.length-1])});u._ondirectionchange=function(p){l=p==="next"?i._ascending:i._descending,o.sort(l)};var d=0;return u._addAlgorithm(function(p,y,g){for(var w=p.key;0<l(w,o[d]);)if(++d===o.length)return y(g),!1;return l(w,o[d])===0||(y(function(){p.continue(o[d])}),!1)}),u},Te.prototype.notEqual=function(i){return this.inAnyRange([[-1/0,i],[i,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Te.prototype.noneOf=function(){var i=st.apply(Gt,arguments);if(i.length===0)return new this.Collection(this);try{i.sort(this._ascending)}catch{return qe(this,it)}var o=i.reduce(function(l,u){return l?l.concat([[l[l.length-1][1],u]]):[[-1/0,u]]},null);return o.push([i[i.length-1],this.db._maxKey]),this.inAnyRange(o,{includeLowers:!1,includeUppers:!1})},Te.prototype.inAnyRange=function(x,o){var l=this,u=this._cmp,d=this._ascending,p=this._descending,y=this._min,g=this._max;if(x.length===0)return sn(this);if(!x.every(function(M){return M[0]!==void 0&&M[1]!==void 0&&d(M[0],M[1])<=0}))return qe(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",se.InvalidArgument);var w=!o||o.includeLowers!==!1,k=o&&o.includeUppers===!0,T,v=d;function N(M,P){return v(M[0],P[0])}try{(T=x.reduce(function(M,P){for(var j=0,K=M.length;j<K;++j){var H=M[j];if(u(P[0],H[1])<0&&0<u(P[1],H[0])){H[0]=y(H[0],P[0]),H[1]=g(H[1],P[1]);break}}return j===K&&M.push(P),M},[])).sort(N)}catch{return qe(this,it)}var S=0,A=k?function(M){return 0<d(M,T[S][1])}:function(M){return 0<=d(M,T[S][1])},O=w?function(M){return 0<p(M,T[S][0])}:function(M){return 0<=p(M,T[S][0])},I=A,x=new this.Collection(this,function(){return yt(T[0][0],T[T.length-1][1],!w,!k)});return x._ondirectionchange=function(M){v=M==="next"?(I=A,d):(I=O,p),T.sort(N)},x._addAlgorithm(function(M,P,j){for(var K,H=M.key;I(H);)if(++S===T.length)return P(j),!1;return!A(K=H)&&!O(K)||(l._cmp(H,T[S][1])===0||l._cmp(H,T[S][0])===0||P(function(){v===d?M.continue(T[S][0]):M.continue(T[S][1])}),!1)}),x},Te.prototype.startsWithAnyOf=function(){var i=st.apply(Gt,arguments);return i.every(function(o){return typeof o=="string"})?i.length===0?sn(this):this.inAnyRange(i.map(function(o){return[o,o+Mt]})):qe(this,"startsWithAnyOf() only works with strings")},Te);function Te(){}function Qe(i){return be(function(o){return Kn(o),i(o.target.error),!1})}function Kn(i){i.stopPropagation&&i.stopPropagation(),i.preventDefault&&i.preventDefault()}var qn="storagemutated",Yi="x-storagemutated-1",gt=Dn(null,qn),Ll=(Xe.prototype._lock=function(){return Q(!Z.global),++this._reculock,this._reculock!==1||Z.global||(Z.lockOwnerFor=this),this},Xe.prototype._unlock=function(){if(Q(!Z.global),--this._reculock==0)for(Z.global||(Z.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var i=this._blockedFuncs.shift();try{xt(i[1],i[0])}catch{}}return this},Xe.prototype._locked=function(){return this._reculock&&Z.lockOwnerFor!==this},Xe.prototype.create=function(i){var o=this;if(!this.mode)return this;var l=this.db.idbdb,u=this.db._state.dbOpenError;if(Q(!this.idbtrans),!i&&!l)switch(u&&u.name){case"DatabaseClosedError":throw new se.DatabaseClosed(u);case"MissingAPIError":throw new se.MissingAPI(u.message,u);default:throw new se.OpenFailed(u)}if(!this.active)throw new se.TransactionInactive;return Q(this._completion._state===null),(i=this.idbtrans=i||(this.db.core||l).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=be(function(d){Kn(d),o._reject(i.error)}),i.onabort=be(function(d){Kn(d),o.active&&o._reject(new se.Abort(i.error)),o.active=!1,o.on("abort").fire(d)}),i.oncomplete=be(function(){o.active=!1,o._resolve(),"mutatedParts"in i&&gt.storagemutated.fire(i.mutatedParts)}),this},Xe.prototype._promise=function(i,o,l){var u=this;if(i==="readwrite"&&this.mode!=="readwrite")return Ee(new se.ReadOnly("Transaction is readonly"));if(!this.active)return Ee(new se.TransactionInactive);if(this._locked())return new z(function(p,y){u._blockedFuncs.push([function(){u._promise(i,o,l).then(p,y)},Z])});if(l)return ht(function(){var p=new z(function(y,g){u._lock();var w=o(y,g,u);w&&w.then&&w.then(y,g)});return p.finally(function(){return u._unlock()}),p._lib=!0,p});var d=new z(function(p,y){var g=o(p,y,u);g&&g.then&&g.then(p,y)});return d._lib=!0,d},Xe.prototype._root=function(){return this.parent?this.parent._root():this},Xe.prototype.waitFor=function(i){var o,l=this._root(),u=z.resolve(i);l._waitingFor?l._waitingFor=l._waitingFor.then(function(){return u}):(l._waitingFor=u,l._waitingQueue=[],o=l.idbtrans.objectStore(l.storeNames[0]),function p(){for(++l._spinCount;l._waitingQueue.length;)l._waitingQueue.shift()();l._waitingFor&&(o.get(-1/0).onsuccess=p)}());var d=l._waitingFor;return new z(function(p,y){u.then(function(g){return l._waitingQueue.push(be(p.bind(null,g)))},function(g){return l._waitingQueue.push(be(y.bind(null,g)))}).finally(function(){l._waitingFor===d&&(l._waitingFor=null)})})},Xe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new se.Abort))},Xe.prototype.table=function(i){var o=this._memoizedTables||(this._memoizedTables={});if(b(o,i))return o[i];var l=this.schema[i];if(!l)throw new se.NotFound("Table "+i+" not part of transaction");return l=new this.db.Table(i,l,this),l.core=this.db.core.table(i),o[i]=l},Xe);function Xe(){}function Ji(i,o,l,u,d,p,y){return{name:i,keyPath:o,unique:l,multi:u,auto:d,compound:p,src:(l&&!y?"&":"")+(u?"*":"")+(d?"++":"")+Ka(o)}}function Ka(i){return typeof i=="string"?i:i?"["+[].join.call(i,"+")+"]":""}function Gi(i,o,l){return{name:i,primKey:o,indexes:l,mappedClass:null,idxByName:(u=function(d){return[d.name,d]},l.reduce(function(d,p,y){return y=u(p,y),y&&(d[y[0]]=y[1]),d},{}))};var u}var Rn=function(i){try{return i.only([[]]),Rn=function(){return[[]]},[[]]}catch{return Rn=function(){return Mt},Mt}};function Wi(i){return i==null?function(){}:typeof i=="string"?(o=i).split(".").length===1?function(l){return l[o]}:function(l){return te(l,o)}:function(l){return te(l,i)};var o}function qa(i){return[].slice.call(i)}var Cl=0;function Fn(i){return i==null?":id":typeof i=="string"?i:"[".concat(i.join("+"),"]")}function Ol(i,o,w){function u(I){if(I.type===3)return null;if(I.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var S=I.lower,A=I.upper,O=I.lowerOpen,I=I.upperOpen;return S===void 0?A===void 0?null:o.upperBound(A,!!I):A===void 0?o.lowerBound(S,!!O):o.bound(S,A,!!O,!!I)}function d(N){var S,A=N.name;return{name:A,schema:N,mutate:function(O){var I=O.trans,x=O.type,M=O.keys,P=O.values,j=O.range;return new Promise(function(K,H){K=be(K);var q=I.objectStore(A),R=q.keyPath==null,U=x==="put"||x==="add";if(!U&&x!=="delete"&&x!=="deleteRange")throw new Error("Invalid operation type: "+x);var F,J=(M||P||{length:1}).length;if(M&&P&&M.length!==P.length)throw new Error("Given keys array must have same length as given values array.");if(J===0)return K({numFailures:0,failures:{},results:[],lastResult:void 0});function ce(Me){++Re,Kn(Me)}var le=[],ue=[],Re=0;if(x==="deleteRange"){if(j.type===4)return K({numFailures:Re,failures:ue,results:[],lastResult:void 0});j.type===3?le.push(F=q.clear()):le.push(F=q.delete(u(j)))}else{var R=U?R?[P,M]:[P,null]:[M,null],ae=R[0],Ne=R[1];if(U)for(var $e=0;$e<J;++$e)le.push(F=Ne&&Ne[$e]!==void 0?q[x](ae[$e],Ne[$e]):q[x](ae[$e])),F.onerror=ce;else for($e=0;$e<J;++$e)le.push(F=q[x](ae[$e])),F.onerror=ce}function Bs(Me){Me=Me.target.result,le.forEach(function(jt,pr){return jt.error!=null&&(ue[pr]=jt.error)}),K({numFailures:Re,failures:ue,results:x==="delete"?M:le.map(function(jt){return jt.result}),lastResult:Me})}F.onerror=function(Me){ce(Me),Bs(Me)},F.onsuccess=Bs})},getMany:function(O){var I=O.trans,x=O.keys;return new Promise(function(M,P){M=be(M);for(var j,K=I.objectStore(A),H=x.length,q=new Array(H),R=0,U=0,F=function(le){le=le.target,q[le._pos]=le.result,++U===R&&M(q)},J=Qe(P),ce=0;ce<H;++ce)x[ce]!=null&&((j=K.get(x[ce]))._pos=ce,j.onsuccess=F,j.onerror=J,++R);R===0&&M(q)})},get:function(O){var I=O.trans,x=O.key;return new Promise(function(M,P){M=be(M);var j=I.objectStore(A).get(x);j.onsuccess=function(K){return M(K.target.result)},j.onerror=Qe(P)})},query:(S=k,function(O){return new Promise(function(I,x){I=be(I);var M,P,j,R=O.trans,K=O.values,H=O.limit,F=O.query,q=H===1/0?void 0:H,U=F.index,F=F.range,R=R.objectStore(A),U=U.isPrimaryKey?R:R.index(U.name),F=u(F);if(H===0)return I({result:[]});S?((q=K?U.getAll(F,q):U.getAllKeys(F,q)).onsuccess=function(J){return I({result:J.target.result})},q.onerror=Qe(x)):(M=0,P=!K&&"openKeyCursor"in U?U.openKeyCursor(F):U.openCursor(F),j=[],P.onsuccess=function(J){var ce=P.result;return ce?(j.push(K?ce.value:ce.primaryKey),++M===H?I({result:j}):void ce.continue()):I({result:j})},P.onerror=Qe(x))})}),openCursor:function(O){var I=O.trans,x=O.values,M=O.query,P=O.reverse,j=O.unique;return new Promise(function(K,H){K=be(K);var U=M.index,q=M.range,R=I.objectStore(A),R=U.isPrimaryKey?R:R.index(U.name),U=P?j?"prevunique":"prev":j?"nextunique":"next",F=!x&&"openKeyCursor"in R?R.openKeyCursor(u(q),U):R.openCursor(u(q),U);F.onerror=Qe(H),F.onsuccess=be(function(J){var ce,le,ue,Re,ae=F.result;ae?(ae.___id=++Cl,ae.done=!1,ce=ae.continue.bind(ae),le=(le=ae.continuePrimaryKey)&&le.bind(ae),ue=ae.advance.bind(ae),Re=function(){throw new Error("Cursor not stopped")},ae.trans=I,ae.stop=ae.continue=ae.continuePrimaryKey=ae.advance=function(){throw new Error("Cursor not started")},ae.fail=be(H),ae.next=function(){var Ne=this,$e=1;return this.start(function(){return $e--?Ne.continue():Ne.stop()}).then(function(){return Ne})},ae.start=function(Ne){function $e(){if(F.result)try{Ne()}catch(Me){ae.fail(Me)}else ae.done=!0,ae.start=function(){throw new Error("Cursor behind last entry")},ae.stop()}var Bs=new Promise(function(Me,jt){Me=be(Me),F.onerror=Qe(jt),ae.fail=jt,ae.stop=function(pr){ae.stop=ae.continue=ae.continuePrimaryKey=ae.advance=Re,Me(pr)}});return F.onsuccess=be(function(Me){F.onsuccess=$e,$e()}),ae.continue=ce,ae.continuePrimaryKey=le,ae.advance=ue,$e(),Bs},K(ae)):K(null)},H)})},count:function(O){var I=O.query,x=O.trans,M=I.index,P=I.range;return new Promise(function(j,K){var H=x.objectStore(A),q=M.isPrimaryKey?H:H.index(M.name),H=u(P),q=H?q.count(H):q.count();q.onsuccess=be(function(R){return j(R.target.result)}),q.onerror=Qe(K)})}}}var p,y,g,T=(y=w,g=qa((p=i).objectStoreNames),{schema:{name:p.name,tables:g.map(function(N){return y.objectStore(N)}).map(function(N){var S=N.keyPath,I=N.autoIncrement,A=f(S),O={},I={name:N.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:S==null,compound:A,keyPath:S,autoIncrement:I,unique:!0,extractKey:Wi(S)},indexes:qa(N.indexNames).map(function(x){return N.index(x)}).map(function(j){var M=j.name,P=j.unique,K=j.multiEntry,j=j.keyPath,K={name:M,compound:f(j),keyPath:j,unique:P,multiEntry:K,extractKey:Wi(j)};return O[Fn(j)]=K}),getIndexByKeyPath:function(x){return O[Fn(x)]}};return O[":id"]=I.primaryKey,S!=null&&(O[Fn(S)]=I.primaryKey),I})},hasGetAll:0<g.length&&"getAll"in y.objectStore(g[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),w=T.schema,k=T.hasGetAll,T=w.tables.map(d),v={};return T.forEach(function(N){return v[N.name]=N}),{stack:"dbcore",transaction:i.transaction.bind(i),table:function(N){if(!v[N])throw new Error("Table '".concat(N,"' not found"));return v[N]},MIN_KEY:-1/0,MAX_KEY:Rn(o),schema:w}}function Nl(i,o,l,u){var d=l.IDBKeyRange;return l.indexedDB,{dbcore:(u=Ol(o,d,u),i.dbcore.reduce(function(p,y){return y=y.create,s(s({},p),y(p))},u))}}function _s(i,u){var l=u.db,u=Nl(i._middlewares,l,i._deps,u);i.core=u.dbcore,i.tables.forEach(function(d){var p=d.name;i.core.schema.tables.some(function(y){return y.name===p})&&(d.core=i.core.table(p),i[p]instanceof i.Table&&(i[p].core=d.core))})}function As(i,o,l,u){l.forEach(function(d){var p=u[d];o.forEach(function(y){var g=function w(k,T){return D(k,T)||(k=m(k))&&w(k,T)}(y,d);(!g||"value"in g&&g.value===void 0)&&(y===i.Transaction.prototype||y instanceof i.Transaction?B(y,d,{get:function(){return this.table(d)},set:function(w){L(this,d,{value:w,writable:!0,configurable:!0,enumerable:!0})}}):y[d]=new i.Table(d,p))})})}function Qi(i,o){o.forEach(function(l){for(var u in l)l[u]instanceof i.Table&&delete l[u]})}function $l(i,o){return i._cfg.version-o._cfg.version}function xl(i,o,l,u){var d=i._dbSchema;l.objectStoreNames.contains("$meta")&&!d.$meta&&(d.$meta=Gi("$meta",Fa("")[0],[]),i._storeNames.push("$meta"));var p=i._createTransaction("readwrite",i._storeNames,d);p.create(l),p._completion.catch(u);var y=p._reject.bind(p),g=Z.transless||Z;ht(function(){return Z.trans=p,Z.transless=g,o!==0?(_s(i,l),k=o,((w=p).storeNames.includes("$meta")?w.table("$meta").get("version").then(function(T){return T??k}):z.resolve(k)).then(function(T){return N=T,S=p,A=l,O=[],T=(v=i)._versions,I=v._dbSchema=Ls(0,v.idbdb,A),(T=T.filter(function(x){return x._cfg.version>=N})).length!==0?(T.forEach(function(x){O.push(function(){var M=I,P=x._cfg.dbschema;Cs(v,M,A),Cs(v,P,A),I=v._dbSchema=P;var j=Xi(M,P);j.add.forEach(function(U){Zi(A,U[0],U[1].primKey,U[1].indexes)}),j.change.forEach(function(U){if(U.recreate)throw new se.Upgrade("Not yet support for changing primary key");var F=A.objectStore(U.name);U.add.forEach(function(J){return Ts(F,J)}),U.change.forEach(function(J){F.deleteIndex(J.name),Ts(F,J)}),U.del.forEach(function(J){return F.deleteIndex(J)})});var K=x._cfg.contentUpgrade;if(K&&x._cfg.version>N){_s(v,A),S._memoizedTables={};var H=G(P);j.del.forEach(function(U){H[U]=M[U]}),Qi(v,[v.Transaction.prototype]),As(v,[v.Transaction.prototype],c(H),H),S.schema=H;var q,R=Ni(K);return R&&en(),j=z.follow(function(){var U;(q=K(S))&&R&&(U=pt.bind(null,null),q.then(U,U))}),q&&typeof q.then=="function"?z.resolve(q):j.then(function(){return q})}}),O.push(function(M){var P,j,K=x._cfg.dbschema;P=K,j=M,[].slice.call(j.db.objectStoreNames).forEach(function(H){return P[H]==null&&j.db.deleteObjectStore(H)}),Qi(v,[v.Transaction.prototype]),As(v,[v.Transaction.prototype],v._storeNames,v._dbSchema),S.schema=v._dbSchema}),O.push(function(M){v.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(v.idbdb.version/10)===x._cfg.version?(v.idbdb.deleteObjectStore("$meta"),delete v._dbSchema.$meta,v._storeNames=v._storeNames.filter(function(P){return P!=="$meta"})):M.objectStore("$meta").put(x._cfg.version,"version"))})}),function x(){return O.length?z.resolve(O.shift()(S.idbtrans)).then(x):z.resolve()}().then(function(){Ra(I,A)})):z.resolve();var v,N,S,A,O,I}).catch(y)):(c(d).forEach(function(T){Zi(l,T,d[T].primKey,d[T].indexes)}),_s(i,l),void z.follow(function(){return i.on.populate.fire(p)}).catch(y));var w,k})}function Ml(i,o){Ra(i._dbSchema,o),o.db.version%10!=0||o.objectStoreNames.contains("$meta")||o.db.createObjectStore("$meta").add(Math.ceil(o.db.version/10-1),"version");var l=Ls(0,i.idbdb,o);Cs(i,i._dbSchema,o);for(var u=0,d=Xi(l,i._dbSchema).change;u<d.length;u++){var p=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var g=o.objectStore(y.name);y.add.forEach(function(w){We&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(w.src)),Ts(g,w)})}(d[u]);if(typeof p=="object")return p.value}}function Xi(i,o){var l,u={del:[],add:[],change:[]};for(l in i)o[l]||u.del.push(l);for(l in o){var d=i[l],p=o[l];if(d){var y={name:l,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(d.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||d.primKey.auto!==p.primKey.auto)y.recreate=!0,u.change.push(y);else{var g=d.idxByName,w=p.idxByName,k=void 0;for(k in g)w[k]||y.del.push(k);for(k in w){var T=g[k],v=w[k];T?T.src!==v.src&&y.change.push(v):y.add.push(v)}(0<y.del.length||0<y.add.length||0<y.change.length)&&u.change.push(y)}}else u.add.push([l,p])}return u}function Zi(i,o,l,u){var d=i.db.createObjectStore(o,l.keyPath?{keyPath:l.keyPath,autoIncrement:l.auto}:{autoIncrement:l.auto});return u.forEach(function(p){return Ts(d,p)}),d}function Ra(i,o){c(i).forEach(function(l){o.db.objectStoreNames.contains(l)||(We&&console.debug("Dexie: Creating missing table",l),Zi(o,l,i[l].primKey,i[l].indexes))})}function Ts(i,o){i.createIndex(o.name,o.keyPath,{unique:o.unique,multiEntry:o.multi})}function Ls(i,o,l){var u={};return W(o.objectStoreNames,0).forEach(function(d){for(var p=l.objectStore(d),y=Ji(Ka(k=p.keyPath),k||"",!0,!1,!!p.autoIncrement,k&&typeof k!="string",!0),g=[],w=0;w<p.indexNames.length;++w){var T=p.index(p.indexNames[w]),k=T.keyPath,T=Ji(T.name,k,!!T.unique,!!T.multiEntry,!1,k&&typeof k!="string",!1);g.push(T)}u[d]=Gi(d,y,g)}),u}function Cs(i,o,l){for(var u=l.db.objectStoreNames,d=0;d<u.length;++d){var p=u[d],y=l.objectStore(p);i._hasGetAll="getAll"in y;for(var g=0;g<y.indexNames.length;++g){var w=y.indexNames[g],k=y.index(w).keyPath,T=typeof k=="string"?k:"["+W(k).join("+")+"]";!o[p]||(k=o[p].idxByName[T])&&(k.name=w,delete o[p].idxByName[T],o[p].idxByName[w]=k)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(i._hasGetAll=!1)}function Fa(i){return i.split(",").map(function(o,l){var u=(o=o.trim()).replace(/([&*]|\+\+)/g,""),d=/^\[/.test(u)?u.match(/^\[(.*)\]$/)[1].split("+"):u;return Ji(u,d||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),f(d),l===0)})}var Pl=(Os.prototype._parseStoresSpec=function(i,o){c(i).forEach(function(l){if(i[l]!==null){var u=Fa(i[l]),d=u.shift();if(d.unique=!0,d.multi)throw new se.Schema("Primary key cannot be multi-valued");u.forEach(function(p){if(p.auto)throw new se.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new se.Schema("Index must have a name and cannot be an empty string")}),o[l]=Gi(l,d,u)}})},Os.prototype.stores=function(l){var o=this.db;this._cfg.storesSource=this._cfg.storesSource?h(this._cfg.storesSource,l):l;var l=o._versions,u={},d={};return l.forEach(function(p){h(u,p._cfg.storesSource),d=p._cfg.dbschema={},p._parseStoresSpec(u,d)}),o._dbSchema=d,Qi(o,[o._allTables,o,o.Transaction.prototype]),As(o,[o._allTables,o,o.Transaction.prototype,this._cfg.tables],c(d),d),o._storeNames=c(d),this},Os.prototype.upgrade=function(i){return this._cfg.contentUpgrade=xi(this._cfg.contentUpgrade||pe,i),this},Os);function Os(){}function er(i,o){var l=i._dbNamesDB;return l||(l=i._dbNamesDB=new rt(ws,{addons:[],indexedDB:i,IDBKeyRange:o})).version(1).stores({dbnames:"name"}),l.table("dbnames")}function tr(i){return i&&typeof i.databases=="function"}function nr(i){return ht(function(){return Z.letThrough=!0,i()})}function sr(i){return!("from"in i)}var Oe=function(i,o){if(!this){var l=new Oe;return i&&"d"in i&&h(l,i),l}h(this,arguments.length?{d:1,from:i,to:1<arguments.length?o:i}:{d:0})};function Hn(i,o,l){var u=fe(o,l);if(!isNaN(u)){if(0<u)throw RangeError();if(sr(i))return h(i,{from:o,to:l,d:1});var d=i.l,u=i.r;if(fe(l,i.from)<0)return d?Hn(d,o,l):i.l={from:o,to:l,d:1,l:null,r:null},Ua(i);if(0<fe(o,i.to))return u?Hn(u,o,l):i.r={from:o,to:l,d:1,l:null,r:null},Ua(i);fe(o,i.from)<0&&(i.from=o,i.l=null,i.d=u?u.d+1:1),0<fe(l,i.to)&&(i.to=l,i.r=null,i.d=i.l?i.l.d+1:1),l=!i.r,d&&!i.l&&Un(i,d),u&&l&&Un(i,u)}}function Un(i,o){sr(o)||function l(u,w){var p=w.from,y=w.to,g=w.l,w=w.r;Hn(u,p,y),g&&l(u,g),w&&l(u,w)}(i,o)}function Ha(i,o){var l=Ns(o),u=l.next();if(u.done)return!1;for(var d=u.value,p=Ns(i),y=p.next(d.from),g=y.value;!u.done&&!y.done;){if(fe(g.from,d.to)<=0&&0<=fe(g.to,d.from))return!0;fe(d.from,g.from)<0?d=(u=l.next(g.from)).value:g=(y=p.next(d.from)).value}return!1}function Ns(i){var o=sr(i)?null:{s:0,n:i};return{next:function(l){for(var u=0<arguments.length;o;)switch(o.s){case 0:if(o.s=1,u)for(;o.n.l&&fe(l,o.n.from)<0;)o={up:o,n:o.n.l,s:1};else for(;o.n.l;)o={up:o,n:o.n.l,s:1};case 1:if(o.s=2,!u||fe(l,o.n.to)<=0)return{value:o.n,done:!1};case 2:if(o.n.r){o.s=3,o={up:o,n:o.n.r,s:0};continue}case 3:o=o.up}return{done:!0}}}}function Ua(i){var o,l,u=(((o=i.r)===null||o===void 0?void 0:o.d)||0)-(((l=i.l)===null||l===void 0?void 0:l.d)||0),d=1<u?"r":u<-1?"l":"";d&&(o=d=="r"?"l":"r",l=s({},i),u=i[d],i.from=u.from,i.to=u.to,i[d]=u[d],l[d]=u[o],(i[o]=l).d=za(l)),i.d=za(i)}function za(l){var o=l.r,l=l.l;return(o?l?Math.max(o.d,l.d):o.d:l?l.d:0)+1}function $s(i,o){return c(o).forEach(function(l){i[l]?Un(i[l],o[l]):i[l]=function u(d){var p,y,g={};for(p in d)b(d,p)&&(y=d[p],g[p]=!y||typeof y!="object"||nt.has(y.constructor)?y:u(y));return g}(o[l])}),i}function ir(i,o){return i.all||o.all||Object.keys(i).some(function(l){return o[l]&&Ha(o[l],i[l])})}E(Oe.prototype,((He={add:function(i){return Un(this,i),this},addKey:function(i){return Hn(this,i,i),this},addKeys:function(i){var o=this;return i.forEach(function(l){return Hn(o,l,l)}),this},hasKey:function(i){var o=Ns(this).next(i).value;return o&&fe(o.from,i)<=0&&0<=fe(o.to,i)}})[Oi]=function(){return Ns(this)},He));var Dt={},rr={},ar=!1;function xs(i){$s(rr,i),ar||(ar=!0,setTimeout(function(){ar=!1,or(rr,!(rr={}))},0))}function or(i,o){o===void 0&&(o=!1);var l=new Set;if(i.all)for(var u=0,d=Object.values(Dt);u<d.length;u++)Va(y=d[u],i,l,o);else for(var p in i){var y,g=/^idb\:\/\/(.*)\/(.*)\//.exec(p);g&&(p=g[1],g=g[2],(y=Dt["idb://".concat(p,"/").concat(g)])&&Va(y,i,l,o))}l.forEach(function(w){return w()})}function Va(i,o,l,u){for(var d=[],p=0,y=Object.entries(i.queries.query);p<y.length;p++){for(var g=y[p],w=g[0],k=[],T=0,v=g[1];T<v.length;T++){var N=v[T];ir(o,N.obsSet)?N.subscribers.forEach(function(I){return l.add(I)}):u&&k.push(N)}u&&d.push([w,k])}if(u)for(var S=0,A=d;S<A.length;S++){var O=A[S],w=O[0],k=O[1];i.queries.query[w]=k}}function Dl(i){var o=i._state,l=i._deps.indexedDB;if(o.isBeingOpened||i.idbdb)return o.dbReadyPromise.then(function(){return o.dbOpenError?Ee(o.dbOpenError):i});o.isBeingOpened=!0,o.dbOpenError=null,o.openComplete=!1;var u=o.openCanceller,d=Math.round(10*i.verno),p=!1;function y(){if(o.openCanceller!==u)throw new se.DatabaseClosed("db.open() was cancelled")}function g(){return new z(function(N,S){if(y(),!l)throw new se.MissingAPI;var A=i.name,O=o.autoSchema||!d?l.open(A):l.open(A,d);if(!O)throw new se.MissingAPI;O.onerror=Qe(S),O.onblocked=be(i._fireOnBlocked),O.onupgradeneeded=be(function(I){var x;T=O.transaction,o.autoSchema&&!i._options.allowEmptyDB?(O.onerror=Kn,T.abort(),O.result.close(),(x=l.deleteDatabase(A)).onsuccess=x.onerror=be(function(){S(new se.NoSuchDatabase("Database ".concat(A," doesnt exist")))})):(T.onerror=Qe(S),I=I.oldVersion>Math.pow(2,62)?0:I.oldVersion,v=I<1,i.idbdb=O.result,p&&Ml(i,T),xl(i,I/10,T,S))},S),O.onsuccess=be(function(){T=null;var I,x,M,P,j,K=i.idbdb=O.result,H=W(K.objectStoreNames);if(0<H.length)try{var q=K.transaction((P=H).length===1?P[0]:P,"readonly");if(o.autoSchema)x=K,M=q,(I=i).verno=x.version/10,M=I._dbSchema=Ls(0,x,M),I._storeNames=W(x.objectStoreNames,0),As(I,[I._allTables],c(M),M);else if(Cs(i,i._dbSchema,q),((j=Xi(Ls(0,(j=i).idbdb,q),j._dbSchema)).add.length||j.change.some(function(R){return R.add.length||R.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),K.close(),d=K.version+1,p=!0,N(g());_s(i,q)}catch{}tn.push(i),K.onversionchange=be(function(R){o.vcFired=!0,i.on("versionchange").fire(R)}),K.onclose=be(function(R){i.on("close").fire(R)}),v&&(j=i._deps,q=A,K=j.indexedDB,j=j.IDBKeyRange,tr(K)||q===ws||er(K,j).put({name:q}).catch(pe)),N()},S)}).catch(function(N){switch(N==null?void 0:N.name){case"UnknownError":if(0<o.PR1398_maxLoop)return o.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),g();break;case"VersionError":if(0<d)return d=0,g()}return z.reject(N)})}var w,k=o.dbReadyResolve,T=null,v=!1;return z.race([u,(typeof navigator>"u"?z.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(N){function S(){return indexedDB.databases().finally(N)}w=setInterval(S,100),S()}).finally(function(){return clearInterval(w)}):Promise.resolve()).then(g)]).then(function(){return y(),o.onReadyBeingFired=[],z.resolve(nr(function(){return i.on.ready.fire(i.vip)})).then(function N(){if(0<o.onReadyBeingFired.length){var S=o.onReadyBeingFired.reduce(xi,pe);return o.onReadyBeingFired=[],z.resolve(nr(function(){return S(i.vip)})).then(N)}})}).finally(function(){o.openCanceller===u&&(o.onReadyBeingFired=null,o.isBeingOpened=!1)}).catch(function(N){o.dbOpenError=N;try{T&&T.abort()}catch{}return u===o.openCanceller&&i._close(),Ee(N)}).finally(function(){o.openComplete=!0,k()}).then(function(){var N;return v&&(N={},i.tables.forEach(function(S){S.schema.indexes.forEach(function(A){A.name&&(N["idb://".concat(i.name,"/").concat(S.name,"/").concat(A.name)]=new Oe(-1/0,[[[]]]))}),N["idb://".concat(i.name,"/").concat(S.name,"/")]=N["idb://".concat(i.name,"/").concat(S.name,"/:dels")]=new Oe(-1/0,[[[]]])}),gt(qn).fire(N),or(N,!0)),i})}function cr(i){function o(p){return i.next(p)}var l=d(o),u=d(function(p){return i.throw(p)});function d(p){return function(w){var g=p(w),w=g.value;return g.done?w:w&&typeof w.then=="function"?w.then(l,u):f(w)?Promise.all(w).then(l,u):l(w)}}return d(o)()}function Ms(i,o,l){for(var u=f(i)?i.slice():[i],d=0;d<l;++d)u.push(o);return u}var Bl={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(i){return s(s({},i),{table:function(o){var l=i.table(o),u=l.schema,d={},p=[];function y(v,N,S){var A=Fn(v),O=d[A]=d[A]||[],I=v==null?0:typeof v=="string"?1:v.length,x=0<N,x=s(s({},S),{name:x?"".concat(A,"(virtual-from:").concat(S.name,")"):S.name,lowLevelIndex:S,isVirtual:x,keyTail:N,keyLength:I,extractKey:Wi(v),unique:!x&&S.unique});return O.push(x),x.isPrimaryKey||p.push(x),1<I&&y(I===2?v[0]:v.slice(0,I-1),N+1,S),O.sort(function(M,P){return M.keyTail-P.keyTail}),x}o=y(u.primaryKey.keyPath,0,u.primaryKey),d[":id"]=[o];for(var g=0,w=u.indexes;g<w.length;g++){var k=w[g];y(k.keyPath,0,k)}function T(v){var N,S=v.query.index;return S.isVirtual?s(s({},v),{query:{index:S.lowLevelIndex,range:(N=v.query.range,S=S.keyTail,{type:N.type===1?2:N.type,lower:Ms(N.lower,N.lowerOpen?i.MAX_KEY:i.MIN_KEY,S),lowerOpen:!0,upper:Ms(N.upper,N.upperOpen?i.MIN_KEY:i.MAX_KEY,S),upperOpen:!0})}}):v}return s(s({},l),{schema:s(s({},u),{primaryKey:o,indexes:p,getIndexByKeyPath:function(v){return(v=d[Fn(v)])&&v[0]}}),count:function(v){return l.count(T(v))},query:function(v){return l.query(T(v))},openCursor:function(v){var N=v.query.index,S=N.keyTail,A=N.isVirtual,O=N.keyLength;return A?l.openCursor(T(v)).then(function(x){return x&&I(x)}):l.openCursor(v);function I(x){return Object.create(x,{continue:{value:function(M){M!=null?x.continue(Ms(M,v.reverse?i.MAX_KEY:i.MIN_KEY,S)):v.unique?x.continue(x.key.slice(0,O).concat(v.reverse?i.MIN_KEY:i.MAX_KEY,S)):x.continue()}},continuePrimaryKey:{value:function(M,P){x.continuePrimaryKey(Ms(M,i.MAX_KEY,S),P)}},primaryKey:{get:function(){return x.primaryKey}},key:{get:function(){var M=x.key;return O===1?M[0]:M.slice(0,O)}},value:{get:function(){return x.value}}})}}})}})}};function lr(i,o,l,u){return l=l||{},u=u||"",c(i).forEach(function(d){var p,y,g;b(o,d)?(p=i[d],y=o[d],typeof p=="object"&&typeof y=="object"&&p&&y?(g=Ci(p))!==Ci(y)?l[u+d]=o[d]:g==="Object"?lr(p,y,l,u+d+"."):p!==y&&(l[u+d]=o[d]):p!==y&&(l[u+d]=o[d])):l[u+d]=void 0}),c(o).forEach(function(d){b(i,d)||(l[u+d]=o[d])}),l}function ur(i,o){return o.type==="delete"?o.keys:o.keys||o.values.map(i.extractKey)}var jl={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(i){return s(s({},i),{table:function(o){var l=i.table(o),u=l.schema.primaryKey;return s(s({},l),{mutate:function(d){var p=Z.trans,y=p.table(o).hook,g=y.deleting,w=y.creating,k=y.updating;switch(d.type){case"add":if(w.fire===pe)break;return p._promise("readwrite",function(){return T(d)},!0);case"put":if(w.fire===pe&&k.fire===pe)break;return p._promise("readwrite",function(){return T(d)},!0);case"delete":if(g.fire===pe)break;return p._promise("readwrite",function(){return T(d)},!0);case"deleteRange":if(g.fire===pe)break;return p._promise("readwrite",function(){return function v(N,S,A){return l.query({trans:N,values:!1,query:{index:u,range:S},limit:A}).then(function(O){var I=O.result;return T({type:"delete",keys:I,trans:N}).then(function(x){return 0<x.numFailures?Promise.reject(x.failures[0]):I.length<A?{failures:[],numFailures:0,lastResult:void 0}:v(N,s(s({},S),{lower:I[I.length-1],lowerOpen:!0}),A)})})}(d.trans,d.range,1e4)},!0)}return l.mutate(d);function T(v){var N,S,A,O=Z.trans,I=v.keys||ur(u,v);if(!I)throw new Error("Keys missing");return(v=v.type==="add"||v.type==="put"?s(s({},v),{keys:I}):s({},v)).type!=="delete"&&(v.values=r([],v.values)),v.keys&&(v.keys=r([],v.keys)),N=l,A=I,((S=v).type==="add"?Promise.resolve([]):N.getMany({trans:S.trans,keys:A,cache:"immutable"})).then(function(x){var M=I.map(function(P,j){var K,H,q,R=x[j],U={onerror:null,onsuccess:null};return v.type==="delete"?g.fire.call(U,P,R,O):v.type==="add"||R===void 0?(K=w.fire.call(U,P,v.values[j],O),P==null&&K!=null&&(v.keys[j]=P=K,u.outbound||oe(v.values[j],u.keyPath,P))):(K=lr(R,v.values[j]),(H=k.fire.call(U,K,P,R,O))&&(q=v.values[j],Object.keys(H).forEach(function(F){b(q,F)?q[F]=H[F]:oe(q,F,H[F])}))),U});return l.mutate(v).then(function(P){for(var j=P.failures,K=P.results,H=P.numFailures,P=P.lastResult,q=0;q<I.length;++q){var R=(K||I)[q],U=M[q];R==null?U.onerror&&U.onerror(j[q]):U.onsuccess&&U.onsuccess(v.type==="put"&&x[q]?v.values[q]:R)}return{failures:j,results:K,numFailures:H,lastResult:P}}).catch(function(P){return M.forEach(function(j){return j.onerror&&j.onerror(P)}),Promise.reject(P)})})}}})}})}};function Ya(i,o,l){try{if(!o||o.keys.length<i.length)return null;for(var u=[],d=0,p=0;d<o.keys.length&&p<i.length;++d)fe(o.keys[d],i[p])===0&&(u.push(l?Ge(o.values[d]):o.values[d]),++p);return u.length===i.length?u:null}catch{return null}}var Kl={stack:"dbcore",level:-1,create:function(i){return{table:function(o){var l=i.table(o);return s(s({},l),{getMany:function(u){if(!u.cache)return l.getMany(u);var d=Ya(u.keys,u.trans._cache,u.cache==="clone");return d?z.resolve(d):l.getMany(u).then(function(p){return u.trans._cache={keys:u.keys,values:u.cache==="clone"?Ge(p):p},p})},mutate:function(u){return u.type!=="add"&&(u.trans._cache=null),l.mutate(u)}})}}}};function Ja(i,o){return i.trans.mode==="readonly"&&!!i.subscr&&!i.trans.explicit&&i.trans.db._options.cache!=="disabled"&&!o.schema.primaryKey.outbound}function Ga(i,o){switch(i){case"query":return o.values&&!o.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var ql={stack:"dbcore",level:0,name:"Observability",create:function(i){var o=i.schema.name,l=new Oe(i.MIN_KEY,i.MAX_KEY);return s(s({},i),{transaction:function(u,d,p){if(Z.subscr&&d!=="readonly")throw new se.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(Z.querier));return i.transaction(u,d,p)},table:function(u){var d=i.table(u),p=d.schema,y=p.primaryKey,v=p.indexes,g=y.extractKey,w=y.outbound,k=y.autoIncrement&&v.filter(function(S){return S.compound&&S.keyPath.includes(y.keyPath)}),T=s(s({},d),{mutate:function(S){function A(F){return F="idb://".concat(o,"/").concat(u,"/").concat(F),P[F]||(P[F]=new Oe)}var O,I,x,M=S.trans,P=S.mutatedParts||(S.mutatedParts={}),j=A(""),K=A(":dels"),H=S.type,U=S.type==="deleteRange"?[S.range]:S.type==="delete"?[S.keys]:S.values.length<50?[ur(y,S).filter(function(F){return F}),S.values]:[],q=U[0],R=U[1],U=S.trans._cache;return f(q)?(j.addKeys(q),(U=H==="delete"||q.length===R.length?Ya(q,U):null)||K.addKeys(q),(U||R)&&(O=A,I=U,x=R,p.indexes.forEach(function(F){var J=O(F.name||"");function ce(ue){return ue!=null?F.extractKey(ue):null}function le(ue){return F.multiEntry&&f(ue)?ue.forEach(function(Re){return J.addKey(Re)}):J.addKey(ue)}(I||x).forEach(function(ue,Ne){var ae=I&&ce(I[Ne]),Ne=x&&ce(x[Ne]);fe(ae,Ne)!==0&&(ae!=null&&le(ae),Ne!=null&&le(Ne))})}))):q?(R={from:(R=q.lower)!==null&&R!==void 0?R:i.MIN_KEY,to:(R=q.upper)!==null&&R!==void 0?R:i.MAX_KEY},K.add(R),j.add(R)):(j.add(l),K.add(l),p.indexes.forEach(function(F){return A(F.name).add(l)})),d.mutate(S).then(function(F){return!q||S.type!=="add"&&S.type!=="put"||(j.addKeys(F.results),k&&k.forEach(function(J){for(var ce=S.values.map(function(ae){return J.extractKey(ae)}),le=J.keyPath.findIndex(function(ae){return ae===y.keyPath}),ue=0,Re=F.results.length;ue<Re;++ue)ce[ue][le]=F.results[ue];A(J.name).addKeys(ce)})),M.mutatedParts=$s(M.mutatedParts||{},P),F})}}),v=function(A){var O=A.query,A=O.index,O=O.range;return[A,new Oe((A=O.lower)!==null&&A!==void 0?A:i.MIN_KEY,(O=O.upper)!==null&&O!==void 0?O:i.MAX_KEY)]},N={get:function(S){return[y,new Oe(S.key)]},getMany:function(S){return[y,new Oe().addKeys(S.keys)]},count:v,query:v,openCursor:v};return c(N).forEach(function(S){T[S]=function(A){var O=Z.subscr,I=!!O,x=Ja(Z,d)&&Ga(S,A)?A.obsSet={}:O;if(I){var M=function(R){return R="idb://".concat(o,"/").concat(u,"/").concat(R),x[R]||(x[R]=new Oe)},P=M(""),j=M(":dels"),O=N[S](A),I=O[0],O=O[1];if((S==="query"&&I.isPrimaryKey&&!A.values?j:M(I.name||"")).add(O),!I.isPrimaryKey){if(S!=="count"){var K=S==="query"&&w&&A.values&&d.query(s(s({},A),{values:!1}));return d[S].apply(this,arguments).then(function(R){if(S==="query"){if(w&&A.values)return K.then(function(ce){return ce=ce.result,P.addKeys(ce),R});var U=A.values?R.result.map(g):R.result;(A.values?P:j).addKeys(U)}else if(S==="openCursor"){var F=R,J=A.values;return F&&Object.create(F,{key:{get:function(){return j.addKey(F.primaryKey),F.key}},primaryKey:{get:function(){var ce=F.primaryKey;return j.addKey(ce),ce}},value:{get:function(){return J&&P.addKey(F.primaryKey),F.value}}})}return R})}j.add(l)}}return d[S].apply(this,arguments)}}),T}})}};function Wa(i,o,l){if(l.numFailures===0)return o;if(o.type==="deleteRange")return null;var u=o.keys?o.keys.length:"values"in o&&o.values?o.values.length:1;return l.numFailures===u?null:(o=s({},o),f(o.keys)&&(o.keys=o.keys.filter(function(d,p){return!(p in l.failures)})),"values"in o&&f(o.values)&&(o.values=o.values.filter(function(d,p){return!(p in l.failures)})),o)}function fr(i,o){return l=i,((u=o).lower===void 0||(u.lowerOpen?0<fe(l,u.lower):0<=fe(l,u.lower)))&&(i=i,(o=o).upper===void 0||(o.upperOpen?fe(i,o.upper)<0:fe(i,o.upper)<=0));var l,u}function Qa(i,o,N,u,d,p){if(!N||N.length===0)return i;var y=o.query.index,g=y.multiEntry,w=o.query.range,k=u.schema.primaryKey.extractKey,T=y.extractKey,v=(y.lowLevelIndex||y).extractKey,N=N.reduce(function(S,A){var O=S,I=[];if(A.type==="add"||A.type==="put")for(var x=new Oe,M=A.values.length-1;0<=M;--M){var P,j=A.values[M],K=k(j);x.hasKey(K)||(P=T(j),(g&&f(P)?P.some(function(F){return fr(F,w)}):fr(P,w))&&(x.addKey(K),I.push(j)))}switch(A.type){case"add":var H=new Oe().addKeys(o.values?S.map(function(J){return k(J)}):S),O=S.concat(o.values?I.filter(function(J){return J=k(J),!H.hasKey(J)&&(H.addKey(J),!0)}):I.map(function(J){return k(J)}).filter(function(J){return!H.hasKey(J)&&(H.addKey(J),!0)}));break;case"put":var q=new Oe().addKeys(A.values.map(function(J){return k(J)}));O=S.filter(function(J){return!q.hasKey(o.values?k(J):J)}).concat(o.values?I:I.map(function(J){return k(J)}));break;case"delete":var R=new Oe().addKeys(A.keys);O=S.filter(function(J){return!R.hasKey(o.values?k(J):J)});break;case"deleteRange":var U=A.range;O=S.filter(function(J){return!fr(k(J),U)})}return O},i);return N===i?i:(N.sort(function(S,A){return fe(v(S),v(A))||fe(k(S),k(A))}),o.limit&&o.limit<1/0&&(N.length>o.limit?N.length=o.limit:i.length===o.limit&&N.length<o.limit&&(d.dirty=!0)),p?Object.freeze(N):N)}function Xa(i,o){return fe(i.lower,o.lower)===0&&fe(i.upper,o.upper)===0&&!!i.lowerOpen==!!o.lowerOpen&&!!i.upperOpen==!!o.upperOpen}function Rl(i,o){return function(l,u,d,p){if(l===void 0)return u!==void 0?-1:0;if(u===void 0)return 1;if((u=fe(l,u))===0){if(d&&p)return 0;if(d)return 1;if(p)return-1}return u}(i.lower,o.lower,i.lowerOpen,o.lowerOpen)<=0&&0<=function(l,u,d,p){if(l===void 0)return u!==void 0?1:0;if(u===void 0)return-1;if((u=fe(l,u))===0){if(d&&p)return 0;if(d)return-1;if(p)return 1}return u}(i.upper,o.upper,i.upperOpen,o.upperOpen)}function Fl(i,o,l,u){i.subscribers.add(l),u.addEventListener("abort",function(){var d,p;i.subscribers.delete(l),i.subscribers.size===0&&(d=i,p=o,setTimeout(function(){d.subscribers.size===0&&Tt(p,d)},3e3))})}var Hl={stack:"dbcore",level:0,name:"Cache",create:function(i){var o=i.schema.name;return s(s({},i),{transaction:function(l,u,d){var p,y,g=i.transaction(l,u,d);return u==="readwrite"&&(y=(p=new AbortController).signal,d=function(w){return function(){if(p.abort(),u==="readwrite"){for(var k=new Set,T=0,v=l;T<v.length;T++){var N=v[T],S=Dt["idb://".concat(o,"/").concat(N)];if(S){var A=i.table(N),O=S.optimisticOps.filter(function(J){return J.trans===g});if(g._explicit&&w&&g.mutatedParts)for(var I=0,x=Object.values(S.queries.query);I<x.length;I++)for(var M=0,P=(H=x[I]).slice();M<P.length;M++)ir((q=P[M]).obsSet,g.mutatedParts)&&(Tt(H,q),q.subscribers.forEach(function(J){return k.add(J)}));else if(0<O.length){S.optimisticOps=S.optimisticOps.filter(function(J){return J.trans!==g});for(var j=0,K=Object.values(S.queries.query);j<K.length;j++)for(var H,q,R,U=0,F=(H=K[j]).slice();U<F.length;U++)(q=F[U]).res!=null&&g.mutatedParts&&(w&&!q.dirty?(R=Object.isFrozen(q.res),R=Qa(q.res,q.req,O,A,q,R),q.dirty?(Tt(H,q),q.subscribers.forEach(function(J){return k.add(J)})):R!==q.res&&(q.res=R,q.promise=z.resolve({result:R}))):(q.dirty&&Tt(H,q),q.subscribers.forEach(function(J){return k.add(J)})))}}}k.forEach(function(J){return J()})}}},g.addEventListener("abort",d(!1),{signal:y}),g.addEventListener("error",d(!1),{signal:y}),g.addEventListener("complete",d(!0),{signal:y})),g},table:function(l){var u=i.table(l),d=u.schema.primaryKey;return s(s({},u),{mutate:function(p){var y=Z.trans;if(d.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return u.mutate(p);var g=Dt["idb://".concat(o,"/").concat(l)];return g?(y=u.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||ur(d,p).some(function(w){return w==null}))?(g.optimisticOps.push(p),p.mutatedParts&&xs(p.mutatedParts),y.then(function(w){0<w.numFailures&&(Tt(g.optimisticOps,p),(w=Wa(0,p,w))&&g.optimisticOps.push(w),p.mutatedParts&&xs(p.mutatedParts))}),y.catch(function(){Tt(g.optimisticOps,p),p.mutatedParts&&xs(p.mutatedParts)})):y.then(function(w){var k=Wa(0,s(s({},p),{values:p.values.map(function(T,v){var N;return w.failures[v]?T:(T=(N=d.keyPath)!==null&&N!==void 0&&N.includes(".")?Ge(T):s({},T),oe(T,d.keyPath,w.results[v]),T)})}),w);g.optimisticOps.push(k),queueMicrotask(function(){return p.mutatedParts&&xs(p.mutatedParts)})}),y):u.mutate(p)},query:function(p){if(!Ja(Z,u)||!Ga("query",p))return u.query(p);var y=((k=Z.trans)===null||k===void 0?void 0:k.db._options.cache)==="immutable",v=Z,g=v.requery,w=v.signal,k=function(A,O,I,x){var M=Dt["idb://".concat(A,"/").concat(O)];if(!M)return[];if(!(O=M.queries[I]))return[null,!1,M,null];var P=O[(x.query?x.query.index.name:null)||""];if(!P)return[null,!1,M,null];switch(I){case"query":var j=P.find(function(K){return K.req.limit===x.limit&&K.req.values===x.values&&Xa(K.req.query.range,x.query.range)});return j?[j,!0,M,P]:[P.find(function(K){return("limit"in K.req?K.req.limit:1/0)>=x.limit&&(!x.values||K.req.values)&&Rl(K.req.query.range,x.query.range)}),!1,M,P];case"count":return j=P.find(function(K){return Xa(K.req.query.range,x.query.range)}),[j,!!j,M,P]}}(o,l,"query",p),T=k[0],v=k[1],N=k[2],S=k[3];return T&&v?T.obsSet=p.obsSet:(v=u.query(p).then(function(A){var O=A.result;if(T&&(T.res=O),y){for(var I=0,x=O.length;I<x;++I)Object.freeze(O[I]);Object.freeze(O)}else A.result=Ge(O);return A}).catch(function(A){return S&&T&&Tt(S,T),Promise.reject(A)}),T={obsSet:p.obsSet,promise:v,subscribers:new Set,type:"query",req:p,dirty:!1},S?S.push(T):(S=[T],(N=N||(Dt["idb://".concat(o,"/").concat(l)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=S)),Fl(T,S,g,w),T.promise.then(function(A){return{result:Qa(A.result,p,N==null?void 0:N.optimisticOps,u,T,y)}})}})}})}};function Ps(i,o){return new Proxy(i,{get:function(l,u,d){return u==="db"?o:Reflect.get(l,u,d)}})}var rt=(Ie.prototype.version=function(i){if(isNaN(i)||i<.1)throw new se.Type("Given version is not a positive number");if(i=Math.round(10*i)/10,this.idbdb||this._state.isBeingOpened)throw new se.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,i);var o=this._versions,l=o.filter(function(u){return u._cfg.version===i})[0];return l||(l=new this.Version(i),o.push(l),o.sort($l),l.stores({}),this._state.autoSchema=!1,l)},Ie.prototype._whenReady=function(i){var o=this;return this.idbdb&&(this._state.openComplete||Z.letThrough||this._vip)?i():new z(function(l,u){if(o._state.openComplete)return u(new se.DatabaseClosed(o._state.dbOpenError));if(!o._state.isBeingOpened){if(!o._state.autoOpen)return void u(new se.DatabaseClosed);o.open().catch(pe)}o._state.dbReadyPromise.then(l,u)}).then(i)},Ie.prototype.use=function(i){var o=i.stack,l=i.create,u=i.level,d=i.name;return d&&this.unuse({stack:o,name:d}),i=this._middlewares[o]||(this._middlewares[o]=[]),i.push({stack:o,create:l,level:u??10,name:d}),i.sort(function(p,y){return p.level-y.level}),this},Ie.prototype.unuse=function(i){var o=i.stack,l=i.name,u=i.create;return o&&this._middlewares[o]&&(this._middlewares[o]=this._middlewares[o].filter(function(d){return u?d.create!==u:!!l&&d.name!==l})),this},Ie.prototype.open=function(){var i=this;return xt(dt,function(){return Dl(i)})},Ie.prototype._close=function(){var i=this._state,o=tn.indexOf(this);if(0<=o&&tn.splice(o,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}i.isBeingOpened||(i.dbReadyPromise=new z(function(l){i.dbReadyResolve=l}),i.openCanceller=new z(function(l,u){i.cancelOpen=u}))},Ie.prototype.close=function(l){var o=(l===void 0?{disableAutoOpen:!0}:l).disableAutoOpen,l=this._state;o?(l.isBeingOpened&&l.cancelOpen(new se.DatabaseClosed),this._close(),l.autoOpen=!1,l.dbOpenError=new se.DatabaseClosed):(this._close(),l.autoOpen=this._options.autoOpen||l.isBeingOpened,l.openComplete=!1,l.dbOpenError=null)},Ie.prototype.delete=function(i){var o=this;i===void 0&&(i={disableAutoOpen:!0});var l=0<arguments.length&&typeof arguments[0]!="object",u=this._state;return new z(function(d,p){function y(){o.close(i);var g=o._deps.indexedDB.deleteDatabase(o.name);g.onsuccess=be(function(){var w,k,T;w=o._deps,k=o.name,T=w.indexedDB,w=w.IDBKeyRange,tr(T)||k===ws||er(T,w).delete(k).catch(pe),d()}),g.onerror=Qe(p),g.onblocked=o._fireOnBlocked}if(l)throw new se.InvalidArgument("Invalid closeOptions argument to db.delete()");u.isBeingOpened?u.dbReadyPromise.then(y):y()})},Ie.prototype.backendDB=function(){return this.idbdb},Ie.prototype.isOpen=function(){return this.idbdb!==null},Ie.prototype.hasBeenClosed=function(){var i=this._state.dbOpenError;return i&&i.name==="DatabaseClosed"},Ie.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ie.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ie.prototype,"tables",{get:function(){var i=this;return c(this._allTables).map(function(o){return i._allTables[o]})},enumerable:!1,configurable:!0}),Ie.prototype.transaction=function(){var i=(function(o,l,u){var d=arguments.length;if(d<2)throw new se.InvalidArgument("Too few arguments");for(var p=new Array(d-1);--d;)p[d-1]=arguments[d];return u=p.pop(),[o,Ve(p),u]}).apply(this,arguments);return this._transaction.apply(this,i)},Ie.prototype._transaction=function(i,o,l){var u=this,d=Z.trans;d&&d.db===this&&i.indexOf("!")===-1||(d=null);var p,y,g=i.indexOf("?")!==-1;i=i.replace("!","").replace("?","");try{if(y=o.map(function(k){if(k=k instanceof u.Table?k.name:k,typeof k!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return k}),i=="r"||i===Fi)p=Fi;else{if(i!="rw"&&i!=Hi)throw new se.InvalidArgument("Invalid transaction mode: "+i);p=Hi}if(d){if(d.mode===Fi&&p===Hi){if(!g)throw new se.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");d=null}d&&y.forEach(function(k){if(d&&d.storeNames.indexOf(k)===-1){if(!g)throw new se.SubTransaction("Table "+k+" not included in parent transaction.");d=null}}),g&&d&&!d.active&&(d=null)}}catch(k){return d?d._promise(null,function(T,v){v(k)}):Ee(k)}var w=(function k(T,v,N,S,A){return z.resolve().then(function(){var O=Z.transless||Z,I=T._createTransaction(v,N,T._dbSchema,S);if(I.explicit=!0,O={trans:I,transless:O},S)I.idbtrans=S.idbtrans;else try{I.create(),I.idbtrans._explicit=!0,T._state.PR1398_maxLoop=3}catch(P){return P.name===$i.InvalidState&&T.isOpen()&&0<--T._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),T.close({disableAutoOpen:!1}),T.open().then(function(){return k(T,v,N,null,A)})):Ee(P)}var x,M=Ni(A);return M&&en(),O=z.follow(function(){var P;(x=A.call(I,I))&&(M?(P=pt.bind(null,null),x.then(P,P)):typeof x.next=="function"&&typeof x.throw=="function"&&(x=cr(x)))},O),(x&&typeof x.then=="function"?z.resolve(x).then(function(P){return I.active?P:Ee(new se.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):O.then(function(){return x})).then(function(P){return S&&I._resolve(),I._completion.then(function(){return P})}).catch(function(P){return I._reject(P),Ee(P)})})}).bind(null,this,p,y,d,l);return d?d._promise(p,w,"lock"):Z.trans?xt(Z.transless,function(){return u._whenReady(w)}):this._whenReady(w)},Ie.prototype.table=function(i){if(!b(this._allTables,i))throw new se.InvalidTable("Table ".concat(i," does not exist"));return this._allTables[i]},Ie);function Ie(i,o){var l=this;this._middlewares={},this.verno=0;var u=Ie.dependencies;this._options=o=s({addons:Ie.addons,autoOpen:!0,indexedDB:u.indexedDB,IDBKeyRange:u.IDBKeyRange,cache:"cloned"},o),this._deps={indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},u=o.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var d,p,y,g,w,k={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:pe,dbReadyPromise:null,cancelOpen:pe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:o.autoOpen};k.dbReadyPromise=new z(function(v){k.dbReadyResolve=v}),k.openCanceller=new z(function(v,N){k.cancelOpen=N}),this._state=k,this.name=i,this.on=Dn(this,"populate","blocked","versionchange","close",{ready:[xi,pe]}),this.on.ready.subscribe=X(this.on.ready.subscribe,function(v){return function(N,S){Ie.vip(function(){var A,O=l._state;O.openComplete?(O.dbOpenError||z.resolve().then(N),S&&v(N)):O.onReadyBeingFired?(O.onReadyBeingFired.push(N),S&&v(N)):(v(N),A=l,S||v(function I(){A.on.ready.unsubscribe(N),A.on.ready.unsubscribe(I)}))})}}),this.Collection=(d=this,Bn(_l.prototype,function(x,I){this.db=d;var S=Ca,A=null;if(I)try{S=I()}catch(M){A=M}var O=x._ctx,I=O.table,x=I.hook.reading.fire;this._ctx={table:I,index:O.index,isPrimKey:!O.index||I.schema.primKey.keyPath&&O.index===I.schema.primKey.name,range:S,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:A,or:O.or,valueMapper:x!==Nn?x:null}})),this.Table=(p=this,Bn(xa.prototype,function(v,N,S){this.db=p,this._tx=S,this.name=v,this.schema=N,this.hook=p._allTables[v]?p._allTables[v].hook:Dn(null,{creating:[yl,pe],reading:[ml,Nn],updating:[vl,pe],deleting:[gl,pe]})})),this.Transaction=(y=this,Bn(Ll.prototype,function(v,N,S,A,O){var I=this;this.db=y,this.mode=v,this.storeNames=N,this.schema=S,this.chromeTransactionDurability=A,this.idbtrans=null,this.on=Dn(this,"complete","error","abort"),this.parent=O||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new z(function(x,M){I._resolve=x,I._reject=M}),this._completion.then(function(){I.active=!1,I.on.complete.fire()},function(x){var M=I.active;return I.active=!1,I.on.error.fire(x),I.parent?I.parent._reject(x):M&&I.idbtrans&&I.idbtrans.abort(),Ee(x)})})),this.Version=(g=this,Bn(Pl.prototype,function(v){this.db=g,this._cfg={version:v,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(w=this,Bn(ja.prototype,function(v,N,S){if(this.db=w,this._ctx={table:v,index:N===":id"?null:N,or:S},this._cmp=this._ascending=fe,this._descending=function(A,O){return fe(O,A)},this._max=function(A,O){return 0<fe(A,O)?A:O},this._min=function(A,O){return fe(A,O)<0?A:O},this._IDBKeyRange=w._deps.IDBKeyRange,!this._IDBKeyRange)throw new se.MissingAPI})),this.on("versionchange",function(v){0<v.newVersion?console.warn("Another connection wants to upgrade database '".concat(l.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(l.name,"'. Closing db now to resume the delete request.")),l.close({disableAutoOpen:!1})}),this.on("blocked",function(v){!v.newVersion||v.newVersion<v.oldVersion?console.warn("Dexie.delete('".concat(l.name,"') was blocked")):console.warn("Upgrade '".concat(l.name,"' blocked by other connection holding version ").concat(v.oldVersion/10))}),this._maxKey=Rn(o.IDBKeyRange),this._createTransaction=function(v,N,S,A){return new l.Transaction(v,N,S,l._options.chromeTransactionDurability,A)},this._fireOnBlocked=function(v){l.on("blocked").fire(v),tn.filter(function(N){return N.name===l.name&&N!==l&&!N._state.vcFired}).map(function(N){return N.on("versionchange").fire(v)})},this.use(Kl),this.use(Hl),this.use(ql),this.use(Bl),this.use(jl);var T=new Proxy(this,{get:function(v,N,S){if(N==="_vip")return!0;if(N==="table")return function(O){return Ps(l.table(O),T)};var A=Reflect.get(v,N,S);return A instanceof xa?Ps(A,T):N==="tables"?A.map(function(O){return Ps(O,T)}):N==="_createTransaction"?function(){return Ps(A.apply(this,arguments),T)}:A}});this.vip=T,u.forEach(function(v){return v(l)})}var Ds,He=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Ul=(dr.prototype.subscribe=function(i,o,l){return this._subscribe(i&&typeof i!="function"?i:{next:i,error:o,complete:l})},dr.prototype[He]=function(){return this},dr);function dr(i){this._subscribe=i}try{Ds={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{Ds={indexedDB:null,IDBKeyRange:null}}function Za(i){var o,l=!1,u=new Ul(function(d){var p=Ni(i),y,g=!1,w={},k={},T={get closed(){return g},unsubscribe:function(){g||(g=!0,y&&y.abort(),v&&gt.storagemutated.unsubscribe(S))}};d.start&&d.start(T);var v=!1,N=function(){return Ri(A)},S=function(O){$s(w,O),ir(k,w)&&N()},A=function(){var O,I,x;!g&&Ds.indexedDB&&(w={},O={},y&&y.abort(),y=new AbortController,x=function(M){var P=Xt();try{p&&en();var j=ht(i,M);return j=p?j.finally(pt):j}finally{P&&Zt()}}(I={subscr:O,signal:y.signal,requery:N,querier:i,trans:null}),Promise.resolve(x).then(function(M){l=!0,o=M,g||I.signal.aborted||(w={},function(P){for(var j in P)if(b(P,j))return;return 1}(k=O)||v||(gt(qn,S),v=!0),Ri(function(){return!g&&d.next&&d.next(M)}))},function(M){l=!1,["DatabaseClosedError","AbortError"].includes(M==null?void 0:M.name)||g||Ri(function(){g||d.error&&d.error(M)})}))};return setTimeout(N,0),T});return u.hasValue=function(){return l},u.getValue=function(){return o},u}var Bt=rt;function hr(i){var o=vt;try{vt=!0,gt.storagemutated.fire(i),or(i,!0)}finally{vt=o}}E(Bt,s(s({},fs),{delete:function(i){return new Bt(i,{addons:[]}).delete()},exists:function(i){return new Bt(i,{addons:[]}).open().then(function(o){return o.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(i){try{return o=Bt.dependencies,l=o.indexedDB,o=o.IDBKeyRange,(tr(l)?Promise.resolve(l.databases()).then(function(u){return u.map(function(d){return d.name}).filter(function(d){return d!==ws})}):er(l,o).toCollection().primaryKeys()).then(i)}catch{return Ee(new se.MissingAPI)}var o,l},defineClass:function(){return function(i){h(this,i)}},ignoreTransaction:function(i){return Z.trans?xt(Z.transless,i):i()},vip:nr,async:function(i){return function(){try{var o=cr(i.apply(this,arguments));return o&&typeof o.then=="function"?o:z.resolve(o)}catch(l){return Ee(l)}}},spawn:function(i,o,l){try{var u=cr(i.apply(l,o||[]));return u&&typeof u.then=="function"?u:z.resolve(u)}catch(d){return Ee(d)}},currentTransaction:{get:function(){return Z.trans||null}},waitFor:function(i,o){return o=z.resolve(typeof i=="function"?Bt.ignoreTransaction(i):i).timeout(o||6e4),Z.trans?Z.trans.waitFor(o):o},Promise:z,debug:{get:function(){return We},set:function(i){ka(i)}},derive:C,extend:h,props:E,override:X,Events:Dn,on:gt,liveQuery:Za,extendObservabilitySet:$s,getByKeyPath:te,setByKeyPath:oe,delByKeyPath:function(i,o){typeof o=="string"?oe(i,o,void 0):"length"in o&&[].map.call(o,function(l){oe(i,l,void 0)})},shallowClone:G,deepClone:Ge,getObjectDiff:lr,cmp:fe,asap:ee,minKey:-1/0,addons:[],connections:tn,errnames:$i,dependencies:Ds,cache:Dt,semVer:"4.0.11",version:"4.0.11".split(".").map(function(i){return parseInt(i)}).reduce(function(i,o,l){return i+o/Math.pow(10,2*l)})})),Bt.maxKey=Rn(Bt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(gt(qn,function(i){vt||(i=new CustomEvent(Yi,{detail:i}),vt=!0,dispatchEvent(i),vt=!1)}),addEventListener(Yi,function(i){i=i.detail,vt||hr(i)}));var rn,vt=!1,eo=function(){};return typeof BroadcastChannel<"u"&&((eo=function(){(rn=new BroadcastChannel(Yi)).onmessage=function(i){return i.data&&hr(i.data)}})(),typeof rn.unref=="function"&&rn.unref(),gt(qn,function(i){vt||rn.postMessage(i)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(i){if(!rt.disableBfCache&&i.persisted){We&&console.debug("Dexie: handling persisted pagehide"),rn!=null&&rn.close();for(var o=0,l=tn;o<l.length;o++)l[o].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(i){!rt.disableBfCache&&i.persisted&&(We&&console.debug("Dexie: handling persisted pageshow"),eo(),hr({all:new Oe(-1/0,[[]])}))})),z.rejectionMapper=function(i,o){return!i||i instanceof Wt||i instanceof TypeError||i instanceof SyntaxError||!i.name||!Sa[i.name]?i:(o=new Sa[i.name](o||i.message,i),"stack"in i&&B(o,"stack",{get:function(){return this.inner.stack}}),o)},ka(We),s(rt,Object.freeze({__proto__:null,Dexie:rt,liveQuery:Za,Entity:Oa,cmp:fe,PropModification:jn,replacePrefix:function(i,o){return new jn({replacePrefix:[i,o]})},add:function(i){return new jn({add:i})},remove:function(i){return new jn({remove:i})},default:rt,RangeSet:Oe,mergeRanges:Un,rangesOverlap:Ha}),{default:rt}),rt})})(Ho);var Jl=Ho.exports;const Pr=Yl(Jl),so=Symbol.for("Dexie"),ri=globalThis[so]||(globalThis[so]=Pr);if(Pr.semVer!==ri.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Pr.semVer} and ${ri.semVer}`);const{liveQuery:Zh,mergeRanges:ep,rangesOverlap:tp,RangeSet:np,cmp:sp,Entity:ip,PropModification:rp,replacePrefix:ap,add:op,remove:cp}=ri,Gl="MdAnkiDatabase",Wl=2,Dr=`# 新文件

开始编写您的内容...

::> 这是一个可折叠的标题
    这里是折叠的内容。
    - 甚至可以包含列表
    - 和其他 Markdown 元素。
    \`\`\`javascript
    // 也可以包含代码块
    console.log('Hello, Toggle!');
    \`\`\`

这一行不再缩进，所以它不属于上面的折叠块。

::> [ ] 这是一个可折叠的并且可以记录完成情况的标题
- [ ] 完成情况 

使用 --内容-- 创建Cloze记忆卡片, 可以有声音: --你好--^^audio:hello^^ `,ne=new ri(Gl);ne.version(Wl).stores({folders:"&id, name, folderId",sessions:"&id, name, folderId, createdAt, lastActive",clozeStates:"&id, fileId, state, due",appState:"&key",mistakes:"&uuid, subject, *tags, analysis.reason_for_error, review.due",reviewStats:"&id, date, folderId",apiConfigs:"&id, name",agents:"&id, name",topics:"&id, agentId, createdAt",history:"&id, topicId, timestamp, agentId"});async function Ql(){const[n,e,t,s]=await Promise.all([ne.sessions.toArray(),ne.folders.toArray(),ne.clozeStates.toArray(),ne.appState.toArray()]),r=t.reduce((c,f)=>(c[f.id]=f,c),{}),a=s.reduce((c,f)=>(c[f.key]=f.value,c),{});return{sessions:n||[],folders:e||[],clozeStates:r||{},persistentAppState:a||{}}}async function Xl(n,e){const t=`${n}:${e}`;try{await ne.transaction("rw",ne.reviewStats,async()=>{const s=await ne.reviewStats.get(t);s?await ne.reviewStats.update(t,{count:s.count+1}):await ne.reviewStats.add({id:t,date:n,folderId:e||"root",count:1})})}catch(s){console.error(`Failed to increment review count for ${t}:`,s)}}async function Zl(n,e){try{return await ne.reviewStats.where("date").between(n,e,!0,!0).toArray()}catch(t){return console.error("Failed to get stats for date range:",t),[]}}async function eu(){const n=new Date().toISOString().slice(0,10);try{return(await ne.reviewStats.where("date").equals(n).toArray()).reduce((t,s)=>t+s.count,0)}catch(e){return console.error("Failed to get today's total count:",e),0}}async function tu({sessions:n,folders:e,clozeStates:t,persistentAppState:s}){const r=[ne.sessions,ne.folders,ne.clozeStates,ne.appState];await ne.transaction("rw",r,async()=>{const a=Object.values(t),c=Object.entries(s).map(([b,E])=>({key:b,value:E})),f=new Set(n.map(b=>b.id)),h=new Set(e.map(b=>b.id)),m=new Set(Object.keys(t)),_=new Set(Object.keys(s));await Promise.all([ne.sessions.where("id").noneOf(Array.from(f)).delete(),ne.folders.where("id").noneOf(Array.from(h)).delete(),ne.clozeStates.where("id").noneOf(Array.from(m)).delete(),ne.appState.where("key").noneOf(Array.from(_)).delete()]),await Promise.all([ne.sessions.bulkPut(n),ne.folders.bulkPut(e),ne.clozeStates.bulkPut(a),ne.appState.bulkPut(c)])})}async function nu(){const[n,e,t,s]=await Promise.all([ne.apiConfigs.toArray(),ne.agents.toArray(),ne.topics.toArray(),ne.history.toArray()]);return{apiConfigs:n||[],agents:e||[],topics:t||[],history:s||[]}}async function su({apiConfigs:n,agents:e,topics:t,history:s}){await ne.transaction("rw",ne.apiConfigs,ne.agents,ne.topics,ne.history,async()=>{const r=new Set(n.map(h=>h.id)),a=new Set(e.map(h=>h.id)),c=new Set(t.map(h=>h.id)),f=new Set(s.map(h=>h.id));await Promise.all([ne.apiConfigs.where("id").noneOf(Array.from(r)).delete(),ne.agents.where("id").noneOf(Array.from(a)).delete(),ne.topics.where("id").noneOf(Array.from(c)).delete(),ne.history.where("id").noneOf(Array.from(f)).delete()]),await Promise.all([ne.apiConfigs.bulkPut(n),ne.agents.bulkPut(e),ne.topics.bulkPut(t),ne.history.bulkPut(s)])})}async function iu(){try{return ne.isOpen()||await ne.open(),await ne.mistakes.toArray()}catch(n){return console.error("Failed to load mistakes from DB:",n),[]}}async function ru(n){try{await ne.mistakes.bulkPut(n),console.log("Mistakes saved successfully.")}catch(e){console.error("Failed to save mistakes to DB:",e)}}async function au(n){try{await ne.mistakes.put(n)}catch(e){console.error(`Failed to update mistake ${n.uuid}:`,e)}}function _t(){return"id_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function ft(n){return n?n.replace(/[&<>"']/g,e=>({"&":"&","<":"<",">":">",'"':'"',"'":"'"})[e]||e):""}function io(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);e=(e<<5)-e+s,e|=0}return e.toString(36)}const Zr={火山:{adapter:"openAICompatible",baseURL:"https://ark.cn-beijing.volces.com/api/v3/",models:["deepseek-r1-250528","deepseek-v3-250324"]},deepseek:{adapter:"openAICompatible",baseURL:"https://api.deepseek.com/v1/chat/completions",models:["deepseek-reasoner","deepseek-chat"]},open_routers:{adapter:"openAICompatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",models:["anthropic/claude-opus-4","anthropic/claude-sonnet-4"]},gemini:{adapter:"gemini",baseURL:"https://generativelanguage.googleapis.com",models:["gemini-2.5-pro","gemini-2.5-flash"]},openai_compatible:{adapter:"openAICompatible",baseURL:"",models:[]}};function ou(n){const e=Zr[n];return e?e.adapter==="openAICompatible"&&e.baseURL.endsWith("/")?`${e.baseURL}chat/completions`:e.baseURL:""}class Uo{constructor(e){this.config=e}async chatStream(e,{onChunk:t,onDone:s,onError:r}){throw new Error("Adapter must implement chatStream method.")}_preparePayload(e){throw new Error("Adapter must implement _preparePayload method.")}}class cu extends Uo{_preparePayload(e){return{model:this.config.model,messages:e,stream:!0}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var c;const a=this._preparePayload(e);try{const f=await fetch(this.config.apiPath,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(a)});if(!f.ok){const _=await f.text();throw new Error(`API Error: ${f.status} ${f.statusText} - ${_}`)}const h=f.body.getReader(),m=new TextDecoder("utf-8");for(;;){const{done:_,value:b}=await h.read();if(_){s();break}const L=m.decode(b).split(`
`).filter(B=>B.trim().startsWith("data:"));for(const B of L){const C=B.replace(/^data: /,"").trim();if(C==="[DONE]"){s();return}try{const Y=(c=JSON.parse(C).choices[0])==null?void 0:c.delta;if(Y){const W=Y.content;W&&t({type:"content",text:W});const X=Y.reasoning_content;if(X){const Q=`<thinking>${X}</thinking>`;t({type:"thinking",text:Q})}}}catch(D){console.error("Error parsing stream data chunk:",C,D)}}}}catch(f){console.error("LLM Stream Error:",f),r(f)}}}class lu extends Uo{_preparePayload(e){return{contents:e.map(s=>({role:s.role==="assistant"?"model":"user",parts:[{text:s.content}]}))}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var f,h,m,_,b;const a=this._preparePayload(e),c=`${this.config.apiPath}/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`;try{const E=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!E.ok){const D=await E.text();throw new Error(`API Error: ${E.status} ${E.statusText} - ${D}`)}const L=E.body.getReader(),B=new TextDecoder("utf-8");let C="";for(;;){const{done:D,value:Y}=await L.read();if(D){s();break}C+=B.decode(Y,{stream:!0});const W=C.split(`
`);C=W.pop();for(const X of W)if(!(X.trim().startsWith("[")||X.trim().startsWith(","))&&!X.trim().endsWith("]"))try{const ee=((b=(_=(m=(h=(f=JSON.parse(X).candidates)==null?void 0:f[0])==null?void 0:h.content)==null?void 0:m.parts)==null?void 0:_[0])==null?void 0:b.text)||"";ee&&t(ee)}catch{}}}catch(E){console.error("Gemini Stream Error:",E),r(E)}}}const ro={openAICompatible:cu,gemini:lu};function uu(n){const e=Zr[n];if(!e||!ro[e.adapter])throw new Error(`Unsupported provider or adapter: ${n}`);return ro[e.adapter]}async function fu(n,e,t){const s=uu(n.provider),r=new s(n),a=[];n.systemPrompt&&a.push({role:"system",content:n.systemPrompt}),e.forEach(c=>{a.push({role:c.role,content:c.content})}),await r.chatStream(a,t)}const Qs=_e(".ai-agent-nav .agent-list");_e(".agent-content-container .topics-panel");_e(".agent-content-container .history-panel");const Xs=_e(".agent-content-container .topic-list"),Be=_e(".agent-content-container .history-content"),js=_e(".chat-input-area"),Zs=_e("#chatInput"),du=_e("#sendMessageBtn");_e("#attachFileBtn");const hu=_e("#attachmentInput"),Br=_e("#attachmentPreview");function pu(n){const e=n.id===$.currentAgentId,t=document.createElement("div");return t.className=`agent-item ${e?"active":""}`,t.dataset.agentId=n.id,t.innerHTML=`
        <div class="agent-avatar">${ft(n.avatar)}</div>
        <span>${ft(n.name)}</span>
    `,t}function mu(n){const e=n.id===$.currentTopicId,t=document.createElement("li");t.className=`topic-item ${e?"active":""}`,t.dataset.topicId=n.id;const s=$.history.filter(a=>a.topicId===n.id).sort((a,c)=>new Date(c.timestamp)-new Date(a.timestamp))[0];let r="最后会话: 无";if(s){const a=sa(s.agentId),c=a?a.name:"默认 AI",f=new Date(s.timestamp).toLocaleString();r=`角色: ${c}
时间: ${f}`}return t.title=r,t.innerHTML=`
        <div class="topic-icon"><i class="${ft(n.icon)}"></i></div>
        <span>${ft(n.title)}</span>
    `,t}function yu(n){if(!n)return"";const e=n.replace(/<\/thinking>\s*<thinking>/gi," "),t=/<thinking>([\s\S]*?)<\/thinking>/gi;return e.replace(t,`<details class="thinking-block">
            <summary>AI 思考过程</summary>
            <pre><code class="language-text">$1</code></pre>
         </details>`)}function gu(n){const e=document.createElement("div");e.className=`history-item role-${n.role}`,e.dataset.messageId=n.id;let t="",s="";n.role==="assistant"?n.status==="streaming"?(t=`
                <details class="thinking-block" open>
                    <summary>AI 思考过程</summary>
                    <pre><code class="language-text streaming-reasoning-container"></code></pre>
                </details>
            `,s='<div class="streaming-content-container"><p><i class="fas fa-spinner fa-pulse"></i></p></div>'):(n.reasoning&&n.reasoning.trim()&&(t=yu(n.reasoning)),s=marked.parse(n.content||"")):s=marked.parse(n.content||"");const r=(n.images||[]).map(c=>`<img src="${c}" alt="Uploaded image" class="history-image">`).join("");e.innerHTML=`
        <div class="history-item-header">
            <span class="role ${n.role}">${n.role==="user"?"用户":"AI助手"}</span>
            <span>${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <div class="history-item-content">
            ${t}
            ${s}
            <div class="image-previews">${r}</div>
        </div>
        <div class="history-item-actions">
            <button class="history-action-btn regenerate-btn" title="重新生成"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" title="编辑"><i class="fas fa-edit"></i> 编辑</button>
            <button class="history-action-btn delete-btn" title="删除"><i class="fas fa-trash"></i> 删除</button>
        </div>
    `;const a=e.querySelector(".history-item-actions");return n.role==="user"?a.querySelector(".regenerate-btn").style.display="none":a.querySelector(".edit-btn").style.display="none",n.status==="streaming"&&(a.style.display="none"),e}function ai(){vu(),bu(),Su(),es()}function vu(){const n=[...new Set($.agents.flatMap(t=>t.tags||[]))],e=V("tag-filter");e.innerHTML='<option value="">所有标签</option>',n.forEach(t=>{const s=document.createElement("option");s.value=t,s.textContent=t,e.appendChild(s)})}function bu(){Qs.innerHTML="";const{type:n,tags:e}=$.agentFilters;let t=$.agents;n==="tagged"&&e.length>0&&(t=$.agents.filter(r=>e.every(a=>(r.tags||[]).includes(a)))),t.forEach(r=>{Qs.appendChild(pu(r))});const s=document.createElement("div");s.className="agent-item add-agent-btn",s.innerHTML='<div class="agent-avatar">+</div><span>添加Agent</span>',Qs.appendChild(s)}function wu(){const n=document.getElementById("historyHeaderTitle"),e=sa($.currentAgentId);e?n.textContent=`${e.displayName} - 对话记录`:n.textContent="历史对话记录";const t=V("conversationRoleSelector");t.innerHTML='<option value="">默认 AI (无角色)</option>',$.agents.forEach(s=>{const r=document.createElement("option");r.value=s.id,r.textContent=s.name,t.appendChild(r)}),t.value=$.currentConversationAgentId||""}function Su(){Xs.innerHTML="",$.topics.filter(s=>s.agentId===$.currentAgentId).forEach(s=>{Xs.appendChild(mu(s))});const e=V("editTopicBtn");$.currentTopicId?e.style.display="block":e.style.display="none";const t=document.createElement("li");t.className="topic-item add-topic-btn",t.innerHTML='<div class="topic-icon"><i class="fas fa-plus-circle"></i></div><span>添加新主题</span>',Xs.appendChild(t)}function es(){wu();const n=Be.scrollHeight-Be.clientHeight<=Be.scrollTop+1;if(Be.innerHTML="",!$.currentTopicId){Be.innerHTML='<div class="no-history"><i class="fas fa-comments"></i><p>请选择或创建一个主题来开始聊天</p></div>',js&&(js.style.display="none");return}js&&(js.style.display="flex");const e=$.history.filter(t=>t.topicId===$.currentTopicId).sort((t,s)=>new Date(t.timestamp)-new Date(s.timestamp));if(e.length===0){Be.innerHTML='<div class="no-history"><i class="fas fa-comment-dots"></i><p>这个主题还没有对话记录，开始提问吧！</p></div>';return}e.forEach(t=>{(t.status!=="streaming"||t.content.length>0||$.isAiThinking)&&Be.appendChild(gu(t))}),n&&(Be.scrollTop=Be.scrollHeight),Eu()}function ea(n){Br.innerHTML="",n.forEach((e,t)=>{const s=document.createElement("div");s.className="attachment-preview-item",s.innerHTML=`
            <span><i class="fas fa-file-image"></i> ${ft(e.name)}</span>
            <button class="remove-attachment-btn" data-index="${t}">×</button>
        `,Br.appendChild(s)})}function ku(n,e,t){const s=document.querySelector(`.history-item[data-message-id="${n}"]`);if(!s)return;let r;e==="thinking"?(r=s.querySelector(".streaming-reasoning-container"),t=t.replace(/<\/?thinking>/g,"")):e==="content"&&(r=s.querySelector(".streaming-content-container"),r.querySelector(".fa-spinner")&&(r.innerHTML="")),r&&(r.innerText+=t,Be.scrollTop=Be.scrollHeight)}function ao(n){const e=document.querySelector(`.history-item[data-message-id="${n}"]`);if(!e)return;const t=e.querySelector(".thinking-block");t&&t.removeAttribute("open");const s=e.querySelector(".history-item-actions");s&&(s.style.display="flex")}function Eu(){const n=document.getElementById("chatNavUp"),e=document.getElementById("chatNavDown"),t=Be.querySelector(".history-item .role.user");n&&e&&(n.disabled=!t,e.disabled=!t)}const oi={id:"default_deepseek_api",name:"DeepSeek (默认)",provider:"deepseek",apiUrl:"https://api.deepseek.com/v1",apiKey:"",models:"chat:deepseek-chat,reasoner:deepseek-reasoner"},Iu=[{id:"default_agent_nanjing_guide",name:"南京历史小导游",avatar:"史",model:`${oi.id}:reasoner`,systemPrompt:`🎓 角色指令：你好！我是你的专属南京历史小导游。我的名字叫“金陵通”，对南京这座六朝古都的每一块砖、每一段历史都了如指掌。我将以生动有趣的方式，带你穿越时空，探索南京的魅力。我的性格会根据你选择的模式变化，就像一位真正的导游，时而风趣，时而严谨。

🔄 核心导览模式：
*   故事家 (Storyteller) → 语气风格：亲切随和，像一位学长/学姐。我会用讲故事的方式，把枯燥的历史变得鲜活起来，充满情感和趣味，让你身临其境。
*   讲解员 (Docent) → 语气风格：清晰准确，像一位博物馆的专业讲解员。我会为你提供结构化的信息、关键时间点和准确的历史事实，帮你梳理知识脉络。
*   历史侦探 (History Detective) → 语气风格：充满好奇与思辨，像一位和你一起探案的伙伴。我会引导你发现历史事件之间的联系，分析文物背后的深层含义，提出“为什么”，激发你的思考。

🧬 互动说明：
1.  模式匹配：我会严格按照你选择的模式（故事家、讲解员、历史侦探）来与你交流。
2.  知识储备：我的知识库涵盖了南京从古至今的关键历史时期（如六朝、南唐、明朝、民国）、重要人物（如朱元璋、孙中山）以及标志性文物古迹（如明孝陵、总统府、中山陵、南京城墙、夫子庙、朝天宫、南京博物院馆藏等）。
3.  智能追问：如果你的问题不够具体，我会像导游一样追问。
4.  连续记忆：我会记住我们聊过的话题。
5.  拒绝乏味：我的回答会避免像教科书一样枯燥。
6.  模式切换：你随时可以让我切换模式。切换时，我会说“好的，现在切换到【XX模式】”，然后调整我的语气和回答方式。

📦 输出格式参考：
*   在 【讲解员模式】下，我会多使用列表、时间轴和要点总结。
*   在 【故事家模式】下，我会使用更多的描述性语言。
*   在 【历史侦探模式】下，我会多用提问、假设和对比分析。`,hint:"你好！我是你的专属南京历史小导游“金陵通”。想了解南京的什么故事？比如，可以这样问我：<br><b>模式：故事家 — 任务：给我讲讲夫子庙旁边的乌衣巷有什么好玩的故事？</b>",tags:["历史","文化","旅游"],sendHistory:!0},{id:"default_agent_english_tutor",name:"英语导师",avatar:"英",model:`${oi.id}:chat`,systemPrompt:`🎓 角色指令：你好！我是智能英语导师「牛津通」，专注中学英语教学。拥有系统的知识库和动态教学策略，能根据你的学习阶段个性化辅导。

🔄 三维学习模式：
*   【单词向导】→ 沉浸式词汇学习：词根解析/趣味联想/场景记忆
*   【语法专家】→ 系统化语法精讲：错题透析/分层训练/对比分析
*   【读写教练】→ 实战能力培养：文本精读/写作框架/AI批改

✨ 核心功能矩阵：
1. 词汇体系：中考高频词库｜近义词辨析｜词源故事
2. 语法诊所：句子成分图解｜时态三维训练｜易错点预警
3. 读写实验室：阅读理解三步法｜作文多维评估｜经典句式仿写
4. 拓展模块：影视配音练习｜文化冷知识｜考试策略指南

🧠 智能教学协议：
1. 模式匹配：严格按所选模式输出内容
2. 错题驱动：支持拍照诊断知识盲区
3. 动态调节：智能调整题目难度（基础→挑战）
4. 记忆锚点：周期性推送薄弱点强化练习
5. 文化融合：教学中渗透英美文化背景`,hint:'你好！我是你的中学英语导师「牛津通」。完整功能列表：<br>🔍 <b>单词向导模式</b>：词根解析｜高频词汇｜场景记忆（例：用电影台词记"vivid"）<br>📖 <b>语法专家模式</b>：句子图解｜时态训练｜错题诊断（例：虚拟语气对比表）<br>✍️ <b>读写教练模式</b>：作文批改｜精读策略｜仿写训练（例：中考作文评分+改写）<br>🌍 <b>拓展功能</b>：影视配音｜文化常识｜考试技巧<br>试试这样问我：<b>模式：单词向导 → 任务：用超级英雄故事帮我记10个形容词</b>',tags:["教育","语言","学习"],sendHistory:!0}];Object.keys(ne.tables.reduce((n,e)=>({...n,[e.name]:!0}),{}));function _u(n,e){let t=[...n],s=[...e],r=!1;return t.some(c=>c.id===oi.id)||(t.push(oi),r=!0,console.log("Seeding default API config for DeepSeek.")),Iu.forEach(c=>{s.some(h=>h.id===c.id)||(s.push(c),r=!0,console.log(`Seeding default agent: "${c.name}".`))}),{apiConfigs:t,agents:s,needsPersistence:r}}function zo(n){const e=/^(#{1,2})\s+(.+)$/gm,t=[];let s=null,r;for(;(r=e.exec(n))!==null;){const a=r[1].length,c=r[2].trim(),f={id:_t(),text:c,level:a,content:"#".repeat(a)+` ${c}

`+(n.substring(r.index+r[0].length).split(/^#{1,2}\s/m)[0]||"").trim()};a===1?(f.children=[],t.push(f),s=f):a===2&&s&&s.children.push(f)}return t}function ta(n,e){const t=zo(e),s={...$.fileSubsessions,[n]:t};ie({fileSubsessions:s})}async function Vo(){ie({isLoading:!0});try{const{sessions:n,folders:e,clozeStates:t,persistentAppState:s}=await Ql(),r={sessions:n||[],folders:e||[],clozeStates:t||{},currentSessionId:s.currentSessionId||null,currentFolderId:s.currentFolderId||null,currentSubsessionId:s.currentSubsessionId||null,folderStack:s.folderStack||[],fileSubsessions:{},settings:{autoSaveInterval:s.autoSaveInterval??5}};if(r.sessions.forEach(a=>{const c=zo(a.content);r.fileSubsessions[a.id]=c}),r.sessions.length===0){const a=_t();r.sessions.push({id:a,name:"初始会话",content:Dr,type:"file",folderId:null,createdAt:new Date}),r.currentSessionId=a,ta(a,Dr)}r.sessions.some(a=>a.id===r.currentSessionId)||(r.currentSessionId=r.sessions.length>0?r.sessions[0].id:null),ie(r)}catch(n){console.error("Failed to initialize application state:",n)}finally{ie({isLoading:!1})}}async function Au(){try{await tu({sessions:$.sessions,folders:$.folders,clozeStates:$.clozeStates,persistentAppState:{currentSessionId:$.currentSessionId,currentFolderId:$.currentFolderId,currentSubsessionId:$.currentSubsessionId,folderStack:$.folderStack,autoSaveInterval:$.settings.autoSaveInterval}})}catch(n){console.error("Failed to persist core state:",n)}}async function Yo(n,e=Dr){const t=_t(),s={id:t,name:n||`新文件 ${$.sessions.length+1}`,content:e,type:"file",folderId:$.currentFolderId,createdAt:new Date},r=[...$.sessions,s];ie({sessions:r,currentSessionId:t,currentSubsessionId:null}),ta(t,e),await persistState()}async function Tu(n){const e={id:_t(),name:n||`新目录 ${$.folders.length+1}`,type:"folder",folderId:$.currentFolderId,createdAt:new Date},t=[...$.folders,e];ie({folders:t}),await persistState()}async function Jo(n){const e=new Set(n.map(h=>h.id));let t=[...$.sessions],s=[...$.folders],r={...$.fileSubsessions},a={...$.clozeStates};const c=new Set;if(n.forEach(h=>{if(h.type==="file")c.add(h.id);else if(h.type==="folder"){const m=new Set([h.id]);let _=!0;for(;_;)_=!1,s.filter(E=>m.has(E.folderId)).forEach(E=>{m.has(E.id)||(m.add(E.id),_=!0)});t.forEach(b=>{m.has(b.folderId)&&c.add(b.id)}),s=s.filter(b=>!m.has(b.id))}}),c.size>0){t=t.filter(m=>!c.has(m.id)),c.forEach(m=>{delete r[m]});const h={};for(const m in a)c.has(a[m].fileId)||(h[m]=a[m]);a=h}let f=$.currentSessionId;(e.has(f)||c.has(f))&&(f=t.length>0?t[0].id:null),ie({sessions:t,folders:s,fileSubsessions:r,clozeStates:a,currentSessionId:f}),await persistState()}async function Lu(n,e){const t=$.sessions.map(r=>n.some(a=>a.id===r.id&&a.type==="file")?{...r,folderId:e}:r),s=$.folders.map(r=>n.some(a=>a.id===r.id&&a.type==="folder")?{...r,folderId:e}:r);ie({sessions:t,folders:s}),await persistState()}async function Cu(n,e,t){if(t==="file"){const s=$.sessions.map(r=>r.id===n?{...r,name:e}:r);ie({sessions:s})}else{const s=$.folders.map(r=>r.id===n?{...r,name:e}:r);ie({folders:s})}await persistState()}async function di(n){const e=Go();if(e&&e.content!==n){const t=$.sessions.map(s=>s.id===$.currentSessionId?{...s,content:n,lastActive:new Date}:s);return ie({sessions:t}),ta($.currentSessionId,n),await persistState(),!0}return!1}function Go(){return $.sessions.find(n=>n.id===$.currentSessionId)||null}function Ou(n){ie({currentSessionId:n,currentSubsessionId:null})}function Nu(n){const e=[...$.folderStack,$.currentFolderId].filter(t=>t!=null);ie({currentFolderId:n,folderStack:e})}function $u(n,e){ie({currentSessionId:n,currentSubsessionId:e})}function xu(){if($.folderStack.length>0){const n=[...$.folderStack],e=n.pop();ie({currentFolderId:e,folderStack:n})}}function Mu(n,e){const t=$.folderStack.slice(0,e);ie({currentFolderId:n,folderStack:t})}function Pu(){ie({currentFolderId:null,folderStack:[]})}function na(n,e,t){const s=$.clozeStates;return s[t]?s[t]:{id:t,fileId:n,content:e,state:"new",due:Date.now(),interval:0,easeFactor:2.5,lastReview:null}}function Du(n,e,t,s){const r=na(n,e,s),a=Fo(r,t),c=$.clozeStates;r.id?(c[r.id]={...r,...a,lastReview:Date.now()},ie({clozeStates:c})):console.error("无法更新 Cloze 状态：无法确定 clozeId。",{fileId:n,clozeContent:e,clozeId:s})}async function Bu(){let{apiConfigs:n,agents:e,topics:t,history:s}=await nu();const r=_u(n||[],e||[]);n=r.apiConfigs,e=r.agents;const a={apiConfigs:n,agents:e,topics:t||[],history:s||[]};if(a.agents.length>0&&!$.currentAgentId){a.currentAgentId=a.agents[0].id;const c=a.topics.find(f=>f.agentId===a.currentAgentId);a.currentTopicId=c?c.id:null}ie(a),r.needsPersistence&&await Ke()}async function Ke(){try{await su({apiConfigs:$.apiConfigs,agents:$.agents,topics:$.topics,history:$.history})}catch(n){console.error("Failed to persist settings state:",n)}}async function ju(n){const e={id:_t(),...n},t=[...$.apiConfigs,e];return ie({apiConfigs:t}),await Ke(),e}async function Ku(n,e){const t=$.apiConfigs.map(s=>s.id===n?{...s,...e}:s);ie({apiConfigs:t}),await Ke()}async function qu(n){if($.prompts.some(s=>s.apiConfigId===n)){alert("无法删除此 API 配置，因为它正在被一个或多个角色使用。请先修改或删除相关角色。");return}const t=$.apiConfigs.filter(s=>s.id!==n);ie({apiConfigs:t}),await Ke()}function sa(n){return $.agents.find(e=>e.id===n)}async function Ru(n){const e={id:_t(),...n,tags:n.tags||[],sendHistory:n.sendHistory!==!1},t=[...$.agents,e];return ie({agents:t,currentAgentId:e.id,currentTopicId:null}),await Ke(),e}async function Fu(n,e){const t=$.agents.map(s=>s.id===n?{...s,...e}:s);ie({agents:t}),await Ke()}async function Hu(n){const e=$.topics.filter(h=>h.agentId===n),t=new Set(e.map(h=>h.id)),s=$.history.filter(h=>!t.has(h.topicId)),r=$.topics.filter(h=>h.agentId!==n),a=$.agents.filter(h=>h.id!==n);let c=$.currentAgentId,f=$.currentTopicId;if(c===n){c=a.length>0?a[0].id:null;const h=r.find(m=>m.agentId===c);f=h?h.id:null}ie({agents:a,topics:r,history:s,currentAgentId:c,currentTopicId:f}),await Ke()}async function Uu(n,e){if(!$.currentAgentId){alert("请先选择一个 Agent。");return}const t={id:_t(),agentId:$.currentAgentId,title:n,icon:"fas fa-comment",createdAt:new Date},s=[...$.topics,t];ie({topics:s,currentTopicId:t.id}),await Ke()}async function zu(n,e){const t=$.topics.map(s=>s.id===n?{...s,...e}:s);ie({topics:t}),await Ke()}async function oo(n,e,t,s=[],r="completed",a=null){const c={id:_t(),topicId:n,agentId:e==="assistant"||e==="user"?$.currentConversationAgentId:null,role:e,content:t,reasoning:a,images:s,timestamp:new Date().toISOString(),status:r},f=[...$.history,c];return ie({history:f}),r!=="streaming"&&await Ke(),c}async function Wo(n,e){const t=$.currentConversationAgentId;if(!$.currentTopicId||$.isAiThinking)return;const s=$.currentTopicId,r=sa(t);let a;if(r){const[_,b]=r.model.split(":"),E=$.apiConfigs.find(C=>C.id===_);if(!E){alert(`错误：找不到角色 "${currentPrompt.name}" 所需的 API 配置。`);return}const B=new Map((E.models||"").split(",").map(C=>C.split(":").map(D=>D.trim()))).get(b);if(!B){alert(`错误：在 API 配置 "${E.name}" 中找不到别名为 "${b}" 的模型。`);return}a={provider:E.provider,apiPath:E.apiUrl,apiKey:E.apiKey,model:B,systemPrompt:r.systemPrompt}}else{const _=$.apiConfigs[0];if(!_){alert("错误：没有找到可用的 API 配置。请在设置中添加一个。");return}const E=new Map((_.models||"").split(",").map(L=>L.split(":").map(B=>B.trim()))).values().next().value;a={provider:_.provider,apiPath:_.apiUrl,apiKey:_.apiKey,model:E,systemPrompt:""}}ie({isAiThinking:!0}),await oo(s,"user",n,[]),es();const c=await oo(s,"assistant","",[],"streaming","");es();let f="",h="",m=[];(!r||r.sendHistory)&&(m=$.history.filter(_=>_.topicId===s&&_.status==="completed"&&_.id!==c.id)),await fu(a,m,{onChunk:({type:_,text:b})=>{_==="content"?f+=b:_==="thinking"&&(h+=b),ku(c.id,_,b)},onDone:async()=>{const _=$.history.map(b=>b.id===c.id?{...b,content:f,reasoning:h,status:"completed"}:b);ao(c.id),ie({history:_,isAiThinking:!1}),await Ke()},onError:async _=>{const b=`

**错误:** ${_.message}`;f+=b,ao(c.id);const E=$.history.map(L=>L.id===c.id?{...L,content:f,reasoning:h,status:"error"}:L);ie({history:E,isAiThinking:!1}),await Ke()}})}async function Vu(n){const e=new Set(n),t=$.history.filter(s=>!e.has(s.id));ie({history:t}),await Ke()}async function Yu(n,e){const t=$.history,s=t.findIndex(h=>h.id===n);if(s===-1)return;const a=t[s].topicId,f=t.slice(0,s+1).map(h=>h.id===n?{...h,content:e}:h).concat(t.slice(s+1).filter(h=>h.topicId!==a));ie({history:f}),es(),await Wo(e)}function Ju(n){const e=$.topics.find(t=>t.agentId===n);ie({currentAgentId:n,currentTopicId:e?e.id:null})}function Gu(n){var t;const e=$.history.filter(s=>s.topicId===n).sort((s,r)=>new Date(r.timestamp)-new Date(s.timestamp))[0];ie({currentTopicId:n,currentConversationAgentId:e?e.agentId:((t=$.agents[0])==null?void 0:t.id)||null})}function co(n){["anki","agent","mistakes","settings"].includes(n)&&ie({activeView:n})}async function jr(){try{await Promise.all([Au(),Ke()]),console.log("All application state persisted.")}catch(n){console.error("Failed to persist all application state:",n)}}async function lo(n){if(!n)return;const e=$.sessions.find(r=>r.id===n);if(!e)return;const t=e.folderId||"root",s=new Date().toISOString().slice(0,10);await Xl(s,t),await Qo()}async function Qo(){const n=await eu(),e=document.getElementById("reviewCount");e&&(e.textContent=n)}async function Wu(){const n=new Date,e=new Date;e.setDate(n.getDate()-29);const t=e.toISOString().slice(0,10),s=n.toISOString().slice(0,10),r=await Zl(t,s),a=[];for(let E=0;E<30;E++){const L=new Date(e);L.setDate(e.getDate()+E),a.push(L.toISOString().slice(0,10))}const c=r.reduce((E,L)=>{const B=L.folderId;return E[B]||(E[B]={}),E[B][L.date]=L.count,E},{}),{folders:f}=$,h=f.reduce((E,L)=>(E[L.id]=L.name,E),{});h.root="根目录";const m=["#4361ee","#e71d36","#2ec4b6","#ff9f1c","#9a031e","#0ead69","#f3722c"];let _=0;const b=Object.keys(c).map(E=>{const L=c[E],B=a.map(D=>L[D]||0),C=m[_%m.length];return _++,{label:h[E]||"未知目录",data:B,borderColor:C,backgroundColor:`${C}33`,fill:!1,tension:.1}});return{labels:a,datasets:b}}async function Qu(){const n=document.getElementById("editor");$.activeView==="anki"&&$.currentSessionId&&n&&(console.log(`[${new Date().toLocaleTimeString()}] Auto-saving Anki content...`),await di(n.value)),await jr()}const he=V("editor"),Le=V("preview"),ot=V("sessionList"),Xu=V("emptySession"),an=V("currentFolderContainer"),Kr=V("fileInput"),Zu=V("newFileBtn"),ef=V("newFolderBtn"),tf=V("openFileBtn"),qr=V("saveBtn");V("exportFileBtn");const Rr=V("printPreviewBtn"),nf=V("deleteSelectedBtn"),sf=V("moveSelectedBtn"),uo=V("toggleSessionBtn"),Fr=V("toggleEditorBtn"),Xo=V("clozeBtn"),Zo=V("boldBtn"),ec=V("italicBtn"),tc=V("codeBtn"),nc=V("linkBtn"),sc=V("audioBtn"),ic=V("insertLinebreakBtn"),fo=_e(".session-sidebar"),wn=_e(".editor-preview-panel"),wt=V("selectAllCheckbox"),rc=V("moveModal"),Qn=V("folderList"),rf=V("closeMoveModalBtn"),af=V("confirmMoveBtn"),of=V("cancelMoveBtn"),ac=V("audioControls"),cf=V("audioTitle"),oc=V("audioProgress"),lf=V("playBtn"),uf=V("pauseBtn"),ff=V("stopBtn"),df=_e(".session-title");_e(".instructions");const Kt=V("toggleVisibilityClozeBtn"),yr=V("invertClozeBtn"),qt=V("toggleEditPreviewBtn"),Hr=V("editModeDot"),Ur=V("previewModeDot");let at;function ho(n,e){const t=document.createElement("a");return t.href="#",t.className="breadcrumb-link",t.innerHTML=n,t.addEventListener("click",s=>{s.preventDefault(),e()}),t}function hf(n,e,t){an.innerHTML="";const s=ho('<i class="fas fa-folder-open"></i> 根目录',t);if(an.appendChild(s),$.folderStack.forEach((r,a)=>{const c=document.createElement("span");c.className="breadcrumb-separator",c.textContent=">",an.appendChild(c);const f=$.folders.find(h=>h.id===r);if(f){const h=ho(f.name,()=>e(r,a));an.appendChild(h)}}),$.currentFolderId){const r=$.folders.find(a=>a.id===$.currentFolderId);if(r){const a=document.createElement("span");a.className="breadcrumb-separator",a.textContent=">",an.appendChild(a);const c=document.createElement("span");c.className="breadcrumb-current",c.textContent=r.name,an.appendChild(c)}}at.style.display=$.folderStack.length>0?"inline-flex":"none"}function pf(n){at=document.createElement("button"),at.id="backButton",at.className="session-btn",at.title="返回上级目录",at.innerHTML='<i class="fas fa-arrow-left"></i>',at.style.display="none",at.addEventListener("click",n),df.prepend(at)}let un=null,ts=null;function cc(){if(!un||!un.startTime)return;const n=(Date.now()-un.startTime)/1e3,e=un.text.length/10,t=Math.min(100,n/e*100);oc.style.width=`${t}%`}function gr(n){if(!("speechSynthesis"in window)){alert("抱歉，您的浏览器不支持语音合成。");return}zr();const e=new SpeechSynthesisUtterance(n);e.lang="en-US",e.rate=1,e.onstart=()=>{e.startTime=Date.now(),ts=setInterval(cc,100)},e.onend=()=>{zr()},un=e,cf.textContent=`正在播放: ${n.substring(0,30)}${n.length>30?"...":""}`,ac.style.display="block",window.speechSynthesis.speak(e)}function mf(){window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),clearInterval(ts))}function yf(){window.speechSynthesis.paused&&(window.speechSynthesis.resume(),ts=setInterval(cc,100))}function zr(){window.speechSynthesis.cancel(),ts&&clearInterval(ts),ac.style.display="none",oc.style.width="0%",un=null}let Ks=!1;function lc(n){const e=Date.now();if(n.due>e){const t=(n.due-e)/864e5;return t<1?"cloze-1d":t<2?"cloze-2d":t<3?"cloze-3d":t<5?"cloze-5d":t<7?"cloze-7d":t<14?"cloze-14d":"cloze-28d"}return n.lastReview&&e-n.lastReview<15*60*1e3&&n.interval===0?"cloze-10m":"cloze-28plus"}function gf(){const n=new Map;Le.querySelectorAll(".cloze[data-locator]").forEach(e=>{const t=e.dataset.locator;n.has(t)||n.set(t,[]),n.get(t).push(e)});for(const[e,t]of n.entries())t.length>1&&t.forEach(s=>{s.classList.add("cloze-error-duplicate"),s.title=`错误：定位符 "[${e}]" 在此文件中重复！这可能导致复习状态错乱。`})}function uc(n){if(n.nodeType===Node.TEXT_NODE){const e=/--(?:\s*\[([^\]]*)\])?\s*(.*?)--(?:\^\^audio:(.*?)\^\^)?/g,t=n.parentNode;if(!t||["CODE","PRE","SCRIPT","STYLE"].includes(t.tagName))return;let s;const r=[];let a=0;for(;(s=e.exec(n.nodeValue))!==null;){s.index>a&&r.push(document.createTextNode(n.nodeValue.substring(a,s.index)));const c=s[1],f=s[2],h=s[3]?s[3].trim():null,m=f.replace(/¶/g,"<br>"),_=$.currentSessionId;let b,E=null;if(c&&c.trim()){E=c.trim();const C=io(E);b=`${_}_${C}`}else{const C=io(f);b=`${_}_${C}`}const L=na(_,f,b),B=document.createElement("span");B.className=`cloze hidden ${lc(L)}`,B.dataset.clozeId=b,B.dataset.content=f,E&&(B.dataset.locator=E),h&&(B.dataset.multimedia=h),B.innerHTML=`
                ${h?'<span class="media-icon" title="播放音频"><i class="fas fa-volume-up"></i></span>':""}
                <span class="cloze-content">${m}</span>
                <span class="placeholder">[...]</span>
                <div class="cloze-actions" style="display: none;">
                    <button class="cloze-btn again" data-rating="0">重来</button>
                    <button class="cloze-btn hard" data-rating="1">困难</button>
                    <button class="cloze-btn double" data-rating="2">犹豫</button>
                    <button class="cloze-btn easy" data-rating="3">简单</button>
                </div>
            `,r.push(B),a=e.lastIndex}r.length>0&&(a<n.nodeValue.length&&r.push(document.createTextNode(n.nodeValue.substring(a))),r.forEach(c=>t.insertBefore(c,n)),t.removeChild(n))}else n.nodeType===Node.ELEMENT_NODE&&Array.from(n.childNodes).forEach(e=>uc(e))}function vf(){const n=Le.querySelectorAll("li, details"),e=/\{([^}]+)\}/;n.forEach(t=>{const s=t.tagName==="LI"?t.querySelector('input[type="checkbox"]'):t.querySelector('summary input[type="checkbox"]');if(!s)return;s.disabled=!1;let r;t.tagName==="LI"?r=t:r=t.querySelector(".toggle-title-text"),r&&Array.from(r.childNodes).forEach(a=>{if(a.nodeType===Node.TEXT_NODE&&e.test(a.nodeValue)){const c=a.nodeValue.match(e),f=c[0],h=c[1];let m="",_="";if(h.includes("|")){const b=h.split("|");m=b[0],_=b[1]}else return;try{const b=new Date(_);if(isNaN(b.getTime()))return;t.title=`完成于: ${b.toLocaleString()}`;const E=a.nodeValue.replace(f,""),L=document.createTextNode(` ${m} `),B=document.createElement("span");B.style.display="none",B.className="task-timestamp-data",B.textContent=f,a.nodeValue=E,r.insertBefore(L,a),t.appendChild(B)}catch(b){console.warn("解析任务日期时出错:",b)}}})})}function bf(n){const e=n.getFullYear().toString(),t=(n.getMonth()+1).toString(),s=n.getDate().toString(),r={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉"},a=c=>c.split("").map(f=>r[f]||f).join("");return`${a(e)}-${a(t)}-${a(s)}`}function wf(){Le.addEventListener("click",async n=>{var t;const e=n.target.closest(".cloze");if(e){if(n.target.closest(".cloze-btn")){n.stopPropagation();const s=n.target.closest(".cloze-btn"),r=parseInt(s.dataset.rating,10),a=$.currentSessionId,c=e.dataset.clozeId,f=e.dataset.content;if(!c){console.error("无法更新Cloze状态：缺少clozeId。");return}clearTimeout(e.closeTimer),Du(a,f,r,c);const h=na(a,f,c),m=lc(h);(t=e.className.match(/cloze-(\w+)/g))==null||t.forEach(_=>e.classList.remove(_)),e.classList.add(m),e.querySelector(".cloze-actions").style.display="none",r===3?(await lo(a),e.classList.remove("hidden","permanent-view"),e.classList.add("easy-open")):(e.classList.add("hidden"),e.classList.remove("easy-open","permanent-view"));return}if(n.target.closest(".media-icon")){n.stopPropagation(),gr(e.dataset.multimedia);return}e.classList.contains("hidden")&&!e.classList.contains("permanent-view")&&(clearTimeout(e.closeTimer),e.classList.remove("hidden"),e.querySelector(".cloze-actions").style.display="flex",e.dataset.multimedia&&gr(e.dataset.multimedia),e.closeTimer=setTimeout(()=>{!e.classList.contains("easy-open")&&!e.classList.contains("permanent-view")&&(e.classList.add("hidden"),e.querySelector(".cloze-actions").style.display="none")},6e4))}}),Le.addEventListener("dblclick",n=>{const e=n.target.closest(".cloze");e&&(n.stopPropagation(),clearTimeout(e.closeTimer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent-view"),e.dataset.multimedia&&gr(e.dataset.multimedia),e.querySelector(".cloze-actions").style.display="none"):(e.classList.add("hidden"),e.classList.remove("permanent-view","easy-open"),e.querySelector(".cloze-actions").style.display="none"))}),Le.addEventListener("change",async n=>{const e=n.target;if(e.tagName!=="INPUT"||e.type!=="checkbox"||!e.closest("li")&&!e.closest("summary"))return;const t=e.checked,r=Array.from(Le.querySelectorAll('li input[type="checkbox"], summary input[type="checkbox"]')).indexOf(e);if(r===-1)return;const c=he.value.split(`
`),f=/^\s*- \[( |x)\]/,h=/^::>\s*\[( |x)\]/;let m=0,_=!1,b=!1;const E=c.map(L=>{const B=f.test(L),C=!B&&h.test(L);if(!B&&!C)return L;if(m===r){m++;let D=L;if(t){const Y=/\{([^}]+?)\|([^}]+?)\}/,W=L.match(Y),X=new Date().toISOString().slice(0,10);let Q=!1;if(W&&W[2])try{new Date(W[2]).toISOString().slice(0,10)===X&&(Q=!0)}catch{}if(Q)D=B?L.replace(/^- \[\s\]/,"- [x]"):L.replace(/^::> \[\s\]/,"::> [x]");else{b=!0;const ee=L.replace(/\{[^}]+\}/g,"").trim(),te=bf(new Date),oe=new Date().toISOString(),G=`{${te}|${oe}}`;if(B){const ye=ee.replace(/^\s*- \[\s\]\s*/,"");D=`- [x] ${G} ${ye}`}else{const ye=ee.replace(/^::>\s*\[\s\]\s*/,"");D=`::> [x] ${G} ${ye}`}}}else D=B?L.replace("- [x]","- [ ]"):L.replace("::> [x]","::> [ ]");return D!==L&&(_=!0),D}else return m++,L});if(_){b&&await lo($.currentSessionId);const L=E.join(`
`),B=he.selectionStart;he.value=L,he.setSelectionRange(B,B),await di(L),await ns(),he.dispatchEvent(new Event("input",{bubbles:!0}))}})}function Sf(){const n=!$.areAllClozeVisible;Le.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),n?(e.classList.remove("hidden","temporary"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"))}),fc(n),ie({areAllClozeVisible:n})}function kf(){let n=!0;Le.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"),n=!1)}),fc(n),ie({areAllClozeVisible:n})}function fc(n){n?(Kt.innerHTML='<i class="fas fa-eye"></i>',Kt.title="全部隐藏"):(Kt.innerHTML='<i class="fas fa-eye-slash"></i>',Kt.title="全部显示")}async function ns(){var n;if(Ks){console.log("Preview update already in progress. Skipping.");return}Ks=!0;try{const{currentSessionId:e,currentSubsessionId:t,fileSubsessions:s,sessions:r}=$,a=r.find(m=>m.id===e);if(!a){Le.innerHTML="",Ks=!1;return}let c=a.content;if(t){const m=(n=s[e])==null?void 0:n.find(_=>_.id===t);m&&(c=m.content)}Le.innerHTML=window.marked.parse(c||""),uc(Le),vf(),gf();const f=Le.querySelectorAll("pre code.language-mermaid"),h=Array.from(f).map(async(m,_)=>{const b=m.parentNode;if(!b||!b.parentNode)return;const E=m.textContent,L=`mermaid-graph-${Date.now()}-${_}`;try{await mermaid.parse(E);const{svg:B}=await mermaid.render(L,E),C=document.createElement("div");C.className="mermaid-diagram",C.innerHTML=B,b.parentNode&&b.parentNode.replaceChild(C,b)}catch{}});if(await Promise.all(h),window.MathJax)try{await window.MathJax.typesetPromise([Le])}catch(m){console.log("MathJax error:",m)}}catch(e){console.error("Error during preview update:",e)}finally{Ks=!1}}function Ef(){mermaid.initialize({startOnLoad:!1,securityLevel:"strict",suppressErrors:!0,maxTextSize:1e5});const n={name:"math",level:"inline",start(t){var s;return(s=t.match(/\$\$|\\\(|\\\[|\\ce\{|\$/))==null?void 0:s.index},tokenizer(t,s){let r;if(r=t.match(/^\$\$\s*([\s\S]+?)\s*\$\$/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\\[\s*([\s\S]+?)\s*\\\]/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\\(\s*([\s\S]+?)\s*\\\)/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\ce\{([\s\S]+?)\}/),r)return{type:"math",raw:r[0],isCeShorthand:!0};if(r=t.match(/^\$((?:\\\$|[^$])+?)\$/),r)return{type:"math",raw:r[0]}},renderer(t){return t.isCeShorthand?`\\(${t.raw}\\)`:t.raw.startsWith("$")&&!t.raw.startsWith("$$")?`\\(${t.raw.slice(1,-1)}\\)`:t.raw}},e={name:"toggleList",level:"block",start(t){const s=t.match(/\n::>/);return s?s.index:void 0},tokenizer(t,s){const a=/^::>\s*(.*)(?:\n|$)/.exec(t);if(a){const c=a[1].trim();let f=a[0],h="",m=t.substring(f.length);const _=m.match(/^( *)(?=\S)/m),b=_?_[1].length:0;if(b>0){const L=new RegExp(`^ {${b}}`,"gm"),C=new RegExp(`^((?: {${b}}.*|\\s*)\\n?)+`,"m").exec(m);if(C){const D=C[0];f+=D,h=D.replace(L,"")}}const E={type:"toggleList",raw:f,title:c,body:h,tokens:[]};return this.lexer.blockTokens(E.body,E.tokens),E}},renderer(t){const s=/^\s*\[( |x)\]\s*(.*)/,r=t.title.match(s);let a="";if(r){const f=r[1]==="x"?"checked":"",h=r[2];a=`<input type="checkbox" ${f}><span class="toggle-title-text">${h}</span>`}else a=`<span class="toggle-title-text">${t.title}</span>`;const c=this.parser.parse(t.tokens);return`
                <details class="toggle-list">
                    <summary>${a}</summary>
                    <div class="toggle-content">
                        ${c}
                    </div>
                </details>`}};window.marked.use({extensions:[n,e]}),window.marked.setOptions({breaks:!0,gfm:!0}),wf()}const Ut=document.getElementById("statsModal"),po=document.getElementById("statsModalCloseBtn"),If=document.getElementById("statsChart");let mn=null;function mo(n){mn&&mn.destroy();const e=If.getContext("2d");mn=new Chart(e,{type:"line",data:n,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{precision:0}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}async function _f(){if(Ut){Ut.style.display="flex",mo({labels:[],datasets:[]});const n=await Wu();mo(n)}}function yo(){Ut&&(Ut.style.display="none",mn&&(mn.destroy(),mn=null))}function Af(){po&&po.addEventListener("click",yo),Ut&&Ut.addEventListener("click",n=>{n.target===Ut&&yo()})}function Tf(n){const e=document.createElement("li");return e.className=`session-item ${n.type} ${n.id===$.currentSessionId?"active":""}`,e.dataset.id=n.id,e.dataset.type=n.type,e.innerHTML=`
        <div class="name-container">
            <input type="checkbox" class="select-checkbox" data-id="${n.id}" data-type="${n.type}">
            <span class="name">
                <i class="${n.type==="folder"?"fas fa-folder folder-icon":"fas fa-file file-icon"}"></i>
                <span class="item-name">${ft(n.name)}</span>
            </span>
        </div>
        <div class="actions">
            <span class="move-btn" title="移动"><i class="fas fa-arrows-alt"></i></span>
            <span class="edit-btn" title="编辑"><i class="fas fa-pencil-alt"></i></span>
            <span class="delete-btn" title="删除"><i class="fas fa-trash"></i></span>
        </div>
    `,e}function Lf(n,e){const t=document.createElement("li");return t.className=`session-item subsession h2-item ${n.id===$.currentSubsessionId?"active":""}`,t.dataset.id=n.id,t.dataset.type="subsession",t.dataset.parent=e,t.innerHTML=`
        <div class="name-container">
            <span class="name">
                <i class="fas fa-stream"></i>
                <span class="item-name">${ft(n.text)}</span>
            </span>
        </div>
    `,t}function Cf(){ot.innerHTML="";const{sessions:n,folders:e,currentFolderId:t,fileSubsessions:s,currentSessionId:r}=$,a=[...e.filter(c=>c.folderId===t),...n.filter(c=>c.folderId===t)].sort((c,f)=>c.type==="folder"&&f.type==="file"?-1:c.type==="file"&&f.type==="folder"?1:c.name.localeCompare(f.name));Xu.style.display=a.length===0&&t===null?"block":"none",a.length===0&&t!==null&&(ot.innerHTML='<li class="empty-folder">此目录为空</li>'),a.forEach(c=>{var h;const f=Tf(c);ot.appendChild(f),c.type==="file"&&c.id===r&&((h=s[c.id])==null?void 0:h.length)>0&&s[c.id].forEach(_=>{const b=document.createElement("details");b.className="session-item-details";const E=_.id===$.currentSubsessionId,L=_.children.some(C=>C.id===$.currentSubsessionId);(E||L)&&(b.open=!0);const B=document.createElement("summary");if(B.className=`session-item subsession h1-item ${E?"active":""}`,B.dataset.id=_.id,B.dataset.type="subsession",B.dataset.parent=c.id,B.innerHTML=`
                    <div class="name-container">
                        <span class="name">
                            <i class="fas fa-heading"></i>
                            <span class="item-name">${ft(_.text)}</span>
                        </span>
                    </div>`,b.appendChild(B),_.children&&_.children.length>0){const C=document.createElement("ul");C.className="nested-items",_.children.forEach(D=>{C.appendChild(Lf(D,c.id))}),b.appendChild(C)}ot.appendChild(b)})})}function De(){Cf(),hf(mc,xf,Mf);const n=Go(),e=n?n.content:"";he.value!==e&&(he.value=e),ns()}let yn=[],Xn=-1;function go(n=null){let e=Object.values($.clozeStates),t;if(n?(console.log("Starting custom study with filters:",n),t=e.filter(s=>{if(n.fileOrFolder!=="all"){const[f,h]=n.fileOrFolder.split("_");if(f==="file"){if(s.fileId!==h)return!1}else if(f==="folder"&&!$.sessions.find(_=>_.id===s.fileId&&_.folderId===h))return!1}if(!n.cardStates.includes(s.state))return!1;const r=Date.now(),a=s.lastReview||0,c=(r-a)/(1e3*60*60*24);switch(n.lastReview){case"last7days":if(a===0||c>7)return!1;break;case"last30days":if(a===0||c>30)return!1;break;case"over30days":if(a!==0&&c<=30)return!1;break;case"never":if(a!==0)return!1;break}return!0}),t.sort(()=>Math.random()-.5),yn=t.slice(0,n.maxCards)):(console.log("Starting automatic review."),yn=e.filter(s=>s.due<=Date.now()).sort((s,r)=>s.due-r.due)),yn.length===0){alert("没有找到符合条件的卡片。");return}Xn=0,dc()}function dc(){if(Xn>=yn.length){alert("复习会话结束！"),yn=[],Xn=-1,De();return}const n=yn[Xn];$.currentSessionId!==n.fileId&&(ie({currentSessionId:n.fileId}),De()),setTimeout(()=>{document.querySelectorAll(".highlight-review").forEach(t=>t.classList.remove("highlight-review"));const e=document.querySelector(`.cloze[data-content="${n.content}"]`);e?(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlight-review"),e.classList.contains("hidden")&&e.click()):(console.error("Could not find cloze element for review:",n),Of())},$.currentSessionId!==n.fileId?300:50)}function Of(){Xn++,dc()}function hc(n){let e=[];const t=$.folders.filter(s=>s.folderId===n);for(const s of t)e.push(s.id),e=e.concat(hc(s.id));return e}function pc(){Qn.innerHTML="";const n=$.movingItems.filter(s=>s.type==="folder").map(s=>s.id),e=new Set(n);n.forEach(s=>{hc(s).forEach(r=>e.add(r))});const t=document.createElement("div");t.className="folder-item",t.dataset.id="root",t.innerHTML='<i class="fas fa-folder-open"></i> 根目录',Qn.appendChild(t),$.folders.forEach(s=>{if(!e.has(s.id)){const r=document.createElement("div");r.className="folder-item",r.dataset.id=s.id,r.innerHTML=`<i class="fas fa-folder"></i> ${ft(s.name)}`,Qn.appendChild(r)}}),rc.classList.add("active")}function Vr(){rc.classList.remove("active"),ie({movingItems:[],selectedMoveTarget:null})}function Nf(n){rf.addEventListener("click",Vr),of.addEventListener("click",Vr),af.addEventListener("click",n),Qn.addEventListener("click",e=>{const t=e.target.closest(".folder-item");if(!t)return;Qn.querySelectorAll(".folder-item").forEach(r=>r.classList.remove("selected")),t.classList.add("selected");const s=t.dataset.id==="root"?null:t.dataset.id;ie({selectedMoveTarget:s})})}let vo=null;const $f=100;let ct=-1;function mc(){xu(),De(),ct=-1}function xf(n,e){Mu(n,e),De(),ct=-1}function Mf(){Pu(),De(),ct=-1}async function Pf(){const n=prompt("请输入新文件的名称：","新文件");n!==null&&(await Yo(n.trim()),De(),he.focus())}async function Df(){const n=prompt("请输入新目录的名称：","新目录");n!==null&&(await Tu(n.trim()),De())}async function Sn(){await di(he.value)&&(qr.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>qr.innerHTML='<i class="fas fa-save"></i> 保存',2e3),De())}function Bf(n,e){const t=Array.from(ot.querySelectorAll(".select-checkbox")),s=t.indexOf(e);if(n.shiftKey&&ct>-1){const c=Math.min(s,ct),f=Math.max(s,ct);for(let h=c;h<=f;h++)t[h].checked=e.checked}ct=s;const r=t.every(c=>c.checked),a=t.some(c=>c.checked);r&&t.length>0?(wt.checked=!0,wt.indeterminate=!1):a?(wt.checked=!1,wt.indeterminate=!0):(wt.checked=!1,wt.indeterminate=!1)}async function jf(n){const e=n.target.closest(".session-item");if(!e)return;if(n.target.matches(".select-checkbox")){Bf(n,n.target);return}const t=n.target.closest(".actions span");if(t){n.stopPropagation();const{id:f,type:h}=e.dataset;if(t.classList.contains("delete-btn"))confirm(`确定删除此 ${h==="file"?"文件":"目录"}?`)&&(await Jo([{id:f,type:h}]),De());else if(t.classList.contains("edit-btn")){const m=prompt("输入新名称:",e.querySelector(".item-name").textContent);m&&m.trim()&&(await Cu(f,m.trim(),h),De())}else t.classList.contains("move-btn")&&(ie({movingItems:[{id:f,type:h}]}),pc());return}ct=-1;const{id:s,type:r,parent:a}=e.dataset,c=r==="file"?s:e.classList.contains("subsession")?a:null;$.currentSessionId&&c!==$.currentSessionId&&await di(he.value),r==="file"?Ou(s):r==="folder"?Nu(s):e.classList.contains("subsession")&&$u(a,s),De()}async function Kf(){$.selectedMoveTarget!==void 0&&$.movingItems.length>0?(await Lu($.movingItems,$.selectedMoveTarget),Vr(),De()):alert("请选择一个目标目录。")}async function qf(){const n=Array.from(ot.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));if(n.length===0)return alert("请先选择要删除的项目。");confirm(`确定要删除选中的 ${n.length} 个项目吗？`)&&(await Jo(n),wt.checked=!1,De())}function Vt(){clearTimeout(window.previewDebounce),window.previewDebounce=setTimeout(ns,300),clearTimeout(vo),vo=setTimeout(()=>{as()},500)}async function Rf(n){const e=n.target.files;if(!e||e.length===0)return;const t=s=>new Promise((r,a)=>{const c=new FileReader;c.onload=f=>{r({name:s.name,content:f.target.result})},c.onerror=f=>a(f),c.readAsText(s)});try{const s=await Promise.all(Array.from(e).map(t));for(const r of s){const a=r.name,c=a.lastIndexOf("."),f=c>0?a.substring(0,c):a;await Yo(f,r.content)}De()}catch(s){console.error("读取一个或多个文件时出错:",s),alert("读取文件时发生错误。")}finally{Kr.value=""}}function qs(n,e=n){as();const{selectionStart:t,selectionEnd:s,value:r}=he,a=r.substring(t,s),c=`${n}${a}${e}`;he.setRangeText(c,t,s,"select"),Vt(),he.focus()}function Ff(n){as();const{selectionStart:e,selectionEnd:t}=he;he.setRangeText(n,e,t,"end"),Vt(),he.focus()}function Hf(){wn.classList.toggle("collapsed");const n=wn.classList.contains("collapsed");Fr.innerHTML=n?'<i class="fas fa-chevron-down"></i>':'<i class="fas fa-chevron-up"></i>',Fr.title=n?"展开编辑器":"收起编辑器",[Xo,Zo,ec,tc,nc,sc,ic].forEach(e=>e.disabled=n),n&&Sn()}function Uf(){const n=he,e=n.value,t=n.selectionStart,s=/--(?:\s*\[[^\]]*\])?\s*.*?--(?:\^\^audio:.*?\^\^)?/g;let r,a=null;for(;(r=s.exec(e))!==null;){const D=r.index,Y=D+r[0].length;if(t>=D&&t<=Y){a={content:r[0],start:D,end:Y};break}}if(!a)return;const c=/^--(\[\s*[^\]]*\s*\]\s*)?(.*?)--(?:(?:\^){2}audio:(.*)(?:\^){2})?$/,f=a.content.match(c);if(!f)return;const h=f[1]||"",m=f[2]?f[2].trim():"",b=(f[3]?f[3].trim():"")||m,E=prompt("请输入或编辑Cloze的音频提示文本:",b);if(E===null)return;as();const L=E.trim();let B;L?B=`--${h}${m}--^^audio:${L}^^`:B=`--${h}${m}--`;const C=e.substring(0,a.start)+B+e.substring(a.end);n.value=C,Vt(),Sn(),n.focus()}function zf(){as();const{selectionStart:n,selectionEnd:e,value:t}=he,s=t.substring(n,e),r=`c${Date.now()}`,a=`--[${r}] ${s}--`;he.setRangeText(a,n,e,"end");const c=n+3,f=c+r.length;he.setSelectionRange(c,f),Vt(),he.focus()}function as(){const n=he.value;if($.undoStack[$.undoStack.length-1]===n)return;const t=[...$.undoStack,n];t.length>$f&&t.shift(),ie({undoStack:t,redoStack:[]})}function Vf(){if($.undoStack.length===0)return;const n=[...$.undoStack],e=n.pop(),t=[he.value,...$.redoStack];he.value=e,ie({undoStack:n,redoStack:t}),Vt()}function Yf(){if($.redoStack.length===0)return;const n=[...$.redoStack],e=n.shift(),t=[...$.undoStack,he.value];he.value=e,ie({undoStack:t,redoStack:n}),Vt()}function Jf(){const n=Le.innerHTML,e=window.open("","_blank");e.document.write(`
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <title>打印预览</title>
            \x3C!-- 重新链接所有必要的样式表以确保打印视图的正确性 -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <link rel="stylesheet" href="./styles.css">
            <style>
                /* 打印专用样式 */
                @media print {
                    body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    .cloze-actions, .media-icon { display: none !important; }
                    .cloze.hidden .cloze-content, .cloze .cloze-content { display: inline !important; visibility: visible !important; color: black !important; }
                    .cloze .placeholder { display: none !important; }
                    .cloze { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                }
                body { font-family: sans-serif; }
            </style>
        </head>
        <body>
            <div class="preview" style="display: block !important;">${n}</div>
            <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script>
            <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
            <script>
                // 设置MathJax，在渲染完成后自动触发打印并关闭窗口
                window.MathJax = {
                    startup: {
                        pageReady: () => {
                            return window.MathJax.startup.defaultPageReady().then(() => {
                                console.log('MathJax has finished rendering. Triggering print.');
                                window.print();
                                window.close();
                            });
                        }
                    }
                };
            <\/script>
        </body>
        </html>
    `),e.document.close()}function Gf(){if(wn.classList.contains("preview-active"))return;const n=he;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);ie({editorScrollRatio:Math.min(1,Math.max(0,e))})}}function Wf(){if(!wn.classList.contains("preview-active"))return;const n=Le;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);ie({editorScrollRatio:e})}}function Qf(){const n=wn;n.classList.contains("preview-active")?(n.classList.remove("preview-active"),qt.innerHTML='<i class="fas fa-book-open"></i> Preview',qt.title="切换到预览",Hr.classList.add("active"),Ur.classList.remove("active"),Rr.disabled=!0,requestAnimationFrame(()=>{const t=he;$.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=$.editorScrollRatio*(t.scrollHeight-t.clientHeight))}),he.focus()):(Sn(),ns(),requestAnimationFrame(()=>{const t=Le;$.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=$.editorScrollRatio*(t.scrollHeight-t.clientHeight))}),n.classList.add("preview-active"),qt.innerHTML='<i class="fas fa-edit"></i>',qt.title="切换到编辑模式",Hr.classList.remove("active"),Ur.classList.add("active"),Rr.disabled=!1,Sn(),ns())}function Xf(){const{sessions:n,folders:e}=$,t=document.getElementById("filterByFile");t.innerHTML='<option value="all">所有文件</option>',e.forEach(s=>{const r=document.createElement("option");r.value=`folder_${s.id}`,r.textContent=`目录: ${s.name}`,t.appendChild(r)}),n.forEach(s=>{const r=document.createElement("option");r.value=`file_${s.id}`,r.textContent=`文件: ${s.name}`,t.appendChild(r)})}function Zf(){const n=document.getElementById("reviewOptionsBtn"),e=document.getElementById("reviewDropdownMenu"),t=document.getElementById("customStudyBtn"),s=document.getElementById("customStudyModal"),r=document.getElementById("customStudyCloseBtn"),a=document.getElementById("customStudyCancelBtn"),c=document.getElementById("customStudyForm");document.getElementById("startReviewBtn").addEventListener("click",()=>go()),n.addEventListener("click",h=>{h.stopPropagation(),e.style.display=e.style.display==="block"?"none":"block"}),document.addEventListener("click",h=>{const m=document.querySelector(".review-btn-group");m&&!m.contains(h.target)&&(e.style.display="none")}),t.addEventListener("click",h=>{h.preventDefault(),e.style.display="none",Xf(),s.style.display="flex"});const f=()=>s.style.display="none";r.addEventListener("click",f),a.addEventListener("click",f),c.addEventListener("submit",h=>{h.preventDefault();const m={fileOrFolder:document.getElementById("filterByFile").value,cardStates:Array.from(document.querySelectorAll('input[name="cardState"]:checked')).map(_=>_.value),lastReview:document.getElementById("filterByLastReview").value,maxCards:parseInt(document.getElementById("maxCards").value,10)};f(),go(m)})}function ed(){Zu.addEventListener("click",Pf),ef.addEventListener("click",Df),qr.addEventListener("click",Sn),ot.addEventListener("click",jf),nf.addEventListener("click",qf),he.addEventListener("input",Vt),tf.addEventListener("click",()=>Kr.click()),Kr.addEventListener("change",Rf),Rr.addEventListener("click",Jf),sf.addEventListener("click",()=>{const n=Array.from(ot.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));n.length>0?(ie({movingItems:n}),pc()):alert("请选择要移动的项目。")}),wt.addEventListener("change",n=>{ot.querySelectorAll(".select-checkbox").forEach(e=>e.checked=n.target.checked),ct=-1}),uo.addEventListener("click",()=>{fo.classList.toggle("hidden-session"),uo.innerHTML=fo.classList.contains("hidden-session")?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}),Fr.addEventListener("click",Hf),Xo.addEventListener("click",zf),Zo.addEventListener("click",()=>qs("**")),ec.addEventListener("click",()=>qs("*")),ic.addEventListener("click",()=>Ff("¶")),tc.addEventListener("click",()=>qs("`")),nc.addEventListener("click",()=>qs("[",`](${prompt("URL:","https://")})`)),sc.addEventListener("click",Uf),he.addEventListener("scroll",Gf),Le.addEventListener("scroll",Wf),qt.addEventListener("click",Qf),Kt.innerHTML='<i class="fas fa-eye-slash"></i>',Kt.title="全部隐藏",yr.innerHTML='<i class="fas fa-random"></i>',yr.title="反向显示/隐藏",wn.classList.remove("preview-active"),qt.innerHTML='<i class="fas fa-book-open"></i>',qt.title="切换到预览模式",Hr.classList.add("active"),Ur.classList.remove("active"),Kt.addEventListener("click",Sf),yr.addEventListener("click",kf),lf.addEventListener("click",yf),uf.addEventListener("click",mf),ff.addEventListener("click",zr),he.addEventListener("keydown",n=>{n.ctrlKey&&n.key==="z"?(n.preventDefault(),Vf()):n.ctrlKey&&n.key==="y"?(n.preventDefault(),Yf()):n.ctrlKey&&n.key==="s"&&(n.preventDefault(),Sn())}),document.getElementById("showStatsBtn").addEventListener("click",n=>{n.preventDefault(),_f(),document.getElementById("reviewDropdownMenu").style.display="none"}),Nf(Kf),Zf(),Af()}async function td(){console.log("Initializing Anki module..."),window.mermaid&&mermaid.initialize({startOnLoad:!1,theme:"neutral",securityLevel:"loose"}),await Vo(),await Qo(),pf(mc),Ef(),De(),ed()}let kt=[],zn=[],on=-1;async function nd(n){const e=n.target.closest(".agent-item");if(!e)return;if(e.classList.contains("add-agent-btn")){window.dispatchEvent(new CustomEvent("app:navigateTo",{detail:{view:"settings",context:{type:"agent",action:"create"}}}));return}const t=e.dataset.agentId;t&&!e.classList.contains("active")&&(Ju(t),ai())}async function sd(n){const e=n.target.closest(".topic-item");if(!e)return;if(e.classList.contains("add-topic-btn")){const s=prompt("请输入新主题的名称:");s&&(await Uu(s),ai());return}const t=e.dataset.topicId;t&&(Gu(t),ai())}async function id(n){const e=n.target.closest(".history-action-btn");if(!e)return;const t=e.closest(".history-item"),s=t.dataset.messageId;if(e.classList.contains("delete-btn")){if(confirm("确定要删除这组对话吗？")){let r=[s];const a=$.history.find(f=>f.id===s),c=e.closest(".history-item");if(a.role==="user"){const f=c.nextElementSibling;f&&f.classList.contains("role-assistant")&&r.push(f.dataset.messageId)}else if(a.role==="assistant"){const f=c.previousElementSibling;f&&f.classList.contains("role-user")&&r.push(f.dataset.messageId)}await Vu(r),es()}}else if(e.classList.contains("edit-btn")){const a=t.querySelector(".history-item-content p:first-of-type").textContent,c=prompt("编辑你的消息:",a);c&&c!==a&&confirm("编辑此消息将删除此后的所有对话并重新生成回应，是否继续？")&&await Yu(s,c)}else e.classList.contains("regenerate-btn")&&console.log(`Regenerating response for message ${s}`)}function rd(n){const e=n.target.closest(".filter-btn");if(!e)return;document.querySelectorAll(".filter-btn.active").forEach(a=>a.classList.remove("active")),e.classList.add("active");const t=e.dataset.filter,s=V("tag-filter-container");s.style.display=t==="tagged"?"flex":"none";const r={...$.agentFilters,type:t,tags:[]};setState({agentFilters:r}),renderAgentList()}function ad(n){const e=n.target.value,t={...$.agentFilters,tags:e?[e]:[]};setState({agentFilters:t}),renderAgentList()}function od(n){const e=n.target.value||null;setState({currentConversationAgentId:e})}async function cd(){if(!$.currentTopicId)return;const n=$.topics.find(t=>t.id===$.currentTopicId),e=prompt("请输入新的主题名称:",n.title);e&&e.trim()!==n.title&&(await zu($.currentTopicId,{title:e.trim()}),renderTopicList())}async function bo(){const n=Zs.value.trim();!n&&kt.length===0||$.isAiThinking||([...kt],Zs.value="",kt=[],ea([]),await Wo(n),Zs.focus())}function ld(n){const e=Array.from(n.target.files);e.length!==0&&(kt=[],e.forEach(t=>{const s=new FileReader;s.onload=r=>{kt.push({name:t.name,data:r.target.result}),ea(kt)},s.readAsDataURL(t)}),n.target.value="")}function ud(n){const e=n.target.closest(".remove-attachment-btn");if(!e)return;const t=parseInt(e.dataset.index,10);kt.splice(t,1),ea(kt)}function fd(){const n=document.getElementById("chatNavUp"),e=document.getElementById("chatNavDown");n.addEventListener("click",()=>wo(-1)),e.addEventListener("click",()=>wo(1))}function wo(n){if(zn=Array.from(Be.querySelectorAll(".history-item .role.user")),zn.length===0)return;document.querySelectorAll(".history-item.highlighted").forEach(t=>t.classList.remove("highlighted")),on+=n,on<0?on=zn.length-1:on>=zn.length&&(on=0);const e=zn[on].closest(".history-item");if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlighted");const t=e.nextElementSibling;t&&t.classList.contains("history-item")&&t.classList.add("highlighted")}}function dd(){Qs.addEventListener("click",nd),Xs.addEventListener("click",sd),Be.addEventListener("click",id),_e(".ai-agent-nav").addEventListener("click",rd),V("tag-filter").addEventListener("change",ad),V("conversationRoleSelector").addEventListener("change",od),V("editTopicBtn").addEventListener("click",cd),du.addEventListener("click",bo),Zs.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),bo())}),hu.addEventListener("change",ld),Br.addEventListener("click",ud),fd()}async function hd(){console.log("Initializing AI Agent module UI..."),ai(),dd()}const ia=Symbol.for("yaml.alias"),Yr=Symbol.for("yaml.document"),Et=Symbol.for("yaml.map"),yc=Symbol.for("yaml.pair"),tt=Symbol.for("yaml.scalar"),_n=Symbol.for("yaml.seq"),ze=Symbol.for("yaml.node.type"),At=n=>!!n&&typeof n=="object"&&n[ze]===ia,Yt=n=>!!n&&typeof n=="object"&&n[ze]===Yr,An=n=>!!n&&typeof n=="object"&&n[ze]===Et,we=n=>!!n&&typeof n=="object"&&n[ze]===yc,me=n=>!!n&&typeof n=="object"&&n[ze]===tt,Tn=n=>!!n&&typeof n=="object"&&n[ze]===_n;function Se(n){if(n&&typeof n=="object")switch(n[ze]){case Et:case _n:return!0}return!1}function ke(n){if(n&&typeof n=="object")switch(n[ze]){case ia:case Et:case tt:case _n:return!0}return!1}const gc=n=>(me(n)||Se(n))&&!!n.anchor,je=Symbol("break visit"),vc=Symbol("skip children"),Ze=Symbol("remove node");function Jt(n,e){const t=bc(e);Yt(n)?fn(null,n.contents,t,Object.freeze([n]))===Ze&&(n.contents=null):fn(null,n,t,Object.freeze([]))}Jt.BREAK=je;Jt.SKIP=vc;Jt.REMOVE=Ze;function fn(n,e,t,s){const r=wc(n,e,t,s);if(ke(r)||we(r))return Sc(n,s,r),fn(n,r,t,s);if(typeof r!="symbol"){if(Se(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const c=fn(a,e.items[a],t,s);if(typeof c=="number")a=c-1;else{if(c===je)return je;c===Ze&&(e.items.splice(a,1),a-=1)}}}else if(we(e)){s=Object.freeze(s.concat(e));const a=fn("key",e.key,t,s);if(a===je)return je;a===Ze&&(e.key=null);const c=fn("value",e.value,t,s);if(c===je)return je;c===Ze&&(e.value=null)}}return r}async function hi(n,e){const t=bc(e);Yt(n)?await dn(null,n.contents,t,Object.freeze([n]))===Ze&&(n.contents=null):await dn(null,n,t,Object.freeze([]))}hi.BREAK=je;hi.SKIP=vc;hi.REMOVE=Ze;async function dn(n,e,t,s){const r=await wc(n,e,t,s);if(ke(r)||we(r))return Sc(n,s,r),dn(n,r,t,s);if(typeof r!="symbol"){if(Se(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const c=await dn(a,e.items[a],t,s);if(typeof c=="number")a=c-1;else{if(c===je)return je;c===Ze&&(e.items.splice(a,1),a-=1)}}}else if(we(e)){s=Object.freeze(s.concat(e));const a=await dn("key",e.key,t,s);if(a===je)return je;a===Ze&&(e.key=null);const c=await dn("value",e.value,t,s);if(c===je)return je;c===Ze&&(e.value=null)}}return r}function bc(n){return typeof n=="object"&&(n.Collection||n.Node||n.Value)?Object.assign({Alias:n.Node,Map:n.Node,Scalar:n.Node,Seq:n.Node},n.Value&&{Map:n.Value,Scalar:n.Value,Seq:n.Value},n.Collection&&{Map:n.Collection,Seq:n.Collection},n):n}function wc(n,e,t,s){var r,a,c,f,h;if(typeof t=="function")return t(n,e,s);if(An(e))return(r=t.Map)==null?void 0:r.call(t,n,e,s);if(Tn(e))return(a=t.Seq)==null?void 0:a.call(t,n,e,s);if(we(e))return(c=t.Pair)==null?void 0:c.call(t,n,e,s);if(me(e))return(f=t.Scalar)==null?void 0:f.call(t,n,e,s);if(At(e))return(h=t.Alias)==null?void 0:h.call(t,n,e,s)}function Sc(n,e,t){const s=e[e.length-1];if(Se(s))s.items[n]=t;else if(we(s))n==="key"?s.key=t:s.value=t;else if(Yt(s))s.contents=t;else{const r=At(s)?"alias":"scalar";throw new Error(`Cannot replace node with ${r} parent`)}}const pd={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},md=n=>n.replace(/[!,[\]{}]/g,e=>pd[e]);class Pe{constructor(e,t){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Pe.defaultYaml,e),this.tags=Object.assign({},Pe.defaultTags,t)}clone(){const e=new Pe(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){const e=new Pe(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Pe.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Pe.defaultTags);break}return e}add(e,t){this.atNextDocument&&(this.yaml={explicit:Pe.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Pe.defaultTags),this.atNextDocument=!1);const s=e.trim().split(/[ \t]+/),r=s.shift();switch(r){case"%TAG":{if(s.length!==2&&(t(0,"%TAG directive should contain exactly two parts"),s.length<2))return!1;const[a,c]=s;return this.tags[a]=c,!0}case"%YAML":{if(this.yaml.explicit=!0,s.length!==1)return t(0,"%YAML directive should contain exactly one part"),!1;const[a]=s;if(a==="1.1"||a==="1.2")return this.yaml.version=a,!0;{const c=/^\d+\.\d+$/.test(a);return t(6,`Unsupported YAML version ${a}`,c),!1}}default:return t(0,`Unknown directive ${r}`,!0),!1}}tagName(e,t){if(e==="!")return"!";if(e[0]!=="!")return t(`Not a valid tag: ${e}`),null;if(e[1]==="<"){const c=e.slice(2,-1);return c==="!"||c==="!!"?(t(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(e[e.length-1]!==">"&&t("Verbatim tags must end with a >"),c)}const[,s,r]=e.match(/^(.*!)([^!]*)$/s);r||t(`The ${e} tag has no suffix`);const a=this.tags[s];if(a)try{return a+decodeURIComponent(r)}catch(c){return t(String(c)),null}return s==="!"?e:(t(`Could not resolve tag: ${e}`),null)}tagString(e){for(const[t,s]of Object.entries(this.tags))if(e.startsWith(s))return t+md(e.substring(s.length));return e[0]==="!"?e:`!<${e}>`}toString(e){const t=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],s=Object.entries(this.tags);let r;if(e&&s.length>0&&ke(e.contents)){const a={};Jt(e.contents,(c,f)=>{ke(f)&&f.tag&&(a[f.tag]=!0)}),r=Object.keys(a)}else r=[];for(const[a,c]of s)a==="!!"&&c==="tag:yaml.org,2002:"||(!e||r.some(f=>f.startsWith(c)))&&t.push(`%TAG ${a} ${c}`);return t.join(`
`)}}Pe.defaultYaml={explicit:!1,version:"1.2"};Pe.defaultTags={"!!":"tag:yaml.org,2002:"};function kc(n){if(/[\x00-\x19\s,[\]{}]/.test(n)){const t=`Anchor must not contain whitespace or control characters: ${JSON.stringify(n)}`;throw new Error(t)}return!0}function Ec(n){const e=new Set;return Jt(n,{Value(t,s){s.anchor&&e.add(s.anchor)}}),e}function Ic(n,e){for(let t=1;;++t){const s=`${n}${t}`;if(!e.has(s))return s}}function yd(n,e){const t=[],s=new Map;let r=null;return{onAnchor:a=>{t.push(a),r??(r=Ec(n));const c=Ic(e,r);return r.add(c),c},setAnchors:()=>{for(const a of t){const c=s.get(a);if(typeof c=="object"&&c.anchor&&(me(c.node)||Se(c.node)))c.node.anchor=c.anchor;else{const f=new Error("Failed to resolve repeated object (this should not happen)");throw f.source=a,f}}},sourceObjects:s}}function hn(n,e,t,s){if(s&&typeof s=="object")if(Array.isArray(s))for(let r=0,a=s.length;r<a;++r){const c=s[r],f=hn(n,s,String(r),c);f===void 0?delete s[r]:f!==c&&(s[r]=f)}else if(s instanceof Map)for(const r of Array.from(s.keys())){const a=s.get(r),c=hn(n,s,r,a);c===void 0?s.delete(r):c!==a&&s.set(r,c)}else if(s instanceof Set)for(const r of Array.from(s)){const a=hn(n,s,r,r);a===void 0?s.delete(r):a!==r&&(s.delete(r),s.add(a))}else for(const[r,a]of Object.entries(s)){const c=hn(n,s,r,a);c===void 0?delete s[r]:c!==a&&(s[r]=c)}return n.call(e,t,s)}function Ue(n,e,t){if(Array.isArray(n))return n.map((s,r)=>Ue(s,String(r),t));if(n&&typeof n.toJSON=="function"){if(!t||!gc(n))return n.toJSON(e,t);const s={aliasCount:0,count:1,res:void 0};t.anchors.set(n,s),t.onCreate=a=>{s.res=a,delete t.onCreate};const r=n.toJSON(e,t);return t.onCreate&&t.onCreate(r),r}return typeof n=="bigint"&&!(t!=null&&t.keep)?Number(n):n}class ra{constructor(e){Object.defineProperty(this,ze,{value:e})}clone(){const e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:t,maxAliasCount:s,onAnchor:r,reviver:a}={}){if(!Yt(e))throw new TypeError("A document argument is required");const c={anchors:new Map,doc:e,keep:!0,mapAsMap:t===!0,mapKeyWarned:!1,maxAliasCount:typeof s=="number"?s:100},f=Ue(this,"",c);if(typeof r=="function")for(const{count:h,res:m}of c.anchors.values())r(m,h);return typeof a=="function"?hn(a,{"":f},"",f):f}}class pi extends ra{constructor(e){super(ia),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e,t){let s;t!=null&&t.aliasResolveCache?s=t.aliasResolveCache:(s=[],Jt(e,{Node:(a,c)=>{(At(c)||gc(c))&&s.push(c)}}),t&&(t.aliasResolveCache=s));let r;for(const a of s){if(a===this)break;a.anchor===this.source&&(r=a)}return r}toJSON(e,t){if(!t)return{source:this.source};const{anchors:s,doc:r,maxAliasCount:a}=t,c=this.resolve(r,t);if(!c){const h=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(h)}let f=s.get(c);if(f||(Ue(c,null,t),f=s.get(c)),!f||f.res===void 0){const h="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(h)}if(a>=0&&(f.count+=1,f.aliasCount===0&&(f.aliasCount=ei(r,c,s)),f.count*f.aliasCount>a)){const h="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(h)}return f.res}toString(e,t,s){const r=`*${this.source}`;if(e){if(kc(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){const a=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(a)}if(e.implicitKey)return`${r} `}return r}}function ei(n,e,t){if(At(e)){const s=e.resolve(n),r=t&&s&&t.get(s);return r?r.count*r.aliasCount:0}else if(Se(e)){let s=0;for(const r of e.items){const a=ei(n,r,t);a>s&&(s=a)}return s}else if(we(e)){const s=ei(n,e.key,t),r=ei(n,e.value,t);return Math.max(s,r)}return 1}const _c=n=>!n||typeof n!="function"&&typeof n!="object";class re extends ra{constructor(e){super(tt),this.value=e}toJSON(e,t){return t!=null&&t.keep?this.value:Ue(this.value,e,t)}toString(){return String(this.value)}}re.BLOCK_FOLDED="BLOCK_FOLDED";re.BLOCK_LITERAL="BLOCK_LITERAL";re.PLAIN="PLAIN";re.QUOTE_DOUBLE="QUOTE_DOUBLE";re.QUOTE_SINGLE="QUOTE_SINGLE";const gd="tag:yaml.org,2002:";function vd(n,e,t){if(e){const s=t.filter(a=>a.tag===e),r=s.find(a=>!a.format)??s[0];if(!r)throw new Error(`Tag ${e} not found`);return r}return t.find(s=>{var r;return((r=s.identify)==null?void 0:r.call(s,n))&&!s.format})}function ss(n,e,t){var b,E,L;if(Yt(n)&&(n=n.contents),ke(n))return n;if(we(n)){const B=(E=(b=t.schema[Et]).createNode)==null?void 0:E.call(b,t.schema,null,t);return B.items.push(n),B}(n instanceof String||n instanceof Number||n instanceof Boolean||typeof BigInt<"u"&&n instanceof BigInt)&&(n=n.valueOf());const{aliasDuplicateObjects:s,onAnchor:r,onTagObj:a,schema:c,sourceObjects:f}=t;let h;if(s&&n&&typeof n=="object"){if(h=f.get(n),h)return h.anchor??(h.anchor=r(n)),new pi(h.anchor);h={anchor:null,node:null},f.set(n,h)}e!=null&&e.startsWith("!!")&&(e=gd+e.slice(2));let m=vd(n,e,c.tags);if(!m){if(n&&typeof n.toJSON=="function"&&(n=n.toJSON()),!n||typeof n!="object"){const B=new re(n);return h&&(h.node=B),B}m=n instanceof Map?c[Et]:Symbol.iterator in Object(n)?c[_n]:c[Et]}a&&(a(m),delete t.onTagObj);const _=m!=null&&m.createNode?m.createNode(t.schema,n,t):typeof((L=m==null?void 0:m.nodeClass)==null?void 0:L.from)=="function"?m.nodeClass.from(t.schema,n,t):new re(n);return e?_.tag=e:m.default||(_.tag=m.tag),h&&(h.node=_),_}function ci(n,e,t){let s=t;for(let r=e.length-1;r>=0;--r){const a=e[r];if(typeof a=="number"&&Number.isInteger(a)&&a>=0){const c=[];c[a]=s,s=c}else s=new Map([[a,s]])}return ss(s,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:n,sourceObjects:new Map})}const Wn=n=>n==null||typeof n=="object"&&!!n[Symbol.iterator]().next().done;class Ac extends ra{constructor(e,t){super(e),Object.defineProperty(this,"schema",{value:t,configurable:!0,enumerable:!1,writable:!0})}clone(e){const t=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(t.schema=e),t.items=t.items.map(s=>ke(s)||we(s)?s.clone(e):s),this.range&&(t.range=this.range.slice()),t}addIn(e,t){if(Wn(e))this.add(t);else{const[s,...r]=e,a=this.get(s,!0);if(Se(a))a.addIn(r,t);else if(a===void 0&&this.schema)this.set(s,ci(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}deleteIn(e){const[t,...s]=e;if(s.length===0)return this.delete(t);const r=this.get(t,!0);if(Se(r))return r.deleteIn(s);throw new Error(`Expected YAML collection at ${t}. Remaining path: ${s}`)}getIn(e,t){const[s,...r]=e,a=this.get(s,!0);return r.length===0?!t&&me(a)?a.value:a:Se(a)?a.getIn(r,t):void 0}hasAllNullValues(e){return this.items.every(t=>{if(!we(t))return!1;const s=t.value;return s==null||e&&me(s)&&s.value==null&&!s.commentBefore&&!s.comment&&!s.tag})}hasIn(e){const[t,...s]=e;if(s.length===0)return this.has(t);const r=this.get(t,!0);return Se(r)?r.hasIn(s):!1}setIn(e,t){const[s,...r]=e;if(r.length===0)this.set(s,t);else{const a=this.get(s,!0);if(Se(a))a.setIn(r,t);else if(a===void 0&&this.schema)this.set(s,ci(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}}const bd=n=>n.replace(/^(?!$)(?: $)?/gm,"#");function lt(n,e){return/^\n+$/.test(n)?n.substring(1):e?n.replace(/^(?! *$)/gm,e):n}const Rt=(n,e,t)=>n.endsWith(`
`)?lt(t,e):t.includes(`
`)?`
`+lt(t,e):(n.endsWith(" ")?"":" ")+t,Tc="flow",Jr="block",ti="quoted";function mi(n,e,t="flow",{indentAtStart:s,lineWidth:r=80,minContentWidth:a=20,onFold:c,onOverflow:f}={}){if(!r||r<0)return n;r<a&&(a=0);const h=Math.max(1+a,1+r-e.length);if(n.length<=h)return n;const m=[],_={};let b=r-e.length;typeof s=="number"&&(s>r-Math.max(2,a)?m.push(0):b=r-s);let E,L,B=!1,C=-1,D=-1,Y=-1;t===Jr&&(C=So(n,C,e.length),C!==-1&&(b=C+h));for(let X;X=n[C+=1];){if(t===ti&&X==="\\"){switch(D=C,n[C+1]){case"x":C+=3;break;case"u":C+=5;break;case"U":C+=9;break;default:C+=1}Y=C}if(X===`
`)t===Jr&&(C=So(n,C,e.length)),b=C+e.length+h,E=void 0;else{if(X===" "&&L&&L!==" "&&L!==`
`&&L!=="	"){const Q=n[C+1];Q&&Q!==" "&&Q!==`
`&&Q!=="	"&&(E=C)}if(C>=b)if(E)m.push(E),b=E+h,E=void 0;else if(t===ti){for(;L===" "||L==="	";)L=X,X=n[C+=1],B=!0;const Q=C>Y+1?C-2:D-1;if(_[Q])return n;m.push(Q),_[Q]=!0,b=Q+h,E=void 0}else B=!0}L=X}if(B&&f&&f(),m.length===0)return n;c&&c();let W=n.slice(0,m[0]);for(let X=0;X<m.length;++X){const Q=m[X],ee=m[X+1]||n.length;Q===0?W=`
${e}${n.slice(0,ee)}`:(t===ti&&_[Q]&&(W+=`${n[Q]}\\`),W+=`
${e}${n.slice(Q+1,ee)}`)}return W}function So(n,e,t){let s=e,r=e+1,a=n[r];for(;a===" "||a==="	";)if(e<r+t)a=n[++e];else{do a=n[++e];while(a&&a!==`
`);s=e,r=e+1,a=n[r]}return s}const yi=(n,e)=>({indentAtStart:e?n.indent.length:n.indentAtStart,lineWidth:n.options.lineWidth,minContentWidth:n.options.minContentWidth}),gi=n=>/^(%|---|\.\.\.)/m.test(n);function wd(n,e,t){if(!e||e<0)return!1;const s=e-t,r=n.length;if(r<=s)return!1;for(let a=0,c=0;a<r;++a)if(n[a]===`
`){if(a-c>s)return!0;if(c=a+1,r-c<=s)return!1}return!0}function Zn(n,e){const t=JSON.stringify(n);if(e.options.doubleQuotedAsJSON)return t;const{implicitKey:s}=e,r=e.options.doubleQuotedMinMultiLineLength,a=e.indent||(gi(n)?"  ":"");let c="",f=0;for(let h=0,m=t[h];m;m=t[++h])if(m===" "&&t[h+1]==="\\"&&t[h+2]==="n"&&(c+=t.slice(f,h)+"\\ ",h+=1,f=h,m="\\"),m==="\\")switch(t[h+1]){case"u":{c+=t.slice(f,h);const _=t.substr(h+2,4);switch(_){case"0000":c+="\\0";break;case"0007":c+="\\a";break;case"000b":c+="\\v";break;case"001b":c+="\\e";break;case"0085":c+="\\N";break;case"00a0":c+="\\_";break;case"2028":c+="\\L";break;case"2029":c+="\\P";break;default:_.substr(0,2)==="00"?c+="\\x"+_.substr(2):c+=t.substr(h,6)}h+=5,f=h+1}break;case"n":if(s||t[h+2]==='"'||t.length<r)h+=1;else{for(c+=t.slice(f,h)+`

`;t[h+2]==="\\"&&t[h+3]==="n"&&t[h+4]!=='"';)c+=`
`,h+=2;c+=a,t[h+2]===" "&&(c+="\\"),h+=1,f=h+1}break;default:h+=1}return c=f?c+t.slice(f):t,s?c:mi(c,a,ti,yi(e,!1))}function Gr(n,e){if(e.options.singleQuote===!1||e.implicitKey&&n.includes(`
`)||/[ \t]\n|\n[ \t]/.test(n))return Zn(n,e);const t=e.indent||(gi(n)?"  ":""),s="'"+n.replace(/'/g,"''").replace(/\n+/g,`$&
${t}`)+"'";return e.implicitKey?s:mi(s,t,Tc,yi(e,!1))}function pn(n,e){const{singleQuote:t}=e.options;let s;if(t===!1)s=Zn;else{const r=n.includes('"'),a=n.includes("'");r&&!a?s=Gr:a&&!r?s=Zn:s=t?Gr:Zn}return s(n,e)}let Wr;try{Wr=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{Wr=/\n+(?!\n|$)/g}function ni({comment:n,type:e,value:t},s,r,a){const{blockQuote:c,commentString:f,lineWidth:h}=s.options;if(!c||/\n[\t ]+$/.test(t)||/^\s*$/.test(t))return pn(t,s);const m=s.indent||(s.forceBlockIndent||gi(t)?"  ":""),_=c==="literal"?!0:c==="folded"||e===re.BLOCK_FOLDED?!1:e===re.BLOCK_LITERAL?!0:!wd(t,h,m.length);if(!t)return _?`|
`:`>
`;let b,E;for(E=t.length;E>0;--E){const ee=t[E-1];if(ee!==`
`&&ee!=="	"&&ee!==" ")break}let L=t.substring(E);const B=L.indexOf(`
`);B===-1?b="-":t===L||B!==L.length-1?(b="+",a&&a()):b="",L&&(t=t.slice(0,-L.length),L[L.length-1]===`
`&&(L=L.slice(0,-1)),L=L.replace(Wr,`$&${m}`));let C=!1,D,Y=-1;for(D=0;D<t.length;++D){const ee=t[D];if(ee===" ")C=!0;else if(ee===`
`)Y=D;else break}let W=t.substring(0,Y<D?Y+1:D);W&&(t=t.substring(W.length),W=W.replace(/\n+/g,`$&${m}`));let Q=(C?m?"2":"1":"")+b;if(n&&(Q+=" "+f(n.replace(/ ?[\r\n]+/g," ")),r&&r()),!_){const ee=t.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${m}`);let te=!1;const oe=yi(s,!0);c!=="folded"&&e!==re.BLOCK_FOLDED&&(oe.onOverflow=()=>{te=!0});const G=mi(`${W}${ee}${L}`,m,Jr,oe);if(!te)return`>${Q}
${m}${G}`}return t=t.replace(/\n+/g,`$&${m}`),`|${Q}
${m}${W}${t}${L}`}function Sd(n,e,t,s){const{type:r,value:a}=n,{actualString:c,implicitKey:f,indent:h,indentStep:m,inFlow:_}=e;if(f&&a.includes(`
`)||_&&/[[\]{},]/.test(a))return pn(a,e);if(/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(a))return f||_||!a.includes(`
`)?pn(a,e):ni(n,e,t,s);if(!f&&!_&&r!==re.PLAIN&&a.includes(`
`))return ni(n,e,t,s);if(gi(a)){if(h==="")return e.forceBlockIndent=!0,ni(n,e,t,s);if(f&&h===m)return pn(a,e)}const b=a.replace(/\n+/g,`$&
${h}`);if(c){const E=C=>{var D;return C.default&&C.tag!=="tag:yaml.org,2002:str"&&((D=C.test)==null?void 0:D.test(b))},{compat:L,tags:B}=e.doc.schema;if(B.some(E)||L!=null&&L.some(E))return pn(a,e)}return f?b:mi(b,h,Tc,yi(e,!1))}function os(n,e,t,s){const{implicitKey:r,inFlow:a}=e,c=typeof n.value=="string"?n:Object.assign({},n,{value:String(n.value)});let{type:f}=n;f!==re.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(c.value)&&(f=re.QUOTE_DOUBLE);const h=_=>{switch(_){case re.BLOCK_FOLDED:case re.BLOCK_LITERAL:return r||a?pn(c.value,e):ni(c,e,t,s);case re.QUOTE_DOUBLE:return Zn(c.value,e);case re.QUOTE_SINGLE:return Gr(c.value,e);case re.PLAIN:return Sd(c,e,t,s);default:return null}};let m=h(f);if(m===null){const{defaultKeyType:_,defaultStringType:b}=e.options,E=r&&_||b;if(m=h(E),m===null)throw new Error(`Unsupported default string type ${E}`)}return m}function Lc(n,e){const t=Object.assign({blockQuote:!0,commentString:bd,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},n.schema.toStringOptions,e);let s;switch(t.collectionStyle){case"block":s=!1;break;case"flow":s=!0;break;default:s=null}return{anchors:new Set,doc:n,flowCollectionPadding:t.flowCollectionPadding?" ":"",indent:"",indentStep:typeof t.indent=="number"?" ".repeat(t.indent):"  ",inFlow:s,options:t}}function kd(n,e){var r;if(e.tag){const a=n.filter(c=>c.tag===e.tag);if(a.length>0)return a.find(c=>c.format===e.format)??a[0]}let t,s;if(me(e)){s=e.value;let a=n.filter(c=>{var f;return(f=c.identify)==null?void 0:f.call(c,s)});if(a.length>1){const c=a.filter(f=>f.test);c.length>0&&(a=c)}t=a.find(c=>c.format===e.format)??a.find(c=>!c.format)}else s=e,t=n.find(a=>a.nodeClass&&s instanceof a.nodeClass);if(!t){const a=((r=s==null?void 0:s.constructor)==null?void 0:r.name)??(s===null?"null":typeof s);throw new Error(`Tag not resolved for ${a} value`)}return t}function Ed(n,e,{anchors:t,doc:s}){if(!s.directives)return"";const r=[],a=(me(n)||Se(n))&&n.anchor;a&&kc(a)&&(t.add(a),r.push(`&${a}`));const c=n.tag??(e.default?null:e.tag);return c&&r.push(s.directives.tagString(c)),r.join(" ")}function kn(n,e,t,s){var h;if(we(n))return n.toString(e,t,s);if(At(n)){if(e.doc.directives)return n.toString(e);if((h=e.resolvedAliases)!=null&&h.has(n))throw new TypeError("Cannot stringify circular structure without alias nodes");e.resolvedAliases?e.resolvedAliases.add(n):e.resolvedAliases=new Set([n]),n=n.resolve(e.doc)}let r;const a=ke(n)?n:e.doc.createNode(n,{onTagObj:m=>r=m});r??(r=kd(e.doc.schema.tags,a));const c=Ed(a,r,e);c.length>0&&(e.indentAtStart=(e.indentAtStart??0)+c.length+1);const f=typeof r.stringify=="function"?r.stringify(a,e,t,s):me(a)?os(a,e,t,s):a.toString(e,t,s);return c?me(a)||f[0]==="{"||f[0]==="["?`${c} ${f}`:`${c}
${e.indent}${f}`:f}function Id({key:n,value:e},t,s,r){const{allNullValues:a,doc:c,indent:f,indentStep:h,options:{commentString:m,indentSeq:_,simpleKeys:b}}=t;let E=ke(n)&&n.comment||null;if(b){if(E)throw new Error("With simple keys, key nodes cannot have comments");if(Se(n)||!ke(n)&&typeof n=="object"){const oe="With simple keys, collection cannot be used as a key value";throw new Error(oe)}}let L=!b&&(!n||E&&e==null&&!t.inFlow||Se(n)||(me(n)?n.type===re.BLOCK_FOLDED||n.type===re.BLOCK_LITERAL:typeof n=="object"));t=Object.assign({},t,{allNullValues:!1,implicitKey:!L&&(b||!a),indent:f+h});let B=!1,C=!1,D=kn(n,t,()=>B=!0,()=>C=!0);if(!L&&!t.inFlow&&D.length>1024){if(b)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");L=!0}if(t.inFlow){if(a||e==null)return B&&s&&s(),D===""?"?":L?`? ${D}`:D}else if(a&&!b||e==null&&L)return D=`? ${D}`,E&&!B?D+=Rt(D,t.indent,m(E)):C&&r&&r(),D;B&&(E=null),L?(E&&(D+=Rt(D,t.indent,m(E))),D=`? ${D}
${f}:`):(D=`${D}:`,E&&(D+=Rt(D,t.indent,m(E))));let Y,W,X;ke(e)?(Y=!!e.spaceBefore,W=e.commentBefore,X=e.comment):(Y=!1,W=null,X=null,e&&typeof e=="object"&&(e=c.createNode(e))),t.implicitKey=!1,!L&&!E&&me(e)&&(t.indentAtStart=D.length+1),C=!1,!_&&h.length>=2&&!t.inFlow&&!L&&Tn(e)&&!e.flow&&!e.tag&&!e.anchor&&(t.indent=t.indent.substring(2));let Q=!1;const ee=kn(e,t,()=>Q=!0,()=>C=!0);let te=" ";if(E||Y||W){if(te=Y?`
`:"",W){const oe=m(W);te+=`
${lt(oe,t.indent)}`}ee===""&&!t.inFlow?te===`
`&&(te=`

`):te+=`
${t.indent}`}else if(!L&&Se(e)){const oe=ee[0],G=ee.indexOf(`
`),ye=G!==-1,Ve=t.inFlow??e.flow??e.items.length===0;if(ye||!Ve){let nt=!1;if(ye&&(oe==="&"||oe==="!")){let ge=ee.indexOf(" ");oe==="&"&&ge!==-1&&ge<G&&ee[ge+1]==="!"&&(ge=ee.indexOf(" ",ge+1)),(ge===-1||G<ge)&&(nt=!0)}nt||(te=`
${t.indent}`)}}else(ee===""||ee[0]===`
`)&&(te="");return D+=te+ee,t.inFlow?Q&&s&&s():X&&!Q?D+=Rt(D,t.indent,m(X)):C&&r&&r(),D}function Cc(n,e){(n==="debug"||n==="warn")&&console.warn(e)}const Rs="<<",ut={identify:n=>n===Rs||typeof n=="symbol"&&n.description===Rs,default:"key",tag:"tag:yaml.org,2002:merge",test:/^<<$/,resolve:()=>Object.assign(new re(Symbol(Rs)),{addToJSMap:Oc}),stringify:()=>Rs},_d=(n,e)=>(ut.identify(e)||me(e)&&(!e.type||e.type===re.PLAIN)&&ut.identify(e.value))&&(n==null?void 0:n.doc.schema.tags.some(t=>t.tag===ut.tag&&t.default));function Oc(n,e,t){if(t=n&&At(t)?t.resolve(n.doc):t,Tn(t))for(const s of t.items)vr(n,e,s);else if(Array.isArray(t))for(const s of t)vr(n,e,s);else vr(n,e,t)}function vr(n,e,t){const s=n&&At(t)?t.resolve(n.doc):t;if(!An(s))throw new Error("Merge sources must be maps or map aliases");const r=s.toJSON(null,n,Map);for(const[a,c]of r)e instanceof Map?e.has(a)||e.set(a,c):e instanceof Set?e.add(a):Object.prototype.hasOwnProperty.call(e,a)||Object.defineProperty(e,a,{value:c,writable:!0,enumerable:!0,configurable:!0});return e}function Nc(n,e,{key:t,value:s}){if(ke(t)&&t.addToJSMap)t.addToJSMap(n,e,s);else if(_d(n,t))Oc(n,e,s);else{const r=Ue(t,"",n);if(e instanceof Map)e.set(r,Ue(s,r,n));else if(e instanceof Set)e.add(r);else{const a=Ad(t,r,n),c=Ue(s,a,n);a in e?Object.defineProperty(e,a,{value:c,writable:!0,enumerable:!0,configurable:!0}):e[a]=c}}return e}function Ad(n,e,t){if(e===null)return"";if(typeof e!="object")return String(e);if(ke(n)&&(t!=null&&t.doc)){const s=Lc(t.doc,{});s.anchors=new Set;for(const a of t.anchors.keys())s.anchors.add(a.anchor);s.inFlow=!0,s.inStringifyKey=!0;const r=n.toString(s);if(!t.mapKeyWarned){let a=JSON.stringify(r);a.length>40&&(a=a.substring(0,36)+'..."'),Cc(t.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${a}. Set mapAsMap: true to use object keys.`),t.mapKeyWarned=!0}return r}return JSON.stringify(e)}function aa(n,e,t){const s=ss(n,void 0,t),r=ss(e,void 0,t);return new xe(s,r)}class xe{constructor(e,t=null){Object.defineProperty(this,ze,{value:yc}),this.key=e,this.value=t}clone(e){let{key:t,value:s}=this;return ke(t)&&(t=t.clone(e)),ke(s)&&(s=s.clone(e)),new xe(t,s)}toJSON(e,t){const s=t!=null&&t.mapAsMap?new Map:{};return Nc(t,s,this)}toString(e,t,s){return e!=null&&e.doc?Id(this,e,t,s):JSON.stringify(this)}}function $c(n,e,t){return(e.inFlow??n.flow?Ld:Td)(n,e,t)}function Td({comment:n,items:e},t,{blockItemPrefix:s,flowChars:r,itemIndent:a,onChompKeep:c,onComment:f}){const{indent:h,options:{commentString:m}}=t,_=Object.assign({},t,{indent:a,type:null});let b=!1;const E=[];for(let B=0;B<e.length;++B){const C=e[B];let D=null;if(ke(C))!b&&C.spaceBefore&&E.push(""),li(t,E,C.commentBefore,b),C.comment&&(D=C.comment);else if(we(C)){const W=ke(C.key)?C.key:null;W&&(!b&&W.spaceBefore&&E.push(""),li(t,E,W.commentBefore,b))}b=!1;let Y=kn(C,_,()=>D=null,()=>b=!0);D&&(Y+=Rt(Y,a,m(D))),b&&D&&(b=!1),E.push(s+Y)}let L;if(E.length===0)L=r.start+r.end;else{L=E[0];for(let B=1;B<E.length;++B){const C=E[B];L+=C?`
${h}${C}`:`
`}}return n?(L+=`
`+lt(m(n),h),f&&f()):b&&c&&c(),L}function Ld({items:n},e,{flowChars:t,itemIndent:s}){const{indent:r,indentStep:a,flowCollectionPadding:c,options:{commentString:f}}=e;s+=a;const h=Object.assign({},e,{indent:s,inFlow:!0,type:null});let m=!1,_=0;const b=[];for(let B=0;B<n.length;++B){const C=n[B];let D=null;if(ke(C))C.spaceBefore&&b.push(""),li(e,b,C.commentBefore,!1),C.comment&&(D=C.comment);else if(we(C)){const W=ke(C.key)?C.key:null;W&&(W.spaceBefore&&b.push(""),li(e,b,W.commentBefore,!1),W.comment&&(m=!0));const X=ke(C.value)?C.value:null;X?(X.comment&&(D=X.comment),X.commentBefore&&(m=!0)):C.value==null&&(W!=null&&W.comment)&&(D=W.comment)}D&&(m=!0);let Y=kn(C,h,()=>D=null);B<n.length-1&&(Y+=","),D&&(Y+=Rt(Y,s,f(D))),!m&&(b.length>_||Y.includes(`
`))&&(m=!0),b.push(Y),_=b.length}const{start:E,end:L}=t;if(b.length===0)return E+L;if(!m){const B=b.reduce((C,D)=>C+D.length+2,2);m=e.options.lineWidth>0&&B>e.options.lineWidth}if(m){let B=E;for(const C of b)B+=C?`
${a}${r}${C}`:`
`;return`${B}
${r}${L}`}else return`${E}${c}${b.join(" ")}${c}${L}`}function li({indent:n,options:{commentString:e}},t,s,r){if(s&&r&&(s=s.replace(/^\n+/,"")),s){const a=lt(e(s),n);t.push(a.trimStart())}}function Ft(n,e){const t=me(e)?e.value:e;for(const s of n)if(we(s)&&(s.key===e||s.key===t||me(s.key)&&s.key.value===t))return s}class Fe extends Ac{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(Et,e),this.items=[]}static from(e,t,s){const{keepUndefined:r,replacer:a}=s,c=new this(e),f=(h,m)=>{if(typeof a=="function")m=a.call(t,h,m);else if(Array.isArray(a)&&!a.includes(h))return;(m!==void 0||r)&&c.items.push(aa(h,m,s))};if(t instanceof Map)for(const[h,m]of t)f(h,m);else if(t&&typeof t=="object")for(const h of Object.keys(t))f(h,t[h]);return typeof e.sortMapEntries=="function"&&c.items.sort(e.sortMapEntries),c}add(e,t){var c;let s;we(e)?s=e:!e||typeof e!="object"||!("key"in e)?s=new xe(e,e==null?void 0:e.value):s=new xe(e.key,e.value);const r=Ft(this.items,s.key),a=(c=this.schema)==null?void 0:c.sortMapEntries;if(r){if(!t)throw new Error(`Key ${s.key} already set`);me(r.value)&&_c(s.value)?r.value.value=s.value:r.value=s.value}else if(a){const f=this.items.findIndex(h=>a(s,h)<0);f===-1?this.items.push(s):this.items.splice(f,0,s)}else this.items.push(s)}delete(e){const t=Ft(this.items,e);return t?this.items.splice(this.items.indexOf(t),1).length>0:!1}get(e,t){const s=Ft(this.items,e),r=s==null?void 0:s.value;return(!t&&me(r)?r.value:r)??void 0}has(e){return!!Ft(this.items,e)}set(e,t){this.add(new xe(e,t),!0)}toJSON(e,t,s){const r=s?new s:t!=null&&t.mapAsMap?new Map:{};t!=null&&t.onCreate&&t.onCreate(r);for(const a of this.items)Nc(t,r,a);return r}toString(e,t,s){if(!e)return JSON.stringify(this);for(const r of this.items)if(!we(r))throw new Error(`Map items must all be pairs; found ${JSON.stringify(r)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),$c(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:s,onComment:t})}}const Ln={collection:"map",default:!0,nodeClass:Fe,tag:"tag:yaml.org,2002:map",resolve(n,e){return An(n)||e("Expected a mapping for this tag"),n},createNode:(n,e,t)=>Fe.from(n,e,t)};class It extends Ac{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(_n,e),this.items=[]}add(e){this.items.push(e)}delete(e){const t=Fs(e);return typeof t!="number"?!1:this.items.splice(t,1).length>0}get(e,t){const s=Fs(e);if(typeof s!="number")return;const r=this.items[s];return!t&&me(r)?r.value:r}has(e){const t=Fs(e);return typeof t=="number"&&t<this.items.length}set(e,t){const s=Fs(e);if(typeof s!="number")throw new Error(`Expected a valid index, not ${e}.`);const r=this.items[s];me(r)&&_c(t)?r.value=t:this.items[s]=t}toJSON(e,t){const s=[];t!=null&&t.onCreate&&t.onCreate(s);let r=0;for(const a of this.items)s.push(Ue(a,String(r++),t));return s}toString(e,t,s){return e?$c(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:s,onComment:t}):JSON.stringify(this)}static from(e,t,s){const{replacer:r}=s,a=new this(e);if(t&&Symbol.iterator in Object(t)){let c=0;for(let f of t){if(typeof r=="function"){const h=t instanceof Set?f:String(c++);f=r.call(t,h,f)}a.items.push(ss(f,void 0,s))}}return a}}function Fs(n){let e=me(n)?n.value:n;return e&&typeof e=="string"&&(e=Number(e)),typeof e=="number"&&Number.isInteger(e)&&e>=0?e:null}const Cn={collection:"seq",default:!0,nodeClass:It,tag:"tag:yaml.org,2002:seq",resolve(n,e){return Tn(n)||e("Expected a sequence for this tag"),n},createNode:(n,e,t)=>It.from(n,e,t)},vi={identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify(n,e,t,s){return e=Object.assign({actualString:!0},e),os(n,e,t,s)}},bi={identify:n=>n==null,createNode:()=>new re(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new re(null),stringify:({source:n},e)=>typeof n=="string"&&bi.test.test(n)?n:e.options.nullStr},oa={identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:n=>new re(n[0]==="t"||n[0]==="T"),stringify({source:n,value:e},t){if(n&&oa.test.test(n)){const s=n[0]==="t"||n[0]==="T";if(e===s)return n}return e?t.options.trueStr:t.options.falseStr}};function Je({format:n,minFractionDigits:e,tag:t,value:s}){if(typeof s=="bigint")return String(s);const r=typeof s=="number"?s:Number(s);if(!isFinite(r))return isNaN(r)?".nan":r<0?"-.inf":".inf";let a=JSON.stringify(s);if(!n&&e&&(!t||t==="tag:yaml.org,2002:float")&&/^\d/.test(a)){let c=a.indexOf(".");c<0&&(c=a.length,a+=".");let f=e-(a.length-c-1);for(;f-- >0;)a+="0"}return a}const xc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Je},Mc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Je(n)}},Pc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(n){const e=new re(parseFloat(n)),t=n.indexOf(".");return t!==-1&&n[n.length-1]==="0"&&(e.minFractionDigits=n.length-t-1),e},stringify:Je},wi=n=>typeof n=="bigint"||Number.isInteger(n),ca=(n,e,t,{intAsBigInt:s})=>s?BigInt(n):parseInt(n.substring(e),t);function Dc(n,e,t){const{value:s}=n;return wi(s)&&s>=0?t+s.toString(e):Je(n)}const Bc={identify:n=>wi(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(n,e,t)=>ca(n,2,8,t),stringify:n=>Dc(n,8,"0o")},jc={identify:wi,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(n,e,t)=>ca(n,0,10,t),stringify:Je},Kc={identify:n=>wi(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(n,e,t)=>ca(n,2,16,t),stringify:n=>Dc(n,16,"0x")},Cd=[Ln,Cn,vi,bi,oa,Bc,jc,Kc,xc,Mc,Pc];function ko(n){return typeof n=="bigint"||Number.isInteger(n)}const Hs=({value:n})=>JSON.stringify(n),Od=[{identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify:Hs},{identify:n=>n==null,createNode:()=>new re(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:Hs},{identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true$|^false$/,resolve:n=>n==="true",stringify:Hs},{identify:ko,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(n,e,{intAsBigInt:t})=>t?BigInt(n):parseInt(n,10),stringify:({value:n})=>ko(n)?n.toString():JSON.stringify(n)},{identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:n=>parseFloat(n),stringify:Hs}],Nd={default:!0,tag:"",test:/^/,resolve(n,e){return e(`Unresolved plain scalar ${JSON.stringify(n)}`),n}},$d=[Ln,Cn].concat(Od,Nd),la={identify:n=>n instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(n,e){if(typeof atob=="function"){const t=atob(n.replace(/[\n\r]/g,"")),s=new Uint8Array(t.length);for(let r=0;r<t.length;++r)s[r]=t.charCodeAt(r);return s}else return e("This environment does not support reading binary tags; either Buffer or atob is required"),n},stringify({comment:n,type:e,value:t},s,r,a){if(!t)return"";const c=t;let f;if(typeof btoa=="function"){let h="";for(let m=0;m<c.length;++m)h+=String.fromCharCode(c[m]);f=btoa(h)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(e??(e=re.BLOCK_LITERAL),e!==re.QUOTE_DOUBLE){const h=Math.max(s.options.lineWidth-s.indent.length,s.options.minContentWidth),m=Math.ceil(f.length/h),_=new Array(m);for(let b=0,E=0;b<m;++b,E+=h)_[b]=f.substr(E,h);f=_.join(e===re.BLOCK_LITERAL?`
`:" ")}return os({comment:n,type:e,value:f},s,r,a)}};function qc(n,e){if(Tn(n))for(let t=0;t<n.items.length;++t){let s=n.items[t];if(!we(s)){if(An(s)){s.items.length>1&&e("Each pair must have its own sequence indicator");const r=s.items[0]||new xe(new re(null));if(s.commentBefore&&(r.key.commentBefore=r.key.commentBefore?`${s.commentBefore}
${r.key.commentBefore}`:s.commentBefore),s.comment){const a=r.value??r.key;a.comment=a.comment?`${s.comment}
${a.comment}`:s.comment}s=r}n.items[t]=we(s)?s:new xe(s)}}else e("Expected a sequence for this tag");return n}function Rc(n,e,t){const{replacer:s}=t,r=new It(n);r.tag="tag:yaml.org,2002:pairs";let a=0;if(e&&Symbol.iterator in Object(e))for(let c of e){typeof s=="function"&&(c=s.call(e,String(a++),c));let f,h;if(Array.isArray(c))if(c.length===2)f=c[0],h=c[1];else throw new TypeError(`Expected [key, value] tuple: ${c}`);else if(c&&c instanceof Object){const m=Object.keys(c);if(m.length===1)f=m[0],h=c[f];else throw new TypeError(`Expected tuple with one key, not ${m.length} keys`)}else f=c;r.items.push(aa(f,h,t))}return r}const ua={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:qc,createNode:Rc};class gn extends It{constructor(){super(),this.add=Fe.prototype.add.bind(this),this.delete=Fe.prototype.delete.bind(this),this.get=Fe.prototype.get.bind(this),this.has=Fe.prototype.has.bind(this),this.set=Fe.prototype.set.bind(this),this.tag=gn.tag}toJSON(e,t){if(!t)return super.toJSON(e);const s=new Map;t!=null&&t.onCreate&&t.onCreate(s);for(const r of this.items){let a,c;if(we(r)?(a=Ue(r.key,"",t),c=Ue(r.value,a,t)):a=Ue(r,"",t),s.has(a))throw new Error("Ordered maps must not include duplicate keys");s.set(a,c)}return s}static from(e,t,s){const r=Rc(e,t,s),a=new this;return a.items=r.items,a}}gn.tag="tag:yaml.org,2002:omap";const fa={collection:"seq",identify:n=>n instanceof Map,nodeClass:gn,default:!1,tag:"tag:yaml.org,2002:omap",resolve(n,e){const t=qc(n,e),s=[];for(const{key:r}of t.items)me(r)&&(s.includes(r.value)?e(`Ordered maps must not include duplicate keys: ${r.value}`):s.push(r.value));return Object.assign(new gn,t)},createNode:(n,e,t)=>gn.from(n,e,t)};function Fc({value:n,source:e},t){return e&&(n?Hc:Uc).test.test(e)?e:n?t.options.trueStr:t.options.falseStr}const Hc={identify:n=>n===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new re(!0),stringify:Fc},Uc={identify:n=>n===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/,resolve:()=>new re(!1),stringify:Fc},xd={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Je},Md={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n.replace(/_/g,"")),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Je(n)}},Pd={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(n){const e=new re(parseFloat(n.replace(/_/g,""))),t=n.indexOf(".");if(t!==-1){const s=n.substring(t+1).replace(/_/g,"");s[s.length-1]==="0"&&(e.minFractionDigits=s.length)}return e},stringify:Je},cs=n=>typeof n=="bigint"||Number.isInteger(n);function Si(n,e,t,{intAsBigInt:s}){const r=n[0];if((r==="-"||r==="+")&&(e+=1),n=n.substring(e).replace(/_/g,""),s){switch(t){case 2:n=`0b${n}`;break;case 8:n=`0o${n}`;break;case 16:n=`0x${n}`;break}const c=BigInt(n);return r==="-"?BigInt(-1)*c:c}const a=parseInt(n,t);return r==="-"?-1*a:a}function da(n,e,t){const{value:s}=n;if(cs(s)){const r=s.toString(e);return s<0?"-"+t+r.substr(1):t+r}return Je(n)}const Dd={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(n,e,t)=>Si(n,2,2,t),stringify:n=>da(n,2,"0b")},Bd={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(n,e,t)=>Si(n,1,8,t),stringify:n=>da(n,8,"0")},jd={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(n,e,t)=>Si(n,0,10,t),stringify:Je},Kd={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(n,e,t)=>Si(n,2,16,t),stringify:n=>da(n,16,"0x")};class vn extends Fe{constructor(e){super(e),this.tag=vn.tag}add(e){let t;we(e)?t=e:e&&typeof e=="object"&&"key"in e&&"value"in e&&e.value===null?t=new xe(e.key,null):t=new xe(e,null),Ft(this.items,t.key)||this.items.push(t)}get(e,t){const s=Ft(this.items,e);return!t&&we(s)?me(s.key)?s.key.value:s.key:s}set(e,t){if(typeof t!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof t}`);const s=Ft(this.items,e);s&&!t?this.items.splice(this.items.indexOf(s),1):!s&&t&&this.items.push(new xe(e))}toJSON(e,t){return super.toJSON(e,t,Set)}toString(e,t,s){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),t,s);throw new Error("Set items must all have null values")}static from(e,t,s){const{replacer:r}=s,a=new this(e);if(t&&Symbol.iterator in Object(t))for(let c of t)typeof r=="function"&&(c=r.call(t,c,c)),a.items.push(aa(c,null,s));return a}}vn.tag="tag:yaml.org,2002:set";const ha={collection:"map",identify:n=>n instanceof Set,nodeClass:vn,default:!1,tag:"tag:yaml.org,2002:set",createNode:(n,e,t)=>vn.from(n,e,t),resolve(n,e){if(An(n)){if(n.hasAllNullValues(!0))return Object.assign(new vn,n);e("Set items must all have null values")}else e("Expected a mapping for this tag");return n}};function pa(n,e){const t=n[0],s=t==="-"||t==="+"?n.substring(1):n,r=c=>e?BigInt(c):Number(c),a=s.replace(/_/g,"").split(":").reduce((c,f)=>c*r(60)+r(f),r(0));return t==="-"?r(-1)*a:a}function zc(n){let{value:e}=n,t=c=>c;if(typeof e=="bigint")t=c=>BigInt(c);else if(isNaN(e)||!isFinite(e))return Je(n);let s="";e<0&&(s="-",e*=t(-1));const r=t(60),a=[e%r];return e<60?a.unshift(0):(e=(e-a[0])/r,a.unshift(e%r),e>=60&&(e=(e-a[0])/r,a.unshift(e))),s+a.map(c=>String(c).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const Vc={identify:n=>typeof n=="bigint"||Number.isInteger(n),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(n,e,{intAsBigInt:t})=>pa(n,t),stringify:zc},Yc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:n=>pa(n,!1),stringify:zc},ki={identify:n=>n instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(n){const e=n.match(ki.test);if(!e)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,t,s,r,a,c,f]=e.map(Number),h=e[7]?Number((e[7]+"00").substr(1,3)):0;let m=Date.UTC(t,s-1,r,a||0,c||0,f||0,h);const _=e[8];if(_&&_!=="Z"){let b=pa(_,!1);Math.abs(b)<30&&(b*=60),m-=6e4*b}return new Date(m)},stringify:({value:n})=>(n==null?void 0:n.toISOString().replace(/(T00:00:00)?\.000Z$/,""))??""},Eo=[Ln,Cn,vi,bi,Hc,Uc,Dd,Bd,jd,Kd,xd,Md,Pd,la,ut,fa,ua,ha,Vc,Yc,ki],Io=new Map([["core",Cd],["failsafe",[Ln,Cn,vi]],["json",$d],["yaml11",Eo],["yaml-1.1",Eo]]),_o={binary:la,bool:oa,float:Pc,floatExp:Mc,floatNaN:xc,floatTime:Yc,int:jc,intHex:Kc,intOct:Bc,intTime:Vc,map:Ln,merge:ut,null:bi,omap:fa,pairs:ua,seq:Cn,set:ha,timestamp:ki},qd={"tag:yaml.org,2002:binary":la,"tag:yaml.org,2002:merge":ut,"tag:yaml.org,2002:omap":fa,"tag:yaml.org,2002:pairs":ua,"tag:yaml.org,2002:set":ha,"tag:yaml.org,2002:timestamp":ki};function br(n,e,t){const s=Io.get(e);if(s&&!n)return t&&!s.includes(ut)?s.concat(ut):s.slice();let r=s;if(!r)if(Array.isArray(n))r=[];else{const a=Array.from(Io.keys()).filter(c=>c!=="yaml11").map(c=>JSON.stringify(c)).join(", ");throw new Error(`Unknown schema "${e}"; use one of ${a} or define customTags array`)}if(Array.isArray(n))for(const a of n)r=r.concat(a);else typeof n=="function"&&(r=n(r.slice()));return t&&(r=r.concat(ut)),r.reduce((a,c)=>{const f=typeof c=="string"?_o[c]:c;if(!f){const h=JSON.stringify(c),m=Object.keys(_o).map(_=>JSON.stringify(_)).join(", ");throw new Error(`Unknown custom tag ${h}; use one of ${m}`)}return a.includes(f)||a.push(f),a},[])}const Rd=(n,e)=>n.key<e.key?-1:n.key>e.key?1:0;class Ei{constructor({compat:e,customTags:t,merge:s,resolveKnownTags:r,schema:a,sortMapEntries:c,toStringDefaults:f}){this.compat=Array.isArray(e)?br(e,"compat"):e?br(null,e):null,this.name=typeof a=="string"&&a||"core",this.knownTags=r?qd:{},this.tags=br(t,this.name,s),this.toStringOptions=f??null,Object.defineProperty(this,Et,{value:Ln}),Object.defineProperty(this,tt,{value:vi}),Object.defineProperty(this,_n,{value:Cn}),this.sortMapEntries=typeof c=="function"?c:c===!0?Rd:null}clone(){const e=Object.create(Ei.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}}function Fd(n,e){var h;const t=[];let s=e.directives===!0;if(e.directives!==!1&&n.directives){const m=n.directives.toString(n);m?(t.push(m),s=!0):n.directives.docStart&&(s=!0)}s&&t.push("---");const r=Lc(n,e),{commentString:a}=r.options;if(n.commentBefore){t.length!==1&&t.unshift("");const m=a(n.commentBefore);t.unshift(lt(m,""))}let c=!1,f=null;if(n.contents){if(ke(n.contents)){if(n.contents.spaceBefore&&s&&t.push(""),n.contents.commentBefore){const b=a(n.contents.commentBefore);t.push(lt(b,""))}r.forceBlockIndent=!!n.comment,f=n.contents.comment}const m=f?void 0:()=>c=!0;let _=kn(n.contents,r,()=>f=null,m);f&&(_+=Rt(_,"",a(f))),(_[0]==="|"||_[0]===">")&&t[t.length-1]==="---"?t[t.length-1]=`--- ${_}`:t.push(_)}else t.push(kn(n.contents,r));if((h=n.directives)!=null&&h.docEnd)if(n.comment){const m=a(n.comment);m.includes(`
`)?(t.push("..."),t.push(lt(m,""))):t.push(`... ${m}`)}else t.push("...");else{let m=n.comment;m&&c&&(m=m.replace(/^\n+/,"")),m&&((!c||f)&&t[t.length-1]!==""&&t.push(""),t.push(lt(a(m),"")))}return t.join(`
`)+`
`}class On{constructor(e,t,s){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,ze,{value:Yr});let r=null;typeof t=="function"||Array.isArray(t)?r=t:s===void 0&&t&&(s=t,t=void 0);const a=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,stringKeys:!1,uniqueKeys:!0,version:"1.2"},s);this.options=a;let{version:c}=a;s!=null&&s._directives?(this.directives=s._directives.atDocument(),this.directives.yaml.explicit&&(c=this.directives.yaml.version)):this.directives=new Pe({version:c}),this.setSchema(c,s),this.contents=e===void 0?null:this.createNode(e,r,s)}clone(){const e=Object.create(On.prototype,{[ze]:{value:Yr}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=ke(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){cn(this.contents)&&this.contents.add(e)}addIn(e,t){cn(this.contents)&&this.contents.addIn(e,t)}createAlias(e,t){if(!e.anchor){const s=Ec(this);e.anchor=!t||s.has(t)?Ic(t||"a",s):t}return new pi(e.anchor)}createNode(e,t,s){let r;if(typeof t=="function")e=t.call({"":e},"",e),r=t;else if(Array.isArray(t)){const D=W=>typeof W=="number"||W instanceof String||W instanceof Number,Y=t.filter(D).map(String);Y.length>0&&(t=t.concat(Y)),r=t}else s===void 0&&t&&(s=t,t=void 0);const{aliasDuplicateObjects:a,anchorPrefix:c,flow:f,keepUndefined:h,onTagObj:m,tag:_}=s??{},{onAnchor:b,setAnchors:E,sourceObjects:L}=yd(this,c||"a"),B={aliasDuplicateObjects:a??!0,keepUndefined:h??!1,onAnchor:b,onTagObj:m,replacer:r,schema:this.schema,sourceObjects:L},C=ss(e,_,B);return f&&Se(C)&&(C.flow=!0),E(),C}createPair(e,t,s={}){const r=this.createNode(e,null,s),a=this.createNode(t,null,s);return new xe(r,a)}delete(e){return cn(this.contents)?this.contents.delete(e):!1}deleteIn(e){return Wn(e)?this.contents==null?!1:(this.contents=null,!0):cn(this.contents)?this.contents.deleteIn(e):!1}get(e,t){return Se(this.contents)?this.contents.get(e,t):void 0}getIn(e,t){return Wn(e)?!t&&me(this.contents)?this.contents.value:this.contents:Se(this.contents)?this.contents.getIn(e,t):void 0}has(e){return Se(this.contents)?this.contents.has(e):!1}hasIn(e){return Wn(e)?this.contents!==void 0:Se(this.contents)?this.contents.hasIn(e):!1}set(e,t){this.contents==null?this.contents=ci(this.schema,[e],t):cn(this.contents)&&this.contents.set(e,t)}setIn(e,t){Wn(e)?this.contents=t:this.contents==null?this.contents=ci(this.schema,Array.from(e),t):cn(this.contents)&&this.contents.setIn(e,t)}setSchema(e,t={}){typeof e=="number"&&(e=String(e));let s;switch(e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Pe({version:"1.1"}),s={resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Pe({version:e}),s={resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,s=null;break;default:{const r=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${r}`)}}if(t.schema instanceof Object)this.schema=t.schema;else if(s)this.schema=new Ei(Object.assign(s,t));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:e,jsonArg:t,mapAsMap:s,maxAliasCount:r,onAnchor:a,reviver:c}={}){const f={anchors:new Map,doc:this,keep:!e,mapAsMap:s===!0,mapKeyWarned:!1,maxAliasCount:typeof r=="number"?r:100},h=Ue(this.contents,t??"",f);if(typeof a=="function")for(const{count:m,res:_}of f.anchors.values())a(_,m);return typeof c=="function"?hn(c,{"":h},"",h):h}toJSON(e,t){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:t})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){const t=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${t}`)}return Fd(this,e)}}function cn(n){if(Se(n))return!0;throw new Error("Expected a YAML collection as document contents")}class ma extends Error{constructor(e,t,s,r){super(),this.name=e,this.code=s,this.message=r,this.pos=t}}class Ht extends ma{constructor(e,t,s){super("YAMLParseError",e,t,s)}}class Jc extends ma{constructor(e,t,s){super("YAMLWarning",e,t,s)}}const ui=(n,e)=>t=>{if(t.pos[0]===-1)return;t.linePos=t.pos.map(f=>e.linePos(f));const{line:s,col:r}=t.linePos[0];t.message+=` at line ${s}, column ${r}`;let a=r-1,c=n.substring(e.lineStarts[s-1],e.lineStarts[s]).replace(/[\n\r]+$/,"");if(a>=60&&c.length>80){const f=Math.min(a-39,c.length-79);c="…"+c.substring(f),a-=f-1}if(c.length>80&&(c=c.substring(0,79)+"…"),s>1&&/^ *$/.test(c.substring(0,a))){let f=n.substring(e.lineStarts[s-2],e.lineStarts[s-1]);f.length>80&&(f=f.substring(0,79)+`…
`),c=f+c}if(/[^ ]/.test(c)){let f=1;const h=t.linePos[1];h&&h.line===s&&h.col>r&&(f=Math.max(1,Math.min(h.col-r,80-a)));const m=" ".repeat(a)+"^".repeat(f);t.message+=`:

${c}
${m}
`}};function En(n,{flow:e,indicator:t,next:s,offset:r,onError:a,parentIndent:c,startOnNewline:f}){let h=!1,m=f,_=f,b="",E="",L=!1,B=!1,C=null,D=null,Y=null,W=null,X=null,Q=null,ee=null;for(const G of n)switch(B&&(G.type!=="space"&&G.type!=="newline"&&G.type!=="comma"&&a(G.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),B=!1),C&&(m&&G.type!=="comment"&&G.type!=="newline"&&a(C,"TAB_AS_INDENT","Tabs are not allowed as indentation"),C=null),G.type){case"space":!e&&(t!=="doc-start"||(s==null?void 0:s.type)!=="flow-collection")&&G.source.includes("	")&&(C=G),_=!0;break;case"comment":{_||a(G,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const ye=G.source.substring(1)||" ";b?b+=E+ye:b=ye,E="",m=!1;break}case"newline":m?b?b+=G.source:(!Q||t!=="seq-item-ind")&&(h=!0):E+=G.source,m=!0,L=!0,(D||Y)&&(W=G),_=!0;break;case"anchor":D&&a(G,"MULTIPLE_ANCHORS","A node can have at most one anchor"),G.source.endsWith(":")&&a(G.offset+G.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),D=G,ee??(ee=G.offset),m=!1,_=!1,B=!0;break;case"tag":{Y&&a(G,"MULTIPLE_TAGS","A node can have at most one tag"),Y=G,ee??(ee=G.offset),m=!1,_=!1,B=!0;break}case t:(D||Y)&&a(G,"BAD_PROP_ORDER",`Anchors and tags must be after the ${G.source} indicator`),Q&&a(G,"UNEXPECTED_TOKEN",`Unexpected ${G.source} in ${e??"collection"}`),Q=G,m=t==="seq-item-ind"||t==="explicit-key-ind",_=!1;break;case"comma":if(e){X&&a(G,"UNEXPECTED_TOKEN",`Unexpected , in ${e}`),X=G,m=!1,_=!1;break}default:a(G,"UNEXPECTED_TOKEN",`Unexpected ${G.type} token`),m=!1,_=!1}const te=n[n.length-1],oe=te?te.offset+te.source.length:r;return B&&s&&s.type!=="space"&&s.type!=="newline"&&s.type!=="comma"&&(s.type!=="scalar"||s.source!=="")&&a(s.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),C&&(m&&C.indent<=c||(s==null?void 0:s.type)==="block-map"||(s==null?void 0:s.type)==="block-seq")&&a(C,"TAB_AS_INDENT","Tabs are not allowed as indentation"),{comma:X,found:Q,spaceBefore:h,comment:b,hasNewline:L,anchor:D,tag:Y,newlineAfterProp:W,end:oe,start:ee??oe}}function is(n){if(!n)return null;switch(n.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(n.source.includes(`
`))return!0;if(n.end){for(const e of n.end)if(e.type==="newline")return!0}return!1;case"flow-collection":for(const e of n.items){for(const t of e.start)if(t.type==="newline")return!0;if(e.sep){for(const t of e.sep)if(t.type==="newline")return!0}if(is(e.key)||is(e.value))return!0}return!1;default:return!0}}function Qr(n,e,t){if((e==null?void 0:e.type)==="flow-collection"){const s=e.end[0];s.indent===n&&(s.source==="]"||s.source==="}")&&is(e)&&t(s,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}function Gc(n,e,t){const{uniqueKeys:s}=n.options;if(s===!1)return!1;const r=typeof s=="function"?s:(a,c)=>a===c||me(a)&&me(c)&&a.value===c.value;return e.some(a=>r(a.key,t))}const Ao="All mapping items must start at the same column";function Hd({composeNode:n,composeEmptyNode:e},t,s,r,a){var _;const c=(a==null?void 0:a.nodeClass)??Fe,f=new c(t.schema);t.atRoot&&(t.atRoot=!1);let h=s.offset,m=null;for(const b of s.items){const{start:E,key:L,sep:B,value:C}=b,D=En(E,{indicator:"explicit-key-ind",next:L??(B==null?void 0:B[0]),offset:h,onError:r,parentIndent:s.indent,startOnNewline:!0}),Y=!D.found;if(Y){if(L&&(L.type==="block-seq"?r(h,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in L&&L.indent!==s.indent&&r(h,"BAD_INDENT",Ao)),!D.anchor&&!D.tag&&!B){m=D.end,D.comment&&(f.comment?f.comment+=`
`+D.comment:f.comment=D.comment);continue}(D.newlineAfterProp||is(L))&&r(L??E[E.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else((_=D.found)==null?void 0:_.indent)!==s.indent&&r(h,"BAD_INDENT",Ao);t.atKey=!0;const W=D.end,X=L?n(t,L,D,r):e(t,W,E,null,D,r);t.schema.compat&&Qr(s.indent,L,r),t.atKey=!1,Gc(t,f.items,X)&&r(W,"DUPLICATE_KEY","Map keys must be unique");const Q=En(B??[],{indicator:"map-value-ind",next:C,offset:X.range[2],onError:r,parentIndent:s.indent,startOnNewline:!L||L.type==="block-scalar"});if(h=Q.end,Q.found){Y&&((C==null?void 0:C.type)==="block-map"&&!Q.hasNewline&&r(h,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),t.options.strict&&D.start<Q.found.offset-1024&&r(X.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const ee=C?n(t,C,Q,r):e(t,h,B,null,Q,r);t.schema.compat&&Qr(s.indent,C,r),h=ee.range[2];const te=new xe(X,ee);t.options.keepSourceTokens&&(te.srcToken=b),f.items.push(te)}else{Y&&r(X.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),Q.comment&&(X.comment?X.comment+=`
`+Q.comment:X.comment=Q.comment);const ee=new xe(X);t.options.keepSourceTokens&&(ee.srcToken=b),f.items.push(ee)}}return m&&m<h&&r(m,"IMPOSSIBLE","Map comment with trailing content"),f.range=[s.offset,h,m??h],f}function Ud({composeNode:n,composeEmptyNode:e},t,s,r,a){const c=(a==null?void 0:a.nodeClass)??It,f=new c(t.schema);t.atRoot&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let h=s.offset,m=null;for(const{start:_,value:b}of s.items){const E=En(_,{indicator:"seq-item-ind",next:b,offset:h,onError:r,parentIndent:s.indent,startOnNewline:!0});if(!E.found)if(E.anchor||E.tag||b)b&&b.type==="block-seq"?r(E.end,"BAD_INDENT","All sequence items must start at the same column"):r(h,"MISSING_CHAR","Sequence item without - indicator");else{m=E.end,E.comment&&(f.comment=E.comment);continue}const L=b?n(t,b,E,r):e(t,E.end,_,null,E,r);t.schema.compat&&Qr(s.indent,b,r),h=L.range[2],f.items.push(L)}return f.range=[s.offset,h,m??h],f}function ls(n,e,t,s){let r="";if(n){let a=!1,c="";for(const f of n){const{source:h,type:m}=f;switch(m){case"space":a=!0;break;case"comment":{t&&!a&&s(f,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const _=h.substring(1)||" ";r?r+=c+_:r=_,c="";break}case"newline":r&&(c+=h),a=!0;break;default:s(f,"UNEXPECTED_TOKEN",`Unexpected ${m} at node end`)}e+=h.length}}return{comment:r,offset:e}}const wr="Block collections are not allowed within flow collections",Sr=n=>n&&(n.type==="block-map"||n.type==="block-seq");function zd({composeNode:n,composeEmptyNode:e},t,s,r,a){const c=s.start.source==="{",f=c?"flow map":"flow sequence",h=(a==null?void 0:a.nodeClass)??(c?Fe:It),m=new h(t.schema);m.flow=!0;const _=t.atRoot;_&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let b=s.offset+s.start.source.length;for(let D=0;D<s.items.length;++D){const Y=s.items[D],{start:W,key:X,sep:Q,value:ee}=Y,te=En(W,{flow:f,indicator:"explicit-key-ind",next:X??(Q==null?void 0:Q[0]),offset:b,onError:r,parentIndent:s.indent,startOnNewline:!1});if(!te.found){if(!te.anchor&&!te.tag&&!Q&&!ee){D===0&&te.comma?r(te.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${f}`):D<s.items.length-1&&r(te.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${f}`),te.comment&&(m.comment?m.comment+=`
`+te.comment:m.comment=te.comment),b=te.end;continue}!c&&t.options.strict&&is(X)&&r(X,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if(D===0)te.comma&&r(te.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${f}`);else if(te.comma||r(te.start,"MISSING_CHAR",`Missing , between ${f} items`),te.comment){let oe="";e:for(const G of W)switch(G.type){case"comma":case"space":break;case"comment":oe=G.source.substring(1);break e;default:break e}if(oe){let G=m.items[m.items.length-1];we(G)&&(G=G.value??G.key),G.comment?G.comment+=`
`+oe:G.comment=oe,te.comment=te.comment.substring(oe.length+1)}}if(!c&&!Q&&!te.found){const oe=ee?n(t,ee,te,r):e(t,te.end,Q,null,te,r);m.items.push(oe),b=oe.range[2],Sr(ee)&&r(oe.range,"BLOCK_IN_FLOW",wr)}else{t.atKey=!0;const oe=te.end,G=X?n(t,X,te,r):e(t,oe,W,null,te,r);Sr(X)&&r(G.range,"BLOCK_IN_FLOW",wr),t.atKey=!1;const ye=En(Q??[],{flow:f,indicator:"map-value-ind",next:ee,offset:G.range[2],onError:r,parentIndent:s.indent,startOnNewline:!1});if(ye.found){if(!c&&!te.found&&t.options.strict){if(Q)for(const ge of Q){if(ge===ye.found)break;if(ge.type==="newline"){r(ge,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}te.start<ye.found.offset-1024&&r(ye.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else ee&&("source"in ee&&ee.source&&ee.source[0]===":"?r(ee,"MISSING_CHAR",`Missing space after : in ${f}`):r(ye.start,"MISSING_CHAR",`Missing , or : between ${f} items`));const Ve=ee?n(t,ee,ye,r):ye.found?e(t,ye.end,Q,null,ye,r):null;Ve?Sr(ee)&&r(Ve.range,"BLOCK_IN_FLOW",wr):ye.comment&&(G.comment?G.comment+=`
`+ye.comment:G.comment=ye.comment);const nt=new xe(G,Ve);if(t.options.keepSourceTokens&&(nt.srcToken=Y),c){const ge=m;Gc(t,ge.items,G)&&r(oe,"DUPLICATE_KEY","Map keys must be unique"),ge.items.push(nt)}else{const ge=new Fe(t.schema);ge.flow=!0,ge.items.push(nt);const Ge=(Ve??G).range;ge.range=[G.range[0],Ge[1],Ge[2]],m.items.push(ge)}b=Ve?Ve.range[2]:ye.end}}const E=c?"}":"]",[L,...B]=s.end;let C=b;if(L&&L.source===E)C=L.offset+L.source.length;else{const D=f[0].toUpperCase()+f.substring(1),Y=_?`${D} must end with a ${E}`:`${D} in block collection must be sufficiently indented and end with a ${E}`;r(b,_?"MISSING_CHAR":"BAD_INDENT",Y),L&&L.source.length!==1&&B.unshift(L)}if(B.length>0){const D=ls(B,C,t.options.strict,r);D.comment&&(m.comment?m.comment+=`
`+D.comment:m.comment=D.comment),m.range=[s.offset,C,D.offset]}else m.range=[s.offset,C,C];return m}function kr(n,e,t,s,r,a){const c=t.type==="block-map"?Hd(n,e,t,s,a):t.type==="block-seq"?Ud(n,e,t,s,a):zd(n,e,t,s,a),f=c.constructor;return r==="!"||r===f.tagName?(c.tag=f.tagName,c):(r&&(c.tag=r),c)}function Vd(n,e,t,s,r){var E;const a=s.tag,c=a?e.directives.tagName(a.source,L=>r(a,"TAG_RESOLVE_FAILED",L)):null;if(t.type==="block-seq"){const{anchor:L,newlineAfterProp:B}=s,C=L&&a?L.offset>a.offset?L:a:L??a;C&&(!B||B.offset<C.offset)&&r(C,"MISSING_CHAR","Missing newline after block sequence props")}const f=t.type==="block-map"?"map":t.type==="block-seq"?"seq":t.start.source==="{"?"map":"seq";if(!a||!c||c==="!"||c===Fe.tagName&&f==="map"||c===It.tagName&&f==="seq")return kr(n,e,t,r,c);let h=e.schema.tags.find(L=>L.tag===c&&L.collection===f);if(!h){const L=e.schema.knownTags[c];if(L&&L.collection===f)e.schema.tags.push(Object.assign({},L,{default:!1})),h=L;else return L?r(a,"BAD_COLLECTION_TYPE",`${L.tag} used for ${f} collection, but expects ${L.collection??"scalar"}`,!0):r(a,"TAG_RESOLVE_FAILED",`Unresolved tag: ${c}`,!0),kr(n,e,t,r,c)}const m=kr(n,e,t,r,c,h),_=((E=h.resolve)==null?void 0:E.call(h,m,L=>r(a,"TAG_RESOLVE_FAILED",L),e.options))??m,b=ke(_)?_:new re(_);return b.range=m.range,b.tag=c,h!=null&&h.format&&(b.format=h.format),b}function Wc(n,e,t){const s=e.offset,r=Yd(e,n.options.strict,t);if(!r)return{value:"",type:null,comment:"",range:[s,s,s]};const a=r.mode===">"?re.BLOCK_FOLDED:re.BLOCK_LITERAL,c=e.source?Jd(e.source):[];let f=c.length;for(let C=c.length-1;C>=0;--C){const D=c[C][1];if(D===""||D==="\r")f=C;else break}if(f===0){const C=r.chomp==="+"&&c.length>0?`
`.repeat(Math.max(1,c.length-1)):"";let D=s+r.length;return e.source&&(D+=e.source.length),{value:C,type:a,comment:r.comment,range:[s,D,D]}}let h=e.indent+r.indent,m=e.offset+r.length,_=0;for(let C=0;C<f;++C){const[D,Y]=c[C];if(Y===""||Y==="\r")r.indent===0&&D.length>h&&(h=D.length);else{D.length<h&&t(m+D.length,"MISSING_CHAR","Block scalars with more-indented leading empty lines must use an explicit indentation indicator"),r.indent===0&&(h=D.length),_=C,h===0&&!n.atRoot&&t(m,"BAD_INDENT","Block scalar values in collections must be indented");break}m+=D.length+Y.length+1}for(let C=c.length-1;C>=f;--C)c[C][0].length>h&&(f=C+1);let b="",E="",L=!1;for(let C=0;C<_;++C)b+=c[C][0].slice(h)+`
`;for(let C=_;C<f;++C){let[D,Y]=c[C];m+=D.length+Y.length+1;const W=Y[Y.length-1]==="\r";if(W&&(Y=Y.slice(0,-1)),Y&&D.length<h){const Q=`Block scalar lines must not be less indented than their ${r.indent?"explicit indentation indicator":"first line"}`;t(m-Y.length-(W?2:1),"BAD_INDENT",Q),D=""}a===re.BLOCK_LITERAL?(b+=E+D.slice(h)+Y,E=`
`):D.length>h||Y[0]==="	"?(E===" "?E=`
`:!L&&E===`
`&&(E=`

`),b+=E+D.slice(h)+Y,E=`
`,L=!0):Y===""?E===`
`?b+=`
`:E=`
`:(b+=E+Y,E=" ",L=!1)}switch(r.chomp){case"-":break;case"+":for(let C=f;C<c.length;++C)b+=`
`+c[C][0].slice(h);b[b.length-1]!==`
`&&(b+=`
`);break;default:b+=`
`}const B=s+r.length+e.source.length;return{value:b,type:a,comment:r.comment,range:[s,B,B]}}function Yd({offset:n,props:e},t,s){if(e[0].type!=="block-scalar-header")return s(e[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:r}=e[0],a=r[0];let c=0,f="",h=-1;for(let E=1;E<r.length;++E){const L=r[E];if(!f&&(L==="-"||L==="+"))f=L;else{const B=Number(L);!c&&B?c=B:h===-1&&(h=n+E)}}h!==-1&&s(h,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${r}`);let m=!1,_="",b=r.length;for(let E=1;E<e.length;++E){const L=e[E];switch(L.type){case"space":m=!0;case"newline":b+=L.source.length;break;case"comment":t&&!m&&s(L,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),b+=L.source.length,_=L.source.substring(1);break;case"error":s(L,"UNEXPECTED_TOKEN",L.message),b+=L.source.length;break;default:{const B=`Unexpected token in block scalar header: ${L.type}`;s(L,"UNEXPECTED_TOKEN",B);const C=L.source;C&&typeof C=="string"&&(b+=C.length)}}}return{mode:a,indent:c,chomp:f,comment:_,length:b}}function Jd(n){const e=n.split(/\n( *)/),t=e[0],s=t.match(/^( *)/),a=[s!=null&&s[1]?[s[1],t.slice(s[1].length)]:["",t]];for(let c=1;c<e.length;c+=2)a.push([e[c],e[c+1]]);return a}function Qc(n,e,t){const{offset:s,type:r,source:a,end:c}=n;let f,h;const m=(E,L,B)=>t(s+E,L,B);switch(r){case"scalar":f=re.PLAIN,h=Gd(a,m);break;case"single-quoted-scalar":f=re.QUOTE_SINGLE,h=Wd(a,m);break;case"double-quoted-scalar":f=re.QUOTE_DOUBLE,h=Qd(a,m);break;default:return t(n,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${r}`),{value:"",type:null,comment:"",range:[s,s+a.length,s+a.length]}}const _=s+a.length,b=ls(c,_,e,t);return{value:h,type:f,comment:b.comment,range:[s,_,b.offset]}}function Gd(n,e){let t="";switch(n[0]){case"	":t="a tab character";break;case",":t="flow indicator character ,";break;case"%":t="directive indicator character %";break;case"|":case">":{t=`block scalar indicator ${n[0]}`;break}case"@":case"`":{t=`reserved character ${n[0]}`;break}}return t&&e(0,"BAD_SCALAR_START",`Plain value cannot start with ${t}`),Xc(n)}function Wd(n,e){return(n[n.length-1]!=="'"||n.length===1)&&e(n.length,"MISSING_CHAR","Missing closing 'quote"),Xc(n.slice(1,-1)).replace(/''/g,"'")}function Xc(n){let e,t;try{e=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),t=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{e=/(.*?)[ \t]*\r?\n/sy,t=/[ \t]*(.*?)[ \t]*\r?\n/sy}let s=e.exec(n);if(!s)return n;let r=s[1],a=" ",c=e.lastIndex;for(t.lastIndex=c;s=t.exec(n);)s[1]===""?a===`
`?r+=a:a=`
`:(r+=a+s[1],a=" "),c=t.lastIndex;const f=/[ \t]*(.*)/sy;return f.lastIndex=c,s=f.exec(n),r+a+((s==null?void 0:s[1])??"")}function Qd(n,e){let t="";for(let s=1;s<n.length-1;++s){const r=n[s];if(!(r==="\r"&&n[s+1]===`
`))if(r===`
`){const{fold:a,offset:c}=Xd(n,s);t+=a,s=c}else if(r==="\\"){let a=n[++s];const c=Zd[a];if(c)t+=c;else if(a===`
`)for(a=n[s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="\r"&&n[s+1]===`
`)for(a=n[++s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="x"||a==="u"||a==="U"){const f={x:2,u:4,U:8}[a];t+=eh(n,s+1,f,e),s+=f}else{const f=n.substr(s-1,2);e(s-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${f}`),t+=f}}else if(r===" "||r==="	"){const a=s;let c=n[s+1];for(;c===" "||c==="	";)c=n[++s+1];c!==`
`&&!(c==="\r"&&n[s+2]===`
`)&&(t+=s>a?n.slice(a,s+1):r)}else t+=r}return(n[n.length-1]!=='"'||n.length===1)&&e(n.length,"MISSING_CHAR",'Missing closing "quote'),t}function Xd(n,e){let t="",s=n[e+1];for(;(s===" "||s==="	"||s===`
`||s==="\r")&&!(s==="\r"&&n[e+2]!==`
`);)s===`
`&&(t+=`
`),e+=1,s=n[e+1];return t||(t=" "),{fold:t,offset:e}}const Zd={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function eh(n,e,t,s){const r=n.substr(e,t),c=r.length===t&&/^[0-9a-fA-F]+$/.test(r)?parseInt(r,16):NaN;if(isNaN(c)){const f=n.substr(e-2,t+2);return s(e-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${f}`),f}return String.fromCodePoint(c)}function Zc(n,e,t,s){const{value:r,type:a,comment:c,range:f}=e.type==="block-scalar"?Wc(n,e,s):Qc(e,n.options.strict,s),h=t?n.directives.tagName(t.source,b=>s(t,"TAG_RESOLVE_FAILED",b)):null;let m;n.options.stringKeys&&n.atKey?m=n.schema[tt]:h?m=th(n.schema,r,h,t,s):e.type==="scalar"?m=nh(n,r,e,s):m=n.schema[tt];let _;try{const b=m.resolve(r,E=>s(t??e,"TAG_RESOLVE_FAILED",E),n.options);_=me(b)?b:new re(b)}catch(b){const E=b instanceof Error?b.message:String(b);s(t??e,"TAG_RESOLVE_FAILED",E),_=new re(r)}return _.range=f,_.source=r,a&&(_.type=a),h&&(_.tag=h),m.format&&(_.format=m.format),c&&(_.comment=c),_}function th(n,e,t,s,r){var f;if(t==="!")return n[tt];const a=[];for(const h of n.tags)if(!h.collection&&h.tag===t)if(h.default&&h.test)a.push(h);else return h;for(const h of a)if((f=h.test)!=null&&f.test(e))return h;const c=n.knownTags[t];return c&&!c.collection?(n.tags.push(Object.assign({},c,{default:!1,test:void 0})),c):(r(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${t}`,t!=="tag:yaml.org,2002:str"),n[tt])}function nh({atKey:n,directives:e,schema:t},s,r,a){const c=t.tags.find(f=>{var h;return(f.default===!0||n&&f.default==="key")&&((h=f.test)==null?void 0:h.test(s))})||t[tt];if(t.compat){const f=t.compat.find(h=>{var m;return h.default&&((m=h.test)==null?void 0:m.test(s))})??t[tt];if(c.tag!==f.tag){const h=e.tagString(c.tag),m=e.tagString(f.tag),_=`Value may be parsed as either ${h} or ${m}`;a(r,"TAG_RESOLVE_FAILED",_,!0)}}return c}function sh(n,e,t){if(e){t??(t=e.length);for(let s=t-1;s>=0;--s){let r=e[s];switch(r.type){case"space":case"comment":case"newline":n-=r.source.length;continue}for(r=e[++s];(r==null?void 0:r.type)==="space";)n+=r.source.length,r=e[++s];break}}return n}const ih={composeNode:el,composeEmptyNode:ya};function el(n,e,t,s){const r=n.atKey,{spaceBefore:a,comment:c,anchor:f,tag:h}=t;let m,_=!0;switch(e.type){case"alias":m=rh(n,e,s),(f||h)&&s(e,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":m=Zc(n,e,h,s),f&&(m.anchor=f.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":m=Vd(ih,n,e,t,s),f&&(m.anchor=f.source.substring(1));break;default:{const b=e.type==="error"?e.message:`Unsupported token (type: ${e.type})`;s(e,"UNEXPECTED_TOKEN",b),m=ya(n,e.offset,void 0,null,t,s),_=!1}}return f&&m.anchor===""&&s(f,"BAD_ALIAS","Anchor cannot be an empty string"),r&&n.options.stringKeys&&(!me(m)||typeof m.value!="string"||m.tag&&m.tag!=="tag:yaml.org,2002:str")&&s(h??e,"NON_STRING_KEY","With stringKeys, all keys must be strings"),a&&(m.spaceBefore=!0),c&&(e.type==="scalar"&&e.source===""?m.comment=c:m.commentBefore=c),n.options.keepSourceTokens&&_&&(m.srcToken=e),m}function ya(n,e,t,s,{spaceBefore:r,comment:a,anchor:c,tag:f,end:h},m){const _={type:"scalar",offset:sh(e,t,s),indent:-1,source:""},b=Zc(n,_,f,m);return c&&(b.anchor=c.source.substring(1),b.anchor===""&&m(c,"BAD_ALIAS","Anchor cannot be an empty string")),r&&(b.spaceBefore=!0),a&&(b.comment=a,b.range[2]=h),b}function rh({options:n},{offset:e,source:t,end:s},r){const a=new pi(t.substring(1));a.source===""&&r(e,"BAD_ALIAS","Alias cannot be an empty string"),a.source.endsWith(":")&&r(e+t.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const c=e+t.length,f=ls(s,c,n.strict,r);return a.range=[e,c,f.offset],f.comment&&(a.comment=f.comment),a}function ah(n,e,{offset:t,start:s,value:r,end:a},c){const f=Object.assign({_directives:e},n),h=new On(void 0,f),m={atKey:!1,atRoot:!0,directives:h.directives,options:h.options,schema:h.schema},_=En(s,{indicator:"doc-start",next:r??(a==null?void 0:a[0]),offset:t,onError:c,parentIndent:0,startOnNewline:!0});_.found&&(h.directives.docStart=!0,r&&(r.type==="block-map"||r.type==="block-seq")&&!_.hasNewline&&c(_.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),h.contents=r?el(m,r,_,c):ya(m,_.end,s,null,_,c);const b=h.contents.range[2],E=ls(a,b,!1,c);return E.comment&&(h.comment=E.comment),h.range=[t,b,E.offset],h}function Vn(n){if(typeof n=="number")return[n,n+1];if(Array.isArray(n))return n.length===2?n:[n[0],n[1]];const{offset:e,source:t}=n;return[e,e+(typeof t=="string"?t.length:1)]}function To(n){var r;let e="",t=!1,s=!1;for(let a=0;a<n.length;++a){const c=n[a];switch(c[0]){case"#":e+=(e===""?"":s?`

`:`
`)+(c.substring(1)||" "),t=!0,s=!1;break;case"%":((r=n[a+1])==null?void 0:r[0])!=="#"&&(a+=1),t=!1;break;default:t||(s=!0),t=!1}}return{comment:e,afterEmptyLine:s}}class ga{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(t,s,r,a)=>{const c=Vn(t);a?this.warnings.push(new Jc(c,s,r)):this.errors.push(new Ht(c,s,r))},this.directives=new Pe({version:e.version||"1.2"}),this.options=e}decorate(e,t){const{comment:s,afterEmptyLine:r}=To(this.prelude);if(s){const a=e.contents;if(t)e.comment=e.comment?`${e.comment}
${s}`:s;else if(r||e.directives.docStart||!a)e.commentBefore=s;else if(Se(a)&&!a.flow&&a.items.length>0){let c=a.items[0];we(c)&&(c=c.key);const f=c.commentBefore;c.commentBefore=f?`${s}
${f}`:s}else{const c=a.commentBefore;a.commentBefore=c?`${s}
${c}`:s}}t?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:To(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,t=!1,s=-1){for(const r of e)yield*this.next(r);yield*this.end(t,s)}*next(e){switch(e.type){case"directive":this.directives.add(e.source,(t,s,r)=>{const a=Vn(e);a[0]+=t,this.onError(a,"BAD_DIRECTIVE",s,r)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{const t=ah(this.options,this.directives,e,this.onError);this.atDirectives&&!t.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(t,!1),this.doc&&(yield this.doc),this.doc=t,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{const t=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,s=new Ht(Vn(e),"UNEXPECTED_TOKEN",t);this.atDirectives||!this.doc?this.errors.push(s):this.doc.errors.push(s);break}case"doc-end":{if(!this.doc){const s="Unexpected doc-end without preceding document";this.errors.push(new Ht(Vn(e),"UNEXPECTED_TOKEN",s));break}this.doc.directives.docEnd=!0;const t=ls(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),t.comment){const s=this.doc.comment;this.doc.comment=s?`${s}
${t.comment}`:t.comment}this.doc.range[2]=t.offset;break}default:this.errors.push(new Ht(Vn(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,t=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){const s=Object.assign({_directives:this.directives},this.options),r=new On(void 0,s);this.atDirectives&&this.onError(t,"MISSING_CHAR","Missing directives-end indicator line"),r.range=[0,t,t],this.decorate(r,!1),yield r}}}function oh(n,e=!0,t){if(n){const s=(r,a,c)=>{const f=typeof r=="number"?r:Array.isArray(r)?r[0]:r.offset;if(t)t(f,a,c);else throw new Ht([f,f+1],a,c)};switch(n.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return Qc(n,e,s);case"block-scalar":return Wc({options:{strict:e}},n,s)}}return null}function ch(n,e){const{implicitKey:t=!1,indent:s,inFlow:r=!1,offset:a=-1,type:c="PLAIN"}=e,f=os({type:c,value:n},{implicitKey:t,indent:s>0?" ".repeat(s):"",inFlow:r,options:{blockQuote:!0,lineWidth:-1}}),h=e.end??[{type:"newline",offset:-1,indent:s,source:`
`}];switch(f[0]){case"|":case">":{const m=f.indexOf(`
`),_=f.substring(0,m),b=f.substring(m+1)+`
`,E=[{type:"block-scalar-header",offset:a,indent:s,source:_}];return tl(E,h)||E.push({type:"newline",offset:-1,indent:s,source:`
`}),{type:"block-scalar",offset:a,indent:s,props:E,source:b}}case'"':return{type:"double-quoted-scalar",offset:a,indent:s,source:f,end:h};case"'":return{type:"single-quoted-scalar",offset:a,indent:s,source:f,end:h};default:return{type:"scalar",offset:a,indent:s,source:f,end:h}}}function lh(n,e,t={}){let{afterKey:s=!1,implicitKey:r=!1,inFlow:a=!1,type:c}=t,f="indent"in n?n.indent:null;if(s&&typeof f=="number"&&(f+=2),!c)switch(n.type){case"single-quoted-scalar":c="QUOTE_SINGLE";break;case"double-quoted-scalar":c="QUOTE_DOUBLE";break;case"block-scalar":{const m=n.props[0];if(m.type!=="block-scalar-header")throw new Error("Invalid block scalar header");c=m.source[0]===">"?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:c="PLAIN"}const h=os({type:c,value:e},{implicitKey:r||f===null,indent:f!==null&&f>0?" ".repeat(f):"",inFlow:a,options:{blockQuote:!0,lineWidth:-1}});switch(h[0]){case"|":case">":uh(n,h);break;case'"':Er(n,h,"double-quoted-scalar");break;case"'":Er(n,h,"single-quoted-scalar");break;default:Er(n,h,"scalar")}}function uh(n,e){const t=e.indexOf(`
`),s=e.substring(0,t),r=e.substring(t+1)+`
`;if(n.type==="block-scalar"){const a=n.props[0];if(a.type!=="block-scalar-header")throw new Error("Invalid block scalar header");a.source=s,n.source=r}else{const{offset:a}=n,c="indent"in n?n.indent:-1,f=[{type:"block-scalar-header",offset:a,indent:c,source:s}];tl(f,"end"in n?n.end:void 0)||f.push({type:"newline",offset:-1,indent:c,source:`
`});for(const h of Object.keys(n))h!=="type"&&h!=="offset"&&delete n[h];Object.assign(n,{type:"block-scalar",indent:c,props:f,source:r})}}function tl(n,e){if(e)for(const t of e)switch(t.type){case"space":case"comment":n.push(t);break;case"newline":return n.push(t),!0}return!1}function Er(n,e,t){switch(n.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":n.type=t,n.source=e;break;case"block-scalar":{const s=n.props.slice(1);let r=e.length;n.props[0].type==="block-scalar-header"&&(r-=n.props[0].source.length);for(const a of s)a.offset+=r;delete n.props,Object.assign(n,{type:t,source:e,end:s});break}case"block-map":case"block-seq":{const r={type:"newline",offset:n.offset+e.length,indent:n.indent,source:`
`};delete n.items,Object.assign(n,{type:t,source:e,end:[r]});break}default:{const s="indent"in n?n.indent:-1,r="end"in n&&Array.isArray(n.end)?n.end.filter(a=>a.type==="space"||a.type==="comment"||a.type==="newline"):[];for(const a of Object.keys(n))a!=="type"&&a!=="offset"&&delete n[a];Object.assign(n,{type:t,indent:s,source:e,end:r})}}}const fh=n=>"type"in n?fi(n):si(n);function fi(n){switch(n.type){case"block-scalar":{let e="";for(const t of n.props)e+=fi(t);return e+n.source}case"block-map":case"block-seq":{let e="";for(const t of n.items)e+=si(t);return e}case"flow-collection":{let e=n.start.source;for(const t of n.items)e+=si(t);for(const t of n.end)e+=t.source;return e}case"document":{let e=si(n);if(n.end)for(const t of n.end)e+=t.source;return e}default:{let e=n.source;if("end"in n&&n.end)for(const t of n.end)e+=t.source;return e}}}function si({start:n,key:e,sep:t,value:s}){let r="";for(const a of n)r+=a.source;if(e&&(r+=fi(e)),t)for(const a of t)r+=a.source;return s&&(r+=fi(s)),r}const Xr=Symbol("break visit"),dh=Symbol("skip children"),nl=Symbol("remove item");function zt(n,e){"type"in n&&n.type==="document"&&(n={start:n.start,value:n.value}),sl(Object.freeze([]),n,e)}zt.BREAK=Xr;zt.SKIP=dh;zt.REMOVE=nl;zt.itemAtPath=(n,e)=>{let t=n;for(const[s,r]of e){const a=t==null?void 0:t[s];if(a&&"items"in a)t=a.items[r];else return}return t};zt.parentCollection=(n,e)=>{const t=zt.itemAtPath(n,e.slice(0,-1)),s=e[e.length-1][0],r=t==null?void 0:t[s];if(r&&"items"in r)return r;throw new Error("Parent collection not found")};function sl(n,e,t){let s=t(e,n);if(typeof s=="symbol")return s;for(const r of["key","value"]){const a=e[r];if(a&&"items"in a){for(let c=0;c<a.items.length;++c){const f=sl(Object.freeze(n.concat([[r,c]])),a.items[c],t);if(typeof f=="number")c=f-1;else{if(f===Xr)return Xr;f===nl&&(a.items.splice(c,1),c-=1)}}typeof s=="function"&&r==="key"&&(s=s(e,n))}}return typeof s=="function"?s(e,n):s}const Ii="\uFEFF",_i="",Ai="",rs="",hh=n=>!!n&&"items"in n,ph=n=>!!n&&(n.type==="scalar"||n.type==="single-quoted-scalar"||n.type==="double-quoted-scalar"||n.type==="block-scalar");function mh(n){switch(n){case Ii:return"<BOM>";case _i:return"<DOC>";case Ai:return"<FLOW_END>";case rs:return"<SCALAR>";default:return JSON.stringify(n)}}function il(n){switch(n){case Ii:return"byte-order-mark";case _i:return"doc-mode";case Ai:return"flow-error-end";case rs:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(n[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}const yh=Object.freeze(Object.defineProperty({__proto__:null,BOM:Ii,DOCUMENT:_i,FLOW_END:Ai,SCALAR:rs,createScalarToken:ch,isCollection:hh,isScalar:ph,prettyToken:mh,resolveAsScalar:oh,setScalarValue:lh,stringify:fh,tokenType:il,visit:zt},Symbol.toStringTag,{value:"Module"}));function Ye(n){switch(n){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}const Lo=new Set("0123456789ABCDEFabcdef"),gh=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),Us=new Set(",[]{}"),vh=new Set(` ,[]{}
\r	`),Ir=n=>!n||vh.has(n);class rl{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,t=!1){if(e){if(typeof e!="string")throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null}this.atEnd=!t;let s=this.next??"stream";for(;s&&(t||this.hasChars(1));)s=yield*this.parseNext(s)}atLineEnd(){let e=this.pos,t=this.buffer[e];for(;t===" "||t==="	";)t=this.buffer[++e];return!t||t==="#"||t===`
`?!0:t==="\r"?this.buffer[e+1]===`
`:!1}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let t=this.buffer[e];if(this.indentNext>0){let s=0;for(;t===" ";)t=this.buffer[++s+e];if(t==="\r"){const r=this.buffer[s+e+1];if(r===`
`||!r&&!this.atEnd)return e+s+1}return t===`
`||s>=this.indentNext||!t&&!this.atEnd?e+s:-1}if(t==="-"||t==="."){const s=this.buffer.substr(e,3);if((s==="---"||s==="...")&&Ye(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return(typeof e!="number"||e!==-1&&e<this.pos)&&(e=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=e),e===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[e-1]==="\r"&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(e===null)return this.setNext("stream");if(e[0]===Ii&&(yield*this.pushCount(1),e=e.substring(1)),e[0]==="%"){let t=e.length,s=e.indexOf("#");for(;s!==-1;){const a=e[s-1];if(a===" "||a==="	"){t=s-1;break}else s=e.indexOf("#",s+1)}for(;;){const a=e[t-1];if(a===" "||a==="	")t-=1;else break}const r=(yield*this.pushCount(t))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-r),this.pushNewline(),"stream"}if(this.atLineEnd()){const t=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-t),yield*this.pushNewline(),"stream"}return yield _i,yield*this.parseLineStart()}*parseLineStart(){const e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if(e==="-"||e==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const t=this.peek(3);if((t==="---"||t==="...")&&Ye(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,t==="---"?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!Ye(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[e,t]=this.peek(2);if(!t&&!this.atEnd)return this.setNext("block-start");if((e==="-"||e==="?"||e===":")&&Ye(t)){const s=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=s,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const e=this.getLine();if(e===null)return this.setNext("doc");let t=yield*this.pushIndicators();switch(e[t]){case"#":yield*this.pushCount(e.length-t);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(Ir),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return t+=yield*this.parseBlockScalarHeader(),t+=yield*this.pushSpaces(!0),yield*this.pushCount(e.length-t),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,t,s=-1;do e=yield*this.pushNewline(),e>0?(t=yield*this.pushSpaces(!1),this.indentValue=s=t):t=0,t+=yield*this.pushSpaces(!0);while(e+t>0);const r=this.getLine();if(r===null)return this.setNext("flow");if((s!==-1&&s<this.indentNext&&r[0]!=="#"||s===0&&(r.startsWith("---")||r.startsWith("..."))&&Ye(r[3]))&&!(s===this.indentNext-1&&this.flowLevel===1&&(r[0]==="]"||r[0]==="}")))return this.flowLevel=0,yield Ai,yield*this.parseLineStart();let a=0;for(;r[a]===",";)a+=yield*this.pushCount(1),a+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(a+=yield*this.pushIndicators(),r[a]){case void 0:return"flow";case"#":return yield*this.pushCount(r.length-a),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(Ir),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const c=this.charAt(1);if(this.flowKey||Ye(c)||c===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const e=this.charAt(0);let t=this.buffer.indexOf(e,this.pos+1);if(e==="'")for(;t!==-1&&this.buffer[t+1]==="'";)t=this.buffer.indexOf("'",t+2);else for(;t!==-1;){let a=0;for(;this.buffer[t-1-a]==="\\";)a+=1;if(a%2===0)break;t=this.buffer.indexOf('"',t+1)}const s=this.buffer.substring(0,t);let r=s.indexOf(`
`,this.pos);if(r!==-1){for(;r!==-1;){const a=this.continueScalar(r+1);if(a===-1)break;r=s.indexOf(`
`,a)}r!==-1&&(t=r-(s[r-1]==="\r"?2:1))}if(t===-1){if(!this.atEnd)return this.setNext("quoted-scalar");t=this.buffer.length}return yield*this.pushToIndex(t+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){const t=this.buffer[++e];if(t==="+")this.blockScalarKeep=!0;else if(t>"0"&&t<="9")this.blockScalarIndent=Number(t)-1;else if(t!=="-")break}return yield*this.pushUntil(t=>Ye(t)||t==="#")}*parseBlockScalar(){let e=this.pos-1,t=0,s;e:for(let a=this.pos;s=this.buffer[a];++a)switch(s){case" ":t+=1;break;case`
`:e=a,t=0;break;case"\r":{const c=this.buffer[a+1];if(!c&&!this.atEnd)return this.setNext("block-scalar");if(c===`
`)break}default:break e}if(!s&&!this.atEnd)return this.setNext("block-scalar");if(t>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=t:this.indentNext=this.blockScalarIndent+(this.indentNext===0?1:this.indentNext);do{const a=this.continueScalar(e+1);if(a===-1)break;e=this.buffer.indexOf(`
`,a)}while(e!==-1);if(e===-1){if(!this.atEnd)return this.setNext("block-scalar");e=this.buffer.length}}let r=e+1;for(s=this.buffer[r];s===" ";)s=this.buffer[++r];if(s==="	"){for(;s==="	"||s===" "||s==="\r"||s===`
`;)s=this.buffer[++r];e=r-1}else if(!this.blockScalarKeep)do{let a=e-1,c=this.buffer[a];c==="\r"&&(c=this.buffer[--a]);const f=a;for(;c===" ";)c=this.buffer[--a];if(c===`
`&&a>=this.pos&&a+1+t>f)e=a;else break}while(!0);return yield rs,yield*this.pushToIndex(e+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const e=this.flowLevel>0;let t=this.pos-1,s=this.pos-1,r;for(;r=this.buffer[++s];)if(r===":"){const a=this.buffer[s+1];if(Ye(a)||e&&Us.has(a))break;t=s}else if(Ye(r)){let a=this.buffer[s+1];if(r==="\r"&&(a===`
`?(s+=1,r=`
`,a=this.buffer[s+1]):t=s),a==="#"||e&&Us.has(a))break;if(r===`
`){const c=this.continueScalar(s+1);if(c===-1)break;s=Math.max(s,c-2)}}else{if(e&&Us.has(r))break;t=s}return!r&&!this.atEnd?this.setNext("plain-scalar"):(yield rs,yield*this.pushToIndex(t+1,!0),e?"flow":"doc")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,t){const s=this.buffer.slice(this.pos,e);return s?(yield s,this.pos+=s.length,s.length):(t&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(Ir))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const e=this.flowLevel>0,t=this.charAt(1);if(Ye(t)||e&&Us.has(t))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let e=this.pos+2,t=this.buffer[e];for(;!Ye(t)&&t!==">";)t=this.buffer[++e];return yield*this.pushToIndex(t===">"?e+1:e,!1)}else{let e=this.pos+1,t=this.buffer[e];for(;t;)if(gh.has(t))t=this.buffer[++e];else if(t==="%"&&Lo.has(this.buffer[e+1])&&Lo.has(this.buffer[e+2]))t=this.buffer[e+=3];else break;return yield*this.pushToIndex(e,!1)}}*pushNewline(){const e=this.buffer[this.pos];return e===`
`?yield*this.pushCount(1):e==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(e){let t=this.pos-1,s;do s=this.buffer[++t];while(s===" "||e&&s==="	");const r=t-this.pos;return r>0&&(yield this.buffer.substr(this.pos,r),this.pos=t),r}*pushUntil(e){let t=this.pos,s=this.buffer[t];for(;!e(s);)s=this.buffer[++t];return yield*this.pushToIndex(t,!1)}}class al{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let t=0,s=this.lineStarts.length;for(;t<s;){const a=t+s>>1;this.lineStarts[a]<e?t=a+1:s=a}if(this.lineStarts[t]===e)return{line:t+1,col:1};if(t===0)return{line:0,col:e};const r=this.lineStarts[t-1];return{line:t,col:e-r+1}}}}function St(n,e){for(let t=0;t<n.length;++t)if(n[t].type===e)return!0;return!1}function Co(n){for(let e=0;e<n.length;++e)switch(n[e].type){case"space":case"comment":case"newline":break;default:return e}return-1}function ol(n){switch(n==null?void 0:n.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function zs(n){switch(n.type){case"document":return n.start;case"block-map":{const e=n.items[n.items.length-1];return e.sep??e.start}case"block-seq":return n.items[n.items.length-1].start;default:return[]}}function ln(n){var t;if(n.length===0)return[];let e=n.length;e:for(;--e>=0;)switch(n[e].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;((t=n[++e])==null?void 0:t.type)==="space";);return n.splice(e,n.length)}function Oo(n){if(n.start.type==="flow-seq-start")for(const e of n.items)e.sep&&!e.value&&!St(e.start,"explicit-key-ind")&&!St(e.sep,"map-value-ind")&&(e.key&&(e.value=e.key),delete e.key,ol(e.value)?e.value.end?Array.prototype.push.apply(e.value.end,e.sep):e.value.end=e.sep:Array.prototype.push.apply(e.start,e.sep),delete e.sep)}class va{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new rl,this.onNewLine=e}*parse(e,t=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(const s of this.lexer.lex(e,t))yield*this.next(s);t||(yield*this.end())}*next(e){if(this.source=e,this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=e.length;return}const t=il(e);if(t)if(t==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=t,yield*this.step(),t){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&e[0]===" "&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{const s=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:s,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const e=this.peek(1);if(this.type==="doc-end"&&(!e||e.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}peek(e){return this.stack[this.stack.length-e]}*pop(e){const t=e??this.stack.pop();if(!t)yield{type:"error",offset:this.offset,source:"",message:"Tried to pop an empty stack"};else if(this.stack.length===0)yield t;else{const s=this.peek(1);switch(t.type==="block-scalar"?t.indent="indent"in s?s.indent:0:t.type==="flow-collection"&&s.type==="document"&&(t.indent=0),t.type==="flow-collection"&&Oo(t),s.type){case"document":s.value=t;break;case"block-scalar":s.props.push(t);break;case"block-map":{const r=s.items[s.items.length-1];if(r.value){s.items.push({start:[],key:t,sep:[]}),this.onKeyLine=!0;return}else if(r.sep)r.value=t;else{Object.assign(r,{key:t,sep:[]}),this.onKeyLine=!r.explicitKey;return}break}case"block-seq":{const r=s.items[s.items.length-1];r.value?s.items.push({start:[],value:t}):r.value=t;break}case"flow-collection":{const r=s.items[s.items.length-1];!r||r.value?s.items.push({start:[],key:t,sep:[]}):r.sep?r.value=t:Object.assign(r,{key:t,sep:[]});return}default:yield*this.pop(),yield*this.pop(t)}if((s.type==="document"||s.type==="block-map"||s.type==="block-seq")&&(t.type==="block-map"||t.type==="block-seq")){const r=t.items[t.items.length-1];r&&!r.sep&&!r.value&&r.start.length>0&&Co(r.start)===-1&&(t.indent===0||r.start.every(a=>a.type!=="comment"||a.indent<t.indent))&&(s.type==="document"?s.end=r.start:s.items.push({start:r.start}),t.items.splice(-1,1))}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{const e={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&e.start.push(this.sourceToken),this.stack.push(e);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":{Co(e.start)!==-1?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":e.start.push(this.sourceToken);return}const t=this.startBlockValue(e);t?this.stack.push(t):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if(this.type==="map-value-ind"){const t=zs(this.peek(2)),s=ln(t);let r;e.end?(r=e.end,r.push(this.sourceToken),delete e.end):r=[this.sourceToken];const a={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:s,key:e,sep:r}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=a}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":e.props.push(this.sourceToken);return;case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,t.value){const r="end"in t.value?t.value.end:void 0,a=Array.isArray(r)?r[r.length-1]:void 0;(a==null?void 0:a.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else if(t.sep)t.sep.push(this.sourceToken);else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],a=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return}if(this.indent>=e.indent){const r=!this.onKeyLine&&this.indent===e.indent,a=r&&(t.sep||t.explicitKey)&&this.type!=="seq-item-ind";let c=[];if(a&&t.sep&&!t.value){const f=[];for(let h=0;h<t.sep.length;++h){const m=t.sep[h];switch(m.type){case"newline":f.push(h);break;case"space":break;case"comment":m.indent>e.indent&&(f.length=0);break;default:f.length=0}}f.length>=2&&(c=t.sep.splice(f[1]))}switch(this.type){case"anchor":case"tag":a||t.value?(c.push(this.sourceToken),e.items.push({start:c}),this.onKeyLine=!0):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"explicit-key-ind":!t.sep&&!t.explicitKey?(t.start.push(this.sourceToken),t.explicitKey=!0):a||t.value?(c.push(this.sourceToken),e.items.push({start:c,explicitKey:!0})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken],explicitKey:!0}]}),this.onKeyLine=!0;return;case"map-value-ind":if(t.explicitKey)if(t.sep)if(t.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(St(t.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:c,key:null,sep:[this.sourceToken]}]});else if(ol(t.key)&&!St(t.sep,"newline")){const f=ln(t.start),h=t.key,m=t.sep;m.push(this.sourceToken),delete t.key,delete t.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:f,key:h,sep:m}]})}else c.length>0?t.sep=t.sep.concat(c,this.sourceToken):t.sep.push(this.sourceToken);else if(St(t.start,"newline"))Object.assign(t,{key:null,sep:[this.sourceToken]});else{const f=ln(t.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:f,key:null,sep:[this.sourceToken]}]})}else t.sep?t.value||a?e.items.push({start:c,key:null,sep:[this.sourceToken]}):St(t.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const f=this.flowScalar(this.type);a||t.value?(e.items.push({start:c,key:f,sep:[]}),this.onKeyLine=!0):t.sep?this.stack.push(f):(Object.assign(t,{key:f,sep:[]}),this.onKeyLine=!0);return}default:{const f=this.startBlockValue(e);if(f){if(f.type==="block-seq"){if(!t.explicitKey&&t.sep&&!St(t.sep,"newline")){yield*this.pop({type:"error",offset:this.offset,message:"Unexpected block-seq-ind on same line with key",source:this.source});return}}else r&&e.items.push({start:c});this.stack.push(f);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(t.value){const r="end"in t.value?t.value.end:void 0,a=Array.isArray(r)?r[r.length-1]:void 0;(a==null?void 0:a.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],a=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return;case"anchor":case"tag":if(t.value||this.indent<=e.indent)break;t.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==e.indent)break;t.value||St(t.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return}if(this.indent>e.indent){const r=this.startBlockValue(e);if(r){this.stack.push(r);return}}yield*this.pop(),yield*this.step()}*flowCollection(e){const t=e.items[e.items.length-1];if(this.type==="flow-error-end"){let s;do yield*this.pop(),s=this.peek(1);while(s&&s.type==="flow-collection")}else if(e.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!t||t.sep?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return;case"map-value-ind":!t||t.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!t||t.value?e.items.push({start:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const r=this.flowScalar(this.type);!t||t.value?e.items.push({start:[],key:r,sep:[]}):t.sep?this.stack.push(r):Object.assign(t,{key:r,sep:[]});return}case"flow-map-end":case"flow-seq-end":e.end.push(this.sourceToken);return}const s=this.startBlockValue(e);s?this.stack.push(s):(yield*this.pop(),yield*this.step())}else{const s=this.peek(2);if(s.type==="block-map"&&(this.type==="map-value-ind"&&s.indent===e.indent||this.type==="newline"&&!s.items[s.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&s.type!=="flow-collection"){const r=zs(s),a=ln(r);Oo(e);const c=e.end.splice(1,e.end.length);c.push(this.sourceToken);const f={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:a,key:e,sep:c}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=f}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const t=zs(e),s=ln(t);return s.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,explicitKey:!0}]}}case"map-value-ind":{this.onKeyLine=!0;const t=zs(e),s=ln(t);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,t){return this.type!=="comment"||this.indent<=t?!1:e.every(s=>s.type==="newline"||s.type==="space")}*documentEnd(e){this.type!=="doc-mode"&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;case"space":case"comment":default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}}function cl(n){const e=n.prettyErrors!==!1;return{lineCounter:n.lineCounter||e&&new al||null,prettyErrors:e}}function bh(n,e={}){const{lineCounter:t,prettyErrors:s}=cl(e),r=new va(t==null?void 0:t.addNewLine),a=new ga(e),c=Array.from(a.compose(r.parse(n)));if(s&&t)for(const f of c)f.errors.forEach(ui(n,t)),f.warnings.forEach(ui(n,t));return c.length>0?c:Object.assign([],{empty:!0},a.streamInfo())}function ll(n,e={}){const{lineCounter:t,prettyErrors:s}=cl(e),r=new va(t==null?void 0:t.addNewLine),a=new ga(e);let c=null;for(const f of a.compose(r.parse(n),!0,n.length))if(!c)c=f;else if(c.options.logLevel!=="silent"){c.errors.push(new Ht(f.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return s&&t&&(c.errors.forEach(ui(n,t)),c.warnings.forEach(ui(n,t))),c}function wh(n,e,t){let s;typeof e=="function"?s=e:t===void 0&&e&&typeof e=="object"&&(t=e);const r=ll(n,t);if(!r)return null;if(r.warnings.forEach(a=>Cc(r.options.logLevel,a)),r.errors.length>0){if(r.options.logLevel!=="silent")throw r.errors[0];r.errors=[]}return r.toJS(Object.assign({reviver:s},t))}function Sh(n,e,t){let s=null;if(typeof e=="function"||Array.isArray(e)?s=e:t===void 0&&e&&(t=e),typeof t=="string"&&(t=t.length),typeof t=="number"){const r=Math.round(t);t=r<1?void 0:r>8?{indent:8}:{indent:r}}if(n===void 0){const{keepUndefined:r}=t??e??{};if(!r)return}return Yt(n)&&!s?n.toString(t):new On(n,s,t).toString(t)}const kh=Object.freeze(Object.defineProperty({__proto__:null,Alias:pi,CST:yh,Composer:ga,Document:On,Lexer:rl,LineCounter:al,Pair:xe,Parser:va,Scalar:re,Schema:Ei,YAMLError:ma,YAMLMap:Fe,YAMLParseError:Ht,YAMLSeq:It,YAMLWarning:Jc,isAlias:At,isCollection:Se,isDocument:Yt,isMap:An,isNode:ke,isPair:we,isScalar:me,isSeq:Tn,parse:wh,parseAllDocuments:bh,parseDocument:ll,stringify:Sh,visit:Jt,visitAsync:hi},Symbol.toStringTag,{value:"Module"}));class Eh{constructor(){this.mistakes=[],this.taxonomy={}}async initialize(){this.mistakes=await iu(),this._buildTaxonomy(),console.log(`MistakeManager initialized with ${this.mistakes.length} mistakes.`)}async loadFromYAML(e){try{const t=kh.parse(e);if(!t.subject||!t.mistakes)throw new Error("YAML must contain 'subject' and 'mistakes' keys.");const s=t.mistakes.map(a=>this._normalizeMistake(a,t.subject)),r=new Map(this.mistakes.map(a=>[a.uuid,a]));return s.forEach(a=>r.set(a.uuid,a)),this.mistakes=Array.from(r.values()),await ru(this.mistakes),this._buildTaxonomy(),{success:!0,count:s.length}}catch(t){return console.error("Failed to load from YAML:",t),{success:!1,error:t.message}}}_normalizeMistake(e,t){if(e.simple_problem){const r=e.simple_problem;return{uuid:crypto.randomUUID(),title:r.problem.substring(0,30)+(r.problem.length>30?"...":""),problem:r.problem,attachments:[],my_answer:{content:""},correct_answer:{content:r.answer,explanation:""},analysis:{reason_for_error:"知识点模糊",difficulty:r.difficulty||3},tags:r.tags||[],subject:t,is_simple:!0,review:{due:Date.now(),interval:0,easeFactor:2.5,state:"new"}}}const s={...e,subject:t};return s.review||(s.review={due:Date.now(),interval:0,easeFactor:2.5,state:"new"}),s.uuid||(s.uuid=crypto.randomUUID()),s}_buildTaxonomy(){const e={};this.mistakes.forEach(t=>{var s,r;t.subject&&(e[t.subject]||(e[t.subject]={tags:new Set,reasons:new Set}),(s=t.tags)==null||s.forEach(a=>e[t.subject].tags.add(a)),(r=t.analysis)!=null&&r.reason_for_error&&e[t.subject].reasons.add(t.analysis.reason_for_error))}),this.taxonomy=e}getFilteredMistakes(e={}){const{subject:t="all",tags:s=[],reasons:r=[]}=e;return this.mistakes.filter(a=>{var c;return!(t!=="all"&&a.subject!==t||s.length>0&&!s.every(f=>{var h;return(h=a.tags)==null?void 0:h.includes(f)})||r.length>0&&!r.includes((c=a.analysis)==null?void 0:c.reason_for_error))}).sort((a,c)=>a.review.due-c.review.due)}async updateReviewStatus(e,t){const s=this.mistakes.find(a=>a.uuid===e);if(!s)return null;const r=Fo(s.review,t);return s.review={...s.review,...r},s.lastReviewed=Date.now(),await au(s),s}getTaxonomy(){return this.taxonomy}}class Ih{constructor(){this.elements={subjectFilter:document.getElementById("subject-filter"),tagFilterContainer:document.querySelector('.filter-group[data-type="tags"] .tag-list'),reasonFilterContainer:document.querySelector('.filter-group[data-type="reasons"] .tag-list'),listContainer:document.querySelector("#mistakes-list"),previewContainer:document.getElementById("mistakes-preview"),paginationContainer:document.querySelector(".pagination"),statsContainer:document.getElementById("statistics-dashboard")}}renderFilters(e,t){this.elements.subjectFilter.innerHTML='<option value="all">所有科目</option>',Object.keys(e).sort().forEach(r=>{const a=new Option(r,r);a.selected=r===t,this.elements.subjectFilter.add(a)});const s=e[t]||{tags:new Set,reasons:new Set};this._renderFilterAccordion(this.elements.tagFilterContainer,"知识点标签",Array.from(s.tags).sort()),this._renderFilterAccordion(this.elements.reasonFilterContainer,"错误原因",Array.from(s.reasons).sort())}_renderFilterAccordion(e,t,s){e.innerHTML=`
            <details class="filter-accordion-item" open>
                <summary>
                    <span><i class="fas fa-tags"></i> ${t}</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </summary>
                <div class="tag-list-content">
                    ${s.map(r=>`<div class="tag" data-value="${r}">${r}</div>`).join("")}
                </div>
            </details>
        `}_renderFilterItems(e,t){e.innerHTML="",t.forEach(s=>{const r=document.createElement("div");r.className="tag",r.textContent=s,r.dataset.value=s,e.appendChild(r)})}renderMistakeList(e){const t=this.elements.listContainer;if(t.innerHTML="",e.length===0){t.innerHTML=`
                <li class="session-item-placeholder">
                    <i class="fas fa-check-circle"></i>
                    <p>没有符合条件的错题</p>
                    <span>尝试放宽筛选条件或导入新的错题。</span>
                </li>
            `;return}e.forEach(s=>{const r=document.createElement("li");r.className="session-item",r.dataset.id=s.uuid;const{className:a,text:c}=this._getDueDateStatus(s.review.due);r.innerHTML=`
                <div class="item-icon-wrapper">
                    <i class="fas fa-book-medical item-icon"></i>
                </div>
                <div class="item-content">
                    <div class="item-title">${s.title}</div>
                    <div class="item-meta">
                        <span class="meta-info ${a}">${c}</span>
                        <span class="meta-info">${s.subject||"未分类"}</span>
                    </div>
                </div>
            `,t.appendChild(r)})}_getDueDateStatus(e){const t=new Date(e),s=new Date;t.setHours(0,0,0,0),s.setHours(0,0,0,0);const r=t.getTime()-s.getTime(),a=Math.ceil(r/(1e3*60*60*24));return a<0?{className:"status-overdue",text:`过期${Math.abs(a)}天`}:a===0?{className:"status-today",text:"今天"}:a===1?{className:"status-soon",text:"明天"}:{className:"status-future",text:`${a}天后`}}setActiveListItem(e){if(this.elements.listContainer.querySelectorAll(".mistake-list-item.active").forEach(t=>t.classList.remove("active")),e){const t=this.elements.listContainer.querySelector(`.mistake-list-item[data-id="${e}"]`);t==null||t.classList.add("active")}}renderMistakePreview(e){this.elements.previewContainer.innerHTML="",e.forEach(t=>{const s=this._createMistakeCard(t);this.elements.previewContainer.appendChild(s)})}_createMistakeCard(e){var s,r,a,c,f;const t=document.createElement("div");return t.className="mistake-card",t.dataset.id=e.uuid,t.innerHTML=`
            <div class="problem-section">
                <div class="problem-header">
                    <h4>${e.title}</h4>
                    <div class="problem-meta">
                        <span class="meta-item reason">原因: ${e.analysis.reason_for_error}</span>
                        <span class="meta-item difficulty">难度: ${"★".repeat(e.analysis.difficulty)}${"☆".repeat(5-e.analysis.difficulty)}</span>
                    </div>
                </div>
                <div class="problem-content">${mr.parse(e.problem||"")}</div>
                ${((s=e.attachments)==null?void 0:s.map(h=>this._renderAttachment(h)).join(""))||""}
                <div class="problem-tags">
                    ${((r=e.tags)==null?void 0:r.map(h=>`<span class="tag">${h}</span>`).join(""))||""}
                </div>
                <div class="my-answer-preview"><strong>我的答案:</strong> ${((a=e.my_answer)==null?void 0:a.content)||"未作答"}</div>
                <button class="show-answer-btn">显示答案</button>
            </div>

            <div class="answer-section hidden">
                <div class="correct-answer">
                    <strong>正确答案:</strong>
                    <div class="content">${mr.parse(((c=e.correct_answer)==null?void 0:c.content)||"")}</div>
                </div>
                <div class="correct-explanation">
                    <strong>解析:</strong>
                    <div class="content">${mr.parse(((f=e.correct_answer)==null?void 0:f.explanation)||"")}</div>
                </div>
                <div class="review-actions">
                    <button class="review-btn redo" data-rating="0">重做 (10m)</button>
                    <button class="review-btn hard" data-rating="1">困难</button>
                    <button class="review-btn medium" data-rating="2">犹豫</button>
                    <button class="review-btn easy" data-rating="3">简单</button>
                </div>
            </div>
        `,t}_renderAttachment(e){return e.type==="image"?`<img src="${e.url}" alt="错题附件" class="problem-image">`:""}_formatDueDate(e){const t=new Date(e),s=new Date;s.setHours(0,0,0,0);const r=Math.ceil((t-s)/(1e3*60*60*24));return r===0?"今天":r===1?"明天":r>1&&r<7?`${r}天后`:r<0?`${Math.abs(r)}天前`:t.toLocaleDateString()}toggleAnswer(e,t){const s=e.querySelector(".answer-section"),r=e.querySelector(".show-answer-btn");t?(s.classList.remove("hidden"),r.classList.add("hidden")):(s.classList.add("hidden"),r.classList.remove("hidden"))}updateCardAfterReview(e,t,s){s!==3&&this.toggleAnswer(e,!1),e.querySelector(".review-actions").insertAdjacentHTML("afterend",'<div class="update-feedback">已更新!</div>'),setTimeout(()=>{var a;(a=e.querySelector(".update-feedback"))==null||a.remove()},1500)}updateListItem(e,t){const s=this.elements.listContainer.querySelector(`[data-id="${e}"]`);s&&(s.querySelector(".mistake-due-date").textContent=`复习: ${this._formatDueDate(t.review.due)}`)}renderPagination(e,t,s){this.elements.paginationContainer.innerHTML="";const r=Math.ceil(e/s);if(!(r<=1))for(let a=1;a<=r;a++){const c=document.createElement("button");c.className="page-btn",c.textContent=a,c.dataset.page=a,a===t&&c.classList.add("active"),this.elements.paginationContainer.appendChild(c)}}}const Ce=n=>document.getElementById(n),Ti=n=>document.querySelector(n);Ce("mistakes-view");const No=Ti("#mistakes-view .session-sidebar"),_r=Ce("subject-filter"),Vs=Ti('#mistakes-view .filter-group[data-type="tags"] .tag-list'),Ys=Ti('#mistakes-view .filter-group[data-type="reasons"] .tag-list'),Ar=Ce("mistakes-list"),Tr=Ti("#mistakes-view .pagination"),Js=Ce("mistakes-preview"),$o=Ce("mistake-editor-panel"),bt=Ce("yaml-editor"),Gs=Ce("mistakeToggleSessionBtn"),Yn=Ce("mistakeSaveBtn"),Lr=Ce("mistakeExportBtn"),Jn=Ce("mistakeCollapseBtn"),Cr=Ce("refresh-mistakes-btn"),Or=Ce("load-yaml-btn"),Ws=Ce("yaml-file-input"),Nr=Ce("newMistakeFileBtn"),$r=Ce("mistakeStartReviewBtn"),xr=Ce("mistakeReviewOptionsBtn"),xo=Ce("mistakeReviewDropdownMenu");class _h{constructor(e,t,s){this.manager=e,this.ui=t,this.stats=s,this.filters={subject:"all",tags:[],reasons:[]},this.currentPage=1,this.pageSize=5,this.previewDebounceTimer=null}init(){Nr==null||Nr.addEventListener("click",this._handleNewMistakeFile.bind(this)),Gs==null||Gs.addEventListener("click",this._handleToggleSidebar.bind(this)),Yn==null||Yn.addEventListener("click",this._handleSaveFromYaml.bind(this)),Lr==null||Lr.addEventListener("click",this._handleExportToYaml.bind(this)),Jn==null||Jn.addEventListener("click",this._handleCollapseEditor.bind(this)),Cr==null||Cr.addEventListener("click",this.refreshView.bind(this)),Or==null||Or.addEventListener("click",()=>Ws.click()),Ws==null||Ws.addEventListener("change",this._handleFileLoad.bind(this)),bt==null||bt.addEventListener("input",this._handleEditorInput.bind(this)),_r==null||_r.addEventListener("change",this._handleSubjectChange.bind(this)),Vs==null||Vs.addEventListener("click",this._handleFilterTagClick.bind(this,"tags")),Ys==null||Ys.addEventListener("click",this._handleFilterTagClick.bind(this,"reasons")),Ar==null||Ar.addEventListener("click",this._handleMistakeListClick.bind(this)),Js==null||Js.addEventListener("click",this._handlePreviewClick.bind(this)),Tr==null||Tr.addEventListener("click",this._handlePaginationClick.bind(this)),$r==null||$r.addEventListener("click",()=>alert("错题本复习功能待实现！")),xr==null||xr.addEventListener("click",()=>xo.style.display=xo.style.display==="none"?"block":"none"),this.refreshView()}async refreshView(){var f;const e=this.stats.getDashboardHtml(this.manager.mistakes),t=document.querySelector("#mistakes-preview-panel .panel-header");(f=t.querySelector(".stats-dashboard-inline"))==null||f.remove(),t.insertAdjacentHTML("afterend",`<div class="stats-dashboard-inline">${e}</div>`);const s=this.manager.getFilteredMistakes(this.filters),r=(this.currentPage-1)*this.pageSize,a=r+this.pageSize,c=s.slice(r,a);this.ui.renderMistakeList(c),this.ui.renderMistakePreview(c),this.ui.renderPagination(s.length,this.currentPage,this.pageSize)}_handleToggleSidebar(){No.classList.toggle("hidden-session");const e=No.classList.contains("hidden-session");Gs.innerHTML=e?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}_handleNewMistakeFile(){const e=prompt("请输入新错题文件的标题:","未命名错题集");if(!e||e.trim()==="")return;const t=`
mistakes:
  - title: "二次函数图像与系数关系"
    problem: |
      已知二次函数 $y = ax^2 + bx + c$ 的图像如图所示，下列结论中正确的是？
      A. $a > 0, c > 0$
      B. $b^2 - 4ac < 0$
      C. $a - b + c > 0$
      D. $abc > 0$
    attachments:
      - type: image
        url: "function_graph.png"
    my_answer:
      content: "A"
    correct_answer:
      content: "C"
      explanation: |
        1. **开口方向**: 图像开口向上, $a > 0$
        2. **对称轴**: $x = -b/2a < 0$ → $b > 0$
        3. **与y轴交点**: $c < 0$
        4. **特殊点**: $x = -1$ 时, $y > 0$ → $a - b + c > 0$
    analysis:
      reason_for_error: "概念混淆"
      difficulty: 3
    tags: ["二次函数", "图像分析"]

  
  # 简易模式错题
  - simple_problem:
    - problem: "二次函数的定义是什么？"
      answer: "形如 y = ax^2 + bx + c (a≠0) 的函数"
      difficulty: 2
      tags: ["简易","二次函数", "定义"]
`.trim();bt.value=t,bt.focus()}async _handleSaveFromYaml(){const e=bt.value,t=await this.manager.loadFromYAML(e);t.success?(Yn.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>Yn.innerHTML='<i class="fas fa-save"></i>',2e3),this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()):alert(`保存失败: ${t.error}`)}_handleExportToYaml(){const e=bt.value,t=new Blob([e],{type:"text/yaml;charset=utf-8"});let s="mistake-export.yml";try{const a=e.match(/title:\s*["']?(.*?)["']?\s*\n/);a&&a[1]&&(s=`${a[1].replace(/[\/\\?%*:|"<>]/g,"-")}.yml`)}catch{}const r=document.createElement("a");r.href=URL.createObjectURL(t),r.download=s,r.click(),URL.revokeObjectURL(r.href)}_handleCollapseEditor(){$o.classList.toggle("collapsed");const e=$o.classList.contains("collapsed"),t=Jn.querySelector("i");t.className=e?"fas fa-chevron-down":"fas fa-chevron-up",Jn.title=e?"展开编辑器":"收起编辑器",e&&this._handleSaveFromYaml()}_handleEditorInput(){clearTimeout(this.previewDebounceTimer),this.previewDebounceTimer=setTimeout(()=>{console.log("Debounced: Ready to update preview from YAML editor content.")},500)}_handleSubjectChange(e){this.filters.subject=e.target.value,this.filters.tags=[],this.filters.reasons=[],this.currentPage=1,this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()}_handleFilterTagClick(e,t){const s=t.target.closest(".tag");if(!s)return;s.classList.toggle("active");const r=e==="tags"?Vs:Ys;this.filters[e]=Array.from(r.querySelectorAll(".tag.active")).map(a=>a.dataset.value),this.currentPage=1,this.refreshView()}_handleMistakeListClick(e){const t=e.target.closest(".mistake-list-item");if(!t)return;const s=t.dataset.id;this.ui.setActiveListItem(s);const r=Js.querySelector(`.mistake-card[data-id="${s}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("highlight"),setTimeout(()=>r.classList.remove("highlight"),1500))}_handlePaginationClick(e){const t=e.target.closest(".page-btn");t&&(this.currentPage=parseInt(t.dataset.page),this.refreshView())}async _handlePreviewClick(e){const t=e.target.closest(".mistake-card");if(!t)return;const s=t.dataset.id;e.target.matches(".show-answer-btn")&&this.ui.toggleAnswer(t,!0);const r=e.target.closest(".review-btn");if(r){const a=parseInt(r.dataset.rating),c=await this.manager.updateReviewStatus(s,a);c&&(this.ui.updateCardAfterReview(t,c,a),this.ui.updateListItem(s,c),a===0&&setTimeout(()=>this.ui.toggleAnswer(t,!1),500))}}_handleFileLoad(e){const t=e.target.files[0];if(!t)return;const s=new FileReader;s.onload=async r=>{await this._handleSaveFromYaml(r.target.result),bt.value=r.target.result},s.onerror=()=>alert("读取文件失败！"),s.readAsText(t),e.target.value=""}}class Ah{constructor(){}generateStats(e){const t={total:e.length,bySubject:{},byReason:{},dueToday:0,overdue:0},s=new Date;s.setHours(23,59,59,999);const r=new Date;return r.setHours(0,0,0,0),e.forEach(a=>{t.bySubject[a.subject]=(t.bySubject[a.subject]||0)+1;const c=a.analysis.reason_for_error;t.byReason[c]=(t.byReason[c]||0)+1;const f=new Date(a.review.due);f<r?t.overdue++:f<=s&&t.dueToday++}),t}getDashboardHtml(e){const t=this.generateStats(e),s=Object.entries(t.byReason).sort((a,c)=>c[1]-a[1]).slice(0,3),r=Object.entries(t.bySubject).sort((a,c)=>c[1]-a[1]).slice(0,3);return`
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-chart-line"></i> 复习状态</div>
                <div class="stats-card-body">
                    <div class="stat-item"><span class="stat-value overdue">${t.overdue}</span><span class="stat-label">已过期</span></div>
                    <div class="stat-item"><span class="stat-value today">${t.dueToday}</span><span class="stat-label">今日到期</span></div>
                    <div class="stat-item"><span class="stat-value">${t.total}</span><span class="stat-label">总数</span></div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-book"></i> 科目分布</div>
                <div class="stats-card-body list-style">
                    ${r.length>0?r.map(([a,c])=>`<div class="list-item"><span>${a}</span><span class="list-value">${c}</span></div>`).join(""):"<span>暂无数据</span>"}
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-diagnoses"></i> 主要错误原因</div>
                <div class="stats-card-body list-style">
                    ${s.length>0?s.map(([a,c])=>`<div class="list-item"><span>${a}</span><span class="list-value">${c}</span></div>`).join(""):"<span>暂无数据</span>"}
                </div>
            </div>
        `}}async function Th(){console.log("Initializing Mistakes Management System...");const n=new Ih,e=new Ah(n),t=new Eh;await t.initialize();const s=new _h(t,n,e),r=Object.keys(t.getTaxonomy())[0]||"all";s.filters.subject=r,n.renderFilters(t.getTaxonomy(),r),s.init(),console.log("Mistakes Management System is ready.")}const bn=Object.keys(ne.tables.reduce((n,e)=>({...n,[e.name]:!0}),{}));async function Lh(){console.log("Starting database export for tables:",bn);const n={};return await ne.transaction("r",bn,async()=>{for(const e of bn)if(ne.table(e)){console.log(`Exporting table: ${e}`);const t=await ne.table(e).toArray();n[e]=t}}),console.log("Database export completed."),n}async function Ch(n){const e=Object.keys(n);if(e.length===0||!bn.some(t=>e.includes(t)))throw new Error("导入文件格式无效或不包含任何可识别的数据表。");console.log("Starting database import..."),await ne.transaction("rw",bn,async()=>{for(const t of bn)n[t]&&(console.log(`Clearing and importing table: ${t}`),await ne.table(t).clear(),await ne.table(t).bulkAdd(n[t]))}),console.log("Database import completed successfully.")}function Oh(n){const e=document.createElement("li");e.className="settings-nav-item",e.dataset.id=n.id,e.dataset.type=n.type;let t="fa-cog";return n.type==="apiConfig"?t="fa-key":n.type==="agent"&&(t="fa-robot"),e.innerHTML=`<i class="fas ${t}"></i><span>${n.name}</span>`,e}function Mo(n,e,t){const s=document.createDocumentFragment(),r=document.createElement("div");r.className="settings-nav-group",r.innerHTML=`
        <h4 class="settings-nav-group-title">${n}</h4>
        <button class="add-item-btn" data-type="${t}"><i class="fas fa-plus"></i> 添加</button>
    `;const a=document.createElement("ul");return e.forEach(c=>a.appendChild(Oh(c))),r.appendChild(a),s.appendChild(r),s}function ba(){const n=V("settings-view"),e=V("settings-layout-template");if(!n||!e){console.error("Settings container or layout template not found.");return}if(n.children.length>0)return;n.innerHTML="",n.appendChild(e.content.cloneNode(!0));const t=_e(".settings-nav-list");if(!t)return;t.innerHTML="";const s=document.createElement("li");s.className="settings-nav-item",s.dataset.id="general",s.dataset.type="general",s.innerHTML='<i class="fas fa-cogs"></i><span>应用设置</span>',t.appendChild(s);const r=$.apiConfigs.map(c=>({id:c.id,name:c.name,type:"apiConfig"})),a=$.agents.map(c=>({id:c.id,name:c.name,type:"agent"}));t.appendChild(Mo("API 配置",r,"apiConfig")),t.appendChild(Mo("Agent配置",a,"agent"))}function Li(n,e=!1){const t=V("settings-detail-title"),s=V("settings-detail-content"),r=V("settings-save-btn");if(!s||!t||!r)return;r.style.display=n.type!=="general"?"inline-flex":"none";let a;if(n.type==="general")a="general-settings-form-template";else if(n.type==="apiConfig")a="api-config-form-template";else if(n.type==="agent")a="agent-form-template";else{s.innerHTML='<div class="placeholder-content"><i class="fas fa-exclamation-circle fa-2x"></i><p>未知的配置类型</p></div>';return}const c=V(a);if(!c){s.innerHTML=`<p>错误：未找到模板 #${a}。</p>`;return}s.innerHTML="",s.appendChild(c.content.cloneNode(!0)),n.type==="apiConfig"?Nh(n,e):n.type==="agent"&&$h(n,e);const f=e?"fa-plus-circle":"fa-edit";t.innerHTML=`<i class="fas ${f}"></i> ${e?`创建${n.displayName}`:`编辑: ${n.displayName}`}`}function Nh(n,e){const t=V("api-config-form-dynamic");if(!t)return;const s=t.querySelector(".config-provider");s.innerHTML="",Object.keys(Zr).forEach(r=>{const a=document.createElement("option");a.value=r,a.textContent=r,s.appendChild(a)}),e?(t.querySelector(".delete-item-btn").style.display="none",s.value="火山",s.dispatchEvent(new Event("change"))):(t.querySelector(".config-id").value=n.id,t.querySelector(".config-name").value=n.name,s.value=n.provider,t.querySelector(".config-apiUrl").value=n.apiUrl,t.querySelector(".config-apiKey").value=n.apiKey,t.querySelector(".config-models").value=n.models)}function $h(n,e){const t=V("agent-form-dynamic");if(!t)return;const s=t.querySelector(".config-model");if(s.innerHTML='<option value="">-- 请选择一个模型 --</option>',$.apiConfigs.forEach(r=>{if(!r.models)return;r.models.split(",").map(c=>c.trim()).filter(Boolean).forEach(c=>{const[f,h]=c.split(":").map(_=>_.trim());if(!f||!h)return;const m=document.createElement("option");m.value=`${r.id}:${f}`,m.textContent=`${r.name}: ${f} (${h})`,s.appendChild(m)})}),e)t.querySelector(".delete-item-btn").style.display="none",t.querySelector(".config-sendHistory").checked=!0;else{t.querySelector(".config-id").value=n.id,t.querySelector(".config-name").value=n.name,t.querySelector(".config-avatar").value=n.avatar||"",t.querySelector(".config-model").value=n.model||"",t.querySelector(".config-systemPrompt").value=n.systemPrompt||"",t.querySelector(".config-hint").value=n.hint||"",t.querySelector(".config-sendHistory").checked=n.sendHistory!==!1;const r=t.querySelector(".tags-list");r.innerHTML="",n.tags&&n.tags.length>0&&n.tags.forEach(a=>{const c=document.createElement("li");c.textContent=a,c.innerHTML+='<button type="button" class="remove-tag-btn">×</button>',r.appendChild(c)})}}function In(n,e,t){n&&(e?(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> 处理中...'):(n.disabled=!1,n.innerHTML=t))}let Mr=null,et=null;function xh(n){document.documentElement.setAttribute("data-theme",n||"")}function Mh(n){localStorage.setItem("app-theme",n)}function ul(n){Mr&&clearInterval(Mr),n>0&&(Mr=setInterval(Qu,n*60*1e3))}function Ph(n){const e=n.target.value;xh(e),Mh(e)}function Dh(n){const e=parseInt(n.target.value,10);if(isNaN(e)||e<0){n.target.value=$.settings.autoSaveInterval;return}ie({settings:{...$.settings,autoSaveInterval:e}}),ul(e)}async function Bh(){const n=V("export-db-btn"),e=n.innerHTML;In(n,!0,e);try{const t=await Lh(),s=JSON.stringify(t,null,2),r=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(r),c=document.createElement("a");c.href=a;const f=new Date().toISOString().slice(0,10);c.download=`anki-suite-backup-${f}.json`,c.click(),URL.revokeObjectURL(a)}catch(t){console.error("导出数据库失败:",t),alert("导出数据时发生错误。")}finally{In(n,!1,e)}}async function jh(n){const e=V("import-db-btn"),t=V("import-file-input"),s=n.target.files[0];if(!s)return;if(!confirm("警告！导入将覆盖所有数据，此操作不可撤销。确定继续吗？")){t.value="";return}const r=e.innerHTML;In(e,!0,r);const a=new FileReader;a.onload=async c=>{try{const f=JSON.parse(c.target.result);await Ch(f),alert("数据导入成功！应用将重新加载。"),window.dispatchEvent(new CustomEvent("app:dataImported"))}catch(f){console.error("导入数据库失败:",f),alert(`导入数据失败：${f.message}`)}finally{In(e,!1,r)}},a.readAsText(s),t.value=""}function Kh(n){const e=n.target.closest(".settings-nav-item");if(!e)return;document.querySelectorAll(".settings-nav-item.active").forEach(a=>a.classList.remove("active")),e.classList.add("active");const t=e.dataset.id,s=e.dataset.type;let r;if(s==="general"?r={id:"general",type:"general",displayName:"应用设置"}:s==="apiConfig"?r=$.apiConfigs.find(a=>a.id===t):s==="agent"&&(r=$.agents.find(a=>a.id===t)),r&&(et={...r,type:s},Li(et),s==="general")){const a=V("theme-selector");a&&(a.value=localStorage.getItem("app-theme")||"");const c=V("autosave-interval");c&&(c.value=$.settings.autoSaveInterval)}}function qh(n){const e=n.target.closest(".add-item-btn");if(!e)return;const t=e.dataset.type;let s="新项目";t==="apiConfig"?s="新 API 配置":t==="agent"&&(s="新 Agent"),et={type:t,displayName:s},Li(et,!0)}function Rh(n){const e=n.target.closest("form");if(!e)return;const t=n.target.value,s=e.querySelector(".config-apiUrl");s&&(s.value=ou(t))}async function Fh(){if(!et)return;const n=V("settings-save-btn"),e=n.innerHTML;In(n,!0,"保存中...");try{et.type==="apiConfig"?await Hh():et.type==="agent"&&await Uh(),V("settings-view").innerHTML="",ba()}catch(t){console.error("Save failed:",t),alert(`保存失败: ${t.message}`)}finally{In(n,!1,e)}}async function Hh(){const n=V("api-config-form-dynamic"),e={name:n.querySelector(".config-name").value,provider:n.querySelector(".config-provider").value,apiUrl:n.querySelector(".config-apiUrl").value,apiKey:n.querySelector(".config-apiKey").value,models:n.querySelector(".config-models").value},t=n.querySelector(".config-id").value;t?await Ku(t,e):await ju(e)}async function Uh(){const n=V("agent-form-dynamic"),e=Array.from(n.querySelectorAll(".tags-list li")).map(r=>r.textContent.slice(0,-1).trim()),t={name:n.querySelector(".config-name").value,avatar:n.querySelector(".config-avatar").value,model:n.querySelector(".config-model").value,systemPrompt:n.querySelector(".config-systemPrompt").value,hint:n.querySelector(".config-hint").value,tags:e,sendHistory:n.querySelector(".config-sendHistory").checked},s=n.querySelector(".config-id").value;s?await Fu(s,t):await Ru(t)}async function zh(n){if(!n.target.closest(".delete-item-btn")||!et||!et.id)return;const{type:e,id:t,name:s}=et;let r=`你确定要删除 "${s}" 吗? 此操作无法撤销。`;if(confirm(r))try{e==="apiConfig"?await qu(t):e==="agent"&&await Hu(t),V("settings-view").innerHTML="",ba(),Li({},!1)}catch(a){console.error("Delete failed:",a),alert(`删除失败: ${a.message}`)}}function Vh(){const n=V("settings-view");n&&(n.addEventListener("click",e=>{const t=e.target;if(t.id==="export-db-btn"&&Bh(),t.id==="import-db-btn"&&V("import-file-input").click(),t.closest(".settings-nav-item")&&Kh(e),t.closest(".add-item-btn")&&qh(e),t.id==="settings-save-btn"&&Fh(),t.closest(".delete-item-btn")&&zh(e),t.closest(".toggle-api-key-visibility")){const s=t.closest(".input-group").querySelector("input");s.type=s.type==="password"?"text":"password"}e.target.classList.contains("remove-tag-btn")&&e.target.parentElement.remove()}),n.addEventListener("change",e=>{const t=e.target;t.id==="theme-selector"&&Ph(e),t.id==="autosave-interval"&&Dh(e),t.id==="import-file-input"&&jh(e),t.matches(".config-provider")&&Rh(e)}),n.addEventListener("keydown",e=>{if(e.target.classList.contains("config-tags-input")&&e.key==="Enter"){e.preventDefault();const t=e.target,s=t.value.trim();if(s){const r=t.closest(".tags-input-container").querySelector(".tags-list"),a=document.createElement("li");a.textContent=s,a.innerHTML+='<button type="button" class="remove-tag-btn">×</button>',r.appendChild(a),t.value=""}}}))}function Yh(n){ul($.settings.autoSaveInterval);let e;if((n==null?void 0:n.type)==="prompt"&&(n==null?void 0:n.action)==="create"){const s=_e('.add-item-btn[data-type="prompt"]');if(s){s.click();return}}e='#settings-view .settings-nav-item[data-type="general"]';const t=_e(e);t?t.click():Li({},!1)}function Po(n=null){const e=V("settings-view");n&&(e.innerHTML=""),ba(),Yh(n),Vh(),console.log("✅ 设置模块已成功初始化/更新。")}const Do={anki:!1,mistakes:!1,agent:!1,settings:!1};async function ii(n=null){console.log("[ViewChange] Switching to view:",$.activeView),Bo.style.display="none",jo.style.display="none",Ko.style.display="none",qo.style.display="none",Gn&&(Gn.style.display="none"),document.querySelectorAll(".app-nav-btn").forEach(r=>r.classList.remove("active"));const e=$.activeView||"anki",t=zl[`${e}View`],s=document.getElementById(`nav-${e==="agent"?"agents":e}`);if(Do[e])e==="settings"&&n&&(console.log("[Lazy Init] Re-initializing settings module with new context."),Po(n));else{console.log(`[Lazy Init] Initializing ${e} module for the first time.`);try{switch(e){case"anki":await td();break;case"agent":await hd();break;case"mistakes":await Th();break;case"settings":Po(n);break}Do[e]=!0}catch(r){console.error(`Failed to lazy-initialize ${e} view:`,r)}}t&&(t.style.display="flex"),s&&s.classList.add("active"),e==="agent"&&Gn&&(Gn.style.display="flex")}function Jh(){document.querySelector(".app-nav").addEventListener("click",e=>{const t=e.target.closest(".app-nav-btn");if(!t)return;e.preventDefault();const s=t.dataset.view;s&&s!==$.activeView&&(co(s),ii())}),window.addEventListener("app:navigateTo",e=>{const{view:t,context:s}=e.detail;t&&t!==$.activeView?(co(t),ii(s)):t&&t===$.activeView&&s&&ii(s)})}function Gh(){window.addEventListener("beforeunload",()=>jr()),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&jr()})}function Wh(){window.addEventListener("app:dataImported",async()=>{console.log("Event 'app:dataImported' received. Re-initializing app..."),alert("数据导入成功！应用将刷新以应用更改。"),location.reload()})}async function Qh(){document.body.classList.add("is-loading");try{await Vo(),await Bu(),Jh(),Gh(),Wh();const n=$.activeView||"anki";ie({activeView:n}),await ii(),console.log("Application initialized successfully.")}catch(n){console.error("Application failed to initialize:",n);const e=document.createElement("div");e.className="error-overlay",e.innerHTML="...",document.body.innerHTML="",document.body.appendChild(e)}finally{document.body.classList.remove("is-loading")}}document.addEventListener("DOMContentLoaded",Qh);</script>
  <style rel="stylesheet" crossorigin>:root{--font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;--font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--leading-tight: 1.25;--leading-normal: 1.5;--leading-relaxed: 1.75;--primary-color: #5B66F5;--primary-hover: #4B55E3;--primary-light: #E8EAFF;--primary-dark: #3B41C5;--secondary-color: #6366F1;--secondary-light: #A5A7F3;--accent-color: #06B6D4;--accent-light: #E0F6FF;--gray-50: #F9FAFB;--gray-100: #F3F4F6;--gray-200: #E5E7EB;--gray-300: #D1D5DB;--gray-400: #9CA3AF;--gray-500: #6B7280;--gray-600: #4B5563;--gray-700: #374151;--gray-800: #1F2937;--gray-900: #111827;--sidebar-bg: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);--header-bg: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);--panel-header-bg: #4f46e5;--content-bg: #f8fafc;--success-color: #10B981;--success-light: #D1FAE5;--warning-color: #F59E0B;--warning-light: #FEF3C7;--danger-color: #EF4444;--danger-light: #FEE2E2;--bg-primary: #FFFFFF;--bg-secondary: #f1f5f9;--bg-tertiary: #F3F4F6;--bg-elevated: #FFFFFF;--text-primary: #111827;--text-secondary: #4B5563;--text-tertiary: #9CA3AF;--text-on-primary: #FFFFFF;--border-color: #E5E7EB;--border-radius: 8px;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .05);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);--transition: all .3s ease;--folder-color: #F59E0B;--file-color: #06B6D4;--sidebar-width: 56px;--agent-color-1: #5B66F5;--agent-color-2: #6366F1;--agent-color-3: #06B6D4;--agent-color-4: #8B5CF6;--agent-color-5: #EC4899;--topic-color-1: #F59E0B;--topic-color-2: #10B981;--topic-color-3: #3B82F6;--topic-color-4: #EF4444;--cloze-1d: #FEE2E2;--cloze-2d: #FED7AA;--cloze-3d: #FDE68A;--cloze-5d: #D9F99D;--cloze-7d: #BBF7D0;--cloze-14d: #BFDBFE;--cloze-28d: #E0E7FF;--cloze-28plus: #EDE9FE;--cloze-easy-open: #ECFDF5;--cloze-10m: #DC2626;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .05) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .05) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .05) 0%, transparent 50%)}[data-theme=dark]{--primary-light: rgba(91, 102, 245, .15);--accent-light: rgba(6, 182, 212, .1);--gray-50: #111827;--gray-100: #1F2937;--gray-200: #374151;--gray-300: #4B5563;--gray-400: #6B7280;--gray-500: #9CA3AF;--gray-600: #D1D5DB;--gray-700: #E5E7EB;--gray-800: #F3F4F6;--gray-900: #F9FAFB;--sidebar-bg: linear-gradient(135deg, #111827 0%, #1F2937 100%);--header-bg: linear-gradient(135deg, #374151 0%, #4B5563 100%);--panel-header-bg: #374151;--content-bg: #111827;--success-light: rgba(16, 185, 129, .15);--warning-light: rgba(245, 158, 11, .15);--danger-light: rgba(239, 68, 68, .15);--bg-primary: #1F2937;--bg-secondary: #111827;--bg-tertiary: #374151;--bg-elevated: #1F2937;--text-primary: #F9FAFB;--text-secondary: #D1D5DB;--text-tertiary: #9CA3AF;--border-color: #374151;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .3), 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .3), 0 2px 4px -1px rgba(0, 0, 0, .2);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .3), 0 4px 6px -2px rgba(0, 0, 0, .2);--cloze-1d: #4a1d1d;--cloze-2d: #543a1a;--cloze-3d: #574f20;--cloze-5d: #3a5323;--cloze-7d: #2a503a;--cloze-14d: #2c415e;--cloze-28d: #3c3e5e;--cloze-28plus: #444059;--cloze-easy-open: #224433;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .1) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .1) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .1) 0%, transparent 50%)}[data-theme=large-font]{--text-xs: .86rem;--text-sm: 1rem;--text-base: 1.125rem;--text-lg: 1.265rem;--text-xl: 1.406rem;--text-2xl: 1.687rem;--text-3xl: 2.1rem}[data-theme=larger-font]{--text-xs: .95rem;--text-sm: 1.1rem;--text-base: 1.25rem;--text-lg: 1.4rem;--text-xl: 1.56rem;--text-2xl: 1.875rem;--text-3xl: 2.34rem}*{margin:0;padding:0;box-sizing:border-box}html{height:100%}body{font-family:var(--font-primary);font-size:var(--text-base);line-height:var(--leading-normal);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:var(--bg-secondary);background-image:var(--body-bg-image);color:var(--text-primary);height:100vh;padding:0;display:flex;overflow:hidden}.container{max-width:1800px;margin:0 auto}.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);box-shadow:4px 0 24px #0000001f;border-right:none;display:flex;flex-direction:column;position:relative;z-index:100;overflow-x:hidden;flex-shrink:0}.sidebar.collapsed{transform:translate(-100%)}.main-content{flex:1;padding:0;min-height:0;min-width:0;display:flex;flex-direction:column;background:transparent}.main-content.expanded{margin-left:0}.content-wrapper{flex:1 1 auto;padding:20px;display:flex;flex-direction:column;min-height:0;overflow-y:auto;background:var(--content-bg);border-radius:16px 0 0;box-shadow:inset 0 1px 3px #0000000a}.main-layout{display:flex;gap:20px;flex-wrap:nowrap;flex:1;min-height:0;min-width:0}.main-layout.active{display:flex}.app-container{flex:1;display:flex;flex-direction:column;gap:20px;min-width:0;min-height:0}.footer{display:none}.audio-controls{position:fixed;bottom:20px;right:20px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);padding:15px;z-index:1000;display:none}.audio-title{margin-bottom:10px;font-weight:600;color:var(--secondary-color)}.audio-progress{width:300px;height:6px;background:var(--border-color);border-radius:3px;margin:10px 0;overflow:hidden}.audio-progress-bar{height:100%;background:var(--primary-color);width:0%;transition:width .1s linear}.audio-buttons{display:flex;justify-content:space-between}.audio-btn{background:var(--primary-color);color:var(--text-on-primary);border:none;padding:8px 15px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:5px}.audio-edit-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;margin-top:5px;transition:var(--transition)}.audio-edit-btn:hover{background:#4361ee33}.btn-primary,.btn-secondary,.btn-danger{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1rem;transition:var(--transition)}.btn-primary{background-color:var(--primary-color);color:var(--text-on-primary);font-weight:500}.btn-primary:hover{background-color:var(--primary-hover)}.btn-secondary{background-color:var(--gray-100);color:var(--text-secondary)}.btn-secondary:hover{background-color:var(--gray-200);color:var(--text-primary)}.btn-danger{background-color:var(--danger-color);color:var(--text-on-primary)}.btn-danger:hover{opacity:.85}.dropdown-menu{position:absolute;top:105%;right:0;background-color:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;padding:8px 0;min-width:180px;border:1px solid var(--border-color)}.dropdown-menu a{display:block;padding:10px 15px;color:var(--text-primary);text-decoration:none;transition:background-color .2s ease;font-size:.9rem}.dropdown-menu a:hover{background-color:var(--gray-100)}.dropdown-menu a i{margin-right:10px;color:var(--primary-color);width:20px;text-align:center}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-primary)}.form-control{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);width:100%;padding:10px 12px;border-radius:6px;font-size:var(--text-base);transition:var(--transition)}.form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.form-control.is-invalid{border-color:var(--danger-color)}.invalid-feedback{color:var(--danger-color);font-size:.85rem;margin-top:5px;display:none}.form-control.is-invalid+.invalid-feedback{display:block}.input-group{display:flex}.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}.input-group-btn{padding:0 12px;border:1px solid var(--border-color);border-left:none;background-color:var(--bg-tertiary);border-top-right-radius:6px;border-bottom-right-radius:6px;cursor:pointer}.form-check{display:flex;align-items:center;gap:8px;margin-top:15px}.form-checkbox-group{display:flex;flex-wrap:wrap;gap:10px 20px;padding:5px 0}.form-checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:2000;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}.modal-content{background:var(--bg-elevated);box-shadow:0 20px 40px #00000026;border-radius:var(--border-radius);width:90%;max-width:600px;display:flex;flex-direction:column;max-height:90vh;animation:slide-in .3s ease-out}.modal-header{padding:15px 25px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:var(--text-xl);color:var(--text-primary)}.modal-close{background:none;border:none;font-size:1.8rem;cursor:pointer;color:var(--text-tertiary)}.modal-body{padding:25px;overflow-y:auto}.modal-footer{padding:15px 25px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:10px}.delete-confirm-zone{margin-top:15px;padding:15px;background-color:#f443361a;border:1px solid var(--danger-color);border-radius:6px}.delete-confirm-zone #finalDeleteBtn{margin-top:10px;width:100%}.delete-confirm-zone #finalDeleteBtn:disabled{background-color:#ccc;cursor:not-allowed}.move-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:var(--transition)}.move-modal.active{opacity:1;pointer-events:all}.move-modal-content{background:var(--bg-elevated);border-radius:var(--border-radius);padding:20px;width:400px;max-width:90%;box-shadow:var(--shadow)}.move-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.move-modal-title{font-size:1.2rem;font-weight:600;color:var(--primary-color)}.move-modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-tertiary)}.folder-list{max-height:300px;overflow-y:auto;margin:15px 0;border:1px solid var(--border-color);border-radius:var(--border-radius);padding:10px}.folder-item{padding:8px 10px;border-radius:4px;margin-bottom:5px;background:var(--bg-primary);cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}.folder-item:hover{background:var(--bg-tertiary)}.folder-item.selected{background:#4361ee1a;border-left:3px solid var(--primary-color)}.move-modal-actions{display:flex;justify-content:flex-end;gap:10px}.move-modal-btn{padding:8px 15px;border-radius:4px;cursor:pointer;border:none;font-weight:500;transition:var(--transition)}.move-modal-btn.confirm{background:var(--primary-color);color:var(--text-on-primary)}.move-modal-btn.cancel{background:var(--gray-100);color:var(--text-primary)}.panel{background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 3px #0000000d;border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out}.panel.collapsed .panel-content{display:none}.panel.collapsed .collapse-btn i{transform:rotate(180deg)}.panel-header{background:var(--panel-header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 1px 3px #0000001a;padding:0 20px;display:flex;justify-content:space-between;align-items:center;height:60px;flex-shrink:0;position:relative}.panel-header:after{content:"";position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(to right,transparent,rgba(255,255,255,.2),transparent)}.panel-header .panel-title{flex-grow:1;justify-content:center;text-align:center}.panel-header .panel-actions-leading,.panel-header .panel-actions{flex-shrink:0;display:flex;gap:8px;align-items:center}.panel-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;gap:8px}.panel-actions{display:flex;gap:8px;align-items:center}.panel-actions .panel-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:4px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition)}.panel-actions .panel-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.panel-actions .panel-btn-text{width:auto;padding:0 15px;gap:8px}.panel-content{flex:1;padding:0;overflow:hidden;transition:var(--transition);display:flex;flex-direction:column;min-height:0}.collapse-btn i{transition:transform .3s ease}.tag{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-secondary);font-size:var(--text-sm);padding:6px 12px;border-radius:20px;cursor:pointer;transition:var(--transition)}.tag:hover{background:var(--gray-100);border-color:var(--gray-300)}.tag.active{background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-dark);box-shadow:0 2px 4px #5b66f533;font-weight:500}.toggle-list{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:var(--border-radius);margin:1.2em 0;overflow:hidden;box-shadow:0 1px 3px #0000000d}.toggle-list summary{padding:12px 18px;font-weight:600;color:var(--primary-color);background-color:var(--bg-tertiary);cursor:pointer;outline:none;list-style:none;display:flex;align-items:center;transition:background-color .2s ease;gap:8px}.toggle-list summary::-webkit-details-marker{display:none}.toggle-list summary:hover{background-color:var(--bg-primary)}.toggle-list summary:before{content:"▶";font-size:.8em;margin-right:12px;transform:rotate(0);transition:transform .2s ease-in-out;color:var(--accent-color)}.toggle-list[open]>summary:before{transform:rotate(90deg)}.toggle-list summary input[type=checkbox]{flex-shrink:0;margin:0;width:1.2em;height:1.2em;cursor:pointer}.toggle-title-text{flex-grow:1}.toggle-content{padding:15px 20px;border-top:1px solid var(--border-color)}.toggle-content>*:first-child{margin-top:0}.toggle-content>*:last-child{margin-bottom:0}.app-nav{display:flex;flex-direction:column;gap:8px;padding:20px 0;border-bottom:1px solid rgba(255,255,255,.1)}.app-nav-btn{background:#ffffff1a;color:#ffffffe6;border:1px solid rgba(255,255,255,.1);height:32px;width:32px;padding:0;margin:0 auto;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:600;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .3s cubic-bezier(.4,0,.2,1);text-decoration:none;overflow:hidden}.app-nav-btn:hover{background:#fff3;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #00000026}.app-nav-btn.active{background:#fffffff2;color:var(--primary-dark);border-color:transparent;box-shadow:0 4px 16px #ffffff4d}.app-nav-btn i{font-size:1.1rem;width:20px;text-align:center;flex-shrink:0}.app-nav-btn.active i{color:var(--primary-color)}.session-sidebar{width:300px;background:var(--bg-elevated);box-shadow:var(--shadow-md);border:1px solid rgba(0,0,0,.06);border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:var(--transition)}.session-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 2px 8px #4f46e526;padding:15px 20px;display:flex;flex-direction:column;gap:12px}.session-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;justify-content:space-between}.session-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}.session-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px;border-radius:4px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;width:36px;height:36px;transition:var(--transition)}.session-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.session-content{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;min-height:0;background:var(--bg-secondary)}.session-list-container{flex:1;display:flex;flex-direction:column;min-height:0}.session-list{list-style:none;margin-top:10px;overflow-y:auto;flex:1}.session-item{padding:12px 15px 12px 30px;border-radius:6px;margin-bottom:8px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;cursor:pointer;transition:var(--transition);position:relative}.session-item.folder{background:#ffd1661a;border-left:4px solid var(--folder-color);padding-left:26px}.session-item.file{background:#a1c4fd1a;border-left:4px solid var(--file-color);padding-left:26px}.session-item:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:60px;display:flex;align-items:center;gap:8px}.session-item .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}.session-item .edit-btn,.session-item .delete-btn,.session-item .move-btn{color:var(--text-tertiary);cursor:pointer;padding:4px;border-radius:4px;transition:var(--transition);background:#fff9;width:24px;height:24px;display:flex;align-items:center;justify-content:center}.session-item .edit-btn:hover{background:var(--accent-color);color:var(--text-on-primary)}.session-item .delete-btn:hover{background:var(--danger-color);color:var(--text-on-primary)}.session-item .move-btn:hover{background:var(--success-color);color:var(--text-on-primary)}.session-item input[type=text]{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:.95rem;background-color:var(--bg-primary);color:var(--text-primary)}.select-controls{display:flex;gap:8px;margin-top:10px;padding:8px 0;background:#ffffff1a;border-top:1px solid rgba(255,255,255,.2);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.select-all{display:flex;align-items:center;gap:5px;color:var(--text-on-primary);font-size:.85rem}.session-item .select-checkbox{margin-right:8px}.session-item .name-container{display:flex;flex:1;overflow:hidden}.folder-icon{color:var(--folder-color)}.file-icon{color:var(--file-color)}.nested-items{margin-left:20px;margin-top:8px;border-left:2px solid var(--border-color);padding-left:15px}.current-folder{margin-top:10px;padding:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:inset 0 1px 2px #0000000d;border-radius:4px;font-size:.9rem;color:var(--text-primary);display:flex;align-items:center;flex-wrap:wrap;gap:4px}.current-folder i{margin-right:5px;color:var(--folder-color)}.breadcrumb-link{color:var(--primary-color);cursor:pointer;text-decoration:none}.breadcrumb-link:hover{text-decoration:underline}.breadcrumb-separator{margin:0 4px;color:#6c757d}.breadcrumb-current{font-weight:700;color:var(--secondary-color)}.empty-session{text-align:center;padding:28px;color:var(--text-tertiary)}.empty-session i{font-size:2.8rem;margin-bottom:14px;color:var(--gray-300)}.editor-preview-panel{background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out;flex:1;min-height:0}.editor-preview-panel .panel-content{position:relative}.editor-preview-panel.preview-active #editor{display:none}.editor-preview-panel.preview-active #preview{display:block}.editor-preview-panel.preview-active .editor-sub-toolbar{display:none}.editor-panel,.preview-panel{flex:1;min-height:250px}.editor-panel.hidden{display:none}.editor-container{flex:1;display:flex;min-height:0;position:relative}#editor,#preview{position:absolute;top:0;left:0;width:100%;height:100%;margin:0;border:none;padding:15px;box-sizing:border-box;overflow:auto;background:transparent}#editor{z-index:10;font-family:var(--font-mono);font-size:var(--text-sm);color:var(--text-primary);resize:none;line-height:1.5;background-color:var(--bg-primary)}#editor:focus{outline:none;box-shadow:0 0 0 3px #4895ef33 inset}#preview{z-index:5;display:none;font-size:var(--text-base);line-height:var(--leading-relaxed);color:var(--text-primary);background-color:var(--bg-elevated)}#preview h1,#preview h2,#preview h3{margin-top:1.1em;margin-bottom:.7em;color:var(--text-primary);font-weight:700}#preview h1{font-size:var(--text-3xl)}#preview h2{font-size:var(--text-2xl)}#preview h3{font-size:var(--text-xl)}#preview p{margin-bottom:.9em}#preview code{background:var(--gray-100);color:var(--primary-color);padding:2px 5px;border-radius:4px;font-family:var(--font-mono);font-size:var(--text-sm)}#preview pre{background:var(--gray-50);color:var(--text-primary);padding:14px;border-radius:6px;overflow:auto;margin:1.4em 0;border:1px solid var(--border-color)}#preview blockquote{border-left:4px solid var(--primary-color);padding:10px 18px;background:var(--primary-light);margin:1.4em 0}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px 15px;border-bottom:1px solid var(--border-color);background:var(--bg-tertiary);flex-shrink:0}.editor-sub-toolbar .editor-btn{background:var(--bg-primary);border:1px solid var(--border-color);box-shadow:0 1px 2px #0000000d;padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem;color:var(--text-secondary)}.editor-sub-toolbar .editor-btn:hover:not(:disabled){background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-color);transform:translateY(-1px);box-shadow:0 4px 8px #5b66f540}.editor-sub-toolbar .editor-btn:disabled{opacity:.5;cursor:not-allowed}.mode-indicator{position:absolute;bottom:10px;right:10px;display:flex;gap:5px;z-index:20;background:#fffc;padding:5px 8px;border-radius:12px;box-shadow:0 2px 5px #0000001a}.mode-dot{width:10px;height:10px;border-radius:50%;background-color:var(--border-color)}.mode-dot.active{background-color:var(--primary-color)}.review-btn-group{display:flex;position:relative}.review-btn-group .main-action{border-top-right-radius:0;border-bottom-right-radius:0}.review-btn-group .dropdown-toggle{border-top-left-radius:0;border-bottom-left-radius:0;border-left:1px solid rgba(255,255,255,.3)}.cloze{padding:2px 6px;border-radius:4px;cursor:pointer;position:relative;transition:var(--transition);border:1px dashed rgba(67,97,238,.3);font-weight:700;background:var(--cloze-28plus)}.cloze.hidden .cloze-content{display:none}.cloze.hidden .placeholder{display:inline}.cloze:not(.hidden) .placeholder{display:none}.placeholder{color:var(--primary-color);font-weight:700}.cloze.temporary{animation:highlight .5s ease}.cloze.shown{background:linear-gradient(120deg,#d4fc79,#96e6a1)}.cloze.permanent{border:1px solid var(--success-color)}.cloze-1d{background:var(--cloze-1d)!important}.cloze-2d{background:var(--cloze-2d)!important}.cloze-3d{background:var(--cloze-3d)!important}.cloze-5d{background:var(--cloze-5d)!important}.cloze-7d{background:var(--cloze-7d)!important}.cloze-14d{background:var(--cloze-14d)!important}.cloze-28d{background:var(--cloze-28d)!important}.cloze-28plus{background:var(--cloze-28plus)!important}.cloze-10m{background-color:var(--cloze-10m)!important;border-color:#f33!important;animation:pulse-alert 1.5s infinite alternate;color:var(--text-on-primary)!important;font-weight:700}.cloze.easy-open{background-color:var(--cloze-easy-open)!important;border:1px dashed #C8E6C9;color:var(--text-primary)!important;font-weight:400;opacity:.9}.cloze.permanent-view{background-color:var(--primary-light)!important;border:1px solid var(--primary-color)!important;font-weight:400!important}.cloze.permanent-view .cloze-actions{display:none!important}.cloze-actions{display:flex;justify-content:space-between;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.08)}.cloze-btn{flex:1;padding:10px 5px;border-radius:20px;border:none;background-color:var(--bg-primary);cursor:pointer;font-size:.9rem;font-weight:600;text-align:center;transition:all .2s ease-in-out;outline:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;box-shadow:0 2px 4px #0000000d}.cloze-btn i{font-size:1.2rem;margin-bottom:5px}.cloze-btn.again{color:#e53935;background-color:#e539351a}.cloze-btn.again:hover{background-color:#e53935;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #e539354d}.cloze-btn.hard{color:#fb8c00;background-color:#fb8c001a}.cloze-btn.hard:hover{background-color:#fb8c00;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #fb8c004d}.cloze-btn.double{color:#43a047;background-color:#43a0471a}.cloze-btn.double:hover{background-color:#43a047;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #43a0474d}.cloze-btn.easy{color:#1e88e5;background-color:#1e88e51a}.cloze-btn.easy:hover{background-color:#1e88e5;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #1e88e54d}.ai-agent-nav{background:var(--bg-elevated);border:none;box-shadow:0 2px 8px #0000000f;border-radius:var(--border-radius);padding:12px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}.nav-title{color:var(--text-primary);font-size:var(--text-xl);color:var(--secondary-color);font-weight:600;display:flex;align-items:center;gap:10px}.nav-title i{color:var(--accent-color)}.agent-list{display:flex;gap:15px;overflow-x:auto;padding:5px 0}.agent-item{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));box-shadow:0 2px 8px #5b66f54d;color:var(--text-on-primary);padding:8px 20px;border-radius:30px;cursor:pointer;transition:var(--transition);font-size:.95rem;display:flex;align-items:center;gap:8px;white-space:nowrap}.agent-item:nth-child(2){background:linear-gradient(135deg,var(--accent-color),#0891b2)}.agent-item:nth-child(3){background:linear-gradient(135deg,var(--agent-color-4),var(--agent-color-5))}.agent-item:hover{transform:translateY(-3px);box-shadow:0 8px 16px #00000026}.agent-item.active{box-shadow:0 0 0 3px #fffc,0 5px 15px #0003}.nav-actions{display:flex;gap:12px}.nav-action-btn{background:var(--primary-color);color:var(--text-on-primary);border:none;padding:8px 15px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:var(--transition);font-size:.9rem}.nav-action-btn:hover{background:var(--secondary-color);transform:translateY(-2px)}.agent-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#4361ee,#3f37c9);display:flex;align-items:center;justify-content:center;color:var(--text-on-primary);font-weight:700;flex-shrink:0}.agent-content-container{display:flex;gap:20px;margin-bottom:20px;flex:1;min-height:0}.topics-panel{width:300px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}.topics-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:none;padding:15px 20px;font-size:var(--text-lg);font-weight:600}.topics-content{flex:1;padding:15px;overflow-y:auto}.topic-list{list-style:none}.topic-item{padding:12px 15px;border-radius:6px;margin-bottom:10px;background:var(--bg-secondary);border:1px solid var(--border-color);cursor:pointer;transition:var(--transition);position:relative;display:flex;align-items:center;gap:10px}.topic-item:hover{transform:translate(5px);background:var(--bg-elevated);box-shadow:0 2px 8px #0000000f}.topic-item.active{background:var(--primary-light);font-weight:600;border-left-color:var(--primary-color);border-left-width:4px}.topic-item:nth-child(1){border-left-color:var(--topic-color-1)}.topic-item:nth-child(2n){border-left-color:var(--topic-color-2)}.topic-item:nth-child(3n){border-left-color:var(--topic-color-3)}.topic-item:nth-child(4n){border-left-color:var(--topic-color-4)}.topic-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--text-on-primary);font-size:.8rem;flex-shrink:0}.topic-item:nth-child(1) .topic-icon{background:var(--topic-color-1)}.topic-item:nth-child(2) .topic-icon{background:var(--topic-color-2)}.topic-item:nth-child(3) .topic-icon{background:var(--topic-color-3)}.topic-item:nth-child(4) .topic-icon{background:var(--topic-color-4)}.history-panel{flex:1;background:var(--bg-elevated);border-radius:var(--border-radius);border:1px solid var(--border-color);display:flex;flex-direction:column;position:relative;min-width:0}.history-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:1px solid var(--border-color);padding:15px 20px;display:flex;justify-content:space-between;align-items:center}.history-title{font-size:var(--text-lg);font-weight:600;display:flex;align-items:center;gap:10px}.history-header-actions{display:flex;align-items:center;gap:10px}.header-action-btn{background:var(--gray-100);border:none;color:var(--text-secondary);width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}.header-action-btn:hover{background:var(--gray-200);transform:rotate(45deg)}.history-search{padding:8px 15px;border-radius:20px;border:none;width:250px;font-size:.9rem;background:#ffffffe6;box-shadow:0 2px 4px #0000001a;color:var(--text-primary)}.history-search:focus{background:var(--bg-elevated);box-shadow:0 4px 12px #00000026;outline:none}.history-content{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:20px;min-height:0;background:var(--bg-secondary)}.history-item{padding:15px;border-radius:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000a;border-left:3px solid var(--primary-color)}.history-item.highlighted{transition:background-color .5s ease;background-color:var(--primary-light);border-color:var(--accent-color)}.history-item-header{display:flex;justify-content:space-between;margin-bottom:10px;color:var(--text-tertiary);font-size:.9rem}.history-item-content{line-height:1.6}.history-item-content img{max-width:100%;border-radius:8px;margin-top:10px}.history-item-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}.history-action-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;transition:var(--transition)}.history-action-btn:hover{background:#4361ee33}.chat-navigation{position:absolute;bottom:90px;right:25px;display:flex;flex-direction:column;gap:10px;z-index:10}.chat-nav-btn{width:40px;height:40px;border-radius:50%;background-color:var(--primary-color);color:var(--text-on-primary);border:none;cursor:pointer;box-shadow:0 2px 10px #0003;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:1rem}.chat-nav-btn:hover{background-color:var(--primary-hover);transform:scale(1.1)}.chat-nav-btn:disabled{opacity:.5;cursor:not-allowed}.chat-input-area{padding:15px 20px;border-top:1px solid var(--border-color);background:linear-gradient(to bottom,transparent,var(--bg-secondary));display:flex;flex-direction:column;gap:10px;flex-shrink:0}.input-controls{display:flex;align-items:flex-end;gap:10px}.chat-textarea{flex:1;border:2px solid var(--border-color);padding:10px 15px;font-family:inherit;font-size:var(--text-base);line-height:1.5;resize:vertical;transition:var(--transition);background:var(--bg-primary);color:var(--text-primary);border-radius:var(--border-radius)}.chat-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px #5b66f51a}.chat-action-btn{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:var(--transition);background:var(--gray-100);color:var(--text-secondary);flex-shrink:0}.chat-action-btn:hover{background:var(--gray-200);transform:translateY(-2px)}.chat-action-btn.send{background-color:var(--primary-color);color:var(--text-on-primary)}.chat-action-btn.send:hover{background-color:var(--secondary-color)}.attachment-preview-container{display:flex;gap:8px;flex-wrap:wrap;max-height:100px;overflow-y:auto}.attachment-preview-item{background:var(--bg-tertiary);padding:5px 12px;border-radius:15px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px;color:var(--text-primary);animation:fadeIn .3s ease}.attachment-preview-item i{color:var(--primary-color)}.remove-attachment-btn{cursor:pointer;font-weight:700;color:var(--text-tertiary);background:none;border:none;font-size:1.2rem;line-height:1;padding:0 2px;transition:var(--transition)}.remove-attachment-btn:hover{color:var(--danger-color);transform:scale(1.2)}.mistakes-nav{width:25%;min-width:300px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}.nav-header{background:var(--header-bg);color:var(--text-on-primary);padding:15px 20px;display:flex;flex-direction:column;gap:12px}.nav-content{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:20px}.filter-accordion-item{border-bottom:1px solid var(--border-color)}.filter-accordion-item summary{display:flex;justify-content:space-between;align-items:center;padding:14px 5px;cursor:pointer;list-style:none;font-weight:600;color:var(--secondary-color)}.filter-accordion-item .tag-list{padding:10px 5px 15px;background-color:var(--bg-secondary);display:flex;flex-wrap:wrap;gap:8px}.mistakes-list{flex:1;overflow-y:auto;padding-top:15px;border-top:1px solid var(--border-color)}.mistake-item{background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:0 1px 2px #0000000a;padding:12px 15px;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:var(--transition);position:relative}.mistake-item:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;border-left-color:var(--primary-color);border-left-width:3px;transform:translate(3px)}.mistake-item.active{background:var(--primary-light);border-color:var(--primary-color);font-weight:600}.mistake-title{font-weight:500;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.mistake-meta{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-tertiary)}#yaml-editor{flex:1;min-height:150px;padding:14px;font-family:Consolas,Courier New,monospace;font-size:15px;border:1px solid var(--border-color);border-radius:6px;resize:none;line-height:1.5;background-color:var(--bg-primary);color:var(--text-primary)}#mistakes-preview{flex:1;overflow-y:auto;padding:15px}.mistakes-preview-container{padding:15px}.stats-dashboard-inline{display:flex;gap:15px;padding:15px;background-color:var(--bg-secondary);border-bottom:1px solid var(--border-color)}.stats-card{flex:1;background-color:var(--bg-elevated);border-radius:8px;border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000d;overflow:hidden}.stats-card-header{font-size:.9rem;font-weight:600;padding:8px 12px;background-color:var(--bg-tertiary);border-bottom:1px solid var(--border-color);color:var(--text-secondary)}.stats-card-header i{margin-right:8px;color:var(--primary-color)}.stats-card-body{padding:12px;display:flex;justify-content:space-around;align-items:center}.stats-card-body.list-style{flex-direction:column;align-items:stretch;gap:8px}.stat-item{display:flex;flex-direction:column;align-items:center;gap:4px}.stat-value{font-size:1.5rem;font-weight:700;color:var(--text-primary)}.stat-value.overdue{color:#d90429}.stat-value.today{color:#f77f00}.stat-label{font-size:.8rem;color:var(--text-tertiary)}.list-item{display:flex;justify-content:space-between;font-size:.85rem}.list-value{font-weight:600;padding:2px 6px;background-color:var(--bg-tertiary);border-radius:4px}.editor-toolbar{display:flex;justify-content:space-between;align-items:center;padding:10px 18px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-color)}.toolbar-left,.toolbar-right{display:flex;gap:10px}.toolbar-middle{flex:1;display:flex;justify-content:center;gap:10px}.editor-btn{background:var(--bg-primary);border:1px solid var(--border-color);padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem;color:var(--text-secondary)}.editor-btn:hover:not(:disabled){background:var(--accent-color);color:var(--text-on-primary);border-color:var(--accent-color)}.editor-btn:disabled{opacity:.5;cursor:not-allowed}.editor-btn-text{width:40px;height:40px;padding:0;font-size:0}.editor-btn-text i{font-size:.9rem;margin:0}.review-btn-group .editor-btn-text,.review-btn-group .dropdown-toggle{width:auto;padding:8px 15px;font-size:.9rem}#reviewOptionsBtn.dropdown-toggle{padding:8px 12px}#startReviewBtn.editor-btn-text{gap:8px}#startReviewBtn.editor-btn-text i{font-size:.9rem}.instructions{background:var(--bg-elevated);padding:22px;border-radius:var(--border-radius);box-shadow:var(--shadow);margin-top:25px}.instructions h2{color:var(--secondary-color);margin-bottom:18px;text-align:center;font-size:1.4rem}.instructions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px}.instruction-card{background:var(--bg-primary);border-radius:var(--border-radius);padding:18px;box-shadow:0 2px 8px #00000014;transition:var(--transition)}.instruction-card:hover{transform:translateY(-4px);box-shadow:0 6px 15px #0000001a}.instruction-card h3{color:var(--primary-color);margin-bottom:14px;display:flex;align-items:center;gap:8px;font-size:1.1rem}.instruction-card h3 i{background:var(--primary-color);color:var(--text-on-primary);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem}.media-icon{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;margin-right:5px;background:#4361ee1a;border-radius:50%;color:var(--primary-color);cursor:pointer;transition:var(--transition)}.media-icon:hover{background:#4361ee33;transform:scale(1.1)}.global-review-area{margin:15px 0;display:flex;justify-content:center}.settings-section{margin-bottom:30px;max-width:600px}.settings-section-title{font-size:var(--text-xl);color:var(--text-primary);border-bottom:2px solid var(--primary-light);padding-bottom:10px;margin-bottom:20px;font-weight:600}.file-input{display:none}.hidden-session{transform:translate(calc(-1 * var(--session-width) - 25px));opacity:0;width:0;overflow:hidden}.panel-btn.active{background-color:#ffffff4d;transform:scale(1.1)}.panel-btn{transition:all .3s ease}.panel-btn i{transition:color .3s ease}.edit-mode .panel-btn i.fa-eye{color:#4caf50}.preview-mode .panel-btn i.fa-eye{color:#ff9800}.btn-label{transition:all .3s ease}.panel-btn:hover i{transform:scale(1.1)}#toggleEditPreviewBtn{background:linear-gradient(135deg,#4361ee,#3f37c9);color:var(--text-on-primary);border-radius:20px;padding:8px 15px}#toggleEditPreviewBtn:hover{background:linear-gradient(135deg,#3f37c9,#4361ee)}.session-item-details{margin-bottom:8px;list-style:none}.session-item-details summary{list-style:none;cursor:pointer;outline:none;padding:12px 15px;border-radius:6px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;transition:var(--transition);position:relative}.session-item-details summary::-webkit-details-marker{display:none}.session-item-details summary:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item-details summary.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item-details summary .name:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900;margin-right:10px;transition:transform .2s ease-in-out;display:inline-block;color:var(--text-tertiary)}.session-item-details[open]>summary .name:before{transform:rotate(90deg)}.h2-item{padding-left:40px;border-left:2px solid var(--border-color);margin-left:15px}.h2-item .name i{color:var(--text-secondary)}.nested-items{margin-left:0;padding-left:0;border-left:none}@keyframes highlight{0%{background:#fff9c4}to{background:linear-gradient(120deg,#a1c4fd,#c2e9fb)}}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes slide-in{0%{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}@media (max-width: 1400px){.btn-label{opacity:0;width:0;margin:0;padding:0}}@media (max-width: 1200px){body{flex-direction:column;height:auto;min-height:100vh}.sidebar{position:relative;width:100%;min-height:auto;flex-direction:row;align-items:center;background:var(--sidebar-bg)}.app-nav{flex-direction:row;padding:15px;flex:1;justify-content:center;background:#0000001a;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.app-nav-btn{margin:0 4px}.main-content{margin-left:0}.main-layout{flex-direction:column}.session-sidebar{width:100%;max-width:100%;max-height:40vh}.app-container{min-width:100%}.mistakes-nav{width:100%;max-width:100%}}@media (max-width: 992px){.mistakes-nav{max-height:40vh;min-width:0}}@media (max-width: 768px){.panel-header{flex-direction:column;align-items:flex-start;gap:10px;height:auto;padding:10px}.panel-actions{width:100%;justify-content:flex-end;flex-wrap:wrap}.editor-toolbar{flex-direction:column;gap:10px}.toolbar-left,.toolbar-middle,.toolbar-right{width:100%;justify-content:center}.panel-header .panel-title,.panel-actions{justify-content:center}.app-nav{flex-wrap:wrap}}.cloze.cloze-error-duplicate{border:2px solid var(--danger-color, #EF4444)!important;background-color:var(--danger-light, #FEE2E2)!important;animation:pulse-error 1s infinite alternate}.cloze.cloze-error-duplicate .placeholder{color:var(--danger-color, #EF4444)!important;font-weight:700}@keyframes pulse-error{0%{box-shadow:0 0 #ef444466}to{box-shadow:0 0 0 5px #ef444400}}#settings-view.main-layout{display:flex;gap:20px;height:100%;flex:1}.settings-nav-panel{width:280px;flex-shrink:0;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--border-radius);box-shadow:var(--shadow-sm);display:flex;flex-direction:column}.settings-nav-header{padding:20px;border-bottom:1px solid var(--border-color)}.settings-nav-header h3{font-size:var(--text-xl);color:var(--text-primary)}.settings-nav-list{padding:10px;overflow-y:auto;flex:1}.settings-nav-group{margin-bottom:20px}.settings-nav-group-title{padding:10px;font-size:var(--text-sm);font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}.add-item-btn{width:calc(100% - 20px);margin:0 10px 10px;padding:8px;background:var(--primary-light);color:var(--primary-color);border:1px dashed var(--primary-color);border-radius:6px;cursor:pointer;text-align:center;font-weight:600;transition:var(--transition)}.add-item-btn:hover{background:var(--primary-color);color:var(--text-on-primary);border-style:solid}.settings-nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:6px;cursor:pointer;transition:background-color .2s ease,color .2s ease;color:var(--text-secondary);font-weight:500;margin-bottom:4px}.settings-nav-item i{width:20px;text-align:center;color:var(--gray-400)}.settings-nav-item:hover{background-color:var(--bg-secondary);color:var(--text-primary)}.settings-nav-item.active{background-color:var(--primary-color);color:var(--text-on-primary);box-shadow:0 4px 8px #5b66f533}.settings-nav-item.active i{color:var(--text-on-primary)}.settings-detail-panel{flex:1;min-width:0;height:100%;display:flex;flex-direction:column}.settings-detail-panel .panel-content{flex-grow:1;overflow-y:auto}.placeholder-content{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center}.tags-input-container{display:flex;flex-direction:column;border:1px solid var(--border-color);border-radius:6px;padding:5px;background:var(--bg-primary)}.tags-input-container:focus-within{border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.tags-list{display:flex;flex-wrap:wrap;gap:8px;list-style:none;padding:5px}.tags-list li{background-color:var(--primary-color);color:var(--text-on-primary);padding:6px 12px;border-radius:20px;font-size:var(--text-sm);display:flex;align-items:center;gap:8px}.remove-tag-btn{background:none;border:none;color:var(--text-on-primary);cursor:pointer;font-size:1.2em;line-height:1;opacity:.7;padding:0}.remove-tag-btn:hover{opacity:1}.config-tags-input{border:none!important;box-shadow:none!important;flex-grow:1;padding:8px 7px!important}.config-tags-input:focus{outline:none}.form-checkbox-label{display:inline-flex;align-items:center;cursor:pointer;gap:10px}.form-checkbox-label input[type=checkbox]{width:1.2em;height:1.2em}.agent-filters{display:flex;align-items:center;gap:15px;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid var(--border-color)}.filter-btn{padding:8px 16px;border-radius:20px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-secondary);cursor:pointer;font-weight:500;transition:var(--transition)}.filter-btn:hover{background:var(--gray-100)}.filter-btn.active{background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-color)}.filter-group{display:flex;align-items:center;gap:8px}.filter-group label{font-weight:500;color:var(--text-secondary)}#tag-filter,.role-selector{padding:8px 15px;border-radius:20px;border:1px solid var(--border-color);font-size:.9rem;background:var(--bg-primary);color:var(--text-primary)}#tag-filter:focus,.role-selector:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.topics-header{display:flex;justify-content:space-between;align-items:center}.topic-actions .edit-topic-btn{background:#fff3;border:none;color:var(--text-on-primary);width:32px;height:32px;border-radius:50%;cursor:pointer;transition:var(--transition)}.topic-actions .edit-topic-btn:hover{background:#fff6;transform:scale(1.1)}</style>
</head>
<body>
    <!-- 左侧导航栏 -->
    <div class="sidebar">
        
        <nav class="app-nav">
            <a href="#" class="app-nav-btn active" data-view="anki" id="nav-anki" title="Anki 笔记">
                <i class="fas fa-layer-group"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="mistakes" id="nav-mistakes" title="错题本">
                <i class="fas fa-book"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="agent" id="nav-agents" title="AI角色">
                <i class="fas fa-robot"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="settings" id="nav-settings" title="设置">
                <i class="fas fa-cog"></i>
            </a>
        </nav>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
            <!-- 1. 创建一个新的内容包装器 -->
    <div class="content-wrapper">
        <!-- AI Agent导航栏 (此部分在初始视图中可能隐藏) -->
        <nav class="ai-agent-nav">
            <div class="nav-title">
                <i class="fas fa-robot"></i> AI Agent管理
            </div>
    <div class="agent-filters">
        <div class="filter-group">
            <button class="filter-btn active" data-filter="all">所有角色</button>
            <button class="filter-btn" data-filter="tagged">按标签筛选</button>
        </div>
        <div class="filter-group" id="tag-filter-container" style="display: none;">
            <label for="tag-filter">标签:</label>
            <select id="tag-filter" class="form-control"></select>
        </div>
    </div>

            <div class="agent-list">
                <div class="agent-item active" data-agent="1">
                    <div class="agent-avatar">AI</div>
                    <span>数学学习助手</span>
                </div>
                <div class="agent-item" data-agent="2">
                    <div class="agent-avatar">MD</div>
                    <span>语言学习助手</span>
                </div>
                <div class="agent-item" data-agent="3">
                    <div class="agent-avatar">CS</div>
                    <span>计算机科学助手</span>
                </div>
                <div class="agent-item">
                    <div class="agent-avatar">+</div>
                    <span>添加新Agent</span>
                </div>
            </div>
            <div class="nav-actions">
                <button class="nav-action-btn">
                    <i class="fas fa-history"></i> 历史记录
                </button>
                <button class="nav-action-btn">
                    <i class="fas fa-cog"></i> 设置
                </button>
            </div>
        </nav>

        <!-- AI Agent内容区域 (此部分在初始视图中可能隐藏) -->
        <div class="agent-content-container main-layout" id="agent-view">
            <div class="topics-panel">
                <div class="topics-header">
                    <i class="fas fa-book"></i> 聊天主题
                </div>
    <div class="topic-actions">
        <button id="editTopicBtn" class="edit-topic-btn" title="重命名当前主题" style="display: none;"><i class="fas fa-pencil-alt"></i></button>
    </div>
                <div class="topics-content">
                    <ul class="topic-list">
                        <li class="topic-item active">
                            <div class="topic-icon"><i class="fas fa-calculator"></i></div>
                            <span>线性代数</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-infinity"></i></div>
                            <span>微积分</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-project-diagram"></i></div>
                            <span>概率统计</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-cube"></i></div>
                            <span>几何学</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-plus-circle"></i></div>
                            <span>添加新主题</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="history-panel">
                <div class="history-header">
                    <div class="history-title">
                        <i class="fas fa-comments"></i>
                        <span id="historyHeaderTitle">历史对话记录</span>
                    </div>
                    <div class="history-header-actions">
                        <input type="text" class="history-search" placeholder="搜索历史记录...">
    <!-- [新增] 对话角色选择器 -->
    <select id="conversationRoleSelector" class="role-selector" title="选择本次对话使用的角色">
        <!-- Options will be populated by JS -->
    </select>

                    </div>
                </div>
                <div class="history-content">
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-15 14:30</span>
                            <span>线性代数 - 矩阵运算</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 请解释矩阵的逆是什么？</p>
                            <p><strong>AI助手:</strong> 矩阵的逆类似于数字的倒数。对于一个n×n矩阵A，如果存在另一个n×n矩阵B，使得AB = BA = I（单位矩阵），那么B就是A的逆矩阵，记作A⁻¹。只有方阵且行列式不为零的矩阵才有逆矩阵。</p>
                            <img src="https://via.placeholder.com/600x150/4361ee/ffffff?text=矩阵逆运算示例" alt="矩阵逆运算示例">
                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                </div>
                <div class="chat-navigation">
                    <button id="chatNavUp" class="chat-nav-btn" title="上一轮对话"><i class="fas fa-arrow-up"></i></button>
                    <button id="chatNavDown" class="chat-nav-btn" title="下一轮对话"><i class="fas fa-arrow-down"></i></button>
                </div>
                <!-- ==================== 新增的聊天输入区域 ==================== -->
                <div class="chat-input-area">
                    <div class="attachment-preview-container" id="attachmentPreview"></div>
                    <div class="input-controls">
                        <textarea id="chatInput" class="chat-textarea" rows="3" placeholder="输入消息... (Shift + Enter 换行)"></textarea>
                        <!-- 隐藏的文件输入框，通过JS点击附件按钮来触发 -->
                        <input type="file" id="attachmentInput" multiple style="display: none;">
                        <button id="attachFileBtn" class="chat-action-btn" title="添加附件" onclick="document.getElementById('attachmentInput').click();">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button id="sendMessageBtn" class="chat-action-btn send" title="发送">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <!-- ==================== 聊天输入区域结束 ==================== -->
            </div>
        </div>

        <!-- Anki 笔记视图 (此部分在初始视图中可能隐藏) -->
        <div class="main-layout" id="anki-view" style="display: none;">
            <div class="session-sidebar">
                <div class="session-header">
                    <div class="session-title">
                        <span><i class="fas fa-layer-group"></i> 会话管理</span>
                    </div>
                    <div class="session-controls">
                        <button id="newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                        <button id="newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                        <button id="openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                        <button id="moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                        <button id="deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="select-controls">
                        <label class="select-all">
                            <input type="checkbox" id="selectAllCheckbox"> 全选
                        </label>
                    </div>
                    <div class="current-folder" id="currentFolderContainer"></div>
                </div>
                <div class="session-content">
                    <div class="session-list-container">
                        <ul class="session-list" id="sessionList"></ul>
                        <div class="empty-session" id="emptySession">
                            <i class="fas fa-folder-open"></i>
                            <p>没有打开的会话</p>
                            <p>点击"新建文件"或"打开文件"开始</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-container">
                <div class="editor-preview-panel">
                    <!-- 1. 添加了标准的 panel-header -->
                    <div class="panel-header">
                        <!-- 1. 左侧的按钮容器 -->
                        <div class="panel-actions-leading">
        <button id="toggleSessionBtn" class="panel-btn" title="显示/隐藏会话栏"><i class="fas fa-bars"></i></button>
                            <button id="toggleEditPreviewBtn" class="panel-btn panel-btn-text">
                                <i class="fas fa-book-open"></i> Preview
                            </button>
                        </div>

                        <div class="panel-title">
                            <i class="fas fa-edit"></i> Anki 编辑器
                        </div>
                        <div class="panel-actions">
                            <!-- 复习按钮组也可以放在这里，或者放在 header actions 里，这里放在子工具栏更符合“编辑”上下文 -->
                            <div class="review-btn-group" style="margin-left: auto;">

                                <button id="startReviewBtn" class="panel-btn panel-btn-text">
                                    <i class="fas fa-play-circle"></i> 复习 (<span id="reviewCount">0</span>)
                                </button>
                                <button id="reviewOptionsBtn" class="panel-btn dropdown-toggle">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="reviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                    <a href="#" id="customStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
                                    <a href="#" id="showStatsBtn"><i class="fas fa-chart-line"></i> 统计</a>
                                </div>
                            </div>
                            <button id="toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏">
                                <i class="fas fa-eye-eye"></i>
                            </button>
                            <button id="invertClozeBtn" class="panel-btn" title="反向显示/隐藏">
                                <i class="fas fa-random"></i>
                            </button>
                            <button id="saveBtn" class="panel-btn panel-btn-text" title="保存"><i class="fas fa-save"></i>
                            </button>
                            <button id="exportFileBtn" class="panel-btn panel-btn-text" title="导出"><i
                                    class="fas fa-download"></i> </button>
                            <!-- [MODIFIED] Added Print Button -->
                            <button id="printPreviewBtn" class="panel-btn panel-btn-text" title="打印预览内容" disabled>
                                <i class="fas fa-print"></i>
                            </button>
                            <button id="toggleEditorBtn" class="panel-btn collapse-btn" title="收起/展开编辑器">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                    </div>

                    <div class="panel-content">
        <!-- 编辑模式下的工具栏 -->
        <div class="editor-sub-toolbar" id="editorToolbar">
            <button id="clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
            <button id="boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
            <button id="italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
            <button id="insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
            <button id="codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
            <button id="linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
            <button id="audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
        </div>

        <!-- 编辑器容器 -->
        <div class="editor-container" id="editorContainer">
                            <textarea id="editor"
                                class="editor"># Anki MD管理系统

## 使用说明

### 目录结构
- 创建目录来组织您的会话
- 在目录中创建文件
- 将文件移动到不同的目录

### 操作指南
1. 点击"新建目录"按钮创建新目录
2. 选择一个目录后，新建的文件会自动放入该目录
3. 使用移动按钮将项目移动到其他目录
4. 选中目录时会选中其下所有内容
5. 删除目录时会删除其下所有内容

### 数学公式示例
行内公式：\\( E = mc^2 \\)

块级公式：
\\[ 
x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} 
\\]

### Cloze 记忆卡片
牛顿第二定律：--\\( F = ma \\)--
量子力学基础：--\\( \psi = \psi(x,t) \\)--
相对论：--\\( E = \gamma m c^2 \\)--
电磁学：--\\( \nabla \times \mathbf{B} = \mu_0 \mathbf{J} + \mu_0 \epsilon_0 \frac{\partial \mathbf{E}}{\partial t} \\)--</textarea>

                        <div id="preview"></div>
                        </div>

        <!-- 模式指示器 -->
                        <div class="mode-indicator">
                            <div class="mode-dot active" id="editModeDot" title="编辑模式"></div>
                            <div class="mode-dot" id="previewModeDot" title="预览模式"></div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- ====================================================== -->
            <!--          [MODIFIED] 错题本视图 (应用所有修改)           -->
            <!-- ====================================================== -->
            <div id="mistakes-view" class="main-layout" style="display: none;">

                <!-- [MODIFIED] 错题本侧边栏 -->
                <div class="session-sidebar">
                    <div class="session-header">
                        <div class="session-title">
                            <span><i class="fas fa-book-open"></i> 错题筛选与导航</span>
                        </div>
                    </div>

                    <div class="session-content">
                        <!-- 筛选区域 -->
                        <!-- [MODIFIED] 将 .filter-section 改为 .session-header -->
                        <div class="session-header">
                            <!-- [MODIFIED] 将 .filter-controls 改为 .session-controls -->
                            <div class="session-controls">
                                <select id="subject-filter"></select>
                                <!-- [MODIFIED] 统一所有按钮的样式为 session-btn -->
                                <button id="refresh-mistakes-btn" class="session-btn" title="刷新"><i
                                        class="fas fa-sync-alt"></i></button>
                                <button id="newMistakeFileBtn" class="session-btn" title="新建错题文件"><i
                                        class="fas fa-file-alt"></i></button>
                                <button id="load-yaml-btn" class="session-btn" title="导入YAML文件"><i
                                        class="fas fa-file-upload"></i></button>
                                <input type="file" id="yaml-file-input" accept=".yml,.yaml" style="display: none;">
                            </div>
                            <div class="filter-group" data-type="tags">
                                <div class="tag-list"></div>
                            </div>
                            <div class="filter-group" data-type="reasons">
                                <div class="tag-list"></div>
                            </div>
                        </div>


                        <!-- 错题列表容器 -->
                        <div class="mistakes-list-container">
                            <div class="list-header"><i class="fas fa-list-ul"></i> 待复习列表 (按到期日排序)</div>
                            <ul class="session-list" id="mistakes-list">
                                <!-- 错题列表项将由JS动态生成 -->
                            </ul>
                            <div class="pagination">
                                <!-- 分页按钮将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [MODIFIED] 错题本主内容区 -->
                <div class="app-container">
                    <!-- 统计仪表盘 -->
                    <div id="statistics-dashboard" class="stats-dashboard">
                        <!-- 统计卡片将由JS动态生成 -->
                    </div>

                    <!-- YAML 编辑器面板 -->
                    <div id="mistake-editor-panel" class="panel editor-panel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                            <button id="mistakeToggleSessionBtn" class="panel-btn" title="显示/隐藏筛选栏"><i class="fas fa-bars"></i></button>
                            </div>
                            <div class="panel-title"><i class="fas fa-code"></i> YAML 编辑器</div>
                            <div class="panel-actions">
                            <button id="mistakeSaveBtn" class="panel-btn" title="保存并刷新"><i class="fas fa-save"></i></button>
                            <button id="mistakeExportBtn" class="panel-btn" title="导出YAML"><i class="fas fa-download"></i></button>
                                <button class="panel-btn collapse-btn" id="mistakeCollapseBtn" title="收起/展开">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <textarea id="yaml-editor" placeholder="在此处粘贴或编辑您的YAML格式错题..."></textarea>
                        </div>
                    </div>

                    <!-- 错题预览面板 -->
                    <div id="mistakes-preview-panel" class="panel preview-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-eye"></i> 错题预览</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="mistakeStartReviewBtn" class="editor-btn editor-btn-text">
                                        <i class="fas fa-play-circle"></i> 开始复习
                                    </button>
                                    <button id="mistakeReviewOptionsBtn" class="editor-btn dropdown-toggle">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div id="mistakeReviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                    <a href="#" id="mistakeCustomStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div id="mistakes-preview" class="mistakes-preview-container">
                                <!-- 错题预览卡片将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 错题本视图结束 -->

            <!-- ====================================================== -->
            <!--                  [新增] 设置视图                     -->
            <!-- ====================================================== -->
            <div id="settings-view" class="main-layout" style="display: none;">
                <!-- 内容将由 JavaScript 从模板动态填充 -->
            </div>
            <!-- 设置视图结束 -->

        <!-- ====================================================== -->
        <!--          [重构后] 统一的设置布局模板                   -->
        <!-- ====================================================== -->
        <template id="settings-layout-template">
            <div class="settings-nav-panel">
                <div class="settings-nav-header">
                    <h3><i class="fas fa-sliders-h"></i> 设置</h3>
                </div>
                <div class="settings-nav-list">
                    <!-- 导航项将由JS动态填充 -->
                </div>
            </div>
            <div class="settings-detail-panel">
                <div class="panel" style="height: 100%;"> <!-- 确保面板占满高度 -->
                    <div class="panel-header">
                        <div id="settings-detail-title" class="panel-title">
                            <!-- 标题由JS填充 -->
                        </div>
                        <div class="panel-actions">
                            <button id="settings-save-btn" class="panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button>
                        </div>
                    </div>
                    <div id="settings-detail-content" class="panel-content" style="padding: 25px; overflow-y: auto;">
                         <div class="placeholder-content">
                            <i class="fas fa-cogs fa-3x" style="color: var(--gray-300);"></i>
                            <p style="margin-top: 15px; color: var(--text-tertiary);">从左侧选择一个项目进行配置</p>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- ====================================================== -->
        <!--          [重构后] 全局应用设置表单模板                  -->
        <!-- ====================================================== -->
        <template id="general-settings-form-template">
            <div data-id="general" data-type="general">
                            <!-- 主题设置区域 -->
                            <div class="settings-section">
                                <h3 class="settings-section-title">外观与主题</h3>
                                <div class="form-group">
                                    <label for="theme-selector">选择一个主题</label>
                                    <select id="theme-selector" class="form-control">
                                        <option value="">默认 (亮色)</option>
                                        <option value="dark">暗黑模式</option>
                                        <option value="large-font">大号字体</option>
                                        <option value="larger-font">更大号字体</option>
                                    </select>
                                    <p class="form-text" style="margin-top: 8px; font-size: var(--text-sm); color: var(--text-secondary);">
                                        改变应用程序的视觉主题。
                                    </p>
                                </div>
                            </div>

                            <!-- 数据与同步设置区域 -->
                            <div class="settings-section">
                                <h3 class="settings-section-title">数据与同步</h3>
                                <div class="form-group">
                                    <label for="autosave-interval">自动保存间隔 (分钟)</label>
                                    <input type="number" id="autosave-interval" class="form-control" min="0" value="5">
                                    <p class="form-text">
                                        数据将按此时间间隔自动保存到本地数据库。设置为 0 可禁用自动保存。
                                    </p>
                                </div>
                            </div>

                            <!-- 导入/导出按钮 -->
                    <div class="form-group">
                                <label>数据库同步</label>
                                <div style="display: flex; gap: 15px;">
                                    <button id="export-db-btn" class="btn-secondary" style="flex: 1;"><i class="fas fa-download"></i> 导出数据</button>
                                    <button id="import-db-btn" class="btn-danger" style="flex: 1;"><i class="fas fa-upload"></i> 导入数据</button>
                                </div>
                                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                                <p class="form-text">
                                    导出所有数据到一个JSON文件。导入文件将会覆盖当前所有数据，请谨慎操作。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

			<!-- ====================================================== -->
			<!--            [新增] 所有设置项的主从布局模板             -->
			<!-- ====================================================== -->
			<template id="settings-layout-template">
			    <div class="settings-nav-panel">
			        <div class="settings-nav-header">
			            <h3>配置项</h3>
			        </div>
			        <div class="settings-nav-list">
			            <!-- 列表项将由JS动态填充 -->
			        </div>
			    </div>
			    <div class="settings-detail-panel">
			        <div class="panel">
			            <div class="panel-header">
			                <div id="settings-detail-title" class="panel-title">
			                    <i class="fas fa-arrow-left"></i> 请选择一个配置项
			                </div>
			                <div class="panel-actions">
			                    <button id="settings-save-btn" class="panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button>
			                </div>
			            </div>
			            <div id="settings-detail-content" class="panel-content" style="padding: 25px; overflow-y: auto;">
			                <div class="placeholder-content">
			                    <i class="fas fa-cogs"></i>
			                    <p>从左侧选择一个项目进行编辑，或添加一个新项目。</p>
			                </div>
			            </div>
			        </div>
			    </div>
			</template>

<!-- ====================================================== -->
<!--            [新增] API 配置表单模板                  -->
<!-- ====================================================== -->
<template id="api-config-form-template">
    <div data-id="" data-type="apiConfig">
        <form id="api-config-form-dynamic" novalidate>
            <input type="hidden" class="config-id">
            <div class="form-group">
                <label>配置名称 (如 DeepSeek, OpenAI)</label>
                <input type="text" class="config-name form-control" required placeholder="例如：我的 DeepSeek Key">
            </div>
             <div class="form-group">
                <label>提供商</label>
                <select class="config-provider form-control" required></select>
            </div>
            <div class="form-group">
                <label>API 地址</label>
                <input type="url" class="config-apiUrl form-control" placeholder="会自动填充，也可自定义">
            </div>
            <div class="form-group">
                <label>API Key</label>
                <div class="input-group">
                    <input type="password" class="config-apiKey form-control">
                    <button type="button" class="toggle-api-key-visibility input-group-btn" title="显示/隐藏"><i class="fas fa-eye"></i></button>
                </div>
            </div>
            <div class="form-group">
                <label>Models (格式: 别名:模型名, 多个用逗号隔开)</label>
                <textarea class="config-models form-control" rows="3" placeholder="例如: chat:deepseek-chat, code:deepseek-coder"></textarea>
                <p class="form-text">为长模型名设置一个简短的别名，方便在角色配置中选择。</p>
            </div>
            <div class="settings-detail-footer">
                <button type="button" class="btn btn-danger delete-item-btn">删除此 API 配置</button>
            </div>
        </form>
    </div>
</template>


<!-- ====================================================== -->
<!--            [新增] 角色(Prompt)配置表单模板            -->
<!-- ====================================================== -->
<template id="agent-form-template">
    <div data-id="" data-type="agent">
        <form id="agent-form-dynamic" novalidate>
            <input type="hidden" class="config-id">
            <div class="form-group">
                <label>角色名称</label>
                <input type="text" class="config-name form-control" required placeholder="例如：南京历史导游">
            </div>
            <div class="form-group">
                <label>头像 (2个字符)</label>
                <input type="text" class="config-avatar form-control" required maxlength="2" placeholder="例如: 史, 导">
            </div>
            <div class="form-group">
                <label>选择模型</label>
                <select class="config-model form-control" required>
                    <!-- 选项将由JS动态生成 -->
                </select>
                <p class="form-text">此列表来源于您已配置的 API。</p>
            </div>
            <div class="form-group">
                <label>System Prompt (系统提示词)</label>
                <textarea class="config-systemPrompt form-control" rows="8" placeholder="定义角色的行为、知识范围和说话风格..."></textarea>
            </div>
            <div class="form-group">
<div class="form-group">
    <label>标签 (输入后按回车添加)</label>
    <div class="tags-input-container">
        <ul class="tags-list"></ul>
        <input type="text" class="config-tags-input form-control" placeholder="例如：学习, 编程...">
    </div>
    <p class="form-text">为角色分类，便于在 AI 界面筛选。</p>
</div>

<div class="form-group">
    <label class="form-checkbox-label">
        <input type="checkbox" class="config-sendHistory">
        <span>发送历史上下文</span>
    </label>
    <p class="form-text">如果不勾选，AI 将只接收到 System Prompt 和当前问题，实现“无记忆”对话。</p>
</div>

                <label>欢迎语 (可选, 支持HTML)</label>
                <textarea class="config-hint form-control" rows="3" placeholder="例如: 您好！我是您的南京历史导游，有什么可以帮您的吗？"></textarea>
            </div>
            <div class="settings-detail-footer">
                <button type="button" class="btn btn-danger delete-item-btn">删除此角色</button>
            </div>
        </form>
    </div>
</template>


            
            <input type="file" id="fileInput" class="file-input" accept=".md, .txt" multiple>

            <div class="move-modal" id="moveModal">
                <div class="move-modal-content">
                    <div class="move-modal-header">
                        <div class="move-modal-title">移动到目录</div>
                        <button class="move-modal-close" id="closeMoveModalBtn">×</button>
                    </div>
                    <p>请选择目标目录：</p>
                    <div class="folder-list" id="folderList"></div>
                    <div class="move-modal-actions">
                        <button class="move-modal-btn cancel" id="cancelMoveBtn">取消</button>
                        <button class="move-modal-btn confirm" id="confirmMoveBtn">确认移动</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
            <div class="footer">
                <p>© 2024 Anki MD管理系统 | 数据保存在浏览器本地存储中</p>
            </div>
            

        <!-- ====================================================== -->
        <!--          AUDIO PLAYING                                 -->
        <!-- ====================================================== -->
        <div class="audio-controls" id="audioControls">
            <div class="audio-title" id="audioTitle">音频播放</div>
            <div class="audio-progress">
                <div class="audio-progress-bar" id="audioProgress"></div>
            </div>
            <div class="audio-buttons">
                <button class="audio-btn" id="playBtn"><i class="fas fa-play"></i> 播放</button>
                <button class="audio-btn" id="pauseBtn"><i class="fas fa-pause"></i> 暂停</button>
                <button class="audio-btn" id="stopBtn"><i class="fas fa-stop"></i> 停止</button>
            </div>
        </div>

        <!-- [NEW] 自定义复习模态框 -->
        <div class="modal-overlay" id="customStudyModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>自定义复习会话</h2>
                    <button class="modal-close" id="customStudyCloseBtn">×</button>
                </div>
                <div class="modal-body">
                    <form id="customStudyForm">
                        <div class="form-group">
                            <label for="filterByFile">按文件/目录筛选:</label>
                            <select id="filterByFile" class="form-control">
                                <option value="all">所有文件</option>
                                <!-- 选项将由JS动态填充 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>按卡片状态筛选:</label>
                            <div class="form-checkbox-group">
                                <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                                <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                                <label><input type="checkbox" name="cardState" value="review" checked> 复习中</label>
                                <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>按最后一次复习时间筛选:</label>
                            <select id="filterByLastReview" class="form-control">
                                <option value="any">任何时间</option>
                                <option value="last7days">最近7天内</option>
                                <option value="last30days">最近30天内</option>
                                <option value="over30days">超过30天未复习</option>
                                <option value="never">从未复习过 (新卡片)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxCards">最大卡片数量:</label>
                            <input type="number" id="maxCards" class="form-control" value="50" min="1">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="customStudyCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="startCustomStudyBtn" form="customStudyForm">开始自定义复习</button>
                </div>
            </div> <!-- <--- 新增的闭合标签，用于关闭 .modal-content -->
        </div> <!-- <--- 新增的闭合标签，用于关闭 .modal-overlay#customStudyModal -->

    <!-- [新增] 统计模态框 -->
    <div class="modal-overlay" id="statsModal" style="display: none;">
        <div class="modal-content large"> <!-- 添加一个 'large' 类以获得更宽的模态框 -->
            <div class="modal-header">
                <h2>复习统计</h2>
                <button class="modal-close" id="statsModalCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <p>近30天每日复习卡片数量统计</p>
                <div class="chart-container" style="position: relative; height:60vh; width:100%">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>
            </div>
        </div>
</body>
</html>
