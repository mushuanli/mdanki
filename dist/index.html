<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
  <script type="module" crossorigin>import{marked as rr}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();const De=n=>document.querySelector(n),oe=n=>document.getElementById(n),or=oe("anki-view"),Vo=oe("agent-view"),Ho=oe("mistakes-view"),Bs=document.querySelector(".ai-agent-nav");let va={activeView:"anki",sessions:[],folders:[],clozeStates:{},fileSubsessions:{},currentSessionId:null,currentFolderId:null,currentSubsessionId:null,folderStack:[],agents:[],topics:[],history:[],currentAgentId:null,currentTopicId:null,isLoading:!0,isAiThinking:!1,isSessionSidebarHidden:!1,areAllClozeVisible:!1,movingItems:[],selectedMoveTarget:null};const x=new Proxy(va,{get(n,e){if(e in n){const t=n[e];return typeof t=="object"&&t!==null?JSON.parse(JSON.stringify(t)):t}},set(){return console.warn("Direct mutation of appState is not allowed. Use a data service function."),!1}});function ae(n){Object.assign(va,n)}const zo=10*60*1e3,_l=2.5;function ba(n,e){const t=Date.now();let{interval:s=0,easeFactor:r=_l,state:a="new"}=n;if(a==="new"||a==="learning")switch(e){case 0:return{due:t+zo,interval:0,easeFactor:r,state:"learning"};case 1:return{due:t+1*24*3600*1e3,interval:1,easeFactor:r,state:"review"};case 2:return{due:t+3*24*3600*1e3,interval:3,easeFactor:r,state:"review"};case 3:return{due:t+5*24*3600*1e3,interval:5,easeFactor:r,state:"review"}}switch(e){case 0:return r=Math.max(1.3,r-.2),{due:t+zo,interval:0,easeFactor:r,state:"learning"};case 1:s=Math.max(1,s*1.2),r=Math.max(1.3,r-.15);break;case 2:break;case 3:r+=.15;break}const l=Math.max(s+1,s*r);return{due:t+l*24*3600*1e3,interval:l,easeFactor:r,state:"review"}}var Yo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function El(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var wa={exports:{}};(function(n,e){(function(t,s){n.exports=s()})(Yo,function(){var t=function(i,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,u){c.__proto__=u}||function(c,u){for(var f in u)Object.prototype.hasOwnProperty.call(u,f)&&(c[f]=u[f])})(i,o)},s=function(){return(s=Object.assign||function(i){for(var o,c=1,u=arguments.length;c<u;c++)for(var f in o=arguments[c])Object.prototype.hasOwnProperty.call(o,f)&&(i[f]=o[f]);return i}).apply(this,arguments)};function r(i,o,c){for(var u,f=0,h=o.length;f<h;f++)!u&&f in o||((u=u||Array.prototype.slice.call(o,0,f))[f]=o[f]);return i.concat(u||Array.prototype.slice.call(o))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Yo,l=Object.keys,d=Array.isArray;function p(i,o){return typeof o!="object"||l(o).forEach(function(c){i[c]=o[c]}),i}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var y=Object.getPrototypeOf,B={}.hasOwnProperty;function I(i,o){return B.call(i,o)}function P(i,o){typeof o=="function"&&(o=o(y(i))),(typeof Reflect>"u"?l:Reflect.ownKeys)(o).forEach(function(c){F(i,c,o[c])})}var M=Object.defineProperty;function F(i,o,c,u){M(i,o,p(c&&I(c,"get")&&typeof c.get=="function"?{get:c.get,set:c.set,configurable:!0}:{value:c,configurable:!0,writable:!0},u))}function O(i){return{from:function(o){return i.prototype=Object.create(o.prototype),F(i.prototype,"constructor",i),{extend:P.bind(null,i.prototype)}}}}var $=Object.getOwnPropertyDescriptor,G=[].slice;function W(i,o,c){return G.call(i,o,c)}function Z(i,o){return o(i)}function Q(i){if(!i)throw new Error("Assertion Failed")}function te(i){a.setImmediate?setImmediate(i):setTimeout(i,0)}function ee(i,o){if(typeof o=="string"&&I(i,o))return i[o];if(!o)return i;if(typeof o!="string"){for(var c=[],u=0,f=o.length;u<f;++u){var h=ee(i,o[u]);c.push(h)}return c}var m=o.indexOf(".");if(m!==-1){var g=i[o.substr(0,m)];return g==null?void 0:ee(g,o.substr(m+1))}}function ce(i,o,c){if(i&&o!==void 0&&!("isFrozen"in Object&&Object.isFrozen(i)))if(typeof o!="string"&&"length"in o){Q(typeof c!="string"&&"length"in c);for(var u=0,f=o.length;u<f;++u)ce(i,o[u],c[u])}else{var h,m,g=o.indexOf(".");g!==-1?(h=o.substr(0,g),(m=o.substr(g+1))===""?c===void 0?d(i)&&!isNaN(parseInt(h))?i.splice(h,1):delete i[h]:i[h]=c:ce(g=!(g=i[h])||!I(i,h)?i[h]={}:g,m,c)):c===void 0?d(i)&&!isNaN(parseInt(o))?i.splice(o,1):delete i[o]:i[o]=c}}function J(i){var o,c={};for(o in i)I(i,o)&&(c[o]=i[o]);return c}var Se=[].concat;function He(i){return Se.apply([],i)}var Tt="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(He([8,16,32,64].map(function(i){return["Int","Uint","Float"].map(function(o){return o+i+"Array"})}))).filter(function(i){return a[i]}),tt=new Set(Tt.map(function(i){return a[i]})),ye=null;function Je(i){return ye=new WeakMap,i=function o(c){if(!c||typeof c!="object")return c;var u=ye.get(c);if(u)return u;if(d(c)){u=[],ye.set(c,u);for(var f=0,h=c.length;f<h;++f)u.push(o(c[f]))}else if(tt.has(c.constructor))u=c;else{var m,g=y(c);for(m in u=g===Object.prototype?{}:Object.create(g),ye.set(c,u),c)I(c,m)&&(u[m]=o(c[m]))}return u}(i),ye=null,i}var Uc={}.toString;function bi(i){return Uc.call(i).slice(8,-1)}var wi=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Vc=typeof wi=="symbol"?function(i){var o;return i!=null&&(o=i[wi])&&o.apply(i)}:function(){return null};function It(i,o){return o=i.indexOf(o),0<=o&&i.splice(o,1),0<=o}var Yt={};function nt(i){var o,c,u,f;if(arguments.length===1){if(d(i))return i.slice();if(this===Yt&&typeof i=="string")return[i];if(f=Vc(i)){for(c=[];!(u=f.next()).done;)c.push(u.value);return c}if(i==null)return[i];if(typeof(o=i.length)!="number")return[i];for(c=new Array(o);o--;)c[o]=i[o];return c}for(o=arguments.length,c=new Array(o);o--;)c[o]=arguments[o];return c}var ki=typeof Symbol<"u"?function(i){return i[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Tn=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Re=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Tn),Hc={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Gt(i,o){this.name=i,this.message=o}function co(i,o){return i+". Errors: "+Object.keys(o).map(function(c){return o[c].toString()}).filter(function(c,u,f){return f.indexOf(c)===u}).join(`
`)}function is(i,o,c,u){this.failures=o,this.failedKeys=u,this.successCount=c,this.message=co(i,o)}function Jt(i,o){this.name="BulkError",this.failures=Object.keys(o).map(function(c){return o[c]}),this.failuresByPos=o,this.message=co(i,this.failures)}O(Gt).from(Error).extend({toString:function(){return this.name+": "+this.message}}),O(is).from(Gt),O(Jt).from(Gt);var Si=Re.reduce(function(i,o){return i[o]=o+"Error",i},{}),zc=Gt,ne=Re.reduce(function(i,o){var c=o+"Error";function u(f,h){this.name=c,f?typeof f=="string"?(this.message="".concat(f).concat(h?`
 `+h:""),this.inner=h||null):typeof f=="object"&&(this.message="".concat(f.name," ").concat(f.message),this.inner=f):(this.message=Hc[o]||c,this.inner=null)}return O(u).from(zc),i[o]=u,i},{});ne.Syntax=SyntaxError,ne.Type=TypeError,ne.Range=RangeError;var lo=Tn.reduce(function(i,o){return i[o+"Error"]=ne[o],i},{}),rs=Re.reduce(function(i,o){return["Syntax","Type","Range"].indexOf(o)===-1&&(i[o+"Error"]=ne[o]),i},{});function pe(){}function In(i){return i}function Yc(i,o){return i==null||i===In?o:function(c){return o(i(c))}}function At(i,o){return function(){i.apply(this,arguments),o.apply(this,arguments)}}function Gc(i,o){return i===pe?o:function(){var c=i.apply(this,arguments);c!==void 0&&(arguments[0]=c);var u=this.onsuccess,f=this.onerror;this.onsuccess=null,this.onerror=null;var h=o.apply(this,arguments);return u&&(this.onsuccess=this.onsuccess?At(u,this.onsuccess):u),f&&(this.onerror=this.onerror?At(f,this.onerror):f),h!==void 0?h:c}}function Jc(i,o){return i===pe?o:function(){i.apply(this,arguments);var c=this.onsuccess,u=this.onerror;this.onsuccess=this.onerror=null,o.apply(this,arguments),c&&(this.onsuccess=this.onsuccess?At(c,this.onsuccess):c),u&&(this.onerror=this.onerror?At(u,this.onerror):u)}}function Wc(i,o){return i===pe?o:function(c){var u=i.apply(this,arguments);p(c,u);var f=this.onsuccess,h=this.onerror;return this.onsuccess=null,this.onerror=null,c=o.apply(this,arguments),f&&(this.onsuccess=this.onsuccess?At(f,this.onsuccess):f),h&&(this.onerror=this.onerror?At(h,this.onerror):h),u===void 0?c===void 0?void 0:c:p(u,c)}}function Qc(i,o){return i===pe?o:function(){return o.apply(this,arguments)!==!1&&i.apply(this,arguments)}}function _i(i,o){return i===pe?o:function(){var c=i.apply(this,arguments);if(c&&typeof c.then=="function"){for(var u=this,f=arguments.length,h=new Array(f);f--;)h[f]=arguments[f];return c.then(function(){return o.apply(u,h)})}return o.apply(this,arguments)}}rs.ModifyError=is,rs.DexieError=Gt,rs.BulkError=Jt;var We=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function uo(i){We=i}var An={},fo=100,Tt=typeof Promise>"u"?[]:function(){var i=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[i,y(i),i];var o=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[o,y(o),i]}(),Tn=Tt[0],Re=Tt[1],Tt=Tt[2],Re=Re&&Re.then,Lt=Tn&&Tn.constructor,Ei=!!Tt,Ln=function(i,o){On.push([i,o]),os&&(queueMicrotask(Zc),os=!1)},Ii=!0,os=!0,Ot=[],as=[],Ai=In,lt={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:pe,pgp:!1,env:{},finalize:pe},X=lt,On=[],Ct=0,cs=[];function z(i){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var o=this._PSD=X;if(typeof i!="function"){if(i!==An)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Li(this,this._value))}this._state=null,this._value=null,++o.ref,function c(u,f){try{f(function(h){if(u._state===null){if(h===u)throw new TypeError("A promise cannot be resolved with itself.");var m=u._lib&&Wt();h&&typeof h.then=="function"?c(u,function(g,b){h instanceof z?h._then(g,b):h.then(g,b)}):(u._state=!0,u._value=h,po(u)),m&&Qt()}},Li.bind(null,u))}catch(h){Li(u,h)}}(this,i)}var Ti={get:function(){var i=X,o=ds;function c(u,f){var h=this,m=!i.global&&(i!==X||o!==ds),g=m&&!ft(),b=new z(function(k,E){Oi(h,new ho(yo(u,i,m,g),yo(f,i,m,g),k,E,i))});return this._consoleTask&&(b._consoleTask=this._consoleTask),b}return c.prototype=An,c},set:function(i){F(this,"then",i&&i.prototype===An?Ti:{get:function(){return i},set:Ti.set})}};function ho(i,o,c,u,f){this.onFulfilled=typeof i=="function"?i:null,this.onRejected=typeof o=="function"?o:null,this.resolve=c,this.reject=u,this.psd=f}function Li(i,o){var c,u;as.push(o),i._state===null&&(c=i._lib&&Wt(),o=Ai(o),i._state=!1,i._value=o,u=i,Ot.some(function(f){return f._value===u._value})||Ot.push(u),po(i),c&&Qt())}function po(i){var o=i._listeners;i._listeners=[];for(var c=0,u=o.length;c<u;++c)Oi(i,o[c]);var f=i._PSD;--f.ref||f.finalize(),Ct===0&&(++Ct,Ln(function(){--Ct==0&&Ci()},[]))}function Oi(i,o){if(i._state!==null){var c=i._state?o.onFulfilled:o.onRejected;if(c===null)return(i._state?o.resolve:o.reject)(i._value);++o.psd.ref,++Ct,Ln(Xc,[c,i,o])}else i._listeners.push(o)}function Xc(i,o,c){try{var u,f=o._value;!o._state&&as.length&&(as=[]),u=We&&o._consoleTask?o._consoleTask.run(function(){return i(f)}):i(f),o._state||as.indexOf(f)!==-1||function(h){for(var m=Ot.length;m;)if(Ot[--m]._value===h._value)return Ot.splice(m,1)}(o),c.resolve(u)}catch(h){c.reject(h)}finally{--Ct==0&&Ci(),--c.psd.ref||c.psd.finalize()}}function Zc(){Nt(lt,function(){Wt()&&Qt()})}function Wt(){var i=Ii;return os=Ii=!1,i}function Qt(){var i,o,c;do for(;0<On.length;)for(i=On,On=[],c=i.length,o=0;o<c;++o){var u=i[o];u[0].apply(null,u[1])}while(0<On.length);os=Ii=!0}function Ci(){var i=Ot;Ot=[],i.forEach(function(u){u._PSD.onunhandled.call(null,u._value,u)});for(var o=cs.slice(0),c=o.length;c;)o[--c]()}function ls(i){return new z(An,!1,i)}function ve(i,o){var c=X;return function(){var u=Wt(),f=X;try{return dt(c,!0),i.apply(this,arguments)}catch(h){o&&o(h)}finally{dt(f,!1),u&&Qt()}}}P(z.prototype,{then:Ti,_then:function(i,o){Oi(this,new ho(null,null,i,o,X))},catch:function(i){if(arguments.length===1)return this.then(null,i);var o=i,c=arguments[1];return typeof o=="function"?this.then(null,function(u){return(u instanceof o?c:ls)(u)}):this.then(null,function(u){return(u&&u.name===o?c:ls)(u)})},finally:function(i){return this.then(function(o){return z.resolve(i()).then(function(){return o})},function(o){return z.resolve(i()).then(function(){return ls(o)})})},timeout:function(i,o){var c=this;return i<1/0?new z(function(u,f){var h=setTimeout(function(){return f(new ne.Timeout(o))},i);c.then(u,f).finally(clearTimeout.bind(null,h))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&F(z.prototype,Symbol.toStringTag,"Dexie.Promise"),lt.env=mo(),P(z,{all:function(){var i=nt.apply(null,arguments).map(hs);return new z(function(o,c){i.length===0&&o([]);var u=i.length;i.forEach(function(f,h){return z.resolve(f).then(function(m){i[h]=m,--u||o(i)},c)})})},resolve:function(i){return i instanceof z?i:i&&typeof i.then=="function"?new z(function(o,c){i.then(o,c)}):new z(An,!0,i)},reject:ls,race:function(){var i=nt.apply(null,arguments).map(hs);return new z(function(o,c){i.map(function(u){return z.resolve(u).then(o,c)})})},PSD:{get:function(){return X},set:function(i){return X=i}},totalEchoes:{get:function(){return ds}},newPSD:ut,usePSD:Nt,scheduler:{get:function(){return Ln},set:function(i){Ln=i}},rejectionMapper:{get:function(){return Ai},set:function(i){Ai=i}},follow:function(i,o){return new z(function(c,u){return ut(function(f,h){var m=X;m.unhandleds=[],m.onunhandled=h,m.finalize=At(function(){var g,b=this;g=function(){b.unhandleds.length===0?f():h(b.unhandleds[0])},cs.push(function k(){g(),cs.splice(cs.indexOf(k),1)}),++Ct,Ln(function(){--Ct==0&&Ci()},[])},m.finalize),i()},o,c,u)})}}),Lt&&(Lt.allSettled&&F(z,"allSettled",function(){var i=nt.apply(null,arguments).map(hs);return new z(function(o){i.length===0&&o([]);var c=i.length,u=new Array(c);i.forEach(function(f,h){return z.resolve(f).then(function(m){return u[h]={status:"fulfilled",value:m}},function(m){return u[h]={status:"rejected",reason:m}}).then(function(){return--c||o(u)})})})}),Lt.any&&typeof AggregateError<"u"&&F(z,"any",function(){var i=nt.apply(null,arguments).map(hs);return new z(function(o,c){i.length===0&&c(new AggregateError([]));var u=i.length,f=new Array(u);i.forEach(function(h,m){return z.resolve(h).then(function(g){return o(g)},function(g){f[m]=g,--u||c(new AggregateError(f))})})})}),Lt.withResolvers&&(z.withResolvers=Lt.withResolvers));var Ie={awaits:0,echoes:0,id:0},el=0,us=[],fs=0,ds=0,tl=0;function ut(i,o,c,u){var f=X,h=Object.create(f);return h.parent=f,h.ref=0,h.global=!1,h.id=++tl,lt.env,h.env=Ei?{Promise:z,PromiseProp:{value:z,configurable:!0,writable:!0},all:z.all,race:z.race,allSettled:z.allSettled,any:z.any,resolve:z.resolve,reject:z.reject}:{},o&&p(h,o),++f.ref,h.finalize=function(){--this.parent.ref||this.parent.finalize()},u=Nt(h,i,c,u),h.ref===0&&h.finalize(),u}function Xt(){return Ie.id||(Ie.id=++el),++Ie.awaits,Ie.echoes+=fo,Ie.id}function ft(){return!!Ie.awaits&&(--Ie.awaits==0&&(Ie.id=0),Ie.echoes=Ie.awaits*fo,!0)}function hs(i){return Ie.echoes&&i&&i.constructor===Lt?(Xt(),i.then(function(o){return ft(),o},function(o){return ft(),_e(o)})):i}function nl(){var i=us[us.length-1];us.pop(),dt(i,!1)}function dt(i,o){var c,u=X;(o?!Ie.echoes||fs++&&i===X:!fs||--fs&&i===X)||queueMicrotask(o?(function(f){++ds,Ie.echoes&&--Ie.echoes!=0||(Ie.echoes=Ie.awaits=Ie.id=0),us.push(X),dt(f,!0)}).bind(null,i):nl),i!==X&&(X=i,u===lt&&(lt.env=mo()),Ei&&(c=lt.env.Promise,o=i.env,(u.global||i.global)&&(Object.defineProperty(a,"Promise",o.PromiseProp),c.all=o.all,c.race=o.race,c.resolve=o.resolve,c.reject=o.reject,o.allSettled&&(c.allSettled=o.allSettled),o.any&&(c.any=o.any))))}function mo(){var i=a.Promise;return Ei?{Promise:i,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:i.all,race:i.race,allSettled:i.allSettled,any:i.any,resolve:i.resolve,reject:i.reject}:{}}function Nt(i,o,c,u,f){var h=X;try{return dt(i,!0),o(c,u,f)}finally{dt(h,!1)}}function yo(i,o,c,u){return typeof i!="function"?i:function(){var f=X;c&&Xt(),dt(o,!0);try{return i.apply(this,arguments)}finally{dt(f,!1),u&&queueMicrotask(ft)}}}function Ni(i){Promise===Lt&&Ie.echoes===0?fs===0?i():enqueueNativeMicroTask(i):setTimeout(i,0)}(""+Re).indexOf("[native code]")===-1&&(Xt=ft=pe);var _e=z.reject,Bt="￿",st="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",go="String expected.",Zt=[],ps="__dbnames",Bi="readonly",Pi="readwrite";function Pt(i,o){return i?o?function(){return i.apply(this,arguments)&&o.apply(this,arguments)}:i:o}var vo={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function ms(i){return typeof i!="string"||/\./.test(i)?function(o){return o}:function(o){return o[i]===void 0&&i in o&&delete(o=Je(o))[i],o}}function bo(){throw ne.Type()}function de(i,o){try{var c=wo(i),u=wo(o);if(c!==u)return c==="Array"?1:u==="Array"?-1:c==="binary"?1:u==="binary"?-1:c==="string"?1:u==="string"?-1:c==="Date"?1:u!=="Date"?NaN:-1;switch(c){case"number":case"Date":case"string":return o<i?1:i<o?-1:0;case"binary":return function(f,h){for(var m=f.length,g=h.length,b=m<g?m:g,k=0;k<b;++k)if(f[k]!==h[k])return f[k]<h[k]?-1:1;return m===g?0:m<g?-1:1}(ko(i),ko(o));case"Array":return function(f,h){for(var m=f.length,g=h.length,b=m<g?m:g,k=0;k<b;++k){var E=de(f[k],h[k]);if(E!==0)return E}return m===g?0:m<g?-1:1}(i,o)}}catch{}return NaN}function wo(i){var o=typeof i;return o!="object"?o:ArrayBuffer.isView(i)?"binary":(i=bi(i),i==="ArrayBuffer"?"binary":i)}function ko(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i)}var So=(ge.prototype._trans=function(i,o,c){var u=this._tx||X.trans,f=this.name,h=We&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(i==="readonly"?"read":"write"," ").concat(this.name));function m(k,E,v){if(!v.schema[f])throw new ne.NotFound("Table "+f+" not part of transaction");return o(v.idbtrans,v)}var g=Wt();try{var b=u&&u.db._novip===this.db._novip?u===X.trans?u._promise(i,m,c):ut(function(){return u._promise(i,m,c)},{trans:u,transless:X.transless||X}):function k(E,v,T,w){if(E.idbdb&&(E._state.openComplete||X.letThrough||E._vip)){var _=E._createTransaction(v,T,E._dbSchema);try{_.create(),E._state.PR1398_maxLoop=3}catch(A){return A.name===Si.InvalidState&&E.isOpen()&&0<--E._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),E.close({disableAutoOpen:!1}),E.open().then(function(){return k(E,v,T,w)})):_e(A)}return _._promise(v,function(A,S){return ut(function(){return X.trans=_,w(A,S,_)})}).then(function(A){if(v==="readwrite")try{_.idbtrans.commit()}catch{}return v==="readonly"?A:_._completion.then(function(){return A})})}if(E._state.openComplete)return _e(new ne.DatabaseClosed(E._state.dbOpenError));if(!E._state.isBeingOpened){if(!E._state.autoOpen)return _e(new ne.DatabaseClosed);E.open().catch(pe)}return E._state.dbReadyPromise.then(function(){return k(E,v,T,w)})}(this.db,i,[this.name],m);return h&&(b._consoleTask=h,b=b.catch(function(k){return console.trace(k),_e(k)})),b}finally{g&&Qt()}},ge.prototype.get=function(i,o){var c=this;return i&&i.constructor===Object?this.where(i).first(o):i==null?_e(new ne.Type("Invalid argument to Table.get()")):this._trans("readonly",function(u){return c.core.get({trans:u,key:i}).then(function(f){return c.hook.reading.fire(f)})}).then(o)},ge.prototype.where=function(i){if(typeof i=="string")return new this.db.WhereClause(this,i);if(d(i))return new this.db.WhereClause(this,"[".concat(i.join("+"),"]"));var o=l(i);if(o.length===1)return this.where(o[0]).equals(i[o[0]]);var c=this.schema.indexes.concat(this.schema.primKey).filter(function(g){if(g.compound&&o.every(function(k){return 0<=g.keyPath.indexOf(k)})){for(var b=0;b<o.length;++b)if(o.indexOf(g.keyPath[b])===-1)return!1;return!0}return!1}).sort(function(g,b){return g.keyPath.length-b.keyPath.length})[0];if(c&&this.db._maxKey!==Bt){var h=c.keyPath.slice(0,o.length);return this.where(h).equals(h.map(function(b){return i[b]}))}!c&&We&&console.warn("The query ".concat(JSON.stringify(i)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(o.join("+"),"]"));var u=this.schema.idxByName;function f(g,b){return de(g,b)===0}var m=o.reduce(function(v,b){var k=v[0],E=v[1],v=u[b],T=i[b];return[k||v,k||!v?Pt(E,v&&v.multi?function(w){return w=ee(w,b),d(w)&&w.some(function(_){return f(T,_)})}:function(w){return f(T,ee(w,b))}):E]},[null,null]),h=m[0],m=m[1];return h?this.where(h.name).equals(i[h.keyPath]).filter(m):c?this.filter(m):this.where(o).equals("")},ge.prototype.filter=function(i){return this.toCollection().and(i)},ge.prototype.count=function(i){return this.toCollection().count(i)},ge.prototype.offset=function(i){return this.toCollection().offset(i)},ge.prototype.limit=function(i){return this.toCollection().limit(i)},ge.prototype.each=function(i){return this.toCollection().each(i)},ge.prototype.toArray=function(i){return this.toCollection().toArray(i)},ge.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},ge.prototype.orderBy=function(i){return new this.db.Collection(new this.db.WhereClause(this,d(i)?"[".concat(i.join("+"),"]"):i))},ge.prototype.reverse=function(){return this.toCollection().reverse()},ge.prototype.mapToClass=function(i){var o,c=this.db,u=this.name;function f(){return o!==null&&o.apply(this,arguments)||this}(this.schema.mappedClass=i).prototype instanceof bo&&(function(b,k){if(typeof k!="function"&&k!==null)throw new TypeError("Class extends value "+String(k)+" is not a constructor or null");function E(){this.constructor=b}t(b,k),b.prototype=k===null?Object.create(k):(E.prototype=k.prototype,new E)}(f,o=i),Object.defineProperty(f.prototype,"db",{get:function(){return c},enumerable:!1,configurable:!0}),f.prototype.table=function(){return u},i=f);for(var h=new Set,m=i.prototype;m;m=y(m))Object.getOwnPropertyNames(m).forEach(function(b){return h.add(b)});function g(b){if(!b)return b;var k,E=Object.create(i.prototype);for(k in b)if(!h.has(k))try{E[k]=b[k]}catch{}return E}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=g,this.hook("reading",g),i},ge.prototype.defineClass=function(){return this.mapToClass(function(i){p(this,i)})},ge.prototype.add=function(i,o){var c=this,u=this.schema.primKey,f=u.auto,h=u.keyPath,m=i;return h&&f&&(m=ms(h)(i)),this._trans("readwrite",function(g){return c.core.mutate({trans:g,type:"add",keys:o!=null?[o]:null,values:[m]})}).then(function(g){return g.numFailures?z.reject(g.failures[0]):g.lastResult}).then(function(g){if(h)try{ce(i,h,g)}catch{}return g})},ge.prototype.update=function(i,o){return typeof i!="object"||d(i)?this.where(":id").equals(i).modify(o):(i=ee(i,this.schema.primKey.keyPath),i===void 0?_e(new ne.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(i).modify(o))},ge.prototype.put=function(i,o){var c=this,u=this.schema.primKey,f=u.auto,h=u.keyPath,m=i;return h&&f&&(m=ms(h)(i)),this._trans("readwrite",function(g){return c.core.mutate({trans:g,type:"put",values:[m],keys:o!=null?[o]:null})}).then(function(g){return g.numFailures?z.reject(g.failures[0]):g.lastResult}).then(function(g){if(h)try{ce(i,h,g)}catch{}return g})},ge.prototype.delete=function(i){var o=this;return this._trans("readwrite",function(c){return o.core.mutate({trans:c,type:"delete",keys:[i]})}).then(function(c){return c.numFailures?z.reject(c.failures[0]):void 0})},ge.prototype.clear=function(){var i=this;return this._trans("readwrite",function(o){return i.core.mutate({trans:o,type:"deleteRange",range:vo})}).then(function(o){return o.numFailures?z.reject(o.failures[0]):void 0})},ge.prototype.bulkGet=function(i){var o=this;return this._trans("readonly",function(c){return o.core.getMany({keys:i,trans:c}).then(function(u){return u.map(function(f){return o.hook.reading.fire(f)})})})},ge.prototype.bulkAdd=function(i,o,c){var u=this,f=Array.isArray(o)?o:void 0,h=(c=c||(f?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(m){var k=u.schema.primKey,g=k.auto,k=k.keyPath;if(k&&f)throw new ne.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(f&&f.length!==i.length)throw new ne.InvalidArgument("Arguments objects and keys must have the same length");var b=i.length,k=k&&g?i.map(ms(k)):i;return u.core.mutate({trans:m,type:"add",keys:f,values:k,wantResults:h}).then(function(_){var v=_.numFailures,T=_.results,w=_.lastResult,_=_.failures;if(v===0)return h?T:w;throw new Jt("".concat(u.name,".bulkAdd(): ").concat(v," of ").concat(b," operations failed"),_)})})},ge.prototype.bulkPut=function(i,o,c){var u=this,f=Array.isArray(o)?o:void 0,h=(c=c||(f?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(m){var k=u.schema.primKey,g=k.auto,k=k.keyPath;if(k&&f)throw new ne.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(f&&f.length!==i.length)throw new ne.InvalidArgument("Arguments objects and keys must have the same length");var b=i.length,k=k&&g?i.map(ms(k)):i;return u.core.mutate({trans:m,type:"put",keys:f,values:k,wantResults:h}).then(function(_){var v=_.numFailures,T=_.results,w=_.lastResult,_=_.failures;if(v===0)return h?T:w;throw new Jt("".concat(u.name,".bulkPut(): ").concat(v," of ").concat(b," operations failed"),_)})})},ge.prototype.bulkUpdate=function(i){var o=this,c=this.core,u=i.map(function(m){return m.key}),f=i.map(function(m){return m.changes}),h=[];return this._trans("readwrite",function(m){return c.getMany({trans:m,keys:u,cache:"clone"}).then(function(g){var b=[],k=[];i.forEach(function(v,T){var w=v.key,_=v.changes,A=g[T];if(A){for(var S=0,L=Object.keys(_);S<L.length;S++){var C=L[S],N=_[C];if(C===o.schema.primKey.keyPath){if(de(N,w)!==0)throw new ne.Constraint("Cannot update primary key in bulkUpdate()")}else ce(A,C,N)}h.push(T),b.push(w),k.push(A)}});var E=b.length;return c.mutate({trans:m,type:"put",keys:b,values:k,updates:{keys:u,changeSpecs:f}}).then(function(v){var T=v.numFailures,w=v.failures;if(T===0)return E;for(var _=0,A=Object.keys(w);_<A.length;_++){var S,L=A[_],C=h[Number(L)];C!=null&&(S=w[L],delete w[L],w[C]=S)}throw new Jt("".concat(o.name,".bulkUpdate(): ").concat(T," of ").concat(E," operations failed"),w)})})})},ge.prototype.bulkDelete=function(i){var o=this,c=i.length;return this._trans("readwrite",function(u){return o.core.mutate({trans:u,type:"delete",keys:i})}).then(function(m){var f=m.numFailures,h=m.lastResult,m=m.failures;if(f===0)return h;throw new Jt("".concat(o.name,".bulkDelete(): ").concat(f," of ").concat(c," operations failed"),m)})},ge);function ge(){}function Cn(i){function o(m,g){if(g){for(var b=arguments.length,k=new Array(b-1);--b;)k[b-1]=arguments[b];return c[m].subscribe.apply(null,k),i}if(typeof m=="string")return c[m]}var c={};o.addEventType=h;for(var u=1,f=arguments.length;u<f;++u)h(arguments[u]);return o;function h(m,g,b){if(typeof m!="object"){var k;g=g||Qc;var E={subscribers:[],fire:b=b||pe,subscribe:function(v){E.subscribers.indexOf(v)===-1&&(E.subscribers.push(v),E.fire=g(E.fire,v))},unsubscribe:function(v){E.subscribers=E.subscribers.filter(function(T){return T!==v}),E.fire=E.subscribers.reduce(g,b)}};return c[m]=o[m]=E}l(k=m).forEach(function(v){var T=k[v];if(d(T))h(v,k[v][0],k[v][1]);else{if(T!=="asap")throw new ne.InvalidArgument("Invalid event config");var w=h(v,In,function(){for(var _=arguments.length,A=new Array(_);_--;)A[_]=arguments[_];w.subscribers.forEach(function(S){te(function(){S.apply(null,A)})})})}})}}function Nn(i,o){return O(o).from({prototype:i}),o}function en(i,o){return!(i.filter||i.algorithm||i.or)&&(o?i.justLimit:!i.replayFilter)}function Mi(i,o){i.filter=Pt(i.filter,o)}function $i(i,o,c){var u=i.replayFilter;i.replayFilter=u?function(){return Pt(u(),o())}:o,i.justLimit=c&&!u}function ys(i,o){if(i.isPrimKey)return o.primaryKey;var c=o.getIndexByKeyPath(i.index);if(!c)throw new ne.Schema("KeyPath "+i.index+" on object store "+o.name+" is not indexed");return c}function _o(i,o,c){var u=ys(i,o.schema);return o.openCursor({trans:c,values:!i.keysOnly,reverse:i.dir==="prev",unique:!!i.unique,query:{index:u,range:i.range}})}function gs(i,o,c,u){var f=i.replayFilter?Pt(i.filter,i.replayFilter()):i.filter;if(i.or){var h={},m=function(g,b,k){var E,v;f&&!f(b,k,function(T){return b.stop(T)},function(T){return b.fail(T)})||((v=""+(E=b.primaryKey))=="[object ArrayBuffer]"&&(v=""+new Uint8Array(E)),I(h,v)||(h[v]=!0,o(g,b,k)))};return Promise.all([i.or._iterate(m,c),Eo(_o(i,u,c),i.algorithm,m,!i.keysOnly&&i.valueMapper)])}return Eo(_o(i,u,c),Pt(i.algorithm,f),o,!i.keysOnly&&i.valueMapper)}function Eo(i,o,c,u){var f=ve(u?function(h,m,g){return c(u(h),m,g)}:c);return i.then(function(h){if(h)return h.start(function(){var m=function(){return h.continue()};o&&!o(h,function(g){return m=g},function(g){h.stop(g),m=pe},function(g){h.fail(g),m=pe})||f(h.value,h,function(g){return m=g}),m()})})}var Bn=(Io.prototype.execute=function(i){var o=this["@@propmod"];if(o.add!==void 0){var c=o.add;if(d(c))return r(r([],d(i)?i:[],!0),c).sort();if(typeof c=="number")return(Number(i)||0)+c;if(typeof c=="bigint")try{return BigInt(i)+c}catch{return BigInt(0)+c}throw new TypeError("Invalid term ".concat(c))}if(o.remove!==void 0){var u=o.remove;if(d(u))return d(i)?i.filter(function(f){return!u.includes(f)}).sort():[];if(typeof u=="number")return Number(i)-u;if(typeof u=="bigint")try{return BigInt(i)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return c=(c=o.replacePrefix)===null||c===void 0?void 0:c[0],c&&typeof i=="string"&&i.startsWith(c)?o.replacePrefix[1]+i.substring(c.length):i},Io);function Io(i){this["@@propmod"]=i}var sl=(he.prototype._read=function(i,o){var c=this._ctx;return c.error?c.table._trans(null,_e.bind(null,c.error)):c.table._trans("readonly",i).then(o)},he.prototype._write=function(i){var o=this._ctx;return o.error?o.table._trans(null,_e.bind(null,o.error)):o.table._trans("readwrite",i,"locked")},he.prototype._addAlgorithm=function(i){var o=this._ctx;o.algorithm=Pt(o.algorithm,i)},he.prototype._iterate=function(i,o){return gs(this._ctx,i,o,this._ctx.table.core)},he.prototype.clone=function(i){var o=Object.create(this.constructor.prototype),c=Object.create(this._ctx);return i&&p(c,i),o._ctx=c,o},he.prototype.raw=function(){return this._ctx.valueMapper=null,this},he.prototype.each=function(i){var o=this._ctx;return this._read(function(c){return gs(o,i,c,o.table.core)})},he.prototype.count=function(i){var o=this;return this._read(function(c){var u=o._ctx,f=u.table.core;if(en(u,!0))return f.count({trans:c,query:{index:ys(u,f.schema),range:u.range}}).then(function(m){return Math.min(m,u.limit)});var h=0;return gs(u,function(){return++h,!1},c,f).then(function(){return h})}).then(i)},he.prototype.sortBy=function(i,o){var c=i.split(".").reverse(),u=c[0],f=c.length-1;function h(b,k){return k?h(b[c[k]],k-1):b[u]}var m=this._ctx.dir==="next"?1:-1;function g(b,k){return de(h(b,f),h(k,f))*m}return this.toArray(function(b){return b.sort(g)}).then(o)},he.prototype.toArray=function(i){var o=this;return this._read(function(c){var u=o._ctx;if(u.dir==="next"&&en(u,!0)&&0<u.limit){var f=u.valueMapper,h=ys(u,u.table.core.schema);return u.table.core.query({trans:c,limit:u.limit,values:!0,query:{index:h,range:u.range}}).then(function(g){return g=g.result,f?g.map(f):g})}var m=[];return gs(u,function(g){return m.push(g)},c,u.table.core).then(function(){return m})},i)},he.prototype.offset=function(i){var o=this._ctx;return i<=0||(o.offset+=i,en(o)?$i(o,function(){var c=i;return function(u,f){return c===0||(c===1?--c:f(function(){u.advance(c),c=0}),!1)}}):$i(o,function(){var c=i;return function(){return--c<0}})),this},he.prototype.limit=function(i){return this._ctx.limit=Math.min(this._ctx.limit,i),$i(this._ctx,function(){var o=i;return function(c,u,f){return--o<=0&&u(f),0<=o}},!0),this},he.prototype.until=function(i,o){return Mi(this._ctx,function(c,u,f){return!i(c.value)||(u(f),o)}),this},he.prototype.first=function(i){return this.limit(1).toArray(function(o){return o[0]}).then(i)},he.prototype.last=function(i){return this.reverse().first(i)},he.prototype.filter=function(i){var o;return Mi(this._ctx,function(c){return i(c.value)}),(o=this._ctx).isMatch=Pt(o.isMatch,i),this},he.prototype.and=function(i){return this.filter(i)},he.prototype.or=function(i){return new this.db.WhereClause(this._ctx.table,i,this)},he.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},he.prototype.desc=function(){return this.reverse()},he.prototype.eachKey=function(i){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,u){i(u.key,u)})},he.prototype.eachUniqueKey=function(i){return this._ctx.unique="unique",this.eachKey(i)},he.prototype.eachPrimaryKey=function(i){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,u){i(u.primaryKey,u)})},he.prototype.keys=function(i){var o=this._ctx;o.keysOnly=!o.isMatch;var c=[];return this.each(function(u,f){c.push(f.key)}).then(function(){return c}).then(i)},he.prototype.primaryKeys=function(i){var o=this._ctx;if(o.dir==="next"&&en(o,!0)&&0<o.limit)return this._read(function(u){var f=ys(o,o.table.core.schema);return o.table.core.query({trans:u,values:!1,limit:o.limit,query:{index:f,range:o.range}})}).then(function(u){return u.result}).then(i);o.keysOnly=!o.isMatch;var c=[];return this.each(function(u,f){c.push(f.primaryKey)}).then(function(){return c}).then(i)},he.prototype.uniqueKeys=function(i){return this._ctx.unique="unique",this.keys(i)},he.prototype.firstKey=function(i){return this.limit(1).keys(function(o){return o[0]}).then(i)},he.prototype.lastKey=function(i){return this.reverse().firstKey(i)},he.prototype.distinct=function(){var i=this._ctx,i=i.index&&i.table.schema.idxByName[i.index];if(!i||!i.multi)return this;var o={};return Mi(this._ctx,function(f){var u=f.primaryKey.toString(),f=I(o,u);return o[u]=!0,!f}),this},he.prototype.modify=function(i){var o=this,c=this._ctx;return this._write(function(u){var f,h,m;m=typeof i=="function"?i:(f=l(i),h=f.length,function(S){for(var L=!1,C=0;C<h;++C){var N=f[C],D=i[N],K=ee(S,N);D instanceof Bn?(ce(S,N,D.execute(K)),L=!0):K!==D&&(ce(S,N,D),L=!0)}return L});var g=c.table.core,v=g.schema.primaryKey,b=v.outbound,k=v.extractKey,E=200,v=o.db._options.modifyChunkSize;v&&(E=typeof v=="object"?v[g.name]||v["*"]||200:v);function T(S,N){var C=N.failures,N=N.numFailures;_+=S-N;for(var D=0,K=l(C);D<K.length;D++){var U=K[D];w.push(C[U])}}var w=[],_=0,A=[];return o.clone().primaryKeys().then(function(S){function L(N){var D=Math.min(E,S.length-N);return g.getMany({trans:u,keys:S.slice(N,N+D),cache:"immutable"}).then(function(K){for(var U=[],j=[],q=b?[]:null,V=[],R=0;R<D;++R){var Y=K[R],re={value:Je(Y),primKey:S[N+R]};m.call(re,re.value,re)!==!1&&(re.value==null?V.push(S[N+R]):b||de(k(Y),k(re.value))===0?(j.push(re.value),b&&q.push(S[N+R])):(V.push(S[N+R]),U.push(re.value)))}return Promise.resolve(0<U.length&&g.mutate({trans:u,type:"add",values:U}).then(function(le){for(var ue in le.failures)V.splice(parseInt(ue),1);T(U.length,le)})).then(function(){return(0<j.length||C&&typeof i=="object")&&g.mutate({trans:u,type:"put",keys:q,values:j,criteria:C,changeSpec:typeof i!="function"&&i,isAdditionalChunk:0<N}).then(function(le){return T(j.length,le)})}).then(function(){return(0<V.length||C&&i===Di)&&g.mutate({trans:u,type:"delete",keys:V,criteria:C,isAdditionalChunk:0<N}).then(function(le){return T(V.length,le)})}).then(function(){return S.length>N+D&&L(N+E)})})}var C=en(c)&&c.limit===1/0&&(typeof i!="function"||i===Di)&&{index:c.index,range:c.range};return L(0).then(function(){if(0<w.length)throw new is("Error modifying one or more objects",w,_,A);return S.length})})})},he.prototype.delete=function(){var i=this._ctx,o=i.range;return en(i)&&(i.isPrimKey||o.type===3)?this._write(function(c){var u=i.table.core.schema.primaryKey,f=o;return i.table.core.count({trans:c,query:{index:u,range:f}}).then(function(h){return i.table.core.mutate({trans:c,type:"deleteRange",range:f}).then(function(m){var g=m.failures;if(m.lastResult,m.results,m=m.numFailures,m)throw new is("Could not delete some values",Object.keys(g).map(function(b){return g[b]}),h-m);return h-m})})}):this.modify(Di)},he);function he(){}var Di=function(i,o){return o.value=null};function il(i,o){return i<o?-1:i===o?0:1}function rl(i,o){return o<i?-1:i===o?0:1}function je(i,o,c){return i=i instanceof To?new i.Collection(i):i,i._ctx.error=new(c||TypeError)(o),i}function tn(i){return new i.Collection(i,function(){return Ao("")}).limit(0)}function vs(i,o,c,u){var f,h,m,g,b,k,E,v=c.length;if(!c.every(function(_){return typeof _=="string"}))return je(i,go);function T(_){f=_==="next"?function(S){return S.toUpperCase()}:function(S){return S.toLowerCase()},h=_==="next"?function(S){return S.toLowerCase()}:function(S){return S.toUpperCase()},m=_==="next"?il:rl;var A=c.map(function(S){return{lower:h(S),upper:f(S)}}).sort(function(S,L){return m(S.lower,L.lower)});g=A.map(function(S){return S.upper}),b=A.map(function(S){return S.lower}),E=(k=_)==="next"?"":u}T("next"),i=new i.Collection(i,function(){return ht(g[0],b[v-1]+u)}),i._ondirectionchange=function(_){T(_)};var w=0;return i._addAlgorithm(function(_,A,S){var L=_.key;if(typeof L!="string")return!1;var C=h(L);if(o(C,b,w))return!0;for(var N=null,D=w;D<v;++D){var K=function(U,j,q,V,R,Y){for(var re=Math.min(U.length,V.length),le=-1,ue=0;ue<re;++ue){var qe=j[ue];if(qe!==V[ue])return R(U[ue],q[ue])<0?U.substr(0,ue)+q[ue]+q.substr(ue+1):R(U[ue],V[ue])<0?U.substr(0,ue)+V[ue]+q.substr(ue+1):0<=le?U.substr(0,le)+j[le]+q.substr(le+1):null;R(U[ue],qe)<0&&(le=ue)}return re<V.length&&Y==="next"?U+q.substr(U.length):re<U.length&&Y==="prev"?U.substr(0,q.length):le<0?null:U.substr(0,le)+V[le]+q.substr(le+1)}(L,C,g[D],b[D],m,k);K===null&&N===null?w=D+1:(N===null||0<m(N,K))&&(N=K)}return A(N!==null?function(){_.continue(N+E)}:S),!1}),i}function ht(i,o,c,u){return{type:2,lower:i,upper:o,lowerOpen:c,upperOpen:u}}function Ao(i){return{type:1,lower:i,upper:i}}var To=(Object.defineProperty(Ae.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ae.prototype.between=function(i,o,c,u){c=c!==!1,u=u===!0;try{return 0<this._cmp(i,o)||this._cmp(i,o)===0&&(c||u)&&(!c||!u)?tn(this):new this.Collection(this,function(){return ht(i,o,!c,!u)})}catch{return je(this,st)}},Ae.prototype.equals=function(i){return i==null?je(this,st):new this.Collection(this,function(){return Ao(i)})},Ae.prototype.above=function(i){return i==null?je(this,st):new this.Collection(this,function(){return ht(i,void 0,!0)})},Ae.prototype.aboveOrEqual=function(i){return i==null?je(this,st):new this.Collection(this,function(){return ht(i,void 0,!1)})},Ae.prototype.below=function(i){return i==null?je(this,st):new this.Collection(this,function(){return ht(void 0,i,!1,!0)})},Ae.prototype.belowOrEqual=function(i){return i==null?je(this,st):new this.Collection(this,function(){return ht(void 0,i)})},Ae.prototype.startsWith=function(i){return typeof i!="string"?je(this,go):this.between(i,i+Bt,!0,!0)},Ae.prototype.startsWithIgnoreCase=function(i){return i===""?this.startsWith(i):vs(this,function(o,c){return o.indexOf(c[0])===0},[i],Bt)},Ae.prototype.equalsIgnoreCase=function(i){return vs(this,function(o,c){return o===c[0]},[i],"")},Ae.prototype.anyOfIgnoreCase=function(){var i=nt.apply(Yt,arguments);return i.length===0?tn(this):vs(this,function(o,c){return c.indexOf(o)!==-1},i,"")},Ae.prototype.startsWithAnyOfIgnoreCase=function(){var i=nt.apply(Yt,arguments);return i.length===0?tn(this):vs(this,function(o,c){return c.some(function(u){return o.indexOf(u)===0})},i,Bt)},Ae.prototype.anyOf=function(){var i=this,o=nt.apply(Yt,arguments),c=this._cmp;try{o.sort(c)}catch{return je(this,st)}if(o.length===0)return tn(this);var u=new this.Collection(this,function(){return ht(o[0],o[o.length-1])});u._ondirectionchange=function(h){c=h==="next"?i._ascending:i._descending,o.sort(c)};var f=0;return u._addAlgorithm(function(h,m,g){for(var b=h.key;0<c(b,o[f]);)if(++f===o.length)return m(g),!1;return c(b,o[f])===0||(m(function(){h.continue(o[f])}),!1)}),u},Ae.prototype.notEqual=function(i){return this.inAnyRange([[-1/0,i],[i,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ae.prototype.noneOf=function(){var i=nt.apply(Yt,arguments);if(i.length===0)return new this.Collection(this);try{i.sort(this._ascending)}catch{return je(this,st)}var o=i.reduce(function(c,u){return c?c.concat([[c[c.length-1][1],u]]):[[-1/0,u]]},null);return o.push([i[i.length-1],this.db._maxKey]),this.inAnyRange(o,{includeLowers:!1,includeUppers:!1})},Ae.prototype.inAnyRange=function(L,o){var c=this,u=this._cmp,f=this._ascending,h=this._descending,m=this._min,g=this._max;if(L.length===0)return tn(this);if(!L.every(function(C){return C[0]!==void 0&&C[1]!==void 0&&f(C[0],C[1])<=0}))return je(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ne.InvalidArgument);var b=!o||o.includeLowers!==!1,k=o&&o.includeUppers===!0,E,v=f;function T(C,N){return v(C[0],N[0])}try{(E=L.reduce(function(C,N){for(var D=0,K=C.length;D<K;++D){var U=C[D];if(u(N[0],U[1])<0&&0<u(N[1],U[0])){U[0]=m(U[0],N[0]),U[1]=g(U[1],N[1]);break}}return D===K&&C.push(N),C},[])).sort(T)}catch{return je(this,st)}var w=0,_=k?function(C){return 0<f(C,E[w][1])}:function(C){return 0<=f(C,E[w][1])},A=b?function(C){return 0<h(C,E[w][0])}:function(C){return 0<=h(C,E[w][0])},S=_,L=new this.Collection(this,function(){return ht(E[0][0],E[E.length-1][1],!b,!k)});return L._ondirectionchange=function(C){v=C==="next"?(S=_,f):(S=A,h),E.sort(T)},L._addAlgorithm(function(C,N,D){for(var K,U=C.key;S(U);)if(++w===E.length)return N(D),!1;return!_(K=U)&&!A(K)||(c._cmp(U,E[w][1])===0||c._cmp(U,E[w][0])===0||N(function(){v===f?C.continue(E[w][0]):C.continue(E[w][1])}),!1)}),L},Ae.prototype.startsWithAnyOf=function(){var i=nt.apply(Yt,arguments);return i.every(function(o){return typeof o=="string"})?i.length===0?tn(this):this.inAnyRange(i.map(function(o){return[o,o+Bt]})):je(this,"startsWithAnyOf() only works with strings")},Ae);function Ae(){}function Qe(i){return ve(function(o){return Pn(o),i(o.target.error),!1})}function Pn(i){i.stopPropagation&&i.stopPropagation(),i.preventDefault&&i.preventDefault()}var Mn="storagemutated",xi="x-storagemutated-1",pt=Cn(null,Mn),ol=(Xe.prototype._lock=function(){return Q(!X.global),++this._reculock,this._reculock!==1||X.global||(X.lockOwnerFor=this),this},Xe.prototype._unlock=function(){if(Q(!X.global),--this._reculock==0)for(X.global||(X.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var i=this._blockedFuncs.shift();try{Nt(i[1],i[0])}catch{}}return this},Xe.prototype._locked=function(){return this._reculock&&X.lockOwnerFor!==this},Xe.prototype.create=function(i){var o=this;if(!this.mode)return this;var c=this.db.idbdb,u=this.db._state.dbOpenError;if(Q(!this.idbtrans),!i&&!c)switch(u&&u.name){case"DatabaseClosedError":throw new ne.DatabaseClosed(u);case"MissingAPIError":throw new ne.MissingAPI(u.message,u);default:throw new ne.OpenFailed(u)}if(!this.active)throw new ne.TransactionInactive;return Q(this._completion._state===null),(i=this.idbtrans=i||(this.db.core||c).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=ve(function(f){Pn(f),o._reject(i.error)}),i.onabort=ve(function(f){Pn(f),o.active&&o._reject(new ne.Abort(i.error)),o.active=!1,o.on("abort").fire(f)}),i.oncomplete=ve(function(){o.active=!1,o._resolve(),"mutatedParts"in i&&pt.storagemutated.fire(i.mutatedParts)}),this},Xe.prototype._promise=function(i,o,c){var u=this;if(i==="readwrite"&&this.mode!=="readwrite")return _e(new ne.ReadOnly("Transaction is readonly"));if(!this.active)return _e(new ne.TransactionInactive);if(this._locked())return new z(function(h,m){u._blockedFuncs.push([function(){u._promise(i,o,c).then(h,m)},X])});if(c)return ut(function(){var h=new z(function(m,g){u._lock();var b=o(m,g,u);b&&b.then&&b.then(m,g)});return h.finally(function(){return u._unlock()}),h._lib=!0,h});var f=new z(function(h,m){var g=o(h,m,u);g&&g.then&&g.then(h,m)});return f._lib=!0,f},Xe.prototype._root=function(){return this.parent?this.parent._root():this},Xe.prototype.waitFor=function(i){var o,c=this._root(),u=z.resolve(i);c._waitingFor?c._waitingFor=c._waitingFor.then(function(){return u}):(c._waitingFor=u,c._waitingQueue=[],o=c.idbtrans.objectStore(c.storeNames[0]),function h(){for(++c._spinCount;c._waitingQueue.length;)c._waitingQueue.shift()();c._waitingFor&&(o.get(-1/0).onsuccess=h)}());var f=c._waitingFor;return new z(function(h,m){u.then(function(g){return c._waitingQueue.push(ve(h.bind(null,g)))},function(g){return c._waitingQueue.push(ve(m.bind(null,g)))}).finally(function(){c._waitingFor===f&&(c._waitingFor=null)})})},Xe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ne.Abort))},Xe.prototype.table=function(i){var o=this._memoizedTables||(this._memoizedTables={});if(I(o,i))return o[i];var c=this.schema[i];if(!c)throw new ne.NotFound("Table "+i+" not part of transaction");return c=new this.db.Table(i,c,this),c.core=this.db.core.table(i),o[i]=c},Xe);function Xe(){}function Ki(i,o,c,u,f,h,m){return{name:i,keyPath:o,unique:c,multi:u,auto:f,compound:h,src:(c&&!m?"&":"")+(u?"*":"")+(f?"++":"")+Lo(o)}}function Lo(i){return typeof i=="string"?i:i?"["+[].join.call(i,"+")+"]":""}function ji(i,o,c){return{name:i,primKey:o,indexes:c,mappedClass:null,idxByName:(u=function(f){return[f.name,f]},c.reduce(function(f,h,m){return m=u(h,m),m&&(f[m[0]]=m[1]),f},{}))};var u}var $n=function(i){try{return i.only([[]]),$n=function(){return[[]]},[[]]}catch{return $n=function(){return Bt},Bt}};function qi(i){return i==null?function(){}:typeof i=="string"?(o=i).split(".").length===1?function(c){return c[o]}:function(c){return ee(c,o)}:function(c){return ee(c,i)};var o}function Oo(i){return[].slice.call(i)}var al=0;function Dn(i){return i==null?":id":typeof i=="string"?i:"[".concat(i.join("+"),"]")}function cl(i,o,b){function u(S){if(S.type===3)return null;if(S.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var w=S.lower,_=S.upper,A=S.lowerOpen,S=S.upperOpen;return w===void 0?_===void 0?null:o.upperBound(_,!!S):_===void 0?o.lowerBound(w,!!A):o.bound(w,_,!!A,!!S)}function f(T){var w,_=T.name;return{name:_,schema:T,mutate:function(A){var S=A.trans,L=A.type,C=A.keys,N=A.values,D=A.range;return new Promise(function(K,U){K=ve(K);var j=S.objectStore(_),q=j.keyPath==null,V=L==="put"||L==="add";if(!V&&L!=="delete"&&L!=="deleteRange")throw new Error("Invalid operation type: "+L);var R,Y=(C||N||{length:1}).length;if(C&&N&&C.length!==N.length)throw new Error("Given keys array must have same length as given values array.");if(Y===0)return K({numFailures:0,failures:{},results:[],lastResult:void 0});function re(Be){++qe,Pn(Be)}var le=[],ue=[],qe=0;if(L==="deleteRange"){if(D.type===4)return K({numFailures:qe,failures:ue,results:[],lastResult:void 0});D.type===3?le.push(R=j.clear()):le.push(R=j.delete(u(D)))}else{var q=V?q?[N,C]:[N,null]:[C,null],ie=q[0],Oe=q[1];if(V)for(var Ce=0;Ce<Y;++Ce)le.push(R=Oe&&Oe[Ce]!==void 0?j[L](ie[Ce],Oe[Ce]):j[L](ie[Ce])),R.onerror=re;else for(Ce=0;Ce<Y;++Ce)le.push(R=j[L](ie[Ce])),R.onerror=re}function Ns(Be){Be=Be.target.result,le.forEach(function(Dt,ir){return Dt.error!=null&&(ue[ir]=Dt.error)}),K({numFailures:qe,failures:ue,results:L==="delete"?C:le.map(function(Dt){return Dt.result}),lastResult:Be})}R.onerror=function(Be){re(Be),Ns(Be)},R.onsuccess=Ns})},getMany:function(A){var S=A.trans,L=A.keys;return new Promise(function(C,N){C=ve(C);for(var D,K=S.objectStore(_),U=L.length,j=new Array(U),q=0,V=0,R=function(le){le=le.target,j[le._pos]=le.result,++V===q&&C(j)},Y=Qe(N),re=0;re<U;++re)L[re]!=null&&((D=K.get(L[re]))._pos=re,D.onsuccess=R,D.onerror=Y,++q);q===0&&C(j)})},get:function(A){var S=A.trans,L=A.key;return new Promise(function(C,N){C=ve(C);var D=S.objectStore(_).get(L);D.onsuccess=function(K){return C(K.target.result)},D.onerror=Qe(N)})},query:(w=k,function(A){return new Promise(function(S,L){S=ve(S);var C,N,D,q=A.trans,K=A.values,U=A.limit,R=A.query,j=U===1/0?void 0:U,V=R.index,R=R.range,q=q.objectStore(_),V=V.isPrimaryKey?q:q.index(V.name),R=u(R);if(U===0)return S({result:[]});w?((j=K?V.getAll(R,j):V.getAllKeys(R,j)).onsuccess=function(Y){return S({result:Y.target.result})},j.onerror=Qe(L)):(C=0,N=!K&&"openKeyCursor"in V?V.openKeyCursor(R):V.openCursor(R),D=[],N.onsuccess=function(Y){var re=N.result;return re?(D.push(K?re.value:re.primaryKey),++C===U?S({result:D}):void re.continue()):S({result:D})},N.onerror=Qe(L))})}),openCursor:function(A){var S=A.trans,L=A.values,C=A.query,N=A.reverse,D=A.unique;return new Promise(function(K,U){K=ve(K);var V=C.index,j=C.range,q=S.objectStore(_),q=V.isPrimaryKey?q:q.index(V.name),V=N?D?"prevunique":"prev":D?"nextunique":"next",R=!L&&"openKeyCursor"in q?q.openKeyCursor(u(j),V):q.openCursor(u(j),V);R.onerror=Qe(U),R.onsuccess=ve(function(Y){var re,le,ue,qe,ie=R.result;ie?(ie.___id=++al,ie.done=!1,re=ie.continue.bind(ie),le=(le=ie.continuePrimaryKey)&&le.bind(ie),ue=ie.advance.bind(ie),qe=function(){throw new Error("Cursor not stopped")},ie.trans=S,ie.stop=ie.continue=ie.continuePrimaryKey=ie.advance=function(){throw new Error("Cursor not started")},ie.fail=ve(U),ie.next=function(){var Oe=this,Ce=1;return this.start(function(){return Ce--?Oe.continue():Oe.stop()}).then(function(){return Oe})},ie.start=function(Oe){function Ce(){if(R.result)try{Oe()}catch(Be){ie.fail(Be)}else ie.done=!0,ie.start=function(){throw new Error("Cursor behind last entry")},ie.stop()}var Ns=new Promise(function(Be,Dt){Be=ve(Be),R.onerror=Qe(Dt),ie.fail=Dt,ie.stop=function(ir){ie.stop=ie.continue=ie.continuePrimaryKey=ie.advance=qe,Be(ir)}});return R.onsuccess=ve(function(Be){R.onsuccess=Ce,Ce()}),ie.continue=re,ie.continuePrimaryKey=le,ie.advance=ue,Ce(),Ns},K(ie)):K(null)},U)})},count:function(A){var S=A.query,L=A.trans,C=S.index,N=S.range;return new Promise(function(D,K){var U=L.objectStore(_),j=C.isPrimaryKey?U:U.index(C.name),U=u(N),j=U?j.count(U):j.count();j.onsuccess=ve(function(q){return D(q.target.result)}),j.onerror=Qe(K)})}}}var h,m,g,E=(m=b,g=Oo((h=i).objectStoreNames),{schema:{name:h.name,tables:g.map(function(T){return m.objectStore(T)}).map(function(T){var w=T.keyPath,S=T.autoIncrement,_=d(w),A={},S={name:T.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:w==null,compound:_,keyPath:w,autoIncrement:S,unique:!0,extractKey:qi(w)},indexes:Oo(T.indexNames).map(function(L){return T.index(L)}).map(function(D){var C=D.name,N=D.unique,K=D.multiEntry,D=D.keyPath,K={name:C,compound:d(D),keyPath:D,unique:N,multiEntry:K,extractKey:qi(D)};return A[Dn(D)]=K}),getIndexByKeyPath:function(L){return A[Dn(L)]}};return A[":id"]=S.primaryKey,w!=null&&(A[Dn(w)]=S.primaryKey),S})},hasGetAll:0<g.length&&"getAll"in m.objectStore(g[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),b=E.schema,k=E.hasGetAll,E=b.tables.map(f),v={};return E.forEach(function(T){return v[T.name]=T}),{stack:"dbcore",transaction:i.transaction.bind(i),table:function(T){if(!v[T])throw new Error("Table '".concat(T,"' not found"));return v[T]},MIN_KEY:-1/0,MAX_KEY:$n(o),schema:b}}function ll(i,o,c,u){var f=c.IDBKeyRange;return c.indexedDB,{dbcore:(u=cl(o,f,u),i.dbcore.reduce(function(h,m){return m=m.create,s(s({},h),m(h))},u))}}function bs(i,u){var c=u.db,u=ll(i._middlewares,c,i._deps,u);i.core=u.dbcore,i.tables.forEach(function(f){var h=f.name;i.core.schema.tables.some(function(m){return m.name===h})&&(f.core=i.core.table(h),i[h]instanceof i.Table&&(i[h].core=f.core))})}function ws(i,o,c,u){c.forEach(function(f){var h=u[f];o.forEach(function(m){var g=function b(k,E){return $(k,E)||(k=y(k))&&b(k,E)}(m,f);(!g||"value"in g&&g.value===void 0)&&(m===i.Transaction.prototype||m instanceof i.Transaction?F(m,f,{get:function(){return this.table(f)},set:function(b){M(this,f,{value:b,writable:!0,configurable:!0,enumerable:!0})}}):m[f]=new i.Table(f,h))})})}function Fi(i,o){o.forEach(function(c){for(var u in c)c[u]instanceof i.Table&&delete c[u]})}function ul(i,o){return i._cfg.version-o._cfg.version}function fl(i,o,c,u){var f=i._dbSchema;c.objectStoreNames.contains("$meta")&&!f.$meta&&(f.$meta=ji("$meta",No("")[0],[]),i._storeNames.push("$meta"));var h=i._createTransaction("readwrite",i._storeNames,f);h.create(c),h._completion.catch(u);var m=h._reject.bind(h),g=X.transless||X;ut(function(){return X.trans=h,X.transless=g,o!==0?(bs(i,c),k=o,((b=h).storeNames.includes("$meta")?b.table("$meta").get("version").then(function(E){return E??k}):z.resolve(k)).then(function(E){return T=E,w=h,_=c,A=[],E=(v=i)._versions,S=v._dbSchema=Ss(0,v.idbdb,_),(E=E.filter(function(L){return L._cfg.version>=T})).length!==0?(E.forEach(function(L){A.push(function(){var C=S,N=L._cfg.dbschema;_s(v,C,_),_s(v,N,_),S=v._dbSchema=N;var D=Ri(C,N);D.add.forEach(function(V){Ui(_,V[0],V[1].primKey,V[1].indexes)}),D.change.forEach(function(V){if(V.recreate)throw new ne.Upgrade("Not yet support for changing primary key");var R=_.objectStore(V.name);V.add.forEach(function(Y){return ks(R,Y)}),V.change.forEach(function(Y){R.deleteIndex(Y.name),ks(R,Y)}),V.del.forEach(function(Y){return R.deleteIndex(Y)})});var K=L._cfg.contentUpgrade;if(K&&L._cfg.version>T){bs(v,_),w._memoizedTables={};var U=J(N);D.del.forEach(function(V){U[V]=C[V]}),Fi(v,[v.Transaction.prototype]),ws(v,[v.Transaction.prototype],l(U),U),w.schema=U;var j,q=ki(K);return q&&Xt(),D=z.follow(function(){var V;(j=K(w))&&q&&(V=ft.bind(null,null),j.then(V,V))}),j&&typeof j.then=="function"?z.resolve(j):D.then(function(){return j})}}),A.push(function(C){var N,D,K=L._cfg.dbschema;N=K,D=C,[].slice.call(D.db.objectStoreNames).forEach(function(U){return N[U]==null&&D.db.deleteObjectStore(U)}),Fi(v,[v.Transaction.prototype]),ws(v,[v.Transaction.prototype],v._storeNames,v._dbSchema),w.schema=v._dbSchema}),A.push(function(C){v.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(v.idbdb.version/10)===L._cfg.version?(v.idbdb.deleteObjectStore("$meta"),delete v._dbSchema.$meta,v._storeNames=v._storeNames.filter(function(N){return N!=="$meta"})):C.objectStore("$meta").put(L._cfg.version,"version"))})}),function L(){return A.length?z.resolve(A.shift()(w.idbtrans)).then(L):z.resolve()}().then(function(){Co(S,_)})):z.resolve();var v,T,w,_,A,S}).catch(m)):(l(f).forEach(function(E){Ui(c,E,f[E].primKey,f[E].indexes)}),bs(i,c),void z.follow(function(){return i.on.populate.fire(h)}).catch(m));var b,k})}function dl(i,o){Co(i._dbSchema,o),o.db.version%10!=0||o.objectStoreNames.contains("$meta")||o.db.createObjectStore("$meta").add(Math.ceil(o.db.version/10-1),"version");var c=Ss(0,i.idbdb,o);_s(i,i._dbSchema,o);for(var u=0,f=Ri(c,i._dbSchema).change;u<f.length;u++){var h=function(m){if(m.change.length||m.recreate)return console.warn("Unable to patch indexes of table ".concat(m.name," because it has changes on the type of index or primary key.")),{value:void 0};var g=o.objectStore(m.name);m.add.forEach(function(b){We&&console.debug("Dexie upgrade patch: Creating missing index ".concat(m.name,".").concat(b.src)),ks(g,b)})}(f[u]);if(typeof h=="object")return h.value}}function Ri(i,o){var c,u={del:[],add:[],change:[]};for(c in i)o[c]||u.del.push(c);for(c in o){var f=i[c],h=o[c];if(f){var m={name:c,def:h,recreate:!1,del:[],add:[],change:[]};if(""+(f.primKey.keyPath||"")!=""+(h.primKey.keyPath||"")||f.primKey.auto!==h.primKey.auto)m.recreate=!0,u.change.push(m);else{var g=f.idxByName,b=h.idxByName,k=void 0;for(k in g)b[k]||m.del.push(k);for(k in b){var E=g[k],v=b[k];E?E.src!==v.src&&m.change.push(v):m.add.push(v)}(0<m.del.length||0<m.add.length||0<m.change.length)&&u.change.push(m)}}else u.add.push([c,h])}return u}function Ui(i,o,c,u){var f=i.db.createObjectStore(o,c.keyPath?{keyPath:c.keyPath,autoIncrement:c.auto}:{autoIncrement:c.auto});return u.forEach(function(h){return ks(f,h)}),f}function Co(i,o){l(i).forEach(function(c){o.db.objectStoreNames.contains(c)||(We&&console.debug("Dexie: Creating missing table",c),Ui(o,c,i[c].primKey,i[c].indexes))})}function ks(i,o){i.createIndex(o.name,o.keyPath,{unique:o.unique,multiEntry:o.multi})}function Ss(i,o,c){var u={};return W(o.objectStoreNames,0).forEach(function(f){for(var h=c.objectStore(f),m=Ki(Lo(k=h.keyPath),k||"",!0,!1,!!h.autoIncrement,k&&typeof k!="string",!0),g=[],b=0;b<h.indexNames.length;++b){var E=h.index(h.indexNames[b]),k=E.keyPath,E=Ki(E.name,k,!!E.unique,!!E.multiEntry,!1,k&&typeof k!="string",!1);g.push(E)}u[f]=ji(f,m,g)}),u}function _s(i,o,c){for(var u=c.db.objectStoreNames,f=0;f<u.length;++f){var h=u[f],m=c.objectStore(h);i._hasGetAll="getAll"in m;for(var g=0;g<m.indexNames.length;++g){var b=m.indexNames[g],k=m.index(b).keyPath,E=typeof k=="string"?k:"["+W(k).join("+")+"]";!o[h]||(k=o[h].idxByName[E])&&(k.name=b,delete o[h].idxByName[E],o[h].idxByName[b]=k)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(i._hasGetAll=!1)}function No(i){return i.split(",").map(function(o,c){var u=(o=o.trim()).replace(/([&*]|\+\+)/g,""),f=/^\[/.test(u)?u.match(/^\[(.*)\]$/)[1].split("+"):u;return Ki(u,f||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),d(f),c===0)})}var hl=(Es.prototype._parseStoresSpec=function(i,o){l(i).forEach(function(c){if(i[c]!==null){var u=No(i[c]),f=u.shift();if(f.unique=!0,f.multi)throw new ne.Schema("Primary key cannot be multi-valued");u.forEach(function(h){if(h.auto)throw new ne.Schema("Only primary key can be marked as autoIncrement (++)");if(!h.keyPath)throw new ne.Schema("Index must have a name and cannot be an empty string")}),o[c]=ji(c,f,u)}})},Es.prototype.stores=function(c){var o=this.db;this._cfg.storesSource=this._cfg.storesSource?p(this._cfg.storesSource,c):c;var c=o._versions,u={},f={};return c.forEach(function(h){p(u,h._cfg.storesSource),f=h._cfg.dbschema={},h._parseStoresSpec(u,f)}),o._dbSchema=f,Fi(o,[o._allTables,o,o.Transaction.prototype]),ws(o,[o._allTables,o,o.Transaction.prototype,this._cfg.tables],l(f),f),o._storeNames=l(f),this},Es.prototype.upgrade=function(i){return this._cfg.contentUpgrade=_i(this._cfg.contentUpgrade||pe,i),this},Es);function Es(){}function Vi(i,o){var c=i._dbNamesDB;return c||(c=i._dbNamesDB=new it(ps,{addons:[],indexedDB:i,IDBKeyRange:o})).version(1).stores({dbnames:"name"}),c.table("dbnames")}function Hi(i){return i&&typeof i.databases=="function"}function zi(i){return ut(function(){return X.letThrough=!0,i()})}function Yi(i){return!("from"in i)}var Le=function(i,o){if(!this){var c=new Le;return i&&"d"in i&&p(c,i),c}p(this,arguments.length?{d:1,from:i,to:1<arguments.length?o:i}:{d:0})};function xn(i,o,c){var u=de(o,c);if(!isNaN(u)){if(0<u)throw RangeError();if(Yi(i))return p(i,{from:o,to:c,d:1});var f=i.l,u=i.r;if(de(c,i.from)<0)return f?xn(f,o,c):i.l={from:o,to:c,d:1,l:null,r:null},Po(i);if(0<de(o,i.to))return u?xn(u,o,c):i.r={from:o,to:c,d:1,l:null,r:null},Po(i);de(o,i.from)<0&&(i.from=o,i.l=null,i.d=u?u.d+1:1),0<de(c,i.to)&&(i.to=c,i.r=null,i.d=i.l?i.l.d+1:1),c=!i.r,f&&!i.l&&Kn(i,f),u&&c&&Kn(i,u)}}function Kn(i,o){Yi(o)||function c(u,b){var h=b.from,m=b.to,g=b.l,b=b.r;xn(u,h,m),g&&c(u,g),b&&c(u,b)}(i,o)}function Bo(i,o){var c=Is(o),u=c.next();if(u.done)return!1;for(var f=u.value,h=Is(i),m=h.next(f.from),g=m.value;!u.done&&!m.done;){if(de(g.from,f.to)<=0&&0<=de(g.to,f.from))return!0;de(f.from,g.from)<0?f=(u=c.next(g.from)).value:g=(m=h.next(f.from)).value}return!1}function Is(i){var o=Yi(i)?null:{s:0,n:i};return{next:function(c){for(var u=0<arguments.length;o;)switch(o.s){case 0:if(o.s=1,u)for(;o.n.l&&de(c,o.n.from)<0;)o={up:o,n:o.n.l,s:1};else for(;o.n.l;)o={up:o,n:o.n.l,s:1};case 1:if(o.s=2,!u||de(c,o.n.to)<=0)return{value:o.n,done:!1};case 2:if(o.n.r){o.s=3,o={up:o,n:o.n.r,s:0};continue}case 3:o=o.up}return{done:!0}}}}function Po(i){var o,c,u=(((o=i.r)===null||o===void 0?void 0:o.d)||0)-(((c=i.l)===null||c===void 0?void 0:c.d)||0),f=1<u?"r":u<-1?"l":"";f&&(o=f=="r"?"l":"r",c=s({},i),u=i[f],i.from=u.from,i.to=u.to,i[f]=u[f],c[f]=u[o],(i[o]=c).d=Mo(c)),i.d=Mo(i)}function Mo(c){var o=c.r,c=c.l;return(o?c?Math.max(o.d,c.d):o.d:c?c.d:0)+1}function As(i,o){return l(o).forEach(function(c){i[c]?Kn(i[c],o[c]):i[c]=function u(f){var h,m,g={};for(h in f)I(f,h)&&(m=f[h],g[h]=!m||typeof m!="object"||tt.has(m.constructor)?m:u(m));return g}(o[c])}),i}function Gi(i,o){return i.all||o.all||Object.keys(i).some(function(c){return o[c]&&Bo(o[c],i[c])})}P(Le.prototype,((Re={add:function(i){return Kn(this,i),this},addKey:function(i){return xn(this,i,i),this},addKeys:function(i){var o=this;return i.forEach(function(c){return xn(o,c,c)}),this},hasKey:function(i){var o=Is(this).next(i).value;return o&&de(o.from,i)<=0&&0<=de(o.to,i)}})[wi]=function(){return Is(this)},Re));var Mt={},Ji={},Wi=!1;function Ts(i){As(Ji,i),Wi||(Wi=!0,setTimeout(function(){Wi=!1,Qi(Ji,!(Ji={}))},0))}function Qi(i,o){o===void 0&&(o=!1);var c=new Set;if(i.all)for(var u=0,f=Object.values(Mt);u<f.length;u++)$o(m=f[u],i,c,o);else for(var h in i){var m,g=/^idb\:\/\/(.*)\/(.*)\//.exec(h);g&&(h=g[1],g=g[2],(m=Mt["idb://".concat(h,"/").concat(g)])&&$o(m,i,c,o))}c.forEach(function(b){return b()})}function $o(i,o,c,u){for(var f=[],h=0,m=Object.entries(i.queries.query);h<m.length;h++){for(var g=m[h],b=g[0],k=[],E=0,v=g[1];E<v.length;E++){var T=v[E];Gi(o,T.obsSet)?T.subscribers.forEach(function(S){return c.add(S)}):u&&k.push(T)}u&&f.push([b,k])}if(u)for(var w=0,_=f;w<_.length;w++){var A=_[w],b=A[0],k=A[1];i.queries.query[b]=k}}function pl(i){var o=i._state,c=i._deps.indexedDB;if(o.isBeingOpened||i.idbdb)return o.dbReadyPromise.then(function(){return o.dbOpenError?_e(o.dbOpenError):i});o.isBeingOpened=!0,o.dbOpenError=null,o.openComplete=!1;var u=o.openCanceller,f=Math.round(10*i.verno),h=!1;function m(){if(o.openCanceller!==u)throw new ne.DatabaseClosed("db.open() was cancelled")}function g(){return new z(function(T,w){if(m(),!c)throw new ne.MissingAPI;var _=i.name,A=o.autoSchema||!f?c.open(_):c.open(_,f);if(!A)throw new ne.MissingAPI;A.onerror=Qe(w),A.onblocked=ve(i._fireOnBlocked),A.onupgradeneeded=ve(function(S){var L;E=A.transaction,o.autoSchema&&!i._options.allowEmptyDB?(A.onerror=Pn,E.abort(),A.result.close(),(L=c.deleteDatabase(_)).onsuccess=L.onerror=ve(function(){w(new ne.NoSuchDatabase("Database ".concat(_," doesnt exist")))})):(E.onerror=Qe(w),S=S.oldVersion>Math.pow(2,62)?0:S.oldVersion,v=S<1,i.idbdb=A.result,h&&dl(i,E),fl(i,S/10,E,w))},w),A.onsuccess=ve(function(){E=null;var S,L,C,N,D,K=i.idbdb=A.result,U=W(K.objectStoreNames);if(0<U.length)try{var j=K.transaction((N=U).length===1?N[0]:N,"readonly");if(o.autoSchema)L=K,C=j,(S=i).verno=L.version/10,C=S._dbSchema=Ss(0,L,C),S._storeNames=W(L.objectStoreNames,0),ws(S,[S._allTables],l(C),C);else if(_s(i,i._dbSchema,j),((D=Ri(Ss(0,(D=i).idbdb,j),D._dbSchema)).add.length||D.change.some(function(q){return q.add.length||q.change.length}))&&!h)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),K.close(),f=K.version+1,h=!0,T(g());bs(i,j)}catch{}Zt.push(i),K.onversionchange=ve(function(q){o.vcFired=!0,i.on("versionchange").fire(q)}),K.onclose=ve(function(q){i.on("close").fire(q)}),v&&(D=i._deps,j=_,K=D.indexedDB,D=D.IDBKeyRange,Hi(K)||j===ps||Vi(K,D).put({name:j}).catch(pe)),T()},w)}).catch(function(T){switch(T==null?void 0:T.name){case"UnknownError":if(0<o.PR1398_maxLoop)return o.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),g();break;case"VersionError":if(0<f)return f=0,g()}return z.reject(T)})}var b,k=o.dbReadyResolve,E=null,v=!1;return z.race([u,(typeof navigator>"u"?z.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(T){function w(){return indexedDB.databases().finally(T)}b=setInterval(w,100),w()}).finally(function(){return clearInterval(b)}):Promise.resolve()).then(g)]).then(function(){return m(),o.onReadyBeingFired=[],z.resolve(zi(function(){return i.on.ready.fire(i.vip)})).then(function T(){if(0<o.onReadyBeingFired.length){var w=o.onReadyBeingFired.reduce(_i,pe);return o.onReadyBeingFired=[],z.resolve(zi(function(){return w(i.vip)})).then(T)}})}).finally(function(){o.openCanceller===u&&(o.onReadyBeingFired=null,o.isBeingOpened=!1)}).catch(function(T){o.dbOpenError=T;try{E&&E.abort()}catch{}return u===o.openCanceller&&i._close(),_e(T)}).finally(function(){o.openComplete=!0,k()}).then(function(){var T;return v&&(T={},i.tables.forEach(function(w){w.schema.indexes.forEach(function(_){_.name&&(T["idb://".concat(i.name,"/").concat(w.name,"/").concat(_.name)]=new Le(-1/0,[[[]]]))}),T["idb://".concat(i.name,"/").concat(w.name,"/")]=T["idb://".concat(i.name,"/").concat(w.name,"/:dels")]=new Le(-1/0,[[[]]])}),pt(Mn).fire(T),Qi(T,!0)),i})}function Xi(i){function o(h){return i.next(h)}var c=f(o),u=f(function(h){return i.throw(h)});function f(h){return function(b){var g=h(b),b=g.value;return g.done?b:b&&typeof b.then=="function"?b.then(c,u):d(b)?Promise.all(b).then(c,u):c(b)}}return f(o)()}function Ls(i,o,c){for(var u=d(i)?i.slice():[i],f=0;f<c;++f)u.push(o);return u}var ml={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(i){return s(s({},i),{table:function(o){var c=i.table(o),u=c.schema,f={},h=[];function m(v,T,w){var _=Dn(v),A=f[_]=f[_]||[],S=v==null?0:typeof v=="string"?1:v.length,L=0<T,L=s(s({},w),{name:L?"".concat(_,"(virtual-from:").concat(w.name,")"):w.name,lowLevelIndex:w,isVirtual:L,keyTail:T,keyLength:S,extractKey:qi(v),unique:!L&&w.unique});return A.push(L),L.isPrimaryKey||h.push(L),1<S&&m(S===2?v[0]:v.slice(0,S-1),T+1,w),A.sort(function(C,N){return C.keyTail-N.keyTail}),L}o=m(u.primaryKey.keyPath,0,u.primaryKey),f[":id"]=[o];for(var g=0,b=u.indexes;g<b.length;g++){var k=b[g];m(k.keyPath,0,k)}function E(v){var T,w=v.query.index;return w.isVirtual?s(s({},v),{query:{index:w.lowLevelIndex,range:(T=v.query.range,w=w.keyTail,{type:T.type===1?2:T.type,lower:Ls(T.lower,T.lowerOpen?i.MAX_KEY:i.MIN_KEY,w),lowerOpen:!0,upper:Ls(T.upper,T.upperOpen?i.MIN_KEY:i.MAX_KEY,w),upperOpen:!0})}}):v}return s(s({},c),{schema:s(s({},u),{primaryKey:o,indexes:h,getIndexByKeyPath:function(v){return(v=f[Dn(v)])&&v[0]}}),count:function(v){return c.count(E(v))},query:function(v){return c.query(E(v))},openCursor:function(v){var T=v.query.index,w=T.keyTail,_=T.isVirtual,A=T.keyLength;return _?c.openCursor(E(v)).then(function(L){return L&&S(L)}):c.openCursor(v);function S(L){return Object.create(L,{continue:{value:function(C){C!=null?L.continue(Ls(C,v.reverse?i.MAX_KEY:i.MIN_KEY,w)):v.unique?L.continue(L.key.slice(0,A).concat(v.reverse?i.MIN_KEY:i.MAX_KEY,w)):L.continue()}},continuePrimaryKey:{value:function(C,N){L.continuePrimaryKey(Ls(C,i.MAX_KEY,w),N)}},primaryKey:{get:function(){return L.primaryKey}},key:{get:function(){var C=L.key;return A===1?C[0]:C.slice(0,A)}},value:{get:function(){return L.value}}})}}})}})}};function Zi(i,o,c,u){return c=c||{},u=u||"",l(i).forEach(function(f){var h,m,g;I(o,f)?(h=i[f],m=o[f],typeof h=="object"&&typeof m=="object"&&h&&m?(g=bi(h))!==bi(m)?c[u+f]=o[f]:g==="Object"?Zi(h,m,c,u+f+"."):h!==m&&(c[u+f]=o[f]):h!==m&&(c[u+f]=o[f])):c[u+f]=void 0}),l(o).forEach(function(f){I(i,f)||(c[u+f]=o[f])}),c}function er(i,o){return o.type==="delete"?o.keys:o.keys||o.values.map(i.extractKey)}var yl={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(i){return s(s({},i),{table:function(o){var c=i.table(o),u=c.schema.primaryKey;return s(s({},c),{mutate:function(f){var h=X.trans,m=h.table(o).hook,g=m.deleting,b=m.creating,k=m.updating;switch(f.type){case"add":if(b.fire===pe)break;return h._promise("readwrite",function(){return E(f)},!0);case"put":if(b.fire===pe&&k.fire===pe)break;return h._promise("readwrite",function(){return E(f)},!0);case"delete":if(g.fire===pe)break;return h._promise("readwrite",function(){return E(f)},!0);case"deleteRange":if(g.fire===pe)break;return h._promise("readwrite",function(){return function v(T,w,_){return c.query({trans:T,values:!1,query:{index:u,range:w},limit:_}).then(function(A){var S=A.result;return E({type:"delete",keys:S,trans:T}).then(function(L){return 0<L.numFailures?Promise.reject(L.failures[0]):S.length<_?{failures:[],numFailures:0,lastResult:void 0}:v(T,s(s({},w),{lower:S[S.length-1],lowerOpen:!0}),_)})})}(f.trans,f.range,1e4)},!0)}return c.mutate(f);function E(v){var T,w,_,A=X.trans,S=v.keys||er(u,v);if(!S)throw new Error("Keys missing");return(v=v.type==="add"||v.type==="put"?s(s({},v),{keys:S}):s({},v)).type!=="delete"&&(v.values=r([],v.values)),v.keys&&(v.keys=r([],v.keys)),T=c,_=S,((w=v).type==="add"?Promise.resolve([]):T.getMany({trans:w.trans,keys:_,cache:"immutable"})).then(function(L){var C=S.map(function(N,D){var K,U,j,q=L[D],V={onerror:null,onsuccess:null};return v.type==="delete"?g.fire.call(V,N,q,A):v.type==="add"||q===void 0?(K=b.fire.call(V,N,v.values[D],A),N==null&&K!=null&&(v.keys[D]=N=K,u.outbound||ce(v.values[D],u.keyPath,N))):(K=Zi(q,v.values[D]),(U=k.fire.call(V,K,N,q,A))&&(j=v.values[D],Object.keys(U).forEach(function(R){I(j,R)?j[R]=U[R]:ce(j,R,U[R])}))),V});return c.mutate(v).then(function(N){for(var D=N.failures,K=N.results,U=N.numFailures,N=N.lastResult,j=0;j<S.length;++j){var q=(K||S)[j],V=C[j];q==null?V.onerror&&V.onerror(D[j]):V.onsuccess&&V.onsuccess(v.type==="put"&&L[j]?v.values[j]:q)}return{failures:D,results:K,numFailures:U,lastResult:N}}).catch(function(N){return C.forEach(function(D){return D.onerror&&D.onerror(N)}),Promise.reject(N)})})}}})}})}};function Do(i,o,c){try{if(!o||o.keys.length<i.length)return null;for(var u=[],f=0,h=0;f<o.keys.length&&h<i.length;++f)de(o.keys[f],i[h])===0&&(u.push(c?Je(o.values[f]):o.values[f]),++h);return u.length===i.length?u:null}catch{return null}}var gl={stack:"dbcore",level:-1,create:function(i){return{table:function(o){var c=i.table(o);return s(s({},c),{getMany:function(u){if(!u.cache)return c.getMany(u);var f=Do(u.keys,u.trans._cache,u.cache==="clone");return f?z.resolve(f):c.getMany(u).then(function(h){return u.trans._cache={keys:u.keys,values:u.cache==="clone"?Je(h):h},h})},mutate:function(u){return u.type!=="add"&&(u.trans._cache=null),c.mutate(u)}})}}}};function xo(i,o){return i.trans.mode==="readonly"&&!!i.subscr&&!i.trans.explicit&&i.trans.db._options.cache!=="disabled"&&!o.schema.primaryKey.outbound}function Ko(i,o){switch(i){case"query":return o.values&&!o.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var vl={stack:"dbcore",level:0,name:"Observability",create:function(i){var o=i.schema.name,c=new Le(i.MIN_KEY,i.MAX_KEY);return s(s({},i),{transaction:function(u,f,h){if(X.subscr&&f!=="readonly")throw new ne.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(X.querier));return i.transaction(u,f,h)},table:function(u){var f=i.table(u),h=f.schema,m=h.primaryKey,v=h.indexes,g=m.extractKey,b=m.outbound,k=m.autoIncrement&&v.filter(function(w){return w.compound&&w.keyPath.includes(m.keyPath)}),E=s(s({},f),{mutate:function(w){function _(R){return R="idb://".concat(o,"/").concat(u,"/").concat(R),N[R]||(N[R]=new Le)}var A,S,L,C=w.trans,N=w.mutatedParts||(w.mutatedParts={}),D=_(""),K=_(":dels"),U=w.type,V=w.type==="deleteRange"?[w.range]:w.type==="delete"?[w.keys]:w.values.length<50?[er(m,w).filter(function(R){return R}),w.values]:[],j=V[0],q=V[1],V=w.trans._cache;return d(j)?(D.addKeys(j),(V=U==="delete"||j.length===q.length?Do(j,V):null)||K.addKeys(j),(V||q)&&(A=_,S=V,L=q,h.indexes.forEach(function(R){var Y=A(R.name||"");function re(ue){return ue!=null?R.extractKey(ue):null}function le(ue){return R.multiEntry&&d(ue)?ue.forEach(function(qe){return Y.addKey(qe)}):Y.addKey(ue)}(S||L).forEach(function(ue,Oe){var ie=S&&re(S[Oe]),Oe=L&&re(L[Oe]);de(ie,Oe)!==0&&(ie!=null&&le(ie),Oe!=null&&le(Oe))})}))):j?(q={from:(q=j.lower)!==null&&q!==void 0?q:i.MIN_KEY,to:(q=j.upper)!==null&&q!==void 0?q:i.MAX_KEY},K.add(q),D.add(q)):(D.add(c),K.add(c),h.indexes.forEach(function(R){return _(R.name).add(c)})),f.mutate(w).then(function(R){return!j||w.type!=="add"&&w.type!=="put"||(D.addKeys(R.results),k&&k.forEach(function(Y){for(var re=w.values.map(function(ie){return Y.extractKey(ie)}),le=Y.keyPath.findIndex(function(ie){return ie===m.keyPath}),ue=0,qe=R.results.length;ue<qe;++ue)re[ue][le]=R.results[ue];_(Y.name).addKeys(re)})),C.mutatedParts=As(C.mutatedParts||{},N),R})}}),v=function(_){var A=_.query,_=A.index,A=A.range;return[_,new Le((_=A.lower)!==null&&_!==void 0?_:i.MIN_KEY,(A=A.upper)!==null&&A!==void 0?A:i.MAX_KEY)]},T={get:function(w){return[m,new Le(w.key)]},getMany:function(w){return[m,new Le().addKeys(w.keys)]},count:v,query:v,openCursor:v};return l(T).forEach(function(w){E[w]=function(_){var A=X.subscr,S=!!A,L=xo(X,f)&&Ko(w,_)?_.obsSet={}:A;if(S){var C=function(q){return q="idb://".concat(o,"/").concat(u,"/").concat(q),L[q]||(L[q]=new Le)},N=C(""),D=C(":dels"),A=T[w](_),S=A[0],A=A[1];if((w==="query"&&S.isPrimaryKey&&!_.values?D:C(S.name||"")).add(A),!S.isPrimaryKey){if(w!=="count"){var K=w==="query"&&b&&_.values&&f.query(s(s({},_),{values:!1}));return f[w].apply(this,arguments).then(function(q){if(w==="query"){if(b&&_.values)return K.then(function(re){return re=re.result,N.addKeys(re),q});var V=_.values?q.result.map(g):q.result;(_.values?N:D).addKeys(V)}else if(w==="openCursor"){var R=q,Y=_.values;return R&&Object.create(R,{key:{get:function(){return D.addKey(R.primaryKey),R.key}},primaryKey:{get:function(){var re=R.primaryKey;return D.addKey(re),re}},value:{get:function(){return Y&&N.addKey(R.primaryKey),R.value}}})}return q})}D.add(c)}}return f[w].apply(this,arguments)}}),E}})}};function jo(i,o,c){if(c.numFailures===0)return o;if(o.type==="deleteRange")return null;var u=o.keys?o.keys.length:"values"in o&&o.values?o.values.length:1;return c.numFailures===u?null:(o=s({},o),d(o.keys)&&(o.keys=o.keys.filter(function(f,h){return!(h in c.failures)})),"values"in o&&d(o.values)&&(o.values=o.values.filter(function(f,h){return!(h in c.failures)})),o)}function tr(i,o){return c=i,((u=o).lower===void 0||(u.lowerOpen?0<de(c,u.lower):0<=de(c,u.lower)))&&(i=i,(o=o).upper===void 0||(o.upperOpen?de(i,o.upper)<0:de(i,o.upper)<=0));var c,u}function qo(i,o,T,u,f,h){if(!T||T.length===0)return i;var m=o.query.index,g=m.multiEntry,b=o.query.range,k=u.schema.primaryKey.extractKey,E=m.extractKey,v=(m.lowLevelIndex||m).extractKey,T=T.reduce(function(w,_){var A=w,S=[];if(_.type==="add"||_.type==="put")for(var L=new Le,C=_.values.length-1;0<=C;--C){var N,D=_.values[C],K=k(D);L.hasKey(K)||(N=E(D),(g&&d(N)?N.some(function(R){return tr(R,b)}):tr(N,b))&&(L.addKey(K),S.push(D)))}switch(_.type){case"add":var U=new Le().addKeys(o.values?w.map(function(Y){return k(Y)}):w),A=w.concat(o.values?S.filter(function(Y){return Y=k(Y),!U.hasKey(Y)&&(U.addKey(Y),!0)}):S.map(function(Y){return k(Y)}).filter(function(Y){return!U.hasKey(Y)&&(U.addKey(Y),!0)}));break;case"put":var j=new Le().addKeys(_.values.map(function(Y){return k(Y)}));A=w.filter(function(Y){return!j.hasKey(o.values?k(Y):Y)}).concat(o.values?S:S.map(function(Y){return k(Y)}));break;case"delete":var q=new Le().addKeys(_.keys);A=w.filter(function(Y){return!q.hasKey(o.values?k(Y):Y)});break;case"deleteRange":var V=_.range;A=w.filter(function(Y){return!tr(k(Y),V)})}return A},i);return T===i?i:(T.sort(function(w,_){return de(v(w),v(_))||de(k(w),k(_))}),o.limit&&o.limit<1/0&&(T.length>o.limit?T.length=o.limit:i.length===o.limit&&T.length<o.limit&&(f.dirty=!0)),h?Object.freeze(T):T)}function Fo(i,o){return de(i.lower,o.lower)===0&&de(i.upper,o.upper)===0&&!!i.lowerOpen==!!o.lowerOpen&&!!i.upperOpen==!!o.upperOpen}function bl(i,o){return function(c,u,f,h){if(c===void 0)return u!==void 0?-1:0;if(u===void 0)return 1;if((u=de(c,u))===0){if(f&&h)return 0;if(f)return 1;if(h)return-1}return u}(i.lower,o.lower,i.lowerOpen,o.lowerOpen)<=0&&0<=function(c,u,f,h){if(c===void 0)return u!==void 0?1:0;if(u===void 0)return-1;if((u=de(c,u))===0){if(f&&h)return 0;if(f)return-1;if(h)return 1}return u}(i.upper,o.upper,i.upperOpen,o.upperOpen)}function wl(i,o,c,u){i.subscribers.add(c),u.addEventListener("abort",function(){var f,h;i.subscribers.delete(c),i.subscribers.size===0&&(f=i,h=o,setTimeout(function(){f.subscribers.size===0&&It(h,f)},3e3))})}var kl={stack:"dbcore",level:0,name:"Cache",create:function(i){var o=i.schema.name;return s(s({},i),{transaction:function(c,u,f){var h,m,g=i.transaction(c,u,f);return u==="readwrite"&&(m=(h=new AbortController).signal,f=function(b){return function(){if(h.abort(),u==="readwrite"){for(var k=new Set,E=0,v=c;E<v.length;E++){var T=v[E],w=Mt["idb://".concat(o,"/").concat(T)];if(w){var _=i.table(T),A=w.optimisticOps.filter(function(Y){return Y.trans===g});if(g._explicit&&b&&g.mutatedParts)for(var S=0,L=Object.values(w.queries.query);S<L.length;S++)for(var C=0,N=(U=L[S]).slice();C<N.length;C++)Gi((j=N[C]).obsSet,g.mutatedParts)&&(It(U,j),j.subscribers.forEach(function(Y){return k.add(Y)}));else if(0<A.length){w.optimisticOps=w.optimisticOps.filter(function(Y){return Y.trans!==g});for(var D=0,K=Object.values(w.queries.query);D<K.length;D++)for(var U,j,q,V=0,R=(U=K[D]).slice();V<R.length;V++)(j=R[V]).res!=null&&g.mutatedParts&&(b&&!j.dirty?(q=Object.isFrozen(j.res),q=qo(j.res,j.req,A,_,j,q),j.dirty?(It(U,j),j.subscribers.forEach(function(Y){return k.add(Y)})):q!==j.res&&(j.res=q,j.promise=z.resolve({result:q}))):(j.dirty&&It(U,j),j.subscribers.forEach(function(Y){return k.add(Y)})))}}}k.forEach(function(Y){return Y()})}}},g.addEventListener("abort",f(!1),{signal:m}),g.addEventListener("error",f(!1),{signal:m}),g.addEventListener("complete",f(!0),{signal:m})),g},table:function(c){var u=i.table(c),f=u.schema.primaryKey;return s(s({},u),{mutate:function(h){var m=X.trans;if(f.outbound||m.db._options.cache==="disabled"||m.explicit||m.idbtrans.mode!=="readwrite")return u.mutate(h);var g=Mt["idb://".concat(o,"/").concat(c)];return g?(m=u.mutate(h),h.type!=="add"&&h.type!=="put"||!(50<=h.values.length||er(f,h).some(function(b){return b==null}))?(g.optimisticOps.push(h),h.mutatedParts&&Ts(h.mutatedParts),m.then(function(b){0<b.numFailures&&(It(g.optimisticOps,h),(b=jo(0,h,b))&&g.optimisticOps.push(b),h.mutatedParts&&Ts(h.mutatedParts))}),m.catch(function(){It(g.optimisticOps,h),h.mutatedParts&&Ts(h.mutatedParts)})):m.then(function(b){var k=jo(0,s(s({},h),{values:h.values.map(function(E,v){var T;return b.failures[v]?E:(E=(T=f.keyPath)!==null&&T!==void 0&&T.includes(".")?Je(E):s({},E),ce(E,f.keyPath,b.results[v]),E)})}),b);g.optimisticOps.push(k),queueMicrotask(function(){return h.mutatedParts&&Ts(h.mutatedParts)})}),m):u.mutate(h)},query:function(h){if(!xo(X,u)||!Ko("query",h))return u.query(h);var m=((k=X.trans)===null||k===void 0?void 0:k.db._options.cache)==="immutable",v=X,g=v.requery,b=v.signal,k=function(_,A,S,L){var C=Mt["idb://".concat(_,"/").concat(A)];if(!C)return[];if(!(A=C.queries[S]))return[null,!1,C,null];var N=A[(L.query?L.query.index.name:null)||""];if(!N)return[null,!1,C,null];switch(S){case"query":var D=N.find(function(K){return K.req.limit===L.limit&&K.req.values===L.values&&Fo(K.req.query.range,L.query.range)});return D?[D,!0,C,N]:[N.find(function(K){return("limit"in K.req?K.req.limit:1/0)>=L.limit&&(!L.values||K.req.values)&&bl(K.req.query.range,L.query.range)}),!1,C,N];case"count":return D=N.find(function(K){return Fo(K.req.query.range,L.query.range)}),[D,!!D,C,N]}}(o,c,"query",h),E=k[0],v=k[1],T=k[2],w=k[3];return E&&v?E.obsSet=h.obsSet:(v=u.query(h).then(function(_){var A=_.result;if(E&&(E.res=A),m){for(var S=0,L=A.length;S<L;++S)Object.freeze(A[S]);Object.freeze(A)}else _.result=Je(A);return _}).catch(function(_){return w&&E&&It(w,E),Promise.reject(_)}),E={obsSet:h.obsSet,promise:v,subscribers:new Set,type:"query",req:h,dirty:!1},w?w.push(E):(w=[E],(T=T||(Mt["idb://".concat(o,"/").concat(c)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[h.query.index.name||""]=w)),wl(E,w,g,b),E.promise.then(function(_){return{result:qo(_.result,h,T==null?void 0:T.optimisticOps,u,E,m)}})}})}})}};function Os(i,o){return new Proxy(i,{get:function(c,u,f){return u==="db"?o:Reflect.get(c,u,f)}})}var it=(Ee.prototype.version=function(i){if(isNaN(i)||i<.1)throw new ne.Type("Given version is not a positive number");if(i=Math.round(10*i)/10,this.idbdb||this._state.isBeingOpened)throw new ne.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,i);var o=this._versions,c=o.filter(function(u){return u._cfg.version===i})[0];return c||(c=new this.Version(i),o.push(c),o.sort(ul),c.stores({}),this._state.autoSchema=!1,c)},Ee.prototype._whenReady=function(i){var o=this;return this.idbdb&&(this._state.openComplete||X.letThrough||this._vip)?i():new z(function(c,u){if(o._state.openComplete)return u(new ne.DatabaseClosed(o._state.dbOpenError));if(!o._state.isBeingOpened){if(!o._state.autoOpen)return void u(new ne.DatabaseClosed);o.open().catch(pe)}o._state.dbReadyPromise.then(c,u)}).then(i)},Ee.prototype.use=function(i){var o=i.stack,c=i.create,u=i.level,f=i.name;return f&&this.unuse({stack:o,name:f}),i=this._middlewares[o]||(this._middlewares[o]=[]),i.push({stack:o,create:c,level:u??10,name:f}),i.sort(function(h,m){return h.level-m.level}),this},Ee.prototype.unuse=function(i){var o=i.stack,c=i.name,u=i.create;return o&&this._middlewares[o]&&(this._middlewares[o]=this._middlewares[o].filter(function(f){return u?f.create!==u:!!c&&f.name!==c})),this},Ee.prototype.open=function(){var i=this;return Nt(lt,function(){return pl(i)})},Ee.prototype._close=function(){var i=this._state,o=Zt.indexOf(this);if(0<=o&&Zt.splice(o,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}i.isBeingOpened||(i.dbReadyPromise=new z(function(c){i.dbReadyResolve=c}),i.openCanceller=new z(function(c,u){i.cancelOpen=u}))},Ee.prototype.close=function(c){var o=(c===void 0?{disableAutoOpen:!0}:c).disableAutoOpen,c=this._state;o?(c.isBeingOpened&&c.cancelOpen(new ne.DatabaseClosed),this._close(),c.autoOpen=!1,c.dbOpenError=new ne.DatabaseClosed):(this._close(),c.autoOpen=this._options.autoOpen||c.isBeingOpened,c.openComplete=!1,c.dbOpenError=null)},Ee.prototype.delete=function(i){var o=this;i===void 0&&(i={disableAutoOpen:!0});var c=0<arguments.length&&typeof arguments[0]!="object",u=this._state;return new z(function(f,h){function m(){o.close(i);var g=o._deps.indexedDB.deleteDatabase(o.name);g.onsuccess=ve(function(){var b,k,E;b=o._deps,k=o.name,E=b.indexedDB,b=b.IDBKeyRange,Hi(E)||k===ps||Vi(E,b).delete(k).catch(pe),f()}),g.onerror=Qe(h),g.onblocked=o._fireOnBlocked}if(c)throw new ne.InvalidArgument("Invalid closeOptions argument to db.delete()");u.isBeingOpened?u.dbReadyPromise.then(m):m()})},Ee.prototype.backendDB=function(){return this.idbdb},Ee.prototype.isOpen=function(){return this.idbdb!==null},Ee.prototype.hasBeenClosed=function(){var i=this._state.dbOpenError;return i&&i.name==="DatabaseClosed"},Ee.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ee.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ee.prototype,"tables",{get:function(){var i=this;return l(this._allTables).map(function(o){return i._allTables[o]})},enumerable:!1,configurable:!0}),Ee.prototype.transaction=function(){var i=(function(o,c,u){var f=arguments.length;if(f<2)throw new ne.InvalidArgument("Too few arguments");for(var h=new Array(f-1);--f;)h[f-1]=arguments[f];return u=h.pop(),[o,He(h),u]}).apply(this,arguments);return this._transaction.apply(this,i)},Ee.prototype._transaction=function(i,o,c){var u=this,f=X.trans;f&&f.db===this&&i.indexOf("!")===-1||(f=null);var h,m,g=i.indexOf("?")!==-1;i=i.replace("!","").replace("?","");try{if(m=o.map(function(k){if(k=k instanceof u.Table?k.name:k,typeof k!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return k}),i=="r"||i===Bi)h=Bi;else{if(i!="rw"&&i!=Pi)throw new ne.InvalidArgument("Invalid transaction mode: "+i);h=Pi}if(f){if(f.mode===Bi&&h===Pi){if(!g)throw new ne.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");f=null}f&&m.forEach(function(k){if(f&&f.storeNames.indexOf(k)===-1){if(!g)throw new ne.SubTransaction("Table "+k+" not included in parent transaction.");f=null}}),g&&f&&!f.active&&(f=null)}}catch(k){return f?f._promise(null,function(E,v){v(k)}):_e(k)}var b=(function k(E,v,T,w,_){return z.resolve().then(function(){var A=X.transless||X,S=E._createTransaction(v,T,E._dbSchema,w);if(S.explicit=!0,A={trans:S,transless:A},w)S.idbtrans=w.idbtrans;else try{S.create(),S.idbtrans._explicit=!0,E._state.PR1398_maxLoop=3}catch(N){return N.name===Si.InvalidState&&E.isOpen()&&0<--E._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),E.close({disableAutoOpen:!1}),E.open().then(function(){return k(E,v,T,null,_)})):_e(N)}var L,C=ki(_);return C&&Xt(),A=z.follow(function(){var N;(L=_.call(S,S))&&(C?(N=ft.bind(null,null),L.then(N,N)):typeof L.next=="function"&&typeof L.throw=="function"&&(L=Xi(L)))},A),(L&&typeof L.then=="function"?z.resolve(L).then(function(N){return S.active?N:_e(new ne.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):A.then(function(){return L})).then(function(N){return w&&S._resolve(),S._completion.then(function(){return N})}).catch(function(N){return S._reject(N),_e(N)})})}).bind(null,this,h,m,f,c);return f?f._promise(h,b,"lock"):X.trans?Nt(X.transless,function(){return u._whenReady(b)}):this._whenReady(b)},Ee.prototype.table=function(i){if(!I(this._allTables,i))throw new ne.InvalidTable("Table ".concat(i," does not exist"));return this._allTables[i]},Ee);function Ee(i,o){var c=this;this._middlewares={},this.verno=0;var u=Ee.dependencies;this._options=o=s({addons:Ee.addons,autoOpen:!0,indexedDB:u.indexedDB,IDBKeyRange:u.IDBKeyRange,cache:"cloned"},o),this._deps={indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},u=o.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var f,h,m,g,b,k={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:pe,dbReadyPromise:null,cancelOpen:pe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:o.autoOpen};k.dbReadyPromise=new z(function(v){k.dbReadyResolve=v}),k.openCanceller=new z(function(v,T){k.cancelOpen=T}),this._state=k,this.name=i,this.on=Cn(this,"populate","blocked","versionchange","close",{ready:[_i,pe]}),this.on.ready.subscribe=Z(this.on.ready.subscribe,function(v){return function(T,w){Ee.vip(function(){var _,A=c._state;A.openComplete?(A.dbOpenError||z.resolve().then(T),w&&v(T)):A.onReadyBeingFired?(A.onReadyBeingFired.push(T),w&&v(T)):(v(T),_=c,w||v(function S(){_.on.ready.unsubscribe(T),_.on.ready.unsubscribe(S)}))})}}),this.Collection=(f=this,Nn(sl.prototype,function(L,S){this.db=f;var w=vo,_=null;if(S)try{w=S()}catch(C){_=C}var A=L._ctx,S=A.table,L=S.hook.reading.fire;this._ctx={table:S,index:A.index,isPrimKey:!A.index||S.schema.primKey.keyPath&&A.index===S.schema.primKey.name,range:w,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:_,or:A.or,valueMapper:L!==In?L:null}})),this.Table=(h=this,Nn(So.prototype,function(v,T,w){this.db=h,this._tx=w,this.name=v,this.schema=T,this.hook=h._allTables[v]?h._allTables[v].hook:Cn(null,{creating:[Gc,pe],reading:[Yc,In],updating:[Wc,pe],deleting:[Jc,pe]})})),this.Transaction=(m=this,Nn(ol.prototype,function(v,T,w,_,A){var S=this;this.db=m,this.mode=v,this.storeNames=T,this.schema=w,this.chromeTransactionDurability=_,this.idbtrans=null,this.on=Cn(this,"complete","error","abort"),this.parent=A||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new z(function(L,C){S._resolve=L,S._reject=C}),this._completion.then(function(){S.active=!1,S.on.complete.fire()},function(L){var C=S.active;return S.active=!1,S.on.error.fire(L),S.parent?S.parent._reject(L):C&&S.idbtrans&&S.idbtrans.abort(),_e(L)})})),this.Version=(g=this,Nn(hl.prototype,function(v){this.db=g,this._cfg={version:v,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(b=this,Nn(To.prototype,function(v,T,w){if(this.db=b,this._ctx={table:v,index:T===":id"?null:T,or:w},this._cmp=this._ascending=de,this._descending=function(_,A){return de(A,_)},this._max=function(_,A){return 0<de(_,A)?_:A},this._min=function(_,A){return de(_,A)<0?_:A},this._IDBKeyRange=b._deps.IDBKeyRange,!this._IDBKeyRange)throw new ne.MissingAPI})),this.on("versionchange",function(v){0<v.newVersion?console.warn("Another connection wants to upgrade database '".concat(c.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(c.name,"'. Closing db now to resume the delete request.")),c.close({disableAutoOpen:!1})}),this.on("blocked",function(v){!v.newVersion||v.newVersion<v.oldVersion?console.warn("Dexie.delete('".concat(c.name,"') was blocked")):console.warn("Upgrade '".concat(c.name,"' blocked by other connection holding version ").concat(v.oldVersion/10))}),this._maxKey=$n(o.IDBKeyRange),this._createTransaction=function(v,T,w,_){return new c.Transaction(v,T,w,c._options.chromeTransactionDurability,_)},this._fireOnBlocked=function(v){c.on("blocked").fire(v),Zt.filter(function(T){return T.name===c.name&&T!==c&&!T._state.vcFired}).map(function(T){return T.on("versionchange").fire(v)})},this.use(gl),this.use(kl),this.use(vl),this.use(ml),this.use(yl);var E=new Proxy(this,{get:function(v,T,w){if(T==="_vip")return!0;if(T==="table")return function(A){return Os(c.table(A),E)};var _=Reflect.get(v,T,w);return _ instanceof So?Os(_,E):T==="tables"?_.map(function(A){return Os(A,E)}):T==="_createTransaction"?function(){return Os(_.apply(this,arguments),E)}:_}});this.vip=E,u.forEach(function(v){return v(c)})}var Cs,Re=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Sl=(nr.prototype.subscribe=function(i,o,c){return this._subscribe(i&&typeof i!="function"?i:{next:i,error:o,complete:c})},nr.prototype[Re]=function(){return this},nr);function nr(i){this._subscribe=i}try{Cs={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{Cs={indexedDB:null,IDBKeyRange:null}}function Ro(i){var o,c=!1,u=new Sl(function(f){var h=ki(i),m,g=!1,b={},k={},E={get closed(){return g},unsubscribe:function(){g||(g=!0,m&&m.abort(),v&&pt.storagemutated.unsubscribe(w))}};f.start&&f.start(E);var v=!1,T=function(){return Ni(_)},w=function(A){As(b,A),Gi(k,b)&&T()},_=function(){var A,S,L;!g&&Cs.indexedDB&&(b={},A={},m&&m.abort(),m=new AbortController,L=function(C){var N=Wt();try{h&&Xt();var D=ut(i,C);return D=h?D.finally(ft):D}finally{N&&Qt()}}(S={subscr:A,signal:m.signal,requery:T,querier:i,trans:null}),Promise.resolve(L).then(function(C){c=!0,o=C,g||S.signal.aborted||(b={},function(N){for(var D in N)if(I(N,D))return;return 1}(k=A)||v||(pt(Mn,w),v=!0),Ni(function(){return!g&&f.next&&f.next(C)}))},function(C){c=!1,["DatabaseClosedError","AbortError"].includes(C==null?void 0:C.name)||g||Ni(function(){g||f.error&&f.error(C)})}))};return setTimeout(T,0),E});return u.hasValue=function(){return c},u.getValue=function(){return o},u}var $t=it;function sr(i){var o=mt;try{mt=!0,pt.storagemutated.fire(i),Qi(i,!0)}finally{mt=o}}P($t,s(s({},rs),{delete:function(i){return new $t(i,{addons:[]}).delete()},exists:function(i){return new $t(i,{addons:[]}).open().then(function(o){return o.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(i){try{return o=$t.dependencies,c=o.indexedDB,o=o.IDBKeyRange,(Hi(c)?Promise.resolve(c.databases()).then(function(u){return u.map(function(f){return f.name}).filter(function(f){return f!==ps})}):Vi(c,o).toCollection().primaryKeys()).then(i)}catch{return _e(new ne.MissingAPI)}var o,c},defineClass:function(){return function(i){p(this,i)}},ignoreTransaction:function(i){return X.trans?Nt(X.transless,i):i()},vip:zi,async:function(i){return function(){try{var o=Xi(i.apply(this,arguments));return o&&typeof o.then=="function"?o:z.resolve(o)}catch(c){return _e(c)}}},spawn:function(i,o,c){try{var u=Xi(i.apply(c,o||[]));return u&&typeof u.then=="function"?u:z.resolve(u)}catch(f){return _e(f)}},currentTransaction:{get:function(){return X.trans||null}},waitFor:function(i,o){return o=z.resolve(typeof i=="function"?$t.ignoreTransaction(i):i).timeout(o||6e4),X.trans?X.trans.waitFor(o):o},Promise:z,debug:{get:function(){return We},set:function(i){uo(i)}},derive:O,extend:p,props:P,override:Z,Events:Cn,on:pt,liveQuery:Ro,extendObservabilitySet:As,getByKeyPath:ee,setByKeyPath:ce,delByKeyPath:function(i,o){typeof o=="string"?ce(i,o,void 0):"length"in o&&[].map.call(o,function(c){ce(i,c,void 0)})},shallowClone:J,deepClone:Je,getObjectDiff:Zi,cmp:de,asap:te,minKey:-1/0,addons:[],connections:Zt,errnames:Si,dependencies:Cs,cache:Mt,semVer:"4.0.11",version:"4.0.11".split(".").map(function(i){return parseInt(i)}).reduce(function(i,o,c){return i+o/Math.pow(10,2*c)})})),$t.maxKey=$n($t.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(pt(Mn,function(i){mt||(i=new CustomEvent(xi,{detail:i}),mt=!0,dispatchEvent(i),mt=!1)}),addEventListener(xi,function(i){i=i.detail,mt||sr(i)}));var nn,mt=!1,Uo=function(){};return typeof BroadcastChannel<"u"&&((Uo=function(){(nn=new BroadcastChannel(xi)).onmessage=function(i){return i.data&&sr(i.data)}})(),typeof nn.unref=="function"&&nn.unref(),pt(Mn,function(i){mt||nn.postMessage(i)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(i){if(!it.disableBfCache&&i.persisted){We&&console.debug("Dexie: handling persisted pagehide"),nn!=null&&nn.close();for(var o=0,c=Zt;o<c.length;o++)c[o].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(i){!it.disableBfCache&&i.persisted&&(We&&console.debug("Dexie: handling persisted pageshow"),Uo(),sr({all:new Le(-1/0,[[]])}))})),z.rejectionMapper=function(i,o){return!i||i instanceof Gt||i instanceof TypeError||i instanceof SyntaxError||!i.name||!lo[i.name]?i:(o=new lo[i.name](o||i.message,i),"stack"in i&&F(o,"stack",{get:function(){return this.inner.stack}}),o)},uo(We),s(it,Object.freeze({__proto__:null,Dexie:it,liveQuery:Ro,Entity:bo,cmp:de,PropModification:Bn,replacePrefix:function(i,o){return new Bn({replacePrefix:[i,o]})},add:function(i){return new Bn({add:i})},remove:function(i){return new Bn({remove:i})},default:it,RangeSet:Le,mergeRanges:Kn,rangesOverlap:Bo}),{default:it}),it})})(wa);var Il=wa.exports;const Ir=El(Il),Go=Symbol.for("Dexie"),Qs=globalThis[Go]||(globalThis[Go]=Ir);if(Ir.semVer!==Qs.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Ir.semVer} and ${Qs.semVer}`);const{liveQuery:Ud,mergeRanges:Vd,rangesOverlap:Hd,RangeSet:zd,cmp:Yd,Entity:Gd,PropModification:Jd,replacePrefix:Wd,add:Qd,remove:Xd}=Qs,Al="MdAnkiDatabase",Tl=2,Ar=`# 新文件

开始编写您的内容...

使用 --内容-- 创建Cloze记忆卡片`,fe=new Qs(Al);fe.version(Tl).stores({folders:"&id, name, folderId",sessions:"&id, name, folderId, createdAt, lastActive",clozeStates:"&id, fileId, state, due",appState:"&key",agents:"&id, &name",topics:"&id, agentId, createdAt",history:"&id, topicId, timestamp",mistakes:"&uuid, subject, *tags, analysis.reason_for_error, review.due"});async function Ll(){const[n,e,t,s]=await Promise.all([fe.sessions.toArray(),fe.folders.toArray(),fe.clozeStates.toArray(),fe.appState.toArray()]),r=t.reduce((l,d)=>(l[d.id]=d,l),{}),a=s.reduce((l,d)=>(l[d.key]=d.value,l),{});return{sessions:n||[],folders:e||[],clozeStates:r||{},persistentAppState:a||{}}}async function Ol({sessions:n,folders:e,clozeStates:t,persistentAppState:s}){const r=[fe.sessions,fe.folders,fe.clozeStates,fe.appState];await fe.transaction("rw",r,async()=>{const a=Object.values(t),l=Object.entries(s).map(([I,P])=>({key:I,value:P})),d=new Set(n.map(I=>I.id)),p=new Set(e.map(I=>I.id)),y=new Set(Object.keys(t)),B=new Set(Object.keys(s));await Promise.all([fe.sessions.where("id").noneOf(Array.from(d)).delete(),fe.folders.where("id").noneOf(Array.from(p)).delete(),fe.clozeStates.where("id").noneOf(Array.from(y)).delete(),fe.appState.where("key").noneOf(Array.from(B)).delete()]),await Promise.all([fe.sessions.bulkPut(n),fe.folders.bulkPut(e),fe.clozeStates.bulkPut(a),fe.appState.bulkPut(l)])})}async function Cl(){const[n,e,t]=await Promise.all([fe.agents.toArray(),fe.topics.toArray(),fe.history.toArray()]);return{agents:n||[],topics:e||[],history:t||[]}}async function Nl({agents:n,topics:e,history:t}){await fe.transaction("rw",fe.agents,fe.topics,fe.history,async()=>{const s=new Set(n.map(l=>l.id)),r=new Set(e.map(l=>l.id)),a=new Set(t.map(l=>l.id));await Promise.all([fe.agents.where("id").noneOf(Array.from(s)).delete(),fe.topics.where("id").noneOf(Array.from(r)).delete(),fe.history.where("id").noneOf(Array.from(a)).delete()]),await Promise.all([fe.agents.bulkPut(n),fe.topics.bulkPut(e),fe.history.bulkPut(t)])})}async function Bl(){try{return fe.isOpen()||await fe.open(),await fe.mistakes.toArray()}catch(n){return console.error("Failed to load mistakes from DB:",n),[]}}async function Pl(n){try{await fe.mistakes.bulkPut(n),console.log("Mistakes saved successfully.")}catch(e){console.error("Failed to save mistakes to DB:",e)}}async function Ml(n){try{await fe.mistakes.put(n)}catch(e){console.error(`Failed to update mistake ${n.uuid}:`,e)}}function kt(){return"id_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function St(n){return n?n.replace(/[&<>"']/g,e=>({"&":"&","<":"<",">":">",'"':'"',"'":"'"})[e]||e):""}function $l(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);e=(e<<5)-e+s,e|=0}return e.toString(36)}const es={火山:{adapter:"openAICompatible",baseURL:"https://ark.cn-beijing.volces.com/api/v3/",models:["deepseek-r1-250528","deepseek-v3-250324"]},deepseek:{adapter:"openAICompatible",baseURL:"https://api.deepseek.com/v1/chat/completions",models:["deepseek-reasoner","deepseek-chat"]},open_routers:{adapter:"openAICompatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",models:["anthropic/claude-opus-4","anthropic/claude-sonnet-4"]},gemini:{adapter:"gemini",baseURL:"https://generativelanguage.googleapis.com",models:["gemini-2.5-pro","gemini-2.5-flash"]},openai_compatible:{adapter:"openAICompatible",baseURL:"",models:[]}};function Dl(n){var e;return((e=es[n])==null?void 0:e.models[0])||""}function xl(n){const e=es[n];return e?e.adapter==="openAICompatible"&&e.baseURL.endsWith("/")?`${e.baseURL}chat/completions`:e.baseURL:""}class ka{constructor(e){this.config=e}async chatStream(e,{onChunk:t,onDone:s,onError:r}){throw new Error("Adapter must implement chatStream method.")}_preparePayload(e){throw new Error("Adapter must implement _preparePayload method.")}}class Kl extends ka{_preparePayload(e){return{model:this.config.model,messages:e,stream:!0}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var l;const a=this._preparePayload(e);try{const d=await fetch(this.config.apiPath,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(a)});if(!d.ok){const B=await d.text();throw new Error(`API Error: ${d.status} ${d.statusText} - ${B}`)}const p=d.body.getReader(),y=new TextDecoder("utf-8");for(;;){const{done:B,value:I}=await p.read();if(B){s();break}const M=y.decode(I).split(`
`).filter(F=>F.trim().startsWith("data:"));for(const F of M){const O=F.replace(/^data: /,"").trim();if(O==="[DONE]"){s();return}try{const G=(l=JSON.parse(O).choices[0])==null?void 0:l.delta;if(G){const W=G.content;W&&t({type:"content",text:W});const Z=G.reasoning_content;if(Z){const Q=`<thinking>${Z}</thinking>`;t({type:"thinking",text:Q})}}}catch($){console.error("Error parsing stream data chunk:",O,$)}}}}catch(d){console.error("LLM Stream Error:",d),r(d)}}}class jl extends ka{_preparePayload(e){return{contents:e.map(s=>({role:s.role==="assistant"?"model":"user",parts:[{text:s.content}]}))}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var d,p,y,B,I;const a=this._preparePayload(e),l=`${this.config.apiPath}/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`;try{const P=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!P.ok){const $=await P.text();throw new Error(`API Error: ${P.status} ${P.statusText} - ${$}`)}const M=P.body.getReader(),F=new TextDecoder("utf-8");let O="";for(;;){const{done:$,value:G}=await M.read();if($){s();break}O+=F.decode(G,{stream:!0});const W=O.split(`
`);O=W.pop();for(const Z of W)if(!(Z.trim().startsWith("[")||Z.trim().startsWith(","))&&!Z.trim().endsWith("]"))try{const te=((I=(B=(y=(p=(d=JSON.parse(Z).candidates)==null?void 0:d[0])==null?void 0:p.content)==null?void 0:y.parts)==null?void 0:B[0])==null?void 0:I.text)||"";te&&t(te)}catch{}}}catch(P){console.error("Gemini Stream Error:",P),r(P)}}}const Jo={openAICompatible:Kl,gemini:jl};function ql(n){const e=es[n];if(!e||!Jo[e.adapter])throw new Error(`Unsupported provider or adapter: ${n}`);return Jo[e.adapter]}async function Fl(n,e,t){const s=ql(n.provider),r=new s(n),a=[];n.systemPrompt&&a.push({role:"system",content:n.systemPrompt}),e.forEach(l=>{a.push({role:l.role,content:l.content})}),await r.chatStream(a,t)}const Vs=De(".ai-agent-nav .agent-list");De(".agent-content-container .topics-panel");De(".agent-content-container .history-panel");const Hs=De(".agent-content-container .topic-list"),xe=De(".agent-content-container .history-content"),Ps=De(".chat-input-area"),zs=De("#chatInput"),Rl=De("#sendMessageBtn");De("#attachFileBtn");const Ul=De("#attachmentInput"),Tr=De("#attachmentPreview");function Vl(n){const e=n.id===x.currentAgentId,t=document.createElement("div");return t.className=`agent-item ${e?"active":""}`,t.dataset.agentId=n.id,t.innerHTML=`
        <div class="agent-avatar">${St(n.avatar)}</div>
        <span>${St(n.displayName)}</span>
    `,t}function Hl(n){const e=n.id===x.currentTopicId,t=document.createElement("li");return t.className=`topic-item ${e?"active":""}`,t.dataset.topicId=n.id,t.innerHTML=`
        <div class="topic-icon"><i class="${St(n.icon)}"></i></div>
        <span>${St(n.title)}</span>
    `,t}function zl(n){if(!n)return"";const e=n.replace(/<\/thinking>\s*<thinking>/gi," "),t=/<thinking>([\s\S]*?)<\/thinking>/gi;return e.replace(t,`<details class="thinking-block">
            <summary>AI 思考过程</summary>
            <pre><code class="language-text">$1</code></pre>
         </details>`)}function Yl(n){const e=document.createElement("div");e.className=`history-item role-${n.role}`,e.dataset.messageId=n.id;let t="",s="";n.role==="assistant"?n.status==="streaming"?(t=`
                <details class="thinking-block" open>
                    <summary>AI 思考过程</summary>
                    <pre><code class="language-text streaming-reasoning-container"></code></pre>
                </details>
            `,s='<div class="streaming-content-container"><p><i class="fas fa-spinner fa-pulse"></i></p></div>'):(n.reasoning&&n.reasoning.trim()&&(t=zl(n.reasoning)),s=marked.parse(n.content||"")):s=marked.parse(n.content||"");const r=(n.images||[]).map(l=>`<img src="${l}" alt="Uploaded image" class="history-image">`).join("");e.innerHTML=`
        <div class="history-item-header">
            <span class="role ${n.role}">${n.role==="user"?"用户":"AI助手"}</span>
            <span>${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <div class="history-item-content">
            ${t}
            ${s}
            <div class="image-previews">${r}</div>
        </div>
        <div class="history-item-actions">
            <button class="history-action-btn regenerate-btn" title="重新生成"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" title="编辑"><i class="fas fa-edit"></i> 编辑</button>
            <button class="history-action-btn delete-btn" title="删除"><i class="fas fa-trash"></i> 删除</button>
        </div>
    `;const a=e.querySelector(".history-item-actions");return n.role==="user"?a.querySelector(".regenerate-btn").style.display="none":a.querySelector(".edit-btn").style.display="none",n.status==="streaming"&&(a.style.display="none"),e}function Rt(){Gl(),Wl(),Gn()}function Gl(){Vs.innerHTML="",x.agents.forEach(e=>{Vs.appendChild(Vl(e))});const n=document.createElement("div");n.className="agent-item add-agent-btn",n.innerHTML='<div class="agent-avatar">+</div><span>添加Agent</span>',Vs.appendChild(n)}function Jl(){const n=document.getElementById("historyHeaderTitle"),e=document.getElementById("agentSettingsTriggerBtn"),t=Hr(x.currentAgentId);t?(n.textContent=`${t.displayName} - 对话记录`,e.style.display="flex"):(n.textContent="历史对话记录",e.style.display="none")}function Wl(){Hs.innerHTML="",x.topics.filter(t=>t.agentId===x.currentAgentId).forEach(t=>{Hs.appendChild(Hl(t))});const e=document.createElement("li");e.className="topic-item add-topic-btn",e.innerHTML='<div class="topic-icon"><i class="fas fa-plus-circle"></i></div><span>添加新主题</span>',Hs.appendChild(e)}function Gn(){Jl();const n=xe.scrollHeight-xe.clientHeight<=xe.scrollTop+1;if(xe.innerHTML="",!x.currentTopicId){xe.innerHTML='<div class="no-history"><i class="fas fa-comments"></i><p>请选择或创建一个主题来开始聊天</p></div>',Ps&&(Ps.style.display="none");return}Ps&&(Ps.style.display="flex");const e=x.history.filter(t=>t.topicId===x.currentTopicId).sort((t,s)=>new Date(t.timestamp)-new Date(s.timestamp));if(e.length===0){xe.innerHTML='<div class="no-history"><i class="fas fa-comment-dots"></i><p>这个主题还没有对话记录，开始提问吧！</p></div>';return}e.forEach(t=>{(t.status!=="streaming"||t.content.length>0||x.isAiThinking)&&xe.appendChild(Yl(t))}),n&&(xe.scrollTop=xe.scrollHeight),Xl()}function Rr(n){Tr.innerHTML="",n.forEach((e,t)=>{const s=document.createElement("div");s.className="attachment-preview-item",s.innerHTML=`
            <span><i class="fas fa-file-image"></i> ${St(e.name)}</span>
            <button class="remove-attachment-btn" data-index="${t}">×</button>
        `,Tr.appendChild(s)})}function Ql(n,e,t){const s=document.querySelector(`.history-item[data-message-id="${n}"]`);if(!s)return;let r;e==="thinking"?(r=s.querySelector(".streaming-reasoning-container"),t=t.replace(/<\/?thinking>/g,"")):e==="content"&&(r=s.querySelector(".streaming-content-container"),r.querySelector(".fa-spinner")&&(r.innerHTML="")),r&&(r.innerText+=t,xe.scrollTop=xe.scrollHeight)}function Wo(n){const e=document.querySelector(`.history-item[data-message-id="${n}"]`);if(!e)return;const t=e.querySelector(".thinking-block");t&&t.removeAttribute("open");const s=e.querySelector(".history-item-actions");s&&(s.style.display="flex")}function Xl(){const n=document.getElementById("chatNavUp"),e=document.getElementById("chatNavDown"),t=xe.querySelector(".history-item .role.user");n&&e&&(n.disabled=!t,e.disabled=!t)}function Sa(n){const e=/^(#{1,2})\s+(.+)$/gm,t=[];let s;for(;(s=e.exec(n))!==null;){const r={level:s[1].length,text:s[2].trim(),start:s.index,end:s.index+s[0].length,content:""};t.push(r)}for(let r=0;r<t.length;r++){const a=t[r].end+1,l=r<t.length-1?t[r+1].start:n.length;t[r].content=n.substring(a,l).trim()}return t}function Ur(n,e){const s=Sa(e).filter(a=>a.level===1||a.level===2).map(a=>({id:kt(),parentId:n,title:a.text,content:`# ${a.text}

${a.content}`,level:a.level})),r={...x.fileSubsessions,[n]:s};ae({fileSubsessions:r})}async function _a(){ae({isLoading:!0});try{const{sessions:n,folders:e,clozeStates:t,persistentAppState:s}=await Ll(),r={sessions:n||[],folders:e||[],clozeStates:t||{},currentSessionId:s.currentSessionId||null,currentFolderId:s.currentFolderId||null,currentSubsessionId:s.currentSubsessionId||null,folderStack:s.folderStack||[],fileSubsessions:{}};if(r.sessions.forEach(a=>{const l=Sa(a.content).filter(d=>d.level===1||d.level===2).map(d=>({id:kt(),parentId:a.id,title:d.text,content:`# ${d.text}

${d.content}`,level:d.level}));r.fileSubsessions[a.id]=l}),r.sessions.length===0){const a=kt();r.sessions.push({id:a,name:"初始会话",content:Ar,type:"file",folderId:null,createdAt:new Date}),r.currentSessionId=a,Ur(a,Ar)}r.sessions.some(a=>a.id===r.currentSessionId)||(r.currentSessionId=r.sessions.length>0?r.sessions[0].id:null),ae(r)}catch(n){console.error("Failed to initialize application state:",n)}finally{ae({isLoading:!1})}}async function Vt(){try{await Ol({sessions:x.sessions,folders:x.folders,clozeStates:x.clozeStates,persistentAppState:{currentSessionId:x.currentSessionId,currentFolderId:x.currentFolderId,currentSubsessionId:x.currentSubsessionId,folderStack:x.folderStack}}),console.log("State persisted successfully.")}catch(n){console.error("Failed to persist state:",n)}}async function Ea(n,e=Ar){const t=kt(),s={id:t,name:n||`新文件 ${x.sessions.length+1}`,content:e,type:"file",folderId:x.currentFolderId,createdAt:new Date},r=[...x.sessions,s];ae({sessions:r,currentSessionId:t,currentSubsessionId:null}),Ur(t,e),await Vt()}async function Zl(n){const e={id:kt(),name:n||`新目录 ${x.folders.length+1}`,type:"folder",folderId:x.currentFolderId,createdAt:new Date},t=[...x.folders,e];ae({folders:t}),await Vt()}async function Ia(n){const e=new Set(n.map(l=>l.id));let t=[...x.sessions],s=[...x.folders],r={...x.fileSubsessions};n.forEach(l=>{if(l.type==="file")t=t.filter(d=>d.id!==l.id),delete r[l.id];else if(l.type==="folder"){const d=new Set([l.id]);let p=!0;for(;p;)p=!1,s.filter(B=>d.has(B.folderId)).forEach(B=>{d.has(B.id)||(d.add(B.id),p=!0)});s=s.filter(y=>!d.has(y.id)),t=t.filter(y=>!d.has(y.folderId))}});let a=x.currentSessionId;e.has(a)&&(a=t.length>0?t[0].id:null),ae({sessions:t,folders:s,fileSubsessions:r,currentSessionId:a}),await Vt()}async function eu(n,e){const t=x.sessions.map(r=>n.some(a=>a.id===r.id&&a.type==="file")?{...r,folderId:e}:r),s=x.folders.map(r=>n.some(a=>a.id===r.id&&a.type==="folder")?{...r,folderId:e}:r);ae({sessions:t,folders:s}),await Vt()}async function tu(n,e,t){if(t==="file"){const s=x.sessions.map(r=>r.id===n?{...r,name:e}:r);ae({sessions:s})}else{const s=x.folders.map(r=>r.id===n?{...r,name:e}:r);ae({folders:s})}await Vt()}async function nu(n){const e=Aa();if(e&&e.content!==n){const t=x.sessions.map(s=>s.id===x.currentSessionId?{...s,content:n,lastActive:new Date}:s);return ae({sessions:t}),Ur(x.currentSessionId,n),await Vt(),!0}return!1}function Aa(){return x.currentSessionId?x.sessions.find(n=>n.id===x.currentSessionId):null}function su(n){ae({currentSessionId:n,currentSubsessionId:null})}function iu(n){const e=[...x.folderStack,x.currentFolderId].filter(t=>t!=null);ae({currentFolderId:n,folderStack:e})}function ru(n,e){ae({currentSessionId:n,currentSubsessionId:e})}function ou(){if(x.folderStack.length>0){const n=[...x.folderStack],e=n.pop();ae({currentFolderId:e,folderStack:n})}}function au(n,e){const t=x.folderStack.slice(0,e);ae({currentFolderId:n,folderStack:t})}function cu(){ae({currentFolderId:null,folderStack:[]})}function Vr(n,e){const t=`${n}_${$l(e)}`,s=x.clozeStates;return s[t]?s[t]:{id:t,fileId:n,content:e,state:"new",due:Date.now(),interval:0,easeFactor:2.5,lastReview:null}}function lu(n,e,t){const s=Vr(n,e),r=ba(s,t),a=x.clozeStates;a[s.id]={...s,...r,lastReview:Date.now()},ae({clozeStates:a})}async function Ta(){const{agents:n,topics:e,history:t}=await Cl(),s={agents:n||[],topics:e||[],history:t||[]};if(s.agents.length>0){s.currentAgentId=s.agents[0].id;const r=s.topics.find(a=>a.agentId===s.currentAgentId);r&&(s.currentTopicId=r.id)}ae(s)}async function ct(){try{await Nl({agents:x.agents,topics:x.topics,history:x.history}),console.log("Agent state persisted.")}catch(n){console.error("Failed to persist agent state:",n)}}function Hr(n){if(n)return x.agents.find(e=>e.id===n)}async function uu(n){const e=n.displayName.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");let t=e,s=1;for(;x.agents.some(l=>l.name===t);)t=`${e}_${s++}`;const r={id:kt(),name:t,displayName:n.displayName,avatar:n.avatar,config:n.config},a=[...x.agents,r];return ae({agents:a,currentAgentId:r.id,currentTopicId:null}),await ct(),r}async function fu(n,e){const t=x.agents.map(s=>s.id===n?{...s,...e}:s);ae({agents:t}),await ct()}async function du(n){const e=x.topics.filter(p=>p.agentId===n),t=new Set(e.map(p=>p.id)),s=x.history.filter(p=>!t.has(p.topicId)),r=x.topics.filter(p=>p.agentId!==n),a=x.agents.filter(p=>p.id!==n);let l=x.currentAgentId,d=x.currentTopicId;if(l===n){l=a.length>0?a[0].id:null;const p=r.find(y=>y.agentId===l);d=p?p.id:null}ae({agents:a,topics:r,history:s,currentAgentId:l,currentTopicId:d}),await ct()}async function hu(n,e){if(!x.currentAgentId){alert("Please select an AI Agent first.");return}const t={id:kt(),agentId:x.currentAgentId,title:n,icon:"fas fa-comment",createdAt:new Date},s=[...x.topics,t];ae({topics:s,currentTopicId:t.id}),await ct()}async function Qo(n,e,t,s=[],r="completed",a=null){const l={id:kt(),topicId:n,role:e,content:t,reasoning:a,images:s,timestamp:new Date().toISOString(),status:r},d=[...x.history,l];return ae({history:d}),r!=="streaming"&&await ct(),l}async function pu(n,e){if(!x.currentTopicId||x.isAiThinking)return;const t=x.currentTopicId,s=Hr(x.currentAgentId);if(!s){alert("错误：找不到当前Agent的配置。");return}ae({isAiThinking:!0}),await Qo(t,"user",n,[]),Gn();const r=await Qo(t,"assistant","",[],"streaming","");Gn();let a="",l="";const d=x.history.filter(p=>p.topicId===t&&p.status==="completed");await Fl(s.config,d,{onChunk:({type:p,text:y})=>{p==="content"?a+=y:p==="thinking"&&(l+=y),Ql(r.id,p,y)},onDone:async()=>{const p=x.history.map(y=>y.id===r.id?{...y,content:a,reasoning:l,status:"completed"}:y);Wo(r.id),ae({history:p,isAiThinking:!1}),await ct()},onError:async p=>{const y=`

**错误:** ${p.message}`;a+=y,Wo(r.id);const B=x.history.map(I=>I.id===r.id?{...I,content:a,reasoning:l,status:"error"}:I);ae({history:B,isAiThinking:!1}),await ct()}})}async function mu(n){const e=new Set(n),t=x.history.filter(s=>!e.has(s.id));ae({history:t}),await ct()}async function yu(n,e){console.log(`Editing message ${n} with content: ${e}`)}function gu(n){const e=x.topics.find(t=>t.agentId===n);ae({currentAgentId:n,currentTopicId:e?e.id:null})}function vu(n){ae({currentTopicId:n})}function bu(n){n==="anki"||n==="agent"||n==="mistakes"?ae({activeView:n}):console.warn(`[DataService] Invalid view name passed to switchView: '${n}'`)}async function Xo(){try{await Promise.all([Vt(),ct()]),console.log("All application state persisted.")}catch(n){console.error("Failed to persist all application state:",n)}}const Me=oe("editor"),Ye=oe("preview"),vt=oe("sessionList"),wu=oe("emptySession"),sn=oe("currentFolderContainer"),Lr=oe("fileInput"),ku=oe("newFileBtn"),Su=oe("newFolderBtn"),_u=oe("openFileBtn"),Or=oe("saveBtn");oe("exportFileBtn");const Eu=oe("deleteSelectedBtn"),Iu=oe("moveSelectedBtn"),Zo=oe("toggleSessionBtn"),Cr=oe("toggleEditorBtn"),La=oe("clozeBtn"),Oa=oe("boldBtn"),Ca=oe("italicBtn"),Na=oe("codeBtn"),Ba=oe("linkBtn"),Au=oe("audioBtn"),Pa=oe("insertLinebreakBtn"),ea=De(".session-sidebar"),yn=De(".editor-preview-panel"),Ma=oe("selectAllCheckbox"),$a=oe("moveModal"),Hn=oe("folderList"),Tu=oe("closeMoveModalBtn"),Lu=oe("confirmMoveBtn"),Ou=oe("cancelMoveBtn"),Da=oe("audioControls"),Cu=oe("audioTitle"),xa=oe("audioProgress"),Nu=oe("playBtn"),Bu=oe("pauseBtn"),Pu=oe("stopBtn"),Mu=De(".session-title");De(".instructions");const xt=oe("toggleVisibilityClozeBtn"),ar=oe("invertClozeBtn"),Kt=oe("toggleEditPreviewBtn"),Nr=oe("editModeDot"),Br=oe("previewModeDot");let rt;function ta(n,e){const t=document.createElement("a");return t.href="#",t.className="breadcrumb-link",t.innerHTML=n,t.addEventListener("click",s=>{s.preventDefault(),e()}),t}function $u(n,e,t){sn.innerHTML="";const s=ta('<i class="fas fa-folder-open"></i> 根目录',t);if(sn.appendChild(s),x.folderStack.forEach((r,a)=>{const l=document.createElement("span");l.className="breadcrumb-separator",l.textContent=">",sn.appendChild(l);const d=x.folders.find(p=>p.id===r);if(d){const p=ta(d.name,()=>e(r,a));sn.appendChild(p)}}),x.currentFolderId){const r=x.folders.find(a=>a.id===x.currentFolderId);if(r){const a=document.createElement("span");a.className="breadcrumb-separator",a.textContent=">",sn.appendChild(a);const l=document.createElement("span");l.className="breadcrumb-current",l.textContent=r.name,sn.appendChild(l)}}rt.style.display=x.folderStack.length>0?"inline-flex":"none"}function Du(n){rt=document.createElement("button"),rt.id="backButton",rt.className="session-btn",rt.title="返回上级目录",rt.innerHTML='<i class="fas fa-arrow-left"></i>',rt.style.display="none",rt.addEventListener("click",n),Mu.prepend(rt)}let cn=null,Jn=null;function Ka(){if(!cn||!cn.startTime)return;const n=(Date.now()-cn.startTime)/1e3,e=cn.text.length/10,t=Math.min(100,n/e*100);xa.style.width=`${t}%`}function cr(n){if(!("speechSynthesis"in window)){alert("抱歉，您的浏览器不支持语音合成。");return}Pr();const e=new SpeechSynthesisUtterance(n);e.lang="en-US",e.rate=1,e.onstart=()=>{e.startTime=Date.now(),Jn=setInterval(Ka,100)},e.onend=()=>{Pr()},cn=e,Cu.textContent=`正在播放: ${n.substring(0,30)}${n.length>30?"...":""}`,Da.style.display="block",window.speechSynthesis.speak(e)}function xu(){window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),clearInterval(Jn))}function Ku(){window.speechSynthesis.paused&&(window.speechSynthesis.resume(),Jn=setInterval(Ka,100))}function Pr(){window.speechSynthesis.cancel(),Jn&&clearInterval(Jn),Da.style.display="none",xa.style.width="0%",cn=null}function ja(n){const e=Date.now();if(n.due>e){const t=(n.due-e)/864e5;return t<1?"cloze-1d":t<2?"cloze-2d":t<3?"cloze-3d":t<5?"cloze-5d":t<7?"cloze-7d":t<14?"cloze-14d":"cloze-28d"}return n.lastReview&&e-n.lastReview<15*60*1e3&&n.interval===0?"cloze-10m":"cloze-28plus"}function qa(n){if(n.nodeType===Node.TEXT_NODE){const e=/--(.*?)--(?:\^\^audio:(.*?)\^\^)?/g,t=n.parentNode;if(!t||["CODE","PRE","SCRIPT","STYLE"].includes(t.tagName))return;let s;const r=[];let a=0;for(;(s=e.exec(n.nodeValue))!==null;){s.index>a&&r.push(document.createTextNode(n.nodeValue.substring(a,s.index)));const l=s[1],d=l.replace(/¶/g,"<br>"),p=s[2]?s[2].trim():null,y=x.currentSessionId,B=Vr(y,l),I=document.createElement("span");I.className=`cloze hidden ${ja(B)}`,I.dataset.content=l,p&&(I.dataset.multimedia=p),I.innerHTML=`
                ${p?'<span class="media-icon" title="播放音频"><i class="fas fa-volume-up"></i></span>':""}
                <span class="cloze-content">${d}</span>
                <span class="placeholder">[...]</span>
                <div class="cloze-actions" style="display: none;">
                    <button class="cloze-btn again" data-rating="0">重来</button>
                    <button class="cloze-btn hard" data-rating="1">困难</button>
                    <button class="cloze-btn double" data-rating="2">犹豫</button>
                    <button class="cloze-btn easy" data-rating="3">简单</button>
                </div>
            `,r.push(I),a=e.lastIndex}r.length>0&&(a<n.nodeValue.length&&r.push(document.createTextNode(n.nodeValue.substring(a))),r.forEach(l=>t.insertBefore(l,n)),t.removeChild(n))}else n.nodeType===Node.ELEMENT_NODE&&Array.from(n.childNodes).forEach(e=>qa(e))}function ju(){Ye.addEventListener("click",n=>{var t;const e=n.target.closest(".cloze");if(e){if(n.target.closest(".cloze-btn")){n.stopPropagation();const s=n.target.closest(".cloze-btn"),r=parseInt(s.dataset.rating,10),a=x.currentSessionId,l=e.dataset.content;clearTimeout(e.closeTimer),lu(a,l,r);const d=Vr(a,l),p=ja(d);(t=e.className.match(/cloze-(\w+)/g))==null||t.forEach(y=>e.classList.remove(y)),e.classList.add(p),e.querySelector(".cloze-actions").style.display="none",r===3?(e.classList.remove("hidden","permanent-view"),e.classList.add("easy-open")):(e.classList.add("hidden"),e.classList.remove("easy-open","permanent-view"));return}if(n.target.closest(".media-icon")){n.stopPropagation(),cr(e.dataset.multimedia);return}e.classList.contains("hidden")&&!e.classList.contains("permanent-view")&&(clearTimeout(e.closeTimer),e.classList.remove("hidden"),e.querySelector(".cloze-actions").style.display="flex",e.dataset.multimedia&&cr(e.dataset.multimedia),e.closeTimer=setTimeout(()=>{!e.classList.contains("easy-open")&&!e.classList.contains("permanent-view")&&(e.classList.add("hidden"),e.querySelector(".cloze-actions").style.display="none")},6e4))}}),Ye.addEventListener("dblclick",n=>{const e=n.target.closest(".cloze");e&&(n.stopPropagation(),clearTimeout(e.closeTimer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent-view"),e.dataset.multimedia&&cr(e.dataset.multimedia),e.querySelector(".cloze-actions").style.display="none"):(e.classList.add("hidden"),e.classList.remove("permanent-view","easy-open"),e.querySelector(".cloze-actions").style.display="none"))})}function qu(){const n=!x.areAllClozeVisible;Ye.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),n?(e.classList.remove("hidden","temporary"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"))}),Fa(n),ae({areAllClozeVisible:n})}function Fu(){let n=!0;Ye.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"),n=!1)}),Fa(n),ae({areAllClozeVisible:n})}function Fa(n){n?(xt.innerHTML='<i class="fas fa-eye"></i>',xt.title="全部隐藏"):(xt.innerHTML='<i class="fas fa-eye-slash"></i>',xt.title="全部显示")}function Xs(){var l;const{currentSessionId:n,currentSubsessionId:e,fileSubsessions:t,sessions:s}=x,r=s.find(d=>d.id===n);if(!r){Ye.innerHTML="";return}let a=r.content;if(e){const d=(l=t[n])==null?void 0:l.find(p=>p.id===e);d&&(a=d.content)}Ye.innerHTML=window.marked.parse(a||""),qa(Ye),window.MathJax&&window.MathJax.typesetPromise([Ye]).catch(d=>console.log("MathJax error:",d))}function Ru(){window.marked.setOptions({breaks:!0}),ju()}function Uu(n){const e=document.createElement("li");return e.className=`session-item ${n.type} ${n.id===x.currentSessionId?"active":""}`,e.dataset.id=n.id,e.dataset.type=n.type,e.innerHTML=`
        <div class="name-container">
            <input type="checkbox" class="select-checkbox" data-id="${n.id}" data-type="${n.type}">
            <span class="name">
                <i class="${n.type==="folder"?"fas fa-folder folder-icon":"fas fa-file file-icon"}"></i>
                <span class="item-name">${St(n.name)}</span>
            </span>
        </div>
        <div class="actions">
            <span class="move-btn" title="移动"><i class="fas fa-arrows-alt"></i></span>
            <span class="edit-btn" title="编辑"><i class="fas fa-pencil-alt"></i></span>
            <span class="delete-btn" title="删除"><i class="fas fa-trash"></i></span>
        </div>
    `,e}function Vu(n){const e=document.createElement("li");return e.className=`session-item subsession ${n.id===x.currentSubsessionId?"active":""}`,e.dataset.id=n.id,e.dataset.parent=n.parentId,e.innerHTML=`
        <div class="name-container">
            <span class="name">
                <i class="fas fa-stream"></i>
                ${St(n.title)}
            </span>
        </div>`,e}function Hu(){vt.innerHTML="";const{sessions:n,folders:e,currentFolderId:t,fileSubsessions:s,currentSessionId:r}=x,a=[...e.filter(l=>l.folderId===t),...n.filter(l=>l.folderId===t)].sort((l,d)=>l.type==="folder"&&d.type==="file"?-1:l.type==="file"&&d.type==="folder"?1:l.name.localeCompare(d.name));wu.style.display=a.length===0&&t===null?"block":"none",a.length===0&&t!==null&&(vt.innerHTML='<li class="empty-folder"><div class="empty-message"><i class="fas fa-inbox"></i> 此目录为空</div></li>'),a.forEach(l=>{var p;const d=Uu(l);if(vt.appendChild(d),l.type==="file"&&l.id===r&&((p=s[l.id])==null?void 0:p.length)>0){const y=document.createElement("ul");y.className="nested-items",s[l.id].forEach(B=>{y.appendChild(Vu(B))}),vt.appendChild(y)}})}function $e(){Hu(),$u(Ha,Gu,Ju);const n=Aa(),e=n?n.content:"";Me.value!==e&&(Me.value=e),Xs()}let hn=[],zn=-1;function na(n=null){let e=Object.values(x.clozeStates),t;if(n?(console.log("Starting custom study with filters:",n),t=e.filter(s=>{if(n.fileOrFolder!=="all"){const[d,p]=n.fileOrFolder.split("_");if(d==="file"){if(s.fileId!==p)return!1}else if(d==="folder"&&!x.sessions.find(B=>B.id===s.fileId&&B.folderId===p))return!1}if(!n.cardStates.includes(s.state))return!1;const r=Date.now(),a=s.lastReview||0,l=(r-a)/(1e3*60*60*24);switch(n.lastReview){case"last7days":if(a===0||l>7)return!1;break;case"last30days":if(a===0||l>30)return!1;break;case"over30days":if(a!==0&&l<=30)return!1;break;case"never":if(a!==0)return!1;break}return!0}),t.sort(()=>Math.random()-.5),hn=t.slice(0,n.maxCards)):(console.log("Starting automatic review."),hn=e.filter(s=>s.due<=Date.now()).sort((s,r)=>s.due-r.due)),hn.length===0){alert("没有找到符合条件的卡片。");return}zn=0,Ra()}function Ra(){if(zn>=hn.length){alert("复习会话结束！"),hn=[],zn=-1,$e();return}const n=hn[zn];x.currentSessionId!==n.fileId&&(ae({currentSessionId:n.fileId}),$e()),setTimeout(()=>{document.querySelectorAll(".highlight-review").forEach(t=>t.classList.remove("highlight-review"));const e=document.querySelector(`.cloze[data-content="${n.content}"]`);e?(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlight-review"),e.classList.contains("hidden")&&e.click()):(console.error("Could not find cloze element for review:",n),zu())},x.currentSessionId!==n.fileId?300:50)}function zu(){zn++,Ra()}function Ua(n){let e=[];const t=x.folders.filter(s=>s.folderId===n);for(const s of t)e.push(s.id),e=e.concat(Ua(s.id));return e}function Va(){Hn.innerHTML="";const n=x.movingItems.filter(s=>s.type==="folder").map(s=>s.id),e=new Set(n);n.forEach(s=>{Ua(s).forEach(r=>e.add(r))});const t=document.createElement("div");t.className="folder-item",t.dataset.id="root",t.innerHTML='<i class="fas fa-folder-open"></i> 根目录',Hn.appendChild(t),x.folders.forEach(s=>{if(!e.has(s.id)){const r=document.createElement("div");r.className="folder-item",r.dataset.id=s.id,r.innerHTML=`<i class="fas fa-folder"></i> ${St(s.name)}`,Hn.appendChild(r)}}),$a.classList.add("active")}function Mr(){$a.classList.remove("active"),ae({movingItems:[],selectedMoveTarget:null})}function Yu(n){Tu.addEventListener("click",Mr),Ou.addEventListener("click",Mr),Lu.addEventListener("click",n),Hn.addEventListener("click",e=>{const t=e.target.closest(".folder-item");if(!t)return;Hn.querySelectorAll(".folder-item").forEach(r=>r.classList.remove("selected")),t.classList.add("selected");const s=t.dataset.id==="root"?null:t.dataset.id;ae({selectedMoveTarget:s})})}function Ha(){ou(),$e()}function Gu(n,e){au(n,e),$e()}function Ju(){cu(),$e()}async function Wu(){const n=prompt("请输入新文件的名称：","新文件");n!==null&&(await Ea(n.trim()),$e(),Me.focus())}async function Qu(){const n=prompt("请输入新目录的名称：","新目录");n!==null&&(await Zl(n.trim()),$e())}async function Zs(){await nu(Me.value)&&(Or.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>Or.innerHTML='<i class="fas fa-save"></i> 保存',2e3),$e())}async function Xu(n){const e=n.target.closest(".session-item");if(!e)return;const{id:t,type:s,parent:r}=e.dataset,a=n.target.closest(".actions span");if(a){if(n.stopPropagation(),a.classList.contains("delete-btn"))confirm(`确定删除此 ${s==="file"?"文件":"目录"}?`)&&(await Ia([{id:t,type:s}]),$e());else if(a.classList.contains("edit-btn")){const l=prompt("输入新名称:",e.querySelector(".item-name").textContent);l&&l.trim()&&(await tu(t,l.trim(),s),$e())}else a.classList.contains("move-btn")&&(ae({movingItems:[{id:t,type:s}]}),Va());return}s==="file"?su(t):s==="folder"?iu(t):e.classList.contains("subsession")&&ru(r,t),$e()}async function Zu(){x.selectedMoveTarget!==void 0&&x.movingItems.length>0?(await eu(x.movingItems,x.selectedMoveTarget),Mr(),$e()):alert("请选择一个目标目录。")}async function ef(){const n=Array.from(vt.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));if(n.length===0)return alert("请先选择要删除的项目。");confirm(`确定要删除选中的 ${n.length} 个项目吗？`)&&(await Ia(n),Ma.checked=!1,$e())}function zr(){clearTimeout(window.previewDebounce),window.previewDebounce=setTimeout(Xs,300)}async function tf(n){const e=n.target.files[0];if(!e)return;const t=new FileReader;t.onload=async s=>{await Ea(e.name,s.target.result),$e()},t.readAsText(e),Lr.value=""}function jn(n,e=n){const{selectionStart:t,selectionEnd:s,value:r}=Me,a=r.substring(t,s),l=`${n}${a}${e}`;Me.setRangeText(l,t,s,"select"),zr(),Me.focus()}function nf(n){const{selectionStart:e,selectionEnd:t}=Me;Me.setRangeText(n,e,t,"end"),zr(),Me.focus()}function sf(){yn.classList.toggle("collapsed");const n=yn.classList.contains("collapsed");Cr.innerHTML=n?'<i class="fas fa-chevron-down"></i>':'<i class="fas fa-chevron-up"></i>',Cr.title=n?"展开编辑器":"收起编辑器",[La,Oa,Ca,Na,Ba,Au,Pa].forEach(e=>e.disabled=n),n&&Zs()}function rf(){if(yn.classList.contains("preview-active"))return;const n=Me;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);ae({editorScrollRatio:Math.min(1,Math.max(0,e))})}}function of(){if(!yn.classList.contains("preview-active"))return;const n=Ye;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);ae({editorScrollRatio:e})}}function af(){const n=yn;n.classList.contains("preview-active")?(n.classList.remove("preview-active"),Kt.innerHTML='<i class="fas fa-book-open"></i> Preview',Kt.title="切换到预览",Nr.classList.add("active"),Br.classList.remove("active"),requestAnimationFrame(()=>{const t=Me;x.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=x.editorScrollRatio*(t.scrollHeight-t.clientHeight))}),Me.focus()):(Zs(),Xs(),requestAnimationFrame(()=>{const t=Ye;x.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=x.editorScrollRatio*(t.scrollHeight-t.clientHeight))}),n.classList.add("preview-active"),Kt.innerHTML='<i class="fas fa-edit"></i>',Kt.title="切换到编辑模式",Nr.classList.remove("active"),Br.classList.add("active"),Zs(),Xs())}function cf(){const{sessions:n,folders:e}=x,t=document.getElementById("filterByFile");t.innerHTML='<option value="all">所有文件</option>',e.forEach(s=>{const r=document.createElement("option");r.value=`folder_${s.id}`,r.textContent=`目录: ${s.name}`,t.appendChild(r)}),n.forEach(s=>{const r=document.createElement("option");r.value=`file_${s.id}`,r.textContent=`文件: ${s.name}`,t.appendChild(r)})}function lf(){const n=document.getElementById("reviewOptionsBtn"),e=document.getElementById("reviewDropdownMenu"),t=document.getElementById("customStudyBtn"),s=document.getElementById("customStudyModal"),r=document.getElementById("customStudyCloseBtn"),a=document.getElementById("customStudyCancelBtn"),l=document.getElementById("customStudyForm");document.getElementById("startReviewBtn").addEventListener("click",()=>na()),n.addEventListener("click",p=>{p.stopPropagation();const y=e.style.display==="block";e.style.display=y?"none":"block"}),document.addEventListener("click",p=>{const y=document.querySelector(".review-btn-group");y&&!y.contains(p.target)&&(e.style.display="none")}),t.addEventListener("click",p=>{p.preventDefault(),e.style.display="none",cf(),s.style.display="flex"});const d=()=>s.style.display="none";r.addEventListener("click",d),a.addEventListener("click",d),l.addEventListener("submit",p=>{p.preventDefault();const y={fileOrFolder:document.getElementById("filterByFile").value,cardStates:Array.from(document.querySelectorAll('input[name="cardState"]:checked')).map(B=>B.value),lastReview:document.getElementById("filterByLastReview").value,maxCards:parseInt(document.getElementById("maxCards").value,10)};d(),na(y)})}function uf(){ku.addEventListener("click",Wu),Su.addEventListener("click",Qu),Or.addEventListener("click",Zs),vt.addEventListener("click",Xu),Eu.addEventListener("click",ef),Me.addEventListener("input",zr),_u.addEventListener("click",()=>Lr.click()),Lr.addEventListener("change",tf),Iu.addEventListener("click",()=>{const n=Array.from(vt.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));n.length>0?(ae({movingItems:n}),Va()):alert("请选择要移动的项目。")}),Ma.addEventListener("change",n=>{vt.querySelectorAll(".select-checkbox").forEach(e=>e.checked=n.target.checked)}),Zo.addEventListener("click",()=>{ea.classList.toggle("hidden-session");const n=ea.classList.contains("hidden-session");Zo.innerHTML=n?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}),Cr.addEventListener("click",sf),La.addEventListener("click",()=>jn("--","--")),Oa.addEventListener("click",()=>jn("**")),Ca.addEventListener("click",()=>jn("*")),Pa.addEventListener("click",()=>nf("¶")),Na.addEventListener("click",()=>jn("`")),Ba.addEventListener("click",()=>jn("[",`](${prompt("URL:","https://")})`)),Me.addEventListener("scroll",rf),Ye.addEventListener("scroll",of),Kt.addEventListener("click",af),xt.innerHTML='<i class="fas fa-eye-slash"></i>',xt.title="全部隐藏",ar.innerHTML='<i class="fas fa-random"></i>',ar.title="反向显示/隐藏",yn.classList.remove("preview-active"),Kt.innerHTML='<i class="fas fa-book-open"></i>',Kt.title="切换到预览模式",Nr.classList.add("active"),Br.classList.remove("active"),xt.addEventListener("click",qu),ar.addEventListener("click",Fu),Nu.addEventListener("click",Ku),Bu.addEventListener("click",xu),Pu.addEventListener("click",Pr),Yu(Zu),lf()}async function ff(){console.log("Initializing Anki module..."),await _a(),Du(Ha),Ru(),$e(),uf()}let bt=[],qn=[],rn=-1;const H={el:document.getElementById("agentSettingsModal"),title:document.getElementById("agentSettingsModalTitle"),form:document.getElementById("agentSettingsForm"),id:document.getElementById("agentSettingsId"),name:document.getElementById("agentSettingsName"),displayName:document.getElementById("agentSettingsDisplayName"),avatar:document.getElementById("agentSettingsAvatar"),provider:document.getElementById("agentSettingsProvider"),apiPath:document.getElementById("agentSettingsApiPath"),apiKey:document.getElementById("agentSettingsApiKey"),apiKeyGroup:document.querySelector(".api-key-group"),model:document.getElementById("agentSettingsModel"),isLocal:document.getElementById("agentSettingsIsLocal"),systemPrompt:document.getElementById("agentSettingsSystemPrompt"),deleteBtn:document.getElementById("deleteAgentBtn"),deleteConfirmZone:document.querySelector(".delete-confirm-zone"),agentNameToConfirm:document.getElementById("agentNameToConfirm"),deleteConfirmInput:document.getElementById("deleteConfirmInput"),finalDeleteBtn:document.getElementById("finalDeleteBtn"),saveBtn:document.getElementById("agentSettingsSaveBtn"),cancelBtn:document.getElementById("agentSettingsCancelBtn"),closeBtn:document.getElementById("agentSettingsCloseBtn")};function df(){H.provider.innerHTML="";for(const n in es){const e=document.createElement("option");e.value=n,e.textContent=n,H.provider.appendChild(e)}}function za(n=null){H.el.style.display="flex",Ya(),H.deleteConfirmZone.style.display="none",df(),n?(H.title.textContent=`Agent 设置: ${n.displayName}`,H.deleteBtn.style.display="block",H.id.value=n.id,H.name.value=n.name,H.displayName.value=n.displayName,H.avatar.value=n.avatar||"",H.systemPrompt.value=n.config.systemPrompt||"",H.provider.value=n.config.provider||"火山",H.provider.dispatchEvent(new Event("change",{bubbles:!0})),H.apiPath.value=n.config.apiPath||"",H.apiKey.value=n.config.apiKey||"",H.model.value=n.config.model||"",H.isLocal.checked=n.config.isLocal||!1):(H.title.textContent="创建新 Agent",H.deleteBtn.style.display="none",H.form.reset(),H.id.value="",H.name.value="",H.provider.value="火山",H.provider.dispatchEvent(new Event("change",{bubbles:!0}))),$r()}function Wn(){H.el.style.display="none"}function $r(){const n=H.provider.value,e=es[n];if(H.model.innerHTML="",e&&e.models&&e.models.length>0)e.models.forEach(t=>{const s=document.createElement("option");s.value=t,s.textContent=t,H.model.appendChild(s)}),H.model.disabled=!1;else{const t=document.createElement("option");t.textContent="请在下方手动输入模型名",t.value="",H.model.appendChild(t),H.model.disabled=!0}H.isLocal.checked?(H.apiKeyGroup.style.display="none",H.apiKey.required=!1):(H.apiKeyGroup.style.display="block",H.apiKey.required=!0)}function Ya(){H.form.querySelectorAll(".is-invalid").forEach(n=>n.classList.remove("is-invalid"))}function hf(){Ya();let n=!0;const e=H.id.value;H.displayName.checkValidity()||(H.displayName.classList.add("is-invalid"),n=!1),H.avatar.checkValidity()||(H.avatar.classList.add("is-invalid"),n=!1);const t=H.name.value;if(t){const r=x.agents.some(a=>a.id!==e&&a.name===t);(!H.name.checkValidity()||r)&&(H.name.classList.add("is-invalid"),n=!1)}if(!n)return;const s={displayName:H.displayName.value,avatar:H.avatar.value.substring(0,2).toUpperCase(),config:{provider:H.provider.value,apiPath:H.apiPath.value,apiKey:H.apiKey.value,model:H.model.value,isLocal:H.isLocal.checked,systemPrompt:H.systemPrompt.value}};e?(s.id=e,s.name=H.name.value,fu(e,s).then(()=>{Wn(),Rt()})):uu(s).then(()=>{Wn(),Rt()})}async function pf(){confirm(`您确定要永久删除Agent "${H.displayName.value}" 吗？此操作无法撤销！`)&&(await du(H.id.value),Wn(),Rt())}async function mf(n){const e=n.target.closest(".agent-item");if(!e)return;if(e.classList.contains("add-agent-btn")){za();return}const t=e.dataset.agentId;t&&!e.classList.contains("active")&&(gu(t),Rt())}async function yf(n){const e=n.target.closest(".topic-item");if(!e)return;if(e.classList.contains("add-topic-btn")){const s=prompt("请输入新主题的名称:");s&&(await hu(s),Rt());return}const t=e.dataset.topicId;t&&(vu(t),Rt())}function gf(){const n=Hr(x.currentAgentId);n?za(n):console.error("No agent selected to configure.")}async function vf(n){const e=n.target.closest(".history-action-btn");if(!e)return;const t=e.closest(".history-item"),s=t.dataset.messageId;if(e.classList.contains("delete-btn"))confirm("确定要删除这条消息吗？")&&(await mu([s]),Gn());else if(e.classList.contains("edit-btn")){const r=t.querySelector(".history-item-content p"),a=prompt("编辑你的消息:",r.textContent);a&&(await yu(s,a),Gn())}else e.classList.contains("regenerate-btn")&&console.log(`Regenerating response for message ${s}`)}async function sa(){const n=zs.value.trim();!n&&bt.length===0||x.isAiThinking||([...bt],zs.value="",bt=[],Rr([]),await pu(n),zs.focus())}function bf(n){const e=Array.from(n.target.files);e.length!==0&&(bt=[],e.forEach(t=>{const s=new FileReader;s.onload=r=>{bt.push({name:t.name,data:r.target.result}),Rr(bt)},s.readAsDataURL(t)}),n.target.value="")}function wf(n){const e=n.target.closest(".remove-attachment-btn");if(!e)return;const t=parseInt(e.dataset.index,10);bt.splice(t,1),Rr(bt)}function kf(){const n=document.getElementById("chatNavUp"),e=document.getElementById("chatNavDown");n.addEventListener("click",()=>ia(-1)),e.addEventListener("click",()=>ia(1))}function ia(n){if(qn=Array.from(xe.querySelectorAll(".history-item .role.user")),qn.length===0)return;document.querySelectorAll(".history-item.highlighted").forEach(t=>t.classList.remove("highlighted")),rn+=n,rn<0?rn=qn.length-1:rn>=qn.length&&(rn=0);const e=qn[rn].closest(".history-item");if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlighted");const t=e.nextElementSibling;t&&t.classList.contains("history-item")&&t.classList.add("highlighted")}}function Sf(){H.form.addEventListener("submit",e=>{e.preventDefault(),hf()}),H.closeBtn.addEventListener("click",Wn),H.cancelBtn.addEventListener("click",Wn),H.provider.addEventListener("change",()=>{const e=H.provider.value;H.apiPath.value=xl(e),$r(),H.model.value=Dl(e)}),H.isLocal.addEventListener("change",$r),H.deleteBtn.addEventListener("click",()=>{H.deleteConfirmZone.style.display="block",H.agentNameToConfirm.textContent=H.name.value,H.deleteConfirmInput.value="",H.finalDeleteBtn.disabled=!0}),H.deleteConfirmInput.addEventListener("input",e=>{H.finalDeleteBtn.disabled=e.target.value!==H.name.value}),H.finalDeleteBtn.addEventListener("click",pf);const n=document.getElementById("toggleApiKeyVisibility");n.addEventListener("click",()=>{const e=n.querySelector("i");H.apiKey.type==="password"?(H.apiKey.type="text",e.classList.replace("fa-eye","fa-eye-slash")):(H.apiKey.type="password",e.classList.replace("fa-eye-slash","fa-eye"))})}function _f(){Vs.addEventListener("click",mf),Hs.addEventListener("click",yf),xe.addEventListener("click",vf),document.getElementById("agentSettingsTriggerBtn").addEventListener("click",gf),Rl.addEventListener("click",sa),zs.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),sa())}),Ul.addEventListener("change",bf),Tr.addEventListener("click",wf),Sf(),kf()}async function Ef(){console.log("Initializing AI Agent module..."),await Ta(),Rt(),_f()}const Yr=Symbol.for("yaml.alias"),Dr=Symbol.for("yaml.document"),wt=Symbol.for("yaml.map"),Ga=Symbol.for("yaml.pair"),et=Symbol.for("yaml.scalar"),bn=Symbol.for("yaml.seq"),Ve=Symbol.for("yaml.node.type"),Et=n=>!!n&&typeof n=="object"&&n[Ve]===Yr,Ht=n=>!!n&&typeof n=="object"&&n[Ve]===Dr,wn=n=>!!n&&typeof n=="object"&&n[Ve]===wt,be=n=>!!n&&typeof n=="object"&&n[Ve]===Ga,me=n=>!!n&&typeof n=="object"&&n[Ve]===et,kn=n=>!!n&&typeof n=="object"&&n[Ve]===bn;function we(n){if(n&&typeof n=="object")switch(n[Ve]){case wt:case bn:return!0}return!1}function ke(n){if(n&&typeof n=="object")switch(n[Ve]){case Yr:case wt:case et:case bn:return!0}return!1}const Ja=n=>(me(n)||we(n))&&!!n.anchor,Ke=Symbol("break visit"),Wa=Symbol("skip children"),Ze=Symbol("remove node");function zt(n,e){const t=Qa(e);Ht(n)?ln(null,n.contents,t,Object.freeze([n]))===Ze&&(n.contents=null):ln(null,n,t,Object.freeze([]))}zt.BREAK=Ke;zt.SKIP=Wa;zt.REMOVE=Ze;function ln(n,e,t,s){const r=Xa(n,e,t,s);if(ke(r)||be(r))return Za(n,s,r),ln(n,r,t,s);if(typeof r!="symbol"){if(we(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const l=ln(a,e.items[a],t,s);if(typeof l=="number")a=l-1;else{if(l===Ke)return Ke;l===Ze&&(e.items.splice(a,1),a-=1)}}}else if(be(e)){s=Object.freeze(s.concat(e));const a=ln("key",e.key,t,s);if(a===Ke)return Ke;a===Ze&&(e.key=null);const l=ln("value",e.value,t,s);if(l===Ke)return Ke;l===Ze&&(e.value=null)}}return r}async function ii(n,e){const t=Qa(e);Ht(n)?await un(null,n.contents,t,Object.freeze([n]))===Ze&&(n.contents=null):await un(null,n,t,Object.freeze([]))}ii.BREAK=Ke;ii.SKIP=Wa;ii.REMOVE=Ze;async function un(n,e,t,s){const r=await Xa(n,e,t,s);if(ke(r)||be(r))return Za(n,s,r),un(n,r,t,s);if(typeof r!="symbol"){if(we(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const l=await un(a,e.items[a],t,s);if(typeof l=="number")a=l-1;else{if(l===Ke)return Ke;l===Ze&&(e.items.splice(a,1),a-=1)}}}else if(be(e)){s=Object.freeze(s.concat(e));const a=await un("key",e.key,t,s);if(a===Ke)return Ke;a===Ze&&(e.key=null);const l=await un("value",e.value,t,s);if(l===Ke)return Ke;l===Ze&&(e.value=null)}}return r}function Qa(n){return typeof n=="object"&&(n.Collection||n.Node||n.Value)?Object.assign({Alias:n.Node,Map:n.Node,Scalar:n.Node,Seq:n.Node},n.Value&&{Map:n.Value,Scalar:n.Value,Seq:n.Value},n.Collection&&{Map:n.Collection,Seq:n.Collection},n):n}function Xa(n,e,t,s){var r,a,l,d,p;if(typeof t=="function")return t(n,e,s);if(wn(e))return(r=t.Map)==null?void 0:r.call(t,n,e,s);if(kn(e))return(a=t.Seq)==null?void 0:a.call(t,n,e,s);if(be(e))return(l=t.Pair)==null?void 0:l.call(t,n,e,s);if(me(e))return(d=t.Scalar)==null?void 0:d.call(t,n,e,s);if(Et(e))return(p=t.Alias)==null?void 0:p.call(t,n,e,s)}function Za(n,e,t){const s=e[e.length-1];if(we(s))s.items[n]=t;else if(be(s))n==="key"?s.key=t:s.value=t;else if(Ht(s))s.contents=t;else{const r=Et(s)?"alias":"scalar";throw new Error(`Cannot replace node with ${r} parent`)}}const If={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},Af=n=>n.replace(/[!,[\]{}]/g,e=>If[e]);class Pe{constructor(e,t){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Pe.defaultYaml,e),this.tags=Object.assign({},Pe.defaultTags,t)}clone(){const e=new Pe(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){const e=new Pe(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Pe.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Pe.defaultTags);break}return e}add(e,t){this.atNextDocument&&(this.yaml={explicit:Pe.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Pe.defaultTags),this.atNextDocument=!1);const s=e.trim().split(/[ \t]+/),r=s.shift();switch(r){case"%TAG":{if(s.length!==2&&(t(0,"%TAG directive should contain exactly two parts"),s.length<2))return!1;const[a,l]=s;return this.tags[a]=l,!0}case"%YAML":{if(this.yaml.explicit=!0,s.length!==1)return t(0,"%YAML directive should contain exactly one part"),!1;const[a]=s;if(a==="1.1"||a==="1.2")return this.yaml.version=a,!0;{const l=/^\d+\.\d+$/.test(a);return t(6,`Unsupported YAML version ${a}`,l),!1}}default:return t(0,`Unknown directive ${r}`,!0),!1}}tagName(e,t){if(e==="!")return"!";if(e[0]!=="!")return t(`Not a valid tag: ${e}`),null;if(e[1]==="<"){const l=e.slice(2,-1);return l==="!"||l==="!!"?(t(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(e[e.length-1]!==">"&&t("Verbatim tags must end with a >"),l)}const[,s,r]=e.match(/^(.*!)([^!]*)$/s);r||t(`The ${e} tag has no suffix`);const a=this.tags[s];if(a)try{return a+decodeURIComponent(r)}catch(l){return t(String(l)),null}return s==="!"?e:(t(`Could not resolve tag: ${e}`),null)}tagString(e){for(const[t,s]of Object.entries(this.tags))if(e.startsWith(s))return t+Af(e.substring(s.length));return e[0]==="!"?e:`!<${e}>`}toString(e){const t=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],s=Object.entries(this.tags);let r;if(e&&s.length>0&&ke(e.contents)){const a={};zt(e.contents,(l,d)=>{ke(d)&&d.tag&&(a[d.tag]=!0)}),r=Object.keys(a)}else r=[];for(const[a,l]of s)a==="!!"&&l==="tag:yaml.org,2002:"||(!e||r.some(d=>d.startsWith(l)))&&t.push(`%TAG ${a} ${l}`);return t.join(`
`)}}Pe.defaultYaml={explicit:!1,version:"1.2"};Pe.defaultTags={"!!":"tag:yaml.org,2002:"};function ec(n){if(/[\x00-\x19\s,[\]{}]/.test(n)){const t=`Anchor must not contain whitespace or control characters: ${JSON.stringify(n)}`;throw new Error(t)}return!0}function tc(n){const e=new Set;return zt(n,{Value(t,s){s.anchor&&e.add(s.anchor)}}),e}function nc(n,e){for(let t=1;;++t){const s=`${n}${t}`;if(!e.has(s))return s}}function Tf(n,e){const t=[],s=new Map;let r=null;return{onAnchor:a=>{t.push(a),r??(r=tc(n));const l=nc(e,r);return r.add(l),l},setAnchors:()=>{for(const a of t){const l=s.get(a);if(typeof l=="object"&&l.anchor&&(me(l.node)||we(l.node)))l.node.anchor=l.anchor;else{const d=new Error("Failed to resolve repeated object (this should not happen)");throw d.source=a,d}}},sourceObjects:s}}function fn(n,e,t,s){if(s&&typeof s=="object")if(Array.isArray(s))for(let r=0,a=s.length;r<a;++r){const l=s[r],d=fn(n,s,String(r),l);d===void 0?delete s[r]:d!==l&&(s[r]=d)}else if(s instanceof Map)for(const r of Array.from(s.keys())){const a=s.get(r),l=fn(n,s,r,a);l===void 0?s.delete(r):l!==a&&s.set(r,l)}else if(s instanceof Set)for(const r of Array.from(s)){const a=fn(n,s,r,r);a===void 0?s.delete(r):a!==r&&(s.delete(r),s.add(a))}else for(const[r,a]of Object.entries(s)){const l=fn(n,s,r,a);l===void 0?delete s[r]:l!==a&&(s[r]=l)}return n.call(e,t,s)}function Ue(n,e,t){if(Array.isArray(n))return n.map((s,r)=>Ue(s,String(r),t));if(n&&typeof n.toJSON=="function"){if(!t||!Ja(n))return n.toJSON(e,t);const s={aliasCount:0,count:1,res:void 0};t.anchors.set(n,s),t.onCreate=a=>{s.res=a,delete t.onCreate};const r=n.toJSON(e,t);return t.onCreate&&t.onCreate(r),r}return typeof n=="bigint"&&!(t!=null&&t.keep)?Number(n):n}class Gr{constructor(e){Object.defineProperty(this,Ve,{value:e})}clone(){const e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:t,maxAliasCount:s,onAnchor:r,reviver:a}={}){if(!Ht(e))throw new TypeError("A document argument is required");const l={anchors:new Map,doc:e,keep:!0,mapAsMap:t===!0,mapKeyWarned:!1,maxAliasCount:typeof s=="number"?s:100},d=Ue(this,"",l);if(typeof r=="function")for(const{count:p,res:y}of l.anchors.values())r(y,p);return typeof a=="function"?fn(a,{"":d},"",d):d}}class ri extends Gr{constructor(e){super(Yr),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e,t){let s;t!=null&&t.aliasResolveCache?s=t.aliasResolveCache:(s=[],zt(e,{Node:(a,l)=>{(Et(l)||Ja(l))&&s.push(l)}}),t&&(t.aliasResolveCache=s));let r;for(const a of s){if(a===this)break;a.anchor===this.source&&(r=a)}return r}toJSON(e,t){if(!t)return{source:this.source};const{anchors:s,doc:r,maxAliasCount:a}=t,l=this.resolve(r,t);if(!l){const p=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(p)}let d=s.get(l);if(d||(Ue(l,null,t),d=s.get(l)),!d||d.res===void 0){const p="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(p)}if(a>=0&&(d.count+=1,d.aliasCount===0&&(d.aliasCount=Ys(r,l,s)),d.count*d.aliasCount>a)){const p="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(p)}return d.res}toString(e,t,s){const r=`*${this.source}`;if(e){if(ec(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){const a=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(a)}if(e.implicitKey)return`${r} `}return r}}function Ys(n,e,t){if(Et(e)){const s=e.resolve(n),r=t&&s&&t.get(s);return r?r.count*r.aliasCount:0}else if(we(e)){let s=0;for(const r of e.items){const a=Ys(n,r,t);a>s&&(s=a)}return s}else if(be(e)){const s=Ys(n,e.key,t),r=Ys(n,e.value,t);return Math.max(s,r)}return 1}const sc=n=>!n||typeof n!="function"&&typeof n!="object";class se extends Gr{constructor(e){super(et),this.value=e}toJSON(e,t){return t!=null&&t.keep?this.value:Ue(this.value,e,t)}toString(){return String(this.value)}}se.BLOCK_FOLDED="BLOCK_FOLDED";se.BLOCK_LITERAL="BLOCK_LITERAL";se.PLAIN="PLAIN";se.QUOTE_DOUBLE="QUOTE_DOUBLE";se.QUOTE_SINGLE="QUOTE_SINGLE";const Lf="tag:yaml.org,2002:";function Of(n,e,t){if(e){const s=t.filter(a=>a.tag===e),r=s.find(a=>!a.format)??s[0];if(!r)throw new Error(`Tag ${e} not found`);return r}return t.find(s=>{var r;return((r=s.identify)==null?void 0:r.call(s,n))&&!s.format})}function Qn(n,e,t){var I,P,M;if(Ht(n)&&(n=n.contents),ke(n))return n;if(be(n)){const F=(P=(I=t.schema[wt]).createNode)==null?void 0:P.call(I,t.schema,null,t);return F.items.push(n),F}(n instanceof String||n instanceof Number||n instanceof Boolean||typeof BigInt<"u"&&n instanceof BigInt)&&(n=n.valueOf());const{aliasDuplicateObjects:s,onAnchor:r,onTagObj:a,schema:l,sourceObjects:d}=t;let p;if(s&&n&&typeof n=="object"){if(p=d.get(n),p)return p.anchor??(p.anchor=r(n)),new ri(p.anchor);p={anchor:null,node:null},d.set(n,p)}e!=null&&e.startsWith("!!")&&(e=Lf+e.slice(2));let y=Of(n,e,l.tags);if(!y){if(n&&typeof n.toJSON=="function"&&(n=n.toJSON()),!n||typeof n!="object"){const F=new se(n);return p&&(p.node=F),F}y=n instanceof Map?l[wt]:Symbol.iterator in Object(n)?l[bn]:l[wt]}a&&(a(y),delete t.onTagObj);const B=y!=null&&y.createNode?y.createNode(t.schema,n,t):typeof((M=y==null?void 0:y.nodeClass)==null?void 0:M.from)=="function"?y.nodeClass.from(t.schema,n,t):new se(n);return e?B.tag=e:y.default||(B.tag=y.tag),p&&(p.node=B),B}function ei(n,e,t){let s=t;for(let r=e.length-1;r>=0;--r){const a=e[r];if(typeof a=="number"&&Number.isInteger(a)&&a>=0){const l=[];l[a]=s,s=l}else s=new Map([[a,s]])}return Qn(s,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:n,sourceObjects:new Map})}const Vn=n=>n==null||typeof n=="object"&&!!n[Symbol.iterator]().next().done;class ic extends Gr{constructor(e,t){super(e),Object.defineProperty(this,"schema",{value:t,configurable:!0,enumerable:!1,writable:!0})}clone(e){const t=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(t.schema=e),t.items=t.items.map(s=>ke(s)||be(s)?s.clone(e):s),this.range&&(t.range=this.range.slice()),t}addIn(e,t){if(Vn(e))this.add(t);else{const[s,...r]=e,a=this.get(s,!0);if(we(a))a.addIn(r,t);else if(a===void 0&&this.schema)this.set(s,ei(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}deleteIn(e){const[t,...s]=e;if(s.length===0)return this.delete(t);const r=this.get(t,!0);if(we(r))return r.deleteIn(s);throw new Error(`Expected YAML collection at ${t}. Remaining path: ${s}`)}getIn(e,t){const[s,...r]=e,a=this.get(s,!0);return r.length===0?!t&&me(a)?a.value:a:we(a)?a.getIn(r,t):void 0}hasAllNullValues(e){return this.items.every(t=>{if(!be(t))return!1;const s=t.value;return s==null||e&&me(s)&&s.value==null&&!s.commentBefore&&!s.comment&&!s.tag})}hasIn(e){const[t,...s]=e;if(s.length===0)return this.has(t);const r=this.get(t,!0);return we(r)?r.hasIn(s):!1}setIn(e,t){const[s,...r]=e;if(r.length===0)this.set(s,t);else{const a=this.get(s,!0);if(we(a))a.setIn(r,t);else if(a===void 0&&this.schema)this.set(s,ei(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}}const Cf=n=>n.replace(/^(?!$)(?: $)?/gm,"#");function ot(n,e){return/^\n+$/.test(n)?n.substring(1):e?n.replace(/^(?! *$)/gm,e):n}const jt=(n,e,t)=>n.endsWith(`
`)?ot(t,e):t.includes(`
`)?`
`+ot(t,e):(n.endsWith(" ")?"":" ")+t,rc="flow",xr="block",Gs="quoted";function oi(n,e,t="flow",{indentAtStart:s,lineWidth:r=80,minContentWidth:a=20,onFold:l,onOverflow:d}={}){if(!r||r<0)return n;r<a&&(a=0);const p=Math.max(1+a,1+r-e.length);if(n.length<=p)return n;const y=[],B={};let I=r-e.length;typeof s=="number"&&(s>r-Math.max(2,a)?y.push(0):I=r-s);let P,M,F=!1,O=-1,$=-1,G=-1;t===xr&&(O=ra(n,O,e.length),O!==-1&&(I=O+p));for(let Z;Z=n[O+=1];){if(t===Gs&&Z==="\\"){switch($=O,n[O+1]){case"x":O+=3;break;case"u":O+=5;break;case"U":O+=9;break;default:O+=1}G=O}if(Z===`
`)t===xr&&(O=ra(n,O,e.length)),I=O+e.length+p,P=void 0;else{if(Z===" "&&M&&M!==" "&&M!==`
`&&M!=="	"){const Q=n[O+1];Q&&Q!==" "&&Q!==`
`&&Q!=="	"&&(P=O)}if(O>=I)if(P)y.push(P),I=P+p,P=void 0;else if(t===Gs){for(;M===" "||M==="	";)M=Z,Z=n[O+=1],F=!0;const Q=O>G+1?O-2:$-1;if(B[Q])return n;y.push(Q),B[Q]=!0,I=Q+p,P=void 0}else F=!0}M=Z}if(F&&d&&d(),y.length===0)return n;l&&l();let W=n.slice(0,y[0]);for(let Z=0;Z<y.length;++Z){const Q=y[Z],te=y[Z+1]||n.length;Q===0?W=`
${e}${n.slice(0,te)}`:(t===Gs&&B[Q]&&(W+=`${n[Q]}\\`),W+=`
${e}${n.slice(Q+1,te)}`)}return W}function ra(n,e,t){let s=e,r=e+1,a=n[r];for(;a===" "||a==="	";)if(e<r+t)a=n[++e];else{do a=n[++e];while(a&&a!==`
`);s=e,r=e+1,a=n[r]}return s}const ai=(n,e)=>({indentAtStart:e?n.indent.length:n.indentAtStart,lineWidth:n.options.lineWidth,minContentWidth:n.options.minContentWidth}),ci=n=>/^(%|---|\.\.\.)/m.test(n);function Nf(n,e,t){if(!e||e<0)return!1;const s=e-t,r=n.length;if(r<=s)return!1;for(let a=0,l=0;a<r;++a)if(n[a]===`
`){if(a-l>s)return!0;if(l=a+1,r-l<=s)return!1}return!0}function Yn(n,e){const t=JSON.stringify(n);if(e.options.doubleQuotedAsJSON)return t;const{implicitKey:s}=e,r=e.options.doubleQuotedMinMultiLineLength,a=e.indent||(ci(n)?"  ":"");let l="",d=0;for(let p=0,y=t[p];y;y=t[++p])if(y===" "&&t[p+1]==="\\"&&t[p+2]==="n"&&(l+=t.slice(d,p)+"\\ ",p+=1,d=p,y="\\"),y==="\\")switch(t[p+1]){case"u":{l+=t.slice(d,p);const B=t.substr(p+2,4);switch(B){case"0000":l+="\\0";break;case"0007":l+="\\a";break;case"000b":l+="\\v";break;case"001b":l+="\\e";break;case"0085":l+="\\N";break;case"00a0":l+="\\_";break;case"2028":l+="\\L";break;case"2029":l+="\\P";break;default:B.substr(0,2)==="00"?l+="\\x"+B.substr(2):l+=t.substr(p,6)}p+=5,d=p+1}break;case"n":if(s||t[p+2]==='"'||t.length<r)p+=1;else{for(l+=t.slice(d,p)+`

`;t[p+2]==="\\"&&t[p+3]==="n"&&t[p+4]!=='"';)l+=`
`,p+=2;l+=a,t[p+2]===" "&&(l+="\\"),p+=1,d=p+1}break;default:p+=1}return l=d?l+t.slice(d):t,s?l:oi(l,a,Gs,ai(e,!1))}function Kr(n,e){if(e.options.singleQuote===!1||e.implicitKey&&n.includes(`
`)||/[ \t]\n|\n[ \t]/.test(n))return Yn(n,e);const t=e.indent||(ci(n)?"  ":""),s="'"+n.replace(/'/g,"''").replace(/\n+/g,`$&
${t}`)+"'";return e.implicitKey?s:oi(s,t,rc,ai(e,!1))}function dn(n,e){const{singleQuote:t}=e.options;let s;if(t===!1)s=Yn;else{const r=n.includes('"'),a=n.includes("'");r&&!a?s=Kr:a&&!r?s=Yn:s=t?Kr:Yn}return s(n,e)}let jr;try{jr=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{jr=/\n+(?!\n|$)/g}function Js({comment:n,type:e,value:t},s,r,a){const{blockQuote:l,commentString:d,lineWidth:p}=s.options;if(!l||/\n[\t ]+$/.test(t)||/^\s*$/.test(t))return dn(t,s);const y=s.indent||(s.forceBlockIndent||ci(t)?"  ":""),B=l==="literal"?!0:l==="folded"||e===se.BLOCK_FOLDED?!1:e===se.BLOCK_LITERAL?!0:!Nf(t,p,y.length);if(!t)return B?`|
`:`>
`;let I,P;for(P=t.length;P>0;--P){const te=t[P-1];if(te!==`
`&&te!=="	"&&te!==" ")break}let M=t.substring(P);const F=M.indexOf(`
`);F===-1?I="-":t===M||F!==M.length-1?(I="+",a&&a()):I="",M&&(t=t.slice(0,-M.length),M[M.length-1]===`
`&&(M=M.slice(0,-1)),M=M.replace(jr,`$&${y}`));let O=!1,$,G=-1;for($=0;$<t.length;++$){const te=t[$];if(te===" ")O=!0;else if(te===`
`)G=$;else break}let W=t.substring(0,G<$?G+1:$);W&&(t=t.substring(W.length),W=W.replace(/\n+/g,`$&${y}`));let Q=(O?y?"2":"1":"")+I;if(n&&(Q+=" "+d(n.replace(/ ?[\r\n]+/g," ")),r&&r()),!B){const te=t.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${y}`);let ee=!1;const ce=ai(s,!0);l!=="folded"&&e!==se.BLOCK_FOLDED&&(ce.onOverflow=()=>{ee=!0});const J=oi(`${W}${te}${M}`,y,xr,ce);if(!ee)return`>${Q}
${y}${J}`}return t=t.replace(/\n+/g,`$&${y}`),`|${Q}
${y}${W}${t}${M}`}function Bf(n,e,t,s){const{type:r,value:a}=n,{actualString:l,implicitKey:d,indent:p,indentStep:y,inFlow:B}=e;if(d&&a.includes(`
`)||B&&/[[\]{},]/.test(a))return dn(a,e);if(/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(a))return d||B||!a.includes(`
`)?dn(a,e):Js(n,e,t,s);if(!d&&!B&&r!==se.PLAIN&&a.includes(`
`))return Js(n,e,t,s);if(ci(a)){if(p==="")return e.forceBlockIndent=!0,Js(n,e,t,s);if(d&&p===y)return dn(a,e)}const I=a.replace(/\n+/g,`$&
${p}`);if(l){const P=O=>{var $;return O.default&&O.tag!=="tag:yaml.org,2002:str"&&(($=O.test)==null?void 0:$.test(I))},{compat:M,tags:F}=e.doc.schema;if(F.some(P)||M!=null&&M.some(P))return dn(a,e)}return d?I:oi(I,p,rc,ai(e,!1))}function ts(n,e,t,s){const{implicitKey:r,inFlow:a}=e,l=typeof n.value=="string"?n:Object.assign({},n,{value:String(n.value)});let{type:d}=n;d!==se.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(l.value)&&(d=se.QUOTE_DOUBLE);const p=B=>{switch(B){case se.BLOCK_FOLDED:case se.BLOCK_LITERAL:return r||a?dn(l.value,e):Js(l,e,t,s);case se.QUOTE_DOUBLE:return Yn(l.value,e);case se.QUOTE_SINGLE:return Kr(l.value,e);case se.PLAIN:return Bf(l,e,t,s);default:return null}};let y=p(d);if(y===null){const{defaultKeyType:B,defaultStringType:I}=e.options,P=r&&B||I;if(y=p(P),y===null)throw new Error(`Unsupported default string type ${P}`)}return y}function oc(n,e){const t=Object.assign({blockQuote:!0,commentString:Cf,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},n.schema.toStringOptions,e);let s;switch(t.collectionStyle){case"block":s=!1;break;case"flow":s=!0;break;default:s=null}return{anchors:new Set,doc:n,flowCollectionPadding:t.flowCollectionPadding?" ":"",indent:"",indentStep:typeof t.indent=="number"?" ".repeat(t.indent):"  ",inFlow:s,options:t}}function Pf(n,e){var r;if(e.tag){const a=n.filter(l=>l.tag===e.tag);if(a.length>0)return a.find(l=>l.format===e.format)??a[0]}let t,s;if(me(e)){s=e.value;let a=n.filter(l=>{var d;return(d=l.identify)==null?void 0:d.call(l,s)});if(a.length>1){const l=a.filter(d=>d.test);l.length>0&&(a=l)}t=a.find(l=>l.format===e.format)??a.find(l=>!l.format)}else s=e,t=n.find(a=>a.nodeClass&&s instanceof a.nodeClass);if(!t){const a=((r=s==null?void 0:s.constructor)==null?void 0:r.name)??(s===null?"null":typeof s);throw new Error(`Tag not resolved for ${a} value`)}return t}function Mf(n,e,{anchors:t,doc:s}){if(!s.directives)return"";const r=[],a=(me(n)||we(n))&&n.anchor;a&&ec(a)&&(t.add(a),r.push(`&${a}`));const l=n.tag??(e.default?null:e.tag);return l&&r.push(s.directives.tagString(l)),r.join(" ")}function gn(n,e,t,s){var p;if(be(n))return n.toString(e,t,s);if(Et(n)){if(e.doc.directives)return n.toString(e);if((p=e.resolvedAliases)!=null&&p.has(n))throw new TypeError("Cannot stringify circular structure without alias nodes");e.resolvedAliases?e.resolvedAliases.add(n):e.resolvedAliases=new Set([n]),n=n.resolve(e.doc)}let r;const a=ke(n)?n:e.doc.createNode(n,{onTagObj:y=>r=y});r??(r=Pf(e.doc.schema.tags,a));const l=Mf(a,r,e);l.length>0&&(e.indentAtStart=(e.indentAtStart??0)+l.length+1);const d=typeof r.stringify=="function"?r.stringify(a,e,t,s):me(a)?ts(a,e,t,s):a.toString(e,t,s);return l?me(a)||d[0]==="{"||d[0]==="["?`${l} ${d}`:`${l}
${e.indent}${d}`:d}function $f({key:n,value:e},t,s,r){const{allNullValues:a,doc:l,indent:d,indentStep:p,options:{commentString:y,indentSeq:B,simpleKeys:I}}=t;let P=ke(n)&&n.comment||null;if(I){if(P)throw new Error("With simple keys, key nodes cannot have comments");if(we(n)||!ke(n)&&typeof n=="object"){const ce="With simple keys, collection cannot be used as a key value";throw new Error(ce)}}let M=!I&&(!n||P&&e==null&&!t.inFlow||we(n)||(me(n)?n.type===se.BLOCK_FOLDED||n.type===se.BLOCK_LITERAL:typeof n=="object"));t=Object.assign({},t,{allNullValues:!1,implicitKey:!M&&(I||!a),indent:d+p});let F=!1,O=!1,$=gn(n,t,()=>F=!0,()=>O=!0);if(!M&&!t.inFlow&&$.length>1024){if(I)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");M=!0}if(t.inFlow){if(a||e==null)return F&&s&&s(),$===""?"?":M?`? ${$}`:$}else if(a&&!I||e==null&&M)return $=`? ${$}`,P&&!F?$+=jt($,t.indent,y(P)):O&&r&&r(),$;F&&(P=null),M?(P&&($+=jt($,t.indent,y(P))),$=`? ${$}
${d}:`):($=`${$}:`,P&&($+=jt($,t.indent,y(P))));let G,W,Z;ke(e)?(G=!!e.spaceBefore,W=e.commentBefore,Z=e.comment):(G=!1,W=null,Z=null,e&&typeof e=="object"&&(e=l.createNode(e))),t.implicitKey=!1,!M&&!P&&me(e)&&(t.indentAtStart=$.length+1),O=!1,!B&&p.length>=2&&!t.inFlow&&!M&&kn(e)&&!e.flow&&!e.tag&&!e.anchor&&(t.indent=t.indent.substring(2));let Q=!1;const te=gn(e,t,()=>Q=!0,()=>O=!0);let ee=" ";if(P||G||W){if(ee=G?`
`:"",W){const ce=y(W);ee+=`
${ot(ce,t.indent)}`}te===""&&!t.inFlow?ee===`
`&&(ee=`

`):ee+=`
${t.indent}`}else if(!M&&we(e)){const ce=te[0],J=te.indexOf(`
`),Se=J!==-1,He=t.inFlow??e.flow??e.items.length===0;if(Se||!He){let tt=!1;if(Se&&(ce==="&"||ce==="!")){let ye=te.indexOf(" ");ce==="&"&&ye!==-1&&ye<J&&te[ye+1]==="!"&&(ye=te.indexOf(" ",ye+1)),(ye===-1||J<ye)&&(tt=!0)}tt||(ee=`
${t.indent}`)}}else(te===""||te[0]===`
`)&&(ee="");return $+=ee+te,t.inFlow?Q&&s&&s():Z&&!Q?$+=jt($,t.indent,y(Z)):O&&r&&r(),$}function ac(n,e){(n==="debug"||n==="warn")&&console.warn(e)}const Ms="<<",at={identify:n=>n===Ms||typeof n=="symbol"&&n.description===Ms,default:"key",tag:"tag:yaml.org,2002:merge",test:/^<<$/,resolve:()=>Object.assign(new se(Symbol(Ms)),{addToJSMap:cc}),stringify:()=>Ms},Df=(n,e)=>(at.identify(e)||me(e)&&(!e.type||e.type===se.PLAIN)&&at.identify(e.value))&&(n==null?void 0:n.doc.schema.tags.some(t=>t.tag===at.tag&&t.default));function cc(n,e,t){if(t=n&&Et(t)?t.resolve(n.doc):t,kn(t))for(const s of t.items)lr(n,e,s);else if(Array.isArray(t))for(const s of t)lr(n,e,s);else lr(n,e,t)}function lr(n,e,t){const s=n&&Et(t)?t.resolve(n.doc):t;if(!wn(s))throw new Error("Merge sources must be maps or map aliases");const r=s.toJSON(null,n,Map);for(const[a,l]of r)e instanceof Map?e.has(a)||e.set(a,l):e instanceof Set?e.add(a):Object.prototype.hasOwnProperty.call(e,a)||Object.defineProperty(e,a,{value:l,writable:!0,enumerable:!0,configurable:!0});return e}function lc(n,e,{key:t,value:s}){if(ke(t)&&t.addToJSMap)t.addToJSMap(n,e,s);else if(Df(n,t))cc(n,e,s);else{const r=Ue(t,"",n);if(e instanceof Map)e.set(r,Ue(s,r,n));else if(e instanceof Set)e.add(r);else{const a=xf(t,r,n),l=Ue(s,a,n);a in e?Object.defineProperty(e,a,{value:l,writable:!0,enumerable:!0,configurable:!0}):e[a]=l}}return e}function xf(n,e,t){if(e===null)return"";if(typeof e!="object")return String(e);if(ke(n)&&(t!=null&&t.doc)){const s=oc(t.doc,{});s.anchors=new Set;for(const a of t.anchors.keys())s.anchors.add(a.anchor);s.inFlow=!0,s.inStringifyKey=!0;const r=n.toString(s);if(!t.mapKeyWarned){let a=JSON.stringify(r);a.length>40&&(a=a.substring(0,36)+'..."'),ac(t.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${a}. Set mapAsMap: true to use object keys.`),t.mapKeyWarned=!0}return r}return JSON.stringify(e)}function Jr(n,e,t){const s=Qn(n,void 0,t),r=Qn(e,void 0,t);return new Ne(s,r)}class Ne{constructor(e,t=null){Object.defineProperty(this,Ve,{value:Ga}),this.key=e,this.value=t}clone(e){let{key:t,value:s}=this;return ke(t)&&(t=t.clone(e)),ke(s)&&(s=s.clone(e)),new Ne(t,s)}toJSON(e,t){const s=t!=null&&t.mapAsMap?new Map:{};return lc(t,s,this)}toString(e,t,s){return e!=null&&e.doc?$f(this,e,t,s):JSON.stringify(this)}}function uc(n,e,t){return(e.inFlow??n.flow?jf:Kf)(n,e,t)}function Kf({comment:n,items:e},t,{blockItemPrefix:s,flowChars:r,itemIndent:a,onChompKeep:l,onComment:d}){const{indent:p,options:{commentString:y}}=t,B=Object.assign({},t,{indent:a,type:null});let I=!1;const P=[];for(let F=0;F<e.length;++F){const O=e[F];let $=null;if(ke(O))!I&&O.spaceBefore&&P.push(""),ti(t,P,O.commentBefore,I),O.comment&&($=O.comment);else if(be(O)){const W=ke(O.key)?O.key:null;W&&(!I&&W.spaceBefore&&P.push(""),ti(t,P,W.commentBefore,I))}I=!1;let G=gn(O,B,()=>$=null,()=>I=!0);$&&(G+=jt(G,a,y($))),I&&$&&(I=!1),P.push(s+G)}let M;if(P.length===0)M=r.start+r.end;else{M=P[0];for(let F=1;F<P.length;++F){const O=P[F];M+=O?`
${p}${O}`:`
`}}return n?(M+=`
`+ot(y(n),p),d&&d()):I&&l&&l(),M}function jf({items:n},e,{flowChars:t,itemIndent:s}){const{indent:r,indentStep:a,flowCollectionPadding:l,options:{commentString:d}}=e;s+=a;const p=Object.assign({},e,{indent:s,inFlow:!0,type:null});let y=!1,B=0;const I=[];for(let F=0;F<n.length;++F){const O=n[F];let $=null;if(ke(O))O.spaceBefore&&I.push(""),ti(e,I,O.commentBefore,!1),O.comment&&($=O.comment);else if(be(O)){const W=ke(O.key)?O.key:null;W&&(W.spaceBefore&&I.push(""),ti(e,I,W.commentBefore,!1),W.comment&&(y=!0));const Z=ke(O.value)?O.value:null;Z?(Z.comment&&($=Z.comment),Z.commentBefore&&(y=!0)):O.value==null&&(W!=null&&W.comment)&&($=W.comment)}$&&(y=!0);let G=gn(O,p,()=>$=null);F<n.length-1&&(G+=","),$&&(G+=jt(G,s,d($))),!y&&(I.length>B||G.includes(`
`))&&(y=!0),I.push(G),B=I.length}const{start:P,end:M}=t;if(I.length===0)return P+M;if(!y){const F=I.reduce((O,$)=>O+$.length+2,2);y=e.options.lineWidth>0&&F>e.options.lineWidth}if(y){let F=P;for(const O of I)F+=O?`
${a}${r}${O}`:`
`;return`${F}
${r}${M}`}else return`${P}${l}${I.join(" ")}${l}${M}`}function ti({indent:n,options:{commentString:e}},t,s,r){if(s&&r&&(s=s.replace(/^\n+/,"")),s){const a=ot(e(s),n);t.push(a.trimStart())}}function qt(n,e){const t=me(e)?e.value:e;for(const s of n)if(be(s)&&(s.key===e||s.key===t||me(s.key)&&s.key.value===t))return s}class Fe extends ic{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(wt,e),this.items=[]}static from(e,t,s){const{keepUndefined:r,replacer:a}=s,l=new this(e),d=(p,y)=>{if(typeof a=="function")y=a.call(t,p,y);else if(Array.isArray(a)&&!a.includes(p))return;(y!==void 0||r)&&l.items.push(Jr(p,y,s))};if(t instanceof Map)for(const[p,y]of t)d(p,y);else if(t&&typeof t=="object")for(const p of Object.keys(t))d(p,t[p]);return typeof e.sortMapEntries=="function"&&l.items.sort(e.sortMapEntries),l}add(e,t){var l;let s;be(e)?s=e:!e||typeof e!="object"||!("key"in e)?s=new Ne(e,e==null?void 0:e.value):s=new Ne(e.key,e.value);const r=qt(this.items,s.key),a=(l=this.schema)==null?void 0:l.sortMapEntries;if(r){if(!t)throw new Error(`Key ${s.key} already set`);me(r.value)&&sc(s.value)?r.value.value=s.value:r.value=s.value}else if(a){const d=this.items.findIndex(p=>a(s,p)<0);d===-1?this.items.push(s):this.items.splice(d,0,s)}else this.items.push(s)}delete(e){const t=qt(this.items,e);return t?this.items.splice(this.items.indexOf(t),1).length>0:!1}get(e,t){const s=qt(this.items,e),r=s==null?void 0:s.value;return(!t&&me(r)?r.value:r)??void 0}has(e){return!!qt(this.items,e)}set(e,t){this.add(new Ne(e,t),!0)}toJSON(e,t,s){const r=s?new s:t!=null&&t.mapAsMap?new Map:{};t!=null&&t.onCreate&&t.onCreate(r);for(const a of this.items)lc(t,r,a);return r}toString(e,t,s){if(!e)return JSON.stringify(this);for(const r of this.items)if(!be(r))throw new Error(`Map items must all be pairs; found ${JSON.stringify(r)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),uc(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:s,onComment:t})}}const Sn={collection:"map",default:!0,nodeClass:Fe,tag:"tag:yaml.org,2002:map",resolve(n,e){return wn(n)||e("Expected a mapping for this tag"),n},createNode:(n,e,t)=>Fe.from(n,e,t)};class _t extends ic{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(bn,e),this.items=[]}add(e){this.items.push(e)}delete(e){const t=$s(e);return typeof t!="number"?!1:this.items.splice(t,1).length>0}get(e,t){const s=$s(e);if(typeof s!="number")return;const r=this.items[s];return!t&&me(r)?r.value:r}has(e){const t=$s(e);return typeof t=="number"&&t<this.items.length}set(e,t){const s=$s(e);if(typeof s!="number")throw new Error(`Expected a valid index, not ${e}.`);const r=this.items[s];me(r)&&sc(t)?r.value=t:this.items[s]=t}toJSON(e,t){const s=[];t!=null&&t.onCreate&&t.onCreate(s);let r=0;for(const a of this.items)s.push(Ue(a,String(r++),t));return s}toString(e,t,s){return e?uc(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:s,onComment:t}):JSON.stringify(this)}static from(e,t,s){const{replacer:r}=s,a=new this(e);if(t&&Symbol.iterator in Object(t)){let l=0;for(let d of t){if(typeof r=="function"){const p=t instanceof Set?d:String(l++);d=r.call(t,p,d)}a.items.push(Qn(d,void 0,s))}}return a}}function $s(n){let e=me(n)?n.value:n;return e&&typeof e=="string"&&(e=Number(e)),typeof e=="number"&&Number.isInteger(e)&&e>=0?e:null}const _n={collection:"seq",default:!0,nodeClass:_t,tag:"tag:yaml.org,2002:seq",resolve(n,e){return kn(n)||e("Expected a sequence for this tag"),n},createNode:(n,e,t)=>_t.from(n,e,t)},li={identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify(n,e,t,s){return e=Object.assign({actualString:!0},e),ts(n,e,t,s)}},ui={identify:n=>n==null,createNode:()=>new se(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new se(null),stringify:({source:n},e)=>typeof n=="string"&&ui.test.test(n)?n:e.options.nullStr},Wr={identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:n=>new se(n[0]==="t"||n[0]==="T"),stringify({source:n,value:e},t){if(n&&Wr.test.test(n)){const s=n[0]==="t"||n[0]==="T";if(e===s)return n}return e?t.options.trueStr:t.options.falseStr}};function Ge({format:n,minFractionDigits:e,tag:t,value:s}){if(typeof s=="bigint")return String(s);const r=typeof s=="number"?s:Number(s);if(!isFinite(r))return isNaN(r)?".nan":r<0?"-.inf":".inf";let a=JSON.stringify(s);if(!n&&e&&(!t||t==="tag:yaml.org,2002:float")&&/^\d/.test(a)){let l=a.indexOf(".");l<0&&(l=a.length,a+=".");let d=e-(a.length-l-1);for(;d-- >0;)a+="0"}return a}const fc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Ge},dc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Ge(n)}},hc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(n){const e=new se(parseFloat(n)),t=n.indexOf(".");return t!==-1&&n[n.length-1]==="0"&&(e.minFractionDigits=n.length-t-1),e},stringify:Ge},fi=n=>typeof n=="bigint"||Number.isInteger(n),Qr=(n,e,t,{intAsBigInt:s})=>s?BigInt(n):parseInt(n.substring(e),t);function pc(n,e,t){const{value:s}=n;return fi(s)&&s>=0?t+s.toString(e):Ge(n)}const mc={identify:n=>fi(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(n,e,t)=>Qr(n,2,8,t),stringify:n=>pc(n,8,"0o")},yc={identify:fi,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(n,e,t)=>Qr(n,0,10,t),stringify:Ge},gc={identify:n=>fi(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(n,e,t)=>Qr(n,2,16,t),stringify:n=>pc(n,16,"0x")},qf=[Sn,_n,li,ui,Wr,mc,yc,gc,fc,dc,hc];function oa(n){return typeof n=="bigint"||Number.isInteger(n)}const Ds=({value:n})=>JSON.stringify(n),Ff=[{identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify:Ds},{identify:n=>n==null,createNode:()=>new se(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:Ds},{identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true$|^false$/,resolve:n=>n==="true",stringify:Ds},{identify:oa,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(n,e,{intAsBigInt:t})=>t?BigInt(n):parseInt(n,10),stringify:({value:n})=>oa(n)?n.toString():JSON.stringify(n)},{identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:n=>parseFloat(n),stringify:Ds}],Rf={default:!0,tag:"",test:/^/,resolve(n,e){return e(`Unresolved plain scalar ${JSON.stringify(n)}`),n}},Uf=[Sn,_n].concat(Ff,Rf),Xr={identify:n=>n instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(n,e){if(typeof atob=="function"){const t=atob(n.replace(/[\n\r]/g,"")),s=new Uint8Array(t.length);for(let r=0;r<t.length;++r)s[r]=t.charCodeAt(r);return s}else return e("This environment does not support reading binary tags; either Buffer or atob is required"),n},stringify({comment:n,type:e,value:t},s,r,a){if(!t)return"";const l=t;let d;if(typeof btoa=="function"){let p="";for(let y=0;y<l.length;++y)p+=String.fromCharCode(l[y]);d=btoa(p)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(e??(e=se.BLOCK_LITERAL),e!==se.QUOTE_DOUBLE){const p=Math.max(s.options.lineWidth-s.indent.length,s.options.minContentWidth),y=Math.ceil(d.length/p),B=new Array(y);for(let I=0,P=0;I<y;++I,P+=p)B[I]=d.substr(P,p);d=B.join(e===se.BLOCK_LITERAL?`
`:" ")}return ts({comment:n,type:e,value:d},s,r,a)}};function vc(n,e){if(kn(n))for(let t=0;t<n.items.length;++t){let s=n.items[t];if(!be(s)){if(wn(s)){s.items.length>1&&e("Each pair must have its own sequence indicator");const r=s.items[0]||new Ne(new se(null));if(s.commentBefore&&(r.key.commentBefore=r.key.commentBefore?`${s.commentBefore}
${r.key.commentBefore}`:s.commentBefore),s.comment){const a=r.value??r.key;a.comment=a.comment?`${s.comment}
${a.comment}`:s.comment}s=r}n.items[t]=be(s)?s:new Ne(s)}}else e("Expected a sequence for this tag");return n}function bc(n,e,t){const{replacer:s}=t,r=new _t(n);r.tag="tag:yaml.org,2002:pairs";let a=0;if(e&&Symbol.iterator in Object(e))for(let l of e){typeof s=="function"&&(l=s.call(e,String(a++),l));let d,p;if(Array.isArray(l))if(l.length===2)d=l[0],p=l[1];else throw new TypeError(`Expected [key, value] tuple: ${l}`);else if(l&&l instanceof Object){const y=Object.keys(l);if(y.length===1)d=y[0],p=l[d];else throw new TypeError(`Expected tuple with one key, not ${y.length} keys`)}else d=l;r.items.push(Jr(d,p,t))}return r}const Zr={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:vc,createNode:bc};class pn extends _t{constructor(){super(),this.add=Fe.prototype.add.bind(this),this.delete=Fe.prototype.delete.bind(this),this.get=Fe.prototype.get.bind(this),this.has=Fe.prototype.has.bind(this),this.set=Fe.prototype.set.bind(this),this.tag=pn.tag}toJSON(e,t){if(!t)return super.toJSON(e);const s=new Map;t!=null&&t.onCreate&&t.onCreate(s);for(const r of this.items){let a,l;if(be(r)?(a=Ue(r.key,"",t),l=Ue(r.value,a,t)):a=Ue(r,"",t),s.has(a))throw new Error("Ordered maps must not include duplicate keys");s.set(a,l)}return s}static from(e,t,s){const r=bc(e,t,s),a=new this;return a.items=r.items,a}}pn.tag="tag:yaml.org,2002:omap";const eo={collection:"seq",identify:n=>n instanceof Map,nodeClass:pn,default:!1,tag:"tag:yaml.org,2002:omap",resolve(n,e){const t=vc(n,e),s=[];for(const{key:r}of t.items)me(r)&&(s.includes(r.value)?e(`Ordered maps must not include duplicate keys: ${r.value}`):s.push(r.value));return Object.assign(new pn,t)},createNode:(n,e,t)=>pn.from(n,e,t)};function wc({value:n,source:e},t){return e&&(n?kc:Sc).test.test(e)?e:n?t.options.trueStr:t.options.falseStr}const kc={identify:n=>n===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new se(!0),stringify:wc},Sc={identify:n=>n===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/,resolve:()=>new se(!1),stringify:wc},Vf={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Ge},Hf={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n.replace(/_/g,"")),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Ge(n)}},zf={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(n){const e=new se(parseFloat(n.replace(/_/g,""))),t=n.indexOf(".");if(t!==-1){const s=n.substring(t+1).replace(/_/g,"");s[s.length-1]==="0"&&(e.minFractionDigits=s.length)}return e},stringify:Ge},ns=n=>typeof n=="bigint"||Number.isInteger(n);function di(n,e,t,{intAsBigInt:s}){const r=n[0];if((r==="-"||r==="+")&&(e+=1),n=n.substring(e).replace(/_/g,""),s){switch(t){case 2:n=`0b${n}`;break;case 8:n=`0o${n}`;break;case 16:n=`0x${n}`;break}const l=BigInt(n);return r==="-"?BigInt(-1)*l:l}const a=parseInt(n,t);return r==="-"?-1*a:a}function to(n,e,t){const{value:s}=n;if(ns(s)){const r=s.toString(e);return s<0?"-"+t+r.substr(1):t+r}return Ge(n)}const Yf={identify:ns,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(n,e,t)=>di(n,2,2,t),stringify:n=>to(n,2,"0b")},Gf={identify:ns,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(n,e,t)=>di(n,1,8,t),stringify:n=>to(n,8,"0")},Jf={identify:ns,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(n,e,t)=>di(n,0,10,t),stringify:Ge},Wf={identify:ns,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(n,e,t)=>di(n,2,16,t),stringify:n=>to(n,16,"0x")};class mn extends Fe{constructor(e){super(e),this.tag=mn.tag}add(e){let t;be(e)?t=e:e&&typeof e=="object"&&"key"in e&&"value"in e&&e.value===null?t=new Ne(e.key,null):t=new Ne(e,null),qt(this.items,t.key)||this.items.push(t)}get(e,t){const s=qt(this.items,e);return!t&&be(s)?me(s.key)?s.key.value:s.key:s}set(e,t){if(typeof t!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof t}`);const s=qt(this.items,e);s&&!t?this.items.splice(this.items.indexOf(s),1):!s&&t&&this.items.push(new Ne(e))}toJSON(e,t){return super.toJSON(e,t,Set)}toString(e,t,s){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),t,s);throw new Error("Set items must all have null values")}static from(e,t,s){const{replacer:r}=s,a=new this(e);if(t&&Symbol.iterator in Object(t))for(let l of t)typeof r=="function"&&(l=r.call(t,l,l)),a.items.push(Jr(l,null,s));return a}}mn.tag="tag:yaml.org,2002:set";const no={collection:"map",identify:n=>n instanceof Set,nodeClass:mn,default:!1,tag:"tag:yaml.org,2002:set",createNode:(n,e,t)=>mn.from(n,e,t),resolve(n,e){if(wn(n)){if(n.hasAllNullValues(!0))return Object.assign(new mn,n);e("Set items must all have null values")}else e("Expected a mapping for this tag");return n}};function so(n,e){const t=n[0],s=t==="-"||t==="+"?n.substring(1):n,r=l=>e?BigInt(l):Number(l),a=s.replace(/_/g,"").split(":").reduce((l,d)=>l*r(60)+r(d),r(0));return t==="-"?r(-1)*a:a}function _c(n){let{value:e}=n,t=l=>l;if(typeof e=="bigint")t=l=>BigInt(l);else if(isNaN(e)||!isFinite(e))return Ge(n);let s="";e<0&&(s="-",e*=t(-1));const r=t(60),a=[e%r];return e<60?a.unshift(0):(e=(e-a[0])/r,a.unshift(e%r),e>=60&&(e=(e-a[0])/r,a.unshift(e))),s+a.map(l=>String(l).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const Ec={identify:n=>typeof n=="bigint"||Number.isInteger(n),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(n,e,{intAsBigInt:t})=>so(n,t),stringify:_c},Ic={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:n=>so(n,!1),stringify:_c},hi={identify:n=>n instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(n){const e=n.match(hi.test);if(!e)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,t,s,r,a,l,d]=e.map(Number),p=e[7]?Number((e[7]+"00").substr(1,3)):0;let y=Date.UTC(t,s-1,r,a||0,l||0,d||0,p);const B=e[8];if(B&&B!=="Z"){let I=so(B,!1);Math.abs(I)<30&&(I*=60),y-=6e4*I}return new Date(y)},stringify:({value:n})=>(n==null?void 0:n.toISOString().replace(/(T00:00:00)?\.000Z$/,""))??""},aa=[Sn,_n,li,ui,kc,Sc,Yf,Gf,Jf,Wf,Vf,Hf,zf,Xr,at,eo,Zr,no,Ec,Ic,hi],ca=new Map([["core",qf],["failsafe",[Sn,_n,li]],["json",Uf],["yaml11",aa],["yaml-1.1",aa]]),la={binary:Xr,bool:Wr,float:hc,floatExp:dc,floatNaN:fc,floatTime:Ic,int:yc,intHex:gc,intOct:mc,intTime:Ec,map:Sn,merge:at,null:ui,omap:eo,pairs:Zr,seq:_n,set:no,timestamp:hi},Qf={"tag:yaml.org,2002:binary":Xr,"tag:yaml.org,2002:merge":at,"tag:yaml.org,2002:omap":eo,"tag:yaml.org,2002:pairs":Zr,"tag:yaml.org,2002:set":no,"tag:yaml.org,2002:timestamp":hi};function ur(n,e,t){const s=ca.get(e);if(s&&!n)return t&&!s.includes(at)?s.concat(at):s.slice();let r=s;if(!r)if(Array.isArray(n))r=[];else{const a=Array.from(ca.keys()).filter(l=>l!=="yaml11").map(l=>JSON.stringify(l)).join(", ");throw new Error(`Unknown schema "${e}"; use one of ${a} or define customTags array`)}if(Array.isArray(n))for(const a of n)r=r.concat(a);else typeof n=="function"&&(r=n(r.slice()));return t&&(r=r.concat(at)),r.reduce((a,l)=>{const d=typeof l=="string"?la[l]:l;if(!d){const p=JSON.stringify(l),y=Object.keys(la).map(B=>JSON.stringify(B)).join(", ");throw new Error(`Unknown custom tag ${p}; use one of ${y}`)}return a.includes(d)||a.push(d),a},[])}const Xf=(n,e)=>n.key<e.key?-1:n.key>e.key?1:0;class pi{constructor({compat:e,customTags:t,merge:s,resolveKnownTags:r,schema:a,sortMapEntries:l,toStringDefaults:d}){this.compat=Array.isArray(e)?ur(e,"compat"):e?ur(null,e):null,this.name=typeof a=="string"&&a||"core",this.knownTags=r?Qf:{},this.tags=ur(t,this.name,s),this.toStringOptions=d??null,Object.defineProperty(this,wt,{value:Sn}),Object.defineProperty(this,et,{value:li}),Object.defineProperty(this,bn,{value:_n}),this.sortMapEntries=typeof l=="function"?l:l===!0?Xf:null}clone(){const e=Object.create(pi.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}}function Zf(n,e){var p;const t=[];let s=e.directives===!0;if(e.directives!==!1&&n.directives){const y=n.directives.toString(n);y?(t.push(y),s=!0):n.directives.docStart&&(s=!0)}s&&t.push("---");const r=oc(n,e),{commentString:a}=r.options;if(n.commentBefore){t.length!==1&&t.unshift("");const y=a(n.commentBefore);t.unshift(ot(y,""))}let l=!1,d=null;if(n.contents){if(ke(n.contents)){if(n.contents.spaceBefore&&s&&t.push(""),n.contents.commentBefore){const I=a(n.contents.commentBefore);t.push(ot(I,""))}r.forceBlockIndent=!!n.comment,d=n.contents.comment}const y=d?void 0:()=>l=!0;let B=gn(n.contents,r,()=>d=null,y);d&&(B+=jt(B,"",a(d))),(B[0]==="|"||B[0]===">")&&t[t.length-1]==="---"?t[t.length-1]=`--- ${B}`:t.push(B)}else t.push(gn(n.contents,r));if((p=n.directives)!=null&&p.docEnd)if(n.comment){const y=a(n.comment);y.includes(`
`)?(t.push("..."),t.push(ot(y,""))):t.push(`... ${y}`)}else t.push("...");else{let y=n.comment;y&&l&&(y=y.replace(/^\n+/,"")),y&&((!l||d)&&t[t.length-1]!==""&&t.push(""),t.push(ot(a(y),"")))}return t.join(`
`)+`
`}class En{constructor(e,t,s){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,Ve,{value:Dr});let r=null;typeof t=="function"||Array.isArray(t)?r=t:s===void 0&&t&&(s=t,t=void 0);const a=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,stringKeys:!1,uniqueKeys:!0,version:"1.2"},s);this.options=a;let{version:l}=a;s!=null&&s._directives?(this.directives=s._directives.atDocument(),this.directives.yaml.explicit&&(l=this.directives.yaml.version)):this.directives=new Pe({version:l}),this.setSchema(l,s),this.contents=e===void 0?null:this.createNode(e,r,s)}clone(){const e=Object.create(En.prototype,{[Ve]:{value:Dr}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=ke(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){on(this.contents)&&this.contents.add(e)}addIn(e,t){on(this.contents)&&this.contents.addIn(e,t)}createAlias(e,t){if(!e.anchor){const s=tc(this);e.anchor=!t||s.has(t)?nc(t||"a",s):t}return new ri(e.anchor)}createNode(e,t,s){let r;if(typeof t=="function")e=t.call({"":e},"",e),r=t;else if(Array.isArray(t)){const $=W=>typeof W=="number"||W instanceof String||W instanceof Number,G=t.filter($).map(String);G.length>0&&(t=t.concat(G)),r=t}else s===void 0&&t&&(s=t,t=void 0);const{aliasDuplicateObjects:a,anchorPrefix:l,flow:d,keepUndefined:p,onTagObj:y,tag:B}=s??{},{onAnchor:I,setAnchors:P,sourceObjects:M}=Tf(this,l||"a"),F={aliasDuplicateObjects:a??!0,keepUndefined:p??!1,onAnchor:I,onTagObj:y,replacer:r,schema:this.schema,sourceObjects:M},O=Qn(e,B,F);return d&&we(O)&&(O.flow=!0),P(),O}createPair(e,t,s={}){const r=this.createNode(e,null,s),a=this.createNode(t,null,s);return new Ne(r,a)}delete(e){return on(this.contents)?this.contents.delete(e):!1}deleteIn(e){return Vn(e)?this.contents==null?!1:(this.contents=null,!0):on(this.contents)?this.contents.deleteIn(e):!1}get(e,t){return we(this.contents)?this.contents.get(e,t):void 0}getIn(e,t){return Vn(e)?!t&&me(this.contents)?this.contents.value:this.contents:we(this.contents)?this.contents.getIn(e,t):void 0}has(e){return we(this.contents)?this.contents.has(e):!1}hasIn(e){return Vn(e)?this.contents!==void 0:we(this.contents)?this.contents.hasIn(e):!1}set(e,t){this.contents==null?this.contents=ei(this.schema,[e],t):on(this.contents)&&this.contents.set(e,t)}setIn(e,t){Vn(e)?this.contents=t:this.contents==null?this.contents=ei(this.schema,Array.from(e),t):on(this.contents)&&this.contents.setIn(e,t)}setSchema(e,t={}){typeof e=="number"&&(e=String(e));let s;switch(e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Pe({version:"1.1"}),s={resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Pe({version:e}),s={resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,s=null;break;default:{const r=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${r}`)}}if(t.schema instanceof Object)this.schema=t.schema;else if(s)this.schema=new pi(Object.assign(s,t));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:e,jsonArg:t,mapAsMap:s,maxAliasCount:r,onAnchor:a,reviver:l}={}){const d={anchors:new Map,doc:this,keep:!e,mapAsMap:s===!0,mapKeyWarned:!1,maxAliasCount:typeof r=="number"?r:100},p=Ue(this.contents,t??"",d);if(typeof a=="function")for(const{count:y,res:B}of d.anchors.values())a(B,y);return typeof l=="function"?fn(l,{"":p},"",p):p}toJSON(e,t){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:t})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){const t=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${t}`)}return Zf(this,e)}}function on(n){if(we(n))return!0;throw new Error("Expected a YAML collection as document contents")}class io extends Error{constructor(e,t,s,r){super(),this.name=e,this.code=s,this.message=r,this.pos=t}}class Ft extends io{constructor(e,t,s){super("YAMLParseError",e,t,s)}}class Ac extends io{constructor(e,t,s){super("YAMLWarning",e,t,s)}}const ni=(n,e)=>t=>{if(t.pos[0]===-1)return;t.linePos=t.pos.map(d=>e.linePos(d));const{line:s,col:r}=t.linePos[0];t.message+=` at line ${s}, column ${r}`;let a=r-1,l=n.substring(e.lineStarts[s-1],e.lineStarts[s]).replace(/[\n\r]+$/,"");if(a>=60&&l.length>80){const d=Math.min(a-39,l.length-79);l="…"+l.substring(d),a-=d-1}if(l.length>80&&(l=l.substring(0,79)+"…"),s>1&&/^ *$/.test(l.substring(0,a))){let d=n.substring(e.lineStarts[s-2],e.lineStarts[s-1]);d.length>80&&(d=d.substring(0,79)+`…
`),l=d+l}if(/[^ ]/.test(l)){let d=1;const p=t.linePos[1];p&&p.line===s&&p.col>r&&(d=Math.max(1,Math.min(p.col-r,80-a)));const y=" ".repeat(a)+"^".repeat(d);t.message+=`:

${l}
${y}
`}};function vn(n,{flow:e,indicator:t,next:s,offset:r,onError:a,parentIndent:l,startOnNewline:d}){let p=!1,y=d,B=d,I="",P="",M=!1,F=!1,O=null,$=null,G=null,W=null,Z=null,Q=null,te=null;for(const J of n)switch(F&&(J.type!=="space"&&J.type!=="newline"&&J.type!=="comma"&&a(J.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),F=!1),O&&(y&&J.type!=="comment"&&J.type!=="newline"&&a(O,"TAB_AS_INDENT","Tabs are not allowed as indentation"),O=null),J.type){case"space":!e&&(t!=="doc-start"||(s==null?void 0:s.type)!=="flow-collection")&&J.source.includes("	")&&(O=J),B=!0;break;case"comment":{B||a(J,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const Se=J.source.substring(1)||" ";I?I+=P+Se:I=Se,P="",y=!1;break}case"newline":y?I?I+=J.source:(!Q||t!=="seq-item-ind")&&(p=!0):P+=J.source,y=!0,M=!0,($||G)&&(W=J),B=!0;break;case"anchor":$&&a(J,"MULTIPLE_ANCHORS","A node can have at most one anchor"),J.source.endsWith(":")&&a(J.offset+J.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),$=J,te??(te=J.offset),y=!1,B=!1,F=!0;break;case"tag":{G&&a(J,"MULTIPLE_TAGS","A node can have at most one tag"),G=J,te??(te=J.offset),y=!1,B=!1,F=!0;break}case t:($||G)&&a(J,"BAD_PROP_ORDER",`Anchors and tags must be after the ${J.source} indicator`),Q&&a(J,"UNEXPECTED_TOKEN",`Unexpected ${J.source} in ${e??"collection"}`),Q=J,y=t==="seq-item-ind"||t==="explicit-key-ind",B=!1;break;case"comma":if(e){Z&&a(J,"UNEXPECTED_TOKEN",`Unexpected , in ${e}`),Z=J,y=!1,B=!1;break}default:a(J,"UNEXPECTED_TOKEN",`Unexpected ${J.type} token`),y=!1,B=!1}const ee=n[n.length-1],ce=ee?ee.offset+ee.source.length:r;return F&&s&&s.type!=="space"&&s.type!=="newline"&&s.type!=="comma"&&(s.type!=="scalar"||s.source!=="")&&a(s.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),O&&(y&&O.indent<=l||(s==null?void 0:s.type)==="block-map"||(s==null?void 0:s.type)==="block-seq")&&a(O,"TAB_AS_INDENT","Tabs are not allowed as indentation"),{comma:Z,found:Q,spaceBefore:p,comment:I,hasNewline:M,anchor:$,tag:G,newlineAfterProp:W,end:ce,start:te??ce}}function Xn(n){if(!n)return null;switch(n.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(n.source.includes(`
`))return!0;if(n.end){for(const e of n.end)if(e.type==="newline")return!0}return!1;case"flow-collection":for(const e of n.items){for(const t of e.start)if(t.type==="newline")return!0;if(e.sep){for(const t of e.sep)if(t.type==="newline")return!0}if(Xn(e.key)||Xn(e.value))return!0}return!1;default:return!0}}function qr(n,e,t){if((e==null?void 0:e.type)==="flow-collection"){const s=e.end[0];s.indent===n&&(s.source==="]"||s.source==="}")&&Xn(e)&&t(s,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}function Tc(n,e,t){const{uniqueKeys:s}=n.options;if(s===!1)return!1;const r=typeof s=="function"?s:(a,l)=>a===l||me(a)&&me(l)&&a.value===l.value;return e.some(a=>r(a.key,t))}const ua="All mapping items must start at the same column";function ed({composeNode:n,composeEmptyNode:e},t,s,r,a){var B;const l=(a==null?void 0:a.nodeClass)??Fe,d=new l(t.schema);t.atRoot&&(t.atRoot=!1);let p=s.offset,y=null;for(const I of s.items){const{start:P,key:M,sep:F,value:O}=I,$=vn(P,{indicator:"explicit-key-ind",next:M??(F==null?void 0:F[0]),offset:p,onError:r,parentIndent:s.indent,startOnNewline:!0}),G=!$.found;if(G){if(M&&(M.type==="block-seq"?r(p,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in M&&M.indent!==s.indent&&r(p,"BAD_INDENT",ua)),!$.anchor&&!$.tag&&!F){y=$.end,$.comment&&(d.comment?d.comment+=`
`+$.comment:d.comment=$.comment);continue}($.newlineAfterProp||Xn(M))&&r(M??P[P.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else((B=$.found)==null?void 0:B.indent)!==s.indent&&r(p,"BAD_INDENT",ua);t.atKey=!0;const W=$.end,Z=M?n(t,M,$,r):e(t,W,P,null,$,r);t.schema.compat&&qr(s.indent,M,r),t.atKey=!1,Tc(t,d.items,Z)&&r(W,"DUPLICATE_KEY","Map keys must be unique");const Q=vn(F??[],{indicator:"map-value-ind",next:O,offset:Z.range[2],onError:r,parentIndent:s.indent,startOnNewline:!M||M.type==="block-scalar"});if(p=Q.end,Q.found){G&&((O==null?void 0:O.type)==="block-map"&&!Q.hasNewline&&r(p,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),t.options.strict&&$.start<Q.found.offset-1024&&r(Z.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const te=O?n(t,O,Q,r):e(t,p,F,null,Q,r);t.schema.compat&&qr(s.indent,O,r),p=te.range[2];const ee=new Ne(Z,te);t.options.keepSourceTokens&&(ee.srcToken=I),d.items.push(ee)}else{G&&r(Z.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),Q.comment&&(Z.comment?Z.comment+=`
`+Q.comment:Z.comment=Q.comment);const te=new Ne(Z);t.options.keepSourceTokens&&(te.srcToken=I),d.items.push(te)}}return y&&y<p&&r(y,"IMPOSSIBLE","Map comment with trailing content"),d.range=[s.offset,p,y??p],d}function td({composeNode:n,composeEmptyNode:e},t,s,r,a){const l=(a==null?void 0:a.nodeClass)??_t,d=new l(t.schema);t.atRoot&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let p=s.offset,y=null;for(const{start:B,value:I}of s.items){const P=vn(B,{indicator:"seq-item-ind",next:I,offset:p,onError:r,parentIndent:s.indent,startOnNewline:!0});if(!P.found)if(P.anchor||P.tag||I)I&&I.type==="block-seq"?r(P.end,"BAD_INDENT","All sequence items must start at the same column"):r(p,"MISSING_CHAR","Sequence item without - indicator");else{y=P.end,P.comment&&(d.comment=P.comment);continue}const M=I?n(t,I,P,r):e(t,P.end,B,null,P,r);t.schema.compat&&qr(s.indent,I,r),p=M.range[2],d.items.push(M)}return d.range=[s.offset,p,y??p],d}function ss(n,e,t,s){let r="";if(n){let a=!1,l="";for(const d of n){const{source:p,type:y}=d;switch(y){case"space":a=!0;break;case"comment":{t&&!a&&s(d,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const B=p.substring(1)||" ";r?r+=l+B:r=B,l="";break}case"newline":r&&(l+=p),a=!0;break;default:s(d,"UNEXPECTED_TOKEN",`Unexpected ${y} at node end`)}e+=p.length}}return{comment:r,offset:e}}const fr="Block collections are not allowed within flow collections",dr=n=>n&&(n.type==="block-map"||n.type==="block-seq");function nd({composeNode:n,composeEmptyNode:e},t,s,r,a){const l=s.start.source==="{",d=l?"flow map":"flow sequence",p=(a==null?void 0:a.nodeClass)??(l?Fe:_t),y=new p(t.schema);y.flow=!0;const B=t.atRoot;B&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let I=s.offset+s.start.source.length;for(let $=0;$<s.items.length;++$){const G=s.items[$],{start:W,key:Z,sep:Q,value:te}=G,ee=vn(W,{flow:d,indicator:"explicit-key-ind",next:Z??(Q==null?void 0:Q[0]),offset:I,onError:r,parentIndent:s.indent,startOnNewline:!1});if(!ee.found){if(!ee.anchor&&!ee.tag&&!Q&&!te){$===0&&ee.comma?r(ee.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${d}`):$<s.items.length-1&&r(ee.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${d}`),ee.comment&&(y.comment?y.comment+=`
`+ee.comment:y.comment=ee.comment),I=ee.end;continue}!l&&t.options.strict&&Xn(Z)&&r(Z,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if($===0)ee.comma&&r(ee.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${d}`);else if(ee.comma||r(ee.start,"MISSING_CHAR",`Missing , between ${d} items`),ee.comment){let ce="";e:for(const J of W)switch(J.type){case"comma":case"space":break;case"comment":ce=J.source.substring(1);break e;default:break e}if(ce){let J=y.items[y.items.length-1];be(J)&&(J=J.value??J.key),J.comment?J.comment+=`
`+ce:J.comment=ce,ee.comment=ee.comment.substring(ce.length+1)}}if(!l&&!Q&&!ee.found){const ce=te?n(t,te,ee,r):e(t,ee.end,Q,null,ee,r);y.items.push(ce),I=ce.range[2],dr(te)&&r(ce.range,"BLOCK_IN_FLOW",fr)}else{t.atKey=!0;const ce=ee.end,J=Z?n(t,Z,ee,r):e(t,ce,W,null,ee,r);dr(Z)&&r(J.range,"BLOCK_IN_FLOW",fr),t.atKey=!1;const Se=vn(Q??[],{flow:d,indicator:"map-value-ind",next:te,offset:J.range[2],onError:r,parentIndent:s.indent,startOnNewline:!1});if(Se.found){if(!l&&!ee.found&&t.options.strict){if(Q)for(const ye of Q){if(ye===Se.found)break;if(ye.type==="newline"){r(ye,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}ee.start<Se.found.offset-1024&&r(Se.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else te&&("source"in te&&te.source&&te.source[0]===":"?r(te,"MISSING_CHAR",`Missing space after : in ${d}`):r(Se.start,"MISSING_CHAR",`Missing , or : between ${d} items`));const He=te?n(t,te,Se,r):Se.found?e(t,Se.end,Q,null,Se,r):null;He?dr(te)&&r(He.range,"BLOCK_IN_FLOW",fr):Se.comment&&(J.comment?J.comment+=`
`+Se.comment:J.comment=Se.comment);const tt=new Ne(J,He);if(t.options.keepSourceTokens&&(tt.srcToken=G),l){const ye=y;Tc(t,ye.items,J)&&r(ce,"DUPLICATE_KEY","Map keys must be unique"),ye.items.push(tt)}else{const ye=new Fe(t.schema);ye.flow=!0,ye.items.push(tt);const Je=(He??J).range;ye.range=[J.range[0],Je[1],Je[2]],y.items.push(ye)}I=He?He.range[2]:Se.end}}const P=l?"}":"]",[M,...F]=s.end;let O=I;if(M&&M.source===P)O=M.offset+M.source.length;else{const $=d[0].toUpperCase()+d.substring(1),G=B?`${$} must end with a ${P}`:`${$} in block collection must be sufficiently indented and end with a ${P}`;r(I,B?"MISSING_CHAR":"BAD_INDENT",G),M&&M.source.length!==1&&F.unshift(M)}if(F.length>0){const $=ss(F,O,t.options.strict,r);$.comment&&(y.comment?y.comment+=`
`+$.comment:y.comment=$.comment),y.range=[s.offset,O,$.offset]}else y.range=[s.offset,O,O];return y}function hr(n,e,t,s,r,a){const l=t.type==="block-map"?ed(n,e,t,s,a):t.type==="block-seq"?td(n,e,t,s,a):nd(n,e,t,s,a),d=l.constructor;return r==="!"||r===d.tagName?(l.tag=d.tagName,l):(r&&(l.tag=r),l)}function sd(n,e,t,s,r){var P;const a=s.tag,l=a?e.directives.tagName(a.source,M=>r(a,"TAG_RESOLVE_FAILED",M)):null;if(t.type==="block-seq"){const{anchor:M,newlineAfterProp:F}=s,O=M&&a?M.offset>a.offset?M:a:M??a;O&&(!F||F.offset<O.offset)&&r(O,"MISSING_CHAR","Missing newline after block sequence props")}const d=t.type==="block-map"?"map":t.type==="block-seq"?"seq":t.start.source==="{"?"map":"seq";if(!a||!l||l==="!"||l===Fe.tagName&&d==="map"||l===_t.tagName&&d==="seq")return hr(n,e,t,r,l);let p=e.schema.tags.find(M=>M.tag===l&&M.collection===d);if(!p){const M=e.schema.knownTags[l];if(M&&M.collection===d)e.schema.tags.push(Object.assign({},M,{default:!1})),p=M;else return M?r(a,"BAD_COLLECTION_TYPE",`${M.tag} used for ${d} collection, but expects ${M.collection??"scalar"}`,!0):r(a,"TAG_RESOLVE_FAILED",`Unresolved tag: ${l}`,!0),hr(n,e,t,r,l)}const y=hr(n,e,t,r,l,p),B=((P=p.resolve)==null?void 0:P.call(p,y,M=>r(a,"TAG_RESOLVE_FAILED",M),e.options))??y,I=ke(B)?B:new se(B);return I.range=y.range,I.tag=l,p!=null&&p.format&&(I.format=p.format),I}function Lc(n,e,t){const s=e.offset,r=id(e,n.options.strict,t);if(!r)return{value:"",type:null,comment:"",range:[s,s,s]};const a=r.mode===">"?se.BLOCK_FOLDED:se.BLOCK_LITERAL,l=e.source?rd(e.source):[];let d=l.length;for(let O=l.length-1;O>=0;--O){const $=l[O][1];if($===""||$==="\r")d=O;else break}if(d===0){const O=r.chomp==="+"&&l.length>0?`
`.repeat(Math.max(1,l.length-1)):"";let $=s+r.length;return e.source&&($+=e.source.length),{value:O,type:a,comment:r.comment,range:[s,$,$]}}let p=e.indent+r.indent,y=e.offset+r.length,B=0;for(let O=0;O<d;++O){const[$,G]=l[O];if(G===""||G==="\r")r.indent===0&&$.length>p&&(p=$.length);else{$.length<p&&t(y+$.length,"MISSING_CHAR","Block scalars with more-indented leading empty lines must use an explicit indentation indicator"),r.indent===0&&(p=$.length),B=O,p===0&&!n.atRoot&&t(y,"BAD_INDENT","Block scalar values in collections must be indented");break}y+=$.length+G.length+1}for(let O=l.length-1;O>=d;--O)l[O][0].length>p&&(d=O+1);let I="",P="",M=!1;for(let O=0;O<B;++O)I+=l[O][0].slice(p)+`
`;for(let O=B;O<d;++O){let[$,G]=l[O];y+=$.length+G.length+1;const W=G[G.length-1]==="\r";if(W&&(G=G.slice(0,-1)),G&&$.length<p){const Q=`Block scalar lines must not be less indented than their ${r.indent?"explicit indentation indicator":"first line"}`;t(y-G.length-(W?2:1),"BAD_INDENT",Q),$=""}a===se.BLOCK_LITERAL?(I+=P+$.slice(p)+G,P=`
`):$.length>p||G[0]==="	"?(P===" "?P=`
`:!M&&P===`
`&&(P=`

`),I+=P+$.slice(p)+G,P=`
`,M=!0):G===""?P===`
`?I+=`
`:P=`
`:(I+=P+G,P=" ",M=!1)}switch(r.chomp){case"-":break;case"+":for(let O=d;O<l.length;++O)I+=`
`+l[O][0].slice(p);I[I.length-1]!==`
`&&(I+=`
`);break;default:I+=`
`}const F=s+r.length+e.source.length;return{value:I,type:a,comment:r.comment,range:[s,F,F]}}function id({offset:n,props:e},t,s){if(e[0].type!=="block-scalar-header")return s(e[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:r}=e[0],a=r[0];let l=0,d="",p=-1;for(let P=1;P<r.length;++P){const M=r[P];if(!d&&(M==="-"||M==="+"))d=M;else{const F=Number(M);!l&&F?l=F:p===-1&&(p=n+P)}}p!==-1&&s(p,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${r}`);let y=!1,B="",I=r.length;for(let P=1;P<e.length;++P){const M=e[P];switch(M.type){case"space":y=!0;case"newline":I+=M.source.length;break;case"comment":t&&!y&&s(M,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),I+=M.source.length,B=M.source.substring(1);break;case"error":s(M,"UNEXPECTED_TOKEN",M.message),I+=M.source.length;break;default:{const F=`Unexpected token in block scalar header: ${M.type}`;s(M,"UNEXPECTED_TOKEN",F);const O=M.source;O&&typeof O=="string"&&(I+=O.length)}}}return{mode:a,indent:l,chomp:d,comment:B,length:I}}function rd(n){const e=n.split(/\n( *)/),t=e[0],s=t.match(/^( *)/),a=[s!=null&&s[1]?[s[1],t.slice(s[1].length)]:["",t]];for(let l=1;l<e.length;l+=2)a.push([e[l],e[l+1]]);return a}function Oc(n,e,t){const{offset:s,type:r,source:a,end:l}=n;let d,p;const y=(P,M,F)=>t(s+P,M,F);switch(r){case"scalar":d=se.PLAIN,p=od(a,y);break;case"single-quoted-scalar":d=se.QUOTE_SINGLE,p=ad(a,y);break;case"double-quoted-scalar":d=se.QUOTE_DOUBLE,p=cd(a,y);break;default:return t(n,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${r}`),{value:"",type:null,comment:"",range:[s,s+a.length,s+a.length]}}const B=s+a.length,I=ss(l,B,e,t);return{value:p,type:d,comment:I.comment,range:[s,B,I.offset]}}function od(n,e){let t="";switch(n[0]){case"	":t="a tab character";break;case",":t="flow indicator character ,";break;case"%":t="directive indicator character %";break;case"|":case">":{t=`block scalar indicator ${n[0]}`;break}case"@":case"`":{t=`reserved character ${n[0]}`;break}}return t&&e(0,"BAD_SCALAR_START",`Plain value cannot start with ${t}`),Cc(n)}function ad(n,e){return(n[n.length-1]!=="'"||n.length===1)&&e(n.length,"MISSING_CHAR","Missing closing 'quote"),Cc(n.slice(1,-1)).replace(/''/g,"'")}function Cc(n){let e,t;try{e=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),t=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{e=/(.*?)[ \t]*\r?\n/sy,t=/[ \t]*(.*?)[ \t]*\r?\n/sy}let s=e.exec(n);if(!s)return n;let r=s[1],a=" ",l=e.lastIndex;for(t.lastIndex=l;s=t.exec(n);)s[1]===""?a===`
`?r+=a:a=`
`:(r+=a+s[1],a=" "),l=t.lastIndex;const d=/[ \t]*(.*)/sy;return d.lastIndex=l,s=d.exec(n),r+a+((s==null?void 0:s[1])??"")}function cd(n,e){let t="";for(let s=1;s<n.length-1;++s){const r=n[s];if(!(r==="\r"&&n[s+1]===`
`))if(r===`
`){const{fold:a,offset:l}=ld(n,s);t+=a,s=l}else if(r==="\\"){let a=n[++s];const l=ud[a];if(l)t+=l;else if(a===`
`)for(a=n[s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="\r"&&n[s+1]===`
`)for(a=n[++s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="x"||a==="u"||a==="U"){const d={x:2,u:4,U:8}[a];t+=fd(n,s+1,d,e),s+=d}else{const d=n.substr(s-1,2);e(s-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${d}`),t+=d}}else if(r===" "||r==="	"){const a=s;let l=n[s+1];for(;l===" "||l==="	";)l=n[++s+1];l!==`
`&&!(l==="\r"&&n[s+2]===`
`)&&(t+=s>a?n.slice(a,s+1):r)}else t+=r}return(n[n.length-1]!=='"'||n.length===1)&&e(n.length,"MISSING_CHAR",'Missing closing "quote'),t}function ld(n,e){let t="",s=n[e+1];for(;(s===" "||s==="	"||s===`
`||s==="\r")&&!(s==="\r"&&n[e+2]!==`
`);)s===`
`&&(t+=`
`),e+=1,s=n[e+1];return t||(t=" "),{fold:t,offset:e}}const ud={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function fd(n,e,t,s){const r=n.substr(e,t),l=r.length===t&&/^[0-9a-fA-F]+$/.test(r)?parseInt(r,16):NaN;if(isNaN(l)){const d=n.substr(e-2,t+2);return s(e-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${d}`),d}return String.fromCodePoint(l)}function Nc(n,e,t,s){const{value:r,type:a,comment:l,range:d}=e.type==="block-scalar"?Lc(n,e,s):Oc(e,n.options.strict,s),p=t?n.directives.tagName(t.source,I=>s(t,"TAG_RESOLVE_FAILED",I)):null;let y;n.options.stringKeys&&n.atKey?y=n.schema[et]:p?y=dd(n.schema,r,p,t,s):e.type==="scalar"?y=hd(n,r,e,s):y=n.schema[et];let B;try{const I=y.resolve(r,P=>s(t??e,"TAG_RESOLVE_FAILED",P),n.options);B=me(I)?I:new se(I)}catch(I){const P=I instanceof Error?I.message:String(I);s(t??e,"TAG_RESOLVE_FAILED",P),B=new se(r)}return B.range=d,B.source=r,a&&(B.type=a),p&&(B.tag=p),y.format&&(B.format=y.format),l&&(B.comment=l),B}function dd(n,e,t,s,r){var d;if(t==="!")return n[et];const a=[];for(const p of n.tags)if(!p.collection&&p.tag===t)if(p.default&&p.test)a.push(p);else return p;for(const p of a)if((d=p.test)!=null&&d.test(e))return p;const l=n.knownTags[t];return l&&!l.collection?(n.tags.push(Object.assign({},l,{default:!1,test:void 0})),l):(r(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${t}`,t!=="tag:yaml.org,2002:str"),n[et])}function hd({atKey:n,directives:e,schema:t},s,r,a){const l=t.tags.find(d=>{var p;return(d.default===!0||n&&d.default==="key")&&((p=d.test)==null?void 0:p.test(s))})||t[et];if(t.compat){const d=t.compat.find(p=>{var y;return p.default&&((y=p.test)==null?void 0:y.test(s))})??t[et];if(l.tag!==d.tag){const p=e.tagString(l.tag),y=e.tagString(d.tag),B=`Value may be parsed as either ${p} or ${y}`;a(r,"TAG_RESOLVE_FAILED",B,!0)}}return l}function pd(n,e,t){if(e){t??(t=e.length);for(let s=t-1;s>=0;--s){let r=e[s];switch(r.type){case"space":case"comment":case"newline":n-=r.source.length;continue}for(r=e[++s];(r==null?void 0:r.type)==="space";)n+=r.source.length,r=e[++s];break}}return n}const md={composeNode:Bc,composeEmptyNode:ro};function Bc(n,e,t,s){const r=n.atKey,{spaceBefore:a,comment:l,anchor:d,tag:p}=t;let y,B=!0;switch(e.type){case"alias":y=yd(n,e,s),(d||p)&&s(e,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":y=Nc(n,e,p,s),d&&(y.anchor=d.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":y=sd(md,n,e,t,s),d&&(y.anchor=d.source.substring(1));break;default:{const I=e.type==="error"?e.message:`Unsupported token (type: ${e.type})`;s(e,"UNEXPECTED_TOKEN",I),y=ro(n,e.offset,void 0,null,t,s),B=!1}}return d&&y.anchor===""&&s(d,"BAD_ALIAS","Anchor cannot be an empty string"),r&&n.options.stringKeys&&(!me(y)||typeof y.value!="string"||y.tag&&y.tag!=="tag:yaml.org,2002:str")&&s(p??e,"NON_STRING_KEY","With stringKeys, all keys must be strings"),a&&(y.spaceBefore=!0),l&&(e.type==="scalar"&&e.source===""?y.comment=l:y.commentBefore=l),n.options.keepSourceTokens&&B&&(y.srcToken=e),y}function ro(n,e,t,s,{spaceBefore:r,comment:a,anchor:l,tag:d,end:p},y){const B={type:"scalar",offset:pd(e,t,s),indent:-1,source:""},I=Nc(n,B,d,y);return l&&(I.anchor=l.source.substring(1),I.anchor===""&&y(l,"BAD_ALIAS","Anchor cannot be an empty string")),r&&(I.spaceBefore=!0),a&&(I.comment=a,I.range[2]=p),I}function yd({options:n},{offset:e,source:t,end:s},r){const a=new ri(t.substring(1));a.source===""&&r(e,"BAD_ALIAS","Alias cannot be an empty string"),a.source.endsWith(":")&&r(e+t.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const l=e+t.length,d=ss(s,l,n.strict,r);return a.range=[e,l,d.offset],d.comment&&(a.comment=d.comment),a}function gd(n,e,{offset:t,start:s,value:r,end:a},l){const d=Object.assign({_directives:e},n),p=new En(void 0,d),y={atKey:!1,atRoot:!0,directives:p.directives,options:p.options,schema:p.schema},B=vn(s,{indicator:"doc-start",next:r??(a==null?void 0:a[0]),offset:t,onError:l,parentIndent:0,startOnNewline:!0});B.found&&(p.directives.docStart=!0,r&&(r.type==="block-map"||r.type==="block-seq")&&!B.hasNewline&&l(B.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),p.contents=r?Bc(y,r,B,l):ro(y,B.end,s,null,B,l);const I=p.contents.range[2],P=ss(a,I,!1,l);return P.comment&&(p.comment=P.comment),p.range=[t,I,P.offset],p}function Fn(n){if(typeof n=="number")return[n,n+1];if(Array.isArray(n))return n.length===2?n:[n[0],n[1]];const{offset:e,source:t}=n;return[e,e+(typeof t=="string"?t.length:1)]}function fa(n){var r;let e="",t=!1,s=!1;for(let a=0;a<n.length;++a){const l=n[a];switch(l[0]){case"#":e+=(e===""?"":s?`

`:`
`)+(l.substring(1)||" "),t=!0,s=!1;break;case"%":((r=n[a+1])==null?void 0:r[0])!=="#"&&(a+=1),t=!1;break;default:t||(s=!0),t=!1}}return{comment:e,afterEmptyLine:s}}class oo{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(t,s,r,a)=>{const l=Fn(t);a?this.warnings.push(new Ac(l,s,r)):this.errors.push(new Ft(l,s,r))},this.directives=new Pe({version:e.version||"1.2"}),this.options=e}decorate(e,t){const{comment:s,afterEmptyLine:r}=fa(this.prelude);if(s){const a=e.contents;if(t)e.comment=e.comment?`${e.comment}
${s}`:s;else if(r||e.directives.docStart||!a)e.commentBefore=s;else if(we(a)&&!a.flow&&a.items.length>0){let l=a.items[0];be(l)&&(l=l.key);const d=l.commentBefore;l.commentBefore=d?`${s}
${d}`:s}else{const l=a.commentBefore;a.commentBefore=l?`${s}
${l}`:s}}t?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:fa(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,t=!1,s=-1){for(const r of e)yield*this.next(r);yield*this.end(t,s)}*next(e){switch(e.type){case"directive":this.directives.add(e.source,(t,s,r)=>{const a=Fn(e);a[0]+=t,this.onError(a,"BAD_DIRECTIVE",s,r)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{const t=gd(this.options,this.directives,e,this.onError);this.atDirectives&&!t.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(t,!1),this.doc&&(yield this.doc),this.doc=t,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{const t=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,s=new Ft(Fn(e),"UNEXPECTED_TOKEN",t);this.atDirectives||!this.doc?this.errors.push(s):this.doc.errors.push(s);break}case"doc-end":{if(!this.doc){const s="Unexpected doc-end without preceding document";this.errors.push(new Ft(Fn(e),"UNEXPECTED_TOKEN",s));break}this.doc.directives.docEnd=!0;const t=ss(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),t.comment){const s=this.doc.comment;this.doc.comment=s?`${s}
${t.comment}`:t.comment}this.doc.range[2]=t.offset;break}default:this.errors.push(new Ft(Fn(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,t=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){const s=Object.assign({_directives:this.directives},this.options),r=new En(void 0,s);this.atDirectives&&this.onError(t,"MISSING_CHAR","Missing directives-end indicator line"),r.range=[0,t,t],this.decorate(r,!1),yield r}}}function vd(n,e=!0,t){if(n){const s=(r,a,l)=>{const d=typeof r=="number"?r:Array.isArray(r)?r[0]:r.offset;if(t)t(d,a,l);else throw new Ft([d,d+1],a,l)};switch(n.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return Oc(n,e,s);case"block-scalar":return Lc({options:{strict:e}},n,s)}}return null}function bd(n,e){const{implicitKey:t=!1,indent:s,inFlow:r=!1,offset:a=-1,type:l="PLAIN"}=e,d=ts({type:l,value:n},{implicitKey:t,indent:s>0?" ".repeat(s):"",inFlow:r,options:{blockQuote:!0,lineWidth:-1}}),p=e.end??[{type:"newline",offset:-1,indent:s,source:`
`}];switch(d[0]){case"|":case">":{const y=d.indexOf(`
`),B=d.substring(0,y),I=d.substring(y+1)+`
`,P=[{type:"block-scalar-header",offset:a,indent:s,source:B}];return Pc(P,p)||P.push({type:"newline",offset:-1,indent:s,source:`
`}),{type:"block-scalar",offset:a,indent:s,props:P,source:I}}case'"':return{type:"double-quoted-scalar",offset:a,indent:s,source:d,end:p};case"'":return{type:"single-quoted-scalar",offset:a,indent:s,source:d,end:p};default:return{type:"scalar",offset:a,indent:s,source:d,end:p}}}function wd(n,e,t={}){let{afterKey:s=!1,implicitKey:r=!1,inFlow:a=!1,type:l}=t,d="indent"in n?n.indent:null;if(s&&typeof d=="number"&&(d+=2),!l)switch(n.type){case"single-quoted-scalar":l="QUOTE_SINGLE";break;case"double-quoted-scalar":l="QUOTE_DOUBLE";break;case"block-scalar":{const y=n.props[0];if(y.type!=="block-scalar-header")throw new Error("Invalid block scalar header");l=y.source[0]===">"?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:l="PLAIN"}const p=ts({type:l,value:e},{implicitKey:r||d===null,indent:d!==null&&d>0?" ".repeat(d):"",inFlow:a,options:{blockQuote:!0,lineWidth:-1}});switch(p[0]){case"|":case">":kd(n,p);break;case'"':pr(n,p,"double-quoted-scalar");break;case"'":pr(n,p,"single-quoted-scalar");break;default:pr(n,p,"scalar")}}function kd(n,e){const t=e.indexOf(`
`),s=e.substring(0,t),r=e.substring(t+1)+`
`;if(n.type==="block-scalar"){const a=n.props[0];if(a.type!=="block-scalar-header")throw new Error("Invalid block scalar header");a.source=s,n.source=r}else{const{offset:a}=n,l="indent"in n?n.indent:-1,d=[{type:"block-scalar-header",offset:a,indent:l,source:s}];Pc(d,"end"in n?n.end:void 0)||d.push({type:"newline",offset:-1,indent:l,source:`
`});for(const p of Object.keys(n))p!=="type"&&p!=="offset"&&delete n[p];Object.assign(n,{type:"block-scalar",indent:l,props:d,source:r})}}function Pc(n,e){if(e)for(const t of e)switch(t.type){case"space":case"comment":n.push(t);break;case"newline":return n.push(t),!0}return!1}function pr(n,e,t){switch(n.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":n.type=t,n.source=e;break;case"block-scalar":{const s=n.props.slice(1);let r=e.length;n.props[0].type==="block-scalar-header"&&(r-=n.props[0].source.length);for(const a of s)a.offset+=r;delete n.props,Object.assign(n,{type:t,source:e,end:s});break}case"block-map":case"block-seq":{const r={type:"newline",offset:n.offset+e.length,indent:n.indent,source:`
`};delete n.items,Object.assign(n,{type:t,source:e,end:[r]});break}default:{const s="indent"in n?n.indent:-1,r="end"in n&&Array.isArray(n.end)?n.end.filter(a=>a.type==="space"||a.type==="comment"||a.type==="newline"):[];for(const a of Object.keys(n))a!=="type"&&a!=="offset"&&delete n[a];Object.assign(n,{type:t,indent:s,source:e,end:r})}}}const Sd=n=>"type"in n?si(n):Ws(n);function si(n){switch(n.type){case"block-scalar":{let e="";for(const t of n.props)e+=si(t);return e+n.source}case"block-map":case"block-seq":{let e="";for(const t of n.items)e+=Ws(t);return e}case"flow-collection":{let e=n.start.source;for(const t of n.items)e+=Ws(t);for(const t of n.end)e+=t.source;return e}case"document":{let e=Ws(n);if(n.end)for(const t of n.end)e+=t.source;return e}default:{let e=n.source;if("end"in n&&n.end)for(const t of n.end)e+=t.source;return e}}}function Ws({start:n,key:e,sep:t,value:s}){let r="";for(const a of n)r+=a.source;if(e&&(r+=si(e)),t)for(const a of t)r+=a.source;return s&&(r+=si(s)),r}const Fr=Symbol("break visit"),_d=Symbol("skip children"),Mc=Symbol("remove item");function Ut(n,e){"type"in n&&n.type==="document"&&(n={start:n.start,value:n.value}),$c(Object.freeze([]),n,e)}Ut.BREAK=Fr;Ut.SKIP=_d;Ut.REMOVE=Mc;Ut.itemAtPath=(n,e)=>{let t=n;for(const[s,r]of e){const a=t==null?void 0:t[s];if(a&&"items"in a)t=a.items[r];else return}return t};Ut.parentCollection=(n,e)=>{const t=Ut.itemAtPath(n,e.slice(0,-1)),s=e[e.length-1][0],r=t==null?void 0:t[s];if(r&&"items"in r)return r;throw new Error("Parent collection not found")};function $c(n,e,t){let s=t(e,n);if(typeof s=="symbol")return s;for(const r of["key","value"]){const a=e[r];if(a&&"items"in a){for(let l=0;l<a.items.length;++l){const d=$c(Object.freeze(n.concat([[r,l]])),a.items[l],t);if(typeof d=="number")l=d-1;else{if(d===Fr)return Fr;d===Mc&&(a.items.splice(l,1),l-=1)}}typeof s=="function"&&r==="key"&&(s=s(e,n))}}return typeof s=="function"?s(e,n):s}const mi="\uFEFF",yi="",gi="",Zn="",Ed=n=>!!n&&"items"in n,Id=n=>!!n&&(n.type==="scalar"||n.type==="single-quoted-scalar"||n.type==="double-quoted-scalar"||n.type==="block-scalar");function Ad(n){switch(n){case mi:return"<BOM>";case yi:return"<DOC>";case gi:return"<FLOW_END>";case Zn:return"<SCALAR>";default:return JSON.stringify(n)}}function Dc(n){switch(n){case mi:return"byte-order-mark";case yi:return"doc-mode";case gi:return"flow-error-end";case Zn:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(n[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}const Td=Object.freeze(Object.defineProperty({__proto__:null,BOM:mi,DOCUMENT:yi,FLOW_END:gi,SCALAR:Zn,createScalarToken:bd,isCollection:Ed,isScalar:Id,prettyToken:Ad,resolveAsScalar:vd,setScalarValue:wd,stringify:Sd,tokenType:Dc,visit:Ut},Symbol.toStringTag,{value:"Module"}));function ze(n){switch(n){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}const da=new Set("0123456789ABCDEFabcdef"),Ld=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),xs=new Set(",[]{}"),Od=new Set(` ,[]{}
\r	`),mr=n=>!n||Od.has(n);class xc{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,t=!1){if(e){if(typeof e!="string")throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null}this.atEnd=!t;let s=this.next??"stream";for(;s&&(t||this.hasChars(1));)s=yield*this.parseNext(s)}atLineEnd(){let e=this.pos,t=this.buffer[e];for(;t===" "||t==="	";)t=this.buffer[++e];return!t||t==="#"||t===`
`?!0:t==="\r"?this.buffer[e+1]===`
`:!1}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let t=this.buffer[e];if(this.indentNext>0){let s=0;for(;t===" ";)t=this.buffer[++s+e];if(t==="\r"){const r=this.buffer[s+e+1];if(r===`
`||!r&&!this.atEnd)return e+s+1}return t===`
`||s>=this.indentNext||!t&&!this.atEnd?e+s:-1}if(t==="-"||t==="."){const s=this.buffer.substr(e,3);if((s==="---"||s==="...")&&ze(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return(typeof e!="number"||e!==-1&&e<this.pos)&&(e=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=e),e===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[e-1]==="\r"&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(e===null)return this.setNext("stream");if(e[0]===mi&&(yield*this.pushCount(1),e=e.substring(1)),e[0]==="%"){let t=e.length,s=e.indexOf("#");for(;s!==-1;){const a=e[s-1];if(a===" "||a==="	"){t=s-1;break}else s=e.indexOf("#",s+1)}for(;;){const a=e[t-1];if(a===" "||a==="	")t-=1;else break}const r=(yield*this.pushCount(t))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-r),this.pushNewline(),"stream"}if(this.atLineEnd()){const t=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-t),yield*this.pushNewline(),"stream"}return yield yi,yield*this.parseLineStart()}*parseLineStart(){const e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if(e==="-"||e==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const t=this.peek(3);if((t==="---"||t==="...")&&ze(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,t==="---"?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!ze(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[e,t]=this.peek(2);if(!t&&!this.atEnd)return this.setNext("block-start");if((e==="-"||e==="?"||e===":")&&ze(t)){const s=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=s,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const e=this.getLine();if(e===null)return this.setNext("doc");let t=yield*this.pushIndicators();switch(e[t]){case"#":yield*this.pushCount(e.length-t);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(mr),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return t+=yield*this.parseBlockScalarHeader(),t+=yield*this.pushSpaces(!0),yield*this.pushCount(e.length-t),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,t,s=-1;do e=yield*this.pushNewline(),e>0?(t=yield*this.pushSpaces(!1),this.indentValue=s=t):t=0,t+=yield*this.pushSpaces(!0);while(e+t>0);const r=this.getLine();if(r===null)return this.setNext("flow");if((s!==-1&&s<this.indentNext&&r[0]!=="#"||s===0&&(r.startsWith("---")||r.startsWith("..."))&&ze(r[3]))&&!(s===this.indentNext-1&&this.flowLevel===1&&(r[0]==="]"||r[0]==="}")))return this.flowLevel=0,yield gi,yield*this.parseLineStart();let a=0;for(;r[a]===",";)a+=yield*this.pushCount(1),a+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(a+=yield*this.pushIndicators(),r[a]){case void 0:return"flow";case"#":return yield*this.pushCount(r.length-a),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(mr),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const l=this.charAt(1);if(this.flowKey||ze(l)||l===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const e=this.charAt(0);let t=this.buffer.indexOf(e,this.pos+1);if(e==="'")for(;t!==-1&&this.buffer[t+1]==="'";)t=this.buffer.indexOf("'",t+2);else for(;t!==-1;){let a=0;for(;this.buffer[t-1-a]==="\\";)a+=1;if(a%2===0)break;t=this.buffer.indexOf('"',t+1)}const s=this.buffer.substring(0,t);let r=s.indexOf(`
`,this.pos);if(r!==-1){for(;r!==-1;){const a=this.continueScalar(r+1);if(a===-1)break;r=s.indexOf(`
`,a)}r!==-1&&(t=r-(s[r-1]==="\r"?2:1))}if(t===-1){if(!this.atEnd)return this.setNext("quoted-scalar");t=this.buffer.length}return yield*this.pushToIndex(t+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){const t=this.buffer[++e];if(t==="+")this.blockScalarKeep=!0;else if(t>"0"&&t<="9")this.blockScalarIndent=Number(t)-1;else if(t!=="-")break}return yield*this.pushUntil(t=>ze(t)||t==="#")}*parseBlockScalar(){let e=this.pos-1,t=0,s;e:for(let a=this.pos;s=this.buffer[a];++a)switch(s){case" ":t+=1;break;case`
`:e=a,t=0;break;case"\r":{const l=this.buffer[a+1];if(!l&&!this.atEnd)return this.setNext("block-scalar");if(l===`
`)break}default:break e}if(!s&&!this.atEnd)return this.setNext("block-scalar");if(t>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=t:this.indentNext=this.blockScalarIndent+(this.indentNext===0?1:this.indentNext);do{const a=this.continueScalar(e+1);if(a===-1)break;e=this.buffer.indexOf(`
`,a)}while(e!==-1);if(e===-1){if(!this.atEnd)return this.setNext("block-scalar");e=this.buffer.length}}let r=e+1;for(s=this.buffer[r];s===" ";)s=this.buffer[++r];if(s==="	"){for(;s==="	"||s===" "||s==="\r"||s===`
`;)s=this.buffer[++r];e=r-1}else if(!this.blockScalarKeep)do{let a=e-1,l=this.buffer[a];l==="\r"&&(l=this.buffer[--a]);const d=a;for(;l===" ";)l=this.buffer[--a];if(l===`
`&&a>=this.pos&&a+1+t>d)e=a;else break}while(!0);return yield Zn,yield*this.pushToIndex(e+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const e=this.flowLevel>0;let t=this.pos-1,s=this.pos-1,r;for(;r=this.buffer[++s];)if(r===":"){const a=this.buffer[s+1];if(ze(a)||e&&xs.has(a))break;t=s}else if(ze(r)){let a=this.buffer[s+1];if(r==="\r"&&(a===`
`?(s+=1,r=`
`,a=this.buffer[s+1]):t=s),a==="#"||e&&xs.has(a))break;if(r===`
`){const l=this.continueScalar(s+1);if(l===-1)break;s=Math.max(s,l-2)}}else{if(e&&xs.has(r))break;t=s}return!r&&!this.atEnd?this.setNext("plain-scalar"):(yield Zn,yield*this.pushToIndex(t+1,!0),e?"flow":"doc")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,t){const s=this.buffer.slice(this.pos,e);return s?(yield s,this.pos+=s.length,s.length):(t&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(mr))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const e=this.flowLevel>0,t=this.charAt(1);if(ze(t)||e&&xs.has(t))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let e=this.pos+2,t=this.buffer[e];for(;!ze(t)&&t!==">";)t=this.buffer[++e];return yield*this.pushToIndex(t===">"?e+1:e,!1)}else{let e=this.pos+1,t=this.buffer[e];for(;t;)if(Ld.has(t))t=this.buffer[++e];else if(t==="%"&&da.has(this.buffer[e+1])&&da.has(this.buffer[e+2]))t=this.buffer[e+=3];else break;return yield*this.pushToIndex(e,!1)}}*pushNewline(){const e=this.buffer[this.pos];return e===`
`?yield*this.pushCount(1):e==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(e){let t=this.pos-1,s;do s=this.buffer[++t];while(s===" "||e&&s==="	");const r=t-this.pos;return r>0&&(yield this.buffer.substr(this.pos,r),this.pos=t),r}*pushUntil(e){let t=this.pos,s=this.buffer[t];for(;!e(s);)s=this.buffer[++t];return yield*this.pushToIndex(t,!1)}}class Kc{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let t=0,s=this.lineStarts.length;for(;t<s;){const a=t+s>>1;this.lineStarts[a]<e?t=a+1:s=a}if(this.lineStarts[t]===e)return{line:t+1,col:1};if(t===0)return{line:0,col:e};const r=this.lineStarts[t-1];return{line:t,col:e-r+1}}}}function gt(n,e){for(let t=0;t<n.length;++t)if(n[t].type===e)return!0;return!1}function ha(n){for(let e=0;e<n.length;++e)switch(n[e].type){case"space":case"comment":case"newline":break;default:return e}return-1}function jc(n){switch(n==null?void 0:n.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function Ks(n){switch(n.type){case"document":return n.start;case"block-map":{const e=n.items[n.items.length-1];return e.sep??e.start}case"block-seq":return n.items[n.items.length-1].start;default:return[]}}function an(n){var t;if(n.length===0)return[];let e=n.length;e:for(;--e>=0;)switch(n[e].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;((t=n[++e])==null?void 0:t.type)==="space";);return n.splice(e,n.length)}function pa(n){if(n.start.type==="flow-seq-start")for(const e of n.items)e.sep&&!e.value&&!gt(e.start,"explicit-key-ind")&&!gt(e.sep,"map-value-ind")&&(e.key&&(e.value=e.key),delete e.key,jc(e.value)?e.value.end?Array.prototype.push.apply(e.value.end,e.sep):e.value.end=e.sep:Array.prototype.push.apply(e.start,e.sep),delete e.sep)}class ao{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new xc,this.onNewLine=e}*parse(e,t=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(const s of this.lexer.lex(e,t))yield*this.next(s);t||(yield*this.end())}*next(e){if(this.source=e,this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=e.length;return}const t=Dc(e);if(t)if(t==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=t,yield*this.step(),t){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&e[0]===" "&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{const s=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:s,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const e=this.peek(1);if(this.type==="doc-end"&&(!e||e.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}peek(e){return this.stack[this.stack.length-e]}*pop(e){const t=e??this.stack.pop();if(!t)yield{type:"error",offset:this.offset,source:"",message:"Tried to pop an empty stack"};else if(this.stack.length===0)yield t;else{const s=this.peek(1);switch(t.type==="block-scalar"?t.indent="indent"in s?s.indent:0:t.type==="flow-collection"&&s.type==="document"&&(t.indent=0),t.type==="flow-collection"&&pa(t),s.type){case"document":s.value=t;break;case"block-scalar":s.props.push(t);break;case"block-map":{const r=s.items[s.items.length-1];if(r.value){s.items.push({start:[],key:t,sep:[]}),this.onKeyLine=!0;return}else if(r.sep)r.value=t;else{Object.assign(r,{key:t,sep:[]}),this.onKeyLine=!r.explicitKey;return}break}case"block-seq":{const r=s.items[s.items.length-1];r.value?s.items.push({start:[],value:t}):r.value=t;break}case"flow-collection":{const r=s.items[s.items.length-1];!r||r.value?s.items.push({start:[],key:t,sep:[]}):r.sep?r.value=t:Object.assign(r,{key:t,sep:[]});return}default:yield*this.pop(),yield*this.pop(t)}if((s.type==="document"||s.type==="block-map"||s.type==="block-seq")&&(t.type==="block-map"||t.type==="block-seq")){const r=t.items[t.items.length-1];r&&!r.sep&&!r.value&&r.start.length>0&&ha(r.start)===-1&&(t.indent===0||r.start.every(a=>a.type!=="comment"||a.indent<t.indent))&&(s.type==="document"?s.end=r.start:s.items.push({start:r.start}),t.items.splice(-1,1))}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{const e={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&e.start.push(this.sourceToken),this.stack.push(e);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":{ha(e.start)!==-1?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":e.start.push(this.sourceToken);return}const t=this.startBlockValue(e);t?this.stack.push(t):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if(this.type==="map-value-ind"){const t=Ks(this.peek(2)),s=an(t);let r;e.end?(r=e.end,r.push(this.sourceToken),delete e.end):r=[this.sourceToken];const a={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:s,key:e,sep:r}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=a}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":e.props.push(this.sourceToken);return;case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,t.value){const r="end"in t.value?t.value.end:void 0,a=Array.isArray(r)?r[r.length-1]:void 0;(a==null?void 0:a.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else if(t.sep)t.sep.push(this.sourceToken);else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],a=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return}if(this.indent>=e.indent){const r=!this.onKeyLine&&this.indent===e.indent,a=r&&(t.sep||t.explicitKey)&&this.type!=="seq-item-ind";let l=[];if(a&&t.sep&&!t.value){const d=[];for(let p=0;p<t.sep.length;++p){const y=t.sep[p];switch(y.type){case"newline":d.push(p);break;case"space":break;case"comment":y.indent>e.indent&&(d.length=0);break;default:d.length=0}}d.length>=2&&(l=t.sep.splice(d[1]))}switch(this.type){case"anchor":case"tag":a||t.value?(l.push(this.sourceToken),e.items.push({start:l}),this.onKeyLine=!0):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"explicit-key-ind":!t.sep&&!t.explicitKey?(t.start.push(this.sourceToken),t.explicitKey=!0):a||t.value?(l.push(this.sourceToken),e.items.push({start:l,explicitKey:!0})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken],explicitKey:!0}]}),this.onKeyLine=!0;return;case"map-value-ind":if(t.explicitKey)if(t.sep)if(t.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(gt(t.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:l,key:null,sep:[this.sourceToken]}]});else if(jc(t.key)&&!gt(t.sep,"newline")){const d=an(t.start),p=t.key,y=t.sep;y.push(this.sourceToken),delete t.key,delete t.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:d,key:p,sep:y}]})}else l.length>0?t.sep=t.sep.concat(l,this.sourceToken):t.sep.push(this.sourceToken);else if(gt(t.start,"newline"))Object.assign(t,{key:null,sep:[this.sourceToken]});else{const d=an(t.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:d,key:null,sep:[this.sourceToken]}]})}else t.sep?t.value||a?e.items.push({start:l,key:null,sep:[this.sourceToken]}):gt(t.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const d=this.flowScalar(this.type);a||t.value?(e.items.push({start:l,key:d,sep:[]}),this.onKeyLine=!0):t.sep?this.stack.push(d):(Object.assign(t,{key:d,sep:[]}),this.onKeyLine=!0);return}default:{const d=this.startBlockValue(e);if(d){if(d.type==="block-seq"){if(!t.explicitKey&&t.sep&&!gt(t.sep,"newline")){yield*this.pop({type:"error",offset:this.offset,message:"Unexpected block-seq-ind on same line with key",source:this.source});return}}else r&&e.items.push({start:l});this.stack.push(d);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(t.value){const r="end"in t.value?t.value.end:void 0,a=Array.isArray(r)?r[r.length-1]:void 0;(a==null?void 0:a.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],a=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return;case"anchor":case"tag":if(t.value||this.indent<=e.indent)break;t.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==e.indent)break;t.value||gt(t.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return}if(this.indent>e.indent){const r=this.startBlockValue(e);if(r){this.stack.push(r);return}}yield*this.pop(),yield*this.step()}*flowCollection(e){const t=e.items[e.items.length-1];if(this.type==="flow-error-end"){let s;do yield*this.pop(),s=this.peek(1);while(s&&s.type==="flow-collection")}else if(e.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!t||t.sep?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return;case"map-value-ind":!t||t.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!t||t.value?e.items.push({start:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const r=this.flowScalar(this.type);!t||t.value?e.items.push({start:[],key:r,sep:[]}):t.sep?this.stack.push(r):Object.assign(t,{key:r,sep:[]});return}case"flow-map-end":case"flow-seq-end":e.end.push(this.sourceToken);return}const s=this.startBlockValue(e);s?this.stack.push(s):(yield*this.pop(),yield*this.step())}else{const s=this.peek(2);if(s.type==="block-map"&&(this.type==="map-value-ind"&&s.indent===e.indent||this.type==="newline"&&!s.items[s.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&s.type!=="flow-collection"){const r=Ks(s),a=an(r);pa(e);const l=e.end.splice(1,e.end.length);l.push(this.sourceToken);const d={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:a,key:e,sep:l}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=d}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const t=Ks(e),s=an(t);return s.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,explicitKey:!0}]}}case"map-value-ind":{this.onKeyLine=!0;const t=Ks(e),s=an(t);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,t){return this.type!=="comment"||this.indent<=t?!1:e.every(s=>s.type==="newline"||s.type==="space")}*documentEnd(e){this.type!=="doc-mode"&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;case"space":case"comment":default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}}function qc(n){const e=n.prettyErrors!==!1;return{lineCounter:n.lineCounter||e&&new Kc||null,prettyErrors:e}}function Cd(n,e={}){const{lineCounter:t,prettyErrors:s}=qc(e),r=new ao(t==null?void 0:t.addNewLine),a=new oo(e),l=Array.from(a.compose(r.parse(n)));if(s&&t)for(const d of l)d.errors.forEach(ni(n,t)),d.warnings.forEach(ni(n,t));return l.length>0?l:Object.assign([],{empty:!0},a.streamInfo())}function Fc(n,e={}){const{lineCounter:t,prettyErrors:s}=qc(e),r=new ao(t==null?void 0:t.addNewLine),a=new oo(e);let l=null;for(const d of a.compose(r.parse(n),!0,n.length))if(!l)l=d;else if(l.options.logLevel!=="silent"){l.errors.push(new Ft(d.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return s&&t&&(l.errors.forEach(ni(n,t)),l.warnings.forEach(ni(n,t))),l}function Nd(n,e,t){let s;typeof e=="function"?s=e:t===void 0&&e&&typeof e=="object"&&(t=e);const r=Fc(n,t);if(!r)return null;if(r.warnings.forEach(a=>ac(r.options.logLevel,a)),r.errors.length>0){if(r.options.logLevel!=="silent")throw r.errors[0];r.errors=[]}return r.toJS(Object.assign({reviver:s},t))}function Bd(n,e,t){let s=null;if(typeof e=="function"||Array.isArray(e)?s=e:t===void 0&&e&&(t=e),typeof t=="string"&&(t=t.length),typeof t=="number"){const r=Math.round(t);t=r<1?void 0:r>8?{indent:8}:{indent:r}}if(n===void 0){const{keepUndefined:r}=t??e??{};if(!r)return}return Ht(n)&&!s?n.toString(t):new En(n,s,t).toString(t)}const Pd=Object.freeze(Object.defineProperty({__proto__:null,Alias:ri,CST:Td,Composer:oo,Document:En,Lexer:xc,LineCounter:Kc,Pair:Ne,Parser:ao,Scalar:se,Schema:pi,YAMLError:io,YAMLMap:Fe,YAMLParseError:Ft,YAMLSeq:_t,YAMLWarning:Ac,isAlias:Et,isCollection:we,isDocument:Ht,isMap:wn,isNode:ke,isPair:be,isScalar:me,isSeq:kn,parse:Nd,parseAllDocuments:Cd,parseDocument:Fc,stringify:Bd,visit:zt,visitAsync:ii},Symbol.toStringTag,{value:"Module"}));class Md{constructor(){this.mistakes=[],this.taxonomy={}}async initialize(){this.mistakes=await Bl(),this._buildTaxonomy(),console.log(`MistakeManager initialized with ${this.mistakes.length} mistakes.`)}async loadFromYAML(e){try{const t=Pd.parse(e);if(!t.subject||!t.mistakes)throw new Error("YAML must contain 'subject' and 'mistakes' keys.");const s=t.mistakes.map(a=>this._normalizeMistake(a,t.subject)),r=new Map(this.mistakes.map(a=>[a.uuid,a]));return s.forEach(a=>r.set(a.uuid,a)),this.mistakes=Array.from(r.values()),await Pl(this.mistakes),this._buildTaxonomy(),{success:!0,count:s.length}}catch(t){return console.error("Failed to load from YAML:",t),{success:!1,error:t.message}}}_normalizeMistake(e,t){if(e.simple_problem){const r=e.simple_problem;return{uuid:crypto.randomUUID(),title:r.problem.substring(0,30)+(r.problem.length>30?"...":""),problem:r.problem,attachments:[],my_answer:{content:""},correct_answer:{content:r.answer,explanation:""},analysis:{reason_for_error:"知识点模糊",difficulty:r.difficulty||3},tags:r.tags||[],subject:t,is_simple:!0,review:{due:Date.now(),interval:0,easeFactor:2.5,state:"new"}}}const s={...e,subject:t};return s.review||(s.review={due:Date.now(),interval:0,easeFactor:2.5,state:"new"}),s.uuid||(s.uuid=crypto.randomUUID()),s}_buildTaxonomy(){const e={};this.mistakes.forEach(t=>{var s,r;t.subject&&(e[t.subject]||(e[t.subject]={tags:new Set,reasons:new Set}),(s=t.tags)==null||s.forEach(a=>e[t.subject].tags.add(a)),(r=t.analysis)!=null&&r.reason_for_error&&e[t.subject].reasons.add(t.analysis.reason_for_error))}),this.taxonomy=e}getFilteredMistakes(e={}){const{subject:t="all",tags:s=[],reasons:r=[]}=e;return this.mistakes.filter(a=>{var l;return!(t!=="all"&&a.subject!==t||s.length>0&&!s.every(d=>{var p;return(p=a.tags)==null?void 0:p.includes(d)})||r.length>0&&!r.includes((l=a.analysis)==null?void 0:l.reason_for_error))}).sort((a,l)=>a.review.due-l.review.due)}async updateReviewStatus(e,t){const s=this.mistakes.find(a=>a.uuid===e);if(!s)return null;const r=ba(s.review,t);return s.review={...s.review,...r},s.lastReviewed=Date.now(),await Ml(s),s}getTaxonomy(){return this.taxonomy}}class $d{constructor(){this.elements={subjectFilter:document.getElementById("subject-filter"),tagFilterContainer:document.querySelector('.filter-group[data-type="tags"] .tag-list'),reasonFilterContainer:document.querySelector('.filter-group[data-type="reasons"] .tag-list'),listContainer:document.querySelector("#mistakes-list"),previewContainer:document.getElementById("mistakes-preview"),paginationContainer:document.querySelector(".pagination"),statsContainer:document.getElementById("statistics-dashboard")}}renderFilters(e,t){this.elements.subjectFilter.innerHTML='<option value="all">所有科目</option>',Object.keys(e).sort().forEach(r=>{const a=new Option(r,r);a.selected=r===t,this.elements.subjectFilter.add(a)});const s=e[t]||{tags:new Set,reasons:new Set};this._renderFilterAccordion(this.elements.tagFilterContainer,"知识点标签",Array.from(s.tags).sort()),this._renderFilterAccordion(this.elements.reasonFilterContainer,"错误原因",Array.from(s.reasons).sort())}_renderFilterAccordion(e,t,s){e.innerHTML=`
            <details class="filter-accordion-item" open>
                <summary>
                    <span><i class="fas fa-tags"></i> ${t}</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </summary>
                <div class="tag-list-content">
                    ${s.map(r=>`<div class="tag" data-value="${r}">${r}</div>`).join("")}
                </div>
            </details>
        `}_renderFilterItems(e,t){e.innerHTML="",t.forEach(s=>{const r=document.createElement("div");r.className="tag",r.textContent=s,r.dataset.value=s,e.appendChild(r)})}renderMistakeList(e){const t=this.elements.listContainer;if(t.innerHTML="",e.length===0){t.innerHTML=`
                <li class="session-item-placeholder">
                    <i class="fas fa-check-circle"></i>
                    <p>没有符合条件的错题</p>
                    <span>尝试放宽筛选条件或导入新的错题。</span>
                </li>
            `;return}e.forEach(s=>{const r=document.createElement("li");r.className="session-item",r.dataset.id=s.uuid;const{className:a,text:l}=this._getDueDateStatus(s.review.due);r.innerHTML=`
                <div class="item-icon-wrapper">
                    <i class="fas fa-book-medical item-icon"></i>
                </div>
                <div class="item-content">
                    <div class="item-title">${s.title}</div>
                    <div class="item-meta">
                        <span class="meta-info ${a}">${l}</span>
                        <span class="meta-info">${s.subject||"未分类"}</span>
                    </div>
                </div>
            `,t.appendChild(r)})}_getDueDateStatus(e){const t=new Date(e),s=new Date;t.setHours(0,0,0,0),s.setHours(0,0,0,0);const r=t.getTime()-s.getTime(),a=Math.ceil(r/(1e3*60*60*24));return a<0?{className:"status-overdue",text:`过期${Math.abs(a)}天`}:a===0?{className:"status-today",text:"今天"}:a===1?{className:"status-soon",text:"明天"}:{className:"status-future",text:`${a}天后`}}setActiveListItem(e){if(this.elements.listContainer.querySelectorAll(".mistake-list-item.active").forEach(t=>t.classList.remove("active")),e){const t=this.elements.listContainer.querySelector(`.mistake-list-item[data-id="${e}"]`);t==null||t.classList.add("active")}}renderMistakePreview(e){this.elements.previewContainer.innerHTML="",e.forEach(t=>{const s=this._createMistakeCard(t);this.elements.previewContainer.appendChild(s)})}_createMistakeCard(e){var s,r,a,l,d;const t=document.createElement("div");return t.className="mistake-card",t.dataset.id=e.uuid,t.innerHTML=`
            <div class="problem-section">
                <div class="problem-header">
                    <h4>${e.title}</h4>
                    <div class="problem-meta">
                        <span class="meta-item reason">原因: ${e.analysis.reason_for_error}</span>
                        <span class="meta-item difficulty">难度: ${"★".repeat(e.analysis.difficulty)}${"☆".repeat(5-e.analysis.difficulty)}</span>
                    </div>
                </div>
                <div class="problem-content">${rr.parse(e.problem||"")}</div>
                ${((s=e.attachments)==null?void 0:s.map(p=>this._renderAttachment(p)).join(""))||""}
                <div class="problem-tags">
                    ${((r=e.tags)==null?void 0:r.map(p=>`<span class="tag">${p}</span>`).join(""))||""}
                </div>
                <div class="my-answer-preview"><strong>我的答案:</strong> ${((a=e.my_answer)==null?void 0:a.content)||"未作答"}</div>
                <button class="show-answer-btn">显示答案</button>
            </div>

            <div class="answer-section hidden">
                <div class="correct-answer">
                    <strong>正确答案:</strong>
                    <div class="content">${rr.parse(((l=e.correct_answer)==null?void 0:l.content)||"")}</div>
                </div>
                <div class="correct-explanation">
                    <strong>解析:</strong>
                    <div class="content">${rr.parse(((d=e.correct_answer)==null?void 0:d.explanation)||"")}</div>
                </div>
                <div class="review-actions">
                    <button class="review-btn redo" data-rating="0">重做 (10m)</button>
                    <button class="review-btn hard" data-rating="1">困难</button>
                    <button class="review-btn medium" data-rating="2">犹豫</button>
                    <button class="review-btn easy" data-rating="3">简单</button>
                </div>
            </div>
        `,t}_renderAttachment(e){return e.type==="image"?`<img src="${e.url}" alt="错题附件" class="problem-image">`:""}_formatDueDate(e){const t=new Date(e),s=new Date;s.setHours(0,0,0,0);const r=Math.ceil((t-s)/(1e3*60*60*24));return r===0?"今天":r===1?"明天":r>1&&r<7?`${r}天后`:r<0?`${Math.abs(r)}天前`:t.toLocaleDateString()}toggleAnswer(e,t){const s=e.querySelector(".answer-section"),r=e.querySelector(".show-answer-btn");t?(s.classList.remove("hidden"),r.classList.add("hidden")):(s.classList.add("hidden"),r.classList.remove("hidden"))}updateCardAfterReview(e,t,s){s!==3&&this.toggleAnswer(e,!1),e.querySelector(".review-actions").insertAdjacentHTML("afterend",'<div class="update-feedback">已更新!</div>'),setTimeout(()=>{var a;(a=e.querySelector(".update-feedback"))==null||a.remove()},1500)}updateListItem(e,t){const s=this.elements.listContainer.querySelector(`[data-id="${e}"]`);s&&(s.querySelector(".mistake-due-date").textContent=`复习: ${this._formatDueDate(t.review.due)}`)}renderPagination(e,t,s){this.elements.paginationContainer.innerHTML="";const r=Math.ceil(e/s);if(!(r<=1))for(let a=1;a<=r;a++){const l=document.createElement("button");l.className="page-btn",l.textContent=a,l.dataset.page=a,a===t&&l.classList.add("active"),this.elements.paginationContainer.appendChild(l)}}}const Te=n=>document.getElementById(n),vi=n=>document.querySelector(n);Te("mistakes-view");const ma=vi("#mistakes-view .session-sidebar"),yr=Te("subject-filter"),js=vi('#mistakes-view .filter-group[data-type="tags"] .tag-list'),qs=vi('#mistakes-view .filter-group[data-type="reasons"] .tag-list'),gr=Te("mistakes-list"),vr=vi("#mistakes-view .pagination"),Fs=Te("mistakes-preview"),ya=Te("mistake-editor-panel"),yt=Te("yaml-editor"),Rs=Te("mistakeToggleSessionBtn"),Rn=Te("mistakeSaveBtn"),br=Te("mistakeExportBtn"),Un=Te("mistakeCollapseBtn"),wr=Te("refresh-mistakes-btn"),kr=Te("load-yaml-btn"),Us=Te("yaml-file-input"),Sr=Te("newMistakeFileBtn"),_r=Te("mistakeStartReviewBtn"),Er=Te("mistakeReviewOptionsBtn"),ga=Te("mistakeReviewDropdownMenu");class Dd{constructor(e,t,s){this.manager=e,this.ui=t,this.stats=s,this.filters={subject:"all",tags:[],reasons:[]},this.currentPage=1,this.pageSize=5,this.previewDebounceTimer=null}init(){Sr==null||Sr.addEventListener("click",this._handleNewMistakeFile.bind(this)),Rs==null||Rs.addEventListener("click",this._handleToggleSidebar.bind(this)),Rn==null||Rn.addEventListener("click",this._handleSaveFromYaml.bind(this)),br==null||br.addEventListener("click",this._handleExportToYaml.bind(this)),Un==null||Un.addEventListener("click",this._handleCollapseEditor.bind(this)),wr==null||wr.addEventListener("click",this.refreshView.bind(this)),kr==null||kr.addEventListener("click",()=>Us.click()),Us==null||Us.addEventListener("change",this._handleFileLoad.bind(this)),yt==null||yt.addEventListener("input",this._handleEditorInput.bind(this)),yr==null||yr.addEventListener("change",this._handleSubjectChange.bind(this)),js==null||js.addEventListener("click",this._handleFilterTagClick.bind(this,"tags")),qs==null||qs.addEventListener("click",this._handleFilterTagClick.bind(this,"reasons")),gr==null||gr.addEventListener("click",this._handleMistakeListClick.bind(this)),Fs==null||Fs.addEventListener("click",this._handlePreviewClick.bind(this)),vr==null||vr.addEventListener("click",this._handlePaginationClick.bind(this)),_r==null||_r.addEventListener("click",()=>alert("错题本复习功能待实现！")),Er==null||Er.addEventListener("click",()=>ga.style.display=ga.style.display==="none"?"block":"none"),this.refreshView()}async refreshView(){var d;const e=this.stats.getDashboardHtml(this.manager.mistakes),t=document.querySelector("#mistakes-preview-panel .panel-header");(d=t.querySelector(".stats-dashboard-inline"))==null||d.remove(),t.insertAdjacentHTML("afterend",`<div class="stats-dashboard-inline">${e}</div>`);const s=this.manager.getFilteredMistakes(this.filters),r=(this.currentPage-1)*this.pageSize,a=r+this.pageSize,l=s.slice(r,a);this.ui.renderMistakeList(l),this.ui.renderMistakePreview(l),this.ui.renderPagination(s.length,this.currentPage,this.pageSize)}_handleToggleSidebar(){ma.classList.toggle("hidden-session");const e=ma.classList.contains("hidden-session");Rs.innerHTML=e?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}_handleNewMistakeFile(){const e=prompt("请输入新错题文件的标题:","未命名错题集");if(!e||e.trim()==="")return;const t=`
mistakes:
  - title: "二次函数图像与系数关系"
    problem: |
      已知二次函数 $y = ax^2 + bx + c$ 的图像如图所示，下列结论中正确的是？
      A. $a > 0, c > 0$
      B. $b^2 - 4ac < 0$
      C. $a - b + c > 0$
      D. $abc > 0$
    attachments:
      - type: image
        url: "function_graph.png"
    my_answer:
      content: "A"
    correct_answer:
      content: "C"
      explanation: |
        1. **开口方向**: 图像开口向上, $a > 0$
        2. **对称轴**: $x = -b/2a < 0$ → $b > 0$
        3. **与y轴交点**: $c < 0$
        4. **特殊点**: $x = -1$ 时, $y > 0$ → $a - b + c > 0$
    analysis:
      reason_for_error: "概念混淆"
      difficulty: 3
    tags: ["二次函数", "图像分析"]

  
  # 简易模式错题
  - simple_problem:
    - problem: "二次函数的定义是什么？"
      answer: "形如 y = ax^2 + bx + c (a≠0) 的函数"
      difficulty: 2
      tags: ["简易","二次函数", "定义"]
`.trim();yt.value=t,yt.focus()}async _handleSaveFromYaml(){const e=yt.value,t=await this.manager.loadFromYAML(e);t.success?(Rn.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>Rn.innerHTML='<i class="fas fa-save"></i>',2e3),this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()):alert(`保存失败: ${t.error}`)}_handleExportToYaml(){const e=yt.value,t=new Blob([e],{type:"text/yaml;charset=utf-8"});let s="mistake-export.yml";try{const a=e.match(/title:\s*["']?(.*?)["']?\s*\n/);a&&a[1]&&(s=`${a[1].replace(/[\/\\?%*:|"<>]/g,"-")}.yml`)}catch{}const r=document.createElement("a");r.href=URL.createObjectURL(t),r.download=s,r.click(),URL.revokeObjectURL(r.href)}_handleCollapseEditor(){ya.classList.toggle("collapsed");const e=ya.classList.contains("collapsed"),t=Un.querySelector("i");t.className=e?"fas fa-chevron-down":"fas fa-chevron-up",Un.title=e?"展开编辑器":"收起编辑器",e&&this._handleSaveFromYaml()}_handleEditorInput(){clearTimeout(this.previewDebounceTimer),this.previewDebounceTimer=setTimeout(()=>{console.log("Debounced: Ready to update preview from YAML editor content.")},500)}_handleSubjectChange(e){this.filters.subject=e.target.value,this.filters.tags=[],this.filters.reasons=[],this.currentPage=1,this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()}_handleFilterTagClick(e,t){const s=t.target.closest(".tag");if(!s)return;s.classList.toggle("active");const r=e==="tags"?js:qs;this.filters[e]=Array.from(r.querySelectorAll(".tag.active")).map(a=>a.dataset.value),this.currentPage=1,this.refreshView()}_handleMistakeListClick(e){const t=e.target.closest(".mistake-list-item");if(!t)return;const s=t.dataset.id;this.ui.setActiveListItem(s);const r=Fs.querySelector(`.mistake-card[data-id="${s}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("highlight"),setTimeout(()=>r.classList.remove("highlight"),1500))}_handlePaginationClick(e){const t=e.target.closest(".page-btn");t&&(this.currentPage=parseInt(t.dataset.page),this.refreshView())}async _handlePreviewClick(e){const t=e.target.closest(".mistake-card");if(!t)return;const s=t.dataset.id;e.target.matches(".show-answer-btn")&&this.ui.toggleAnswer(t,!0);const r=e.target.closest(".review-btn");if(r){const a=parseInt(r.dataset.rating),l=await this.manager.updateReviewStatus(s,a);l&&(this.ui.updateCardAfterReview(t,l,a),this.ui.updateListItem(s,l),a===0&&setTimeout(()=>this.ui.toggleAnswer(t,!1),500))}}_handleFileLoad(e){const t=e.target.files[0];if(!t)return;const s=new FileReader;s.onload=async r=>{await this._handleSaveFromYaml(r.target.result),yt.value=r.target.result},s.onerror=()=>alert("读取文件失败！"),s.readAsText(t),e.target.value=""}}class xd{constructor(){}generateStats(e){const t={total:e.length,bySubject:{},byReason:{},dueToday:0,overdue:0},s=new Date;s.setHours(23,59,59,999);const r=new Date;return r.setHours(0,0,0,0),e.forEach(a=>{t.bySubject[a.subject]=(t.bySubject[a.subject]||0)+1;const l=a.analysis.reason_for_error;t.byReason[l]=(t.byReason[l]||0)+1;const d=new Date(a.review.due);d<r?t.overdue++:d<=s&&t.dueToday++}),t}getDashboardHtml(e){const t=this.generateStats(e),s=Object.entries(t.byReason).sort((a,l)=>l[1]-a[1]).slice(0,3),r=Object.entries(t.bySubject).sort((a,l)=>l[1]-a[1]).slice(0,3);return`
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-chart-line"></i> 复习状态</div>
                <div class="stats-card-body">
                    <div class="stat-item"><span class="stat-value overdue">${t.overdue}</span><span class="stat-label">已过期</span></div>
                    <div class="stat-item"><span class="stat-value today">${t.dueToday}</span><span class="stat-label">今日到期</span></div>
                    <div class="stat-item"><span class="stat-value">${t.total}</span><span class="stat-label">总数</span></div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-book"></i> 科目分布</div>
                <div class="stats-card-body list-style">
                    ${r.length>0?r.map(([a,l])=>`<div class="list-item"><span>${a}</span><span class="list-value">${l}</span></div>`).join(""):"<span>暂无数据</span>"}
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-diagnoses"></i> 主要错误原因</div>
                <div class="stats-card-body list-style">
                    ${s.length>0?s.map(([a,l])=>`<div class="list-item"><span>${a}</span><span class="list-value">${l}</span></div>`).join(""):"<span>暂无数据</span>"}
                </div>
            </div>
        `}}async function Kd(){console.log("Initializing Mistakes Management System...");const n=new $d,e=new xd(n),t=new Md;await t.initialize();const s=new Dd(t,n,e),r=Object.keys(t.getTaxonomy())[0]||"all";s.filters.subject=r,n.renderFilters(t.getTaxonomy(),r),s.init(),console.log("Mistakes Management System is ready.")}function Rc(){var t,s,r,a;console.log("[ViewChange] Attempting to switch to view:",x.activeView);const{activeView:n}=x,e={anki:document.getElementById("nav-anki"),agent:document.getElementById("nav-agents"),mistakes:document.getElementById("nav-mistakes")};switch(or.style.display="none",Vo.style.display="none",Ho.style.display="none",Bs&&(Bs.style.display="none"),Object.values(e).forEach(l=>l==null?void 0:l.classList.remove("active")),n){case"anki":console.log("[ViewChange] Showing anki-view."),or.style.display="flex",(t=e.anki)==null||t.classList.add("active");break;case"agent":console.log("[ViewChange] Showing agent-view."),Vo.style.display="flex",Bs?(console.log("[ViewChange] Showing ai-agent-nav."),Bs.style.display="flex"):console.warn("[ViewChange] dom.agentNav element not found!"),(s=e.agent)==null||s.classList.add("active");break;case"mistakes":console.log("[ViewChange] Showing mistakes-view."),Ho.style.display="flex",(r=e.mistakes)==null||r.classList.add("active");break;default:console.log(`[ViewChange] Defaulting to anki-view because activeView is '${n}'.`),or.style.display="flex",(a=e.anki)==null||a.classList.add("active");break}}function jd(){const n=document.querySelector(".app-nav");if(!n){console.error("App navigation container (.app-nav) not found!");return}n.addEventListener("click",e=>{const t=e.target.closest(".app-nav-btn");if(!t)return;const s=t.dataset.target.replace("-view","");console.log(`[Navigation] Clicked button for view: '${s}'`),bu(s),Rc()})}function qd(){window.addEventListener("beforeunload",()=>{Xo()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Xo()})}async function Fd(){document.body.classList.add("is-loading");try{await _a(),await Ta(),await Promise.all([ff(),Ef(),Kd()]),jd(),qd();const n=x.activeView||"mistakes";ae({activeView:n}),Rc(),console.log("Application initialized successfully.")}catch(n){console.error("Application failed to initialize:",n);const e=document.createElement("div");e.className="error-overlay",e.innerHTML=`
            <h1><i class="fas fa-exclamation-triangle"></i> 应用程序加载失败</h1>
            <p>无法初始化应用。这可能是由于数据库结构变更或数据损坏导致的。</p>
            <p><strong>错误详情:</strong> ${n.message}</p>
            <p><strong>建议操作:</strong> 尝试清除浏览器缓存和IndexedDB数据后刷新页面。如果问题仍然存在，请联系开发者。</p>
            <button onclick="location.reload()">重试</button>
        `,document.body.innerHTML="",document.body.appendChild(e),document.body.classList.remove("is-loading")}finally{document.body.classList.remove("is-loading")}}document.addEventListener("DOMContentLoaded",Fd);</script>
  <style rel="stylesheet" crossorigin>:root{--primary-color: #4361ee;--secondary-color: #3f37c9;--accent-color: #4895ef;--light-color: #f8f9fa;--dark-color: #212529;--success-color: #43a047;--warning-color: #fb8c00;--danger-color: #e53935;--border-radius: 8px;--shadow: 0 4px 12px rgba(0, 0, 0, .1);--transition: all .3s ease;--folder-color: #ffca28;--file-color: #64b5f6;--agent-color-1: #4361ee;--agent-color-2: #3f37c9;--agent-color-3: #4895ef;--agent-color-4: #7209b7;--agent-color-5: #f72585;--topic-color-1: #ffd166;--topic-color-2: #06d6a0;--topic-color-3: #118ab2;--topic-color-4: #ef476f;--cloze-1d: #ffcdd2;--cloze-2d: #ffccbc;--cloze-3d: #ffc107;--cloze-5d: #d4e157;--cloze-7d: #a5d6a7;--cloze-14d: #80cbc4;--cloze-28d: #90caf9;--cloze-28plus: #b39ddb;--cloze-easy-open: #E8F5E9;--cloze-10m: #FF6666}.cloze.easy-open{background-color:var(--cloze-easy-open)!important;border:1px dashed #C8E6C9;color:#333!important;font-weight:400;opacity:.9}.cloze.permanent-view{background-color:#f0f4ff!important;border:1px solid #d0d9ff!important;font-weight:400!important}*{margin:0;padding:0;box-sizing:border-box}body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;background:linear-gradient(135deg,#f5f7fa,#e4e7f1);color:var(--dark-color);min-height:100vh;padding:20px}.container{max-width:1800px;margin:0 auto}header{text-align:center;margin-bottom:20px;padding:20px;background:#fffffff2;border-radius:var(--border-radius);box-shadow:var(--shadow)}h1{color:var(--secondary-color);margin-bottom:10px;font-size:2.2rem}.subtitle{color:var(--primary-color);font-size:1.1rem;max-width:800px;margin:0 auto 20px}.app-nav{display:flex;justify-content:center;gap:15px;margin:15px 0;border-top:1px solid #eee;padding-top:20px}.app-nav-btn{background:var(--primary-color);color:#fff;border:none;padding:12px 25px;border-radius:50px;cursor:pointer;font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;transition:var(--transition);box-shadow:0 4px 8px #4361ee33}.app-nav-btn:hover{transform:translateY(-3px);box-shadow:0 6px 15px #4361ee4d}.app-nav-btn.active{background:var(--secondary-color);box-shadow:0 2px 5px #3f37c94d;transform:translateY(0)}.ai-agent-nav{background:#fffffff2;border-radius:var(--border-radius);box-shadow:var(--shadow);padding:12px 20px;margin:0 auto 20px;max-width:1800px;display:flex;justify-content:space-between;align-items:center}.nav-title{font-size:1.3rem;color:var(--secondary-color);font-weight:600;display:flex;align-items:center;gap:10px}.nav-title i{color:var(--accent-color)}.agent-list{display:flex;gap:15px;overflow-x:auto;padding:5px 0}.agent-item{background:linear-gradient(135deg,var(--agent-color-1) 0%,var(--agent-color-2) 100%);color:#fff;padding:8px 20px;border-radius:30px;cursor:pointer;transition:var(--transition);font-size:.95rem;display:flex;align-items:center;gap:8px;white-space:nowrap;box-shadow:0 3px 8px #00000026}.agent-item:nth-child(2){background:linear-gradient(135deg,var(--agent-color-3) 0%,var(--agent-color-1) 100%)}.agent-item:nth-child(3){background:linear-gradient(135deg,var(--agent-color-4) 0%,var(--agent-color-5) 100%)}.agent-item:hover{transform:translateY(-3px);box-shadow:0 5px 15px #0003}.agent-item.active{box-shadow:0 0 0 3px #fffc,0 5px 15px #0003}.nav-actions{display:flex;gap:12px}.nav-action-btn{background:var(--primary-color);color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:var(--transition);font-size:.9rem}.nav-action-btn:hover{background:var(--secondary-color);transform:translateY(-2px)}.main-layout{display:flex;gap:20px;margin-bottom:25px;min-height:75vh;flex-wrap:wrap}.session-sidebar{width:300px;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:var(--transition)}.session-header{background:var(--primary-color);color:#fff;padding:15px 20px;display:flex;flex-direction:column;gap:12px}.session-title{font-size:1.2rem;font-weight:600;display:flex;align-items:center;justify-content:space-between}.session-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}.session-btn{background:#fff3;border:none;color:#fff;padding:8px;border-radius:4px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;width:36px;height:36px;transition:var(--transition)}.session-btn:hover{background:#ffffff4d}.session-content{flex:1;padding:15px;overflow-y:auto;max-height:750px}.session-list{list-style:none;margin-top:10px}.session-item{padding:12px 15px 12px 30px;border-radius:6px;margin-bottom:8px;background:#f8f9ff;cursor:pointer;transition:var(--transition);border:1px solid #e0e0e0;position:relative}.session-item.folder{background:#ffd1661a;border-left:4px solid var(--folder-color);padding-left:26px}.session-item.file{background:#a1c4fd1a;border-left:4px solid var(--file-color);padding-left:26px}.session-item:hover{background:#eef2ff;transform:translate(3px)}.session-item.active{background:linear-gradient(120deg,#a1c4fd,#c2e9fb);border-color:var(--accent-color);font-weight:600}.session-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:60px;display:flex;align-items:center;gap:8px}.session-item .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}.session-item .edit-btn,.session-item .delete-btn,.session-item .move-btn{color:#666;cursor:pointer;padding:4px;border-radius:4px;transition:var(--transition);background:#fff9;width:24px;height:24px;display:flex;align-items:center;justify-content:center}.session-item .edit-btn:hover{background:var(--accent-color);color:#fff}.session-item .delete-btn:hover{background:var(--danger-color);color:#fff}.session-item .move-btn:hover{background:var(--success-color);color:#fff}.session-item input[type=text]{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:inherit;font-size:.95rem}.app-container{flex:1;display:flex;flex-direction:column;gap:20px;min-width:0}.panel{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out}.panel.collapsed .panel-content{display:none}.editor-panel,.preview-panel{flex:1;min-height:250px}.editor-panel.hidden{display:none}.panel-header{background:var(--primary-color);color:#fff;padding:0 20px;display:flex;justify-content:space-between;align-items:center;height:60px;flex-shrink:0}.panel-header .panel-title{flex-grow:1;justify-content:center;text-align:center}.panel-header .panel-actions-leading,.panel-header .panel-actions{flex-shrink:0;display:flex;gap:8px;align-items:center}.panel-title{font-size:1.2rem;font-weight:600;display:flex;align-items:center;gap:8px}.panel-actions{display:flex;gap:8px;align-items:center}.panel-actions .panel-btn{background:#fff3;border:none;color:#fff;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition)}.panel-actions .panel-btn:hover{background:#ffffff4d}.panel-actions .panel-btn-text{width:auto;padding:0 15px;gap:8px}.collapse-btn i{transition:transform .3s ease}.panel.collapsed .collapse-btn i{transform:rotate(180deg)}.panel-content{flex:1;padding:18px;overflow:auto;transition:var(--transition);display:flex;flex-direction:column}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding-bottom:12px;margin-bottom:12px;border-bottom:1px solid #e0e6f0;flex-shrink:0}.editor-sub-toolbar .editor-btn{background:#f0f4ff;border:1px solid #d0d9ff;padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem}.editor-sub-toolbar .editor-btn:hover:not(:disabled){background:var(--accent-color);color:#fff;border-color:var(--accent-color)}.editor-sub-toolbar .editor-btn:disabled{opacity:.5;cursor:not-allowed}.editor-container{flex:1;display:flex;min-height:280px}.editor,#yaml-editor{width:100%;flex:1;min-height:0;padding:14px;font-family:Consolas,Courier New,monospace;font-size:15px;border:1px solid #e0e0e0;border-radius:6px;resize:none;line-height:1.5}.editor:focus,#yaml-editor:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px #4895ef33}#preview,#mistakes-preview{min-height:280px;padding:15px;border:1px solid #e0e0e0;border-radius:6px;background:#fcfcfc}#preview h1,#preview h2,#preview h3,#mistakes-preview h1,#mistakes-preview h2,#mistakes-preview h3{margin-top:1.1em;margin-bottom:.7em;color:var(--secondary-color)}#preview p,#mistakes-preview p{margin-bottom:.9em}#preview code,#mistakes-preview code{background:#f5f5f5;padding:2px 5px;border-radius:4px;font-family:monospace}#preview pre,#mistakes-preview pre{background:#2d2d2d;color:#f8f8f2;padding:14px;border-radius:6px;overflow:auto;margin:1.4em 0}#preview blockquote,#mistakes-preview blockquote{border-left:4px solid var(--accent-color);padding:10px 18px;background:#f9f9f9;margin:1.4em 0}.cloze{padding:2px 6px;border-radius:4px;cursor:pointer;position:relative;transition:var(--transition);border:1px dashed rgba(67,97,238,.3);font-weight:700;background:var(--cloze-28plus)}.cloze.hidden .cloze-content{display:none}.cloze.hidden .placeholder{display:inline}.cloze:not(.hidden) .placeholder{display:none}.placeholder{color:var(--primary-color);font-weight:700}.cloze.temporary{animation:highlight .5s ease}.cloze.shown{background:linear-gradient(120deg,#d4fc79,#96e6a1)}.cloze.permanent{border:1px solid var(--success-color)}.cloze-1d{background:var(--cloze-1d)!important}.cloze-2d{background:var(--cloze-2d)!important}.cloze-3d{background:var(--cloze-3d)!important}.cloze-5d{background:var(--cloze-5d)!important}.cloze-7d{background:var(--cloze-7d)!important}.cloze-14d{background:var(--cloze-14d)!important}.cloze-28d{background:var(--cloze-28d)!important}.cloze-28plus{background:var(--cloze-28plus)!important}.cloze-10m{background-color:var(--cloze-10m)!important;border-color:#f33!important;animation:pulse-alert 1.5s infinite alternate;color:#fff!important;font-weight:700}@keyframes highlight{0%{background:#fff9c4}to{background:linear-gradient(120deg,#a1c4fd,#c2e9fb)}}.editor-toolbar{display:flex;justify-content:space-between;align-items:center;padding:10px 18px;background:#f0f4ff;border-bottom:1px solid #d0d9ff}.toolbar-left,.toolbar-right{display:flex;gap:10px}.toolbar-middle{flex:1;display:flex;justify-content:center;gap:10px}.editor-btn{background:#eef2ff;border:1px solid #d0d9ff;padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem}.editor-btn:hover:not(:disabled){background:var(--accent-color);color:#fff;border-color:var(--accent-color)}.editor-btn:disabled{opacity:.5;cursor:not-allowed}.editor-btn-text{width:40px;height:40px;padding:0;font-size:0}.editor-btn-text i{font-size:.9rem;margin:0}.review-btn-group .editor-btn-text,.review-btn-group .dropdown-toggle{width:auto;padding:8px 15px;font-size:.9rem}#reviewOptionsBtn.dropdown-toggle{padding:8px 12px}#startReviewBtn.editor-btn-text{gap:8px}#startReviewBtn.editor-btn-text i{font-size:.9rem}.hidden-session{transform:translate(calc(-1 * var(--session-width) - 25px));opacity:0;width:0;overflow:hidden}.instructions{background:#fff;padding:22px;border-radius:var(--border-radius);box-shadow:var(--shadow);margin-top:25px}.instructions h2{color:var(--secondary-color);margin-bottom:18px;text-align:center;font-size:1.4rem}.instructions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px}.instruction-card{background:#f8f9ff;border-radius:var(--border-radius);padding:18px;box-shadow:0 2px 8px #00000014;transition:var(--transition)}.instruction-card:hover{transform:translateY(-4px);box-shadow:0 6px 15px #0000001a}.instruction-card h3{color:var(--primary-color);margin-bottom:14px;display:flex;align-items:center;gap:8px;font-size:1.1rem}.instruction-card h3 i{background:var(--primary-color);color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem}.footer{text-align:center;margin-top:35px;padding:18px;color:#666;font-size:.85rem}.file-input{display:none}.empty-session{text-align:center;padding:28px;color:#666}.empty-session i{font-size:2.8rem;margin-bottom:14px;color:#c3cfe2}.select-controls{display:flex;gap:8px;margin-top:10px;padding:8px 0;border-top:1px solid rgba(255,255,255,.2)}.select-all{display:flex;align-items:center;gap:5px;color:#fff;font-size:.85rem}.session-item .select-checkbox{margin-right:8px}.session-item .name-container{display:flex;flex:1;overflow:hidden}.folder-icon{color:var(--folder-color)}.file-icon{color:var(--file-color)}.nested-items{margin-left:20px;margin-top:8px;border-left:2px solid #e0e0e0;padding-left:15px}.current-folder{margin-top:10px;padding:8px;background:#eef2ff;border-radius:4px;font-size:.9rem;color:var(--dark-color);display:flex;align-items:center;flex-wrap:wrap;gap:4px}.current-folder i{margin-right:5px;color:var(--folder-color)}.breadcrumb-link{color:var(--primary-color);cursor:pointer;text-decoration:none}.breadcrumb-link:hover{text-decoration:underline}.breadcrumb-separator{margin:0 4px;color:#6c757d}.breadcrumb-current{font-weight:700;color:var(--secondary-color)}.move-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:var(--transition)}.move-modal.active{opacity:1;pointer-events:all}.move-modal-content{background:#fff;border-radius:var(--border-radius);padding:20px;width:400px;max-width:90%;box-shadow:var(--shadow)}.move-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.move-modal-title{font-size:1.2rem;font-weight:600;color:var(--primary-color)}.move-modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666}.folder-list{max-height:300px;overflow-y:auto;margin:15px 0;border:1px solid #e0e0e0;border-radius:var(--border-radius);padding:10px}.folder-item{padding:8px 10px;border-radius:4px;margin-bottom:5px;background:#f8f9ff;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}.folder-item:hover{background:#eef2ff}.folder-item.selected{background:#4361ee1a;border-left:3px solid var(--primary-color)}.move-modal-actions{display:flex;justify-content:flex-end;gap:10px}.move-modal-btn{padding:8px 15px;border-radius:4px;cursor:pointer;border:none;font-weight:500;transition:var(--transition)}.move-modal-btn.confirm{background:var(--primary-color);color:#fff}.move-modal-btn.cancel{background:#f0f0f0;color:var(--dark-color)}@media (max-width: 1200px){.main-layout{flex-direction:column}.session-sidebar{width:100%;max-width:100%}.app-container{min-width:100%}}@media (max-width: 768px){.panel-header{flex-direction:column;align-items:flex-start;gap:10px;height:auto;padding:10px}.panel-actions{width:100%;justify-content:flex-end;flex-wrap:wrap}.editor-toolbar{flex-direction:column;gap:10px}.toolbar-left,.toolbar-middle,.toolbar-right{width:100%;justify-content:center}}.media-icon{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;margin-right:5px;background:#4361ee1a;border-radius:50%;color:var(--primary-color);cursor:pointer;transition:var(--transition)}.media-icon:hover{background:#4361ee33;transform:scale(1.1)}.audio-controls{position:fixed;bottom:20px;right:20px;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);padding:15px;z-index:1000;display:none}.audio-title{margin-bottom:10px;font-weight:600;color:var(--secondary-color)}.audio-progress{width:300px;height:6px;background:#e0e0e0;border-radius:3px;margin:10px 0;overflow:hidden}.audio-progress-bar{height:100%;background:var(--primary-color);width:0%;transition:width .1s linear}.audio-buttons{display:flex;justify-content:space-between}.audio-btn{background:var(--primary-color);color:#fff;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:5px}.audio-edit-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;margin-top:5px;transition:var(--transition)}.audio-edit-btn:hover{background:#4361ee33}.agent-content-container{display:flex;gap:20px;margin-bottom:20px}.topics-panel{width:300px;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}.topics-header{background:var(--primary-color);color:#fff;padding:15px 20px;font-size:1.1rem;font-weight:600}.topics-content{flex:1;padding:15px;overflow-y:auto;max-height:500px}.topic-list{list-style:none}.topic-item{padding:12px 15px;border-radius:6px;margin-bottom:10px;background:#f8f9ff;cursor:pointer;transition:var(--transition);border-left:4px solid var(--topic-color-1);position:relative;display:flex;align-items:center;gap:10px}.topic-item:nth-child(2n){border-left-color:var(--topic-color-2)}.topic-item:nth-child(3n){border-left-color:var(--topic-color-3)}.topic-item:nth-child(4n){border-left-color:var(--topic-color-4)}.topic-item:hover{transform:translate(5px);background:#eef2ff}.topic-item.active{background:linear-gradient(120deg,#a1c4fd,#c2e9fb);font-weight:600}.history-panel{flex:1;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);display:flex;flex-direction:column;position:relative}.history-header{background:var(--primary-color);color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}.history-title{font-size:1.1rem;font-weight:600;display:flex;align-items:center;gap:10px}.history-header-actions{display:flex;align-items:center;gap:10px}.header-action-btn{background:#fff3;border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}.header-action-btn:hover{background:#fff6;transform:rotate(45deg)}.history-search{padding:8px 15px;border-radius:20px;border:none;width:250px;font-size:.9rem}.history-content{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:20px}.history-item{padding:15px;border-radius:8px;background:#f8f9ff;box-shadow:0 2px 6px #0000000d;border-left:3px solid var(--primary-color)}.history-item-header{display:flex;justify-content:space-between;margin-bottom:10px;color:#666;font-size:.9rem}.history-item-content{line-height:1.6}.history-item-content img{max-width:100%;border-radius:8px;margin-top:10px}.history-item-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}.history-action-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;transition:var(--transition)}.history-action-btn:hover{background:#4361ee33}.agent-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#4361ee,#3f37c9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;flex-shrink:0}.topic-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.8rem;flex-shrink:0}.topic-item:nth-child(1) .topic-icon{background:var(--topic-color-1)}.topic-item:nth-child(2) .topic-icon{background:var(--topic-color-2)}.topic-item:nth-child(3) .topic-icon{background:var(--topic-color-3)}.topic-item:nth-child(4) .topic-icon{background:var(--topic-color-4)}.chat-input-area{padding:15px 20px;border-top:1px solid #e0e6f0;background-color:#f8f9ff;display:flex;flex-direction:column;gap:10px;flex-shrink:0}.input-controls{display:flex;align-items:flex-end;gap:10px}.chat-textarea{flex:1;border:1px solid #d0d9ff;border-radius:var(--border-radius);padding:10px 15px;font-family:inherit;font-size:1rem;line-height:1.5;resize:vertical;transition:var(--transition);background-color:#fff}.chat-textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px #4895ef33}.chat-action-btn{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:var(--transition);background:#eef2ff;color:var(--primary-color);flex-shrink:0}.chat-action-btn:hover{background:#dbe4ff;transform:translateY(-2px)}.chat-action-btn.send{background-color:var(--primary-color);color:#fff}.chat-action-btn.send:hover{background-color:var(--secondary-color)}.attachment-preview-container{display:flex;gap:8px;flex-wrap:wrap;max-height:100px;overflow-y:auto}.attachment-preview-item{background:#e0e6f0;padding:5px 12px;border-radius:15px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px;color:#333;animation:fadeIn .3s ease}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}.attachment-preview-item i{color:var(--primary-color)}.remove-attachment-btn{cursor:pointer;font-weight:700;color:#666;background:none;border:none;font-size:1.2rem;line-height:1;padding:0 2px;transition:var(--transition)}.remove-attachment-btn:hover{color:var(--danger-color);transform:scale(1.2)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:2000;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}.modal-content{background:#fff;border-radius:var(--border-radius);box-shadow:0 10px 30px #0003;width:90%;max-width:600px;display:flex;flex-direction:column;max-height:90vh;animation:slide-in .3s ease-out}@keyframes slide-in{0%{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}.modal-header{padding:15px 25px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:1.4rem;color:var(--secondary-color)}.modal-close{background:none;border:none;font-size:1.8rem;cursor:pointer;color:#888}.modal-body{padding:25px;overflow-y:auto}.modal-footer{padding:15px 25px;border-top:1px solid #e0e0e0;display:flex;justify-content:flex-end;gap:10px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#333}.form-control{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:6px;font-size:1rem;transition:var(--transition)}.form-control:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px #4895ef33}.form-control.is-invalid{border-color:var(--danger-color)}.invalid-feedback{color:var(--danger-color);font-size:.85rem;margin-top:5px;display:none}.form-control.is-invalid+.invalid-feedback{display:block}.input-group{display:flex}.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}.input-group-btn{padding:0 12px;border:1px solid #ccc;border-left:none;background-color:#f0f0f0;border-top-right-radius:6px;border-bottom-right-radius:6px;cursor:pointer}.form-check{display:flex;align-items:center;gap:8px;margin-top:15px}.btn-primary,.btn-secondary,.btn-danger{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1rem;transition:var(--transition)}.btn-primary{background-color:var(--primary-color);color:#fff}.btn-primary:hover{background-color:var(--secondary-color)}.btn-secondary{background-color:#e0e0e0;color:#333}.btn-secondary:hover{background-color:#ccc}.btn-danger{background-color:var(--danger-color);color:#fff}.btn-danger:hover{opacity:.85}.delete-confirm-zone{margin-top:15px;padding:15px;background-color:#f443361a;border:1px solid var(--danger-color);border-radius:6px}.delete-confirm-zone #finalDeleteBtn{margin-top:10px;width:100%}.delete-confirm-zone #finalDeleteBtn:disabled{background-color:#ccc;cursor:not-allowed}.chat-navigation{position:absolute;bottom:90px;right:25px;display:flex;flex-direction:column;gap:10px;z-index:10}.chat-nav-btn{width:40px;height:40px;border-radius:50%;background-color:#4361eecc;color:#fff;border:none;cursor:pointer;box-shadow:0 2px 10px #0003;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:1rem}.chat-nav-btn:hover{background-color:var(--secondary-color);transform:scale(1.1)}.chat-nav-btn:disabled{opacity:.5;cursor:not-allowed}.history-item.highlighted{transition:background-color .5s ease;background-color:#e0e7ff;border-color:var(--accent-color)}.global-review-area{margin:15px 0;display:flex;justify-content:center}.review-btn-group{display:flex;position:relative}.review-btn-group .main-action{border-top-right-radius:0;border-bottom-right-radius:0}.review-btn-group .dropdown-toggle{border-top-left-radius:0;border-bottom-left-radius:0;border-left:1px solid rgba(255,255,255,.3)}.dropdown-menu{position:absolute;top:105%;right:0;background-color:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;padding:8px 0;min-width:180px;border:1px solid #ddd}.dropdown-menu a{display:block;padding:10px 15px;color:var(--dark-color);text-decoration:none;transition:background-color .2s ease;font-size:.9rem}.dropdown-menu a:hover{background-color:#f0f4ff}.dropdown-menu a i{margin-right:10px;color:var(--primary-color);width:20px;text-align:center}.form-checkbox-group{display:flex;flex-wrap:wrap;gap:10px 20px;padding:5px 0}.form-checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer}.cloze.permanent-view .cloze-actions{display:none!important}.cloze-actions{display:flex;justify-content:space-between;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.08)}.cloze-btn{flex:1;padding:10px 5px;border-radius:20px;border:none;background-color:#f5f7fa;cursor:pointer;font-size:.9rem;font-weight:600;text-align:center;transition:all .2s ease-in-out;outline:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;box-shadow:0 2px 4px #0000000d}.cloze-btn i{font-size:1.2rem;margin-bottom:5px}.cloze-btn.again{color:#e53935;background-color:#e539351a}.cloze-btn.again:hover{background-color:#e53935;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #e539354d}.cloze-btn.hard{color:#fb8c00;background-color:#fb8c001a}.cloze-btn.hard:hover{background-color:#fb8c00;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #fb8c004d}.cloze-btn.double{color:#43a047;background-color:#43a0471a}.cloze-btn.double:hover{background-color:#43a047;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #43a0474d}.cloze-btn.easy{color:#1e88e5;background-color:#1e88e51a}.cloze-btn.easy:hover{background-color:#1e88e5;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #1e88e54d}.mistakes-nav{width:25%;min-width:300px;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}.nav-header{background:var(--primary-color);color:#fff;padding:15px 20px;display:flex;flex-direction:column;gap:12px}.nav-content{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:20px}.filter-accordion-item{border-bottom:1px solid #eee}.filter-accordion-item summary{display:flex;justify-content:space-between;align-items:center;padding:14px 5px;cursor:pointer;list-style:none;font-weight:600;color:var(--secondary-color)}.filter-accordion-item .tag-list{padding:10px 5px 15px;background-color:#fdfdff;display:flex;flex-wrap:wrap;gap:8px}.tag{background:#4361ee1a;color:var(--primary-color);padding:6px 12px;border-radius:20px;font-size:.85rem;cursor:pointer;transition:var(--transition)}.tag:hover{background:#4361ee33}.tag.active{background:var(--primary-color);color:#fff;font-weight:500}.mistakes-list{flex:1;overflow-y:auto;padding-top:15px;border-top:1px solid #e0e6f0}.mistake-item{padding:12px 15px;border-radius:6px;margin-bottom:8px;background:#f8f9ff;cursor:pointer;transition:var(--transition);border:1px solid #e0e0e0;position:relative}.mistake-item:hover{background:#eef2ff;transform:translate(3px)}.mistake-item.active{background:linear-gradient(120deg,#a1c4fd,#c2e9fb);border-color:var(--accent-color);font-weight:600}.mistake-title{font-weight:500;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.mistake-meta{display:flex;justify-content:space-between;font-size:.8rem;color:#666}@media (max-width: 1200px){.mistakes-nav{width:100%;max-width:100%}}@media (max-width: 992px){.mistakes-nav{max-height:40vh;min-width:0}}@media (max-width: 768px){.panel-header .panel-title,.panel-actions{justify-content:center}.app-nav{flex-wrap:wrap}}.stats-dashboard-inline{display:flex;gap:15px;padding:15px;background-color:#f8f9fa;border-bottom:1px solid #dee2e6}.stats-card{flex:1;background-color:#fff;border-radius:8px;border:1px solid #e9ecef;box-shadow:0 1px 3px #0000000d;overflow:hidden}.stats-card-header{font-size:.9rem;font-weight:600;padding:8px 12px;background-color:#f1f3f5;border-bottom:1px solid #e9ecef;color:#495057}.stats-card-header i{margin-right:8px;color:var(--primary-color)}.stats-card-body{padding:12px;display:flex;justify-content:space-around;align-items:center}.stats-card-body.list-style{flex-direction:column;align-items:stretch;gap:8px}.stat-item{display:flex;flex-direction:column;align-items:center;gap:4px}.stat-value{font-size:1.5rem;font-weight:700;color:#212529}.stat-value.overdue{color:#d90429}.stat-value.today{color:#f77f00}.stat-label{font-size:.8rem;color:#6c757d}.list-item{display:flex;justify-content:space-between;font-size:.85rem}.list-value{font-weight:600;padding:2px 6px;background-color:#e9ecef;border-radius:4px}.editor-preview-panel{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out}.editor-preview-panel .panel-content{position:relative;flex:1;display:flex;flex-direction:column;min-height:300px}.editor-container{display:flex;flex-direction:column;height:100%;width:100%}#preview{display:none;height:100%;overflow:auto;padding:15px;border:1px solid #e0e0e0;border-radius:6px;background:#fcfcfc}.editor-preview-panel.preview-active .editor-container{display:none}.editor-preview-panel.preview-active #preview{display:block;height:100%}.mode-indicator{position:absolute;bottom:10px;right:10px;display:flex;gap:5px;z-index:10}.mode-dot{width:8px;height:8px;border-radius:50%;background-color:#ccc}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding-bottom:12px;margin-bottom:12px;border-bottom:1px solid #e0e6f0;flex-shrink:0;background:#f8f9ff}#editor{flex:1;min-height:0;padding:14px;font-family:Consolas,Courier New,monospace;font-size:15px;border:1px solid #e0e0e0;border-radius:6px;resize:none;line-height:1.5}.panel-btn.active{background-color:#ffffff4d}.app-container,.editor-preview-panel,.panel-content,.editor-container{flex:1;display:flex;flex-direction:column;min-height:0}#editor{flex:1;min-height:0;resize:vertical}#preview{flex:1;min-height:0;overflow:auto}#anki-view .app-container{min-height:500px}#mistakes-view .app-container{display:block;min-height:auto}.editor-preview-panel{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out;flex:1;min-height:0}.editor-preview-panel .panel-content{position:relative;flex:1;display:flex;flex-direction:column;min-height:300px;padding:0}#editorContainer{display:flex;flex-direction:column;height:100%;width:100%;position:relative;overflow:hidden}#editor,#preview{position:absolute;top:0;left:0;width:100%;height:100%;padding:15px;box-sizing:border-box}#editor{z-index:10;font-family:Consolas,Courier New,monospace;font-size:15px;border:none;resize:none;line-height:1.5;background:#fcfcfc}#preview{z-index:5;display:none;overflow:auto;background:#fff}.editor-preview-panel.preview-active #editor{display:none}.editor-preview-panel.preview-active #preview{display:block}.editor-preview-panel.preview-active #editorToolbar{display:none}.mode-indicator{position:absolute;bottom:10px;right:10px;display:flex;gap:5px;z-index:20;background:#fffc;padding:5px 8px;border-radius:12px;box-shadow:0 2px 5px #0000001a}.mode-dot{width:10px;height:10px;border-radius:50%;background-color:#ddd}.mode-dot.active{background-color:var(--primary-color)}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px 15px;border-bottom:1px solid #e0e6f0;background:#f8f9ff;z-index:15;position:relative}.panel-btn.active{background-color:#ffffff4d;transform:scale(1.1)}.panel-btn{transition:all .3s ease}.panel-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px #0000001a}.panel-btn i{transition:color .3s ease}.edit-mode .panel-btn i.fa-eye{color:#4caf50}.preview-mode .panel-btn i.fa-eye{color:#ff9800}.btn-label{transition:all .3s ease}@media (max-width: 1400px){.btn-label{opacity:0;width:0;margin:0;padding:0}}.panel-btn:hover i{transform:scale(1.1)}.panel-btn.active{background-color:#ffffff4d;transform:scale(1.05);box-shadow:0 0 10px #4caf5080}#toggleEditPreviewBtn{background:linear-gradient(135deg,#4361ee,#3f37c9);color:#fff;border-radius:20px;padding:8px 15px}#toggleEditPreviewBtn:hover{background:linear-gradient(135deg,#3f37c9,#4361ee)}</style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-brain"></i> 智能学习套件</h1>
            <p class="subtitle">集成 Anki 笔记、AI Agents 和智能错题本的一站式学习平台</p>
            <nav class="app-nav">
                <button class="app-nav-btn" id="nav-anki" data-target="anki-view">
                    <i class="fas fa-layer-group"></i> Anki 笔记
                </button>
                <button class="app-nav-btn active" id="nav-mistakes" data-target="mistakes-view">
                    <i class="fas fa-book"></i> 错题本
                </button>
                <button class="app-nav-btn" id="nav-agents" data-target="agent-view">
                    <i class="fas fa-robot"></i> AI Agents
                </button>
            </nav>
        </header>

        <!-- AI Agent导航栏 (此部分在初始视图中可能隐藏) -->
        <nav class="ai-agent-nav" style="display: none;">
            <div class="nav-title">
                <i class="fas fa-robot"></i> AI Agent管理
            </div>
            <div class="agent-list">
                <div class="agent-item active" data-agent="1">
                    <div class="agent-avatar">AI</div>
                    <span>数学学习助手</span>
                </div>
                <div class="agent-item" data-agent="2">
                    <div class="agent-avatar">MD</div>
                    <span>语言学习助手</span>
                </div>
                <div class="agent-item" data-agent="3">
                    <div class="agent-avatar">CS</div>
                    <span>计算机科学助手</span>
                </div>
                <div class="agent-item">
                    <div class="agent-avatar">+</div>
                    <span>添加新Agent</span>
                </div>
            </div>
            <div class="nav-actions">
                <button class="nav-action-btn">
                    <i class="fas fa-history"></i> 历史记录
                </button>
                <button class="nav-action-btn">
                    <i class="fas fa-cog"></i> 设置
                </button>
            </div>
        </nav>

        <!-- AI Agent内容区域 (此部分在初始视图中可能隐藏) -->
        <div class="agent-content-container" id="agent-view" style="display: none;">
            <div class="topics-panel">
                <div class="topics-header">
                    <i class="fas fa-book"></i> 聊天主题
                </div>
                <div class="topics-content">
                    <ul class="topic-list">
                        <li class="topic-item active">
                            <div class="topic-icon"><i class="fas fa-calculator"></i></div>
                            <span>线性代数</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-infinity"></i></div>
                            <span>微积分</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-project-diagram"></i></div>
                            <span>概率统计</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-cube"></i></div>
                            <span>几何学</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-plus-circle"></i></div>
                            <span>添加新主题</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="history-panel">
                <div class="history-header">
                    <div class="history-title">
                        <i class="fas fa-comments"></i>
                        <span id="historyHeaderTitle">历史对话记录</span>
                    </div>
                    <div class="history-header-actions">
                        <button id="agentSettingsTriggerBtn" class="header-action-btn" title="当前Agent设置" style="display: none;">
                            <i class="fas fa-cog"></i>
                        </button>
                        <input type="text" class="history-search" placeholder="搜索历史记录...">
                    </div>
                </div>
                <div class="history-content">
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-15 14:30</span>
                            <span>线性代数 - 矩阵运算</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 请解释矩阵的逆是什么？</p>
                            <p><strong>AI助手:</strong> 矩阵的逆类似于数字的倒数。对于一个n×n矩阵A，如果存在另一个n×n矩阵B，使得AB = BA = I（单位矩阵），那么B就是A的逆矩阵，记作A⁻¹。只有方阵且行列式不为零的矩阵才有逆矩阵。</p>
                            <img src="https://via.placeholder.com/600x150/4361ee/ffffff?text=矩阵逆运算示例" alt="矩阵逆运算示例">
                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                </div>
                <div class="chat-navigation">
                    <button id="chatNavUp" class="chat-nav-btn" title="上一轮对话"><i class="fas fa-arrow-up"></i></button>
                    <button id="chatNavDown" class="chat-nav-btn" title="下一轮对话"><i class="fas fa-arrow-down"></i></button>
                </div>
                <!-- ==================== 新增的聊天输入区域 ==================== -->
                <div class="chat-input-area">
                    <div class="attachment-preview-container" id="attachmentPreview"></div>
                    <div class="input-controls">
                        <textarea id="chatInput" class="chat-textarea" rows="3" placeholder="输入消息... (Shift + Enter 换行)"></textarea>
                        <!-- 隐藏的文件输入框，通过JS点击附件按钮来触发 -->
                        <input type="file" id="attachmentInput" multiple style="display: none;">
                        <button id="attachFileBtn" class="chat-action-btn" title="添加附件" onclick="document.getElementById('attachmentInput').click();">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button id="sendMessageBtn" class="chat-action-btn send" title="发送">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <!-- ==================== 聊天输入区域结束 ==================== -->
            </div>
        </div>

        <!-- Anki 笔记视图 (此部分在初始视图中可能隐藏) -->
        <div class="main-layout" id="anki-view" style="display: none;">
            <div class="session-sidebar">
                <div class="session-header">
                    <div class="session-title">
                        <span><i class="fas fa-layer-group"></i> 会话管理</span>
                    </div>
                    <div class="session-controls">
                        <button id="newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                        <button id="newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                        <button id="openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                        <button id="moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                        <button id="deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="select-controls">
                        <label class="select-all">
                            <input type="checkbox" id="selectAllCheckbox"> 全选
                        </label>
                    </div>
                    <div class="current-folder" id="currentFolderContainer"></div>
                </div>
                <div class="session-content">
                    <div class="session-list-container">
                        <ul class="session-list" id="sessionList"></ul>
                        <div class="empty-session" id="emptySession">
                            <i class="fas fa-folder-open"></i>
                            <p>没有打开的会话</p>
                            <p>点击"新建文件"或"打开文件"开始</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-container">
                <div class="editor-preview-panel">
                    <!-- 1. 添加了标准的 panel-header -->
                    <div class="panel-header">
                        <!-- 1. 左侧的按钮容器 -->
                        <div class="panel-actions-leading">
        <button id="toggleSessionBtn" class="panel-btn" title="显示/隐藏会话栏"><i class="fas fa-bars"></i></button>
                            <button id="toggleEditPreviewBtn" class="panel-btn panel-btn-text">
                                <i class="fas fa-book-open"></i> Preview
                            </button>
                        </div>

                        <div class="panel-title">
                            <i class="fas fa-edit"></i> Anki 编辑器
                        </div>
                        <div class="panel-actions">
                            <!-- 复习按钮组也可以放在这里，或者放在 header actions 里，这里放在子工具栏更符合“编辑”上下文 -->
                            <div class="review-btn-group" style="margin-left: auto;">

                                <button id="startReviewBtn" class="panel-btn panel-btn-text">
                                    <i class="fas fa-play-circle"></i> 复习 (<span id="reviewCount">0</span>)
                                </button>
                                <button id="reviewOptionsBtn" class="panel-btn dropdown-toggle">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="reviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                    <a href="#" id="customStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
                                </div>
                            </div>
                            <button id="toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏">
                                <i class="fas fa-eye-eye"></i>
                            </button>
                            <button id="invertClozeBtn" class="panel-btn" title="反向显示/隐藏">
                                <i class="fas fa-random"></i>
                            </button>
                            <button id="saveBtn" class="panel-btn panel-btn-text" title="保存"><i class="fas fa-save"></i>
                            </button>
                            <button id="exportFileBtn" class="panel-btn panel-btn-text" title="导出"><i
                                    class="fas fa-download"></i> </button>
                            <button id="toggleEditorBtn" class="panel-btn collapse-btn" title="收起/展开编辑器">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                    </div>

                    <div class="panel-content">
        <!-- 编辑模式下的工具栏 -->
        <div class="editor-sub-toolbar" id="editorToolbar">
            <button id="clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
            <button id="boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
            <button id="italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
            <button id="insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
            <button id="codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
            <button id="linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
            <button id="audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
        </div>

        <!-- 编辑器容器 -->
        <div class="editor-container" id="editorContainer">
                            <textarea id="editor"
                                class="editor"># Anki MD管理系统

## 使用说明

### 目录结构
- 创建目录来组织您的会话
- 在目录中创建文件
- 将文件移动到不同的目录

### 操作指南
1. 点击"新建目录"按钮创建新目录
2. 选择一个目录后，新建的文件会自动放入该目录
3. 使用移动按钮将项目移动到其他目录
4. 选中目录时会选中其下所有内容
5. 删除目录时会删除其下所有内容

### 数学公式示例
行内公式：\\( E = mc^2 \\)

块级公式：
\\[ 
x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} 
\\]

### Cloze 记忆卡片
牛顿第二定律：--\\( F = ma \\)--
量子力学基础：--\\( \psi = \psi(x,t) \\)--
相对论：--\\( E = \gamma m c^2 \\)--
电磁学：--\\( \nabla \times \mathbf{B} = \mu_0 \mathbf{J} + \mu_0 \epsilon_0 \frac{\partial \mathbf{E}}{\partial t} \\)--</textarea>

                        <div id="preview"></div>
                        </div>

        <!-- 模式指示器 -->
                        <div class="mode-indicator">
                            <div class="mode-dot active" id="editModeDot" title="编辑模式"></div>
                            <div class="mode-dot" id="previewModeDot" title="预览模式"></div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- ====================================================== -->
            <!--          [MODIFIED] 错题本视图 (应用所有修改)           -->
            <!-- ====================================================== -->
            <div id="mistakes-view" class="main-layout active">

                <!-- [MODIFIED] 错题本侧边栏 -->
                <div class="session-sidebar">
                    <div class="session-header">
                        <div class="session-title">
                            <span><i class="fas fa-book-open"></i> 错题筛选与导航</span>
                        </div>
                    </div>

                    <div class="session-content">
                        <!-- 筛选区域 -->
                        <!-- [MODIFIED] 将 .filter-section 改为 .session-header -->
                        <div class="session-header">
                            <!-- [MODIFIED] 将 .filter-controls 改为 .session-controls -->
                            <div class="session-controls">
                                <select id="subject-filter"></select>
                                <!-- [MODIFIED] 统一所有按钮的样式为 session-btn -->
                                <button id="refresh-mistakes-btn" class="session-btn" title="刷新"><i
                                        class="fas fa-sync-alt"></i></button>
                                <button id="newMistakeFileBtn" class="session-btn" title="新建错题文件"><i
                                        class="fas fa-file-alt"></i></button>
                                <button id="load-yaml-btn" class="session-btn" title="导入YAML文件"><i
                                        class="fas fa-file-upload"></i></button>
                                <input type="file" id="yaml-file-input" accept=".yml,.yaml" style="display: none;">
                            </div>
                            <div class="filter-group" data-type="tags">
                                <div class="tag-list"></div>
                            </div>
                            <div class="filter-group" data-type="reasons">
                                <div class="tag-list"></div>
                            </div>
                        </div>


                        <!-- 错题列表容器 -->
                        <div class="mistakes-list-container">
                            <div class="list-header"><i class="fas fa-list-ul"></i> 待复习列表 (按到期日排序)</div>
                            <ul class="session-list" id="mistakes-list">
                                <!-- 错题列表项将由JS动态生成 -->
                            </ul>
                            <div class="pagination">
                                <!-- 分页按钮将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [MODIFIED] 错题本主内容区 -->
                <div class="app-container">
                    <!-- 统计仪表盘 -->
                    <div id="statistics-dashboard" class="stats-dashboard">
                        <!-- 统计卡片将由JS动态生成 -->
                    </div>

                    <!-- YAML 编辑器面板 -->
                    <div id="mistake-editor-panel" class="panel editor-panel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                            <button id="mistakeToggleSessionBtn" class="panel-btn" title="显示/隐藏筛选栏"><i class="fas fa-bars"></i></button>
                            </div>
                            <div class="panel-title"><i class="fas fa-code"></i> YAML 编辑器</div>
                            <div class="panel-actions">
                            <button id="mistakeSaveBtn" class="panel-btn" title="保存并刷新"><i class="fas fa-save"></i></button>
                            <button id="mistakeExportBtn" class="panel-btn" title="导出YAML"><i class="fas fa-download"></i></button>
                                <button class="panel-btn collapse-btn" id="mistakeCollapseBtn" title="收起/展开">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <textarea id="yaml-editor" placeholder="在此处粘贴或编辑您的YAML格式错题..."></textarea>
                        </div>
                    </div>

                    <!-- 错题预览面板 -->
                    <div id="mistakes-preview-panel" class="panel preview-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-eye"></i> 错题预览</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="mistakeStartReviewBtn" class="editor-btn editor-btn-text">
                                        <i class="fas fa-play-circle"></i> 开始复习
                                    </button>
                                    <button id="mistakeReviewOptionsBtn" class="editor-btn dropdown-toggle">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div id="mistakeReviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                    <a href="#" id="mistakeCustomStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div id="mistakes-preview" class="mistakes-preview-container">
                                <!-- 错题预览卡片将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 错题本视图结束 -->



            <input type="file" id="fileInput" class="file-input" accept=".md, .txt">

            <div class="move-modal" id="moveModal">
                <div class="move-modal-content">
                    <div class="move-modal-header">
                        <div class="move-modal-title">移动到目录</div>
                        <button class="move-modal-close" id="closeMoveModalBtn">×</button>
                    </div>
                    <p>请选择目标目录：</p>
                    <div class="folder-list" id="folderList"></div>
                    <div class="move-modal-actions">
                        <button class="move-modal-btn cancel" id="cancelMoveBtn">取消</button>
                        <button class="move-modal-btn confirm" id="confirmMoveBtn">确认移动</button>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>© 2024 Anki MD管理系统 | 数据保存在浏览器本地存储中</p>
            </div>
        </div>


        <!-- ====================================================== -->
        <!--          AUDIO PLAYING                                 -->
        <!-- ====================================================== -->
        <div class="audio-controls" id="audioControls">
            <div class="audio-title" id="audioTitle">音频播放</div>
            <div class="audio-progress">
                <div class="audio-progress-bar" id="audioProgress"></div>
            </div>
            <div class="audio-buttons">
                <button class="audio-btn" id="playBtn"><i class="fas fa-play"></i> 播放</button>
                <button class="audio-btn" id="pauseBtn"><i class="fas fa-pause"></i> 暂停</button>
                <button class="audio-btn" id="stopBtn"><i class="fas fa-stop"></i> 停止</button>
            </div>
        </div>

        <!-- ====================================================== -->
        <!--          AGENT SETTINGS MODAL (Initially Hidden)       -->
        <!-- ====================================================== -->
        <div class="modal-overlay" id="agentSettingsModal" style="display: none;">
            <div class="modal-content agent-settings-modal">
                <div class="modal-header">
                    <h2 id="agentSettingsModalTitle">Agent 设置</h2>
                    <button class="modal-close" id="agentSettingsCloseBtn">×</button>
                </div>
                <div class="modal-body">
                    <form id="agentSettingsForm" novalidate>
                        <input type="hidden" id="agentSettingsId">

                        <div class="form-group">
                        <label for="agentSettingsName">Agent名 (内部标识) <i class="fas fa-info-circle" title="唯一标识，仅限字母、数字、下划线。"></i></label>
                        <input type="text" id="agentSettingsName" class="form-control" required pattern="[a-zA-Z0-9_]+">
                            <div class="invalid-feedback">名称已被使用或格式不正确。</div>
                        </div>

                        <div class="form-group">
                            <label for="agentSettingsDisplayName">会话显示名</label>
                            <input type="text" id="agentSettingsDisplayName" class="form-control" required>
                        </div>
                        <!-- 新增 Avatar 输入框 -->
                        <div class="form-group">
                            <label for="agentSettingsAvatar">头像 (2个字符)</label>
                        <input type="text" id="agentSettingsAvatar" class="form-control" required maxlength="2" placeholder="例如：AI, 数, 语">
                        </div>
                        <hr>

                        <h4>模型配置</h4>

                        <div class="form-group">
                            <label for="agentSettingsProvider">提供商</label>
                            <select id="agentSettingsProvider" class="form-control" required>
                                <!-- 选项将由JS动态填充 -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="agentSettingsApiPath">API 地址</label>
                            <input type="url" id="agentSettingsApiPath" class="form-control">
                        </div>

                        <div class="form-group api-key-group">
                            <label for="agentSettingsApiKey">API Key</label>
                            <div class="input-group">
                                <input type="password" id="agentSettingsApiKey" class="form-control">
                            <button type="button" id="toggleApiKeyVisibility" class="input-group-btn" title="显示/隐藏"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="agentSettingsModel">模型名</label>
                            <select id="agentSettingsModel" class="form-control" required>
                                <!-- 选项将由JS动态填充 -->
                            </select>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" id="agentSettingsIsLocal" class="form-check-input">
                            <label for="agentSettingsIsLocal">这是一个本地推理模型 (无需API Key)</label>
                        </div>

                        <hr>

                        <h4>危险操作区</h4>
                    <button type="button" class="btn-danger" id="deleteAgentBtn"><i class="fas fa-trash"></i> 删除此 Agent</button>
                        <div class="delete-confirm-zone" style="display:none;">
                            <p>请输入Agent名 "<b><span id="agentNameToConfirm"></span></b>" 以确认删除：</p>
                            <input type="text" id="deleteConfirmInput" class="form-control">
                            <button type="button" class="btn-danger" id="finalDeleteBtn" disabled>我已了解后果，永久删除</button>
                        </div>
                        <hr>
                        <h4>Agent 行为设定</h4>
                        <div class="form-group">
                            <label for="agentSettingsSystemPrompt">System Prompt (系统提示词)</label>
                        <textarea id="agentSettingsSystemPrompt" class="form-control" rows="5" placeholder="定义Agent的角色和行为，例如：你是一个专业的数学学习助手..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="agentSettingsCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="agentSettingsSaveBtn" form="agentSettingsForm">保存更改</button>
                </div>
            </div>
        </div>

        <!-- [NEW] 自定义复习模态框 -->
        <div class="modal-overlay" id="customStudyModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>自定义复习会话</h2>
                    <button class="modal-close" id="customStudyCloseBtn">×</button>
                </div>
                <div class="modal-body">
                    <form id="customStudyForm">
                        <div class="form-group">
                            <label for="filterByFile">按文件/目录筛选:</label>
                            <select id="filterByFile" class="form-control">
                                <option value="all">所有文件</option>
                                <!-- 选项将由JS动态填充 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>按卡片状态筛选:</label>
                            <div class="form-checkbox-group">
                                <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                                <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                                <label><input type="checkbox" name="cardState" value="review" checked> 复习中</label>
                                <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>按最后一次复习时间筛选:</label>
                            <select id="filterByLastReview" class="form-control">
                                <option value="any">任何时间</option>
                                <option value="last7days">最近7天内</option>
                                <option value="last30days">最近30天内</option>
                                <option value="over30days">超过30天未复习</option>
                                <option value="never">从未复习过 (新卡片)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxCards">最大卡片数量:</label>
                            <input type="number" id="maxCards" class="form-control" value="50" min="1">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="customStudyCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="startCustomStudyBtn" form="customStudyForm">开始自定义复习</button>
                </div>
            </div>
        </div>
</body>
</html>
