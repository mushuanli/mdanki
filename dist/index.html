<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能学习套件</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script> 
    <!-- [新增] 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        loader: {load: ['[tex]/mhchem']},
        tex: {
          packages: {'[+]': ['mhchem']}
        },
        startup: {
          pageReady: () => {
            return window.MathJax.startup.defaultPageReady();
          }
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
  <script type="module" crossorigin>import{marked as Er}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const wa=n=>document.querySelector(n),K=n=>document.getElementById(n),Io={anki:K("anki-view"),task:K("task-view"),agent:K("agent-view"),settings:K("settings-view")};let yc={activeView:"anki",sessions:[],folders:[],clozeStates:{},fileSubsessions:{},undoStack:[],redoStack:[],currentSessionId:null,currentFolderId:null,currentSubsessionId:null,folderStack:[],agents:[],topics:[],history:[],currentAgentId:null,currentTopicId:null,currentConversationAgentId:null,topicListFilterTag:"all",isLoading:!0,isAiThinking:!1,isTopicsPanelHidden:!1,isSessionSidebarHidden:!1,areAllClozeVisible:!1,movingItems:[],selectedMoveTarget:null,isTopicSelectionMode:!1,selectedTopicIds:[]};const A=new Proxy(yc,{get(n,e){if(e in n){const t=n[e];return typeof t=="object"&&t!==null?JSON.parse(JSON.stringify(t)):t}},set(){return console.warn("Direct mutation of appState is not allowed. Use a data service function."),!1}});function Z(n){Object.assign(yc,n)}var Eo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Nu(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var gc={exports:{}};(function(n,e){(function(t,s){n.exports=s()})(Eo,function(){var t=function(i,a){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(l,u){l.__proto__=u}||function(l,u){for(var d in u)Object.prototype.hasOwnProperty.call(u,d)&&(l[d]=u[d])})(i,a)},s=function(){return(s=Object.assign||function(i){for(var a,l=1,u=arguments.length;l<u;l++)for(var d in a=arguments[l])Object.prototype.hasOwnProperty.call(a,d)&&(i[d]=a[d]);return i}).apply(this,arguments)};function r(i,a,l){for(var u,d=0,p=a.length;d<p;d++)!u&&d in a||((u=u||Array.prototype.slice.call(a,0,d))[d]=a[d]);return i.concat(u||Array.prototype.slice.call(a))}var o=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Eo,c=Object.keys,f=Array.isArray;function h(i,a){return typeof a!="object"||c(a).forEach(function(l){i[l]=a[l]}),i}typeof Promise>"u"||o.Promise||(o.Promise=Promise);var m=Object.getPrototypeOf,I={}.hasOwnProperty;function b(i,a){return I.call(i,a)}function N(i,a){typeof a=="function"&&(a=a(m(i))),(typeof Reflect>"u"?c:Reflect.ownKeys)(a).forEach(function(l){M(i,l,a[l])})}var $=Object.defineProperty;function M(i,a,l,u){$(i,a,h(l&&b(l,"get")&&typeof l.get=="function"?{get:l.get,set:l.set,configurable:!0}:{value:l,configurable:!0,writable:!0},u))}function L(i){return{from:function(a){return i.prototype=Object.create(a.prototype),M(i.prototype,"constructor",i),{extend:N.bind(null,i.prototype)}}}}var P=Object.getOwnPropertyDescriptor,z=[].slice;function J(i,a,l){return z.call(i,a,l)}function X(i,a){return a(i)}function Q(i){if(!i)throw new Error("Assertion Failed")}function te(i){o.setImmediate?setImmediate(i):setTimeout(i,0)}function ne(i,a){if(typeof a=="string"&&b(i,a))return i[a];if(!a)return i;if(typeof a!="string"){for(var l=[],u=0,d=a.length;u<d;++u){var p=ne(i,a[u]);l.push(p)}return l}var y=a.indexOf(".");if(y!==-1){var g=i[a.substr(0,y)];return g==null?void 0:ne(g,a.substr(y+1))}}function oe(i,a,l){if(i&&a!==void 0&&!("isFrozen"in Object&&Object.isFrozen(i)))if(typeof a!="string"&&"length"in a){Q(typeof l!="string"&&"length"in l);for(var u=0,d=a.length;u<d;++u)oe(i,a[u],l[u])}else{var p,y,g=a.indexOf(".");g!==-1?(p=a.substr(0,g),(y=a.substr(g+1))===""?l===void 0?f(i)&&!isNaN(parseInt(p))?i.splice(p,1):delete i[p]:i[p]=l:oe(g=!(g=i[p])||!b(i,p)?i[p]={}:g,y,l)):l===void 0?f(i)&&!isNaN(parseInt(a))?i.splice(a,1):delete i[a]:i[a]=l}}function G(i){var a,l={};for(a in i)b(i,a)&&(l[a]=i[a]);return l}var ye=[].concat;function ze(i){return ye.apply([],i)}var Lt="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(ze([8,16,32,64].map(function(i){return["Int","Uint","Float"].map(function(a){return a+i+"Array"})}))).filter(function(i){return o[i]}),nt=new Set(Lt.map(function(i){return o[i]})),ge=null;function We(i){return ge=new WeakMap,i=function a(l){if(!l||typeof l!="object")return l;var u=ge.get(l);if(u)return u;if(f(l)){u=[],ge.set(l,u);for(var d=0,p=l.length;d<p;++d)u.push(a(l[d]))}else if(nt.has(l.constructor))u=l;else{var y,g=m(l);for(y in u=g===Object.prototype?{}:Object.create(g),ge.set(l,u),l)b(l,y)&&(u[y]=a(l[y]))}return u}(i),ge=null,i}var Ql={}.toString;function Ki(i){return Ql.call(i).slice(8,-1)}var qi=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Xl=typeof qi=="symbol"?function(i){var a;return i!=null&&(a=i[qi])&&a.apply(i)}:function(){return null};function Tt(i,a){return a=i.indexOf(a),0<=a&&i.splice(a,1),0<=a}var Gt={};function st(i){var a,l,u,d;if(arguments.length===1){if(f(i))return i.slice();if(this===Gt&&typeof i=="string")return[i];if(d=Xl(i)){for(l=[];!(u=d.next()).done;)l.push(u.value);return l}if(i==null)return[i];if(typeof(a=i.length)!="number")return[i];for(l=new Array(a);a--;)l[a]=i[a];return l}for(a=arguments.length,l=new Array(a);a--;)l[a]=arguments[a];return l}var Ri=typeof Symbol<"u"?function(i){return i[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Dn=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Fe=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Dn),Zl={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Qt(i,a){this.name=i,this.message=a}function Fa(i,a){return i+". Errors: "+Object.keys(a).map(function(l){return a[l].toString()}).filter(function(l,u,d){return d.indexOf(l)===u}).join(`
`)}function ws(i,a,l,u){this.failures=a,this.failedKeys=u,this.successCount=l,this.message=Fa(i,a)}function Xt(i,a){this.name="BulkError",this.failures=Object.keys(a).map(function(l){return a[l]}),this.failuresByPos=a,this.message=Fa(i,this.failures)}L(Qt).from(Error).extend({toString:function(){return this.name+": "+this.message}}),L(ws).from(Qt),L(Xt).from(Qt);var Fi=Fe.reduce(function(i,a){return i[a]=a+"Error",i},{}),eu=Qt,ie=Fe.reduce(function(i,a){var l=a+"Error";function u(d,p){this.name=l,d?typeof d=="string"?(this.message="".concat(d).concat(p?`
 `+p:""),this.inner=p||null):typeof d=="object"&&(this.message="".concat(d.name," ").concat(d.message),this.inner=d):(this.message=Zl[a]||l,this.inner=null)}return L(u).from(eu),i[a]=u,i},{});ie.Syntax=SyntaxError,ie.Type=TypeError,ie.Range=RangeError;var Ha=Dn.reduce(function(i,a){return i[a+"Error"]=ie[a],i},{}),ks=Fe.reduce(function(i,a){return["Syntax","Type","Range"].indexOf(a)===-1&&(i[a+"Error"]=ie[a]),i},{});function pe(){}function Pn(i){return i}function tu(i,a){return i==null||i===Pn?a:function(l){return a(i(l))}}function At(i,a){return function(){i.apply(this,arguments),a.apply(this,arguments)}}function nu(i,a){return i===pe?a:function(){var l=i.apply(this,arguments);l!==void 0&&(arguments[0]=l);var u=this.onsuccess,d=this.onerror;this.onsuccess=null,this.onerror=null;var p=a.apply(this,arguments);return u&&(this.onsuccess=this.onsuccess?At(u,this.onsuccess):u),d&&(this.onerror=this.onerror?At(d,this.onerror):d),p!==void 0?p:l}}function su(i,a){return i===pe?a:function(){i.apply(this,arguments);var l=this.onsuccess,u=this.onerror;this.onsuccess=this.onerror=null,a.apply(this,arguments),l&&(this.onsuccess=this.onsuccess?At(l,this.onsuccess):l),u&&(this.onerror=this.onerror?At(u,this.onerror):u)}}function iu(i,a){return i===pe?a:function(l){var u=i.apply(this,arguments);h(l,u);var d=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,l=a.apply(this,arguments),d&&(this.onsuccess=this.onsuccess?At(d,this.onsuccess):d),p&&(this.onerror=this.onerror?At(p,this.onerror):p),u===void 0?l===void 0?void 0:l:h(u,l)}}function ru(i,a){return i===pe?a:function(){return a.apply(this,arguments)!==!1&&i.apply(this,arguments)}}function Hi(i,a){return i===pe?a:function(){var l=i.apply(this,arguments);if(l&&typeof l.then=="function"){for(var u=this,d=arguments.length,p=new Array(d);d--;)p[d]=arguments[d];return l.then(function(){return a.apply(u,p)})}return a.apply(this,arguments)}}ks.ModifyError=ws,ks.DexieError=Qt,ks.BulkError=Xt;var Ge=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Ua(i){Ge=i}var Mn={},za=100,Lt=typeof Promise>"u"?[]:function(){var i=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[i,m(i),i];var a=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[a,m(a),i]}(),Dn=Lt[0],Fe=Lt[1],Lt=Lt[2],Fe=Fe&&Fe.then,Ct=Dn&&Dn.constructor,Ui=!!Lt,Bn=function(i,a){jn.push([i,a]),Ss&&(queueMicrotask(ou),Ss=!1)},zi=!0,Ss=!0,Ot=[],_s=[],Vi=Pn,ft={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:pe,pgp:!1,env:{},finalize:pe},ee=ft,jn=[],Nt=0,Is=[];function Y(i){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var a=this._PSD=ee;if(typeof i!="function"){if(i!==Mn)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Ji(this,this._value))}this._state=null,this._value=null,++a.ref,function l(u,d){try{d(function(p){if(u._state===null){if(p===u)throw new TypeError("A promise cannot be resolved with itself.");var y=u._lib&&Zt();p&&typeof p.then=="function"?l(u,function(g,w){p instanceof Y?p._then(g,w):p.then(g,w)}):(u._state=!0,u._value=p,Ya(u)),y&&en()}},Ji.bind(null,u))}catch(p){Ji(u,p)}}(this,i)}var Yi={get:function(){var i=ee,a=Ls;function l(u,d){var p=this,y=!i.global&&(i!==ee||a!==Ls),g=y&&!ht(),w=new Y(function(S,T){Wi(p,new Va(Wa(u,i,y,g),Wa(d,i,y,g),S,T,i))});return this._consoleTask&&(w._consoleTask=this._consoleTask),w}return l.prototype=Mn,l},set:function(i){M(this,"then",i&&i.prototype===Mn?Yi:{get:function(){return i},set:Yi.set})}};function Va(i,a,l,u,d){this.onFulfilled=typeof i=="function"?i:null,this.onRejected=typeof a=="function"?a:null,this.resolve=l,this.reject=u,this.psd=d}function Ji(i,a){var l,u;_s.push(a),i._state===null&&(l=i._lib&&Zt(),a=Vi(a),i._state=!1,i._value=a,u=i,Ot.some(function(d){return d._value===u._value})||Ot.push(u),Ya(i),l&&en())}function Ya(i){var a=i._listeners;i._listeners=[];for(var l=0,u=a.length;l<u;++l)Wi(i,a[l]);var d=i._PSD;--d.ref||d.finalize(),Nt===0&&(++Nt,Bn(function(){--Nt==0&&Gi()},[]))}function Wi(i,a){if(i._state!==null){var l=i._state?a.onFulfilled:a.onRejected;if(l===null)return(i._state?a.resolve:a.reject)(i._value);++a.psd.ref,++Nt,Bn(au,[l,i,a])}else i._listeners.push(a)}function au(i,a,l){try{var u,d=a._value;!a._state&&_s.length&&(_s=[]),u=Ge&&a._consoleTask?a._consoleTask.run(function(){return i(d)}):i(d),a._state||_s.indexOf(d)!==-1||function(p){for(var y=Ot.length;y;)if(Ot[--y]._value===p._value)return Ot.splice(y,1)}(a),l.resolve(u)}catch(p){l.reject(p)}finally{--Nt==0&&Gi(),--l.psd.ref||l.psd.finalize()}}function ou(){$t(ft,function(){Zt()&&en()})}function Zt(){var i=zi;return Ss=zi=!1,i}function en(){var i,a,l;do for(;0<jn.length;)for(i=jn,jn=[],l=i.length,a=0;a<l;++a){var u=i[a];u[0].apply(null,u[1])}while(0<jn.length);Ss=zi=!0}function Gi(){var i=Ot;Ot=[],i.forEach(function(u){u._PSD.onunhandled.call(null,u._value,u)});for(var a=Is.slice(0),l=a.length;l;)a[--l]()}function Es(i){return new Y(Mn,!1,i)}function be(i,a){var l=ee;return function(){var u=Zt(),d=ee;try{return pt(l,!0),i.apply(this,arguments)}catch(p){a&&a(p)}finally{pt(d,!1),u&&en()}}}N(Y.prototype,{then:Yi,_then:function(i,a){Wi(this,new Va(null,null,i,a,ee))},catch:function(i){if(arguments.length===1)return this.then(null,i);var a=i,l=arguments[1];return typeof a=="function"?this.then(null,function(u){return(u instanceof a?l:Es)(u)}):this.then(null,function(u){return(u&&u.name===a?l:Es)(u)})},finally:function(i){return this.then(function(a){return Y.resolve(i()).then(function(){return a})},function(a){return Y.resolve(i()).then(function(){return Es(a)})})},timeout:function(i,a){var l=this;return i<1/0?new Y(function(u,d){var p=setTimeout(function(){return d(new ie.Timeout(a))},i);l.then(u,d).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&M(Y.prototype,Symbol.toStringTag,"Dexie.Promise"),ft.env=Ja(),N(Y,{all:function(){var i=st.apply(null,arguments).map(Cs);return new Y(function(a,l){i.length===0&&a([]);var u=i.length;i.forEach(function(d,p){return Y.resolve(d).then(function(y){i[p]=y,--u||a(i)},l)})})},resolve:function(i){return i instanceof Y?i:i&&typeof i.then=="function"?new Y(function(a,l){i.then(a,l)}):new Y(Mn,!0,i)},reject:Es,race:function(){var i=st.apply(null,arguments).map(Cs);return new Y(function(a,l){i.map(function(u){return Y.resolve(u).then(a,l)})})},PSD:{get:function(){return ee},set:function(i){return ee=i}},totalEchoes:{get:function(){return Ls}},newPSD:dt,usePSD:$t,scheduler:{get:function(){return Bn},set:function(i){Bn=i}},rejectionMapper:{get:function(){return Vi},set:function(i){Vi=i}},follow:function(i,a){return new Y(function(l,u){return dt(function(d,p){var y=ee;y.unhandleds=[],y.onunhandled=p,y.finalize=At(function(){var g,w=this;g=function(){w.unhandleds.length===0?d():p(w.unhandleds[0])},Is.push(function S(){g(),Is.splice(Is.indexOf(S),1)}),++Nt,Bn(function(){--Nt==0&&Gi()},[])},y.finalize),i()},a,l,u)})}}),Ct&&(Ct.allSettled&&M(Y,"allSettled",function(){var i=st.apply(null,arguments).map(Cs);return new Y(function(a){i.length===0&&a([]);var l=i.length,u=new Array(l);i.forEach(function(d,p){return Y.resolve(d).then(function(y){return u[p]={status:"fulfilled",value:y}},function(y){return u[p]={status:"rejected",reason:y}}).then(function(){return--l||a(u)})})})}),Ct.any&&typeof AggregateError<"u"&&M(Y,"any",function(){var i=st.apply(null,arguments).map(Cs);return new Y(function(a,l){i.length===0&&l(new AggregateError([]));var u=i.length,d=new Array(u);i.forEach(function(p,y){return Y.resolve(p).then(function(g){return a(g)},function(g){d[y]=g,--u||l(new AggregateError(d))})})})}),Ct.withResolvers&&(Y.withResolvers=Ct.withResolvers));var Ae={awaits:0,echoes:0,id:0},cu=0,Ts=[],As=0,Ls=0,lu=0;function dt(i,a,l,u){var d=ee,p=Object.create(d);return p.parent=d,p.ref=0,p.global=!1,p.id=++lu,ft.env,p.env=Ui?{Promise:Y,PromiseProp:{value:Y,configurable:!0,writable:!0},all:Y.all,race:Y.race,allSettled:Y.allSettled,any:Y.any,resolve:Y.resolve,reject:Y.reject}:{},a&&h(p,a),++d.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},u=$t(p,i,l,u),p.ref===0&&p.finalize(),u}function tn(){return Ae.id||(Ae.id=++cu),++Ae.awaits,Ae.echoes+=za,Ae.id}function ht(){return!!Ae.awaits&&(--Ae.awaits==0&&(Ae.id=0),Ae.echoes=Ae.awaits*za,!0)}function Cs(i){return Ae.echoes&&i&&i.constructor===Ct?(tn(),i.then(function(a){return ht(),a},function(a){return ht(),_e(a)})):i}function uu(){var i=Ts[Ts.length-1];Ts.pop(),pt(i,!1)}function pt(i,a){var l,u=ee;(a?!Ae.echoes||As++&&i===ee:!As||--As&&i===ee)||queueMicrotask(a?(function(d){++Ls,Ae.echoes&&--Ae.echoes!=0||(Ae.echoes=Ae.awaits=Ae.id=0),Ts.push(ee),pt(d,!0)}).bind(null,i):uu),i!==ee&&(ee=i,u===ft&&(ft.env=Ja()),Ui&&(l=ft.env.Promise,a=i.env,(u.global||i.global)&&(Object.defineProperty(o,"Promise",a.PromiseProp),l.all=a.all,l.race=a.race,l.resolve=a.resolve,l.reject=a.reject,a.allSettled&&(l.allSettled=a.allSettled),a.any&&(l.any=a.any))))}function Ja(){var i=o.Promise;return Ui?{Promise:i,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:i.all,race:i.race,allSettled:i.allSettled,any:i.any,resolve:i.resolve,reject:i.reject}:{}}function $t(i,a,l,u,d){var p=ee;try{return pt(i,!0),a(l,u,d)}finally{pt(p,!1)}}function Wa(i,a,l,u){return typeof i!="function"?i:function(){var d=ee;l&&tn(),pt(a,!0);try{return i.apply(this,arguments)}finally{pt(d,!1),u&&queueMicrotask(ht)}}}function Qi(i){Promise===Ct&&Ae.echoes===0?As===0?i():enqueueNativeMicroTask(i):setTimeout(i,0)}(""+Fe).indexOf("[native code]")===-1&&(tn=ht=pe);var _e=Y.reject,xt="￿",it="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Ga="String expected.",nn=[],Os="__dbnames",Xi="readonly",Zi="readwrite";function Pt(i,a){return i?a?function(){return i.apply(this,arguments)&&a.apply(this,arguments)}:i:a}var Qa={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Ns(i){return typeof i!="string"||/\./.test(i)?function(a){return a}:function(a){return a[i]===void 0&&i in a&&delete(a=We(a))[i],a}}function Xa(){throw ie.Type()}function fe(i,a){try{var l=Za(i),u=Za(a);if(l!==u)return l==="Array"?1:u==="Array"?-1:l==="binary"?1:u==="binary"?-1:l==="string"?1:u==="string"?-1:l==="Date"?1:u!=="Date"?NaN:-1;switch(l){case"number":case"Date":case"string":return a<i?1:i<a?-1:0;case"binary":return function(d,p){for(var y=d.length,g=p.length,w=y<g?y:g,S=0;S<w;++S)if(d[S]!==p[S])return d[S]<p[S]?-1:1;return y===g?0:y<g?-1:1}(eo(i),eo(a));case"Array":return function(d,p){for(var y=d.length,g=p.length,w=y<g?y:g,S=0;S<w;++S){var T=fe(d[S],p[S]);if(T!==0)return T}return y===g?0:y<g?-1:1}(i,a)}}catch{}return NaN}function Za(i){var a=typeof i;return a!="object"?a:ArrayBuffer.isView(i)?"binary":(i=Ki(i),i==="ArrayBuffer"?"binary":i)}function eo(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i)}var to=(ve.prototype._trans=function(i,a,l){var u=this._tx||ee.trans,d=this.name,p=Ge&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(i==="readonly"?"read":"write"," ").concat(this.name));function y(S,T,v){if(!v.schema[d])throw new ie.NotFound("Table "+d+" not part of transaction");return a(v.idbtrans,v)}var g=Zt();try{var w=u&&u.db._novip===this.db._novip?u===ee.trans?u._promise(i,y,l):dt(function(){return u._promise(i,y,l)},{trans:u,transless:ee.transless||ee}):function S(T,v,O,k){if(T.idbdb&&(T._state.openComplete||ee.letThrough||T._vip)){var E=T._createTransaction(v,O,T._dbSchema);try{E.create(),T._state.PR1398_maxLoop=3}catch(C){return C.name===Fi.InvalidState&&T.isOpen()&&0<--T._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),T.close({disableAutoOpen:!1}),T.open().then(function(){return S(T,v,O,k)})):_e(C)}return E._promise(v,function(C,_){return dt(function(){return ee.trans=E,k(C,_,E)})}).then(function(C){if(v==="readwrite")try{E.idbtrans.commit()}catch{}return v==="readonly"?C:E._completion.then(function(){return C})})}if(T._state.openComplete)return _e(new ie.DatabaseClosed(T._state.dbOpenError));if(!T._state.isBeingOpened){if(!T._state.autoOpen)return _e(new ie.DatabaseClosed);T.open().catch(pe)}return T._state.dbReadyPromise.then(function(){return S(T,v,O,k)})}(this.db,i,[this.name],y);return p&&(w._consoleTask=p,w=w.catch(function(S){return console.trace(S),_e(S)})),w}finally{g&&en()}},ve.prototype.get=function(i,a){var l=this;return i&&i.constructor===Object?this.where(i).first(a):i==null?_e(new ie.Type("Invalid argument to Table.get()")):this._trans("readonly",function(u){return l.core.get({trans:u,key:i}).then(function(d){return l.hook.reading.fire(d)})}).then(a)},ve.prototype.where=function(i){if(typeof i=="string")return new this.db.WhereClause(this,i);if(f(i))return new this.db.WhereClause(this,"[".concat(i.join("+"),"]"));var a=c(i);if(a.length===1)return this.where(a[0]).equals(i[a[0]]);var l=this.schema.indexes.concat(this.schema.primKey).filter(function(g){if(g.compound&&a.every(function(S){return 0<=g.keyPath.indexOf(S)})){for(var w=0;w<a.length;++w)if(a.indexOf(g.keyPath[w])===-1)return!1;return!0}return!1}).sort(function(g,w){return g.keyPath.length-w.keyPath.length})[0];if(l&&this.db._maxKey!==xt){var p=l.keyPath.slice(0,a.length);return this.where(p).equals(p.map(function(w){return i[w]}))}!l&&Ge&&console.warn("The query ".concat(JSON.stringify(i)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(a.join("+"),"]"));var u=this.schema.idxByName;function d(g,w){return fe(g,w)===0}var y=a.reduce(function(v,w){var S=v[0],T=v[1],v=u[w],O=i[w];return[S||v,S||!v?Pt(T,v&&v.multi?function(k){return k=ne(k,w),f(k)&&k.some(function(E){return d(O,E)})}:function(k){return d(O,ne(k,w))}):T]},[null,null]),p=y[0],y=y[1];return p?this.where(p.name).equals(i[p.keyPath]).filter(y):l?this.filter(y):this.where(a).equals("")},ve.prototype.filter=function(i){return this.toCollection().and(i)},ve.prototype.count=function(i){return this.toCollection().count(i)},ve.prototype.offset=function(i){return this.toCollection().offset(i)},ve.prototype.limit=function(i){return this.toCollection().limit(i)},ve.prototype.each=function(i){return this.toCollection().each(i)},ve.prototype.toArray=function(i){return this.toCollection().toArray(i)},ve.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},ve.prototype.orderBy=function(i){return new this.db.Collection(new this.db.WhereClause(this,f(i)?"[".concat(i.join("+"),"]"):i))},ve.prototype.reverse=function(){return this.toCollection().reverse()},ve.prototype.mapToClass=function(i){var a,l=this.db,u=this.name;function d(){return a!==null&&a.apply(this,arguments)||this}(this.schema.mappedClass=i).prototype instanceof Xa&&(function(w,S){if(typeof S!="function"&&S!==null)throw new TypeError("Class extends value "+String(S)+" is not a constructor or null");function T(){this.constructor=w}t(w,S),w.prototype=S===null?Object.create(S):(T.prototype=S.prototype,new T)}(d,a=i),Object.defineProperty(d.prototype,"db",{get:function(){return l},enumerable:!1,configurable:!0}),d.prototype.table=function(){return u},i=d);for(var p=new Set,y=i.prototype;y;y=m(y))Object.getOwnPropertyNames(y).forEach(function(w){return p.add(w)});function g(w){if(!w)return w;var S,T=Object.create(i.prototype);for(S in w)if(!p.has(S))try{T[S]=w[S]}catch{}return T}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=g,this.hook("reading",g),i},ve.prototype.defineClass=function(){return this.mapToClass(function(i){h(this,i)})},ve.prototype.add=function(i,a){var l=this,u=this.schema.primKey,d=u.auto,p=u.keyPath,y=i;return p&&d&&(y=Ns(p)(i)),this._trans("readwrite",function(g){return l.core.mutate({trans:g,type:"add",keys:a!=null?[a]:null,values:[y]})}).then(function(g){return g.numFailures?Y.reject(g.failures[0]):g.lastResult}).then(function(g){if(p)try{oe(i,p,g)}catch{}return g})},ve.prototype.update=function(i,a){return typeof i!="object"||f(i)?this.where(":id").equals(i).modify(a):(i=ne(i,this.schema.primKey.keyPath),i===void 0?_e(new ie.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(i).modify(a))},ve.prototype.put=function(i,a){var l=this,u=this.schema.primKey,d=u.auto,p=u.keyPath,y=i;return p&&d&&(y=Ns(p)(i)),this._trans("readwrite",function(g){return l.core.mutate({trans:g,type:"put",values:[y],keys:a!=null?[a]:null})}).then(function(g){return g.numFailures?Y.reject(g.failures[0]):g.lastResult}).then(function(g){if(p)try{oe(i,p,g)}catch{}return g})},ve.prototype.delete=function(i){var a=this;return this._trans("readwrite",function(l){return a.core.mutate({trans:l,type:"delete",keys:[i]})}).then(function(l){return l.numFailures?Y.reject(l.failures[0]):void 0})},ve.prototype.clear=function(){var i=this;return this._trans("readwrite",function(a){return i.core.mutate({trans:a,type:"deleteRange",range:Qa})}).then(function(a){return a.numFailures?Y.reject(a.failures[0]):void 0})},ve.prototype.bulkGet=function(i){var a=this;return this._trans("readonly",function(l){return a.core.getMany({keys:i,trans:l}).then(function(u){return u.map(function(d){return a.hook.reading.fire(d)})})})},ve.prototype.bulkAdd=function(i,a,l){var u=this,d=Array.isArray(a)?a:void 0,p=(l=l||(d?void 0:a))?l.allKeys:void 0;return this._trans("readwrite",function(y){var S=u.schema.primKey,g=S.auto,S=S.keyPath;if(S&&d)throw new ie.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(d&&d.length!==i.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var w=i.length,S=S&&g?i.map(Ns(S)):i;return u.core.mutate({trans:y,type:"add",keys:d,values:S,wantResults:p}).then(function(E){var v=E.numFailures,O=E.results,k=E.lastResult,E=E.failures;if(v===0)return p?O:k;throw new Xt("".concat(u.name,".bulkAdd(): ").concat(v," of ").concat(w," operations failed"),E)})})},ve.prototype.bulkPut=function(i,a,l){var u=this,d=Array.isArray(a)?a:void 0,p=(l=l||(d?void 0:a))?l.allKeys:void 0;return this._trans("readwrite",function(y){var S=u.schema.primKey,g=S.auto,S=S.keyPath;if(S&&d)throw new ie.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(d&&d.length!==i.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var w=i.length,S=S&&g?i.map(Ns(S)):i;return u.core.mutate({trans:y,type:"put",keys:d,values:S,wantResults:p}).then(function(E){var v=E.numFailures,O=E.results,k=E.lastResult,E=E.failures;if(v===0)return p?O:k;throw new Xt("".concat(u.name,".bulkPut(): ").concat(v," of ").concat(w," operations failed"),E)})})},ve.prototype.bulkUpdate=function(i){var a=this,l=this.core,u=i.map(function(y){return y.key}),d=i.map(function(y){return y.changes}),p=[];return this._trans("readwrite",function(y){return l.getMany({trans:y,keys:u,cache:"clone"}).then(function(g){var w=[],S=[];i.forEach(function(v,O){var k=v.key,E=v.changes,C=g[O];if(C){for(var _=0,x=Object.keys(E);_<x.length;_++){var D=x[_],B=E[D];if(D===a.schema.primKey.keyPath){if(fe(B,k)!==0)throw new ie.Constraint("Cannot update primary key in bulkUpdate()")}else oe(C,D,B)}p.push(O),w.push(k),S.push(C)}});var T=w.length;return l.mutate({trans:y,type:"put",keys:w,values:S,updates:{keys:u,changeSpecs:d}}).then(function(v){var O=v.numFailures,k=v.failures;if(O===0)return T;for(var E=0,C=Object.keys(k);E<C.length;E++){var _,x=C[E],D=p[Number(x)];D!=null&&(_=k[x],delete k[x],k[D]=_)}throw new Xt("".concat(a.name,".bulkUpdate(): ").concat(O," of ").concat(T," operations failed"),k)})})})},ve.prototype.bulkDelete=function(i){var a=this,l=i.length;return this._trans("readwrite",function(u){return a.core.mutate({trans:u,type:"delete",keys:i})}).then(function(y){var d=y.numFailures,p=y.lastResult,y=y.failures;if(d===0)return p;throw new Xt("".concat(a.name,".bulkDelete(): ").concat(d," of ").concat(l," operations failed"),y)})},ve);function ve(){}function Kn(i){function a(y,g){if(g){for(var w=arguments.length,S=new Array(w-1);--w;)S[w-1]=arguments[w];return l[y].subscribe.apply(null,S),i}if(typeof y=="string")return l[y]}var l={};a.addEventType=p;for(var u=1,d=arguments.length;u<d;++u)p(arguments[u]);return a;function p(y,g,w){if(typeof y!="object"){var S;g=g||ru;var T={subscribers:[],fire:w=w||pe,subscribe:function(v){T.subscribers.indexOf(v)===-1&&(T.subscribers.push(v),T.fire=g(T.fire,v))},unsubscribe:function(v){T.subscribers=T.subscribers.filter(function(O){return O!==v}),T.fire=T.subscribers.reduce(g,w)}};return l[y]=a[y]=T}c(S=y).forEach(function(v){var O=S[v];if(f(O))p(v,S[v][0],S[v][1]);else{if(O!=="asap")throw new ie.InvalidArgument("Invalid event config");var k=p(v,Pn,function(){for(var E=arguments.length,C=new Array(E);E--;)C[E]=arguments[E];k.subscribers.forEach(function(_){te(function(){_.apply(null,C)})})})}})}}function qn(i,a){return L(a).from({prototype:i}),a}function sn(i,a){return!(i.filter||i.algorithm||i.or)&&(a?i.justLimit:!i.replayFilter)}function er(i,a){i.filter=Pt(i.filter,a)}function tr(i,a,l){var u=i.replayFilter;i.replayFilter=u?function(){return Pt(u(),a())}:a,i.justLimit=l&&!u}function $s(i,a){if(i.isPrimKey)return a.primaryKey;var l=a.getIndexByKeyPath(i.index);if(!l)throw new ie.Schema("KeyPath "+i.index+" on object store "+a.name+" is not indexed");return l}function no(i,a,l){var u=$s(i,a.schema);return a.openCursor({trans:l,values:!i.keysOnly,reverse:i.dir==="prev",unique:!!i.unique,query:{index:u,range:i.range}})}function xs(i,a,l,u){var d=i.replayFilter?Pt(i.filter,i.replayFilter()):i.filter;if(i.or){var p={},y=function(g,w,S){var T,v;d&&!d(w,S,function(O){return w.stop(O)},function(O){return w.fail(O)})||((v=""+(T=w.primaryKey))=="[object ArrayBuffer]"&&(v=""+new Uint8Array(T)),b(p,v)||(p[v]=!0,a(g,w,S)))};return Promise.all([i.or._iterate(y,l),so(no(i,u,l),i.algorithm,y,!i.keysOnly&&i.valueMapper)])}return so(no(i,u,l),Pt(i.algorithm,d),a,!i.keysOnly&&i.valueMapper)}function so(i,a,l,u){var d=be(u?function(p,y,g){return l(u(p),y,g)}:l);return i.then(function(p){if(p)return p.start(function(){var y=function(){return p.continue()};a&&!a(p,function(g){return y=g},function(g){p.stop(g),y=pe},function(g){p.fail(g),y=pe})||d(p.value,p,function(g){return y=g}),y()})})}var Rn=(io.prototype.execute=function(i){var a=this["@@propmod"];if(a.add!==void 0){var l=a.add;if(f(l))return r(r([],f(i)?i:[],!0),l).sort();if(typeof l=="number")return(Number(i)||0)+l;if(typeof l=="bigint")try{return BigInt(i)+l}catch{return BigInt(0)+l}throw new TypeError("Invalid term ".concat(l))}if(a.remove!==void 0){var u=a.remove;if(f(u))return f(i)?i.filter(function(d){return!u.includes(d)}).sort():[];if(typeof u=="number")return Number(i)-u;if(typeof u=="bigint")try{return BigInt(i)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return l=(l=a.replacePrefix)===null||l===void 0?void 0:l[0],l&&typeof i=="string"&&i.startsWith(l)?a.replacePrefix[1]+i.substring(l.length):i},io);function io(i){this["@@propmod"]=i}var fu=(he.prototype._read=function(i,a){var l=this._ctx;return l.error?l.table._trans(null,_e.bind(null,l.error)):l.table._trans("readonly",i).then(a)},he.prototype._write=function(i){var a=this._ctx;return a.error?a.table._trans(null,_e.bind(null,a.error)):a.table._trans("readwrite",i,"locked")},he.prototype._addAlgorithm=function(i){var a=this._ctx;a.algorithm=Pt(a.algorithm,i)},he.prototype._iterate=function(i,a){return xs(this._ctx,i,a,this._ctx.table.core)},he.prototype.clone=function(i){var a=Object.create(this.constructor.prototype),l=Object.create(this._ctx);return i&&h(l,i),a._ctx=l,a},he.prototype.raw=function(){return this._ctx.valueMapper=null,this},he.prototype.each=function(i){var a=this._ctx;return this._read(function(l){return xs(a,i,l,a.table.core)})},he.prototype.count=function(i){var a=this;return this._read(function(l){var u=a._ctx,d=u.table.core;if(sn(u,!0))return d.count({trans:l,query:{index:$s(u,d.schema),range:u.range}}).then(function(y){return Math.min(y,u.limit)});var p=0;return xs(u,function(){return++p,!1},l,d).then(function(){return p})}).then(i)},he.prototype.sortBy=function(i,a){var l=i.split(".").reverse(),u=l[0],d=l.length-1;function p(w,S){return S?p(w[l[S]],S-1):w[u]}var y=this._ctx.dir==="next"?1:-1;function g(w,S){return fe(p(w,d),p(S,d))*y}return this.toArray(function(w){return w.sort(g)}).then(a)},he.prototype.toArray=function(i){var a=this;return this._read(function(l){var u=a._ctx;if(u.dir==="next"&&sn(u,!0)&&0<u.limit){var d=u.valueMapper,p=$s(u,u.table.core.schema);return u.table.core.query({trans:l,limit:u.limit,values:!0,query:{index:p,range:u.range}}).then(function(g){return g=g.result,d?g.map(d):g})}var y=[];return xs(u,function(g){return y.push(g)},l,u.table.core).then(function(){return y})},i)},he.prototype.offset=function(i){var a=this._ctx;return i<=0||(a.offset+=i,sn(a)?tr(a,function(){var l=i;return function(u,d){return l===0||(l===1?--l:d(function(){u.advance(l),l=0}),!1)}}):tr(a,function(){var l=i;return function(){return--l<0}})),this},he.prototype.limit=function(i){return this._ctx.limit=Math.min(this._ctx.limit,i),tr(this._ctx,function(){var a=i;return function(l,u,d){return--a<=0&&u(d),0<=a}},!0),this},he.prototype.until=function(i,a){return er(this._ctx,function(l,u,d){return!i(l.value)||(u(d),a)}),this},he.prototype.first=function(i){return this.limit(1).toArray(function(a){return a[0]}).then(i)},he.prototype.last=function(i){return this.reverse().first(i)},he.prototype.filter=function(i){var a;return er(this._ctx,function(l){return i(l.value)}),(a=this._ctx).isMatch=Pt(a.isMatch,i),this},he.prototype.and=function(i){return this.filter(i)},he.prototype.or=function(i){return new this.db.WhereClause(this._ctx.table,i,this)},he.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},he.prototype.desc=function(){return this.reverse()},he.prototype.eachKey=function(i){var a=this._ctx;return a.keysOnly=!a.isMatch,this.each(function(l,u){i(u.key,u)})},he.prototype.eachUniqueKey=function(i){return this._ctx.unique="unique",this.eachKey(i)},he.prototype.eachPrimaryKey=function(i){var a=this._ctx;return a.keysOnly=!a.isMatch,this.each(function(l,u){i(u.primaryKey,u)})},he.prototype.keys=function(i){var a=this._ctx;a.keysOnly=!a.isMatch;var l=[];return this.each(function(u,d){l.push(d.key)}).then(function(){return l}).then(i)},he.prototype.primaryKeys=function(i){var a=this._ctx;if(a.dir==="next"&&sn(a,!0)&&0<a.limit)return this._read(function(u){var d=$s(a,a.table.core.schema);return a.table.core.query({trans:u,values:!1,limit:a.limit,query:{index:d,range:a.range}})}).then(function(u){return u.result}).then(i);a.keysOnly=!a.isMatch;var l=[];return this.each(function(u,d){l.push(d.primaryKey)}).then(function(){return l}).then(i)},he.prototype.uniqueKeys=function(i){return this._ctx.unique="unique",this.keys(i)},he.prototype.firstKey=function(i){return this.limit(1).keys(function(a){return a[0]}).then(i)},he.prototype.lastKey=function(i){return this.reverse().firstKey(i)},he.prototype.distinct=function(){var i=this._ctx,i=i.index&&i.table.schema.idxByName[i.index];if(!i||!i.multi)return this;var a={};return er(this._ctx,function(d){var u=d.primaryKey.toString(),d=b(a,u);return a[u]=!0,!d}),this},he.prototype.modify=function(i){var a=this,l=this._ctx;return this._write(function(u){var d,p,y;y=typeof i=="function"?i:(d=c(i),p=d.length,function(_){for(var x=!1,D=0;D<p;++D){var B=d[D],j=i[B],q=ne(_,B);j instanceof Rn?(oe(_,B,j.execute(q)),x=!0):q!==j&&(oe(_,B,j),x=!0)}return x});var g=l.table.core,v=g.schema.primaryKey,w=v.outbound,S=v.extractKey,T=200,v=a.db._options.modifyChunkSize;v&&(T=typeof v=="object"?v[g.name]||v["*"]||200:v);function O(_,B){var D=B.failures,B=B.numFailures;E+=_-B;for(var j=0,q=c(D);j<q.length;j++){var U=q[j];k.push(D[U])}}var k=[],E=0,C=[];return a.clone().primaryKeys().then(function(_){function x(B){var j=Math.min(T,_.length-B);return g.getMany({trans:u,keys:_.slice(B,B+j),cache:"immutable"}).then(function(q){for(var U=[],R=[],F=w?[]:null,V=[],H=0;H<j;++H){var W=q[H],ce={value:We(W),primKey:_[B+H]};y.call(ce,ce.value,ce)!==!1&&(ce.value==null?V.push(_[B+H]):w||fe(S(W),S(ce.value))===0?(R.push(ce.value),w&&F.push(_[B+H])):(V.push(_[B+H]),U.push(ce.value)))}return Promise.resolve(0<U.length&&g.mutate({trans:u,type:"add",values:U}).then(function(le){for(var ue in le.failures)V.splice(parseInt(ue),1);O(U.length,le)})).then(function(){return(0<R.length||D&&typeof i=="object")&&g.mutate({trans:u,type:"put",keys:F,values:R,criteria:D,changeSpec:typeof i!="function"&&i,isAdditionalChunk:0<B}).then(function(le){return O(R.length,le)})}).then(function(){return(0<V.length||D&&i===nr)&&g.mutate({trans:u,type:"delete",keys:V,criteria:D,isAdditionalChunk:0<B}).then(function(le){return O(V.length,le)})}).then(function(){return _.length>B+j&&x(B+T)})})}var D=sn(l)&&l.limit===1/0&&(typeof i!="function"||i===nr)&&{index:l.index,range:l.range};return x(0).then(function(){if(0<k.length)throw new ws("Error modifying one or more objects",k,E,C);return _.length})})})},he.prototype.delete=function(){var i=this._ctx,a=i.range;return sn(i)&&(i.isPrimKey||a.type===3)?this._write(function(l){var u=i.table.core.schema.primaryKey,d=a;return i.table.core.count({trans:l,query:{index:u,range:d}}).then(function(p){return i.table.core.mutate({trans:l,type:"deleteRange",range:d}).then(function(y){var g=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new ws("Could not delete some values",Object.keys(g).map(function(w){return g[w]}),p-y);return p-y})})}):this.modify(nr)},he);function he(){}var nr=function(i,a){return a.value=null};function du(i,a){return i<a?-1:i===a?0:1}function hu(i,a){return a<i?-1:i===a?0:1}function Ke(i,a,l){return i=i instanceof ao?new i.Collection(i):i,i._ctx.error=new(l||TypeError)(a),i}function rn(i){return new i.Collection(i,function(){return ro("")}).limit(0)}function Ps(i,a,l,u){var d,p,y,g,w,S,T,v=l.length;if(!l.every(function(E){return typeof E=="string"}))return Ke(i,Ga);function O(E){d=E==="next"?function(_){return _.toUpperCase()}:function(_){return _.toLowerCase()},p=E==="next"?function(_){return _.toLowerCase()}:function(_){return _.toUpperCase()},y=E==="next"?du:hu;var C=l.map(function(_){return{lower:p(_),upper:d(_)}}).sort(function(_,x){return y(_.lower,x.lower)});g=C.map(function(_){return _.upper}),w=C.map(function(_){return _.lower}),T=(S=E)==="next"?"":u}O("next"),i=new i.Collection(i,function(){return mt(g[0],w[v-1]+u)}),i._ondirectionchange=function(E){O(E)};var k=0;return i._addAlgorithm(function(E,C,_){var x=E.key;if(typeof x!="string")return!1;var D=p(x);if(a(D,w,k))return!0;for(var B=null,j=k;j<v;++j){var q=function(U,R,F,V,H,W){for(var ce=Math.min(U.length,V.length),le=-1,ue=0;ue<ce;++ue){var qe=R[ue];if(qe!==V[ue])return H(U[ue],F[ue])<0?U.substr(0,ue)+F[ue]+F.substr(ue+1):H(U[ue],V[ue])<0?U.substr(0,ue)+V[ue]+F.substr(ue+1):0<=le?U.substr(0,le)+R[le]+F.substr(le+1):null;H(U[ue],qe)<0&&(le=ue)}return ce<V.length&&W==="next"?U+F.substr(U.length):ce<U.length&&W==="prev"?U.substr(0,F.length):le<0?null:U.substr(0,le)+V[le]+F.substr(le+1)}(x,D,g[j],w[j],y,S);q===null&&B===null?k=j+1:(B===null||0<y(B,q))&&(B=q)}return C(B!==null?function(){E.continue(B+T)}:_),!1}),i}function mt(i,a,l,u){return{type:2,lower:i,upper:a,lowerOpen:l,upperOpen:u}}function ro(i){return{type:1,lower:i,upper:i}}var ao=(Object.defineProperty(Le.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Le.prototype.between=function(i,a,l,u){l=l!==!1,u=u===!0;try{return 0<this._cmp(i,a)||this._cmp(i,a)===0&&(l||u)&&(!l||!u)?rn(this):new this.Collection(this,function(){return mt(i,a,!l,!u)})}catch{return Ke(this,it)}},Le.prototype.equals=function(i){return i==null?Ke(this,it):new this.Collection(this,function(){return ro(i)})},Le.prototype.above=function(i){return i==null?Ke(this,it):new this.Collection(this,function(){return mt(i,void 0,!0)})},Le.prototype.aboveOrEqual=function(i){return i==null?Ke(this,it):new this.Collection(this,function(){return mt(i,void 0,!1)})},Le.prototype.below=function(i){return i==null?Ke(this,it):new this.Collection(this,function(){return mt(void 0,i,!1,!0)})},Le.prototype.belowOrEqual=function(i){return i==null?Ke(this,it):new this.Collection(this,function(){return mt(void 0,i)})},Le.prototype.startsWith=function(i){return typeof i!="string"?Ke(this,Ga):this.between(i,i+xt,!0,!0)},Le.prototype.startsWithIgnoreCase=function(i){return i===""?this.startsWith(i):Ps(this,function(a,l){return a.indexOf(l[0])===0},[i],xt)},Le.prototype.equalsIgnoreCase=function(i){return Ps(this,function(a,l){return a===l[0]},[i],"")},Le.prototype.anyOfIgnoreCase=function(){var i=st.apply(Gt,arguments);return i.length===0?rn(this):Ps(this,function(a,l){return l.indexOf(a)!==-1},i,"")},Le.prototype.startsWithAnyOfIgnoreCase=function(){var i=st.apply(Gt,arguments);return i.length===0?rn(this):Ps(this,function(a,l){return l.some(function(u){return a.indexOf(u)===0})},i,xt)},Le.prototype.anyOf=function(){var i=this,a=st.apply(Gt,arguments),l=this._cmp;try{a.sort(l)}catch{return Ke(this,it)}if(a.length===0)return rn(this);var u=new this.Collection(this,function(){return mt(a[0],a[a.length-1])});u._ondirectionchange=function(p){l=p==="next"?i._ascending:i._descending,a.sort(l)};var d=0;return u._addAlgorithm(function(p,y,g){for(var w=p.key;0<l(w,a[d]);)if(++d===a.length)return y(g),!1;return l(w,a[d])===0||(y(function(){p.continue(a[d])}),!1)}),u},Le.prototype.notEqual=function(i){return this.inAnyRange([[-1/0,i],[i,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Le.prototype.noneOf=function(){var i=st.apply(Gt,arguments);if(i.length===0)return new this.Collection(this);try{i.sort(this._ascending)}catch{return Ke(this,it)}var a=i.reduce(function(l,u){return l?l.concat([[l[l.length-1][1],u]]):[[-1/0,u]]},null);return a.push([i[i.length-1],this.db._maxKey]),this.inAnyRange(a,{includeLowers:!1,includeUppers:!1})},Le.prototype.inAnyRange=function(x,a){var l=this,u=this._cmp,d=this._ascending,p=this._descending,y=this._min,g=this._max;if(x.length===0)return rn(this);if(!x.every(function(D){return D[0]!==void 0&&D[1]!==void 0&&d(D[0],D[1])<=0}))return Ke(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ie.InvalidArgument);var w=!a||a.includeLowers!==!1,S=a&&a.includeUppers===!0,T,v=d;function O(D,B){return v(D[0],B[0])}try{(T=x.reduce(function(D,B){for(var j=0,q=D.length;j<q;++j){var U=D[j];if(u(B[0],U[1])<0&&0<u(B[1],U[0])){U[0]=y(U[0],B[0]),U[1]=g(U[1],B[1]);break}}return j===q&&D.push(B),D},[])).sort(O)}catch{return Ke(this,it)}var k=0,E=S?function(D){return 0<d(D,T[k][1])}:function(D){return 0<=d(D,T[k][1])},C=w?function(D){return 0<p(D,T[k][0])}:function(D){return 0<=p(D,T[k][0])},_=E,x=new this.Collection(this,function(){return mt(T[0][0],T[T.length-1][1],!w,!S)});return x._ondirectionchange=function(D){v=D==="next"?(_=E,d):(_=C,p),T.sort(O)},x._addAlgorithm(function(D,B,j){for(var q,U=D.key;_(U);)if(++k===T.length)return B(j),!1;return!E(q=U)&&!C(q)||(l._cmp(U,T[k][1])===0||l._cmp(U,T[k][0])===0||B(function(){v===d?D.continue(T[k][0]):D.continue(T[k][1])}),!1)}),x},Le.prototype.startsWithAnyOf=function(){var i=st.apply(Gt,arguments);return i.every(function(a){return typeof a=="string"})?i.length===0?rn(this):this.inAnyRange(i.map(function(a){return[a,a+xt]})):Ke(this,"startsWithAnyOf() only works with strings")},Le);function Le(){}function Qe(i){return be(function(a){return Fn(a),i(a.target.error),!1})}function Fn(i){i.stopPropagation&&i.stopPropagation(),i.preventDefault&&i.preventDefault()}var Hn="storagemutated",sr="x-storagemutated-1",yt=Kn(null,Hn),pu=(Xe.prototype._lock=function(){return Q(!ee.global),++this._reculock,this._reculock!==1||ee.global||(ee.lockOwnerFor=this),this},Xe.prototype._unlock=function(){if(Q(!ee.global),--this._reculock==0)for(ee.global||(ee.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var i=this._blockedFuncs.shift();try{$t(i[1],i[0])}catch{}}return this},Xe.prototype._locked=function(){return this._reculock&&ee.lockOwnerFor!==this},Xe.prototype.create=function(i){var a=this;if(!this.mode)return this;var l=this.db.idbdb,u=this.db._state.dbOpenError;if(Q(!this.idbtrans),!i&&!l)switch(u&&u.name){case"DatabaseClosedError":throw new ie.DatabaseClosed(u);case"MissingAPIError":throw new ie.MissingAPI(u.message,u);default:throw new ie.OpenFailed(u)}if(!this.active)throw new ie.TransactionInactive;return Q(this._completion._state===null),(i=this.idbtrans=i||(this.db.core||l).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=be(function(d){Fn(d),a._reject(i.error)}),i.onabort=be(function(d){Fn(d),a.active&&a._reject(new ie.Abort(i.error)),a.active=!1,a.on("abort").fire(d)}),i.oncomplete=be(function(){a.active=!1,a._resolve(),"mutatedParts"in i&&yt.storagemutated.fire(i.mutatedParts)}),this},Xe.prototype._promise=function(i,a,l){var u=this;if(i==="readwrite"&&this.mode!=="readwrite")return _e(new ie.ReadOnly("Transaction is readonly"));if(!this.active)return _e(new ie.TransactionInactive);if(this._locked())return new Y(function(p,y){u._blockedFuncs.push([function(){u._promise(i,a,l).then(p,y)},ee])});if(l)return dt(function(){var p=new Y(function(y,g){u._lock();var w=a(y,g,u);w&&w.then&&w.then(y,g)});return p.finally(function(){return u._unlock()}),p._lib=!0,p});var d=new Y(function(p,y){var g=a(p,y,u);g&&g.then&&g.then(p,y)});return d._lib=!0,d},Xe.prototype._root=function(){return this.parent?this.parent._root():this},Xe.prototype.waitFor=function(i){var a,l=this._root(),u=Y.resolve(i);l._waitingFor?l._waitingFor=l._waitingFor.then(function(){return u}):(l._waitingFor=u,l._waitingQueue=[],a=l.idbtrans.objectStore(l.storeNames[0]),function p(){for(++l._spinCount;l._waitingQueue.length;)l._waitingQueue.shift()();l._waitingFor&&(a.get(-1/0).onsuccess=p)}());var d=l._waitingFor;return new Y(function(p,y){u.then(function(g){return l._waitingQueue.push(be(p.bind(null,g)))},function(g){return l._waitingQueue.push(be(y.bind(null,g)))}).finally(function(){l._waitingFor===d&&(l._waitingFor=null)})})},Xe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ie.Abort))},Xe.prototype.table=function(i){var a=this._memoizedTables||(this._memoizedTables={});if(b(a,i))return a[i];var l=this.schema[i];if(!l)throw new ie.NotFound("Table "+i+" not part of transaction");return l=new this.db.Table(i,l,this),l.core=this.db.core.table(i),a[i]=l},Xe);function Xe(){}function ir(i,a,l,u,d,p,y){return{name:i,keyPath:a,unique:l,multi:u,auto:d,compound:p,src:(l&&!y?"&":"")+(u?"*":"")+(d?"++":"")+oo(a)}}function oo(i){return typeof i=="string"?i:i?"["+[].join.call(i,"+")+"]":""}function rr(i,a,l){return{name:i,primKey:a,indexes:l,mappedClass:null,idxByName:(u=function(d){return[d.name,d]},l.reduce(function(d,p,y){return y=u(p,y),y&&(d[y[0]]=y[1]),d},{}))};var u}var Un=function(i){try{return i.only([[]]),Un=function(){return[[]]},[[]]}catch{return Un=function(){return xt},xt}};function ar(i){return i==null?function(){}:typeof i=="string"?(a=i).split(".").length===1?function(l){return l[a]}:function(l){return ne(l,a)}:function(l){return ne(l,i)};var a}function co(i){return[].slice.call(i)}var mu=0;function zn(i){return i==null?":id":typeof i=="string"?i:"[".concat(i.join("+"),"]")}function yu(i,a,w){function u(_){if(_.type===3)return null;if(_.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var k=_.lower,E=_.upper,C=_.lowerOpen,_=_.upperOpen;return k===void 0?E===void 0?null:a.upperBound(E,!!_):E===void 0?a.lowerBound(k,!!C):a.bound(k,E,!!C,!!_)}function d(O){var k,E=O.name;return{name:E,schema:O,mutate:function(C){var _=C.trans,x=C.type,D=C.keys,B=C.values,j=C.range;return new Promise(function(q,U){q=be(q);var R=_.objectStore(E),F=R.keyPath==null,V=x==="put"||x==="add";if(!V&&x!=="delete"&&x!=="deleteRange")throw new Error("Invalid operation type: "+x);var H,W=(D||B||{length:1}).length;if(D&&B&&D.length!==B.length)throw new Error("Given keys array must have same length as given values array.");if(W===0)return q({numFailures:0,failures:{},results:[],lastResult:void 0});function ce(Pe){++qe,Fn(Pe)}var le=[],ue=[],qe=0;if(x==="deleteRange"){if(j.type===4)return q({numFailures:qe,failures:ue,results:[],lastResult:void 0});j.type===3?le.push(H=R.clear()):le.push(H=R.delete(u(j)))}else{var F=V?F?[B,D]:[B,null]:[D,null],ae=F[0],Ne=F[1];if(V)for(var $e=0;$e<W;++$e)le.push(H=Ne&&Ne[$e]!==void 0?R[x](ae[$e],Ne[$e]):R[x](ae[$e])),H.onerror=ce;else for($e=0;$e<W;++$e)le.push(H=R[x](ae[$e])),H.onerror=ce}function Ys(Pe){Pe=Pe.target.result,le.forEach(function(Bt,Ir){return Bt.error!=null&&(ue[Ir]=Bt.error)}),q({numFailures:qe,failures:ue,results:x==="delete"?D:le.map(function(Bt){return Bt.result}),lastResult:Pe})}H.onerror=function(Pe){ce(Pe),Ys(Pe)},H.onsuccess=Ys})},getMany:function(C){var _=C.trans,x=C.keys;return new Promise(function(D,B){D=be(D);for(var j,q=_.objectStore(E),U=x.length,R=new Array(U),F=0,V=0,H=function(le){le=le.target,R[le._pos]=le.result,++V===F&&D(R)},W=Qe(B),ce=0;ce<U;++ce)x[ce]!=null&&((j=q.get(x[ce]))._pos=ce,j.onsuccess=H,j.onerror=W,++F);F===0&&D(R)})},get:function(C){var _=C.trans,x=C.key;return new Promise(function(D,B){D=be(D);var j=_.objectStore(E).get(x);j.onsuccess=function(q){return D(q.target.result)},j.onerror=Qe(B)})},query:(k=S,function(C){return new Promise(function(_,x){_=be(_);var D,B,j,F=C.trans,q=C.values,U=C.limit,H=C.query,R=U===1/0?void 0:U,V=H.index,H=H.range,F=F.objectStore(E),V=V.isPrimaryKey?F:F.index(V.name),H=u(H);if(U===0)return _({result:[]});k?((R=q?V.getAll(H,R):V.getAllKeys(H,R)).onsuccess=function(W){return _({result:W.target.result})},R.onerror=Qe(x)):(D=0,B=!q&&"openKeyCursor"in V?V.openKeyCursor(H):V.openCursor(H),j=[],B.onsuccess=function(W){var ce=B.result;return ce?(j.push(q?ce.value:ce.primaryKey),++D===U?_({result:j}):void ce.continue()):_({result:j})},B.onerror=Qe(x))})}),openCursor:function(C){var _=C.trans,x=C.values,D=C.query,B=C.reverse,j=C.unique;return new Promise(function(q,U){q=be(q);var V=D.index,R=D.range,F=_.objectStore(E),F=V.isPrimaryKey?F:F.index(V.name),V=B?j?"prevunique":"prev":j?"nextunique":"next",H=!x&&"openKeyCursor"in F?F.openKeyCursor(u(R),V):F.openCursor(u(R),V);H.onerror=Qe(U),H.onsuccess=be(function(W){var ce,le,ue,qe,ae=H.result;ae?(ae.___id=++mu,ae.done=!1,ce=ae.continue.bind(ae),le=(le=ae.continuePrimaryKey)&&le.bind(ae),ue=ae.advance.bind(ae),qe=function(){throw new Error("Cursor not stopped")},ae.trans=_,ae.stop=ae.continue=ae.continuePrimaryKey=ae.advance=function(){throw new Error("Cursor not started")},ae.fail=be(U),ae.next=function(){var Ne=this,$e=1;return this.start(function(){return $e--?Ne.continue():Ne.stop()}).then(function(){return Ne})},ae.start=function(Ne){function $e(){if(H.result)try{Ne()}catch(Pe){ae.fail(Pe)}else ae.done=!0,ae.start=function(){throw new Error("Cursor behind last entry")},ae.stop()}var Ys=new Promise(function(Pe,Bt){Pe=be(Pe),H.onerror=Qe(Bt),ae.fail=Bt,ae.stop=function(Ir){ae.stop=ae.continue=ae.continuePrimaryKey=ae.advance=qe,Pe(Ir)}});return H.onsuccess=be(function(Pe){H.onsuccess=$e,$e()}),ae.continue=ce,ae.continuePrimaryKey=le,ae.advance=ue,$e(),Ys},q(ae)):q(null)},U)})},count:function(C){var _=C.query,x=C.trans,D=_.index,B=_.range;return new Promise(function(j,q){var U=x.objectStore(E),R=D.isPrimaryKey?U:U.index(D.name),U=u(B),R=U?R.count(U):R.count();R.onsuccess=be(function(F){return j(F.target.result)}),R.onerror=Qe(q)})}}}var p,y,g,T=(y=w,g=co((p=i).objectStoreNames),{schema:{name:p.name,tables:g.map(function(O){return y.objectStore(O)}).map(function(O){var k=O.keyPath,_=O.autoIncrement,E=f(k),C={},_={name:O.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:k==null,compound:E,keyPath:k,autoIncrement:_,unique:!0,extractKey:ar(k)},indexes:co(O.indexNames).map(function(x){return O.index(x)}).map(function(j){var D=j.name,B=j.unique,q=j.multiEntry,j=j.keyPath,q={name:D,compound:f(j),keyPath:j,unique:B,multiEntry:q,extractKey:ar(j)};return C[zn(j)]=q}),getIndexByKeyPath:function(x){return C[zn(x)]}};return C[":id"]=_.primaryKey,k!=null&&(C[zn(k)]=_.primaryKey),_})},hasGetAll:0<g.length&&"getAll"in y.objectStore(g[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),w=T.schema,S=T.hasGetAll,T=w.tables.map(d),v={};return T.forEach(function(O){return v[O.name]=O}),{stack:"dbcore",transaction:i.transaction.bind(i),table:function(O){if(!v[O])throw new Error("Table '".concat(O,"' not found"));return v[O]},MIN_KEY:-1/0,MAX_KEY:Un(a),schema:w}}function gu(i,a,l,u){var d=l.IDBKeyRange;return l.indexedDB,{dbcore:(u=yu(a,d,u),i.dbcore.reduce(function(p,y){return y=y.create,s(s({},p),y(p))},u))}}function Ms(i,u){var l=u.db,u=gu(i._middlewares,l,i._deps,u);i.core=u.dbcore,i.tables.forEach(function(d){var p=d.name;i.core.schema.tables.some(function(y){return y.name===p})&&(d.core=i.core.table(p),i[p]instanceof i.Table&&(i[p].core=d.core))})}function Ds(i,a,l,u){l.forEach(function(d){var p=u[d];a.forEach(function(y){var g=function w(S,T){return P(S,T)||(S=m(S))&&w(S,T)}(y,d);(!g||"value"in g&&g.value===void 0)&&(y===i.Transaction.prototype||y instanceof i.Transaction?M(y,d,{get:function(){return this.table(d)},set:function(w){$(this,d,{value:w,writable:!0,configurable:!0,enumerable:!0})}}):y[d]=new i.Table(d,p))})})}function or(i,a){a.forEach(function(l){for(var u in l)l[u]instanceof i.Table&&delete l[u]})}function vu(i,a){return i._cfg.version-a._cfg.version}function bu(i,a,l,u){var d=i._dbSchema;l.objectStoreNames.contains("$meta")&&!d.$meta&&(d.$meta=rr("$meta",uo("")[0],[]),i._storeNames.push("$meta"));var p=i._createTransaction("readwrite",i._storeNames,d);p.create(l),p._completion.catch(u);var y=p._reject.bind(p),g=ee.transless||ee;dt(function(){return ee.trans=p,ee.transless=g,a!==0?(Ms(i,l),S=a,((w=p).storeNames.includes("$meta")?w.table("$meta").get("version").then(function(T){return T??S}):Y.resolve(S)).then(function(T){return O=T,k=p,E=l,C=[],T=(v=i)._versions,_=v._dbSchema=js(0,v.idbdb,E),(T=T.filter(function(x){return x._cfg.version>=O})).length!==0?(T.forEach(function(x){C.push(function(){var D=_,B=x._cfg.dbschema;Ks(v,D,E),Ks(v,B,E),_=v._dbSchema=B;var j=cr(D,B);j.add.forEach(function(V){lr(E,V[0],V[1].primKey,V[1].indexes)}),j.change.forEach(function(V){if(V.recreate)throw new ie.Upgrade("Not yet support for changing primary key");var H=E.objectStore(V.name);V.add.forEach(function(W){return Bs(H,W)}),V.change.forEach(function(W){H.deleteIndex(W.name),Bs(H,W)}),V.del.forEach(function(W){return H.deleteIndex(W)})});var q=x._cfg.contentUpgrade;if(q&&x._cfg.version>O){Ms(v,E),k._memoizedTables={};var U=G(B);j.del.forEach(function(V){U[V]=D[V]}),or(v,[v.Transaction.prototype]),Ds(v,[v.Transaction.prototype],c(U),U),k.schema=U;var R,F=Ri(q);return F&&tn(),j=Y.follow(function(){var V;(R=q(k))&&F&&(V=ht.bind(null,null),R.then(V,V))}),R&&typeof R.then=="function"?Y.resolve(R):j.then(function(){return R})}}),C.push(function(D){var B,j,q=x._cfg.dbschema;B=q,j=D,[].slice.call(j.db.objectStoreNames).forEach(function(U){return B[U]==null&&j.db.deleteObjectStore(U)}),or(v,[v.Transaction.prototype]),Ds(v,[v.Transaction.prototype],v._storeNames,v._dbSchema),k.schema=v._dbSchema}),C.push(function(D){v.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(v.idbdb.version/10)===x._cfg.version?(v.idbdb.deleteObjectStore("$meta"),delete v._dbSchema.$meta,v._storeNames=v._storeNames.filter(function(B){return B!=="$meta"})):D.objectStore("$meta").put(x._cfg.version,"version"))})}),function x(){return C.length?Y.resolve(C.shift()(k.idbtrans)).then(x):Y.resolve()}().then(function(){lo(_,E)})):Y.resolve();var v,O,k,E,C,_}).catch(y)):(c(d).forEach(function(T){lr(l,T,d[T].primKey,d[T].indexes)}),Ms(i,l),void Y.follow(function(){return i.on.populate.fire(p)}).catch(y));var w,S})}function wu(i,a){lo(i._dbSchema,a),a.db.version%10!=0||a.objectStoreNames.contains("$meta")||a.db.createObjectStore("$meta").add(Math.ceil(a.db.version/10-1),"version");var l=js(0,i.idbdb,a);Ks(i,i._dbSchema,a);for(var u=0,d=cr(l,i._dbSchema).change;u<d.length;u++){var p=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var g=a.objectStore(y.name);y.add.forEach(function(w){Ge&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(w.src)),Bs(g,w)})}(d[u]);if(typeof p=="object")return p.value}}function cr(i,a){var l,u={del:[],add:[],change:[]};for(l in i)a[l]||u.del.push(l);for(l in a){var d=i[l],p=a[l];if(d){var y={name:l,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(d.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||d.primKey.auto!==p.primKey.auto)y.recreate=!0,u.change.push(y);else{var g=d.idxByName,w=p.idxByName,S=void 0;for(S in g)w[S]||y.del.push(S);for(S in w){var T=g[S],v=w[S];T?T.src!==v.src&&y.change.push(v):y.add.push(v)}(0<y.del.length||0<y.add.length||0<y.change.length)&&u.change.push(y)}}else u.add.push([l,p])}return u}function lr(i,a,l,u){var d=i.db.createObjectStore(a,l.keyPath?{keyPath:l.keyPath,autoIncrement:l.auto}:{autoIncrement:l.auto});return u.forEach(function(p){return Bs(d,p)}),d}function lo(i,a){c(i).forEach(function(l){a.db.objectStoreNames.contains(l)||(Ge&&console.debug("Dexie: Creating missing table",l),lr(a,l,i[l].primKey,i[l].indexes))})}function Bs(i,a){i.createIndex(a.name,a.keyPath,{unique:a.unique,multiEntry:a.multi})}function js(i,a,l){var u={};return J(a.objectStoreNames,0).forEach(function(d){for(var p=l.objectStore(d),y=ir(oo(S=p.keyPath),S||"",!0,!1,!!p.autoIncrement,S&&typeof S!="string",!0),g=[],w=0;w<p.indexNames.length;++w){var T=p.index(p.indexNames[w]),S=T.keyPath,T=ir(T.name,S,!!T.unique,!!T.multiEntry,!1,S&&typeof S!="string",!1);g.push(T)}u[d]=rr(d,y,g)}),u}function Ks(i,a,l){for(var u=l.db.objectStoreNames,d=0;d<u.length;++d){var p=u[d],y=l.objectStore(p);i._hasGetAll="getAll"in y;for(var g=0;g<y.indexNames.length;++g){var w=y.indexNames[g],S=y.index(w).keyPath,T=typeof S=="string"?S:"["+J(S).join("+")+"]";!a[p]||(S=a[p].idxByName[T])&&(S.name=w,delete a[p].idxByName[T],a[p].idxByName[w]=S)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(i._hasGetAll=!1)}function uo(i){return i.split(",").map(function(a,l){var u=(a=a.trim()).replace(/([&*]|\+\+)/g,""),d=/^\[/.test(u)?u.match(/^\[(.*)\]$/)[1].split("+"):u;return ir(u,d||null,/\&/.test(a),/\*/.test(a),/\+\+/.test(a),f(d),l===0)})}var ku=(qs.prototype._parseStoresSpec=function(i,a){c(i).forEach(function(l){if(i[l]!==null){var u=uo(i[l]),d=u.shift();if(d.unique=!0,d.multi)throw new ie.Schema("Primary key cannot be multi-valued");u.forEach(function(p){if(p.auto)throw new ie.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new ie.Schema("Index must have a name and cannot be an empty string")}),a[l]=rr(l,d,u)}})},qs.prototype.stores=function(l){var a=this.db;this._cfg.storesSource=this._cfg.storesSource?h(this._cfg.storesSource,l):l;var l=a._versions,u={},d={};return l.forEach(function(p){h(u,p._cfg.storesSource),d=p._cfg.dbschema={},p._parseStoresSpec(u,d)}),a._dbSchema=d,or(a,[a._allTables,a,a.Transaction.prototype]),Ds(a,[a._allTables,a,a.Transaction.prototype,this._cfg.tables],c(d),d),a._storeNames=c(d),this},qs.prototype.upgrade=function(i){return this._cfg.contentUpgrade=Hi(this._cfg.contentUpgrade||pe,i),this},qs);function qs(){}function ur(i,a){var l=i._dbNamesDB;return l||(l=i._dbNamesDB=new rt(Os,{addons:[],indexedDB:i,IDBKeyRange:a})).version(1).stores({dbnames:"name"}),l.table("dbnames")}function fr(i){return i&&typeof i.databases=="function"}function dr(i){return dt(function(){return ee.letThrough=!0,i()})}function hr(i){return!("from"in i)}var Oe=function(i,a){if(!this){var l=new Oe;return i&&"d"in i&&h(l,i),l}h(this,arguments.length?{d:1,from:i,to:1<arguments.length?a:i}:{d:0})};function Vn(i,a,l){var u=fe(a,l);if(!isNaN(u)){if(0<u)throw RangeError();if(hr(i))return h(i,{from:a,to:l,d:1});var d=i.l,u=i.r;if(fe(l,i.from)<0)return d?Vn(d,a,l):i.l={from:a,to:l,d:1,l:null,r:null},ho(i);if(0<fe(a,i.to))return u?Vn(u,a,l):i.r={from:a,to:l,d:1,l:null,r:null},ho(i);fe(a,i.from)<0&&(i.from=a,i.l=null,i.d=u?u.d+1:1),0<fe(l,i.to)&&(i.to=l,i.r=null,i.d=i.l?i.l.d+1:1),l=!i.r,d&&!i.l&&Yn(i,d),u&&l&&Yn(i,u)}}function Yn(i,a){hr(a)||function l(u,w){var p=w.from,y=w.to,g=w.l,w=w.r;Vn(u,p,y),g&&l(u,g),w&&l(u,w)}(i,a)}function fo(i,a){var l=Rs(a),u=l.next();if(u.done)return!1;for(var d=u.value,p=Rs(i),y=p.next(d.from),g=y.value;!u.done&&!y.done;){if(fe(g.from,d.to)<=0&&0<=fe(g.to,d.from))return!0;fe(d.from,g.from)<0?d=(u=l.next(g.from)).value:g=(y=p.next(d.from)).value}return!1}function Rs(i){var a=hr(i)?null:{s:0,n:i};return{next:function(l){for(var u=0<arguments.length;a;)switch(a.s){case 0:if(a.s=1,u)for(;a.n.l&&fe(l,a.n.from)<0;)a={up:a,n:a.n.l,s:1};else for(;a.n.l;)a={up:a,n:a.n.l,s:1};case 1:if(a.s=2,!u||fe(l,a.n.to)<=0)return{value:a.n,done:!1};case 2:if(a.n.r){a.s=3,a={up:a,n:a.n.r,s:0};continue}case 3:a=a.up}return{done:!0}}}}function ho(i){var a,l,u=(((a=i.r)===null||a===void 0?void 0:a.d)||0)-(((l=i.l)===null||l===void 0?void 0:l.d)||0),d=1<u?"r":u<-1?"l":"";d&&(a=d=="r"?"l":"r",l=s({},i),u=i[d],i.from=u.from,i.to=u.to,i[d]=u[d],l[d]=u[a],(i[a]=l).d=po(l)),i.d=po(i)}function po(l){var a=l.r,l=l.l;return(a?l?Math.max(a.d,l.d):a.d:l?l.d:0)+1}function Fs(i,a){return c(a).forEach(function(l){i[l]?Yn(i[l],a[l]):i[l]=function u(d){var p,y,g={};for(p in d)b(d,p)&&(y=d[p],g[p]=!y||typeof y!="object"||nt.has(y.constructor)?y:u(y));return g}(a[l])}),i}function pr(i,a){return i.all||a.all||Object.keys(i).some(function(l){return a[l]&&fo(a[l],i[l])})}N(Oe.prototype,((Fe={add:function(i){return Yn(this,i),this},addKey:function(i){return Vn(this,i,i),this},addKeys:function(i){var a=this;return i.forEach(function(l){return Vn(a,l,l)}),this},hasKey:function(i){var a=Rs(this).next(i).value;return a&&fe(a.from,i)<=0&&0<=fe(a.to,i)}})[qi]=function(){return Rs(this)},Fe));var Mt={},mr={},yr=!1;function Hs(i){Fs(mr,i),yr||(yr=!0,setTimeout(function(){yr=!1,gr(mr,!(mr={}))},0))}function gr(i,a){a===void 0&&(a=!1);var l=new Set;if(i.all)for(var u=0,d=Object.values(Mt);u<d.length;u++)mo(y=d[u],i,l,a);else for(var p in i){var y,g=/^idb\:\/\/(.*)\/(.*)\//.exec(p);g&&(p=g[1],g=g[2],(y=Mt["idb://".concat(p,"/").concat(g)])&&mo(y,i,l,a))}l.forEach(function(w){return w()})}function mo(i,a,l,u){for(var d=[],p=0,y=Object.entries(i.queries.query);p<y.length;p++){for(var g=y[p],w=g[0],S=[],T=0,v=g[1];T<v.length;T++){var O=v[T];pr(a,O.obsSet)?O.subscribers.forEach(function(_){return l.add(_)}):u&&S.push(O)}u&&d.push([w,S])}if(u)for(var k=0,E=d;k<E.length;k++){var C=E[k],w=C[0],S=C[1];i.queries.query[w]=S}}function Su(i){var a=i._state,l=i._deps.indexedDB;if(a.isBeingOpened||i.idbdb)return a.dbReadyPromise.then(function(){return a.dbOpenError?_e(a.dbOpenError):i});a.isBeingOpened=!0,a.dbOpenError=null,a.openComplete=!1;var u=a.openCanceller,d=Math.round(10*i.verno),p=!1;function y(){if(a.openCanceller!==u)throw new ie.DatabaseClosed("db.open() was cancelled")}function g(){return new Y(function(O,k){if(y(),!l)throw new ie.MissingAPI;var E=i.name,C=a.autoSchema||!d?l.open(E):l.open(E,d);if(!C)throw new ie.MissingAPI;C.onerror=Qe(k),C.onblocked=be(i._fireOnBlocked),C.onupgradeneeded=be(function(_){var x;T=C.transaction,a.autoSchema&&!i._options.allowEmptyDB?(C.onerror=Fn,T.abort(),C.result.close(),(x=l.deleteDatabase(E)).onsuccess=x.onerror=be(function(){k(new ie.NoSuchDatabase("Database ".concat(E," doesnt exist")))})):(T.onerror=Qe(k),_=_.oldVersion>Math.pow(2,62)?0:_.oldVersion,v=_<1,i.idbdb=C.result,p&&wu(i,T),bu(i,_/10,T,k))},k),C.onsuccess=be(function(){T=null;var _,x,D,B,j,q=i.idbdb=C.result,U=J(q.objectStoreNames);if(0<U.length)try{var R=q.transaction((B=U).length===1?B[0]:B,"readonly");if(a.autoSchema)x=q,D=R,(_=i).verno=x.version/10,D=_._dbSchema=js(0,x,D),_._storeNames=J(x.objectStoreNames,0),Ds(_,[_._allTables],c(D),D);else if(Ks(i,i._dbSchema,R),((j=cr(js(0,(j=i).idbdb,R),j._dbSchema)).add.length||j.change.some(function(F){return F.add.length||F.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),q.close(),d=q.version+1,p=!0,O(g());Ms(i,R)}catch{}nn.push(i),q.onversionchange=be(function(F){a.vcFired=!0,i.on("versionchange").fire(F)}),q.onclose=be(function(F){i.on("close").fire(F)}),v&&(j=i._deps,R=E,q=j.indexedDB,j=j.IDBKeyRange,fr(q)||R===Os||ur(q,j).put({name:R}).catch(pe)),O()},k)}).catch(function(O){switch(O==null?void 0:O.name){case"UnknownError":if(0<a.PR1398_maxLoop)return a.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),g();break;case"VersionError":if(0<d)return d=0,g()}return Y.reject(O)})}var w,S=a.dbReadyResolve,T=null,v=!1;return Y.race([u,(typeof navigator>"u"?Y.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(O){function k(){return indexedDB.databases().finally(O)}w=setInterval(k,100),k()}).finally(function(){return clearInterval(w)}):Promise.resolve()).then(g)]).then(function(){return y(),a.onReadyBeingFired=[],Y.resolve(dr(function(){return i.on.ready.fire(i.vip)})).then(function O(){if(0<a.onReadyBeingFired.length){var k=a.onReadyBeingFired.reduce(Hi,pe);return a.onReadyBeingFired=[],Y.resolve(dr(function(){return k(i.vip)})).then(O)}})}).finally(function(){a.openCanceller===u&&(a.onReadyBeingFired=null,a.isBeingOpened=!1)}).catch(function(O){a.dbOpenError=O;try{T&&T.abort()}catch{}return u===a.openCanceller&&i._close(),_e(O)}).finally(function(){a.openComplete=!0,S()}).then(function(){var O;return v&&(O={},i.tables.forEach(function(k){k.schema.indexes.forEach(function(E){E.name&&(O["idb://".concat(i.name,"/").concat(k.name,"/").concat(E.name)]=new Oe(-1/0,[[[]]]))}),O["idb://".concat(i.name,"/").concat(k.name,"/")]=O["idb://".concat(i.name,"/").concat(k.name,"/:dels")]=new Oe(-1/0,[[[]]])}),yt(Hn).fire(O),gr(O,!0)),i})}function vr(i){function a(p){return i.next(p)}var l=d(a),u=d(function(p){return i.throw(p)});function d(p){return function(w){var g=p(w),w=g.value;return g.done?w:w&&typeof w.then=="function"?w.then(l,u):f(w)?Promise.all(w).then(l,u):l(w)}}return d(a)()}function Us(i,a,l){for(var u=f(i)?i.slice():[i],d=0;d<l;++d)u.push(a);return u}var _u={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(i){return s(s({},i),{table:function(a){var l=i.table(a),u=l.schema,d={},p=[];function y(v,O,k){var E=zn(v),C=d[E]=d[E]||[],_=v==null?0:typeof v=="string"?1:v.length,x=0<O,x=s(s({},k),{name:x?"".concat(E,"(virtual-from:").concat(k.name,")"):k.name,lowLevelIndex:k,isVirtual:x,keyTail:O,keyLength:_,extractKey:ar(v),unique:!x&&k.unique});return C.push(x),x.isPrimaryKey||p.push(x),1<_&&y(_===2?v[0]:v.slice(0,_-1),O+1,k),C.sort(function(D,B){return D.keyTail-B.keyTail}),x}a=y(u.primaryKey.keyPath,0,u.primaryKey),d[":id"]=[a];for(var g=0,w=u.indexes;g<w.length;g++){var S=w[g];y(S.keyPath,0,S)}function T(v){var O,k=v.query.index;return k.isVirtual?s(s({},v),{query:{index:k.lowLevelIndex,range:(O=v.query.range,k=k.keyTail,{type:O.type===1?2:O.type,lower:Us(O.lower,O.lowerOpen?i.MAX_KEY:i.MIN_KEY,k),lowerOpen:!0,upper:Us(O.upper,O.upperOpen?i.MIN_KEY:i.MAX_KEY,k),upperOpen:!0})}}):v}return s(s({},l),{schema:s(s({},u),{primaryKey:a,indexes:p,getIndexByKeyPath:function(v){return(v=d[zn(v)])&&v[0]}}),count:function(v){return l.count(T(v))},query:function(v){return l.query(T(v))},openCursor:function(v){var O=v.query.index,k=O.keyTail,E=O.isVirtual,C=O.keyLength;return E?l.openCursor(T(v)).then(function(x){return x&&_(x)}):l.openCursor(v);function _(x){return Object.create(x,{continue:{value:function(D){D!=null?x.continue(Us(D,v.reverse?i.MAX_KEY:i.MIN_KEY,k)):v.unique?x.continue(x.key.slice(0,C).concat(v.reverse?i.MIN_KEY:i.MAX_KEY,k)):x.continue()}},continuePrimaryKey:{value:function(D,B){x.continuePrimaryKey(Us(D,i.MAX_KEY,k),B)}},primaryKey:{get:function(){return x.primaryKey}},key:{get:function(){var D=x.key;return C===1?D[0]:D.slice(0,C)}},value:{get:function(){return x.value}}})}}})}})}};function br(i,a,l,u){return l=l||{},u=u||"",c(i).forEach(function(d){var p,y,g;b(a,d)?(p=i[d],y=a[d],typeof p=="object"&&typeof y=="object"&&p&&y?(g=Ki(p))!==Ki(y)?l[u+d]=a[d]:g==="Object"?br(p,y,l,u+d+"."):p!==y&&(l[u+d]=a[d]):p!==y&&(l[u+d]=a[d])):l[u+d]=void 0}),c(a).forEach(function(d){b(i,d)||(l[u+d]=a[d])}),l}function wr(i,a){return a.type==="delete"?a.keys:a.keys||a.values.map(i.extractKey)}var Iu={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(i){return s(s({},i),{table:function(a){var l=i.table(a),u=l.schema.primaryKey;return s(s({},l),{mutate:function(d){var p=ee.trans,y=p.table(a).hook,g=y.deleting,w=y.creating,S=y.updating;switch(d.type){case"add":if(w.fire===pe)break;return p._promise("readwrite",function(){return T(d)},!0);case"put":if(w.fire===pe&&S.fire===pe)break;return p._promise("readwrite",function(){return T(d)},!0);case"delete":if(g.fire===pe)break;return p._promise("readwrite",function(){return T(d)},!0);case"deleteRange":if(g.fire===pe)break;return p._promise("readwrite",function(){return function v(O,k,E){return l.query({trans:O,values:!1,query:{index:u,range:k},limit:E}).then(function(C){var _=C.result;return T({type:"delete",keys:_,trans:O}).then(function(x){return 0<x.numFailures?Promise.reject(x.failures[0]):_.length<E?{failures:[],numFailures:0,lastResult:void 0}:v(O,s(s({},k),{lower:_[_.length-1],lowerOpen:!0}),E)})})}(d.trans,d.range,1e4)},!0)}return l.mutate(d);function T(v){var O,k,E,C=ee.trans,_=v.keys||wr(u,v);if(!_)throw new Error("Keys missing");return(v=v.type==="add"||v.type==="put"?s(s({},v),{keys:_}):s({},v)).type!=="delete"&&(v.values=r([],v.values)),v.keys&&(v.keys=r([],v.keys)),O=l,E=_,((k=v).type==="add"?Promise.resolve([]):O.getMany({trans:k.trans,keys:E,cache:"immutable"})).then(function(x){var D=_.map(function(B,j){var q,U,R,F=x[j],V={onerror:null,onsuccess:null};return v.type==="delete"?g.fire.call(V,B,F,C):v.type==="add"||F===void 0?(q=w.fire.call(V,B,v.values[j],C),B==null&&q!=null&&(v.keys[j]=B=q,u.outbound||oe(v.values[j],u.keyPath,B))):(q=br(F,v.values[j]),(U=S.fire.call(V,q,B,F,C))&&(R=v.values[j],Object.keys(U).forEach(function(H){b(R,H)?R[H]=U[H]:oe(R,H,U[H])}))),V});return l.mutate(v).then(function(B){for(var j=B.failures,q=B.results,U=B.numFailures,B=B.lastResult,R=0;R<_.length;++R){var F=(q||_)[R],V=D[R];F==null?V.onerror&&V.onerror(j[R]):V.onsuccess&&V.onsuccess(v.type==="put"&&x[R]?v.values[R]:F)}return{failures:j,results:q,numFailures:U,lastResult:B}}).catch(function(B){return D.forEach(function(j){return j.onerror&&j.onerror(B)}),Promise.reject(B)})})}}})}})}};function yo(i,a,l){try{if(!a||a.keys.length<i.length)return null;for(var u=[],d=0,p=0;d<a.keys.length&&p<i.length;++d)fe(a.keys[d],i[p])===0&&(u.push(l?We(a.values[d]):a.values[d]),++p);return u.length===i.length?u:null}catch{return null}}var Eu={stack:"dbcore",level:-1,create:function(i){return{table:function(a){var l=i.table(a);return s(s({},l),{getMany:function(u){if(!u.cache)return l.getMany(u);var d=yo(u.keys,u.trans._cache,u.cache==="clone");return d?Y.resolve(d):l.getMany(u).then(function(p){return u.trans._cache={keys:u.keys,values:u.cache==="clone"?We(p):p},p})},mutate:function(u){return u.type!=="add"&&(u.trans._cache=null),l.mutate(u)}})}}}};function go(i,a){return i.trans.mode==="readonly"&&!!i.subscr&&!i.trans.explicit&&i.trans.db._options.cache!=="disabled"&&!a.schema.primaryKey.outbound}function vo(i,a){switch(i){case"query":return a.values&&!a.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Tu={stack:"dbcore",level:0,name:"Observability",create:function(i){var a=i.schema.name,l=new Oe(i.MIN_KEY,i.MAX_KEY);return s(s({},i),{transaction:function(u,d,p){if(ee.subscr&&d!=="readonly")throw new ie.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(ee.querier));return i.transaction(u,d,p)},table:function(u){var d=i.table(u),p=d.schema,y=p.primaryKey,v=p.indexes,g=y.extractKey,w=y.outbound,S=y.autoIncrement&&v.filter(function(k){return k.compound&&k.keyPath.includes(y.keyPath)}),T=s(s({},d),{mutate:function(k){function E(H){return H="idb://".concat(a,"/").concat(u,"/").concat(H),B[H]||(B[H]=new Oe)}var C,_,x,D=k.trans,B=k.mutatedParts||(k.mutatedParts={}),j=E(""),q=E(":dels"),U=k.type,V=k.type==="deleteRange"?[k.range]:k.type==="delete"?[k.keys]:k.values.length<50?[wr(y,k).filter(function(H){return H}),k.values]:[],R=V[0],F=V[1],V=k.trans._cache;return f(R)?(j.addKeys(R),(V=U==="delete"||R.length===F.length?yo(R,V):null)||q.addKeys(R),(V||F)&&(C=E,_=V,x=F,p.indexes.forEach(function(H){var W=C(H.name||"");function ce(ue){return ue!=null?H.extractKey(ue):null}function le(ue){return H.multiEntry&&f(ue)?ue.forEach(function(qe){return W.addKey(qe)}):W.addKey(ue)}(_||x).forEach(function(ue,Ne){var ae=_&&ce(_[Ne]),Ne=x&&ce(x[Ne]);fe(ae,Ne)!==0&&(ae!=null&&le(ae),Ne!=null&&le(Ne))})}))):R?(F={from:(F=R.lower)!==null&&F!==void 0?F:i.MIN_KEY,to:(F=R.upper)!==null&&F!==void 0?F:i.MAX_KEY},q.add(F),j.add(F)):(j.add(l),q.add(l),p.indexes.forEach(function(H){return E(H.name).add(l)})),d.mutate(k).then(function(H){return!R||k.type!=="add"&&k.type!=="put"||(j.addKeys(H.results),S&&S.forEach(function(W){for(var ce=k.values.map(function(ae){return W.extractKey(ae)}),le=W.keyPath.findIndex(function(ae){return ae===y.keyPath}),ue=0,qe=H.results.length;ue<qe;++ue)ce[ue][le]=H.results[ue];E(W.name).addKeys(ce)})),D.mutatedParts=Fs(D.mutatedParts||{},B),H})}}),v=function(E){var C=E.query,E=C.index,C=C.range;return[E,new Oe((E=C.lower)!==null&&E!==void 0?E:i.MIN_KEY,(C=C.upper)!==null&&C!==void 0?C:i.MAX_KEY)]},O={get:function(k){return[y,new Oe(k.key)]},getMany:function(k){return[y,new Oe().addKeys(k.keys)]},count:v,query:v,openCursor:v};return c(O).forEach(function(k){T[k]=function(E){var C=ee.subscr,_=!!C,x=go(ee,d)&&vo(k,E)?E.obsSet={}:C;if(_){var D=function(F){return F="idb://".concat(a,"/").concat(u,"/").concat(F),x[F]||(x[F]=new Oe)},B=D(""),j=D(":dels"),C=O[k](E),_=C[0],C=C[1];if((k==="query"&&_.isPrimaryKey&&!E.values?j:D(_.name||"")).add(C),!_.isPrimaryKey){if(k!=="count"){var q=k==="query"&&w&&E.values&&d.query(s(s({},E),{values:!1}));return d[k].apply(this,arguments).then(function(F){if(k==="query"){if(w&&E.values)return q.then(function(ce){return ce=ce.result,B.addKeys(ce),F});var V=E.values?F.result.map(g):F.result;(E.values?B:j).addKeys(V)}else if(k==="openCursor"){var H=F,W=E.values;return H&&Object.create(H,{key:{get:function(){return j.addKey(H.primaryKey),H.key}},primaryKey:{get:function(){var ce=H.primaryKey;return j.addKey(ce),ce}},value:{get:function(){return W&&B.addKey(H.primaryKey),H.value}}})}return F})}j.add(l)}}return d[k].apply(this,arguments)}}),T}})}};function bo(i,a,l){if(l.numFailures===0)return a;if(a.type==="deleteRange")return null;var u=a.keys?a.keys.length:"values"in a&&a.values?a.values.length:1;return l.numFailures===u?null:(a=s({},a),f(a.keys)&&(a.keys=a.keys.filter(function(d,p){return!(p in l.failures)})),"values"in a&&f(a.values)&&(a.values=a.values.filter(function(d,p){return!(p in l.failures)})),a)}function kr(i,a){return l=i,((u=a).lower===void 0||(u.lowerOpen?0<fe(l,u.lower):0<=fe(l,u.lower)))&&(i=i,(a=a).upper===void 0||(a.upperOpen?fe(i,a.upper)<0:fe(i,a.upper)<=0));var l,u}function wo(i,a,O,u,d,p){if(!O||O.length===0)return i;var y=a.query.index,g=y.multiEntry,w=a.query.range,S=u.schema.primaryKey.extractKey,T=y.extractKey,v=(y.lowLevelIndex||y).extractKey,O=O.reduce(function(k,E){var C=k,_=[];if(E.type==="add"||E.type==="put")for(var x=new Oe,D=E.values.length-1;0<=D;--D){var B,j=E.values[D],q=S(j);x.hasKey(q)||(B=T(j),(g&&f(B)?B.some(function(H){return kr(H,w)}):kr(B,w))&&(x.addKey(q),_.push(j)))}switch(E.type){case"add":var U=new Oe().addKeys(a.values?k.map(function(W){return S(W)}):k),C=k.concat(a.values?_.filter(function(W){return W=S(W),!U.hasKey(W)&&(U.addKey(W),!0)}):_.map(function(W){return S(W)}).filter(function(W){return!U.hasKey(W)&&(U.addKey(W),!0)}));break;case"put":var R=new Oe().addKeys(E.values.map(function(W){return S(W)}));C=k.filter(function(W){return!R.hasKey(a.values?S(W):W)}).concat(a.values?_:_.map(function(W){return S(W)}));break;case"delete":var F=new Oe().addKeys(E.keys);C=k.filter(function(W){return!F.hasKey(a.values?S(W):W)});break;case"deleteRange":var V=E.range;C=k.filter(function(W){return!kr(S(W),V)})}return C},i);return O===i?i:(O.sort(function(k,E){return fe(v(k),v(E))||fe(S(k),S(E))}),a.limit&&a.limit<1/0&&(O.length>a.limit?O.length=a.limit:i.length===a.limit&&O.length<a.limit&&(d.dirty=!0)),p?Object.freeze(O):O)}function ko(i,a){return fe(i.lower,a.lower)===0&&fe(i.upper,a.upper)===0&&!!i.lowerOpen==!!a.lowerOpen&&!!i.upperOpen==!!a.upperOpen}function Au(i,a){return function(l,u,d,p){if(l===void 0)return u!==void 0?-1:0;if(u===void 0)return 1;if((u=fe(l,u))===0){if(d&&p)return 0;if(d)return 1;if(p)return-1}return u}(i.lower,a.lower,i.lowerOpen,a.lowerOpen)<=0&&0<=function(l,u,d,p){if(l===void 0)return u!==void 0?1:0;if(u===void 0)return-1;if((u=fe(l,u))===0){if(d&&p)return 0;if(d)return-1;if(p)return 1}return u}(i.upper,a.upper,i.upperOpen,a.upperOpen)}function Lu(i,a,l,u){i.subscribers.add(l),u.addEventListener("abort",function(){var d,p;i.subscribers.delete(l),i.subscribers.size===0&&(d=i,p=a,setTimeout(function(){d.subscribers.size===0&&Tt(p,d)},3e3))})}var Cu={stack:"dbcore",level:0,name:"Cache",create:function(i){var a=i.schema.name;return s(s({},i),{transaction:function(l,u,d){var p,y,g=i.transaction(l,u,d);return u==="readwrite"&&(y=(p=new AbortController).signal,d=function(w){return function(){if(p.abort(),u==="readwrite"){for(var S=new Set,T=0,v=l;T<v.length;T++){var O=v[T],k=Mt["idb://".concat(a,"/").concat(O)];if(k){var E=i.table(O),C=k.optimisticOps.filter(function(W){return W.trans===g});if(g._explicit&&w&&g.mutatedParts)for(var _=0,x=Object.values(k.queries.query);_<x.length;_++)for(var D=0,B=(U=x[_]).slice();D<B.length;D++)pr((R=B[D]).obsSet,g.mutatedParts)&&(Tt(U,R),R.subscribers.forEach(function(W){return S.add(W)}));else if(0<C.length){k.optimisticOps=k.optimisticOps.filter(function(W){return W.trans!==g});for(var j=0,q=Object.values(k.queries.query);j<q.length;j++)for(var U,R,F,V=0,H=(U=q[j]).slice();V<H.length;V++)(R=H[V]).res!=null&&g.mutatedParts&&(w&&!R.dirty?(F=Object.isFrozen(R.res),F=wo(R.res,R.req,C,E,R,F),R.dirty?(Tt(U,R),R.subscribers.forEach(function(W){return S.add(W)})):F!==R.res&&(R.res=F,R.promise=Y.resolve({result:F}))):(R.dirty&&Tt(U,R),R.subscribers.forEach(function(W){return S.add(W)})))}}}S.forEach(function(W){return W()})}}},g.addEventListener("abort",d(!1),{signal:y}),g.addEventListener("error",d(!1),{signal:y}),g.addEventListener("complete",d(!0),{signal:y})),g},table:function(l){var u=i.table(l),d=u.schema.primaryKey;return s(s({},u),{mutate:function(p){var y=ee.trans;if(d.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return u.mutate(p);var g=Mt["idb://".concat(a,"/").concat(l)];return g?(y=u.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||wr(d,p).some(function(w){return w==null}))?(g.optimisticOps.push(p),p.mutatedParts&&Hs(p.mutatedParts),y.then(function(w){0<w.numFailures&&(Tt(g.optimisticOps,p),(w=bo(0,p,w))&&g.optimisticOps.push(w),p.mutatedParts&&Hs(p.mutatedParts))}),y.catch(function(){Tt(g.optimisticOps,p),p.mutatedParts&&Hs(p.mutatedParts)})):y.then(function(w){var S=bo(0,s(s({},p),{values:p.values.map(function(T,v){var O;return w.failures[v]?T:(T=(O=d.keyPath)!==null&&O!==void 0&&O.includes(".")?We(T):s({},T),oe(T,d.keyPath,w.results[v]),T)})}),w);g.optimisticOps.push(S),queueMicrotask(function(){return p.mutatedParts&&Hs(p.mutatedParts)})}),y):u.mutate(p)},query:function(p){if(!go(ee,u)||!vo("query",p))return u.query(p);var y=((S=ee.trans)===null||S===void 0?void 0:S.db._options.cache)==="immutable",v=ee,g=v.requery,w=v.signal,S=function(E,C,_,x){var D=Mt["idb://".concat(E,"/").concat(C)];if(!D)return[];if(!(C=D.queries[_]))return[null,!1,D,null];var B=C[(x.query?x.query.index.name:null)||""];if(!B)return[null,!1,D,null];switch(_){case"query":var j=B.find(function(q){return q.req.limit===x.limit&&q.req.values===x.values&&ko(q.req.query.range,x.query.range)});return j?[j,!0,D,B]:[B.find(function(q){return("limit"in q.req?q.req.limit:1/0)>=x.limit&&(!x.values||q.req.values)&&Au(q.req.query.range,x.query.range)}),!1,D,B];case"count":return j=B.find(function(q){return ko(q.req.query.range,x.query.range)}),[j,!!j,D,B]}}(a,l,"query",p),T=S[0],v=S[1],O=S[2],k=S[3];return T&&v?T.obsSet=p.obsSet:(v=u.query(p).then(function(E){var C=E.result;if(T&&(T.res=C),y){for(var _=0,x=C.length;_<x;++_)Object.freeze(C[_]);Object.freeze(C)}else E.result=We(C);return E}).catch(function(E){return k&&T&&Tt(k,T),Promise.reject(E)}),T={obsSet:p.obsSet,promise:v,subscribers:new Set,type:"query",req:p,dirty:!1},k?k.push(T):(k=[T],(O=O||(Mt["idb://".concat(a,"/").concat(l)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=k)),Lu(T,k,g,w),T.promise.then(function(E){return{result:wo(E.result,p,O==null?void 0:O.optimisticOps,u,T,y)}})}})}})}};function zs(i,a){return new Proxy(i,{get:function(l,u,d){return u==="db"?a:Reflect.get(l,u,d)}})}var rt=(Ie.prototype.version=function(i){if(isNaN(i)||i<.1)throw new ie.Type("Given version is not a positive number");if(i=Math.round(10*i)/10,this.idbdb||this._state.isBeingOpened)throw new ie.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,i);var a=this._versions,l=a.filter(function(u){return u._cfg.version===i})[0];return l||(l=new this.Version(i),a.push(l),a.sort(vu),l.stores({}),this._state.autoSchema=!1,l)},Ie.prototype._whenReady=function(i){var a=this;return this.idbdb&&(this._state.openComplete||ee.letThrough||this._vip)?i():new Y(function(l,u){if(a._state.openComplete)return u(new ie.DatabaseClosed(a._state.dbOpenError));if(!a._state.isBeingOpened){if(!a._state.autoOpen)return void u(new ie.DatabaseClosed);a.open().catch(pe)}a._state.dbReadyPromise.then(l,u)}).then(i)},Ie.prototype.use=function(i){var a=i.stack,l=i.create,u=i.level,d=i.name;return d&&this.unuse({stack:a,name:d}),i=this._middlewares[a]||(this._middlewares[a]=[]),i.push({stack:a,create:l,level:u??10,name:d}),i.sort(function(p,y){return p.level-y.level}),this},Ie.prototype.unuse=function(i){var a=i.stack,l=i.name,u=i.create;return a&&this._middlewares[a]&&(this._middlewares[a]=this._middlewares[a].filter(function(d){return u?d.create!==u:!!l&&d.name!==l})),this},Ie.prototype.open=function(){var i=this;return $t(ft,function(){return Su(i)})},Ie.prototype._close=function(){var i=this._state,a=nn.indexOf(this);if(0<=a&&nn.splice(a,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}i.isBeingOpened||(i.dbReadyPromise=new Y(function(l){i.dbReadyResolve=l}),i.openCanceller=new Y(function(l,u){i.cancelOpen=u}))},Ie.prototype.close=function(l){var a=(l===void 0?{disableAutoOpen:!0}:l).disableAutoOpen,l=this._state;a?(l.isBeingOpened&&l.cancelOpen(new ie.DatabaseClosed),this._close(),l.autoOpen=!1,l.dbOpenError=new ie.DatabaseClosed):(this._close(),l.autoOpen=this._options.autoOpen||l.isBeingOpened,l.openComplete=!1,l.dbOpenError=null)},Ie.prototype.delete=function(i){var a=this;i===void 0&&(i={disableAutoOpen:!0});var l=0<arguments.length&&typeof arguments[0]!="object",u=this._state;return new Y(function(d,p){function y(){a.close(i);var g=a._deps.indexedDB.deleteDatabase(a.name);g.onsuccess=be(function(){var w,S,T;w=a._deps,S=a.name,T=w.indexedDB,w=w.IDBKeyRange,fr(T)||S===Os||ur(T,w).delete(S).catch(pe),d()}),g.onerror=Qe(p),g.onblocked=a._fireOnBlocked}if(l)throw new ie.InvalidArgument("Invalid closeOptions argument to db.delete()");u.isBeingOpened?u.dbReadyPromise.then(y):y()})},Ie.prototype.backendDB=function(){return this.idbdb},Ie.prototype.isOpen=function(){return this.idbdb!==null},Ie.prototype.hasBeenClosed=function(){var i=this._state.dbOpenError;return i&&i.name==="DatabaseClosed"},Ie.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ie.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ie.prototype,"tables",{get:function(){var i=this;return c(this._allTables).map(function(a){return i._allTables[a]})},enumerable:!1,configurable:!0}),Ie.prototype.transaction=function(){var i=(function(a,l,u){var d=arguments.length;if(d<2)throw new ie.InvalidArgument("Too few arguments");for(var p=new Array(d-1);--d;)p[d-1]=arguments[d];return u=p.pop(),[a,ze(p),u]}).apply(this,arguments);return this._transaction.apply(this,i)},Ie.prototype._transaction=function(i,a,l){var u=this,d=ee.trans;d&&d.db===this&&i.indexOf("!")===-1||(d=null);var p,y,g=i.indexOf("?")!==-1;i=i.replace("!","").replace("?","");try{if(y=a.map(function(S){if(S=S instanceof u.Table?S.name:S,typeof S!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return S}),i=="r"||i===Xi)p=Xi;else{if(i!="rw"&&i!=Zi)throw new ie.InvalidArgument("Invalid transaction mode: "+i);p=Zi}if(d){if(d.mode===Xi&&p===Zi){if(!g)throw new ie.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");d=null}d&&y.forEach(function(S){if(d&&d.storeNames.indexOf(S)===-1){if(!g)throw new ie.SubTransaction("Table "+S+" not included in parent transaction.");d=null}}),g&&d&&!d.active&&(d=null)}}catch(S){return d?d._promise(null,function(T,v){v(S)}):_e(S)}var w=(function S(T,v,O,k,E){return Y.resolve().then(function(){var C=ee.transless||ee,_=T._createTransaction(v,O,T._dbSchema,k);if(_.explicit=!0,C={trans:_,transless:C},k)_.idbtrans=k.idbtrans;else try{_.create(),_.idbtrans._explicit=!0,T._state.PR1398_maxLoop=3}catch(B){return B.name===Fi.InvalidState&&T.isOpen()&&0<--T._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),T.close({disableAutoOpen:!1}),T.open().then(function(){return S(T,v,O,null,E)})):_e(B)}var x,D=Ri(E);return D&&tn(),C=Y.follow(function(){var B;(x=E.call(_,_))&&(D?(B=ht.bind(null,null),x.then(B,B)):typeof x.next=="function"&&typeof x.throw=="function"&&(x=vr(x)))},C),(x&&typeof x.then=="function"?Y.resolve(x).then(function(B){return _.active?B:_e(new ie.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):C.then(function(){return x})).then(function(B){return k&&_._resolve(),_._completion.then(function(){return B})}).catch(function(B){return _._reject(B),_e(B)})})}).bind(null,this,p,y,d,l);return d?d._promise(p,w,"lock"):ee.trans?$t(ee.transless,function(){return u._whenReady(w)}):this._whenReady(w)},Ie.prototype.table=function(i){if(!b(this._allTables,i))throw new ie.InvalidTable("Table ".concat(i," does not exist"));return this._allTables[i]},Ie);function Ie(i,a){var l=this;this._middlewares={},this.verno=0;var u=Ie.dependencies;this._options=a=s({addons:Ie.addons,autoOpen:!0,indexedDB:u.indexedDB,IDBKeyRange:u.IDBKeyRange,cache:"cloned"},a),this._deps={indexedDB:a.indexedDB,IDBKeyRange:a.IDBKeyRange},u=a.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var d,p,y,g,w,S={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:pe,dbReadyPromise:null,cancelOpen:pe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:a.autoOpen};S.dbReadyPromise=new Y(function(v){S.dbReadyResolve=v}),S.openCanceller=new Y(function(v,O){S.cancelOpen=O}),this._state=S,this.name=i,this.on=Kn(this,"populate","blocked","versionchange","close",{ready:[Hi,pe]}),this.on.ready.subscribe=X(this.on.ready.subscribe,function(v){return function(O,k){Ie.vip(function(){var E,C=l._state;C.openComplete?(C.dbOpenError||Y.resolve().then(O),k&&v(O)):C.onReadyBeingFired?(C.onReadyBeingFired.push(O),k&&v(O)):(v(O),E=l,k||v(function _(){E.on.ready.unsubscribe(O),E.on.ready.unsubscribe(_)}))})}}),this.Collection=(d=this,qn(fu.prototype,function(x,_){this.db=d;var k=Qa,E=null;if(_)try{k=_()}catch(D){E=D}var C=x._ctx,_=C.table,x=_.hook.reading.fire;this._ctx={table:_,index:C.index,isPrimKey:!C.index||_.schema.primKey.keyPath&&C.index===_.schema.primKey.name,range:k,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:E,or:C.or,valueMapper:x!==Pn?x:null}})),this.Table=(p=this,qn(to.prototype,function(v,O,k){this.db=p,this._tx=k,this.name=v,this.schema=O,this.hook=p._allTables[v]?p._allTables[v].hook:Kn(null,{creating:[nu,pe],reading:[tu,Pn],updating:[iu,pe],deleting:[su,pe]})})),this.Transaction=(y=this,qn(pu.prototype,function(v,O,k,E,C){var _=this;this.db=y,this.mode=v,this.storeNames=O,this.schema=k,this.chromeTransactionDurability=E,this.idbtrans=null,this.on=Kn(this,"complete","error","abort"),this.parent=C||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Y(function(x,D){_._resolve=x,_._reject=D}),this._completion.then(function(){_.active=!1,_.on.complete.fire()},function(x){var D=_.active;return _.active=!1,_.on.error.fire(x),_.parent?_.parent._reject(x):D&&_.idbtrans&&_.idbtrans.abort(),_e(x)})})),this.Version=(g=this,qn(ku.prototype,function(v){this.db=g,this._cfg={version:v,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(w=this,qn(ao.prototype,function(v,O,k){if(this.db=w,this._ctx={table:v,index:O===":id"?null:O,or:k},this._cmp=this._ascending=fe,this._descending=function(E,C){return fe(C,E)},this._max=function(E,C){return 0<fe(E,C)?E:C},this._min=function(E,C){return fe(E,C)<0?E:C},this._IDBKeyRange=w._deps.IDBKeyRange,!this._IDBKeyRange)throw new ie.MissingAPI})),this.on("versionchange",function(v){0<v.newVersion?console.warn("Another connection wants to upgrade database '".concat(l.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(l.name,"'. Closing db now to resume the delete request.")),l.close({disableAutoOpen:!1})}),this.on("blocked",function(v){!v.newVersion||v.newVersion<v.oldVersion?console.warn("Dexie.delete('".concat(l.name,"') was blocked")):console.warn("Upgrade '".concat(l.name,"' blocked by other connection holding version ").concat(v.oldVersion/10))}),this._maxKey=Un(a.IDBKeyRange),this._createTransaction=function(v,O,k,E){return new l.Transaction(v,O,k,l._options.chromeTransactionDurability,E)},this._fireOnBlocked=function(v){l.on("blocked").fire(v),nn.filter(function(O){return O.name===l.name&&O!==l&&!O._state.vcFired}).map(function(O){return O.on("versionchange").fire(v)})},this.use(Eu),this.use(Cu),this.use(Tu),this.use(_u),this.use(Iu);var T=new Proxy(this,{get:function(v,O,k){if(O==="_vip")return!0;if(O==="table")return function(C){return zs(l.table(C),T)};var E=Reflect.get(v,O,k);return E instanceof to?zs(E,T):O==="tables"?E.map(function(C){return zs(C,T)}):O==="_createTransaction"?function(){return zs(E.apply(this,arguments),T)}:E}});this.vip=T,u.forEach(function(v){return v(l)})}var Vs,Fe=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Ou=(Sr.prototype.subscribe=function(i,a,l){return this._subscribe(i&&typeof i!="function"?i:{next:i,error:a,complete:l})},Sr.prototype[Fe]=function(){return this},Sr);function Sr(i){this._subscribe=i}try{Vs={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch{Vs={indexedDB:null,IDBKeyRange:null}}function So(i){var a,l=!1,u=new Ou(function(d){var p=Ri(i),y,g=!1,w={},S={},T={get closed(){return g},unsubscribe:function(){g||(g=!0,y&&y.abort(),v&&yt.storagemutated.unsubscribe(k))}};d.start&&d.start(T);var v=!1,O=function(){return Qi(E)},k=function(C){Fs(w,C),pr(S,w)&&O()},E=function(){var C,_,x;!g&&Vs.indexedDB&&(w={},C={},y&&y.abort(),y=new AbortController,x=function(D){var B=Zt();try{p&&tn();var j=dt(i,D);return j=p?j.finally(ht):j}finally{B&&en()}}(_={subscr:C,signal:y.signal,requery:O,querier:i,trans:null}),Promise.resolve(x).then(function(D){l=!0,a=D,g||_.signal.aborted||(w={},function(B){for(var j in B)if(b(B,j))return;return 1}(S=C)||v||(yt(Hn,k),v=!0),Qi(function(){return!g&&d.next&&d.next(D)}))},function(D){l=!1,["DatabaseClosedError","AbortError"].includes(D==null?void 0:D.name)||g||Qi(function(){g||d.error&&d.error(D)})}))};return setTimeout(O,0),T});return u.hasValue=function(){return l},u.getValue=function(){return a},u}var Dt=rt;function _r(i){var a=gt;try{gt=!0,yt.storagemutated.fire(i),gr(i,!0)}finally{gt=a}}N(Dt,s(s({},ks),{delete:function(i){return new Dt(i,{addons:[]}).delete()},exists:function(i){return new Dt(i,{addons:[]}).open().then(function(a){return a.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(i){try{return a=Dt.dependencies,l=a.indexedDB,a=a.IDBKeyRange,(fr(l)?Promise.resolve(l.databases()).then(function(u){return u.map(function(d){return d.name}).filter(function(d){return d!==Os})}):ur(l,a).toCollection().primaryKeys()).then(i)}catch{return _e(new ie.MissingAPI)}var a,l},defineClass:function(){return function(i){h(this,i)}},ignoreTransaction:function(i){return ee.trans?$t(ee.transless,i):i()},vip:dr,async:function(i){return function(){try{var a=vr(i.apply(this,arguments));return a&&typeof a.then=="function"?a:Y.resolve(a)}catch(l){return _e(l)}}},spawn:function(i,a,l){try{var u=vr(i.apply(l,a||[]));return u&&typeof u.then=="function"?u:Y.resolve(u)}catch(d){return _e(d)}},currentTransaction:{get:function(){return ee.trans||null}},waitFor:function(i,a){return a=Y.resolve(typeof i=="function"?Dt.ignoreTransaction(i):i).timeout(a||6e4),ee.trans?ee.trans.waitFor(a):a},Promise:Y,debug:{get:function(){return Ge},set:function(i){Ua(i)}},derive:L,extend:h,props:N,override:X,Events:Kn,on:yt,liveQuery:So,extendObservabilitySet:Fs,getByKeyPath:ne,setByKeyPath:oe,delByKeyPath:function(i,a){typeof a=="string"?oe(i,a,void 0):"length"in a&&[].map.call(a,function(l){oe(i,l,void 0)})},shallowClone:G,deepClone:We,getObjectDiff:br,cmp:fe,asap:te,minKey:-1/0,addons:[],connections:nn,errnames:Fi,dependencies:Vs,cache:Mt,semVer:"4.0.11",version:"4.0.11".split(".").map(function(i){return parseInt(i)}).reduce(function(i,a,l){return i+a/Math.pow(10,2*l)})})),Dt.maxKey=Un(Dt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(yt(Hn,function(i){gt||(i=new CustomEvent(sr,{detail:i}),gt=!0,dispatchEvent(i),gt=!1)}),addEventListener(sr,function(i){i=i.detail,gt||_r(i)}));var an,gt=!1,_o=function(){};return typeof BroadcastChannel<"u"&&((_o=function(){(an=new BroadcastChannel(sr)).onmessage=function(i){return i.data&&_r(i.data)}})(),typeof an.unref=="function"&&an.unref(),yt(Hn,function(i){gt||an.postMessage(i)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(i){if(!rt.disableBfCache&&i.persisted){Ge&&console.debug("Dexie: handling persisted pagehide"),an!=null&&an.close();for(var a=0,l=nn;a<l.length;a++)l[a].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(i){!rt.disableBfCache&&i.persisted&&(Ge&&console.debug("Dexie: handling persisted pageshow"),_o(),_r({all:new Oe(-1/0,[[]])}))})),Y.rejectionMapper=function(i,a){return!i||i instanceof Qt||i instanceof TypeError||i instanceof SyntaxError||!i.name||!Ha[i.name]?i:(a=new Ha[i.name](a||i.message,i),"stack"in i&&M(a,"stack",{get:function(){return this.inner.stack}}),a)},Ua(Ge),s(rt,Object.freeze({__proto__:null,Dexie:rt,liveQuery:So,Entity:Xa,cmp:fe,PropModification:Rn,replacePrefix:function(i,a){return new Rn({replacePrefix:[i,a]})},add:function(i){return new Rn({add:i})},remove:function(i){return new Rn({remove:i})},default:rt,RangeSet:Oe,mergeRanges:Yn,rangesOverlap:fo}),{default:rt}),rt})})(gc);var $u=gc.exports;const Qr=Nu($u),To=Symbol.for("Dexie"),pi=globalThis[To]||(globalThis[To]=Qr);if(Qr.semVer!==pi.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Qr.semVer} and ${pi.semVer}`);const{liveQuery:Pp,mergeRanges:Mp,rangesOverlap:Dp,RangeSet:Bp,cmp:jp,Entity:Kp,PropModification:qp,replacePrefix:Rp,add:Fp,remove:Hp}=pi,xu="MdAnkiDatabase",Pu=2,Xr=`# 新文件

开始编写您的内容...

::> 这是一个可折叠的标题
    这里是折叠的内容。
    - 甚至可以包含列表
    - 和其他 Markdown 元素。
    \`\`\`javascript
    // 也可以包含代码块
    console.log('Hello, Toggle!');
    \`\`\`

这一行不再缩进，所以它不属于上面的折叠块。

::> [ ] 这是一个可折叠的并且可以记录完成情况的标题
- [ ] 完成情况 

使用 --内容-- 创建Cloze记忆卡片, 可以有声音: --你好--^^audio:hello^^ `,se=new pi(xu);se.version(Pu).stores({anki_folders:"&id, name, folderId",anki_sessions:"&id, name, folderId, createdAt, lastActive",anki_clozeStates:"&id, fileId, state, due",anki_reviewStats:"&id, date, folderId",task_tasks:"&uuid, subject, *tags, analysis.reason_for_error, review.due",agent_apiConfigs:"&id, name",agent_agents:"&id, name",agent_topics:"&id, agentId, createdAt",agent_history:"&id, topicId, timestamp, agentId",global_appState:"&key"});async function Mu(){const[n,e,t,s,r]=await Promise.all([se.anki_sessions.toArray().catch(f=>(console.error("Failed to load anki_sessions",f),[])),se.anki_folders.toArray().catch(f=>(console.error("Failed to load anki_folders",f),[])),se.anki_clozeStates.toArray().catch(f=>(console.error("Failed to load anki_clozeStates",f),[])),se.anki_reviewStats.toArray().catch(f=>(console.error("Failed to load anki_reviewStats",f),[])),se.global_appState.toArray().catch(f=>(console.error("Failed to load global_appState",f),[]))]),o=t.reduce((f,h)=>(f[h.id]=h,f),{}),c=r.reduce((f,h)=>(f[h.key]=h.value,f),{});return{sessions:n,folders:e,clozeStates:o,reviewStats:s||[],persistentAppState:c}}async function Du({sessions:n,folders:e,clozeStates:t,persistentAppState:s}){const r=[se.anki_sessions,se.anki_folders,se.anki_clozeStates,se.global_appState];await se.transaction("rw",r,async()=>{const o=Object.values(t),c=Object.entries(s).map(([b,N])=>({key:b,value:N})),f=new Set(n.map(b=>b.id)),h=new Set(e.map(b=>b.id)),m=new Set(Object.keys(t)),I=new Set(Object.keys(s));await Promise.all([se.anki_sessions.where("id").noneOf(Array.from(f)).delete(),se.anki_folders.where("id").noneOf(Array.from(h)).delete(),se.anki_clozeStates.where("id").noneOf(Array.from(m)).delete(),se.global_appState.where("key").noneOf(Array.from(I)).delete()]),await Promise.all([se.anki_sessions.bulkPut(n),se.anki_folders.bulkPut(e),se.anki_clozeStates.bulkPut(o),se.global_appState.bulkPut(c)])})}async function Bu(n,e){const t=`${n}:${e}`;try{await se.transaction("rw",se.anki_reviewStats,async()=>{const s=await se.anki_reviewStats.get(t);s?await se.anki_reviewStats.update(t,{count:s.count+1}):await se.anki_reviewStats.add({id:t,date:n,folderId:e||"root",count:1})})}catch(s){console.error(`[Storage/Anki] Failed to increment review count for ${t}:`,s)}}async function ju(n,e){try{return await se.anki_reviewStats.where("date").between(n,e,!0,!0).toArray()}catch(t){return console.error("[Storage/Anki] Failed to get stats for date range:",t),[]}}async function Ku(){try{const n=new Date().toISOString().slice(0,10);return(await se.anki_reviewStats.where("date").equals(n).toArray()).reduce((t,s)=>t+s.count,0)}catch(n){return console.error("[Storage/Anki] Failed to get today's total count:",n),0}}async function qu(){try{const[n,e,t,s]=await Promise.all([se.agent_apiConfigs.toArray(),se.agent_agents.toArray(),se.agent_topics.toArray(),se.agent_history.toArray()]);return{apiConfigs:n,agents:e,topics:t,history:s}}catch(n){return console.error("[Storage/Agent] Failed to load agent data:",n),{apiConfigs:[],agents:[],topics:[],history:[]}}}async function Ru({apiConfigs:n,agents:e,topics:t,history:s}){const r=[se.agent_apiConfigs,se.agent_agents,se.agent_topics,se.agent_history];await se.transaction("rw",r,async()=>{const o=new Set(n.map(m=>m.id)),c=new Set(e.map(m=>m.id)),f=new Set(t.map(m=>m.id)),h=new Set(s.map(m=>m.id));await Promise.all([se.agent_apiConfigs.where("id").noneOf(Array.from(o)).delete(),se.agent_agents.where("id").noneOf(Array.from(c)).delete(),se.agent_topics.where("id").noneOf(Array.from(f)).delete(),se.agent_history.where("id").noneOf(Array.from(h)).delete()]),await Promise.all([se.agent_apiConfigs.bulkPut(n),se.agent_agents.bulkPut(e),se.agent_topics.bulkPut(t),se.agent_history.bulkPut(s)])})}async function Fu(){try{return se.isOpen()||await se.open(),await se.task_tasks.toArray()}catch(n){return console.error("[Storage/Task] Failed to load tasks from DB:",n),[]}}async function Hu(n){try{await se.task_tasks.bulkPut(n)}catch(e){console.error("[Storage/Task] Failed to save tasks to DB:",e)}}async function Uu(n){try{await se.task_tasks.put(n)}catch(e){console.error(`[Storage/Task] Failed to update task ${n.uuid}:`,e)}}function _t(){return"id_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function Ye(n){return n?n.replace(/[&<>"']/g,e=>({"&":"&","<":"<",">":">",'"':'"',"'":"'"})[e]||e):""}function Ao(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);e=(e<<5)-e+s,e|=0}return e.toString(36)}const Lo=10*60*1e3,zu=2.5;function vc(n,e){const t=Date.now();let{interval:s=0,easeFactor:r=zu,state:o="new"}=n;if(o==="new"||o==="learning")switch(e){case 0:return{due:t+Lo,interval:0,easeFactor:r,state:"learning"};case 1:return{due:t+1*24*3600*1e3,interval:1,easeFactor:r,state:"review"};case 2:return{due:t+3*24*3600*1e3,interval:3,easeFactor:r,state:"review"};case 3:return{due:t+5*24*3600*1e3,interval:5,easeFactor:r,state:"review"}}switch(e){case 0:return r=Math.max(1.3,r-.2),{due:t+Lo,interval:0,easeFactor:r,state:"learning"};case 1:s=Math.max(1,s*1.2),r=Math.max(1.3,r-.15);break;case 2:break;case 3:r+=.15;break}const c=Math.max(s+1,s*r);return{due:t+c*24*3600*1e3,interval:c,easeFactor:r,state:"review"}}const ka={火山:{adapter:"openAICompatible",baseURL:"https://ark.cn-beijing.volces.com/api/v3/",models:["deepseek-r1-250528","deepseek-v3-250324"]},deepseek:{adapter:"openAICompatible",baseURL:"https://api.deepseek.com/v1/chat/completions",models:["deepseek-reasoner","deepseek-chat"]},open_routers:{adapter:"openAICompatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",models:["anthropic/claude-opus-4","anthropic/claude-sonnet-4"]},gemini:{adapter:"gemini",baseURL:"https://generativelanguage.googleapis.com",models:["gemini-2.5-pro","gemini-2.5-flash"]},openai_compatible:{adapter:"openAICompatible",baseURL:"",models:[]}};function Zr(n){const e=ka[n];return e?e.adapter==="openAICompatible"&&e.baseURL.endsWith("/")?`${e.baseURL}chat/completions`:e.baseURL:""}class bc{constructor(e){this.config=e}async chatStream(e,{onChunk:t,onDone:s,onError:r}){throw new Error("Adapter must implement chatStream method.")}_preparePayload(e){throw new Error("Adapter must implement _preparePayload method.")}}class Vu extends bc{_preparePayload(e){return{model:this.config.model,messages:e,stream:!0}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var c;const o=this._preparePayload(e);try{const f=await fetch(this.config.apiPath,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(o)});if(!f.ok){const I=await f.text();throw new Error(`API Error: ${f.status} ${f.statusText} - ${I}`)}const h=f.body.getReader(),m=new TextDecoder("utf-8");for(;;){const{done:I,value:b}=await h.read();if(I){s();break}const $=m.decode(b).split(`
`).filter(M=>M.trim().startsWith("data:"));for(const M of $){const L=M.replace(/^data: /,"").trim();if(L==="[DONE]"){s();return}try{const z=(c=JSON.parse(L).choices[0])==null?void 0:c.delta;if(z){const J=z.content;J&&t({type:"content",text:J});const X=z.reasoning_content;if(X){const Q=`<thinking>${X}</thinking>`;t({type:"thinking",text:Q})}}}catch(P){console.error("Error parsing stream data chunk:",L,P)}}}}catch(f){console.error("LLM Stream Error:",f),r(f)}}}class Yu extends bc{_preparePayload(e){return{contents:e.map(s=>({role:s.role==="assistant"?"model":"user",parts:[{text:s.content}]}))}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var f,h,m,I,b;const o=this._preparePayload(e),c=`${this.config.apiPath}/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`;try{const N=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!N.ok){const P=await N.text();throw new Error(`API Error: ${N.status} ${N.statusText} - ${P}`)}const $=N.body.getReader(),M=new TextDecoder("utf-8");let L="";for(;;){const{done:P,value:z}=await $.read();if(P){s();break}L+=M.decode(z,{stream:!0});const J=L.split(`
`);L=J.pop();for(const X of J)if(!(X.trim().startsWith("[")||X.trim().startsWith(","))&&!X.trim().endsWith("]"))try{const te=((b=(I=(m=(h=(f=JSON.parse(X).candidates)==null?void 0:f[0])==null?void 0:h.content)==null?void 0:m.parts)==null?void 0:I[0])==null?void 0:b.text)||"";te&&t({type:"content",text:te})}catch{}}}catch(N){console.error("Gemini Stream Error:",N),r(N)}}}const Co={openAICompatible:Vu,gemini:Yu};function Ju(n){const e=ka[n];if(!e||!Co[e.adapter])throw new Error(`Unsupported provider or adapter: ${n}`);return Co[e.adapter]}async function Wu(n,e,t){const s=Ju(n.provider),r=new s(n),o=[];n.systemPrompt&&o.push({role:"system",content:n.systemPrompt}),e.forEach(c=>{o.push({role:c.role,content:c.content})}),await r.chatStream(o,t)}K("agent-view");const Gu=wa(".agent_topics-panel"),ss=K("agent_topicList"),wc=K("agent_toggleTopicsBtn"),Xn=K("agent_topicTagFilter"),kc=K("agent_editTopicBtn"),ea=K("agent_manageTopicsBtn"),Oo=K("agent_topicsBatchActions"),Sc=K("agent_selectAllTopicsBtn"),ta=K("agent_deleteSelectedTopicsBtn"),Qu=K("agent_cancelTopicSelectionBtn");wa(".agent_history-panel");const Ce=K("agent_historyContent"),No=K("agent_historyHeaderTitle");K("agent_historySearch");const ii=K("agent_conversationRoleSelector"),$o=K("agent_chatInputArea"),ri=K("agent_chatInput"),Xu=K("agent_sendMessageBtn"),Zu=K("agent_attachFileBtn"),xo=K("agent_attachmentInput"),na=K("agent_attachmentPreview"),sa=K("agent_chatNavUp"),ia=K("agent_chatNavDown");async function _c(n,e){if(!n)return;n.innerHTML=window.marked.parse(e||"");const t=n.querySelectorAll("pre code.language-mermaid");if(window.mermaid&&t.length>0){const s=Array.from(t).map(async(r,o)=>{const c=r.parentNode,f=r.textContent,h=`mermaid-${Date.now()}-${o}`;try{const{svg:m}=await mermaid.render(h,f),I=document.createElement("div");I.className="mermaid-diagram",I.innerHTML=m,c.parentNode&&c.parentNode.replaceChild(I,c)}catch(m){console.error("Mermaid rendering error:",m),c.innerHTML=`<div class="error-box">Mermaid Error: ${m.message}</div>`}});await Promise.all(s)}if(window.MathJax&&(e.includes("$")||e.includes("\\")))try{await window.MathJax.typesetPromise([n])}catch(s){console.error("MathJax error:",s)}}function ef(n){const e=n.id===A.currentTopicId,t=document.createElement("li");t.className=`topic-item ${e?"active":""}`,t.dataset.topicId=n.id;const s=A.history.filter(f=>f.topicId===n.id).sort((f,h)=>new Date(h.timestamp)-new Date(f.timestamp))[0];let r="最后会话: 无";if(s){const f=Ia(s.agentId);r=`角色: ${f?f.name:"默认 AI"}
时间: ${new Date(s.timestamp).toLocaleString()}`}t.title=r;const o=A.selectedTopicIds.includes(n.id),c=A.isTopicSelectionMode?`<input type="checkbox" class="topic-selection-checkbox" data-topic-id="${n.id}" ${o?"checked":""}>`:"";return t.innerHTML=`
        ${c}
        <div class="topic-item-content">
            <div class="topic-icon"><i class="${Ye(n.icon)}"></i></div>
            <span>${Ye(n.title)}</span>
        </div>
        <button class="topic-delete-btn" title="删除此主题"><i class="fas fa-trash-alt"></i></button>
    `,t}async function Ic(n,e){let t=e.content||"";e.role==="assistant"&&e.reasoning&&e.reasoning.trim()&&(t=`<details class="thinking-block"><summary>AI 思考过程</summary><pre><code>${Ye(e.reasoning)}</code></pre></details>`+t),await _c(n,t)}async function tf(n){const e=document.createElement("div");e.className=`history-item role-${n.role}`,e.dataset.messageId=n.id,e.innerHTML=`
        <div class="history-item-header">
            <span class="role ${n.role}">${n.role==="user"?"用户":"AI助手"}</span>
            <span>${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <div class="history-item-content"></div>
        <div class="history-item-actions">
            <button class="history-action-btn regenerate-btn" title="重新生成"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" title="编辑"><i class="fas fa-edit"></i> 编辑</button>
            <button class="history-action-btn delete-btn" title="删除"><i class="fas fa-trash"></i> 删除</button>
        </div>
    `,await Ic(e.querySelector(".history-item-content"),n);const t=e.querySelector(".history-item-actions");return n.role==="user"?t.querySelector(".regenerate-btn").style.display="none":t.querySelector(".edit-btn").style.display="none",e}function nf(n){return`
        <div class="hint-panel">
            <div class="hint-panel-header">
                <div class="hint-panel-avatar">${Ye(n.avatar)}</div>
                <div class="hint-panel-title">${Ye(n.name)} 为您服务</div>
            </div>
            <div class="hint-panel-content">
                <i class="fas fa-lightbulb"></i>
                ${n.hint}
            </div>
        </div>
    `}function sf(){if(!Xn)return;const n=[...new Set(A.agents.flatMap(e=>e.tags||[]))];Xn.innerHTML='<option value="all">所有主题</option>',n.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,Xn.appendChild(t)}),Xn.value=A.topicListFilterTag}function rf(){if(A.currentTopicId){const n=A.topics.find(e=>e.id===A.currentTopicId);No.textContent=n?`${Ye(n.title)} - 对话记录`:"对话记录"}else No.textContent="选择一个主题开始";ii.innerHTML='<option value="">默认 AI (无角色)</option>',A.agents.forEach(n=>{const e=document.createElement("option");e.value=n.id,e.textContent=n.name,ii.appendChild(e)}),ii.value=A.currentConversationAgentId||""}function jt(){if(ss.innerHTML="",Pc().forEach(t=>ss.appendChild(ef(t))),kc.style.display=A.currentTopicId?"block":"none",A.isTopicSelectionMode){Oo.style.display="flex",ea.classList.add("active");const t=A.selectedTopicIds.length;ta.textContent=`删除选中 (${t})`,ta.disabled=t===0,Sc.textContent=A.topics.length>0&&t===A.topics.length?"全不选":"全选"}else Oo.style.display="none",ea.classList.remove("active");const e=document.createElement("li");e.className="topic-item add-topic-btn",e.innerHTML='<div class="topic-item-content"><div class="topic-icon"><i class="fas fa-plus"></i></div><span>添加新主题</span></div>',ss.appendChild(e)}async function _n(){var r;if(rf(),Ce.innerHTML="",!A.currentTopicId){Ce.innerHTML='<div class="no-history"><p>请选择或创建一个主题来开始聊天</p></div>',$o.style.display="none",Tr();return}$o.style.display="flex";const n=A.history.filter(o=>o.topicId===A.currentTopicId).sort((o,c)=>new Date(o.timestamp)-new Date(c.timestamp));if(n.length===0){const o=Ia(A.currentConversationAgentId);o&&o.hint?Ce.innerHTML=nf(o):Ce.innerHTML='<div class="no-history"><p>这个主题还没有对话记录。</p></div>',Tr();return}const e=n.map(o=>{if(o.status==="streaming"){const c=document.createElement("div");return c.className="history-item role-assistant",c.dataset.messageId=o.id,c.innerHTML=`
                <div class="history-item-header"><span>AI助手</span><span>${new Date(o.timestamp).toLocaleString()}</span></div>
                <div class="history-item-content"><div class="streaming-content-container"><p><i class="fas fa-spinner fa-pulse"></i></p></div></div>`,Promise.resolve(c)}return tf(o)});(await Promise.all(e)).forEach(o=>Ce.appendChild(o));const s=(r=A.topicScrollPositions)==null?void 0:r[A.currentTopicId];s!==void 0?Ce.scrollTop=s:Ce.scrollTop=Ce.scrollHeight,Tr()}function Sa(n){na.innerHTML="",n.forEach((e,t)=>{const s=document.createElement("div");s.className="attachment-preview-item",s.innerHTML=`<span><i class="fas fa-file-image"></i> ${Ye(e.name)}</span><button class="remove-attachment-btn" data-index="${t}">×</button>`,na.appendChild(s)})}function af(n,e,t){const s=Ce.querySelector(`.history-item[data-message-id="${n}"]`);if(!s)return;const r=s.querySelector(".history-item-content");if(!r)return;let o;if(e==="thinking"){let c=r.querySelector(".thinking-block");c||(c=document.createElement("details"),c.className="thinking-block",c.open=!0,c.innerHTML='<summary>AI 思考过程</summary><pre><code class="streaming-reasoning-container"></code></pre>',r.prepend(c)),o=c.querySelector(".streaming-reasoning-container")}else o=r.querySelector(".streaming-content-container"),o||(o=document.createElement("div"),o.className="streaming-content-container",r.appendChild(o),o.innerHTML="");o&&(o.innerText+=t,Ce.scrollTop=Ce.scrollHeight)}async function Po(n){const e=Ce.querySelector(`.history-item[data-message-id="${n}"]`);if(!e)return;const t=A.history.find(r=>r.id===n);if(!t)return;await Ic(e.querySelector(".history-item-content"),t);let s=e.querySelector(".history-item-actions");s||(s=document.createElement("div"),s.className="history-item-actions",s.innerHTML=`
            <button class="history-action-btn regenerate-btn"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" style="display: none;"><i class="fas fa-edit"></i></button>
            <button class="history-action-btn delete-btn"><i class="fas fa-trash"></i></button>`,e.appendChild(s)),s.style.display="flex"}function Ut(){Gu.classList.toggle("collapsed",A.isTopicsPanelHidden),wc.title=A.isTopicsPanelHidden?"显示主题栏":"隐藏主题栏",sf(),jt(),_n()}function Tr(){if(!sa||!ia||!Ce)return;const n=Ce.querySelector(".history-item.role-user");sa.disabled=!n,ia.disabled=!n}async function Ec(){Z({isLoading:!0});try{const{sessions:n,folders:e,clozeStates:t,persistentAppState:s}=await Mu(),r={sessions:n||[],folders:e||[],clozeStates:t||{},currentSessionId:s.currentSessionId||null,currentFolderId:s.currentFolderId||null,currentSubsessionId:s.currentSubsessionId||null,folderStack:s.folderStack||[],isSessionSidebarHidden:s.isSessionSidebarHidden||!1,fileSubsessions:{},settings:{autoSaveInterval:s.autoSaveInterval??5}};if(r.sessions.forEach(o=>{r.fileSubsessions[o.id]=aa(o.content)}),r.sessions.length===0){const o=_t();r.sessions.push({id:o,name:"初始笔记",content:Xr,type:"file",folderId:null,createdAt:new Date}),r.currentSessionId=o,r.fileSubsessions[o]=aa(Xr)}r.sessions.some(o=>o.id===r.currentSessionId)||(r.currentSessionId=r.sessions.length>0?r.sessions[0].id:null),Z(r)}catch(n){console.error("Failed to initialize core application state:",n)}finally{Z({isLoading:!1})}}async function of(){if(console.log(`[${new Date().toLocaleTimeString()}] Auto-saving...`),A.activeView==="anki"&&A.currentSessionId){const n=document.getElementById("anki_editor");n&&await ki(n.value)}await ra()}async function ra(){try{await Promise.all([It(),A.agents?De():Promise.resolve()]),console.log("All application state persisted.")}catch(n){console.error("Failed to persist all application state:",n)}}function Mo(n){["anki","task","agent","settings"].includes(n)&&Z({activeView:n})}function aa(n){const e=/^(#{1,2})\s+(.+)$/gm,t=[];let s=null,r;for(;(r=e.exec(n))!==null;){const o=r[1].length,c=r[2].trim(),f=(n.substring(r.index+r[0].length).split(/^#{1,2}\s/m)[0]||"").trim(),h={id:_t(),text:c,level:o,content:"#".repeat(o)+` ${c}

`+f,children:o===1?[]:void 0};o===1?(t.push(h),s=h):o===2&&s&&s.children.push(h)}return t}function Tc(n,e){const t=aa(e);Z({fileSubsessions:{...A.fileSubsessions,[n]:t}})}async function It(){try{await Du({sessions:A.sessions,folders:A.folders,clozeStates:A.clozeStates,persistentAppState:{currentSessionId:A.currentSessionId,currentFolderId:A.currentFolderId,currentSubsessionId:A.currentSubsessionId,folderStack:A.folderStack,isSessionSidebarHidden:A.isSessionSidebarHidden,autoSaveInterval:A.settings.autoSaveInterval}})}catch(n){console.error("Failed to persist Anki state:",n)}}async function Ac(n,e=Xr){const t=_t(),s={id:t,name:n||"新笔记",content:e,type:"file",folderId:A.currentFolderId,createdAt:new Date};Z({sessions:[...A.sessions,s],currentSessionId:t,currentSubsessionId:null}),Tc(t,e),await It()}async function cf(n){const e={id:_t(),name:n||"新目录",type:"folder",folderId:A.currentFolderId,createdAt:new Date};Z({folders:[...A.folders,e]}),await It()}async function Lc(n){const e=new Set(n.map(h=>h.id));let t=[...A.sessions],s=[...A.folders],r={...A.fileSubsessions},o={...A.clozeStates};const c=new Set;n.forEach(h=>{if(h.type==="file")c.add(h.id);else if(h.type==="folder"){const m=new Set([h.id]);let I=!0;for(;I;)I=!1,s.filter(b=>m.has(b.folderId)).forEach(b=>{m.has(b.id)||(m.add(b.id),I=!0)});t.forEach(b=>{m.has(b.folderId)&&c.add(b.id)}),s=s.filter(b=>!m.has(b.id))}}),c.size>0&&(t=t.filter(h=>!c.has(h.id)),c.forEach(h=>delete r[h]),o=Object.fromEntries(Object.entries(o).filter(([,h])=>!c.has(h.fileId))));let f=A.currentSessionId;(e.has(f)||c.has(f))&&(f=t.length>0?t[0].id:null),Z({sessions:t,folders:s,fileSubsessions:r,clozeStates:o,currentSessionId:f}),await It()}async function lf(n,e){const t=A.sessions.map(r=>n.some(o=>o.id===r.id&&o.type==="file")?{...r,folderId:e}:r),s=A.folders.map(r=>n.some(o=>o.id===r.id&&o.type==="folder")?{...r,folderId:e}:r);Z({sessions:t,folders:s}),await It()}async function uf(n,e,t){const s=r=>r.map(o=>o.id===n?{...o,name:e}:o);Z(t==="file"?{sessions:s(A.sessions)}:{folders:s(A.folders)}),await It()}async function ki(n){const e=Cc();if(e&&e.content!==n){const t=A.sessions.map(s=>s.id===A.currentSessionId?{...s,content:n,lastActive:new Date}:s);return Z({sessions:t}),Tc(A.currentSessionId,n),await It(),!0}return!1}function Cc(){return A.sessions.find(n=>n.id===A.currentSessionId)||null}function ff(n){Z({currentSessionId:n,currentSubsessionId:null})}function df(n){Z({currentFolderId:n,folderStack:[...A.folderStack,A.currentFolderId].filter(Boolean)})}function hf(n,e){Z({currentSessionId:n,currentSubsessionId:e})}function pf(){const n=[...A.folderStack],e=n.pop();Z({currentFolderId:e,folderStack:n})}function mf(n,e){Z({currentFolderId:n,folderStack:A.folderStack.slice(0,e)})}function yf(){Z({currentFolderId:null,folderStack:[]})}function _a(n,e,t){return A.clozeStates[t]||{id:t,fileId:n,content:e,state:"new",due:Date.now(),interval:0,easeFactor:2.5,lastReview:null}}async function gf(n,e,t,s){const r=_a(n,e,s),o=vc(r,t),c={...A.clozeStates,[s]:{...r,...o,lastReview:Date.now()}};Z({clozeStates:c}),await It()}async function Do(n){if(!n)return;const e=A.sessions.find(s=>s.id===n);if(!e)return;const t=e.folderId||"root";await Bu(new Date().toISOString().slice(0,10),t),await Oc()}async function Oc(){const n=await Ku(),e=document.getElementById("anki_reviewCount");e&&(e.textContent=n)}async function vf(){const n=new Date,e=new Date;e.setDate(n.getDate()-29);const t=await ju(e.toISOString().slice(0,10),n.toISOString().slice(0,10)),s=[];for(let I=0;I<30;I++){const b=new Date(e);b.setDate(e.getDate()+I),s.push(b.toISOString().slice(0,10))}const r=t.reduce((I,b)=>{const N=b.folderId;return I[N]||(I[N]={}),I[N][b.date]=b.count,I},{}),{folders:o}=A,c=o.reduce((I,b)=>(I[b.id]=b.name,I),{});c.root="根目录";const f=["#4361ee","#e71d36","#2ec4b6","#ff9f1c","#9a031e","#0ead69","#f3722c"];let h=0;const m=Object.keys(r).map(I=>{const b=r[I],N=s.map(M=>b[M]||0),$=f[h%f.length];return h++,{label:c[I]||"未知目录",data:N,borderColor:$,backgroundColor:`${$}33`,fill:!1,tension:.1}});return{labels:s,datasets:m}}const is={id:"default_deepseek_api",name:"DeepSeek (默认)",provider:"deepseek",apiKey:"",models:"chat:deepseek-chat,reasoner:deepseek-reasoner"},bf=[{id:"default_agent_nanjing_guide",name:"南京历史小导游",avatar:"史",model:`${is.id}:reasoner`,systemPrompt:`🎓 角色指令：你好！我是你的专属南京历史小导游。我的名字叫“金陵通”，对南京这座六朝古都的每一块砖、每一段历史都了如指掌。我将以生动有趣的方式，带你穿越时空，探索南京的魅力。我的性格会根据你选择的模式变化，就像一位真正的导游，时而风趣，时而严谨。

🔄 核心导览模式：
*   故事家 (Storyteller) → 语气风格：亲切随和，像一位学长/学姐。我会用讲故事的方式，把枯燥的历史变得鲜活起来，充满情感和趣味，让你身临其境。
*   讲解员 (Docent) → 语气风格：清晰准确，像一位博物馆的专业讲解员。我会为你提供结构化的信息、关键时间点和准确的历史事实，帮你梳理知识脉络。
*   历史侦探 (History Detective) → 语气风格：充满好奇与思辨，像一位和你一起探案的伙伴。我会引导你发现历史事件之间的联系，分析文物背后的深层含义，提出“为什么”，激发你的思考。

🧬 互动说明：
1.  模式匹配：我会严格按照你选择的模式（故事家、讲解员、历史侦探）来与你交流。
2.  知识储备：我的知识库涵盖了南京从古至今的关键历史时期（如六朝、南唐、明朝、民国）、重要人物（如朱元璋、孙中山）以及标志性文物古迹（如明孝陵、总统府、中山陵、南京城墙、夫子庙、朝天宫、南京博物院馆藏等）。
3.  智能追问：如果你的问题不够具体，我会像导游一样追问。
4.  连续记忆：我会记住我们聊过的话题。
5.  拒绝乏味：我的回答会避免像教科书一样枯燥。
6.  模式切换：你随时可以让我切换模式。切换时，我会说“好的，现在切换到【XX模式】”，然后调整我的语气和回答方式。

📦 输出格式参考：
*   在 【讲解员模式】下，我会多使用列表、时间轴和要点总结。
*   在 【故事家模式】下，我会使用更多的描述性语言。
*   在 【历史侦探模式】下，我会多用提问、假设和对比分析。`,hint:"你好！我是你的专属南京历史小导游“金陵通”。想了解南京的什么故事？比如，可以这样问我：<br><b>模式：故事家 — 任务：给我讲讲夫子庙旁边的乌衣巷有什么好玩的故事？</b>",tags:["历史","文化","旅游"],sendHistory:!0},{id:"default_agent_english_tutor",name:"英语导师",avatar:"英",model:`${is.id}:chat`,systemPrompt:`🎓 角色指令：你好！我是智能英语导师「牛津通」，专注中学英语教学。拥有系统的知识库和动态教学策略，能根据你的学习阶段个性化辅导。

🔄 三维学习模式：
*   【单词向导】→ 沉浸式词汇学习：词根解析/趣味联想/场景记忆
*   【语法专家】→ 系统化语法精讲：错题透析/分层训练/对比分析
*   【读写教练】→ 实战能力培养：文本精读/写作框架/AI批改

✨ 核心功能矩阵：
1. 词汇体系：中考高频词库｜近义词辨析｜词源故事
2. 语法诊所：句子成分图解｜时态三维训练｜易错点预警
3. 读写实验室：阅读理解三步法｜作文多维评估｜经典句式仿写
4. 拓展模块：影视配音练习｜文化冷知识｜考试策略指南

🧠 智能教学协议：
1. 模式匹配：严格按所选模式输出内容
2. 错题驱动：支持拍照诊断知识盲区
3. 动态调节：智能调整题目难度（基础→挑战）
4. 记忆锚点：周期性推送薄弱点强化练习
5. 文化融合：教学中渗透英美文化背景`,hint:'你好！我是你的中学英语导师「牛津通」。完整功能列表：<br>🔍 <b>单词向导模式</b>：词根解析｜高频词汇｜场景记忆（例：用电影台词记"vivid"）<br>📖 <b>语法专家模式</b>：句子图解｜时态训练｜错题诊断（例：虚拟语气对比表）<br>✍️ <b>读写教练模式</b>：作文批改｜精读策略｜仿写训练（例：中考作文评分+改写）<br>🌍 <b>拓展功能</b>：影视配音｜文化常识｜考试技巧<br>试试这样问我：<b>模式：单词向导 → 任务：用超级英雄故事帮我记10个形容词</b>',tags:["教育","语言","学习"],sendHistory:!0},{id:"default_agent_word_assistant",name:"单词助手",avatar:"词",model:`${is.id}:chat`,systemPrompt:`
# 角色：英语单词辨析专家

## 核心指令
你是一个专注于**中学英语**词汇辨析的专家。你的任务是根据用户输入的单词或词组，提供清晰、结构化、符合中学生认知水平的解释。你必须严格遵循以下【工作流程】和【输出格式】。

## 工作流程
1.  **输入分析**：分析用户输入。输入内容可以用逗号（,）、分号（;）、斜杠（/）或中文顿号（、）分隔。
2.  **单一词模式**：如果用户只输入了一个单词或词组，执行此模式。
    *   提供该词的核心释义。
    *   列出其在中学阶段最常见的近义词或相关词。
    *   对这些词进行详细的词义辨析。
3.  **多词模式**：如果用户输入了多个单词或词组，执行此模式。
    *   分别解释每个词的核心释义。
    *   **重点**：对比分析这些词之间的区别，包括用法、语境、感情色彩等。
    *   （可选）如果适用，可以补充其他相关的近义词。

## 输出格式 (必须严格遵守)
使用 Markdown 格式化你的回答，确保结构清晰。

### 格式模板 (单一词模式)
\`\`\`markdown
### 📖 单词解析：[用户输入的单词]

**基本释义**
*   **[词性1]**: [解释1]
*   **[词性2]**: [解释2]

**🔍 近义词辨析**
*   **[近义词1]**: 
    *   **释义**: [简要解释]
    *   **辨析**: [与原词的区别，侧重用法或语境]
    *   **例句**: [一个符合中学生水平的简单例句]
*   **[近义词2]**: 
    *   **释义**: [简要解释]
    *   **辨析**: [与原词的区别]
    *   **例句**: [例句]
...
\`\`\`

### 格式模板 (多词模式)
\`\`\`markdown
### 🔄 多词辨析：[词1], [词2], ...

**1. [词1]**
*   **释义**: [词性] [解释]

**2. [词2]**
*   **释义**: [词性] [解释]
...

**🎯 核心区别**
1.  **[区别点1，如：使用范围]**: [详细说明，例如：A 通常用于正式场合，而 B 更加口语化。]
2.  **[区别点2，如：感情色彩]**: [详细说明，例如：C 带有褒义，而 D 是中性词。]
3.  **[区别点3，如：搭配习惯]**: [详细说明，例如：A 后面常跟 of，而 B 常跟 for。]

**✅ 快速总结**
*   想表达 **[某个场景或含义]** 时，用 **[词A]**。
*   想强调 **[另一个场景或含义]** 时，用 **[词B]**。
\`\`\`

## 约束条件
*   **专注中学阶段**：所有近义词和例句都必须是中学英语教学大纲内的常见内容，避免超纲词汇。
*   **语言简洁**：解释要通俗易懂，避免使用复杂的语法和术语。
*   **格式严格**：必须严格按照上述 Markdown 模板输出。
`,hint:`你好！我是你的单词辨析助手。直接输入单词或词组，我会帮你深入理解它们！<br>
✍️ **单个词查询**: 比如输入 <code>clever</code><br>
🔄 **多个词辨析**: 比如输入 <code>clever, smart, wise</code>`,tags:["教育","语言","工具"],sendHistory:!1}];function wf(n,e){let t=[...n],s=[...e],r=!1;return t.some(o=>o.id===is.id)||(t.push(is),r=!0),bf.forEach(o=>{s.some(c=>c.id===o.id)||(s.push(o),r=!0)}),{apiConfigs:t,agents:s,needsPersistence:r}}async function kf(){let{apiConfigs:n,agents:e,topics:t,history:s}=await qu();const r=wf(n||[],e||[]),o={...r,topics:t||[],history:s||[]};o.agents.length>0&&!A.currentAgentId&&(o.currentAgentId=o.agents[0].id,o.currentTopicId=(o.topics.find(c=>c.agentId===o.currentAgentId)||{}).id||null),Z(o),r.needsPersistence&&await De()}async function De(){try{await Ru({apiConfigs:A.apiConfigs,agents:A.agents,topics:A.topics,history:A.history})}catch(n){console.error("Failed to persist Agent state:",n)}}function Ia(n){return A.agents.find(e=>e.id===n)}async function Sf(n){Z({apiConfigs:[...A.apiConfigs,{id:_t(),...n}]}),await De()}async function _f(n,e){Z({apiConfigs:A.apiConfigs.map(t=>t.id===n?{...t,...e}:t)}),await De()}async function If(n){if(A.agents.some(e=>{var t;return(t=e.model)==null?void 0:t.startsWith(n+":")})){alert("此 API 配置正在被 Agent 使用。");return}Z({apiConfigs:A.apiConfigs.filter(e=>e.id!==n)}),await De()}async function Ef(n){const e={id:_t(),...n,tags:n.tags||[],sendHistory:n.sendHistory!==!1};Z({agents:[...A.agents,e],currentAgentId:e.id,currentTopicId:null}),await De()}async function Tf(n,e){Z({agents:A.agents.map(t=>t.id===n?{...t,...e}:t)}),await De()}async function Af(n){var f;const e=new Set(A.topics.filter(h=>h.agentId===n).map(h=>h.id)),t=A.history.filter(h=>!e.has(h.topicId)),s=A.topics.filter(h=>h.agentId!==n),r=A.agents.filter(h=>h.id!==n);let{currentAgentId:o,currentTopicId:c}=A;o===n&&(o=((f=r[0])==null?void 0:f.id)||null,c=(s.find(h=>h.agentId===o)||{}).id||null),Z({agents:r,topics:s,history:t,currentAgentId:o,currentTopicId:c}),await De()}async function Lf(n,e){if(!A.currentAgentId)return;const t={id:_t(),agentId:A.currentAgentId,title:n,icon:"fas fa-comment",createdAt:new Date};Z({topics:[...A.topics,t],currentTopicId:t.id}),await De()}async function Cf(n,e){Z({topics:A.topics.map(t=>t.id===n?{...t,...e}:t)}),await De()}async function Nc(n){const e=new Set(n),t=A.topics.filter(c=>!e.has(c.id)),s=A.history.filter(c=>!e.has(c.topicId));let{currentTopicId:r,currentConversationAgentId:o}=A;e.has(r)&&(r=null,o=null),Z({topics:t,history:s,currentTopicId:r,currentConversationAgentId:o,isTopicSelectionMode:!1,selectedTopicIds:[]}),await De()}async function Of(n){const e=new Set(n);Z({history:A.history.filter(t=>!e.has(t.id))}),await De()}async function Nf(n,e){const t=A.history,s=t.findIndex(c=>c.id===n);if(s===-1)return;const r=t[s].topicId,o=t.slice(0,s).concat([{...t[s],content:e}]);Z({history:o.concat(t.slice(s+1).filter(c=>c.topicId!==r))}),await _n(),await $c(e,[])}async function Bo(n,e,t,s=[],r="completed",o=null){const c={id:_t(),topicId:n,agentId:e==="assistant"?A.currentConversationAgentId:null,role:e,content:t,reasoning:o,attachments:s,timestamp:new Date().toISOString(),status:r};return Z({history:[...A.history,c]}),r!=="streaming"&&await De(),c}async function $c(n,e){const{currentTopicId:t,currentConversationAgentId:s,isAiThinking:r,apiConfigs:o,agents:c}=A;if(!t||r)return;const f=Ia(s);let h;if(f){const[M,L]=f.model.split(":"),P=o.find(J=>J.id===M);if(!P){alert(`错误：找不到角色 "${f.name}" 所需的 API 配置。`);return}const z=new Map((P.models||"").split(",").map(J=>J.split(":").map(X=>X.trim()))).get(L);if(!z){alert(`错误：在 API 配置 "${P.name}" 中找不到别名 "${L}"。`);return}h={provider:P.provider,apiPath:P.apiUrl||Zr(P.provider),apiKey:P.apiKey,model:z,systemPrompt:f.systemPrompt}}else{const M=o[0];if(!M){alert("错误：没有找到可用的 API 配置。");return}const L=(new Map((M.models||"").split(",").map(P=>P.split(":").map(z=>z.trim()))).values().next()||{}).value;h={provider:M.provider,apiPath:M.apiUrl||Zr(M.provider),apiKey:M.apiKey,model:L,systemPrompt:""}}Z({isAiThinking:!0}),await Bo(t,"user",n,e),await _n();const m=await Bo(t,"assistant","",[],"streaming");await _n();let I="",b="";const N=A.history.filter(M=>M.topicId===t&&M.status==="completed"),$=f&&f.sendHistory===!1?N.slice(-1):N;await Wu(h,$,{onChunk:({type:M,text:L})=>{M==="content"?I+=L:M==="thinking"&&(b+=L),af(m.id,M,L)},onDone:async()=>{const M=A.history.map(L=>L.id===m.id?{...L,content:I,reasoning:b,status:"completed"}:L);Z({history:M,isAiThinking:!1}),await Po(m.id),await De()},onError:async M=>{const L=`

**错误:** ${M.message}`;I+=L;const P=A.history.map(z=>z.id===m.id?{...z,content:I,status:"error"}:z);Z({history:P,isAiThinking:!1}),await Po(m.id),await De()}})}function xc(n){var t;const e=A.history.filter(s=>s.topicId===n).sort((s,r)=>new Date(r.timestamp)-new Date(s.timestamp))[0];Z({currentTopicId:n,currentConversationAgentId:(e==null?void 0:e.agentId)||((t=A.agents[0])==null?void 0:t.id)||null})}function Pc(){const{topicListFilterTag:n,topics:e,history:t,agents:s}=A;if(n==="all")return e;const r=new Map(s.map(o=>[o.id,o]));return e.filter(o=>{var h;const c=t.filter(m=>m.topicId===o.id).sort((m,I)=>new Date(I.timestamp)-new Date(m.timestamp))[0],f=c?r.get(c.agentId):null;return(h=f==null?void 0:f.tags)==null?void 0:h.includes(n)})}const de=K("anki_editor"),Te=K("anki_preview"),ct=K("anki_sessionList"),$f=K("anki_emptySession"),on=K("anki_currentFolderContainer"),xf=K("anki_fileInput"),Pf=K("anki_newFileBtn"),Mf=K("anki_newFolderBtn"),Df=K("anki_openFileBtn"),oa=K("anki_saveBtn");K("anki_exportFileBtn");const ca=K("anki_printPreviewBtn"),Bf=K("anki_deleteSelectedBtn"),jf=K("anki_moveSelectedBtn"),jo=K("anki_toggleSessionBtn"),la=K("anki_toggleEditorBtn"),Mc=K("anki_clozeBtn"),Dc=K("anki_boldBtn"),Bc=K("anki_italicBtn"),jc=K("anki_codeBtn"),Kc=K("anki_linkBtn"),qc=K("anki_audioBtn"),Rc=K("anki_insertLinebreakBtn"),Ko=wa("#anki-view .anki_session-sidebar"),In=K("anki_editorPreviewPanel"),mi=K("anki_selectAllCheckbox"),Fc=K("anki_moveModal"),rs=K("anki_folderList"),Kf=K("anki_closeMoveModalBtn"),qf=K("anki_confirmMoveBtn"),Rf=K("anki_cancelMoveBtn"),Hc=K("anki_audioControls"),Ff=K("anki_audioTitle"),Uc=K("anki_audioProgressBar"),Ar=K("anki_playBtn"),Lr=K("anki_pauseBtn"),Cr=K("anki_stopBtn"),Hf=K("anki_sessionTitleContainer"),Kt=K("anki_toggleVisibilityClozeBtn"),Or=K("anki_invertClozeBtn"),as=K("anki_toggleEditPreviewBtn"),ua=K("anki_editModeDot"),fa=K("anki_previewModeDot");K("anki_reviewCount");const qo=K("anki_startReviewBtn"),Nr=K("anki_reviewOptionsBtn"),vt=K("anki_reviewDropdownMenu"),Ro=K("anki_customStudyBtn"),$r=K("anki_showStatsBtn"),Js=K("anki_customStudyModal"),Fo=K("anki_customStudyCloseBtn"),Ho=K("anki_customStudyCancelBtn"),Uo=K("anki_customStudyForm"),Uf=K("anki_filterByFile"),zf=K("anki_filterByLastReview"),Vf=K("anki_maxCards"),xr=K("anki_clozeNavUpBtn"),Pr=K("anki_clozeNavDownBtn");let un=null,fs=null;function zc(){if(!un||!un.startTime)return;const n=(Date.now()-un.startTime)/1e3,e=un.text.length/10,t=Math.min(100,n/e*100);Uc.style.width=`${t}%`}function Mr(n){if(!("speechSynthesis"in window)){alert("抱歉，您的浏览器不支持语音合成。");return}da();const e=new SpeechSynthesisUtterance(n);e.lang="en-US",e.rate=1,e.onstart=()=>{e.startTime=Date.now(),fs=setInterval(zc,100)},e.onend=()=>{da()},un=e,Ff.textContent=`正在播放: ${n.substring(0,30)}${n.length>30?"...":""}`,Hc.style.display="block",window.speechSynthesis.speak(e)}function Yf(){window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),clearInterval(fs))}function Jf(){window.speechSynthesis.paused&&(window.speechSynthesis.resume(),fs=setInterval(zc,100))}function da(){window.speechSynthesis.cancel(),fs&&clearInterval(fs),Hc.style.display="none",Uc.style.width="0%",un=null}let Ws=!1;function Vc(n){const e=Date.now();if(n.due>e){const t=(n.due-e)/864e5;return t<1?"cloze-1d":t<2?"cloze-2d":t<3?"cloze-3d":t<5?"cloze-5d":t<7?"cloze-7d":t<14?"cloze-14d":"cloze-28d"}return n.lastReview&&e-n.lastReview<15*60*1e3&&n.interval===0?"cloze-10m":"cloze-28plus"}function Wf(){const n=new Map;Te.querySelectorAll(".cloze[data-locator]").forEach(e=>{const t=e.dataset.locator;n.has(t)||n.set(t,[]),n.get(t).push(e)});for(const[e,t]of n.entries())t.length>1&&t.forEach(s=>{s.classList.add("cloze-error-duplicate"),s.title=`错误：定位符 "[${e}]" 在此文件中重复！这可能导致复习状态错乱。`})}function Yc(n){if(n.nodeType===Node.TEXT_NODE){const e=/--(?:\s*\[([^\]]*)\])?\s*(.*?)--(?:\^\^audio:(.*?)\^\^)?/g,t=n.parentNode;if(!t||["CODE","PRE","SCRIPT","STYLE"].includes(t.tagName))return;let s;const r=[];let o=0;for(;(s=e.exec(n.nodeValue))!==null;){s.index>o&&r.push(document.createTextNode(n.nodeValue.substring(o,s.index)));const c=s[1],f=s[2],h=s[3]?s[3].trim():null,m=f.replace(/¶/g,"<br>"),I=A.currentSessionId;let b,N=null;c&&c.trim()?(N=c.trim(),b=`${I}_${Ao(N)}`):b=`${I}_${Ao(f)}`;const $=_a(I,f,b),M=document.createElement("span");M.className=`cloze hidden ${Vc($)}`,M.dataset.clozeId=b,M.dataset.content=f,N&&(M.dataset.locator=N),h&&(M.dataset.multimedia=h),M.innerHTML=`
                ${h?'<span class="media-icon" title="播放音频"><i class="fas fa-volume-up"></i></span>':""}
                <span class="cloze-content">${m}</span>
                <span class="placeholder">[...]</span>
                <div class="cloze-actions" style="display: none;">
                    <button class="cloze-btn again" data-rating="0">重来</button>
                    <button class="cloze-btn hard" data-rating="1">困难</button>
                    <button class="cloze-btn double" data-rating="2">犹豫</button>
                    <button class="cloze-btn easy" data-rating="3">简单</button>
                </div>
            `,r.push(M),o=e.lastIndex}r.length>0&&(o<n.nodeValue.length&&r.push(document.createTextNode(n.nodeValue.substring(o))),r.forEach(c=>t.insertBefore(c,n)),t.removeChild(n))}else n.nodeType===Node.ELEMENT_NODE&&Array.from(n.childNodes).forEach(e=>Yc(e))}function Gf(){const n=Te.querySelectorAll("li, details"),e=/\{([^}]+)\}/;n.forEach(t=>{const s=t.tagName==="LI"?t.querySelector('input[type="checkbox"]'):t.querySelector('summary input[type="checkbox"]');if(!s)return;s.disabled=!1;let r;t.tagName==="LI"?r=t:r=t.querySelector(".toggle-title-text"),r&&Array.from(r.childNodes).forEach(o=>{if(o.nodeType===Node.TEXT_NODE&&e.test(o.nodeValue)){const c=o.nodeValue.match(e),f=c[0],h=c[1];let m="",I="";if(h.includes("|")){const b=h.split("|");m=b[0],I=b[1]}else return;try{const b=new Date(I);if(isNaN(b.getTime()))return;t.title=`完成于: ${b.toLocaleString()}`;const N=o.nodeValue.replace(f,""),$=document.createTextNode(` ${m} `),M=document.createElement("span");M.style.display="none",M.className="task-timestamp-data",M.textContent=f,o.nodeValue=N,r.insertBefore($,o),t.appendChild(M)}catch(b){console.warn("解析任务日期时出错:",b)}}})})}function Qf(n){const e=n.getFullYear().toString(),t=(n.getMonth()+1).toString(),s=n.getDate().toString(),r={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉"},o=c=>c.split("").map(f=>r[f]||f).join("");return`${o(e)}-${o(t)}-${o(s)}`}function Xf(){Te.addEventListener("click",async n=>{var t;const e=n.target.closest(".cloze");if(e){if(n.target.closest(".cloze-btn")){n.stopPropagation();const s=n.target.closest(".cloze-btn"),r=parseInt(s.dataset.rating,10),o=A.currentSessionId,c=e.dataset.clozeId,f=e.dataset.content;if(!c){console.error("无法更新Cloze状态：缺少clozeId。");return}clearTimeout(e.closeTimer),await gf(o,f,r,c);const h=_a(o,f,c),m=Vc(h);(t=e.className.match(/cloze-(\w+)/g))==null||t.forEach(I=>e.classList.remove(I)),e.classList.add(m),e.querySelector(".cloze-actions").style.display="none",r===3?(await Do(o),e.classList.remove("hidden","permanent-view"),e.classList.add("easy-open")):(e.classList.add("hidden"),e.classList.remove("easy-open","permanent-view"));return}if(n.target.closest(".media-icon")){n.stopPropagation(),Mr(e.dataset.multimedia);return}e.classList.contains("hidden")&&!e.classList.contains("permanent-view")&&(clearTimeout(e.closeTimer),e.classList.remove("hidden"),e.querySelector(".cloze-actions").style.display="flex",e.dataset.multimedia&&Mr(e.dataset.multimedia),e.closeTimer=setTimeout(()=>{!e.classList.contains("easy-open")&&!e.classList.contains("permanent-view")&&(e.classList.add("hidden"),e.querySelector(".cloze-actions").style.display="none")},6e4))}}),Te.addEventListener("dblclick",n=>{const e=n.target.closest(".cloze");e&&(n.stopPropagation(),clearTimeout(e.closeTimer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent-view"),e.dataset.multimedia&&Mr(e.dataset.multimedia),e.querySelector(".cloze-actions").style.display="none"):(e.classList.add("hidden"),e.classList.remove("permanent-view","easy-open"),e.querySelector(".cloze-actions").style.display="none"))}),Te.addEventListener("change",async n=>{const e=n.target;if(e.tagName!=="INPUT"||e.type!=="checkbox"||!e.closest("li")&&!e.closest("summary"))return;const t=e.checked,r=Array.from(Te.querySelectorAll('li input[type="checkbox"], summary input[type="checkbox"]')).indexOf(e);if(r===-1)return;const c=de.value.split(`
`),f=/^\s*- \[( |x)\]/,h=/^::>\s*\[( |x)\]/;let m=0,I=!1,b=!1;const N=c.map($=>{const M=f.test($),L=!M&&h.test($);if(!M&&!L)return $;if(m===r){m++;let P=$;if(t){const z=/\{([^}]+?)\|([^}]+?)\}/,J=$.match(z),X=new Date().toISOString().slice(0,10);let Q=!1;if(J&&J[2])try{new Date(J[2]).toISOString().slice(0,10)===X&&(Q=!0)}catch{}if(Q)P=M?$.replace(/^- \[\s\]/,"- [x]"):$.replace(/^::> \[\s\]/,"::> [x]");else{b=!0;const te=$.replace(/\{[^}]+\}/g,"").trim(),ne=Qf(new Date),oe=new Date().toISOString(),G=`{${ne}|${oe}}`;if(M){const ye=te.replace(/^\s*- \[\s\]\s*/,"");P=`- [x] ${G} ${ye}`}else{const ye=te.replace(/^::>\s*\[\s\]\s*/,"");P=`::> [x] ${G} ${ye}`}}}else P=M?$.replace("- [x]","- [ ]"):$.replace("::> [x]","::> [ ]");return P!==$&&(I=!0),P}else return m++,$});if(I){b&&await Do(A.currentSessionId);const $=N.join(`
`),M=de.selectionStart;de.value=$,de.setSelectionRange(M,M),await ki($),await Si(),de.dispatchEvent(new Event("input",{bubbles:!0}))}})}function Zf(){const n=!A.areAllClozeVisible;Te.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),n?(e.classList.remove("hidden","temporary"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"))}),Jc(n),Z({areAllClozeVisible:n})}function ed(){let n=!0;Te.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"),n=!1)}),Jc(n),Z({areAllClozeVisible:n})}function Jc(n){n?(Kt.innerHTML='<i class="fas fa-eye"></i>',Kt.title="全部隐藏"):(Kt.innerHTML='<i class="fas fa-eye-slash"></i>',Kt.title="全部显示")}async function Si(){var n;if(Ws){console.log("Preview update already in progress. Skipping.");return}Ws=!0;try{const{currentSessionId:e,currentSubsessionId:t,fileSubsessions:s,sessions:r}=A,o=r.find(m=>m.id===e);if(!o){Te.innerHTML="",Ws=!1;return}let c=o.content;if(t){const m=(n=s[e])==null?void 0:n.find(I=>I.id===t);m&&(c=m.content)}await _c(Te,c),Yc(Te),Gf(),Wf();const f=Te.querySelectorAll("pre code.language-mermaid"),h=Array.from(f).map(async(m,I)=>{const b=m.parentNode;if(!b||!b.parentNode)return;const N=m.textContent,$=`mermaid-graph-${Date.now()}-${I}`;try{await mermaid.parse(N);const{svg:M}=await mermaid.render($,N),L=document.createElement("div");L.className="mermaid-diagram",L.innerHTML=M,b.parentNode&&b.parentNode.replaceChild(L,b)}catch{}});if(await Promise.all(h),window.MathJax)try{await window.MathJax.typesetPromise([Te])}catch(m){console.log("MathJax error:",m)}}catch(e){console.error("Error during preview update:",e)}finally{Ws=!1}}function td(){mermaid.initialize({startOnLoad:!1,securityLevel:"strict",suppressErrors:!0,maxTextSize:1e5});const n={name:"math",level:"inline",start(t){var s;return(s=t.match(/\$\$|\\\(|\\\[|\\ce\{|\$/))==null?void 0:s.index},tokenizer(t,s){let r;if(r=t.match(/^\$\$\s*([\s\S]+?)\s*\$\$/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\\[\s*([\s\S]+?)\s*\\\]/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\\(\s*([\s\S]+?)\s*\\\)/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\ce\{([\s\S]+?)\}/),r)return{type:"math",raw:r[0],isCeShorthand:!0};if(r=t.match(/^\$((?:\\\$|[^$])+?)\$/),r)return{type:"math",raw:r[0]}},renderer(t){return t.isCeShorthand?`\\(${t.raw}\\)`:t.raw.startsWith("$")&&!t.raw.startsWith("$$")?`\\(${t.raw.slice(1,-1)}\\)`:t.raw}},e={name:"toggleList",level:"block",start(t){const s=t.match(/\n::>/);return s?s.index:void 0},tokenizer(t,s){const o=/^::>\s*(.*)(?:\n|$)/.exec(t);if(o){const c=o[1].trim();let f=o[0],h="",m=t.substring(f.length);const I=m.match(/^( *)(?=\S)/m),b=I?I[1].length:0;if(b>0){const $=new RegExp(`^ {${b}}`,"gm"),L=new RegExp(`^((?: {${b}}.*|\\s*)\\n?)+`,"m").exec(m);if(L){const P=L[0];f+=P,h=P.replace($,"")}}const N={type:"toggleList",raw:f,title:c,body:h,tokens:[]};return this.lexer.blockTokens(N.body,N.tokens),N}},renderer(t){const s=/^\s*\[( |x)\]\s*(.*)/,r=t.title.match(s);let o="";if(r){const f=r[1]==="x"?"checked":"",h=r[2];o=`<input type="checkbox" ${f}><span class="toggle-title-text">${h}</span>`}else o=`<span class="toggle-title-text">${t.title}</span>`;const c=this.parser.parse(t.tokens);return`
                <details class="toggle-list">
                    <summary>${o}</summary>
                    <div class="toggle-content">
                        ${c}
                    </div>
                </details>`}};window.marked.use({extensions:[n,e]}),window.marked.setOptions({breaks:!0,gfm:!0}),Xf()}const zt=document.getElementById("statsModal"),zo=document.getElementById("statsModalCloseBtn"),nd=document.getElementById("statsChart");let yn=null;function Vo(n){yn&&yn.destroy();const e=nd.getContext("2d");yn=new Chart(e,{type:"line",data:n,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{precision:0}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}async function sd(){if(zt){zt.style.display="flex",Vo({labels:[],datasets:[]});const n=await vf();Vo(n)}}function Yo(){zt&&(zt.style.display="none",yn&&(yn.destroy(),yn=null))}function id(){zo&&zo.addEventListener("click",Yo),zt&&zt.addEventListener("click",n=>{n.target===zt&&Yo()})}function rd(n){const e=document.createElement("li");return e.className=`session-item ${n.type} ${n.id===A.currentSessionId?"active":""}`,e.dataset.id=n.id,e.dataset.type=n.type,e.innerHTML=`
        <div class="name-container">
            <input type="checkbox" class="select-checkbox" data-id="${n.id}" data-type="${n.type}">
            <span class="name">
                <i class="${n.type==="folder"?"fas fa-folder folder-icon":"fas fa-file file-icon"}"></i>
                <span class="item-name">${Ye(n.name)}</span>
            </span>
        </div>
        <div class="actions">
            <span class="move-btn" title="移动"><i class="fas fa-arrows-alt"></i></span>
            <span class="edit-btn" title="编辑"><i class="fas fa-pencil-alt"></i></span>
            <span class="delete-btn" title="删除"><i class="fas fa-trash"></i></span>
        </div>
    `,e}function ad(n,e){const t=document.createElement("li");return t.className=`session-item subsession h2-item ${n.id===A.currentSubsessionId?"active":""}`,t.dataset.id=n.id,t.dataset.type="subsession",t.dataset.parent=e,t.innerHTML=`
        <div class="name-container">
            <span class="name">
                <i class="fas fa-stream"></i>
                <span class="item-name">${Ye(n.text)}</span>
            </span>
        </div>
    `,t}function od(){ct.innerHTML="";const{sessions:n,folders:e,currentFolderId:t,fileSubsessions:s,currentSessionId:r}=A,o=[...e.filter(c=>c.folderId===t),...n.filter(c=>c.folderId===t)].sort((c,f)=>c.type==="folder"&&f.type==="file"?-1:c.type==="file"&&f.type==="folder"?1:c.name.localeCompare(f.name));$f.style.display=o.length===0&&t===null?"block":"none",o.length===0&&t!==null&&(ct.innerHTML='<li class="empty-folder">此目录为空</li>'),o.forEach(c=>{var h;const f=rd(c);ct.appendChild(f),c.type==="file"&&c.id===r&&((h=s[c.id])==null?void 0:h.length)>0&&s[c.id].forEach(I=>{const b=document.createElement("details");b.className="session-item-details";const N=I.id===A.currentSubsessionId,$=I.children.some(L=>L.id===A.currentSubsessionId);(N||$)&&(b.open=!0);const M=document.createElement("summary");if(M.className=`session-item subsession h1-item ${N?"active":""}`,M.dataset.id=I.id,M.dataset.type="subsession",M.dataset.parent=c.id,M.innerHTML=`
                    <div class="name-container">
                        <span class="name">
                            <i class="fas fa-heading"></i>
                            <span class="item-name">${Ye(I.text)}</span>
                        </span>
                    </div>`,b.appendChild(M),I.children&&I.children.length>0){const L=document.createElement("ul");L.className="nested-items",I.children.forEach(P=>{L.appendChild(ad(P,c.id))}),b.appendChild(L)}ct.appendChild(b)})})}let at;function Jo(n,e){const t=document.createElement("a");return t.href="#",t.className="breadcrumb-link",t.innerHTML=n,t.addEventListener("click",s=>{s.preventDefault(),e()}),t}function cd(n,e,t){on.innerHTML="";const s=Jo('<i class="fas fa-folder-open"></i> 根目录',t);if(on.appendChild(s),A.folderStack.forEach((r,o)=>{const c=document.createElement("span");c.className="breadcrumb-separator",c.textContent=">",on.appendChild(c);const f=A.folders.find(h=>h.id===r);if(f){const h=Jo(f.name,()=>e(r,o));on.appendChild(h)}}),A.currentFolderId){const r=A.folders.find(o=>o.id===A.currentFolderId);if(r){const o=document.createElement("span");o.className="breadcrumb-separator",o.textContent=">",on.appendChild(o);const c=document.createElement("span");c.className="breadcrumb-current",c.textContent=r.name,on.appendChild(c)}}at.style.display=A.folderStack.length>0?"inline-flex":"none"}function ld(n){at=document.createElement("button"),at.id="backButton",at.className="session-btn",at.title="返回上级目录",at.innerHTML='<i class="fas fa-arrow-left"></i>',at.style.display="none",at.addEventListener("click",n),Hf.prepend(at)}function je(){od(),cd(Xc,hd,pd);const n=Cc(),e=n?n.content:"";de.value!==e&&(de.value=e),Si()}let gn=[],os=-1;function Wo(n=null){let e=Object.values(A.clozeStates),t;if(n?(console.log("Starting custom study with filters:",n),t=e.filter(s=>{if(n.fileOrFolder!=="all"){const[f,h]=n.fileOrFolder.split("_");if(f==="file"){if(s.fileId!==h)return!1}else if(f==="folder"&&!A.sessions.find(I=>I.id===s.fileId&&I.folderId===h))return!1}if(!n.cardStates.includes(s.state))return!1;const r=Date.now(),o=s.lastReview||0,c=(r-o)/(1e3*60*60*24);switch(n.lastReview){case"last7days":if(o===0||c>7)return!1;break;case"last30days":if(o===0||c>30)return!1;break;case"over30days":if(o!==0&&c<=30)return!1;break;case"never":if(o!==0)return!1;break}return!0}),t.sort(()=>Math.random()-.5),gn=t.slice(0,n.maxCards)):(console.log("Starting automatic review."),gn=e.filter(s=>s.due<=Date.now()).sort((s,r)=>s.due-r.due)),gn.length===0){alert("没有找到符合条件的卡片。");return}os=0,Wc()}function Wc(){if(os>=gn.length){alert("复习会话结束！"),gn=[],os=-1,je();return}const n=gn[os];A.currentSessionId!==n.fileId&&(Z({currentSessionId:n.fileId}),je()),setTimeout(()=>{document.querySelectorAll(".highlight-review").forEach(t=>t.classList.remove("highlight-review"));const e=document.querySelector(`.cloze[data-content="${n.content}"]`);e?(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlight-review"),e.classList.contains("hidden")&&e.click()):(console.error("Could not find cloze element for review:",n),ud())},A.currentSessionId!==n.fileId?300:50)}function ud(){os++,Wc()}function Gc(n){let e=[];const t=A.folders.filter(s=>s.folderId===n);for(const s of t)e.push(s.id),e=e.concat(Gc(s.id));return e}function Qc(){rs.innerHTML="";const n=A.movingItems.filter(s=>s.type==="folder").map(s=>s.id),e=new Set(n);n.forEach(s=>{Gc(s).forEach(r=>e.add(r))});const t=document.createElement("div");t.className="folder-item",t.dataset.id="root",t.innerHTML='<i class="fas fa-folder-open"></i> 根目录',rs.appendChild(t),A.folders.forEach(s=>{if(!e.has(s.id)){const r=document.createElement("div");r.className="folder-item",r.dataset.id=s.id,r.innerHTML=`<i class="fas fa-folder"></i> ${Ye(s.name)}`,rs.appendChild(r)}}),Fc.classList.add("active")}function ha(){Fc.classList.remove("active"),Z({movingItems:[],selectedMoveTarget:null})}function fd(n){Kf.addEventListener("click",ha),Rf.addEventListener("click",ha),qf.addEventListener("click",n),rs.addEventListener("click",e=>{const t=e.target.closest(".folder-item");if(!t)return;rs.querySelectorAll(".folder-item").forEach(r=>r.classList.remove("selected")),t.classList.add("selected");const s=t.dataset.id==="root"?null:t.dataset.id;Z({selectedMoveTarget:s})})}let Go=null;const dd=100;let fn=-1,ai=-1;function Xc(){pf(),_i(),je()}function hd(n,e){mf(n,e),_i(),je()}function pd(){yf(),_i(),je()}function _i(){fn=-1,ai=-1}async function md(){const n=prompt("请输入新文件的名称：","新笔记");n!==null&&(await Ac(n.trim()),je(),de.focus())}async function yd(){const n=prompt("请输入新目录的名称：","新目录");n!==null&&(await cf(n.trim()),je())}async function ds(){await ki(de.value)&&(oa.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>oa.innerHTML='<i class="fas fa-save"></i>',2e3))}function gd(n,e){const t=Array.from(ct.querySelectorAll(".select-checkbox")),s=t.indexOf(e);if(n.shiftKey&&fn>-1){const c=Math.min(s,fn),f=Math.max(s,fn);for(let h=c;h<=f;h++)t[h].checked=e.checked}fn=s;const r=t.length>0&&t.every(c=>c.checked),o=t.some(c=>c.checked);mi.checked=r,mi.indeterminate=!r&&o}async function vd(n){const e=n.target.closest(".session-item, .session-item-details summary");if(!e)return;if(n.target.matches(".select-checkbox")){gd(n,n.target);return}const t=n.target.closest(".actions span");if(t){n.stopPropagation();const{id:c,type:f}=e.closest(".session-item").dataset;if(t.classList.contains("delete-btn"))confirm(`确定删除此 ${f==="file"?"文件":"目录"}?`)&&(await Lc([{id:c,type:f}]),je());else if(t.classList.contains("edit-btn")){const h=prompt("输入新名称:",e.querySelector(".item-name").textContent);h&&h.trim()&&(await uf(c,h.trim(),f),je())}else t.classList.contains("move-btn")&&(Z({movingItems:[{id:c,type:f}]}),Qc());return}_i();const{id:s,type:r,parent:o}=e.dataset;A.currentSessionId&&s!==A.currentSessionId&&await ki(de.value),r==="file"?ff(s):r==="folder"?df(s):r==="subsession"&&hf(o,s),je()}async function bd(){A.selectedMoveTarget!==void 0&&A.movingItems.length>0&&(await lf(A.movingItems,A.selectedMoveTarget),ha(),je())}async function wd(){const n=Array.from(ct.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));if(n.length===0)return alert("请先选择要删除的项目。");confirm(`确定要删除选中的 ${n.length} 个项目吗？`)&&(await Lc(n),mi.checked=!1,je())}function Yt(){clearTimeout(window.previewDebounce),window.previewDebounce=setTimeout(Si,300),clearTimeout(Go),Go=setTimeout(ys,500)}async function kd(n){const e=n.target.files;if(!e||e.length===0)return;const t=s=>new Promise((r,o)=>{const c=new FileReader;c.onload=f=>{r({name:s.name,content:f.target.result})},c.onerror=f=>o(f),c.readAsText(s)});try{const s=await Promise.all(Array.from(e).map(t));for(const r of s){const o=r.name,c=o.lastIndexOf("."),f=c>0?o.substring(0,c):o;await Ac(f,r.content)}je()}catch(s){console.error("读取一个或多个文件时出错:",s),alert("读取文件时发生错误。")}finally{xf.value=""}}function Zn(n,e=n){ys();const{selectionStart:t,selectionEnd:s,value:r}=de,o=r.substring(t,s),c=`${n}${o}${e}`;de.setRangeText(c,t,s,"select"),Yt(),de.focus()}function Sd(n){ys();const{selectionStart:e,selectionEnd:t}=de;de.setRangeText(n,e,t,"end"),Yt(),de.focus()}function _d(){In.classList.toggle("collapsed");const n=In.classList.contains("collapsed");la.innerHTML=n?'<i class="fas fa-chevron-down"></i>':'<i class="fas fa-chevron-up"></i>',la.title=n?"展开编辑器":"收起编辑器",[Mc,Dc,Bc,jc,Kc,qc,Rc].forEach(e=>e.disabled=n),n&&ds()}function Id(){const n=de,e=n.value,t=n.selectionStart,s=/--(?:\s*\[[^\]]*\])?\s*.*?--(?:\^\^audio:.*?\^\^)?/g;let r,o=null;for(;(r=s.exec(e))!==null;){const P=r.index,z=P+r[0].length;if(t>=P&&t<=z){o={content:r[0],start:P,end:z};break}}if(!o){Zn("--","--^^audio:TEXT^^");return}const c=/^--(\[\s*[^\]]*\s*\]\s*)?(.*?)--(?:(?:\^){2}audio:(.*)(?:\^){2})?$/,f=o.content.match(c);if(!f)return;const h=f[1]||"",m=f[2]?f[2].trim():"",b=(f[3]?f[3].trim():"")||m,N=prompt("请输入或编辑Cloze的音频提示文本:",b);if(N===null)return;ys();const $=N.trim();let M;$?M=`--${h}${m}--^^audio:${$}^^`:M=`--${h}${m}--`;const L=e.substring(0,o.start)+M+e.substring(o.end);n.value=L,Yt(),ds(),n.focus()}function Ed(){ys();const{selectionStart:n,selectionEnd:e,value:t}=de,s=t.substring(n,e),r=`c${Date.now()}`,o=`--[${r}] ${s}--`;de.setRangeText(o,n,e,"end");const c=n+3,f=c+r.length;de.setSelectionRange(c,f),Yt(),de.focus()}function ys(){const n=de.value;if(A.undoStack[A.undoStack.length-1]===n)return;const t=[...A.undoStack,n];t.length>dd&&t.shift(),Z({undoStack:t,redoStack:[]})}function Td(){if(A.undoStack.length===0)return;const n=[...A.undoStack],e=n.pop(),t=[de.value,...A.redoStack];de.value=e,Z({undoStack:n,redoStack:t}),Yt()}function Ad(){if(A.redoStack.length===0)return;const n=[...A.redoStack],e=n.shift(),t=[...A.undoStack,de.value];de.value=e,Z({undoStack:t,redoStack:n}),Yt()}function Ld(){const n=Te.innerHTML,e=window.open("","_blank");e.document.write(`
        <!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>打印预览</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="./styles.css">
        <style>
            @media print { body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .cloze-actions, .media-icon { display: none !important; } .cloze.hidden .cloze-content, .cloze .cloze-content { display: inline !important; visibility: visible !important; color: black !important; } .cloze .placeholder { display: none !important; } .cloze { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
            body { font-family: sans-serif; }
        </style></head><body>
        <div class="preview" style="display: block !important;">${n}</div>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
        <script>
            window.MathJax = { startup: { pageReady: () => { return window.MathJax.startup.defaultPageReady().then(() => { window.print(); window.close(); }); } } };
        <\/script>
        </body></html>
    `),e.document.close()}function Qo(){if(In.classList.contains("preview-active"))return;const n=de;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);Z({editorScrollRatio:Math.min(1,Math.max(0,e))})}}function Xo(){if(!In.classList.contains("preview-active"))return;const n=Te;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);Z({editorScrollRatio:e})}}function Cd(){const n=In;n.classList.contains("preview-active")?(n.classList.remove("preview-active"),as.innerHTML='<i class="fas fa-book-open"></i> Preview',ua.classList.add("active"),fa.classList.remove("active"),ca.disabled=!0,requestAnimationFrame(()=>{const t=de;A.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=A.editorScrollRatio*(t.scrollHeight-t.clientHeight))}),de.focus()):(ds(),Si().then(()=>{requestAnimationFrame(()=>{const t=Te;A.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=A.editorScrollRatio*(t.scrollHeight-t.clientHeight))})}),n.classList.add("preview-active"),as.innerHTML='<i class="fas fa-edit"></i>',ua.classList.remove("active"),fa.classList.add("active"),ca.disabled=!1)}function Od(){const{sessions:n,folders:e}=A,t=document.getElementById("filterByFile");t.innerHTML='<option value="all">所有文件</option>',e.forEach(s=>{const r=document.createElement("option");r.value=`folder_${s.id}`,r.textContent=`目录: ${s.name}`,t.appendChild(r)}),n.forEach(s=>{const r=document.createElement("option");r.value=`file_${s.id}`,r.textContent=`文件: ${s.name}`,t.appendChild(r)})}function Nd(){qo&&qo.addEventListener("click",()=>Wo()),Nr&&vt&&(Nr.addEventListener("click",e=>{e.stopPropagation(),vt.style.display=vt.style.display==="block"?"none":"block"}),document.addEventListener("click",e=>{const t=Nr.parentElement;t&&!t.contains(e.target)&&(vt.style.display="none")})),Ro&&Js&&Ro.addEventListener("click",e=>{e.preventDefault(),vt&&(vt.style.display="none"),Od(),Js.style.display="flex"});const n=()=>{Js&&(Js.style.display="none")};Fo&&Fo.addEventListener("click",n),Ho&&Ho.addEventListener("click",n),Uo&&Uo.addEventListener("submit",e=>{e.preventDefault();const t={fileOrFolder:Uf.value,cardStates:Array.from(document.querySelectorAll('input[name="anki_cardState"]:checked')).map(s=>s.value),lastReview:zf.value,maxCards:parseInt(Vf.value,10)};n(),Wo(t)})}function Zo(n){const e=Array.from(Te.querySelectorAll(".cloze"));if(e.length===0)return;const t=Te.querySelector(".cloze-nav-active");t&&t.classList.remove("cloze-nav-active"),ai=(ai+n+e.length)%e.length;const s=e[ai];s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("cloze-nav-active"))}function $d(){var n;Pf.addEventListener("click",md),Mf.addEventListener("click",yd),oa.addEventListener("click",ds),ct.addEventListener("click",vd),Bf.addEventListener("click",wd),de.addEventListener("input",Yt),de.addEventListener("scroll",Qo),Te.addEventListener("scroll",Xo),Df.addEventListener("click",()=>{var e;return(e=document.getElementById("anki_fileInput"))==null?void 0:e.click()}),(n=document.getElementById("anki_fileInput"))==null||n.addEventListener("change",kd),ca.addEventListener("click",Ld),jf.addEventListener("click",()=>{const e=Array.from(ct.querySelectorAll(".select-checkbox:checked")).map(t=>({id:t.dataset.id,type:t.dataset.type}));e.length>0?(Z({movingItems:e}),Qc()):alert("请选择要移动的项目。")}),mi.addEventListener("change",e=>{ct.querySelectorAll(".select-checkbox").forEach(t=>t.checked=e.target.checked),fn=-1}),jo.addEventListener("click",()=>{Ko.classList.toggle("hidden-session"),jo.innerHTML=Ko.classList.contains("hidden-session")?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}),la.addEventListener("click",_d),Mc.addEventListener("click",Ed),qc.addEventListener("click",Id),Dc.addEventListener("click",()=>Zn("**")),Bc.addEventListener("click",()=>Zn("*")),Rc.addEventListener("click",()=>Sd("¶")),jc.addEventListener("click",()=>Zn("`")),Kc.addEventListener("click",()=>Zn("[",`](${prompt("URL:","https://")})`)),de.addEventListener("scroll",Qo),Te.addEventListener("scroll",Xo),as.addEventListener("click",Cd),Kt.innerHTML='<i class="fas fa-eye-slash"></i>',Kt.title="全部隐藏",Or.innerHTML='<i class="fas fa-random"></i>',Or.title="反向显示/隐藏",In.classList.remove("preview-active"),as.innerHTML='<i class="fas fa-book-open"></i>',as.title="切换到预览模式",ua.classList.add("active"),fa.classList.remove("active"),Kt.addEventListener("click",Zf),Or.addEventListener("click",ed),Ar==null||Ar.addEventListener("click",Jf),Lr==null||Lr.addEventListener("click",Yf),Cr==null||Cr.addEventListener("click",da),xr==null||xr.addEventListener("click",()=>Zo(-1)),Pr==null||Pr.addEventListener("click",()=>Zo(1)),de.addEventListener("keydown",e=>{e.ctrlKey&&e.key==="z"?(e.preventDefault(),Td()):e.ctrlKey&&e.key==="y"?(e.preventDefault(),Ad()):e.ctrlKey&&e.key==="s"&&(e.preventDefault(),ds())}),Nd(),$r==null||$r.addEventListener("click",e=>{e.preventDefault(),sd(),vt&&(vt.style.display="none")}),fd(bd),id()}async function xd(){console.log("Initializing Anki module..."),await Ec(),window.mermaid&&mermaid.initialize({startOnLoad:!1,theme:"neutral",securityLevel:"loose"}),ld(Xc),td(),await Oc(),je(),$d(),console.log("✅ Anki module initialized successfully.")}let wt=[],Jn=[],Dr=-1;async function Pd(n){const e=n.target,t=e.closest(".topic-item");if(!t)return;if(t.classList.contains("add-topic-btn")){if(!A.currentAgentId&&A.agents.length>0&&Z({currentAgentId:A.agents[0].id}),!A.currentAgentId){alert("请先在设置中创建一个 Agent 角色。");return}const r=prompt("请输入新主题的名称:");r&&(await Lf(r),Ut());return}if(e.closest(".topic-delete-btn")){const r=t.dataset.topicId;confirm(`确定要删除主题 "${t.querySelector("span").textContent}" 吗？`)&&(await Nc([r]),Ut());return}if(A.isTopicSelectionMode){const r=t.querySelector(".topic-selection-checkbox");r&&(r.checked=!r.checked,r.dispatchEvent(new Event("change",{bubbles:!0})));return}const s=t.dataset.topicId;if(s&&s!==A.currentTopicId){if(A.currentTopicId){const r=Ce.scrollTop,o={...A.topicScrollPositions||{},[A.currentTopicId]:r};Z({topicScrollPositions:o})}xc(s),Ut()}}async function Md(n){var r,o,c;const e=n.target.closest(".history-action-btn");if(!e)return;const s=e.closest(".history-item").dataset.messageId;if(e.classList.contains("delete-btn")){if(confirm("确定要删除这组对话吗？")){let f=[s];const h=e.closest(".history-item");h.classList.contains("role-user")&&((r=h.nextElementSibling)!=null&&r.classList.contains("role-assistant"))?f.push(h.nextElementSibling.dataset.messageId):h.classList.contains("role-assistant")&&((o=h.previousElementSibling)!=null&&o.classList.contains("role-user"))&&f.push(h.previousElementSibling.dataset.messageId),await Of(f),await _n()}}else if(e.classList.contains("edit-btn")){const f=((c=A.history.find(m=>m.id===s))==null?void 0:c.content)||"",h=prompt("编辑你的消息:",f);h&&h!==f&&confirm("编辑将删除此后的对话并重新生成回应，是否继续？")&&await Nf(s,h)}}function Dd(n){Z({topicListFilterTag:n.target.value}),jt();const e=Pc();if(!e.some(s=>s.id===A.currentTopicId)){const s=e.length>0?e[0].id:null;s?xc(s):Z({currentTopicId:null}),Ut()}}function Bd(n){A.currentTopicId&&(Z({currentConversationAgentId:n.target.value||null}),_n())}async function jd(){if(!A.currentTopicId)return;const n=A.topics.find(t=>t.id===A.currentTopicId),e=prompt("请输入新的主题名称:",n.title);e&&e.trim()!==n.title&&(await Cf(A.currentTopicId,{title:e.trim()}),jt())}async function ec(){const n=ri.value.trim();!n&&wt.length===0||A.isAiThinking||(await $c(n,[...wt]),ri.value="",wt=[],Sa([]),ri.focus())}function Kd(n){wt=[],Array.from(n.target.files).forEach(e=>{const t=new FileReader;t.onload=s=>{wt.push({name:e.name,data:s.target.result}),Sa(wt)},t.readAsDataURL(e)}),n.target.value=""}function qd(n){const e=n.target.closest(".remove-attachment-btn");e&&(wt.splice(parseInt(e.dataset.index,10),1),Sa(wt))}function Rd(){sa.addEventListener("click",()=>tc(-1)),ia.addEventListener("click",()=>tc(1))}function tc(n){if(Jn=Array.from(Ce.querySelectorAll(".history-item.role-user")),Jn.length===0)return;document.querySelectorAll(".history-item.highlighted").forEach(t=>t.classList.remove("highlighted")),Dr=(Dr+n+Jn.length)%Jn.length;const e=Jn[Dr];if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlighted");const t=e.nextElementSibling;t&&t.classList.contains("history-item")&&t.classList.add("highlighted")}}function Fd(){Z({isTopicsPanelHidden:!A.isTopicsPanelHidden}),Ut()}function Hd(){ss.addEventListener("click",Pd),Ce.addEventListener("click",Md),Xn.addEventListener("change",Dd),ii.addEventListener("change",Bd),kc.addEventListener("click",jd),wc.addEventListener("click",Fd),ea.addEventListener("click",()=>{Z({isTopicSelectionMode:!0,selectedTopicIds:[]}),jt()}),Qu.addEventListener("click",()=>{Z({isTopicSelectionMode:!1,selectedTopicIds:[]}),jt()}),Sc.addEventListener("click",()=>{const n=A.topics.map(t=>t.id),e=A.selectedTopicIds.length===n.length?[]:n;Z({selectedTopicIds:e}),jt()}),ta.addEventListener("click",async()=>{const n=A.selectedTopicIds.length;n>0&&confirm(`确定要删除选中的 ${n} 个主题吗？`)&&(await Nc(A.selectedTopicIds),Ut())}),ss.addEventListener("change",n=>{if(n.target.classList.contains("topic-selection-checkbox")){const e=n.target.dataset.topicId,t=new Set(A.selectedTopicIds);n.target.checked?t.add(e):t.delete(e),Z({selectedTopicIds:Array.from(t)}),jt()}}),Xu.addEventListener("click",ec),ri.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),ec())}),Zu.addEventListener("click",()=>xo.click()),xo.addEventListener("change",Kd),na.addEventListener("click",qd),Rd()}async function Ud(){console.log("Initializing AI Agent module UI..."),Ut(),Hd()}const Ea=Symbol.for("yaml.alias"),pa=Symbol.for("yaml.document"),kt=Symbol.for("yaml.map"),Zc=Symbol.for("yaml.pair"),tt=Symbol.for("yaml.scalar"),Ln=Symbol.for("yaml.seq"),Ue=Symbol.for("yaml.node.type"),Et=n=>!!n&&typeof n=="object"&&n[Ue]===Ea,Jt=n=>!!n&&typeof n=="object"&&n[Ue]===pa,Cn=n=>!!n&&typeof n=="object"&&n[Ue]===kt,we=n=>!!n&&typeof n=="object"&&n[Ue]===Zc,me=n=>!!n&&typeof n=="object"&&n[Ue]===tt,On=n=>!!n&&typeof n=="object"&&n[Ue]===Ln;function ke(n){if(n&&typeof n=="object")switch(n[Ue]){case kt:case Ln:return!0}return!1}function Se(n){if(n&&typeof n=="object")switch(n[Ue]){case Ea:case kt:case tt:case Ln:return!0}return!1}const el=n=>(me(n)||ke(n))&&!!n.anchor,Be=Symbol("break visit"),tl=Symbol("skip children"),et=Symbol("remove node");function Wt(n,e){const t=nl(e);Jt(n)?dn(null,n.contents,t,Object.freeze([n]))===et&&(n.contents=null):dn(null,n,t,Object.freeze([]))}Wt.BREAK=Be;Wt.SKIP=tl;Wt.REMOVE=et;function dn(n,e,t,s){const r=sl(n,e,t,s);if(Se(r)||we(r))return il(n,s,r),dn(n,r,t,s);if(typeof r!="symbol"){if(ke(e)){s=Object.freeze(s.concat(e));for(let o=0;o<e.items.length;++o){const c=dn(o,e.items[o],t,s);if(typeof c=="number")o=c-1;else{if(c===Be)return Be;c===et&&(e.items.splice(o,1),o-=1)}}}else if(we(e)){s=Object.freeze(s.concat(e));const o=dn("key",e.key,t,s);if(o===Be)return Be;o===et&&(e.key=null);const c=dn("value",e.value,t,s);if(c===Be)return Be;c===et&&(e.value=null)}}return r}async function Ii(n,e){const t=nl(e);Jt(n)?await hn(null,n.contents,t,Object.freeze([n]))===et&&(n.contents=null):await hn(null,n,t,Object.freeze([]))}Ii.BREAK=Be;Ii.SKIP=tl;Ii.REMOVE=et;async function hn(n,e,t,s){const r=await sl(n,e,t,s);if(Se(r)||we(r))return il(n,s,r),hn(n,r,t,s);if(typeof r!="symbol"){if(ke(e)){s=Object.freeze(s.concat(e));for(let o=0;o<e.items.length;++o){const c=await hn(o,e.items[o],t,s);if(typeof c=="number")o=c-1;else{if(c===Be)return Be;c===et&&(e.items.splice(o,1),o-=1)}}}else if(we(e)){s=Object.freeze(s.concat(e));const o=await hn("key",e.key,t,s);if(o===Be)return Be;o===et&&(e.key=null);const c=await hn("value",e.value,t,s);if(c===Be)return Be;c===et&&(e.value=null)}}return r}function nl(n){return typeof n=="object"&&(n.Collection||n.Node||n.Value)?Object.assign({Alias:n.Node,Map:n.Node,Scalar:n.Node,Seq:n.Node},n.Value&&{Map:n.Value,Scalar:n.Value,Seq:n.Value},n.Collection&&{Map:n.Collection,Seq:n.Collection},n):n}function sl(n,e,t,s){var r,o,c,f,h;if(typeof t=="function")return t(n,e,s);if(Cn(e))return(r=t.Map)==null?void 0:r.call(t,n,e,s);if(On(e))return(o=t.Seq)==null?void 0:o.call(t,n,e,s);if(we(e))return(c=t.Pair)==null?void 0:c.call(t,n,e,s);if(me(e))return(f=t.Scalar)==null?void 0:f.call(t,n,e,s);if(Et(e))return(h=t.Alias)==null?void 0:h.call(t,n,e,s)}function il(n,e,t){const s=e[e.length-1];if(ke(s))s.items[n]=t;else if(we(s))n==="key"?s.key=t:s.value=t;else if(Jt(s))s.contents=t;else{const r=Et(s)?"alias":"scalar";throw new Error(`Cannot replace node with ${r} parent`)}}const zd={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},Vd=n=>n.replace(/[!,[\]{}]/g,e=>zd[e]);class Me{constructor(e,t){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Me.defaultYaml,e),this.tags=Object.assign({},Me.defaultTags,t)}clone(){const e=new Me(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){const e=new Me(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Me.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Me.defaultTags);break}return e}add(e,t){this.atNextDocument&&(this.yaml={explicit:Me.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Me.defaultTags),this.atNextDocument=!1);const s=e.trim().split(/[ \t]+/),r=s.shift();switch(r){case"%TAG":{if(s.length!==2&&(t(0,"%TAG directive should contain exactly two parts"),s.length<2))return!1;const[o,c]=s;return this.tags[o]=c,!0}case"%YAML":{if(this.yaml.explicit=!0,s.length!==1)return t(0,"%YAML directive should contain exactly one part"),!1;const[o]=s;if(o==="1.1"||o==="1.2")return this.yaml.version=o,!0;{const c=/^\d+\.\d+$/.test(o);return t(6,`Unsupported YAML version ${o}`,c),!1}}default:return t(0,`Unknown directive ${r}`,!0),!1}}tagName(e,t){if(e==="!")return"!";if(e[0]!=="!")return t(`Not a valid tag: ${e}`),null;if(e[1]==="<"){const c=e.slice(2,-1);return c==="!"||c==="!!"?(t(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(e[e.length-1]!==">"&&t("Verbatim tags must end with a >"),c)}const[,s,r]=e.match(/^(.*!)([^!]*)$/s);r||t(`The ${e} tag has no suffix`);const o=this.tags[s];if(o)try{return o+decodeURIComponent(r)}catch(c){return t(String(c)),null}return s==="!"?e:(t(`Could not resolve tag: ${e}`),null)}tagString(e){for(const[t,s]of Object.entries(this.tags))if(e.startsWith(s))return t+Vd(e.substring(s.length));return e[0]==="!"?e:`!<${e}>`}toString(e){const t=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],s=Object.entries(this.tags);let r;if(e&&s.length>0&&Se(e.contents)){const o={};Wt(e.contents,(c,f)=>{Se(f)&&f.tag&&(o[f.tag]=!0)}),r=Object.keys(o)}else r=[];for(const[o,c]of s)o==="!!"&&c==="tag:yaml.org,2002:"||(!e||r.some(f=>f.startsWith(c)))&&t.push(`%TAG ${o} ${c}`);return t.join(`
`)}}Me.defaultYaml={explicit:!1,version:"1.2"};Me.defaultTags={"!!":"tag:yaml.org,2002:"};function rl(n){if(/[\x00-\x19\s,[\]{}]/.test(n)){const t=`Anchor must not contain whitespace or control characters: ${JSON.stringify(n)}`;throw new Error(t)}return!0}function al(n){const e=new Set;return Wt(n,{Value(t,s){s.anchor&&e.add(s.anchor)}}),e}function ol(n,e){for(let t=1;;++t){const s=`${n}${t}`;if(!e.has(s))return s}}function Yd(n,e){const t=[],s=new Map;let r=null;return{onAnchor:o=>{t.push(o),r??(r=al(n));const c=ol(e,r);return r.add(c),c},setAnchors:()=>{for(const o of t){const c=s.get(o);if(typeof c=="object"&&c.anchor&&(me(c.node)||ke(c.node)))c.node.anchor=c.anchor;else{const f=new Error("Failed to resolve repeated object (this should not happen)");throw f.source=o,f}}},sourceObjects:s}}function pn(n,e,t,s){if(s&&typeof s=="object")if(Array.isArray(s))for(let r=0,o=s.length;r<o;++r){const c=s[r],f=pn(n,s,String(r),c);f===void 0?delete s[r]:f!==c&&(s[r]=f)}else if(s instanceof Map)for(const r of Array.from(s.keys())){const o=s.get(r),c=pn(n,s,r,o);c===void 0?s.delete(r):c!==o&&s.set(r,c)}else if(s instanceof Set)for(const r of Array.from(s)){const o=pn(n,s,r,r);o===void 0?s.delete(r):o!==r&&(s.delete(r),s.add(o))}else for(const[r,o]of Object.entries(s)){const c=pn(n,s,r,o);c===void 0?delete s[r]:c!==o&&(s[r]=c)}return n.call(e,t,s)}function He(n,e,t){if(Array.isArray(n))return n.map((s,r)=>He(s,String(r),t));if(n&&typeof n.toJSON=="function"){if(!t||!el(n))return n.toJSON(e,t);const s={aliasCount:0,count:1,res:void 0};t.anchors.set(n,s),t.onCreate=o=>{s.res=o,delete t.onCreate};const r=n.toJSON(e,t);return t.onCreate&&t.onCreate(r),r}return typeof n=="bigint"&&!(t!=null&&t.keep)?Number(n):n}class Ta{constructor(e){Object.defineProperty(this,Ue,{value:e})}clone(){const e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:t,maxAliasCount:s,onAnchor:r,reviver:o}={}){if(!Jt(e))throw new TypeError("A document argument is required");const c={anchors:new Map,doc:e,keep:!0,mapAsMap:t===!0,mapKeyWarned:!1,maxAliasCount:typeof s=="number"?s:100},f=He(this,"",c);if(typeof r=="function")for(const{count:h,res:m}of c.anchors.values())r(m,h);return typeof o=="function"?pn(o,{"":f},"",f):f}}class Ei extends Ta{constructor(e){super(Ea),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e,t){let s;t!=null&&t.aliasResolveCache?s=t.aliasResolveCache:(s=[],Wt(e,{Node:(o,c)=>{(Et(c)||el(c))&&s.push(c)}}),t&&(t.aliasResolveCache=s));let r;for(const o of s){if(o===this)break;o.anchor===this.source&&(r=o)}return r}toJSON(e,t){if(!t)return{source:this.source};const{anchors:s,doc:r,maxAliasCount:o}=t,c=this.resolve(r,t);if(!c){const h=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(h)}let f=s.get(c);if(f||(He(c,null,t),f=s.get(c)),!f||f.res===void 0){const h="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(h)}if(o>=0&&(f.count+=1,f.aliasCount===0&&(f.aliasCount=oi(r,c,s)),f.count*f.aliasCount>o)){const h="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(h)}return f.res}toString(e,t,s){const r=`*${this.source}`;if(e){if(rl(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){const o=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(o)}if(e.implicitKey)return`${r} `}return r}}function oi(n,e,t){if(Et(e)){const s=e.resolve(n),r=t&&s&&t.get(s);return r?r.count*r.aliasCount:0}else if(ke(e)){let s=0;for(const r of e.items){const o=oi(n,r,t);o>s&&(s=o)}return s}else if(we(e)){const s=oi(n,e.key,t),r=oi(n,e.value,t);return Math.max(s,r)}return 1}const cl=n=>!n||typeof n!="function"&&typeof n!="object";class re extends Ta{constructor(e){super(tt),this.value=e}toJSON(e,t){return t!=null&&t.keep?this.value:He(this.value,e,t)}toString(){return String(this.value)}}re.BLOCK_FOLDED="BLOCK_FOLDED";re.BLOCK_LITERAL="BLOCK_LITERAL";re.PLAIN="PLAIN";re.QUOTE_DOUBLE="QUOTE_DOUBLE";re.QUOTE_SINGLE="QUOTE_SINGLE";const Jd="tag:yaml.org,2002:";function Wd(n,e,t){if(e){const s=t.filter(o=>o.tag===e),r=s.find(o=>!o.format)??s[0];if(!r)throw new Error(`Tag ${e} not found`);return r}return t.find(s=>{var r;return((r=s.identify)==null?void 0:r.call(s,n))&&!s.format})}function hs(n,e,t){var b,N,$;if(Jt(n)&&(n=n.contents),Se(n))return n;if(we(n)){const M=(N=(b=t.schema[kt]).createNode)==null?void 0:N.call(b,t.schema,null,t);return M.items.push(n),M}(n instanceof String||n instanceof Number||n instanceof Boolean||typeof BigInt<"u"&&n instanceof BigInt)&&(n=n.valueOf());const{aliasDuplicateObjects:s,onAnchor:r,onTagObj:o,schema:c,sourceObjects:f}=t;let h;if(s&&n&&typeof n=="object"){if(h=f.get(n),h)return h.anchor??(h.anchor=r(n)),new Ei(h.anchor);h={anchor:null,node:null},f.set(n,h)}e!=null&&e.startsWith("!!")&&(e=Jd+e.slice(2));let m=Wd(n,e,c.tags);if(!m){if(n&&typeof n.toJSON=="function"&&(n=n.toJSON()),!n||typeof n!="object"){const M=new re(n);return h&&(h.node=M),M}m=n instanceof Map?c[kt]:Symbol.iterator in Object(n)?c[Ln]:c[kt]}o&&(o(m),delete t.onTagObj);const I=m!=null&&m.createNode?m.createNode(t.schema,n,t):typeof(($=m==null?void 0:m.nodeClass)==null?void 0:$.from)=="function"?m.nodeClass.from(t.schema,n,t):new re(n);return e?I.tag=e:m.default||(I.tag=m.tag),h&&(h.node=I),I}function yi(n,e,t){let s=t;for(let r=e.length-1;r>=0;--r){const o=e[r];if(typeof o=="number"&&Number.isInteger(o)&&o>=0){const c=[];c[o]=s,s=c}else s=new Map([[o,s]])}return hs(s,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:n,sourceObjects:new Map})}const es=n=>n==null||typeof n=="object"&&!!n[Symbol.iterator]().next().done;class ll extends Ta{constructor(e,t){super(e),Object.defineProperty(this,"schema",{value:t,configurable:!0,enumerable:!1,writable:!0})}clone(e){const t=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(t.schema=e),t.items=t.items.map(s=>Se(s)||we(s)?s.clone(e):s),this.range&&(t.range=this.range.slice()),t}addIn(e,t){if(es(e))this.add(t);else{const[s,...r]=e,o=this.get(s,!0);if(ke(o))o.addIn(r,t);else if(o===void 0&&this.schema)this.set(s,yi(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}deleteIn(e){const[t,...s]=e;if(s.length===0)return this.delete(t);const r=this.get(t,!0);if(ke(r))return r.deleteIn(s);throw new Error(`Expected YAML collection at ${t}. Remaining path: ${s}`)}getIn(e,t){const[s,...r]=e,o=this.get(s,!0);return r.length===0?!t&&me(o)?o.value:o:ke(o)?o.getIn(r,t):void 0}hasAllNullValues(e){return this.items.every(t=>{if(!we(t))return!1;const s=t.value;return s==null||e&&me(s)&&s.value==null&&!s.commentBefore&&!s.comment&&!s.tag})}hasIn(e){const[t,...s]=e;if(s.length===0)return this.has(t);const r=this.get(t,!0);return ke(r)?r.hasIn(s):!1}setIn(e,t){const[s,...r]=e;if(r.length===0)this.set(s,t);else{const o=this.get(s,!0);if(ke(o))o.setIn(r,t);else if(o===void 0&&this.schema)this.set(s,yi(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}}const Gd=n=>n.replace(/^(?!$)(?: $)?/gm,"#");function lt(n,e){return/^\n+$/.test(n)?n.substring(1):e?n.replace(/^(?! *$)/gm,e):n}const qt=(n,e,t)=>n.endsWith(`
`)?lt(t,e):t.includes(`
`)?`
`+lt(t,e):(n.endsWith(" ")?"":" ")+t,ul="flow",ma="block",ci="quoted";function Ti(n,e,t="flow",{indentAtStart:s,lineWidth:r=80,minContentWidth:o=20,onFold:c,onOverflow:f}={}){if(!r||r<0)return n;r<o&&(o=0);const h=Math.max(1+o,1+r-e.length);if(n.length<=h)return n;const m=[],I={};let b=r-e.length;typeof s=="number"&&(s>r-Math.max(2,o)?m.push(0):b=r-s);let N,$,M=!1,L=-1,P=-1,z=-1;t===ma&&(L=nc(n,L,e.length),L!==-1&&(b=L+h));for(let X;X=n[L+=1];){if(t===ci&&X==="\\"){switch(P=L,n[L+1]){case"x":L+=3;break;case"u":L+=5;break;case"U":L+=9;break;default:L+=1}z=L}if(X===`
`)t===ma&&(L=nc(n,L,e.length)),b=L+e.length+h,N=void 0;else{if(X===" "&&$&&$!==" "&&$!==`
`&&$!=="	"){const Q=n[L+1];Q&&Q!==" "&&Q!==`
`&&Q!=="	"&&(N=L)}if(L>=b)if(N)m.push(N),b=N+h,N=void 0;else if(t===ci){for(;$===" "||$==="	";)$=X,X=n[L+=1],M=!0;const Q=L>z+1?L-2:P-1;if(I[Q])return n;m.push(Q),I[Q]=!0,b=Q+h,N=void 0}else M=!0}$=X}if(M&&f&&f(),m.length===0)return n;c&&c();let J=n.slice(0,m[0]);for(let X=0;X<m.length;++X){const Q=m[X],te=m[X+1]||n.length;Q===0?J=`
${e}${n.slice(0,te)}`:(t===ci&&I[Q]&&(J+=`${n[Q]}\\`),J+=`
${e}${n.slice(Q+1,te)}`)}return J}function nc(n,e,t){let s=e,r=e+1,o=n[r];for(;o===" "||o==="	";)if(e<r+t)o=n[++e];else{do o=n[++e];while(o&&o!==`
`);s=e,r=e+1,o=n[r]}return s}const Ai=(n,e)=>({indentAtStart:e?n.indent.length:n.indentAtStart,lineWidth:n.options.lineWidth,minContentWidth:n.options.minContentWidth}),Li=n=>/^(%|---|\.\.\.)/m.test(n);function Qd(n,e,t){if(!e||e<0)return!1;const s=e-t,r=n.length;if(r<=s)return!1;for(let o=0,c=0;o<r;++o)if(n[o]===`
`){if(o-c>s)return!0;if(c=o+1,r-c<=s)return!1}return!0}function cs(n,e){const t=JSON.stringify(n);if(e.options.doubleQuotedAsJSON)return t;const{implicitKey:s}=e,r=e.options.doubleQuotedMinMultiLineLength,o=e.indent||(Li(n)?"  ":"");let c="",f=0;for(let h=0,m=t[h];m;m=t[++h])if(m===" "&&t[h+1]==="\\"&&t[h+2]==="n"&&(c+=t.slice(f,h)+"\\ ",h+=1,f=h,m="\\"),m==="\\")switch(t[h+1]){case"u":{c+=t.slice(f,h);const I=t.substr(h+2,4);switch(I){case"0000":c+="\\0";break;case"0007":c+="\\a";break;case"000b":c+="\\v";break;case"001b":c+="\\e";break;case"0085":c+="\\N";break;case"00a0":c+="\\_";break;case"2028":c+="\\L";break;case"2029":c+="\\P";break;default:I.substr(0,2)==="00"?c+="\\x"+I.substr(2):c+=t.substr(h,6)}h+=5,f=h+1}break;case"n":if(s||t[h+2]==='"'||t.length<r)h+=1;else{for(c+=t.slice(f,h)+`

`;t[h+2]==="\\"&&t[h+3]==="n"&&t[h+4]!=='"';)c+=`
`,h+=2;c+=o,t[h+2]===" "&&(c+="\\"),h+=1,f=h+1}break;default:h+=1}return c=f?c+t.slice(f):t,s?c:Ti(c,o,ci,Ai(e,!1))}function ya(n,e){if(e.options.singleQuote===!1||e.implicitKey&&n.includes(`
`)||/[ \t]\n|\n[ \t]/.test(n))return cs(n,e);const t=e.indent||(Li(n)?"  ":""),s="'"+n.replace(/'/g,"''").replace(/\n+/g,`$&
${t}`)+"'";return e.implicitKey?s:Ti(s,t,ul,Ai(e,!1))}function mn(n,e){const{singleQuote:t}=e.options;let s;if(t===!1)s=cs;else{const r=n.includes('"'),o=n.includes("'");r&&!o?s=ya:o&&!r?s=cs:s=t?ya:cs}return s(n,e)}let ga;try{ga=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{ga=/\n+(?!\n|$)/g}function li({comment:n,type:e,value:t},s,r,o){const{blockQuote:c,commentString:f,lineWidth:h}=s.options;if(!c||/\n[\t ]+$/.test(t)||/^\s*$/.test(t))return mn(t,s);const m=s.indent||(s.forceBlockIndent||Li(t)?"  ":""),I=c==="literal"?!0:c==="folded"||e===re.BLOCK_FOLDED?!1:e===re.BLOCK_LITERAL?!0:!Qd(t,h,m.length);if(!t)return I?`|
`:`>
`;let b,N;for(N=t.length;N>0;--N){const te=t[N-1];if(te!==`
`&&te!=="	"&&te!==" ")break}let $=t.substring(N);const M=$.indexOf(`
`);M===-1?b="-":t===$||M!==$.length-1?(b="+",o&&o()):b="",$&&(t=t.slice(0,-$.length),$[$.length-1]===`
`&&($=$.slice(0,-1)),$=$.replace(ga,`$&${m}`));let L=!1,P,z=-1;for(P=0;P<t.length;++P){const te=t[P];if(te===" ")L=!0;else if(te===`
`)z=P;else break}let J=t.substring(0,z<P?z+1:P);J&&(t=t.substring(J.length),J=J.replace(/\n+/g,`$&${m}`));let Q=(L?m?"2":"1":"")+b;if(n&&(Q+=" "+f(n.replace(/ ?[\r\n]+/g," ")),r&&r()),!I){const te=t.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${m}`);let ne=!1;const oe=Ai(s,!0);c!=="folded"&&e!==re.BLOCK_FOLDED&&(oe.onOverflow=()=>{ne=!0});const G=Ti(`${J}${te}${$}`,m,ma,oe);if(!ne)return`>${Q}
${m}${G}`}return t=t.replace(/\n+/g,`$&${m}`),`|${Q}
${m}${J}${t}${$}`}function Xd(n,e,t,s){const{type:r,value:o}=n,{actualString:c,implicitKey:f,indent:h,indentStep:m,inFlow:I}=e;if(f&&o.includes(`
`)||I&&/[[\]{},]/.test(o))return mn(o,e);if(/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(o))return f||I||!o.includes(`
`)?mn(o,e):li(n,e,t,s);if(!f&&!I&&r!==re.PLAIN&&o.includes(`
`))return li(n,e,t,s);if(Li(o)){if(h==="")return e.forceBlockIndent=!0,li(n,e,t,s);if(f&&h===m)return mn(o,e)}const b=o.replace(/\n+/g,`$&
${h}`);if(c){const N=L=>{var P;return L.default&&L.tag!=="tag:yaml.org,2002:str"&&((P=L.test)==null?void 0:P.test(b))},{compat:$,tags:M}=e.doc.schema;if(M.some(N)||$!=null&&$.some(N))return mn(o,e)}return f?b:Ti(b,h,ul,Ai(e,!1))}function gs(n,e,t,s){const{implicitKey:r,inFlow:o}=e,c=typeof n.value=="string"?n:Object.assign({},n,{value:String(n.value)});let{type:f}=n;f!==re.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(c.value)&&(f=re.QUOTE_DOUBLE);const h=I=>{switch(I){case re.BLOCK_FOLDED:case re.BLOCK_LITERAL:return r||o?mn(c.value,e):li(c,e,t,s);case re.QUOTE_DOUBLE:return cs(c.value,e);case re.QUOTE_SINGLE:return ya(c.value,e);case re.PLAIN:return Xd(c,e,t,s);default:return null}};let m=h(f);if(m===null){const{defaultKeyType:I,defaultStringType:b}=e.options,N=r&&I||b;if(m=h(N),m===null)throw new Error(`Unsupported default string type ${N}`)}return m}function fl(n,e){const t=Object.assign({blockQuote:!0,commentString:Gd,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},n.schema.toStringOptions,e);let s;switch(t.collectionStyle){case"block":s=!1;break;case"flow":s=!0;break;default:s=null}return{anchors:new Set,doc:n,flowCollectionPadding:t.flowCollectionPadding?" ":"",indent:"",indentStep:typeof t.indent=="number"?" ".repeat(t.indent):"  ",inFlow:s,options:t}}function Zd(n,e){var r;if(e.tag){const o=n.filter(c=>c.tag===e.tag);if(o.length>0)return o.find(c=>c.format===e.format)??o[0]}let t,s;if(me(e)){s=e.value;let o=n.filter(c=>{var f;return(f=c.identify)==null?void 0:f.call(c,s)});if(o.length>1){const c=o.filter(f=>f.test);c.length>0&&(o=c)}t=o.find(c=>c.format===e.format)??o.find(c=>!c.format)}else s=e,t=n.find(o=>o.nodeClass&&s instanceof o.nodeClass);if(!t){const o=((r=s==null?void 0:s.constructor)==null?void 0:r.name)??(s===null?"null":typeof s);throw new Error(`Tag not resolved for ${o} value`)}return t}function eh(n,e,{anchors:t,doc:s}){if(!s.directives)return"";const r=[],o=(me(n)||ke(n))&&n.anchor;o&&rl(o)&&(t.add(o),r.push(`&${o}`));const c=n.tag??(e.default?null:e.tag);return c&&r.push(s.directives.tagString(c)),r.join(" ")}function En(n,e,t,s){var h;if(we(n))return n.toString(e,t,s);if(Et(n)){if(e.doc.directives)return n.toString(e);if((h=e.resolvedAliases)!=null&&h.has(n))throw new TypeError("Cannot stringify circular structure without alias nodes");e.resolvedAliases?e.resolvedAliases.add(n):e.resolvedAliases=new Set([n]),n=n.resolve(e.doc)}let r;const o=Se(n)?n:e.doc.createNode(n,{onTagObj:m=>r=m});r??(r=Zd(e.doc.schema.tags,o));const c=eh(o,r,e);c.length>0&&(e.indentAtStart=(e.indentAtStart??0)+c.length+1);const f=typeof r.stringify=="function"?r.stringify(o,e,t,s):me(o)?gs(o,e,t,s):o.toString(e,t,s);return c?me(o)||f[0]==="{"||f[0]==="["?`${c} ${f}`:`${c}
${e.indent}${f}`:f}function th({key:n,value:e},t,s,r){const{allNullValues:o,doc:c,indent:f,indentStep:h,options:{commentString:m,indentSeq:I,simpleKeys:b}}=t;let N=Se(n)&&n.comment||null;if(b){if(N)throw new Error("With simple keys, key nodes cannot have comments");if(ke(n)||!Se(n)&&typeof n=="object"){const oe="With simple keys, collection cannot be used as a key value";throw new Error(oe)}}let $=!b&&(!n||N&&e==null&&!t.inFlow||ke(n)||(me(n)?n.type===re.BLOCK_FOLDED||n.type===re.BLOCK_LITERAL:typeof n=="object"));t=Object.assign({},t,{allNullValues:!1,implicitKey:!$&&(b||!o),indent:f+h});let M=!1,L=!1,P=En(n,t,()=>M=!0,()=>L=!0);if(!$&&!t.inFlow&&P.length>1024){if(b)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");$=!0}if(t.inFlow){if(o||e==null)return M&&s&&s(),P===""?"?":$?`? ${P}`:P}else if(o&&!b||e==null&&$)return P=`? ${P}`,N&&!M?P+=qt(P,t.indent,m(N)):L&&r&&r(),P;M&&(N=null),$?(N&&(P+=qt(P,t.indent,m(N))),P=`? ${P}
${f}:`):(P=`${P}:`,N&&(P+=qt(P,t.indent,m(N))));let z,J,X;Se(e)?(z=!!e.spaceBefore,J=e.commentBefore,X=e.comment):(z=!1,J=null,X=null,e&&typeof e=="object"&&(e=c.createNode(e))),t.implicitKey=!1,!$&&!N&&me(e)&&(t.indentAtStart=P.length+1),L=!1,!I&&h.length>=2&&!t.inFlow&&!$&&On(e)&&!e.flow&&!e.tag&&!e.anchor&&(t.indent=t.indent.substring(2));let Q=!1;const te=En(e,t,()=>Q=!0,()=>L=!0);let ne=" ";if(N||z||J){if(ne=z?`
`:"",J){const oe=m(J);ne+=`
${lt(oe,t.indent)}`}te===""&&!t.inFlow?ne===`
`&&(ne=`

`):ne+=`
${t.indent}`}else if(!$&&ke(e)){const oe=te[0],G=te.indexOf(`
`),ye=G!==-1,ze=t.inFlow??e.flow??e.items.length===0;if(ye||!ze){let nt=!1;if(ye&&(oe==="&"||oe==="!")){let ge=te.indexOf(" ");oe==="&"&&ge!==-1&&ge<G&&te[ge+1]==="!"&&(ge=te.indexOf(" ",ge+1)),(ge===-1||G<ge)&&(nt=!0)}nt||(ne=`
${t.indent}`)}}else(te===""||te[0]===`
`)&&(ne="");return P+=ne+te,t.inFlow?Q&&s&&s():X&&!Q?P+=qt(P,t.indent,m(X)):L&&r&&r(),P}function dl(n,e){(n==="debug"||n==="warn")&&console.warn(e)}const Gs="<<",ut={identify:n=>n===Gs||typeof n=="symbol"&&n.description===Gs,default:"key",tag:"tag:yaml.org,2002:merge",test:/^<<$/,resolve:()=>Object.assign(new re(Symbol(Gs)),{addToJSMap:hl}),stringify:()=>Gs},nh=(n,e)=>(ut.identify(e)||me(e)&&(!e.type||e.type===re.PLAIN)&&ut.identify(e.value))&&(n==null?void 0:n.doc.schema.tags.some(t=>t.tag===ut.tag&&t.default));function hl(n,e,t){if(t=n&&Et(t)?t.resolve(n.doc):t,On(t))for(const s of t.items)Br(n,e,s);else if(Array.isArray(t))for(const s of t)Br(n,e,s);else Br(n,e,t)}function Br(n,e,t){const s=n&&Et(t)?t.resolve(n.doc):t;if(!Cn(s))throw new Error("Merge sources must be maps or map aliases");const r=s.toJSON(null,n,Map);for(const[o,c]of r)e instanceof Map?e.has(o)||e.set(o,c):e instanceof Set?e.add(o):Object.prototype.hasOwnProperty.call(e,o)||Object.defineProperty(e,o,{value:c,writable:!0,enumerable:!0,configurable:!0});return e}function pl(n,e,{key:t,value:s}){if(Se(t)&&t.addToJSMap)t.addToJSMap(n,e,s);else if(nh(n,t))hl(n,e,s);else{const r=He(t,"",n);if(e instanceof Map)e.set(r,He(s,r,n));else if(e instanceof Set)e.add(r);else{const o=sh(t,r,n),c=He(s,o,n);o in e?Object.defineProperty(e,o,{value:c,writable:!0,enumerable:!0,configurable:!0}):e[o]=c}}return e}function sh(n,e,t){if(e===null)return"";if(typeof e!="object")return String(e);if(Se(n)&&(t!=null&&t.doc)){const s=fl(t.doc,{});s.anchors=new Set;for(const o of t.anchors.keys())s.anchors.add(o.anchor);s.inFlow=!0,s.inStringifyKey=!0;const r=n.toString(s);if(!t.mapKeyWarned){let o=JSON.stringify(r);o.length>40&&(o=o.substring(0,36)+'..."'),dl(t.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${o}. Set mapAsMap: true to use object keys.`),t.mapKeyWarned=!0}return r}return JSON.stringify(e)}function Aa(n,e,t){const s=hs(n,void 0,t),r=hs(e,void 0,t);return new xe(s,r)}class xe{constructor(e,t=null){Object.defineProperty(this,Ue,{value:Zc}),this.key=e,this.value=t}clone(e){let{key:t,value:s}=this;return Se(t)&&(t=t.clone(e)),Se(s)&&(s=s.clone(e)),new xe(t,s)}toJSON(e,t){const s=t!=null&&t.mapAsMap?new Map:{};return pl(t,s,this)}toString(e,t,s){return e!=null&&e.doc?th(this,e,t,s):JSON.stringify(this)}}function ml(n,e,t){return(e.inFlow??n.flow?rh:ih)(n,e,t)}function ih({comment:n,items:e},t,{blockItemPrefix:s,flowChars:r,itemIndent:o,onChompKeep:c,onComment:f}){const{indent:h,options:{commentString:m}}=t,I=Object.assign({},t,{indent:o,type:null});let b=!1;const N=[];for(let M=0;M<e.length;++M){const L=e[M];let P=null;if(Se(L))!b&&L.spaceBefore&&N.push(""),gi(t,N,L.commentBefore,b),L.comment&&(P=L.comment);else if(we(L)){const J=Se(L.key)?L.key:null;J&&(!b&&J.spaceBefore&&N.push(""),gi(t,N,J.commentBefore,b))}b=!1;let z=En(L,I,()=>P=null,()=>b=!0);P&&(z+=qt(z,o,m(P))),b&&P&&(b=!1),N.push(s+z)}let $;if(N.length===0)$=r.start+r.end;else{$=N[0];for(let M=1;M<N.length;++M){const L=N[M];$+=L?`
${h}${L}`:`
`}}return n?($+=`
`+lt(m(n),h),f&&f()):b&&c&&c(),$}function rh({items:n},e,{flowChars:t,itemIndent:s}){const{indent:r,indentStep:o,flowCollectionPadding:c,options:{commentString:f}}=e;s+=o;const h=Object.assign({},e,{indent:s,inFlow:!0,type:null});let m=!1,I=0;const b=[];for(let M=0;M<n.length;++M){const L=n[M];let P=null;if(Se(L))L.spaceBefore&&b.push(""),gi(e,b,L.commentBefore,!1),L.comment&&(P=L.comment);else if(we(L)){const J=Se(L.key)?L.key:null;J&&(J.spaceBefore&&b.push(""),gi(e,b,J.commentBefore,!1),J.comment&&(m=!0));const X=Se(L.value)?L.value:null;X?(X.comment&&(P=X.comment),X.commentBefore&&(m=!0)):L.value==null&&(J!=null&&J.comment)&&(P=J.comment)}P&&(m=!0);let z=En(L,h,()=>P=null);M<n.length-1&&(z+=","),P&&(z+=qt(z,s,f(P))),!m&&(b.length>I||z.includes(`
`))&&(m=!0),b.push(z),I=b.length}const{start:N,end:$}=t;if(b.length===0)return N+$;if(!m){const M=b.reduce((L,P)=>L+P.length+2,2);m=e.options.lineWidth>0&&M>e.options.lineWidth}if(m){let M=N;for(const L of b)M+=L?`
${o}${r}${L}`:`
`;return`${M}
${r}${$}`}else return`${N}${c}${b.join(" ")}${c}${$}`}function gi({indent:n,options:{commentString:e}},t,s,r){if(s&&r&&(s=s.replace(/^\n+/,"")),s){const o=lt(e(s),n);t.push(o.trimStart())}}function Rt(n,e){const t=me(e)?e.value:e;for(const s of n)if(we(s)&&(s.key===e||s.key===t||me(s.key)&&s.key.value===t))return s}class Re extends ll{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(kt,e),this.items=[]}static from(e,t,s){const{keepUndefined:r,replacer:o}=s,c=new this(e),f=(h,m)=>{if(typeof o=="function")m=o.call(t,h,m);else if(Array.isArray(o)&&!o.includes(h))return;(m!==void 0||r)&&c.items.push(Aa(h,m,s))};if(t instanceof Map)for(const[h,m]of t)f(h,m);else if(t&&typeof t=="object")for(const h of Object.keys(t))f(h,t[h]);return typeof e.sortMapEntries=="function"&&c.items.sort(e.sortMapEntries),c}add(e,t){var c;let s;we(e)?s=e:!e||typeof e!="object"||!("key"in e)?s=new xe(e,e==null?void 0:e.value):s=new xe(e.key,e.value);const r=Rt(this.items,s.key),o=(c=this.schema)==null?void 0:c.sortMapEntries;if(r){if(!t)throw new Error(`Key ${s.key} already set`);me(r.value)&&cl(s.value)?r.value.value=s.value:r.value=s.value}else if(o){const f=this.items.findIndex(h=>o(s,h)<0);f===-1?this.items.push(s):this.items.splice(f,0,s)}else this.items.push(s)}delete(e){const t=Rt(this.items,e);return t?this.items.splice(this.items.indexOf(t),1).length>0:!1}get(e,t){const s=Rt(this.items,e),r=s==null?void 0:s.value;return(!t&&me(r)?r.value:r)??void 0}has(e){return!!Rt(this.items,e)}set(e,t){this.add(new xe(e,t),!0)}toJSON(e,t,s){const r=s?new s:t!=null&&t.mapAsMap?new Map:{};t!=null&&t.onCreate&&t.onCreate(r);for(const o of this.items)pl(t,r,o);return r}toString(e,t,s){if(!e)return JSON.stringify(this);for(const r of this.items)if(!we(r))throw new Error(`Map items must all be pairs; found ${JSON.stringify(r)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),ml(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:s,onComment:t})}}const Nn={collection:"map",default:!0,nodeClass:Re,tag:"tag:yaml.org,2002:map",resolve(n,e){return Cn(n)||e("Expected a mapping for this tag"),n},createNode:(n,e,t)=>Re.from(n,e,t)};class St extends ll{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(Ln,e),this.items=[]}add(e){this.items.push(e)}delete(e){const t=Qs(e);return typeof t!="number"?!1:this.items.splice(t,1).length>0}get(e,t){const s=Qs(e);if(typeof s!="number")return;const r=this.items[s];return!t&&me(r)?r.value:r}has(e){const t=Qs(e);return typeof t=="number"&&t<this.items.length}set(e,t){const s=Qs(e);if(typeof s!="number")throw new Error(`Expected a valid index, not ${e}.`);const r=this.items[s];me(r)&&cl(t)?r.value=t:this.items[s]=t}toJSON(e,t){const s=[];t!=null&&t.onCreate&&t.onCreate(s);let r=0;for(const o of this.items)s.push(He(o,String(r++),t));return s}toString(e,t,s){return e?ml(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:s,onComment:t}):JSON.stringify(this)}static from(e,t,s){const{replacer:r}=s,o=new this(e);if(t&&Symbol.iterator in Object(t)){let c=0;for(let f of t){if(typeof r=="function"){const h=t instanceof Set?f:String(c++);f=r.call(t,h,f)}o.items.push(hs(f,void 0,s))}}return o}}function Qs(n){let e=me(n)?n.value:n;return e&&typeof e=="string"&&(e=Number(e)),typeof e=="number"&&Number.isInteger(e)&&e>=0?e:null}const $n={collection:"seq",default:!0,nodeClass:St,tag:"tag:yaml.org,2002:seq",resolve(n,e){return On(n)||e("Expected a sequence for this tag"),n},createNode:(n,e,t)=>St.from(n,e,t)},Ci={identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify(n,e,t,s){return e=Object.assign({actualString:!0},e),gs(n,e,t,s)}},Oi={identify:n=>n==null,createNode:()=>new re(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new re(null),stringify:({source:n},e)=>typeof n=="string"&&Oi.test.test(n)?n:e.options.nullStr},La={identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:n=>new re(n[0]==="t"||n[0]==="T"),stringify({source:n,value:e},t){if(n&&La.test.test(n)){const s=n[0]==="t"||n[0]==="T";if(e===s)return n}return e?t.options.trueStr:t.options.falseStr}};function Je({format:n,minFractionDigits:e,tag:t,value:s}){if(typeof s=="bigint")return String(s);const r=typeof s=="number"?s:Number(s);if(!isFinite(r))return isNaN(r)?".nan":r<0?"-.inf":".inf";let o=JSON.stringify(s);if(!n&&e&&(!t||t==="tag:yaml.org,2002:float")&&/^\d/.test(o)){let c=o.indexOf(".");c<0&&(c=o.length,o+=".");let f=e-(o.length-c-1);for(;f-- >0;)o+="0"}return o}const yl={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Je},gl={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Je(n)}},vl={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(n){const e=new re(parseFloat(n)),t=n.indexOf(".");return t!==-1&&n[n.length-1]==="0"&&(e.minFractionDigits=n.length-t-1),e},stringify:Je},Ni=n=>typeof n=="bigint"||Number.isInteger(n),Ca=(n,e,t,{intAsBigInt:s})=>s?BigInt(n):parseInt(n.substring(e),t);function bl(n,e,t){const{value:s}=n;return Ni(s)&&s>=0?t+s.toString(e):Je(n)}const wl={identify:n=>Ni(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(n,e,t)=>Ca(n,2,8,t),stringify:n=>bl(n,8,"0o")},kl={identify:Ni,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(n,e,t)=>Ca(n,0,10,t),stringify:Je},Sl={identify:n=>Ni(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(n,e,t)=>Ca(n,2,16,t),stringify:n=>bl(n,16,"0x")},ah=[Nn,$n,Ci,Oi,La,wl,kl,Sl,yl,gl,vl];function sc(n){return typeof n=="bigint"||Number.isInteger(n)}const Xs=({value:n})=>JSON.stringify(n),oh=[{identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify:Xs},{identify:n=>n==null,createNode:()=>new re(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:Xs},{identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true$|^false$/,resolve:n=>n==="true",stringify:Xs},{identify:sc,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(n,e,{intAsBigInt:t})=>t?BigInt(n):parseInt(n,10),stringify:({value:n})=>sc(n)?n.toString():JSON.stringify(n)},{identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:n=>parseFloat(n),stringify:Xs}],ch={default:!0,tag:"",test:/^/,resolve(n,e){return e(`Unresolved plain scalar ${JSON.stringify(n)}`),n}},lh=[Nn,$n].concat(oh,ch),Oa={identify:n=>n instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(n,e){if(typeof atob=="function"){const t=atob(n.replace(/[\n\r]/g,"")),s=new Uint8Array(t.length);for(let r=0;r<t.length;++r)s[r]=t.charCodeAt(r);return s}else return e("This environment does not support reading binary tags; either Buffer or atob is required"),n},stringify({comment:n,type:e,value:t},s,r,o){if(!t)return"";const c=t;let f;if(typeof btoa=="function"){let h="";for(let m=0;m<c.length;++m)h+=String.fromCharCode(c[m]);f=btoa(h)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(e??(e=re.BLOCK_LITERAL),e!==re.QUOTE_DOUBLE){const h=Math.max(s.options.lineWidth-s.indent.length,s.options.minContentWidth),m=Math.ceil(f.length/h),I=new Array(m);for(let b=0,N=0;b<m;++b,N+=h)I[b]=f.substr(N,h);f=I.join(e===re.BLOCK_LITERAL?`
`:" ")}return gs({comment:n,type:e,value:f},s,r,o)}};function _l(n,e){if(On(n))for(let t=0;t<n.items.length;++t){let s=n.items[t];if(!we(s)){if(Cn(s)){s.items.length>1&&e("Each pair must have its own sequence indicator");const r=s.items[0]||new xe(new re(null));if(s.commentBefore&&(r.key.commentBefore=r.key.commentBefore?`${s.commentBefore}
${r.key.commentBefore}`:s.commentBefore),s.comment){const o=r.value??r.key;o.comment=o.comment?`${s.comment}
${o.comment}`:s.comment}s=r}n.items[t]=we(s)?s:new xe(s)}}else e("Expected a sequence for this tag");return n}function Il(n,e,t){const{replacer:s}=t,r=new St(n);r.tag="tag:yaml.org,2002:pairs";let o=0;if(e&&Symbol.iterator in Object(e))for(let c of e){typeof s=="function"&&(c=s.call(e,String(o++),c));let f,h;if(Array.isArray(c))if(c.length===2)f=c[0],h=c[1];else throw new TypeError(`Expected [key, value] tuple: ${c}`);else if(c&&c instanceof Object){const m=Object.keys(c);if(m.length===1)f=m[0],h=c[f];else throw new TypeError(`Expected tuple with one key, not ${m.length} keys`)}else f=c;r.items.push(Aa(f,h,t))}return r}const Na={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:_l,createNode:Il};class vn extends St{constructor(){super(),this.add=Re.prototype.add.bind(this),this.delete=Re.prototype.delete.bind(this),this.get=Re.prototype.get.bind(this),this.has=Re.prototype.has.bind(this),this.set=Re.prototype.set.bind(this),this.tag=vn.tag}toJSON(e,t){if(!t)return super.toJSON(e);const s=new Map;t!=null&&t.onCreate&&t.onCreate(s);for(const r of this.items){let o,c;if(we(r)?(o=He(r.key,"",t),c=He(r.value,o,t)):o=He(r,"",t),s.has(o))throw new Error("Ordered maps must not include duplicate keys");s.set(o,c)}return s}static from(e,t,s){const r=Il(e,t,s),o=new this;return o.items=r.items,o}}vn.tag="tag:yaml.org,2002:omap";const $a={collection:"seq",identify:n=>n instanceof Map,nodeClass:vn,default:!1,tag:"tag:yaml.org,2002:omap",resolve(n,e){const t=_l(n,e),s=[];for(const{key:r}of t.items)me(r)&&(s.includes(r.value)?e(`Ordered maps must not include duplicate keys: ${r.value}`):s.push(r.value));return Object.assign(new vn,t)},createNode:(n,e,t)=>vn.from(n,e,t)};function El({value:n,source:e},t){return e&&(n?Tl:Al).test.test(e)?e:n?t.options.trueStr:t.options.falseStr}const Tl={identify:n=>n===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new re(!0),stringify:El},Al={identify:n=>n===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/,resolve:()=>new re(!1),stringify:El},uh={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Je},fh={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n.replace(/_/g,"")),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Je(n)}},dh={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(n){const e=new re(parseFloat(n.replace(/_/g,""))),t=n.indexOf(".");if(t!==-1){const s=n.substring(t+1).replace(/_/g,"");s[s.length-1]==="0"&&(e.minFractionDigits=s.length)}return e},stringify:Je},vs=n=>typeof n=="bigint"||Number.isInteger(n);function $i(n,e,t,{intAsBigInt:s}){const r=n[0];if((r==="-"||r==="+")&&(e+=1),n=n.substring(e).replace(/_/g,""),s){switch(t){case 2:n=`0b${n}`;break;case 8:n=`0o${n}`;break;case 16:n=`0x${n}`;break}const c=BigInt(n);return r==="-"?BigInt(-1)*c:c}const o=parseInt(n,t);return r==="-"?-1*o:o}function xa(n,e,t){const{value:s}=n;if(vs(s)){const r=s.toString(e);return s<0?"-"+t+r.substr(1):t+r}return Je(n)}const hh={identify:vs,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(n,e,t)=>$i(n,2,2,t),stringify:n=>xa(n,2,"0b")},ph={identify:vs,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(n,e,t)=>$i(n,1,8,t),stringify:n=>xa(n,8,"0")},mh={identify:vs,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(n,e,t)=>$i(n,0,10,t),stringify:Je},yh={identify:vs,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(n,e,t)=>$i(n,2,16,t),stringify:n=>xa(n,16,"0x")};class bn extends Re{constructor(e){super(e),this.tag=bn.tag}add(e){let t;we(e)?t=e:e&&typeof e=="object"&&"key"in e&&"value"in e&&e.value===null?t=new xe(e.key,null):t=new xe(e,null),Rt(this.items,t.key)||this.items.push(t)}get(e,t){const s=Rt(this.items,e);return!t&&we(s)?me(s.key)?s.key.value:s.key:s}set(e,t){if(typeof t!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof t}`);const s=Rt(this.items,e);s&&!t?this.items.splice(this.items.indexOf(s),1):!s&&t&&this.items.push(new xe(e))}toJSON(e,t){return super.toJSON(e,t,Set)}toString(e,t,s){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),t,s);throw new Error("Set items must all have null values")}static from(e,t,s){const{replacer:r}=s,o=new this(e);if(t&&Symbol.iterator in Object(t))for(let c of t)typeof r=="function"&&(c=r.call(t,c,c)),o.items.push(Aa(c,null,s));return o}}bn.tag="tag:yaml.org,2002:set";const Pa={collection:"map",identify:n=>n instanceof Set,nodeClass:bn,default:!1,tag:"tag:yaml.org,2002:set",createNode:(n,e,t)=>bn.from(n,e,t),resolve(n,e){if(Cn(n)){if(n.hasAllNullValues(!0))return Object.assign(new bn,n);e("Set items must all have null values")}else e("Expected a mapping for this tag");return n}};function Ma(n,e){const t=n[0],s=t==="-"||t==="+"?n.substring(1):n,r=c=>e?BigInt(c):Number(c),o=s.replace(/_/g,"").split(":").reduce((c,f)=>c*r(60)+r(f),r(0));return t==="-"?r(-1)*o:o}function Ll(n){let{value:e}=n,t=c=>c;if(typeof e=="bigint")t=c=>BigInt(c);else if(isNaN(e)||!isFinite(e))return Je(n);let s="";e<0&&(s="-",e*=t(-1));const r=t(60),o=[e%r];return e<60?o.unshift(0):(e=(e-o[0])/r,o.unshift(e%r),e>=60&&(e=(e-o[0])/r,o.unshift(e))),s+o.map(c=>String(c).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const Cl={identify:n=>typeof n=="bigint"||Number.isInteger(n),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(n,e,{intAsBigInt:t})=>Ma(n,t),stringify:Ll},Ol={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:n=>Ma(n,!1),stringify:Ll},xi={identify:n=>n instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(n){const e=n.match(xi.test);if(!e)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,t,s,r,o,c,f]=e.map(Number),h=e[7]?Number((e[7]+"00").substr(1,3)):0;let m=Date.UTC(t,s-1,r,o||0,c||0,f||0,h);const I=e[8];if(I&&I!=="Z"){let b=Ma(I,!1);Math.abs(b)<30&&(b*=60),m-=6e4*b}return new Date(m)},stringify:({value:n})=>(n==null?void 0:n.toISOString().replace(/(T00:00:00)?\.000Z$/,""))??""},ic=[Nn,$n,Ci,Oi,Tl,Al,hh,ph,mh,yh,uh,fh,dh,Oa,ut,$a,Na,Pa,Cl,Ol,xi],rc=new Map([["core",ah],["failsafe",[Nn,$n,Ci]],["json",lh],["yaml11",ic],["yaml-1.1",ic]]),ac={binary:Oa,bool:La,float:vl,floatExp:gl,floatNaN:yl,floatTime:Ol,int:kl,intHex:Sl,intOct:wl,intTime:Cl,map:Nn,merge:ut,null:Oi,omap:$a,pairs:Na,seq:$n,set:Pa,timestamp:xi},gh={"tag:yaml.org,2002:binary":Oa,"tag:yaml.org,2002:merge":ut,"tag:yaml.org,2002:omap":$a,"tag:yaml.org,2002:pairs":Na,"tag:yaml.org,2002:set":Pa,"tag:yaml.org,2002:timestamp":xi};function jr(n,e,t){const s=rc.get(e);if(s&&!n)return t&&!s.includes(ut)?s.concat(ut):s.slice();let r=s;if(!r)if(Array.isArray(n))r=[];else{const o=Array.from(rc.keys()).filter(c=>c!=="yaml11").map(c=>JSON.stringify(c)).join(", ");throw new Error(`Unknown schema "${e}"; use one of ${o} or define customTags array`)}if(Array.isArray(n))for(const o of n)r=r.concat(o);else typeof n=="function"&&(r=n(r.slice()));return t&&(r=r.concat(ut)),r.reduce((o,c)=>{const f=typeof c=="string"?ac[c]:c;if(!f){const h=JSON.stringify(c),m=Object.keys(ac).map(I=>JSON.stringify(I)).join(", ");throw new Error(`Unknown custom tag ${h}; use one of ${m}`)}return o.includes(f)||o.push(f),o},[])}const vh=(n,e)=>n.key<e.key?-1:n.key>e.key?1:0;class Pi{constructor({compat:e,customTags:t,merge:s,resolveKnownTags:r,schema:o,sortMapEntries:c,toStringDefaults:f}){this.compat=Array.isArray(e)?jr(e,"compat"):e?jr(null,e):null,this.name=typeof o=="string"&&o||"core",this.knownTags=r?gh:{},this.tags=jr(t,this.name,s),this.toStringOptions=f??null,Object.defineProperty(this,kt,{value:Nn}),Object.defineProperty(this,tt,{value:Ci}),Object.defineProperty(this,Ln,{value:$n}),this.sortMapEntries=typeof c=="function"?c:c===!0?vh:null}clone(){const e=Object.create(Pi.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}}function bh(n,e){var h;const t=[];let s=e.directives===!0;if(e.directives!==!1&&n.directives){const m=n.directives.toString(n);m?(t.push(m),s=!0):n.directives.docStart&&(s=!0)}s&&t.push("---");const r=fl(n,e),{commentString:o}=r.options;if(n.commentBefore){t.length!==1&&t.unshift("");const m=o(n.commentBefore);t.unshift(lt(m,""))}let c=!1,f=null;if(n.contents){if(Se(n.contents)){if(n.contents.spaceBefore&&s&&t.push(""),n.contents.commentBefore){const b=o(n.contents.commentBefore);t.push(lt(b,""))}r.forceBlockIndent=!!n.comment,f=n.contents.comment}const m=f?void 0:()=>c=!0;let I=En(n.contents,r,()=>f=null,m);f&&(I+=qt(I,"",o(f))),(I[0]==="|"||I[0]===">")&&t[t.length-1]==="---"?t[t.length-1]=`--- ${I}`:t.push(I)}else t.push(En(n.contents,r));if((h=n.directives)!=null&&h.docEnd)if(n.comment){const m=o(n.comment);m.includes(`
`)?(t.push("..."),t.push(lt(m,""))):t.push(`... ${m}`)}else t.push("...");else{let m=n.comment;m&&c&&(m=m.replace(/^\n+/,"")),m&&((!c||f)&&t[t.length-1]!==""&&t.push(""),t.push(lt(o(m),"")))}return t.join(`
`)+`
`}class xn{constructor(e,t,s){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,Ue,{value:pa});let r=null;typeof t=="function"||Array.isArray(t)?r=t:s===void 0&&t&&(s=t,t=void 0);const o=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,stringKeys:!1,uniqueKeys:!0,version:"1.2"},s);this.options=o;let{version:c}=o;s!=null&&s._directives?(this.directives=s._directives.atDocument(),this.directives.yaml.explicit&&(c=this.directives.yaml.version)):this.directives=new Me({version:c}),this.setSchema(c,s),this.contents=e===void 0?null:this.createNode(e,r,s)}clone(){const e=Object.create(xn.prototype,{[Ue]:{value:pa}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=Se(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){cn(this.contents)&&this.contents.add(e)}addIn(e,t){cn(this.contents)&&this.contents.addIn(e,t)}createAlias(e,t){if(!e.anchor){const s=al(this);e.anchor=!t||s.has(t)?ol(t||"a",s):t}return new Ei(e.anchor)}createNode(e,t,s){let r;if(typeof t=="function")e=t.call({"":e},"",e),r=t;else if(Array.isArray(t)){const P=J=>typeof J=="number"||J instanceof String||J instanceof Number,z=t.filter(P).map(String);z.length>0&&(t=t.concat(z)),r=t}else s===void 0&&t&&(s=t,t=void 0);const{aliasDuplicateObjects:o,anchorPrefix:c,flow:f,keepUndefined:h,onTagObj:m,tag:I}=s??{},{onAnchor:b,setAnchors:N,sourceObjects:$}=Yd(this,c||"a"),M={aliasDuplicateObjects:o??!0,keepUndefined:h??!1,onAnchor:b,onTagObj:m,replacer:r,schema:this.schema,sourceObjects:$},L=hs(e,I,M);return f&&ke(L)&&(L.flow=!0),N(),L}createPair(e,t,s={}){const r=this.createNode(e,null,s),o=this.createNode(t,null,s);return new xe(r,o)}delete(e){return cn(this.contents)?this.contents.delete(e):!1}deleteIn(e){return es(e)?this.contents==null?!1:(this.contents=null,!0):cn(this.contents)?this.contents.deleteIn(e):!1}get(e,t){return ke(this.contents)?this.contents.get(e,t):void 0}getIn(e,t){return es(e)?!t&&me(this.contents)?this.contents.value:this.contents:ke(this.contents)?this.contents.getIn(e,t):void 0}has(e){return ke(this.contents)?this.contents.has(e):!1}hasIn(e){return es(e)?this.contents!==void 0:ke(this.contents)?this.contents.hasIn(e):!1}set(e,t){this.contents==null?this.contents=yi(this.schema,[e],t):cn(this.contents)&&this.contents.set(e,t)}setIn(e,t){es(e)?this.contents=t:this.contents==null?this.contents=yi(this.schema,Array.from(e),t):cn(this.contents)&&this.contents.setIn(e,t)}setSchema(e,t={}){typeof e=="number"&&(e=String(e));let s;switch(e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Me({version:"1.1"}),s={resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Me({version:e}),s={resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,s=null;break;default:{const r=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${r}`)}}if(t.schema instanceof Object)this.schema=t.schema;else if(s)this.schema=new Pi(Object.assign(s,t));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:e,jsonArg:t,mapAsMap:s,maxAliasCount:r,onAnchor:o,reviver:c}={}){const f={anchors:new Map,doc:this,keep:!e,mapAsMap:s===!0,mapKeyWarned:!1,maxAliasCount:typeof r=="number"?r:100},h=He(this.contents,t??"",f);if(typeof o=="function")for(const{count:m,res:I}of f.anchors.values())o(I,m);return typeof c=="function"?pn(c,{"":h},"",h):h}toJSON(e,t){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:t})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){const t=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${t}`)}return bh(this,e)}}function cn(n){if(ke(n))return!0;throw new Error("Expected a YAML collection as document contents")}class Da extends Error{constructor(e,t,s,r){super(),this.name=e,this.code=s,this.message=r,this.pos=t}}class Ft extends Da{constructor(e,t,s){super("YAMLParseError",e,t,s)}}class Nl extends Da{constructor(e,t,s){super("YAMLWarning",e,t,s)}}const vi=(n,e)=>t=>{if(t.pos[0]===-1)return;t.linePos=t.pos.map(f=>e.linePos(f));const{line:s,col:r}=t.linePos[0];t.message+=` at line ${s}, column ${r}`;let o=r-1,c=n.substring(e.lineStarts[s-1],e.lineStarts[s]).replace(/[\n\r]+$/,"");if(o>=60&&c.length>80){const f=Math.min(o-39,c.length-79);c="…"+c.substring(f),o-=f-1}if(c.length>80&&(c=c.substring(0,79)+"…"),s>1&&/^ *$/.test(c.substring(0,o))){let f=n.substring(e.lineStarts[s-2],e.lineStarts[s-1]);f.length>80&&(f=f.substring(0,79)+`…
`),c=f+c}if(/[^ ]/.test(c)){let f=1;const h=t.linePos[1];h&&h.line===s&&h.col>r&&(f=Math.max(1,Math.min(h.col-r,80-o)));const m=" ".repeat(o)+"^".repeat(f);t.message+=`:

${c}
${m}
`}};function Tn(n,{flow:e,indicator:t,next:s,offset:r,onError:o,parentIndent:c,startOnNewline:f}){let h=!1,m=f,I=f,b="",N="",$=!1,M=!1,L=null,P=null,z=null,J=null,X=null,Q=null,te=null;for(const G of n)switch(M&&(G.type!=="space"&&G.type!=="newline"&&G.type!=="comma"&&o(G.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),M=!1),L&&(m&&G.type!=="comment"&&G.type!=="newline"&&o(L,"TAB_AS_INDENT","Tabs are not allowed as indentation"),L=null),G.type){case"space":!e&&(t!=="doc-start"||(s==null?void 0:s.type)!=="flow-collection")&&G.source.includes("	")&&(L=G),I=!0;break;case"comment":{I||o(G,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const ye=G.source.substring(1)||" ";b?b+=N+ye:b=ye,N="",m=!1;break}case"newline":m?b?b+=G.source:(!Q||t!=="seq-item-ind")&&(h=!0):N+=G.source,m=!0,$=!0,(P||z)&&(J=G),I=!0;break;case"anchor":P&&o(G,"MULTIPLE_ANCHORS","A node can have at most one anchor"),G.source.endsWith(":")&&o(G.offset+G.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),P=G,te??(te=G.offset),m=!1,I=!1,M=!0;break;case"tag":{z&&o(G,"MULTIPLE_TAGS","A node can have at most one tag"),z=G,te??(te=G.offset),m=!1,I=!1,M=!0;break}case t:(P||z)&&o(G,"BAD_PROP_ORDER",`Anchors and tags must be after the ${G.source} indicator`),Q&&o(G,"UNEXPECTED_TOKEN",`Unexpected ${G.source} in ${e??"collection"}`),Q=G,m=t==="seq-item-ind"||t==="explicit-key-ind",I=!1;break;case"comma":if(e){X&&o(G,"UNEXPECTED_TOKEN",`Unexpected , in ${e}`),X=G,m=!1,I=!1;break}default:o(G,"UNEXPECTED_TOKEN",`Unexpected ${G.type} token`),m=!1,I=!1}const ne=n[n.length-1],oe=ne?ne.offset+ne.source.length:r;return M&&s&&s.type!=="space"&&s.type!=="newline"&&s.type!=="comma"&&(s.type!=="scalar"||s.source!=="")&&o(s.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),L&&(m&&L.indent<=c||(s==null?void 0:s.type)==="block-map"||(s==null?void 0:s.type)==="block-seq")&&o(L,"TAB_AS_INDENT","Tabs are not allowed as indentation"),{comma:X,found:Q,spaceBefore:h,comment:b,hasNewline:$,anchor:P,tag:z,newlineAfterProp:J,end:oe,start:te??oe}}function ps(n){if(!n)return null;switch(n.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(n.source.includes(`
`))return!0;if(n.end){for(const e of n.end)if(e.type==="newline")return!0}return!1;case"flow-collection":for(const e of n.items){for(const t of e.start)if(t.type==="newline")return!0;if(e.sep){for(const t of e.sep)if(t.type==="newline")return!0}if(ps(e.key)||ps(e.value))return!0}return!1;default:return!0}}function va(n,e,t){if((e==null?void 0:e.type)==="flow-collection"){const s=e.end[0];s.indent===n&&(s.source==="]"||s.source==="}")&&ps(e)&&t(s,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}function $l(n,e,t){const{uniqueKeys:s}=n.options;if(s===!1)return!1;const r=typeof s=="function"?s:(o,c)=>o===c||me(o)&&me(c)&&o.value===c.value;return e.some(o=>r(o.key,t))}const oc="All mapping items must start at the same column";function wh({composeNode:n,composeEmptyNode:e},t,s,r,o){var I;const c=(o==null?void 0:o.nodeClass)??Re,f=new c(t.schema);t.atRoot&&(t.atRoot=!1);let h=s.offset,m=null;for(const b of s.items){const{start:N,key:$,sep:M,value:L}=b,P=Tn(N,{indicator:"explicit-key-ind",next:$??(M==null?void 0:M[0]),offset:h,onError:r,parentIndent:s.indent,startOnNewline:!0}),z=!P.found;if(z){if($&&($.type==="block-seq"?r(h,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in $&&$.indent!==s.indent&&r(h,"BAD_INDENT",oc)),!P.anchor&&!P.tag&&!M){m=P.end,P.comment&&(f.comment?f.comment+=`
`+P.comment:f.comment=P.comment);continue}(P.newlineAfterProp||ps($))&&r($??N[N.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else((I=P.found)==null?void 0:I.indent)!==s.indent&&r(h,"BAD_INDENT",oc);t.atKey=!0;const J=P.end,X=$?n(t,$,P,r):e(t,J,N,null,P,r);t.schema.compat&&va(s.indent,$,r),t.atKey=!1,$l(t,f.items,X)&&r(J,"DUPLICATE_KEY","Map keys must be unique");const Q=Tn(M??[],{indicator:"map-value-ind",next:L,offset:X.range[2],onError:r,parentIndent:s.indent,startOnNewline:!$||$.type==="block-scalar"});if(h=Q.end,Q.found){z&&((L==null?void 0:L.type)==="block-map"&&!Q.hasNewline&&r(h,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),t.options.strict&&P.start<Q.found.offset-1024&&r(X.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const te=L?n(t,L,Q,r):e(t,h,M,null,Q,r);t.schema.compat&&va(s.indent,L,r),h=te.range[2];const ne=new xe(X,te);t.options.keepSourceTokens&&(ne.srcToken=b),f.items.push(ne)}else{z&&r(X.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),Q.comment&&(X.comment?X.comment+=`
`+Q.comment:X.comment=Q.comment);const te=new xe(X);t.options.keepSourceTokens&&(te.srcToken=b),f.items.push(te)}}return m&&m<h&&r(m,"IMPOSSIBLE","Map comment with trailing content"),f.range=[s.offset,h,m??h],f}function kh({composeNode:n,composeEmptyNode:e},t,s,r,o){const c=(o==null?void 0:o.nodeClass)??St,f=new c(t.schema);t.atRoot&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let h=s.offset,m=null;for(const{start:I,value:b}of s.items){const N=Tn(I,{indicator:"seq-item-ind",next:b,offset:h,onError:r,parentIndent:s.indent,startOnNewline:!0});if(!N.found)if(N.anchor||N.tag||b)b&&b.type==="block-seq"?r(N.end,"BAD_INDENT","All sequence items must start at the same column"):r(h,"MISSING_CHAR","Sequence item without - indicator");else{m=N.end,N.comment&&(f.comment=N.comment);continue}const $=b?n(t,b,N,r):e(t,N.end,I,null,N,r);t.schema.compat&&va(s.indent,b,r),h=$.range[2],f.items.push($)}return f.range=[s.offset,h,m??h],f}function bs(n,e,t,s){let r="";if(n){let o=!1,c="";for(const f of n){const{source:h,type:m}=f;switch(m){case"space":o=!0;break;case"comment":{t&&!o&&s(f,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const I=h.substring(1)||" ";r?r+=c+I:r=I,c="";break}case"newline":r&&(c+=h),o=!0;break;default:s(f,"UNEXPECTED_TOKEN",`Unexpected ${m} at node end`)}e+=h.length}}return{comment:r,offset:e}}const Kr="Block collections are not allowed within flow collections",qr=n=>n&&(n.type==="block-map"||n.type==="block-seq");function Sh({composeNode:n,composeEmptyNode:e},t,s,r,o){const c=s.start.source==="{",f=c?"flow map":"flow sequence",h=(o==null?void 0:o.nodeClass)??(c?Re:St),m=new h(t.schema);m.flow=!0;const I=t.atRoot;I&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let b=s.offset+s.start.source.length;for(let P=0;P<s.items.length;++P){const z=s.items[P],{start:J,key:X,sep:Q,value:te}=z,ne=Tn(J,{flow:f,indicator:"explicit-key-ind",next:X??(Q==null?void 0:Q[0]),offset:b,onError:r,parentIndent:s.indent,startOnNewline:!1});if(!ne.found){if(!ne.anchor&&!ne.tag&&!Q&&!te){P===0&&ne.comma?r(ne.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${f}`):P<s.items.length-1&&r(ne.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${f}`),ne.comment&&(m.comment?m.comment+=`
`+ne.comment:m.comment=ne.comment),b=ne.end;continue}!c&&t.options.strict&&ps(X)&&r(X,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if(P===0)ne.comma&&r(ne.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${f}`);else if(ne.comma||r(ne.start,"MISSING_CHAR",`Missing , between ${f} items`),ne.comment){let oe="";e:for(const G of J)switch(G.type){case"comma":case"space":break;case"comment":oe=G.source.substring(1);break e;default:break e}if(oe){let G=m.items[m.items.length-1];we(G)&&(G=G.value??G.key),G.comment?G.comment+=`
`+oe:G.comment=oe,ne.comment=ne.comment.substring(oe.length+1)}}if(!c&&!Q&&!ne.found){const oe=te?n(t,te,ne,r):e(t,ne.end,Q,null,ne,r);m.items.push(oe),b=oe.range[2],qr(te)&&r(oe.range,"BLOCK_IN_FLOW",Kr)}else{t.atKey=!0;const oe=ne.end,G=X?n(t,X,ne,r):e(t,oe,J,null,ne,r);qr(X)&&r(G.range,"BLOCK_IN_FLOW",Kr),t.atKey=!1;const ye=Tn(Q??[],{flow:f,indicator:"map-value-ind",next:te,offset:G.range[2],onError:r,parentIndent:s.indent,startOnNewline:!1});if(ye.found){if(!c&&!ne.found&&t.options.strict){if(Q)for(const ge of Q){if(ge===ye.found)break;if(ge.type==="newline"){r(ge,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}ne.start<ye.found.offset-1024&&r(ye.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else te&&("source"in te&&te.source&&te.source[0]===":"?r(te,"MISSING_CHAR",`Missing space after : in ${f}`):r(ye.start,"MISSING_CHAR",`Missing , or : between ${f} items`));const ze=te?n(t,te,ye,r):ye.found?e(t,ye.end,Q,null,ye,r):null;ze?qr(te)&&r(ze.range,"BLOCK_IN_FLOW",Kr):ye.comment&&(G.comment?G.comment+=`
`+ye.comment:G.comment=ye.comment);const nt=new xe(G,ze);if(t.options.keepSourceTokens&&(nt.srcToken=z),c){const ge=m;$l(t,ge.items,G)&&r(oe,"DUPLICATE_KEY","Map keys must be unique"),ge.items.push(nt)}else{const ge=new Re(t.schema);ge.flow=!0,ge.items.push(nt);const We=(ze??G).range;ge.range=[G.range[0],We[1],We[2]],m.items.push(ge)}b=ze?ze.range[2]:ye.end}}const N=c?"}":"]",[$,...M]=s.end;let L=b;if($&&$.source===N)L=$.offset+$.source.length;else{const P=f[0].toUpperCase()+f.substring(1),z=I?`${P} must end with a ${N}`:`${P} in block collection must be sufficiently indented and end with a ${N}`;r(b,I?"MISSING_CHAR":"BAD_INDENT",z),$&&$.source.length!==1&&M.unshift($)}if(M.length>0){const P=bs(M,L,t.options.strict,r);P.comment&&(m.comment?m.comment+=`
`+P.comment:m.comment=P.comment),m.range=[s.offset,L,P.offset]}else m.range=[s.offset,L,L];return m}function Rr(n,e,t,s,r,o){const c=t.type==="block-map"?wh(n,e,t,s,o):t.type==="block-seq"?kh(n,e,t,s,o):Sh(n,e,t,s,o),f=c.constructor;return r==="!"||r===f.tagName?(c.tag=f.tagName,c):(r&&(c.tag=r),c)}function _h(n,e,t,s,r){var N;const o=s.tag,c=o?e.directives.tagName(o.source,$=>r(o,"TAG_RESOLVE_FAILED",$)):null;if(t.type==="block-seq"){const{anchor:$,newlineAfterProp:M}=s,L=$&&o?$.offset>o.offset?$:o:$??o;L&&(!M||M.offset<L.offset)&&r(L,"MISSING_CHAR","Missing newline after block sequence props")}const f=t.type==="block-map"?"map":t.type==="block-seq"?"seq":t.start.source==="{"?"map":"seq";if(!o||!c||c==="!"||c===Re.tagName&&f==="map"||c===St.tagName&&f==="seq")return Rr(n,e,t,r,c);let h=e.schema.tags.find($=>$.tag===c&&$.collection===f);if(!h){const $=e.schema.knownTags[c];if($&&$.collection===f)e.schema.tags.push(Object.assign({},$,{default:!1})),h=$;else return $?r(o,"BAD_COLLECTION_TYPE",`${$.tag} used for ${f} collection, but expects ${$.collection??"scalar"}`,!0):r(o,"TAG_RESOLVE_FAILED",`Unresolved tag: ${c}`,!0),Rr(n,e,t,r,c)}const m=Rr(n,e,t,r,c,h),I=((N=h.resolve)==null?void 0:N.call(h,m,$=>r(o,"TAG_RESOLVE_FAILED",$),e.options))??m,b=Se(I)?I:new re(I);return b.range=m.range,b.tag=c,h!=null&&h.format&&(b.format=h.format),b}function xl(n,e,t){const s=e.offset,r=Ih(e,n.options.strict,t);if(!r)return{value:"",type:null,comment:"",range:[s,s,s]};const o=r.mode===">"?re.BLOCK_FOLDED:re.BLOCK_LITERAL,c=e.source?Eh(e.source):[];let f=c.length;for(let L=c.length-1;L>=0;--L){const P=c[L][1];if(P===""||P==="\r")f=L;else break}if(f===0){const L=r.chomp==="+"&&c.length>0?`
`.repeat(Math.max(1,c.length-1)):"";let P=s+r.length;return e.source&&(P+=e.source.length),{value:L,type:o,comment:r.comment,range:[s,P,P]}}let h=e.indent+r.indent,m=e.offset+r.length,I=0;for(let L=0;L<f;++L){const[P,z]=c[L];if(z===""||z==="\r")r.indent===0&&P.length>h&&(h=P.length);else{P.length<h&&t(m+P.length,"MISSING_CHAR","Block scalars with more-indented leading empty lines must use an explicit indentation indicator"),r.indent===0&&(h=P.length),I=L,h===0&&!n.atRoot&&t(m,"BAD_INDENT","Block scalar values in collections must be indented");break}m+=P.length+z.length+1}for(let L=c.length-1;L>=f;--L)c[L][0].length>h&&(f=L+1);let b="",N="",$=!1;for(let L=0;L<I;++L)b+=c[L][0].slice(h)+`
`;for(let L=I;L<f;++L){let[P,z]=c[L];m+=P.length+z.length+1;const J=z[z.length-1]==="\r";if(J&&(z=z.slice(0,-1)),z&&P.length<h){const Q=`Block scalar lines must not be less indented than their ${r.indent?"explicit indentation indicator":"first line"}`;t(m-z.length-(J?2:1),"BAD_INDENT",Q),P=""}o===re.BLOCK_LITERAL?(b+=N+P.slice(h)+z,N=`
`):P.length>h||z[0]==="	"?(N===" "?N=`
`:!$&&N===`
`&&(N=`

`),b+=N+P.slice(h)+z,N=`
`,$=!0):z===""?N===`
`?b+=`
`:N=`
`:(b+=N+z,N=" ",$=!1)}switch(r.chomp){case"-":break;case"+":for(let L=f;L<c.length;++L)b+=`
`+c[L][0].slice(h);b[b.length-1]!==`
`&&(b+=`
`);break;default:b+=`
`}const M=s+r.length+e.source.length;return{value:b,type:o,comment:r.comment,range:[s,M,M]}}function Ih({offset:n,props:e},t,s){if(e[0].type!=="block-scalar-header")return s(e[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:r}=e[0],o=r[0];let c=0,f="",h=-1;for(let N=1;N<r.length;++N){const $=r[N];if(!f&&($==="-"||$==="+"))f=$;else{const M=Number($);!c&&M?c=M:h===-1&&(h=n+N)}}h!==-1&&s(h,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${r}`);let m=!1,I="",b=r.length;for(let N=1;N<e.length;++N){const $=e[N];switch($.type){case"space":m=!0;case"newline":b+=$.source.length;break;case"comment":t&&!m&&s($,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),b+=$.source.length,I=$.source.substring(1);break;case"error":s($,"UNEXPECTED_TOKEN",$.message),b+=$.source.length;break;default:{const M=`Unexpected token in block scalar header: ${$.type}`;s($,"UNEXPECTED_TOKEN",M);const L=$.source;L&&typeof L=="string"&&(b+=L.length)}}}return{mode:o,indent:c,chomp:f,comment:I,length:b}}function Eh(n){const e=n.split(/\n( *)/),t=e[0],s=t.match(/^( *)/),o=[s!=null&&s[1]?[s[1],t.slice(s[1].length)]:["",t]];for(let c=1;c<e.length;c+=2)o.push([e[c],e[c+1]]);return o}function Pl(n,e,t){const{offset:s,type:r,source:o,end:c}=n;let f,h;const m=(N,$,M)=>t(s+N,$,M);switch(r){case"scalar":f=re.PLAIN,h=Th(o,m);break;case"single-quoted-scalar":f=re.QUOTE_SINGLE,h=Ah(o,m);break;case"double-quoted-scalar":f=re.QUOTE_DOUBLE,h=Lh(o,m);break;default:return t(n,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${r}`),{value:"",type:null,comment:"",range:[s,s+o.length,s+o.length]}}const I=s+o.length,b=bs(c,I,e,t);return{value:h,type:f,comment:b.comment,range:[s,I,b.offset]}}function Th(n,e){let t="";switch(n[0]){case"	":t="a tab character";break;case",":t="flow indicator character ,";break;case"%":t="directive indicator character %";break;case"|":case">":{t=`block scalar indicator ${n[0]}`;break}case"@":case"`":{t=`reserved character ${n[0]}`;break}}return t&&e(0,"BAD_SCALAR_START",`Plain value cannot start with ${t}`),Ml(n)}function Ah(n,e){return(n[n.length-1]!=="'"||n.length===1)&&e(n.length,"MISSING_CHAR","Missing closing 'quote"),Ml(n.slice(1,-1)).replace(/''/g,"'")}function Ml(n){let e,t;try{e=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),t=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{e=/(.*?)[ \t]*\r?\n/sy,t=/[ \t]*(.*?)[ \t]*\r?\n/sy}let s=e.exec(n);if(!s)return n;let r=s[1],o=" ",c=e.lastIndex;for(t.lastIndex=c;s=t.exec(n);)s[1]===""?o===`
`?r+=o:o=`
`:(r+=o+s[1],o=" "),c=t.lastIndex;const f=/[ \t]*(.*)/sy;return f.lastIndex=c,s=f.exec(n),r+o+((s==null?void 0:s[1])??"")}function Lh(n,e){let t="";for(let s=1;s<n.length-1;++s){const r=n[s];if(!(r==="\r"&&n[s+1]===`
`))if(r===`
`){const{fold:o,offset:c}=Ch(n,s);t+=o,s=c}else if(r==="\\"){let o=n[++s];const c=Oh[o];if(c)t+=c;else if(o===`
`)for(o=n[s+1];o===" "||o==="	";)o=n[++s+1];else if(o==="\r"&&n[s+1]===`
`)for(o=n[++s+1];o===" "||o==="	";)o=n[++s+1];else if(o==="x"||o==="u"||o==="U"){const f={x:2,u:4,U:8}[o];t+=Nh(n,s+1,f,e),s+=f}else{const f=n.substr(s-1,2);e(s-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${f}`),t+=f}}else if(r===" "||r==="	"){const o=s;let c=n[s+1];for(;c===" "||c==="	";)c=n[++s+1];c!==`
`&&!(c==="\r"&&n[s+2]===`
`)&&(t+=s>o?n.slice(o,s+1):r)}else t+=r}return(n[n.length-1]!=='"'||n.length===1)&&e(n.length,"MISSING_CHAR",'Missing closing "quote'),t}function Ch(n,e){let t="",s=n[e+1];for(;(s===" "||s==="	"||s===`
`||s==="\r")&&!(s==="\r"&&n[e+2]!==`
`);)s===`
`&&(t+=`
`),e+=1,s=n[e+1];return t||(t=" "),{fold:t,offset:e}}const Oh={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function Nh(n,e,t,s){const r=n.substr(e,t),c=r.length===t&&/^[0-9a-fA-F]+$/.test(r)?parseInt(r,16):NaN;if(isNaN(c)){const f=n.substr(e-2,t+2);return s(e-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${f}`),f}return String.fromCodePoint(c)}function Dl(n,e,t,s){const{value:r,type:o,comment:c,range:f}=e.type==="block-scalar"?xl(n,e,s):Pl(e,n.options.strict,s),h=t?n.directives.tagName(t.source,b=>s(t,"TAG_RESOLVE_FAILED",b)):null;let m;n.options.stringKeys&&n.atKey?m=n.schema[tt]:h?m=$h(n.schema,r,h,t,s):e.type==="scalar"?m=xh(n,r,e,s):m=n.schema[tt];let I;try{const b=m.resolve(r,N=>s(t??e,"TAG_RESOLVE_FAILED",N),n.options);I=me(b)?b:new re(b)}catch(b){const N=b instanceof Error?b.message:String(b);s(t??e,"TAG_RESOLVE_FAILED",N),I=new re(r)}return I.range=f,I.source=r,o&&(I.type=o),h&&(I.tag=h),m.format&&(I.format=m.format),c&&(I.comment=c),I}function $h(n,e,t,s,r){var f;if(t==="!")return n[tt];const o=[];for(const h of n.tags)if(!h.collection&&h.tag===t)if(h.default&&h.test)o.push(h);else return h;for(const h of o)if((f=h.test)!=null&&f.test(e))return h;const c=n.knownTags[t];return c&&!c.collection?(n.tags.push(Object.assign({},c,{default:!1,test:void 0})),c):(r(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${t}`,t!=="tag:yaml.org,2002:str"),n[tt])}function xh({atKey:n,directives:e,schema:t},s,r,o){const c=t.tags.find(f=>{var h;return(f.default===!0||n&&f.default==="key")&&((h=f.test)==null?void 0:h.test(s))})||t[tt];if(t.compat){const f=t.compat.find(h=>{var m;return h.default&&((m=h.test)==null?void 0:m.test(s))})??t[tt];if(c.tag!==f.tag){const h=e.tagString(c.tag),m=e.tagString(f.tag),I=`Value may be parsed as either ${h} or ${m}`;o(r,"TAG_RESOLVE_FAILED",I,!0)}}return c}function Ph(n,e,t){if(e){t??(t=e.length);for(let s=t-1;s>=0;--s){let r=e[s];switch(r.type){case"space":case"comment":case"newline":n-=r.source.length;continue}for(r=e[++s];(r==null?void 0:r.type)==="space";)n+=r.source.length,r=e[++s];break}}return n}const Mh={composeNode:Bl,composeEmptyNode:Ba};function Bl(n,e,t,s){const r=n.atKey,{spaceBefore:o,comment:c,anchor:f,tag:h}=t;let m,I=!0;switch(e.type){case"alias":m=Dh(n,e,s),(f||h)&&s(e,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":m=Dl(n,e,h,s),f&&(m.anchor=f.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":m=_h(Mh,n,e,t,s),f&&(m.anchor=f.source.substring(1));break;default:{const b=e.type==="error"?e.message:`Unsupported token (type: ${e.type})`;s(e,"UNEXPECTED_TOKEN",b),m=Ba(n,e.offset,void 0,null,t,s),I=!1}}return f&&m.anchor===""&&s(f,"BAD_ALIAS","Anchor cannot be an empty string"),r&&n.options.stringKeys&&(!me(m)||typeof m.value!="string"||m.tag&&m.tag!=="tag:yaml.org,2002:str")&&s(h??e,"NON_STRING_KEY","With stringKeys, all keys must be strings"),o&&(m.spaceBefore=!0),c&&(e.type==="scalar"&&e.source===""?m.comment=c:m.commentBefore=c),n.options.keepSourceTokens&&I&&(m.srcToken=e),m}function Ba(n,e,t,s,{spaceBefore:r,comment:o,anchor:c,tag:f,end:h},m){const I={type:"scalar",offset:Ph(e,t,s),indent:-1,source:""},b=Dl(n,I,f,m);return c&&(b.anchor=c.source.substring(1),b.anchor===""&&m(c,"BAD_ALIAS","Anchor cannot be an empty string")),r&&(b.spaceBefore=!0),o&&(b.comment=o,b.range[2]=h),b}function Dh({options:n},{offset:e,source:t,end:s},r){const o=new Ei(t.substring(1));o.source===""&&r(e,"BAD_ALIAS","Alias cannot be an empty string"),o.source.endsWith(":")&&r(e+t.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const c=e+t.length,f=bs(s,c,n.strict,r);return o.range=[e,c,f.offset],f.comment&&(o.comment=f.comment),o}function Bh(n,e,{offset:t,start:s,value:r,end:o},c){const f=Object.assign({_directives:e},n),h=new xn(void 0,f),m={atKey:!1,atRoot:!0,directives:h.directives,options:h.options,schema:h.schema},I=Tn(s,{indicator:"doc-start",next:r??(o==null?void 0:o[0]),offset:t,onError:c,parentIndent:0,startOnNewline:!0});I.found&&(h.directives.docStart=!0,r&&(r.type==="block-map"||r.type==="block-seq")&&!I.hasNewline&&c(I.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),h.contents=r?Bl(m,r,I,c):Ba(m,I.end,s,null,I,c);const b=h.contents.range[2],N=bs(o,b,!1,c);return N.comment&&(h.comment=N.comment),h.range=[t,b,N.offset],h}function Wn(n){if(typeof n=="number")return[n,n+1];if(Array.isArray(n))return n.length===2?n:[n[0],n[1]];const{offset:e,source:t}=n;return[e,e+(typeof t=="string"?t.length:1)]}function cc(n){var r;let e="",t=!1,s=!1;for(let o=0;o<n.length;++o){const c=n[o];switch(c[0]){case"#":e+=(e===""?"":s?`

`:`
`)+(c.substring(1)||" "),t=!0,s=!1;break;case"%":((r=n[o+1])==null?void 0:r[0])!=="#"&&(o+=1),t=!1;break;default:t||(s=!0),t=!1}}return{comment:e,afterEmptyLine:s}}class ja{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(t,s,r,o)=>{const c=Wn(t);o?this.warnings.push(new Nl(c,s,r)):this.errors.push(new Ft(c,s,r))},this.directives=new Me({version:e.version||"1.2"}),this.options=e}decorate(e,t){const{comment:s,afterEmptyLine:r}=cc(this.prelude);if(s){const o=e.contents;if(t)e.comment=e.comment?`${e.comment}
${s}`:s;else if(r||e.directives.docStart||!o)e.commentBefore=s;else if(ke(o)&&!o.flow&&o.items.length>0){let c=o.items[0];we(c)&&(c=c.key);const f=c.commentBefore;c.commentBefore=f?`${s}
${f}`:s}else{const c=o.commentBefore;o.commentBefore=c?`${s}
${c}`:s}}t?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:cc(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,t=!1,s=-1){for(const r of e)yield*this.next(r);yield*this.end(t,s)}*next(e){switch(e.type){case"directive":this.directives.add(e.source,(t,s,r)=>{const o=Wn(e);o[0]+=t,this.onError(o,"BAD_DIRECTIVE",s,r)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{const t=Bh(this.options,this.directives,e,this.onError);this.atDirectives&&!t.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(t,!1),this.doc&&(yield this.doc),this.doc=t,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{const t=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,s=new Ft(Wn(e),"UNEXPECTED_TOKEN",t);this.atDirectives||!this.doc?this.errors.push(s):this.doc.errors.push(s);break}case"doc-end":{if(!this.doc){const s="Unexpected doc-end without preceding document";this.errors.push(new Ft(Wn(e),"UNEXPECTED_TOKEN",s));break}this.doc.directives.docEnd=!0;const t=bs(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),t.comment){const s=this.doc.comment;this.doc.comment=s?`${s}
${t.comment}`:t.comment}this.doc.range[2]=t.offset;break}default:this.errors.push(new Ft(Wn(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,t=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){const s=Object.assign({_directives:this.directives},this.options),r=new xn(void 0,s);this.atDirectives&&this.onError(t,"MISSING_CHAR","Missing directives-end indicator line"),r.range=[0,t,t],this.decorate(r,!1),yield r}}}function jh(n,e=!0,t){if(n){const s=(r,o,c)=>{const f=typeof r=="number"?r:Array.isArray(r)?r[0]:r.offset;if(t)t(f,o,c);else throw new Ft([f,f+1],o,c)};switch(n.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return Pl(n,e,s);case"block-scalar":return xl({options:{strict:e}},n,s)}}return null}function Kh(n,e){const{implicitKey:t=!1,indent:s,inFlow:r=!1,offset:o=-1,type:c="PLAIN"}=e,f=gs({type:c,value:n},{implicitKey:t,indent:s>0?" ".repeat(s):"",inFlow:r,options:{blockQuote:!0,lineWidth:-1}}),h=e.end??[{type:"newline",offset:-1,indent:s,source:`
`}];switch(f[0]){case"|":case">":{const m=f.indexOf(`
`),I=f.substring(0,m),b=f.substring(m+1)+`
`,N=[{type:"block-scalar-header",offset:o,indent:s,source:I}];return jl(N,h)||N.push({type:"newline",offset:-1,indent:s,source:`
`}),{type:"block-scalar",offset:o,indent:s,props:N,source:b}}case'"':return{type:"double-quoted-scalar",offset:o,indent:s,source:f,end:h};case"'":return{type:"single-quoted-scalar",offset:o,indent:s,source:f,end:h};default:return{type:"scalar",offset:o,indent:s,source:f,end:h}}}function qh(n,e,t={}){let{afterKey:s=!1,implicitKey:r=!1,inFlow:o=!1,type:c}=t,f="indent"in n?n.indent:null;if(s&&typeof f=="number"&&(f+=2),!c)switch(n.type){case"single-quoted-scalar":c="QUOTE_SINGLE";break;case"double-quoted-scalar":c="QUOTE_DOUBLE";break;case"block-scalar":{const m=n.props[0];if(m.type!=="block-scalar-header")throw new Error("Invalid block scalar header");c=m.source[0]===">"?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:c="PLAIN"}const h=gs({type:c,value:e},{implicitKey:r||f===null,indent:f!==null&&f>0?" ".repeat(f):"",inFlow:o,options:{blockQuote:!0,lineWidth:-1}});switch(h[0]){case"|":case">":Rh(n,h);break;case'"':Fr(n,h,"double-quoted-scalar");break;case"'":Fr(n,h,"single-quoted-scalar");break;default:Fr(n,h,"scalar")}}function Rh(n,e){const t=e.indexOf(`
`),s=e.substring(0,t),r=e.substring(t+1)+`
`;if(n.type==="block-scalar"){const o=n.props[0];if(o.type!=="block-scalar-header")throw new Error("Invalid block scalar header");o.source=s,n.source=r}else{const{offset:o}=n,c="indent"in n?n.indent:-1,f=[{type:"block-scalar-header",offset:o,indent:c,source:s}];jl(f,"end"in n?n.end:void 0)||f.push({type:"newline",offset:-1,indent:c,source:`
`});for(const h of Object.keys(n))h!=="type"&&h!=="offset"&&delete n[h];Object.assign(n,{type:"block-scalar",indent:c,props:f,source:r})}}function jl(n,e){if(e)for(const t of e)switch(t.type){case"space":case"comment":n.push(t);break;case"newline":return n.push(t),!0}return!1}function Fr(n,e,t){switch(n.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":n.type=t,n.source=e;break;case"block-scalar":{const s=n.props.slice(1);let r=e.length;n.props[0].type==="block-scalar-header"&&(r-=n.props[0].source.length);for(const o of s)o.offset+=r;delete n.props,Object.assign(n,{type:t,source:e,end:s});break}case"block-map":case"block-seq":{const r={type:"newline",offset:n.offset+e.length,indent:n.indent,source:`
`};delete n.items,Object.assign(n,{type:t,source:e,end:[r]});break}default:{const s="indent"in n?n.indent:-1,r="end"in n&&Array.isArray(n.end)?n.end.filter(o=>o.type==="space"||o.type==="comment"||o.type==="newline"):[];for(const o of Object.keys(n))o!=="type"&&o!=="offset"&&delete n[o];Object.assign(n,{type:t,indent:s,source:e,end:r})}}}const Fh=n=>"type"in n?bi(n):ui(n);function bi(n){switch(n.type){case"block-scalar":{let e="";for(const t of n.props)e+=bi(t);return e+n.source}case"block-map":case"block-seq":{let e="";for(const t of n.items)e+=ui(t);return e}case"flow-collection":{let e=n.start.source;for(const t of n.items)e+=ui(t);for(const t of n.end)e+=t.source;return e}case"document":{let e=ui(n);if(n.end)for(const t of n.end)e+=t.source;return e}default:{let e=n.source;if("end"in n&&n.end)for(const t of n.end)e+=t.source;return e}}}function ui({start:n,key:e,sep:t,value:s}){let r="";for(const o of n)r+=o.source;if(e&&(r+=bi(e)),t)for(const o of t)r+=o.source;return s&&(r+=bi(s)),r}const ba=Symbol("break visit"),Hh=Symbol("skip children"),Kl=Symbol("remove item");function Vt(n,e){"type"in n&&n.type==="document"&&(n={start:n.start,value:n.value}),ql(Object.freeze([]),n,e)}Vt.BREAK=ba;Vt.SKIP=Hh;Vt.REMOVE=Kl;Vt.itemAtPath=(n,e)=>{let t=n;for(const[s,r]of e){const o=t==null?void 0:t[s];if(o&&"items"in o)t=o.items[r];else return}return t};Vt.parentCollection=(n,e)=>{const t=Vt.itemAtPath(n,e.slice(0,-1)),s=e[e.length-1][0],r=t==null?void 0:t[s];if(r&&"items"in r)return r;throw new Error("Parent collection not found")};function ql(n,e,t){let s=t(e,n);if(typeof s=="symbol")return s;for(const r of["key","value"]){const o=e[r];if(o&&"items"in o){for(let c=0;c<o.items.length;++c){const f=ql(Object.freeze(n.concat([[r,c]])),o.items[c],t);if(typeof f=="number")c=f-1;else{if(f===ba)return ba;f===Kl&&(o.items.splice(c,1),c-=1)}}typeof s=="function"&&r==="key"&&(s=s(e,n))}}return typeof s=="function"?s(e,n):s}const Mi="\uFEFF",Di="",Bi="",ms="",Uh=n=>!!n&&"items"in n,zh=n=>!!n&&(n.type==="scalar"||n.type==="single-quoted-scalar"||n.type==="double-quoted-scalar"||n.type==="block-scalar");function Vh(n){switch(n){case Mi:return"<BOM>";case Di:return"<DOC>";case Bi:return"<FLOW_END>";case ms:return"<SCALAR>";default:return JSON.stringify(n)}}function Rl(n){switch(n){case Mi:return"byte-order-mark";case Di:return"doc-mode";case Bi:return"flow-error-end";case ms:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(n[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}const Yh=Object.freeze(Object.defineProperty({__proto__:null,BOM:Mi,DOCUMENT:Di,FLOW_END:Bi,SCALAR:ms,createScalarToken:Kh,isCollection:Uh,isScalar:zh,prettyToken:Vh,resolveAsScalar:jh,setScalarValue:qh,stringify:Fh,tokenType:Rl,visit:Vt},Symbol.toStringTag,{value:"Module"}));function Ve(n){switch(n){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}const lc=new Set("0123456789ABCDEFabcdef"),Jh=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),Zs=new Set(",[]{}"),Wh=new Set(` ,[]{}
\r	`),Hr=n=>!n||Wh.has(n);class Fl{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,t=!1){if(e){if(typeof e!="string")throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null}this.atEnd=!t;let s=this.next??"stream";for(;s&&(t||this.hasChars(1));)s=yield*this.parseNext(s)}atLineEnd(){let e=this.pos,t=this.buffer[e];for(;t===" "||t==="	";)t=this.buffer[++e];return!t||t==="#"||t===`
`?!0:t==="\r"?this.buffer[e+1]===`
`:!1}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let t=this.buffer[e];if(this.indentNext>0){let s=0;for(;t===" ";)t=this.buffer[++s+e];if(t==="\r"){const r=this.buffer[s+e+1];if(r===`
`||!r&&!this.atEnd)return e+s+1}return t===`
`||s>=this.indentNext||!t&&!this.atEnd?e+s:-1}if(t==="-"||t==="."){const s=this.buffer.substr(e,3);if((s==="---"||s==="...")&&Ve(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return(typeof e!="number"||e!==-1&&e<this.pos)&&(e=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=e),e===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[e-1]==="\r"&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(e===null)return this.setNext("stream");if(e[0]===Mi&&(yield*this.pushCount(1),e=e.substring(1)),e[0]==="%"){let t=e.length,s=e.indexOf("#");for(;s!==-1;){const o=e[s-1];if(o===" "||o==="	"){t=s-1;break}else s=e.indexOf("#",s+1)}for(;;){const o=e[t-1];if(o===" "||o==="	")t-=1;else break}const r=(yield*this.pushCount(t))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-r),this.pushNewline(),"stream"}if(this.atLineEnd()){const t=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-t),yield*this.pushNewline(),"stream"}return yield Di,yield*this.parseLineStart()}*parseLineStart(){const e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if(e==="-"||e==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const t=this.peek(3);if((t==="---"||t==="...")&&Ve(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,t==="---"?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!Ve(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[e,t]=this.peek(2);if(!t&&!this.atEnd)return this.setNext("block-start");if((e==="-"||e==="?"||e===":")&&Ve(t)){const s=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=s,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const e=this.getLine();if(e===null)return this.setNext("doc");let t=yield*this.pushIndicators();switch(e[t]){case"#":yield*this.pushCount(e.length-t);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(Hr),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return t+=yield*this.parseBlockScalarHeader(),t+=yield*this.pushSpaces(!0),yield*this.pushCount(e.length-t),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,t,s=-1;do e=yield*this.pushNewline(),e>0?(t=yield*this.pushSpaces(!1),this.indentValue=s=t):t=0,t+=yield*this.pushSpaces(!0);while(e+t>0);const r=this.getLine();if(r===null)return this.setNext("flow");if((s!==-1&&s<this.indentNext&&r[0]!=="#"||s===0&&(r.startsWith("---")||r.startsWith("..."))&&Ve(r[3]))&&!(s===this.indentNext-1&&this.flowLevel===1&&(r[0]==="]"||r[0]==="}")))return this.flowLevel=0,yield Bi,yield*this.parseLineStart();let o=0;for(;r[o]===",";)o+=yield*this.pushCount(1),o+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(o+=yield*this.pushIndicators(),r[o]){case void 0:return"flow";case"#":return yield*this.pushCount(r.length-o),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(Hr),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const c=this.charAt(1);if(this.flowKey||Ve(c)||c===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const e=this.charAt(0);let t=this.buffer.indexOf(e,this.pos+1);if(e==="'")for(;t!==-1&&this.buffer[t+1]==="'";)t=this.buffer.indexOf("'",t+2);else for(;t!==-1;){let o=0;for(;this.buffer[t-1-o]==="\\";)o+=1;if(o%2===0)break;t=this.buffer.indexOf('"',t+1)}const s=this.buffer.substring(0,t);let r=s.indexOf(`
`,this.pos);if(r!==-1){for(;r!==-1;){const o=this.continueScalar(r+1);if(o===-1)break;r=s.indexOf(`
`,o)}r!==-1&&(t=r-(s[r-1]==="\r"?2:1))}if(t===-1){if(!this.atEnd)return this.setNext("quoted-scalar");t=this.buffer.length}return yield*this.pushToIndex(t+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){const t=this.buffer[++e];if(t==="+")this.blockScalarKeep=!0;else if(t>"0"&&t<="9")this.blockScalarIndent=Number(t)-1;else if(t!=="-")break}return yield*this.pushUntil(t=>Ve(t)||t==="#")}*parseBlockScalar(){let e=this.pos-1,t=0,s;e:for(let o=this.pos;s=this.buffer[o];++o)switch(s){case" ":t+=1;break;case`
`:e=o,t=0;break;case"\r":{const c=this.buffer[o+1];if(!c&&!this.atEnd)return this.setNext("block-scalar");if(c===`
`)break}default:break e}if(!s&&!this.atEnd)return this.setNext("block-scalar");if(t>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=t:this.indentNext=this.blockScalarIndent+(this.indentNext===0?1:this.indentNext);do{const o=this.continueScalar(e+1);if(o===-1)break;e=this.buffer.indexOf(`
`,o)}while(e!==-1);if(e===-1){if(!this.atEnd)return this.setNext("block-scalar");e=this.buffer.length}}let r=e+1;for(s=this.buffer[r];s===" ";)s=this.buffer[++r];if(s==="	"){for(;s==="	"||s===" "||s==="\r"||s===`
`;)s=this.buffer[++r];e=r-1}else if(!this.blockScalarKeep)do{let o=e-1,c=this.buffer[o];c==="\r"&&(c=this.buffer[--o]);const f=o;for(;c===" ";)c=this.buffer[--o];if(c===`
`&&o>=this.pos&&o+1+t>f)e=o;else break}while(!0);return yield ms,yield*this.pushToIndex(e+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const e=this.flowLevel>0;let t=this.pos-1,s=this.pos-1,r;for(;r=this.buffer[++s];)if(r===":"){const o=this.buffer[s+1];if(Ve(o)||e&&Zs.has(o))break;t=s}else if(Ve(r)){let o=this.buffer[s+1];if(r==="\r"&&(o===`
`?(s+=1,r=`
`,o=this.buffer[s+1]):t=s),o==="#"||e&&Zs.has(o))break;if(r===`
`){const c=this.continueScalar(s+1);if(c===-1)break;s=Math.max(s,c-2)}}else{if(e&&Zs.has(r))break;t=s}return!r&&!this.atEnd?this.setNext("plain-scalar"):(yield ms,yield*this.pushToIndex(t+1,!0),e?"flow":"doc")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,t){const s=this.buffer.slice(this.pos,e);return s?(yield s,this.pos+=s.length,s.length):(t&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(Hr))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const e=this.flowLevel>0,t=this.charAt(1);if(Ve(t)||e&&Zs.has(t))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let e=this.pos+2,t=this.buffer[e];for(;!Ve(t)&&t!==">";)t=this.buffer[++e];return yield*this.pushToIndex(t===">"?e+1:e,!1)}else{let e=this.pos+1,t=this.buffer[e];for(;t;)if(Jh.has(t))t=this.buffer[++e];else if(t==="%"&&lc.has(this.buffer[e+1])&&lc.has(this.buffer[e+2]))t=this.buffer[e+=3];else break;return yield*this.pushToIndex(e,!1)}}*pushNewline(){const e=this.buffer[this.pos];return e===`
`?yield*this.pushCount(1):e==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(e){let t=this.pos-1,s;do s=this.buffer[++t];while(s===" "||e&&s==="	");const r=t-this.pos;return r>0&&(yield this.buffer.substr(this.pos,r),this.pos=t),r}*pushUntil(e){let t=this.pos,s=this.buffer[t];for(;!e(s);)s=this.buffer[++t];return yield*this.pushToIndex(t,!1)}}class Hl{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let t=0,s=this.lineStarts.length;for(;t<s;){const o=t+s>>1;this.lineStarts[o]<e?t=o+1:s=o}if(this.lineStarts[t]===e)return{line:t+1,col:1};if(t===0)return{line:0,col:e};const r=this.lineStarts[t-1];return{line:t,col:e-r+1}}}}function bt(n,e){for(let t=0;t<n.length;++t)if(n[t].type===e)return!0;return!1}function uc(n){for(let e=0;e<n.length;++e)switch(n[e].type){case"space":case"comment":case"newline":break;default:return e}return-1}function Ul(n){switch(n==null?void 0:n.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function ei(n){switch(n.type){case"document":return n.start;case"block-map":{const e=n.items[n.items.length-1];return e.sep??e.start}case"block-seq":return n.items[n.items.length-1].start;default:return[]}}function ln(n){var t;if(n.length===0)return[];let e=n.length;e:for(;--e>=0;)switch(n[e].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;((t=n[++e])==null?void 0:t.type)==="space";);return n.splice(e,n.length)}function fc(n){if(n.start.type==="flow-seq-start")for(const e of n.items)e.sep&&!e.value&&!bt(e.start,"explicit-key-ind")&&!bt(e.sep,"map-value-ind")&&(e.key&&(e.value=e.key),delete e.key,Ul(e.value)?e.value.end?Array.prototype.push.apply(e.value.end,e.sep):e.value.end=e.sep:Array.prototype.push.apply(e.start,e.sep),delete e.sep)}class Ka{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new Fl,this.onNewLine=e}*parse(e,t=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(const s of this.lexer.lex(e,t))yield*this.next(s);t||(yield*this.end())}*next(e){if(this.source=e,this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=e.length;return}const t=Rl(e);if(t)if(t==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=t,yield*this.step(),t){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&e[0]===" "&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{const s=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:s,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const e=this.peek(1);if(this.type==="doc-end"&&(!e||e.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}peek(e){return this.stack[this.stack.length-e]}*pop(e){const t=e??this.stack.pop();if(!t)yield{type:"error",offset:this.offset,source:"",message:"Tried to pop an empty stack"};else if(this.stack.length===0)yield t;else{const s=this.peek(1);switch(t.type==="block-scalar"?t.indent="indent"in s?s.indent:0:t.type==="flow-collection"&&s.type==="document"&&(t.indent=0),t.type==="flow-collection"&&fc(t),s.type){case"document":s.value=t;break;case"block-scalar":s.props.push(t);break;case"block-map":{const r=s.items[s.items.length-1];if(r.value){s.items.push({start:[],key:t,sep:[]}),this.onKeyLine=!0;return}else if(r.sep)r.value=t;else{Object.assign(r,{key:t,sep:[]}),this.onKeyLine=!r.explicitKey;return}break}case"block-seq":{const r=s.items[s.items.length-1];r.value?s.items.push({start:[],value:t}):r.value=t;break}case"flow-collection":{const r=s.items[s.items.length-1];!r||r.value?s.items.push({start:[],key:t,sep:[]}):r.sep?r.value=t:Object.assign(r,{key:t,sep:[]});return}default:yield*this.pop(),yield*this.pop(t)}if((s.type==="document"||s.type==="block-map"||s.type==="block-seq")&&(t.type==="block-map"||t.type==="block-seq")){const r=t.items[t.items.length-1];r&&!r.sep&&!r.value&&r.start.length>0&&uc(r.start)===-1&&(t.indent===0||r.start.every(o=>o.type!=="comment"||o.indent<t.indent))&&(s.type==="document"?s.end=r.start:s.items.push({start:r.start}),t.items.splice(-1,1))}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{const e={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&e.start.push(this.sourceToken),this.stack.push(e);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":{uc(e.start)!==-1?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":e.start.push(this.sourceToken);return}const t=this.startBlockValue(e);t?this.stack.push(t):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if(this.type==="map-value-ind"){const t=ei(this.peek(2)),s=ln(t);let r;e.end?(r=e.end,r.push(this.sourceToken),delete e.end):r=[this.sourceToken];const o={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:s,key:e,sep:r}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=o}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":e.props.push(this.sourceToken);return;case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,t.value){const r="end"in t.value?t.value.end:void 0,o=Array.isArray(r)?r[r.length-1]:void 0;(o==null?void 0:o.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else if(t.sep)t.sep.push(this.sourceToken);else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],o=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(o)){Array.prototype.push.apply(o,t.start),o.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return}if(this.indent>=e.indent){const r=!this.onKeyLine&&this.indent===e.indent,o=r&&(t.sep||t.explicitKey)&&this.type!=="seq-item-ind";let c=[];if(o&&t.sep&&!t.value){const f=[];for(let h=0;h<t.sep.length;++h){const m=t.sep[h];switch(m.type){case"newline":f.push(h);break;case"space":break;case"comment":m.indent>e.indent&&(f.length=0);break;default:f.length=0}}f.length>=2&&(c=t.sep.splice(f[1]))}switch(this.type){case"anchor":case"tag":o||t.value?(c.push(this.sourceToken),e.items.push({start:c}),this.onKeyLine=!0):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"explicit-key-ind":!t.sep&&!t.explicitKey?(t.start.push(this.sourceToken),t.explicitKey=!0):o||t.value?(c.push(this.sourceToken),e.items.push({start:c,explicitKey:!0})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken],explicitKey:!0}]}),this.onKeyLine=!0;return;case"map-value-ind":if(t.explicitKey)if(t.sep)if(t.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(bt(t.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:c,key:null,sep:[this.sourceToken]}]});else if(Ul(t.key)&&!bt(t.sep,"newline")){const f=ln(t.start),h=t.key,m=t.sep;m.push(this.sourceToken),delete t.key,delete t.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:f,key:h,sep:m}]})}else c.length>0?t.sep=t.sep.concat(c,this.sourceToken):t.sep.push(this.sourceToken);else if(bt(t.start,"newline"))Object.assign(t,{key:null,sep:[this.sourceToken]});else{const f=ln(t.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:f,key:null,sep:[this.sourceToken]}]})}else t.sep?t.value||o?e.items.push({start:c,key:null,sep:[this.sourceToken]}):bt(t.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const f=this.flowScalar(this.type);o||t.value?(e.items.push({start:c,key:f,sep:[]}),this.onKeyLine=!0):t.sep?this.stack.push(f):(Object.assign(t,{key:f,sep:[]}),this.onKeyLine=!0);return}default:{const f=this.startBlockValue(e);if(f){if(f.type==="block-seq"){if(!t.explicitKey&&t.sep&&!bt(t.sep,"newline")){yield*this.pop({type:"error",offset:this.offset,message:"Unexpected block-seq-ind on same line with key",source:this.source});return}}else r&&e.items.push({start:c});this.stack.push(f);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(t.value){const r="end"in t.value?t.value.end:void 0,o=Array.isArray(r)?r[r.length-1]:void 0;(o==null?void 0:o.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],o=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(o)){Array.prototype.push.apply(o,t.start),o.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return;case"anchor":case"tag":if(t.value||this.indent<=e.indent)break;t.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==e.indent)break;t.value||bt(t.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return}if(this.indent>e.indent){const r=this.startBlockValue(e);if(r){this.stack.push(r);return}}yield*this.pop(),yield*this.step()}*flowCollection(e){const t=e.items[e.items.length-1];if(this.type==="flow-error-end"){let s;do yield*this.pop(),s=this.peek(1);while(s&&s.type==="flow-collection")}else if(e.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!t||t.sep?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return;case"map-value-ind":!t||t.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!t||t.value?e.items.push({start:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const r=this.flowScalar(this.type);!t||t.value?e.items.push({start:[],key:r,sep:[]}):t.sep?this.stack.push(r):Object.assign(t,{key:r,sep:[]});return}case"flow-map-end":case"flow-seq-end":e.end.push(this.sourceToken);return}const s=this.startBlockValue(e);s?this.stack.push(s):(yield*this.pop(),yield*this.step())}else{const s=this.peek(2);if(s.type==="block-map"&&(this.type==="map-value-ind"&&s.indent===e.indent||this.type==="newline"&&!s.items[s.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&s.type!=="flow-collection"){const r=ei(s),o=ln(r);fc(e);const c=e.end.splice(1,e.end.length);c.push(this.sourceToken);const f={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:o,key:e,sep:c}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=f}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const t=ei(e),s=ln(t);return s.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,explicitKey:!0}]}}case"map-value-ind":{this.onKeyLine=!0;const t=ei(e),s=ln(t);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,t){return this.type!=="comment"||this.indent<=t?!1:e.every(s=>s.type==="newline"||s.type==="space")}*documentEnd(e){this.type!=="doc-mode"&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;case"space":case"comment":default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}}function zl(n){const e=n.prettyErrors!==!1;return{lineCounter:n.lineCounter||e&&new Hl||null,prettyErrors:e}}function Gh(n,e={}){const{lineCounter:t,prettyErrors:s}=zl(e),r=new Ka(t==null?void 0:t.addNewLine),o=new ja(e),c=Array.from(o.compose(r.parse(n)));if(s&&t)for(const f of c)f.errors.forEach(vi(n,t)),f.warnings.forEach(vi(n,t));return c.length>0?c:Object.assign([],{empty:!0},o.streamInfo())}function Vl(n,e={}){const{lineCounter:t,prettyErrors:s}=zl(e),r=new Ka(t==null?void 0:t.addNewLine),o=new ja(e);let c=null;for(const f of o.compose(r.parse(n),!0,n.length))if(!c)c=f;else if(c.options.logLevel!=="silent"){c.errors.push(new Ft(f.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return s&&t&&(c.errors.forEach(vi(n,t)),c.warnings.forEach(vi(n,t))),c}function Qh(n,e,t){let s;typeof e=="function"?s=e:t===void 0&&e&&typeof e=="object"&&(t=e);const r=Vl(n,t);if(!r)return null;if(r.warnings.forEach(o=>dl(r.options.logLevel,o)),r.errors.length>0){if(r.options.logLevel!=="silent")throw r.errors[0];r.errors=[]}return r.toJS(Object.assign({reviver:s},t))}function Xh(n,e,t){let s=null;if(typeof e=="function"||Array.isArray(e)?s=e:t===void 0&&e&&(t=e),typeof t=="string"&&(t=t.length),typeof t=="number"){const r=Math.round(t);t=r<1?void 0:r>8?{indent:8}:{indent:r}}if(n===void 0){const{keepUndefined:r}=t??e??{};if(!r)return}return Jt(n)&&!s?n.toString(t):new xn(n,s,t).toString(t)}const Zh=Object.freeze(Object.defineProperty({__proto__:null,Alias:Ei,CST:Yh,Composer:ja,Document:xn,Lexer:Fl,LineCounter:Hl,Pair:xe,Parser:Ka,Scalar:re,Schema:Pi,YAMLError:Da,YAMLMap:Re,YAMLParseError:Ft,YAMLSeq:St,YAMLWarning:Nl,isAlias:Et,isCollection:ke,isDocument:Jt,isMap:Cn,isNode:Se,isPair:we,isScalar:me,isSeq:On,parse:Qh,parseAllDocuments:Gh,parseDocument:Vl,stringify:Xh,visit:Wt,visitAsync:Ii},Symbol.toStringTag,{value:"Module"}));class ep{constructor(){this.tasks=[],this.taxonomy={}}async initialize(){this.tasks=await Fu(),this._buildTaxonomy(),console.log(`TaskManager initialized with ${this.tasks.length} tasks.`)}async loadFromYAML(e){try{const t=Zh.parse(e);if(!t.subject||!t.tasks)throw new Error("YAML must contain 'subject' and 'tasks' keys.");const s=t.tasks.map(o=>this._normalizeTask(o,t.subject)),r=new Map(this.tasks.map(o=>[o.uuid,o]));return s.forEach(o=>r.set(o.uuid,o)),this.tasks=Array.from(r.values()),await Hu(this.tasks),this._buildTaxonomy(),{success:!0,count:s.length}}catch(t){return console.error("Failed to load from YAML:",t),{success:!1,error:t.message}}}_normalizeTask(e,t){if(e.simple_task){const r=e.simple_task;return{uuid:crypto.randomUUID(),title:r.problem.substring(0,30)+(r.problem.length>30?"...":""),problem:r.problem,attachments:[],my_answer:{content:""},correct_answer:{content:r.answer,explanation:""},analysis:{reason_for_error:"知识点模糊",difficulty:r.difficulty||3},tags:r.tags||[],subject:t,is_simple:!0,review:{due:Date.now(),interval:0,easeFactor:2.5,state:"new"}}}const s={...e,subject:t};return s.review||(s.review={due:Date.now(),interval:0,easeFactor:2.5,state:"new"}),s.uuid||(s.uuid=crypto.randomUUID()),s}_buildTaxonomy(){const e={};this.tasks.forEach(t=>{var r,o;const s=t.subject||"未分类";e[s]||(e[s]={tags:new Set,reasons:new Set}),(r=t.tags)==null||r.forEach(c=>e[s].tags.add(c)),(o=t.analysis)!=null&&o.reason_for_error&&e[s].reasons.add(t.analysis.reason_for_error)}),this.taxonomy=e}getFilteredTasks(e={}){const{subject:t="all",tags:s=[],reasons:r=[]}=e;return this.tasks.filter(o=>{var c;return!(t!=="all"&&o.subject!==t||s.length>0&&!s.every(f=>{var h;return(h=o.tags)==null?void 0:h.includes(f)})||r.length>0&&!r.includes((c=o.analysis)==null?void 0:c.reason_for_error))}).sort((o,c)=>o.review.due-c.review.due)}async updateReviewStatus(e,t){const s=this.tasks.find(o=>o.uuid===e);if(!s)return null;const r=vc(s.review,t);return s.review={...s.review,...r},s.lastReviewed=Date.now(),await Uu(s),s}getTaxonomy(){return this.taxonomy}}const Ee=n=>document.getElementById(n);Ee("task-view");const tp=Ee("task-view").querySelector(".task_session-sidebar"),ls=Ee("task_subjectFilter"),ts=Ee("task_tagFilterContainer"),ns=Ee("task_reasonFilterContainer"),ot=Ee("task_list"),us=Ee("task_paginationContainer"),np=Ee("task_statsDashboard"),Ht=Ee("task_previewContainer");Ee("task_previewPanel");const Ur=Ee("task_editorPanel"),Gn=Ee("task_yamlEditor"),zr=Ee("task_toggleSessionBtn"),Qn=Ee("task_saveBtn"),Vr=Ee("task_exportBtn"),ti=Ee("task_collapseBtn"),Yr=Ee("task_refreshBtn"),Jr=Ee("task_loadYamlBtn"),ni=Ee("task_yamlFileInput"),Wr=Ee("task_newFileBtn"),Gr=Ee("task_startReviewBtn");class sp{renderFilters(e,t){ls.innerHTML='<option value="all">所有科目</option>',Object.keys(e).sort().forEach(r=>{const o=new Option(r,r);o.selected=r===t,ls.add(o)});const s=e[t]||{tags:new Set,reasons:new Set};this._renderFilterAccordion(ts,"知识点标签",Array.from(s.tags).sort()),this._renderFilterAccordion(ns,"错误原因",Array.from(s.reasons).sort())}_renderFilterAccordion(e,t,s){e.innerHTML=`
            <details class="filter-accordion-item" open>
                <summary><span><i class="fas fa-tags"></i> ${t}</span></summary>
                <div class="tag-list-content">
                    ${s.map(r=>`<div class="tag" data-value="${r}">${r}</div>`).join("")}
                </div>
            </details>
        `}renderTaskList(e){if(ot.innerHTML="",e.length===0){ot.innerHTML='<li class="session-item-placeholder"><i class="fas fa-check-circle"></i><p>没有符合条件的任务</p></li>';return}e.forEach(t=>{const s=document.createElement("li");s.className="session-item task-item",s.dataset.id=t.uuid;const{className:r,text:o}=this._getDueDateStatus(t.review.due);s.innerHTML=`
                <div class="item-content">
                    <div class="item-title">${t.title}</div>
                    <div class="item-meta">
                        <span class="meta-info ${r}">${o}</span>
                        <span class="meta-info">${t.subject||"未分类"}</span>
                    </div>
                </div>
            `,ot.appendChild(s)})}_getDueDateStatus(e){const t=new Date(e),s=new Date;t.setHours(0,0,0,0),s.setHours(0,0,0,0);const r=Math.ceil((t-s)/(1e3*60*60*24));return r<0?{className:"status-overdue",text:`过期${Math.abs(r)}天`}:r===0?{className:"status-today",text:"今天"}:{className:"status-future",text:`${r}天后`}}setActiveListItem(e){if(ot.querySelectorAll(".task-item.active").forEach(t=>t.classList.remove("active")),e){const t=ot.querySelector(`.task-item[data-id="${e}"]`);t==null||t.classList.add("active")}}renderTaskPreview(e){Ht.innerHTML="",e.forEach(t=>{Ht.appendChild(this._createTaskCard(t))})}_renderAttachment(e){return e.type==="image"?`<img src="${e.url}" alt="任务附件" class="problem-image">`:""}_createTaskCard(e){var s,r,o,c,f;const t=document.createElement("div");return t.className="mistake-card task-card",t.dataset.id=e.uuid,t.innerHTML=`
            <div class="problem-section">
                <h4>${e.title}</h4>
                <div class="problem-meta">
                    <span>原因: ${e.analysis.reason_for_error}</span>
                    <span>难度: ${"★".repeat(e.analysis.difficulty)}${"☆".repeat(5-e.analysis.difficulty)}</span>
                </div>
                <div class="problem-content">${Er.parse(e.problem||"")}</div>
                
                \x3C!-- [恢复] 附件渲染区域 -->
                ${((s=e.attachments)==null?void 0:s.map(h=>this._renderAttachment(h)).join(""))||""}

                <div class="problem-tags">${((r=e.tags)==null?void 0:r.map(h=>`<span class="tag">${h}</span>`).join(""))||""}</div>

                \x3C!-- [恢复] 我的答案预览区域 -->
                <div class="my-answer-preview"><strong>我的答案:</strong> ${((o=e.my_answer)==null?void 0:o.content)||"未作答"}</div>

                <button class="show-answer-btn">显示答案</button>
            </div>
            <div class="answer-section hidden">
                <div class="correct-answer"><strong>正确答案:</strong><div class="content">${Er.parse(((c=e.correct_answer)==null?void 0:c.content)||"")}</div></div>
                <div class="correct-explanation"><strong>解析:</strong><div class="content">${Er.parse(((f=e.correct_answer)==null?void 0:f.explanation)||"")}</div></div>
                <div class="review-actions">
                    <button class="review-btn redo" data-rating="0">重做</button>
                    <button class="review-btn hard" data-rating="1">困难</button>
                    <button class="review-btn medium" data-rating="2">犹豫</button>
                    <button class="review-btn easy" data-rating="3">简单</button>
                </div>
            </div>
        `,t}highlightPreviewCard(e){const t=Ht.querySelector(`.task-card[data-id="${e}"]`);t&&(t.classList.add("highlight"),setTimeout(()=>t.classList.remove("highlight"),1500))}toggleAnswer(e,t){e.querySelector(".answer-section").classList.toggle("hidden",!t),e.querySelector(".show-answer-btn").classList.toggle("hidden",t)}updateCardAfterReview(e,t){t!==3&&this.toggleAnswer(e,!1),e.querySelector(".review-actions").insertAdjacentHTML("afterend",'<div class="update-feedback">已更新!</div>'),setTimeout(()=>{var r;return(r=e.querySelector(".update-feedback"))==null?void 0:r.remove()},1500)}updateListItem(e,t){const s=ot.querySelector(`[data-id="${e}"] .meta-info`);if(s){const{className:r,text:o}=this._getDueDateStatus(t.review.due);s.className=`meta-info ${r}`,s.textContent=o}}renderPagination(e,t,s){us.innerHTML="";const r=Math.ceil(e/s);if(!(r<=1))for(let o=1;o<=r;o++){const c=document.createElement("button");c.className=`page-btn ${o===t?"active":""}`,c.textContent=o,c.dataset.page=o,us.appendChild(c)}}}class ip{constructor(e,t,s){this.manager=e,this.ui=t,this.stats=s,this.filters={subject:"all",tags:[],reasons:[]},this.currentPage=1,this.pageSize=5}init(){Wr==null||Wr.addEventListener("click",this._handleNewFile.bind(this)),zr==null||zr.addEventListener("click",this._handleToggleSidebar.bind(this)),Qn==null||Qn.addEventListener("click",this._handleSave.bind(this)),Vr==null||Vr.addEventListener("click",this._handleExport.bind(this)),ti==null||ti.addEventListener("click",this._handleCollapseEditor.bind(this)),Yr==null||Yr.addEventListener("click",this.refreshView.bind(this)),Jr==null||Jr.addEventListener("click",()=>ni.click()),ni==null||ni.addEventListener("change",this._handleFileLoad.bind(this)),ls==null||ls.addEventListener("change",this._handleSubjectChange.bind(this)),ts==null||ts.addEventListener("click",this._handleFilterClick.bind(this,"tags")),ns==null||ns.addEventListener("click",this._handleFilterClick.bind(this,"reasons")),ot==null||ot.addEventListener("click",this._handleListClick.bind(this)),Ht==null||Ht.addEventListener("click",this._handlePreviewClick.bind(this)),us==null||us.addEventListener("click",this._handlePaginationClick.bind(this)),Gr==null||Gr.addEventListener("click",()=>alert("任务复习功能待实现！")),this.refreshView()}async refreshView(){const e=this.stats.getDashboardHtml(this.manager.tasks);np.innerHTML=e;const t=this.manager.getFilteredTasks(this.filters),s=(this.currentPage-1)*this.pageSize,r=t.slice(s,s+this.pageSize);this.ui.renderTaskList(r),this.ui.renderTaskPreview(r),this.ui.renderPagination(t.length,this.currentPage,this.pageSize)}_handleToggleSidebar(){tp.classList.toggle("collapsed")}_handleNewFile(){const e=prompt("请输入新任务集的主题:","未命名任务集");if(!e||e.trim()==="")return;const t=`
subject: ${e}
tasks:
  - title: "二次函数图像与系数关系"
    problem: |
      已知二次函数 $y = ax^2 + bx + c$ 的图像如图所示，下列结论中正确的是？
      A. $a > 0, c > 0$
      B. $b^2 - 4ac < 0$
      C. $a - b + c > 0$
      D. $abc > 0$
    attachments:
      - type: image
        url: "function_graph.png"
    my_answer:
      content: "A"
    correct_answer:
      content: "C"
      explanation: |
        1. **开口方向**: 图像开口向上, $a > 0$
        2. **对称轴**: $x = -b/2a < 0$ → $b > 0$
        3. **与y轴交点**: $c < 0$
        4. **特殊点**: $x = -1$ 时, $y > 0$ → $a - b + c > 0$
    analysis:
      reason_for_error: "概念混淆"
      difficulty: 3
    tags: ["二次函数", "图像分析"]

  # 简易模式任务
  - simple_task:
      problem: "二次函数的定义是什么？"
      answer: "形如 y = ax^2 + bx + c (a≠0) 的函数"
      difficulty: 2
      tags: ["简易", "二次函数", "定义"]
`.trim();Gn.value=t,Gn.focus()}async _handleSave(){const e=await this.manager.loadFromYAML(Gn.value);e.success?(Qn.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>Qn.innerHTML='<i class="fas fa-save"></i>',2e3),this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()):alert(`保存失败: ${e.error}`)}_handleExport(){const e=new Blob([Gn.value],{type:"text/yaml;charset=utf-8"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="task-export.yml",t.click(),URL.revokeObjectURL(t.href)}_handleCollapseEditor(){Ur.classList.toggle("collapsed");const e=ti.querySelector("i");e.className=Ur.classList.contains("collapsed")?"fas fa-chevron-down":"fas fa-chevron-up",Ur.classList.contains("collapsed")&&this._handleSave()}async _handleFileLoad(e){const t=e.target.files[0];if(!t)return;const s=await t.text();Gn.value=s,await this._handleSave(),e.target.value=""}_handleSubjectChange(e){this.filters.subject=e.target.value,this.filters.tags=[],this.filters.reasons=[],this.currentPage=1,this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()}_handleFilterClick(e,t){const s=t.target.closest(".tag");if(!s)return;s.classList.toggle("active");const r=e==="tags"?ts:ns;this.filters[e]=Array.from(r.querySelectorAll(".tag.active")).map(o=>o.dataset.value),this.currentPage=1,this.refreshView()}_handleListClick(e){const t=e.target.closest(".task-item");if(!t)return;const s=t.dataset.id;this.ui.setActiveListItem(s);const r=Ht.querySelector(`.task-card[data-id="${s}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),this.ui.highlightPreviewCard(s))}_handlePaginationClick(e){const t=e.target.closest(".page-btn");t&&(this.currentPage=parseInt(t.dataset.page,10),this.refreshView())}async _handlePreviewClick(e){const t=e.target.closest(".task-card");if(!t)return;const s=t.dataset.id;e.target.matches(".show-answer-btn")&&this.ui.toggleAnswer(t,!0);const r=e.target.closest(".review-btn");if(r){const o=parseInt(r.dataset.rating,10),c=await this.manager.updateReviewStatus(s,o);c&&(this.ui.updateCardAfterReview(t,o),this.ui.updateListItem(s,c))}}}class rp{generateStats(e){const t={total:e.length,bySubject:{},byReason:{},dueToday:0,overdue:0},s=new Date;s.setHours(23,59,59,999);const r=new Date;return r.setHours(0,0,0,0),e.forEach(o=>{const c=o.subject||"未分类";t.bySubject[c]=(t.bySubject[c]||0)+1;const f=o.analysis.reason_for_error||"未知原因";t.byReason[f]=(t.byReason[f]||0)+1;const h=new Date(o.review.due);h<r?t.overdue++:h<=s&&t.dueToday++}),t}getDashboardHtml(e){const t=this.generateStats(e),s=Object.entries(t.bySubject).sort((c,f)=>f[1]-c[1]).slice(0,3),r=Object.entries(t.byReason).sort((c,f)=>f[1]-c[1]).slice(0,3),o=c=>c.length>0?c.map(([f,h])=>`<div class="list-item"><span>${f}</span><span class="list-value">${h}</span></div>`).join(""):"<span>暂无数据</span>";return`
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-chart-line"></i> 复习状态</div>
                <div class="stats-card-body">
                    <div class="stat-item"><span class="stat-value overdue">${t.overdue}</span><span class="stat-label">已过期</span></div>
                    <div class="stat-item"><span class="stat-value today">${t.dueToday}</span><span class="stat-label">今日到期</span></div>
                    <div class="stat-item"><span class="stat-value">${t.total}</span><span class="stat-label">总数</span></div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-book"></i> 科目分布</div>
                <div class="stats-card-body list-style">${o(s)}</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-diagnoses"></i> 主要错误原因</div>
                <div class="stats-card-body list-style">${o(r)}</div>
            </div>
        `}}async function ap(){console.log("Initializing Task Management System...");const n=new sp,e=new rp(n),t=new ep;await t.initialize();const s=new ip(t,n,e),r=Object.keys(t.getTaxonomy())[0]||"all";s.filters.subject=r,n.renderFilters(t.getTaxonomy(),r),s.init(),console.log("Task Management System is ready.")}const wn=K("settings-view"),op=K("settings_navList"),dc=K("settings_detailTitle"),si=K("settings_detailContent"),kn=K("settings_saveBtn"),Yl=K("settings_themeSelector"),Jl=K("settings_autosaveInterval"),fi=K("settings_exportDbBtn"),di=K("settings_importDbBtn"),wi=K("settings_importFileInput"),cp=K("settings_layoutTemplate"),lp=K("settings_generalFormTemplate"),up=K("settings_apiConfigFormTemplate"),fp=K("settings_agentFormTemplate"),ji={apiConfig:"settings_apiConfigFormDynamic",agent:"settings_agentFormDynamic"},Sn=Object.keys(se.tables.reduce((n,e)=>({...n,[e.name]:!0}),{}));async function dp(){console.log("Starting database export for tables:",Sn);const n={};return await se.transaction("r",Sn,async()=>{for(const e of Sn)if(se.table(e)){console.log(`Exporting table: ${e}`);const t=await se.table(e).toArray();n[e]=t}}),console.log("Database export completed."),n}async function hp(n){const e=Object.keys(n);if(e.length===0||!Sn.some(t=>e.includes(t)))throw new Error("导入文件格式无效或不包含任何可识别的数据表。");console.log("Starting database import..."),await se.transaction("rw",Sn,async()=>{for(const t of Sn)n[t]&&(console.log(`Clearing and importing table: ${t}`),await se.table(t).clear(),await se.table(t).bulkAdd(n[t]))}),console.log("Database import completed successfully.")}function Wl(n){const e=document.createElement("li");e.className="settings-nav-item",e.dataset.id=n.id,e.dataset.type=n.type;let t="fa-cog";return n.type==="apiConfig"?t="fa-key":n.type==="agent"&&(t="fa-robot"),e.innerHTML=`<i class="fas ${t}"></i><span>${n.name}</span>`,e}function hc(n,e,t){const s=document.createDocumentFragment(),r=document.createElement("div");r.className="settings-nav-group",r.innerHTML=`<h4 class="settings-nav-group-title">${n}</h4>
                       <button class="add-item-btn" data-type="${t}"><i class="fas fa-plus"></i> 添加</button>`;const o=document.createElement("ul");return e.forEach(c=>o.appendChild(Wl(c))),r.appendChild(o),s.appendChild(r),s}function qa(){if(wn.children.length>0)return;wn.innerHTML="",wn.appendChild(cp.content.cloneNode(!0));const n=op;if(!n)return;n.innerHTML="";const e=Wl({id:"general",type:"general",name:"应用设置"});n.appendChild(e);const t=A.apiConfigs.map(r=>({id:r.id,name:r.name,type:"apiConfig"})),s=A.agents.map(r=>({id:r.id,name:r.name,type:"agent"}));n.appendChild(hc("API 配置",t,"apiConfig")),n.appendChild(hc("Agent 配置",s,"agent"))}function Ra(n,e=!1){if(!si||!dc||!kn)return;kn.style.display=n.type!=="general"?"inline-flex":"none";let t;if(n.type==="general")t=lp;else if(n.type==="apiConfig")t=up;else if(n.type==="agent")t=fp;else{si.innerHTML='<div class="placeholder-content"><p>未知的配置类型</p></div>';return}si.innerHTML="",si.appendChild(t.content.cloneNode(!0)),n.type==="apiConfig"?pp(n,e):n.type==="agent"&&mp(n,e);const s=e?"fa-plus-circle":"fa-edit";dc.innerHTML=`<i class="fas ${s}"></i> ${e?`创建 ${n.displayName}`:`编辑: ${n.displayName}`}`}function pp(n,e){const t=document.getElementById(ji.apiConfig);if(!t)return;const s=t.querySelector(".config-provider");s.innerHTML="",Object.keys(ka).forEach(r=>{s.add(new Option(r,r))}),e?(t.querySelector(".delete-item-btn").style.display="none",s.value="火山",s.dispatchEvent(new Event("change"))):(t.querySelector(".config-id").value=n.id,t.querySelector(".config-name").value=n.name,s.value=n.provider,t.querySelector(".config-apiUrl").value=n.apiUrl||"",t.querySelector(".config-apiKey").value=n.apiKey,t.querySelector(".config-models").value=n.models)}function mp(n,e){var r;const t=document.getElementById(ji.agent);if(!t)return;const s=t.querySelector(".config-model");if(s.innerHTML='<option value="">-- 请选择模型 --</option>',A.apiConfigs.forEach(o=>{o.models&&o.models.split(",").map(c=>c.trim()).filter(Boolean).forEach(c=>{const[f,h]=c.split(":").map(m=>m.trim());if(f&&h){const m=`${o.id}:${f}`,I=`${o.name}: ${f} (${h})`;s.add(new Option(I,m))}})}),e)t.querySelector(".delete-item-btn").style.display="none",t.querySelector(".config-sendHistory").checked=!0;else{t.querySelector(".config-id").value=n.id,t.querySelector(".config-name").value=n.name,t.querySelector(".config-avatar").value=n.avatar||"",s.value=n.model||"",t.querySelector(".config-systemPrompt").value=n.systemPrompt||"",t.querySelector(".config-hint").value=n.hint||"",t.querySelector(".config-sendHistory").checked=n.sendHistory!==!1;const o=t.querySelector(".tags-list");o.innerHTML="",((r=n.tags)==null?void 0:r.length)>0&&n.tags.forEach(c=>{const f=document.createElement("li");f.textContent=c,f.innerHTML+='<button type="button" class="remove-tag-btn">×</button>',o.appendChild(f)})}}function An(n,e,t){n&&(n.disabled=e,n.innerHTML=e?'<i class="fas fa-spinner fa-spin"></i> 处理中...':t)}let Ze=null;function Gl(n){document.documentElement.setAttribute("data-theme",n||""),localStorage.setItem("app-theme",n)}function yp(n){Gl(n.target.value)}function gp(n){const e=parseInt(n.target.value,10);!isNaN(e)&&e>=0&&Z({settings:{...A.settings,autoSaveInterval:e}})}async function vp(){const n=fi.innerHTML;An(fi,!0,n);try{const e=await dp(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),s=URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download=`smart-suite-backup-${new Date().toISOString().slice(0,10)}.json`,r.click(),URL.revokeObjectURL(s)}catch(e){alert(`导出失败: ${e.message}`)}finally{An(fi,!1,n)}}async function bp(n){const e=n.target.files[0];if(!e)return;if(!confirm("警告！导入将覆盖所有数据。确定继续吗？")){wi.value="";return}const t=di.innerHTML;An(di,!0,t);try{const s=JSON.parse(await e.text());await hp(s),window.dispatchEvent(new CustomEvent("app:dataImported"))}catch(s){alert(`导入失败: ${s.message}`)}finally{An(di,!1,t),wi.value=""}}function wp(n){const e=n.target.closest(".settings-nav-item");if(!e)return;document.querySelectorAll(".settings-nav-item.active").forEach(o=>o.classList.remove("active")),e.classList.add("active");const{id:t,type:s}=e.dataset;let r;if(s==="general"?r={id:t,type:s,name:"应用设置"}:s==="apiConfig"?r=A.apiConfigs.find(o=>o.id===t):s==="agent"&&(r=A.agents.find(o=>o.id===t)),r){const o={...r,type:s,displayName:r.name};Ze=o,Ra(o),s==="general"&&(Yl.value=localStorage.getItem("app-theme")||"",Jl.value=A.settings.autoSaveInterval)}}function kp(n){const e=n.target.closest(".add-item-btn");if(!e)return;const{type:t}=e.dataset;Ze={type:t,displayName:t==="apiConfig"?"新 API 配置":"新 Agent"},Ra(Ze,!0)}function Sp(n){const e=n.target.closest("form");e&&(e.querySelector(".config-apiUrl").value=Zr(n.target.value))}async function _p(){if(!Ze)return;const n=kn.innerHTML;An(kn,!0,"保存中...");try{Ze.type==="apiConfig"?await Ip():Ze.type==="agent"&&await Ep(),wn.innerHTML="",qa()}catch(e){alert(`保存失败: ${e.message}`)}finally{An(kn,!1,n)}}async function Ip(){const n=document.getElementById(ji.apiConfig),e={name:n.querySelector(".config-name").value.trim(),provider:n.querySelector(".config-provider").value,apiUrl:n.querySelector(".config-apiUrl").value.trim(),apiKey:n.querySelector(".config-apiKey").value.trim(),models:n.querySelector(".config-models").value.trim()},t=n.querySelector(".config-id").value;await(t?_f(t,e):Sf(e))}async function Ep(){const n=document.getElementById(ji.agent),e=Array.from(n.querySelectorAll(".tags-list li")).map(r=>r.textContent.slice(0,-1).trim()),t={name:n.querySelector(".config-name").value.trim(),avatar:n.querySelector(".config-avatar").value.trim(),model:n.querySelector(".config-model").value,systemPrompt:n.querySelector(".config-systemPrompt").value.trim(),hint:n.querySelector(".config-hint").value.trim(),tags:e,sendHistory:n.querySelector(".config-sendHistory").checked},s=n.querySelector(".config-id").value;await(s?Tf(s,t):Ef(t))}async function Tp(n){if(!n.target.closest(".delete-item-btn")||!(Ze!=null&&Ze.id))return;const{type:e,id:t,displayName:s}=Ze;if(confirm(`确定要删除 "${s}" 吗?`))try{e==="apiConfig"?await If(t):e==="agent"&&await Af(t),wn.innerHTML="",qa(),Ra({},!1)}catch(r){alert(`删除失败: ${r.message}`)}}function Ap(){const n=wn;n&&(n.addEventListener("click",e=>{if(e.target.id===fi.id&&vp(),e.target.id===di.id&&wi.click(),e.target.closest(".settings-nav-item")&&wp(e),e.target.closest(".add-item-btn")&&kp(e),e.target.id===kn.id&&_p(),e.target.closest(".delete-item-btn")&&Tp(e),e.target.closest(".toggle-api-key-visibility")){const t=e.target.closest(".input-group").querySelector("input");t.type=t.type==="password"?"text":"password"}e.target.classList.contains("remove-tag-btn")&&e.target.parentElement.remove()}),n.addEventListener("change",e=>{e.target.id===Yl.id&&yp(e),e.target.id===Jl.id&&gp(e),e.target.id===wi.id&&bp(e),e.target.matches(".config-provider")&&Sp(e)}),n.addEventListener("keydown",e=>{if(e.target.classList.contains("config-tags-input")&&e.key==="Enter"){e.preventDefault();const t=e.target,s=t.value.trim();if(s){const r=t.closest(".tags-input-container").querySelector(".tags-list"),o=document.createElement("li");o.textContent=s,o.innerHTML+='<button type="button" class="remove-tag-btn">×</button>',r.appendChild(o),t.value=""}}}))}function Lp(n){if(Gl(localStorage.getItem("app-theme")||""),(n==null?void 0:n.type)==="agent"&&(n==null?void 0:n.action)==="create"){const e=document.querySelector('.add-item-btn[data-type="agent"]');e==null||e.click()}else{const e=document.querySelector('#settings-view .settings-nav-item[data-type="general"]');e==null||e.click()}}async function pc(n=null){const e=document.getElementById("settings-view");(n||e.innerHTML.trim()==="")&&(e.innerHTML="",qa()),Lp(n),Ap(),console.log("✅ Settings module initialized/updated.")}const mc={anki:!1,task:!1,agent:!1,settings:!1};async function hi(n=null){console.log("[ViewChange] Switching to view:",A.activeView),Object.values(Io).forEach(r=>r.style.display="none"),document.querySelectorAll(".app-nav-btn").forEach(r=>r.classList.remove("active"));const e=A.activeView||"anki",t=Io[e],s=document.getElementById(`nav-${e}`);if(mc[e])e==="settings"&&n&&(console.log("[Re-init] Re-initializing settings module with new context."),await pc(n));else{console.log(`[Lazy Init] Initializing ${e} module...`);try{switch(e){case"anki":await xd();break;case"agent":await Ud();break;case"task":await ap();break;case"settings":await pc(n);break}mc[e]=!0}catch(r){console.error(`Failed to lazy-initialize ${e} view:`,r)}}t&&(t.style.display="flex",t.classList.add("active")),s&&s.classList.add("active")}function Cp(){document.querySelector(".app-nav").addEventListener("click",n=>{const e=n.target.closest(".app-nav-btn");if(!e)return;n.preventDefault();const t=e.dataset.view;t&&t!==A.activeView&&(Mo(t),hi())}),window.addEventListener("app:navigateTo",n=>{const{view:e,context:t}=n.detail;e&&e!==A.activeView?(Mo(e),hi(t)):e&&e===A.activeView&&t&&hi(t)})}function Op(){let n=null;const e=()=>{var s;n&&clearInterval(n);const t=(s=A.settings)==null?void 0:s.autoSaveInterval;t>0&&(n=setInterval(of,t*60*1e3),console.log(`Auto-save timer set for every ${t} minutes.`))};e(),window.addEventListener("state-changed",t=>{t.detail.settings&&t.detail.settings.autoSaveInterval!==void 0&&e()}),window.addEventListener("beforeunload",()=>ra()),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ra()})}function Np(){window.addEventListener("app:dataImported",async()=>{console.log("Event 'app:dataImported' received. Re-initializing app..."),alert("数据导入成功！应用将刷新以应用更改。"),location.reload()})}async function $p(){document.body.classList.add("is-loading");try{await Ec(),await kf(),Cp(),Op(),Np();const n=A.activeView||"anki";Z({activeView:n}),await hi(),console.log("Application initialized successfully.")}catch(n){console.error("Application failed to initialize:",n);const e=document.createElement("div");e.className="error-overlay",e.innerHTML=`<h1>应用启动失败</h1><p>请检查控制台以获取详细信息。</p><pre>${n.stack}</pre>`,document.body.innerHTML="",document.body.appendChild(e)}finally{document.body.classList.remove("is-loading")}}document.addEventListener("DOMContentLoaded",$p);</script>
  <style rel="stylesheet" crossorigin>:root{--font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;--font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--leading-tight: 1.25;--leading-normal: 1.5;--leading-relaxed: 1.75;--primary-color: #5B66F5;--primary-hover: #4B55E3;--primary-light: #E8EAFF;--primary-dark: #3B41C5;--secondary-color: #6366F1;--secondary-light: #A5A7F3;--accent-color: #06B6D4;--accent-light: #E0F6FF;--gray-50: #F9FAFB;--gray-100: #F3F4F6;--gray-200: #E5E7EB;--gray-300: #D1D5DB;--gray-400: #9CA3AF;--gray-500: #6B7280;--gray-600: #4B5563;--gray-700: #374151;--gray-800: #1F2937;--gray-900: #111827;--sidebar-bg: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);--header-bg: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);--panel-header-bg: #4f46e5;--content-bg: #f8fafc;--success-color: #10B981;--success-light: #D1FAE5;--warning-color: #F59E0B;--warning-light: #FEF3C7;--danger-color: #EF4444;--danger-light: #FEE2E2;--bg-primary: #FFFFFF;--bg-secondary: #f1f5f9;--bg-tertiary: #F3F4F6;--bg-elevated: #FFFFFF;--text-primary: #111827;--text-secondary: #4B5563;--text-tertiary: #9CA3AF;--text-on-primary: #FFFFFF;--border-color: #E5E7EB;--border-radius: 8px;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .05);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);--transition: all .3s ease;--folder-color: #F59E0B;--file-color: #06B6D4;--sidebar-width: 56px;--agent-color-1: #5B66F5;--agent-color-2: #6366F1;--agent-color-3: #06B6D4;--agent-color-4: #8B5CF6;--agent-color-5: #EC4899;--topic-color-1: #F59E0B;--topic-color-2: #10B981;--topic-color-3: #3B82F6;--topic-color-4: #EF4444;--cloze-1d: #FEE2E2;--cloze-2d: #FED7AA;--cloze-3d: #FDE68A;--cloze-5d: #D9F99D;--cloze-7d: #BBF7D0;--cloze-14d: #BFDBFE;--cloze-28d: #E0E7FF;--cloze-28plus: #EDE9FE;--cloze-easy-open: #ECFDF5;--cloze-10m: #DC2626;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .05) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .05) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .05) 0%, transparent 50%)}[data-theme=dark]{--primary-light: rgba(91, 102, 245, .15);--accent-light: rgba(6, 182, 212, .1);--gray-50: #111827;--gray-100: #1F2937;--gray-200: #374151;--gray-300: #4B5563;--gray-400: #6B7280;--gray-500: #9CA3AF;--gray-600: #D1D5DB;--gray-700: #E5E7EB;--gray-800: #F3F4F6;--gray-900: #F9FAFB;--sidebar-bg: linear-gradient(135deg, #111827 0%, #1F2937 100%);--header-bg: linear-gradient(135deg, #374151 0%, #4B5563 100%);--panel-header-bg: #374151;--content-bg: #111827;--success-light: rgba(16, 185, 129, .15);--warning-light: rgba(245, 158, 11, .15);--danger-light: rgba(239, 68, 68, .15);--bg-primary: #1F2937;--bg-secondary: #111827;--bg-tertiary: #374151;--bg-elevated: #1F2937;--text-primary: #F9FAFB;--text-secondary: #D1D5DB;--text-tertiary: #9CA3AF;--border-color: #374151;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .3), 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .3), 0 2px 4px -1px rgba(0, 0, 0, .2);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .3), 0 4px 6px -2px rgba(0, 0, 0, .2);--cloze-1d: #4a1d1d;--cloze-2d: #543a1a;--cloze-3d: #574f20;--cloze-5d: #3a5323;--cloze-7d: #2a503a;--cloze-14d: #2c415e;--cloze-28d: #3c3e5e;--cloze-28plus: #444059;--cloze-easy-open: #224433;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .1) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .1) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .1) 0%, transparent 50%)}[data-theme=large-font]{--text-xs: .86rem;--text-sm: 1rem;--text-base: 1.125rem;--text-lg: 1.265rem;--text-xl: 1.406rem;--text-2xl: 1.687rem;--text-3xl: 2.1rem}[data-theme=larger-font]{--text-xs: .95rem;--text-sm: 1.1rem;--text-base: 1.25rem;--text-lg: 1.4rem;--text-xl: 1.56rem;--text-2xl: 1.875rem;--text-3xl: 2.34rem}*{margin:0;padding:0;box-sizing:border-box}html{height:100%}body{font-family:var(--font-primary);font-size:var(--text-base);line-height:1.5;background:var(--bg-secondary);color:var(--text-primary);display:flex;overflow:hidden;height:100%}.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);display:flex;flex-direction:column;flex-shrink:0}.main-content{flex:1;display:flex;flex-direction:column;min-width:0}.content-wrapper{flex:1;padding:20px;display:flex;flex-direction:column;min-height:0;overflow-y:auto}.main-layout{display:none;gap:20px;flex:1;min-height:0}.main-layout.active{display:flex}.app-container{flex:1;display:flex;flex-direction:column;gap:20px;min-width:0;min-height:0}.footer{display:none}.app-nav{display:flex;flex-direction:column;gap:8px;padding:20px 0;border-bottom:1px solid rgba(255,255,255,.1)}.app-nav-btn{background:#ffffff1a;color:#ffffffe6;border:1px solid rgba(255,255,255,.1);height:32px;width:32px;padding:0;margin:0 auto;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:600;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .3s cubic-bezier(.4,0,.2,1);text-decoration:none;overflow:hidden}.app-nav-btn:hover{background:#fff3;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #00000026}.app-nav-btn.active{background:#fffffff2;color:var(--primary-dark);border-color:transparent;box-shadow:0 4px 16px #ffffff4d}.app-nav-btn i{font-size:1.1rem;width:20px;text-align:center;flex-shrink:0}.app-nav-btn.active i{color:var(--primary-color)}.panel{background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 3px #0000000d;border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out}.panel.collapsed .panel-content{display:none}.panel.collapsed .collapse-btn i{transform:rotate(180deg)}.panel-header{background:var(--panel-header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 1px 3px #0000001a;padding:0 20px;display:flex;justify-content:space-between;align-items:center;height:60px;flex-shrink:0;position:relative}.panel-header:after{content:"";position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(to right,transparent,rgba(255,255,255,.2),transparent)}.panel-header .panel-title{flex-grow:1;justify-content:center;text-align:center}.panel-header .panel-actions-leading,.panel-header .panel-actions{flex-shrink:0;display:flex;gap:8px;align-items:center}.panel-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;gap:8px}.panel-actions{display:flex;gap:8px;align-items:center}.panel-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:4px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition)}.panel-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.panel-btn.active{background-color:#ffffff4d;transform:scale(1.1)}.panel-btn-text{width:auto;padding:0 15px;gap:8px}.panel-content{flex:1;padding:0;overflow:hidden;transition:var(--transition);display:flex;flex-direction:column;min-height:0}.collapse-btn i{transition:transform .3s ease}.session-sidebar{width:300px;background:var(--bg-elevated);box-shadow:var(--shadow-md);border:1px solid rgba(0,0,0,.06);border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:var(--transition)}.session-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 2px 8px #4f46e526;padding:15px 20px;display:flex;flex-direction:column;gap:12px}.session-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;justify-content:space-between}.session-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}.session-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px;border-radius:4px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;width:36px;height:36px;transition:var(--transition)}.session-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.session-content{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;min-height:0;background:var(--bg-secondary)}.session-list-container{flex:1;display:flex;flex-direction:column;min-height:0}.session-list{list-style:none;margin-top:10px;overflow-y:auto;flex:1}.session-item{padding:12px 15px 12px 30px;border-radius:6px;margin-bottom:8px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;cursor:pointer;transition:var(--transition);position:relative}.session-item.folder{background:#ffd1661a;border-left:4px solid var(--folder-color);padding-left:26px}.session-item.file{background:#a1c4fd1a;border-left:4px solid var(--file-color);padding-left:26px}.session-item:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:60px;display:flex;align-items:center;gap:8px}.session-item .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}.session-item .edit-btn,.session-item .delete-btn,.session-item .move-btn{color:var(--text-tertiary);cursor:pointer;padding:4px;border-radius:4px;transition:var(--transition);background:#fff9;width:24px;height:24px;display:flex;align-items:center;justify-content:center}.session-item .edit-btn:hover{background:var(--accent-color);color:var(--text-on-primary)}.session-item .delete-btn:hover{background:var(--danger-color);color:var(--text-on-primary)}.session-item .move-btn:hover{background:var(--success-color);color:var(--text-on-primary)}.session-item input[type=text]{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:.95rem;background-color:var(--bg-primary);color:var(--text-primary)}.select-controls{display:flex;gap:8px;margin-top:10px;padding:8px 0;background:#ffffff1a;border-top:1px solid rgba(255,255,255,.2);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.select-all{display:flex;align-items:center;gap:5px;color:var(--text-on-primary);font-size:.85rem}.session-item .select-checkbox{margin-right:8px}.folder-icon{color:var(--folder-color)}.file-icon{color:var(--file-color)}.current-folder{margin-top:10px;padding:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:inset 0 1px 2px #0000000d;border-radius:4px;font-size:.9rem;color:var(--text-primary);display:flex;align-items:center;flex-wrap:wrap;gap:4px}.current-folder i{margin-right:5px;color:var(--folder-color)}.breadcrumb-link{color:var(--primary-color);cursor:pointer;text-decoration:none}.breadcrumb-link:hover{text-decoration:underline}.breadcrumb-separator{margin:0 4px;color:#6c757d}.breadcrumb-current{font-weight:700;color:var(--secondary-color)}.empty-session{text-align:center;padding:28px;color:var(--text-tertiary)}.empty-session i{font-size:2.8rem;margin-bottom:14px;color:var(--gray-300)}.btn-primary,.btn-secondary,.btn-danger{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1rem;transition:var(--transition)}.btn-primary{background-color:var(--primary-color);color:var(--text-on-primary);font-weight:500}.btn-primary:hover{background-color:var(--primary-hover)}.btn-secondary{background-color:var(--gray-100);color:var(--text-secondary)}.btn-secondary:hover{background-color:var(--gray-200);color:var(--text-primary)}.btn-danger{background-color:var(--danger-color);color:var(--text-on-primary)}.btn-danger:hover{opacity:.85}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-primary)}.form-control{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);width:100%;padding:10px 12px;border-radius:6px;font-size:var(--text-base);transition:var(--transition)}.form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.input-group{display:flex}.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}.input-group-btn{padding:0 12px;border:1px solid var(--border-color);border-left:none;background-color:var(--bg-tertiary);border-top-right-radius:6px;border-bottom-right-radius:6px;cursor:pointer}.form-checkbox-group{display:flex;flex-wrap:wrap;gap:10px 20px;padding:5px 0}.form-checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:2000;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}.modal-content{background:var(--bg-elevated);box-shadow:0 20px 40px #00000026;border-radius:var(--border-radius);width:90%;max-width:600px;display:flex;flex-direction:column;max-height:90vh;animation:slide-in .3s ease-out}.modal-content.large{max-width:900px}.modal-header{padding:15px 25px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:var(--text-xl);color:var(--text-primary)}.modal-close{background:none;border:none;font-size:1.8rem;cursor:pointer;color:var(--text-tertiary)}.modal-body{padding:25px;overflow-y:auto}.modal-footer{padding:15px 25px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:10px}.move-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:var(--transition)}.move-modal.active{opacity:1;pointer-events:all}.move-modal-content{background:var(--bg-elevated);border-radius:var(--border-radius);padding:20px;width:400px;max-width:90%;box-shadow:var(--shadow)}.move-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.move-modal-title{font-size:1.2rem;font-weight:600;color:var(--primary-color)}.move-modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-tertiary)}.folder-list{max-height:300px;overflow-y:auto;margin:15px 0;border:1px solid var(--border-color);border-radius:var(--border-radius);padding:10px}.folder-item{padding:8px 10px;border-radius:4px;margin-bottom:5px;background:var(--bg-primary);cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}.folder-item:hover{background:var(--bg-tertiary)}.folder-item.selected{background:#4361ee1a;border-left:3px solid var(--primary-color)}.move-modal-actions{display:flex;justify-content:flex-end;gap:10px}.move-modal-btn{padding:8px 15px;border-radius:4px;cursor:pointer;border:none;font-weight:500;transition:var(--transition)}.move-modal-btn.confirm{background:var(--primary-color);color:var(--text-on-primary)}.move-modal-btn.cancel{background:var(--gray-100);color:var(--text-primary)}#anki_editorPreviewPanel{flex:1;min-height:0}#anki_editorPreviewPanel.preview-active #anki_editor,#anki_editorPreviewPanel.preview-active #anki_editorToolbar{display:none}#anki_editorPreviewPanel.preview-active #anki_preview{display:block}.editor-container{flex:1;display:flex;min-height:0;position:relative}#anki_editor,#anki_preview{position:absolute;top:0;left:0;width:100%;height:100%;margin:0;border:none;padding:15px;box-sizing:border-box;overflow:auto;background:transparent}#anki_editor{z-index:10;font-family:var(--font-mono);font-size:var(--text-sm);color:var(--text-primary);resize:none;line-height:1.5;background-color:var(--bg-primary)}#anki_editor:focus{outline:none;box-shadow:0 0 0 3px #4895ef33 inset}#anki_preview{z-index:5;display:none;font-size:var(--text-base);line-height:var(--leading-relaxed);color:var(--text-primary);background-color:var(--bg-elevated)}#anki_preview h1,#anki_preview h2,#anki_preview h3{margin-top:1.1em;margin-bottom:.7em;color:var(--text-primary);font-weight:700}#anki_preview h1{font-size:var(--text-3xl)}#anki_preview h2{font-size:var(--text-2xl)}#anki_preview h3{font-size:var(--text-xl)}#anki_preview p{margin-bottom:.9em}#anki_preview code{background:var(--gray-100);color:var(--primary-color);padding:2px 5px;border-radius:4px;font-family:var(--font-mono);font-size:var(--text-sm)}#anki_preview pre{background:var(--gray-50);color:var(--text-primary);padding:14px;border-radius:6px;overflow:auto;margin:1.4em 0;border:1px solid var(--border-color)}#anki_preview blockquote{border-left:4px solid var(--primary-color);padding:10px 18px;background:var(--primary-light);margin:1.4em 0}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px 15px;border-bottom:1px solid var(--border-color);background:var(--bg-tertiary);flex-shrink:0}.editor-btn{background:var(--bg-primary);border:1px solid var(--border-color);box-shadow:0 1px 2px #0000000d;padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem;color:var(--text-secondary)}.editor-btn:hover:not(:disabled){background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-color);transform:translateY(-1px);box-shadow:0 4px 8px #5b66f540}.editor-btn:disabled{opacity:.5;cursor:not-allowed}.mode-indicator{position:absolute;bottom:10px;right:10px;display:flex;gap:5px;z-index:20;background:#fffc;padding:5px 8px;border-radius:12px;box-shadow:0 2px 5px #0000001a}.mode-dot{width:10px;height:10px;border-radius:50%;background-color:var(--border-color)}.mode-dot.active{background-color:var(--primary-color)}.review-btn-group{display:flex;position:relative}.review-btn-group .panel-btn:first-child{border-top-right-radius:0;border-bottom-right-radius:0}.review-btn-group .dropdown-toggle{border-top-left-radius:0;border-bottom-left-radius:0;border-left:1px solid rgba(255,255,255,.3)}.dropdown-menu{position:absolute;top:105%;right:0;background-color:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;padding:8px 0;min-width:180px;border:1px solid var(--border-color)}.dropdown-menu a{display:block;padding:10px 15px;color:var(--text-primary);text-decoration:none;transition:background-color .2s ease;font-size:.9rem}.dropdown-menu a:hover{background-color:var(--gray-100)}.dropdown-menu a i{margin-right:10px;color:var(--primary-color);width:20px;text-align:center}#anki_audioControls{position:fixed;bottom:20px;right:20px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);padding:15px;z-index:1000;display:none}#anki_audioControls .audio-title{margin-bottom:10px;font-weight:600;color:var(--secondary-color)}#anki_audioControls .audio-progress{width:300px;height:6px;background:var(--border-color);border-radius:3px;margin:10px 0;overflow:hidden}#anki_audioControls .audio-progress-bar{height:100%;background:var(--primary-color);width:0%;transition:width .1s linear}#anki_audioControls .audio-buttons{display:flex;justify-content:space-between;gap:5px}#anki_audioControls .audio-btn{background:var(--primary-color);color:var(--text-on-primary);border:none;padding:8px 15px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:5px}.cloze{padding:2px 6px;border-radius:4px;cursor:pointer;position:relative;transition:var(--transition);border:1px dashed rgba(67,97,238,.3);font-weight:700;background:var(--cloze-28plus)}.cloze.hidden .cloze-content{display:none}.cloze.hidden .placeholder{display:inline}.cloze:not(.hidden) .placeholder{display:none}.placeholder{color:var(--primary-color);font-weight:700}.cloze-1d{background:var(--cloze-1d)!important}.cloze-2d{background:var(--cloze-2d)!important}.cloze-3d{background:var(--cloze-3d)!important}.cloze-5d{background:var(--cloze-5d)!important}.cloze-7d{background:var(--cloze-7d)!important}.cloze-14d{background:var(--cloze-14d)!important}.cloze-28d{background:var(--cloze-28d)!important}.cloze-28plus{background:var(--cloze-28plus)!important}.cloze-10m{background-color:var(--cloze-10m)!important;border-color:#f33!important;animation:pulse-alert 1.5s infinite alternate;color:var(--text-on-primary)!important;font-weight:700}.cloze.easy-open{background-color:var(--cloze-easy-open)!important;border:1px dashed #C8E6C9;color:var(--text-primary)!important;font-weight:400;opacity:.9}.cloze.permanent-view{background-color:var(--primary-light)!important;border:1px solid var(--primary-color)!important;font-weight:400!important}.cloze.permanent-view .cloze-actions{display:none!important}.cloze-actions{display:flex;justify-content:space-between;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.08)}.cloze-btn{flex:1;padding:10px 5px;border-radius:20px;border:none;background-color:var(--bg-primary);cursor:pointer;font-size:.9rem;font-weight:600;text-align:center;transition:all .2s ease-in-out;outline:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;box-shadow:0 2px 4px #0000000d}.cloze-btn i{font-size:1.2rem;margin-bottom:5px}.cloze-btn.again{color:#e53935;background-color:#e539351a}.cloze-btn.again:hover{background-color:#e53935;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #e539354d}.cloze-btn.hard{color:#fb8c00;background-color:#fb8c001a}.cloze-btn.hard:hover{background-color:#fb8c00;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #fb8c004d}.cloze-btn.double{color:#43a047;background-color:#43a0471a}.cloze-btn.double:hover{background-color:#43a047;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #43a0474d}.cloze-btn.easy{color:#1e88e5;background-color:#1e88e51a}.cloze-btn.easy:hover{background-color:#1e88e5;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #1e88e54d}.cloze.cloze-nav-active{outline:3px solid var(--accent-color, #06B6D4);box-shadow:0 0 15px #06b6d480;transition:outline .2s ease-in-out,box-shadow .2s ease-in-out}.cloze.cloze-error-duplicate{border:2px solid var(--danger-color, #EF4444)!important;background-color:var(--danger-light, #FEE2E2)!important;animation:pulse-error 1s infinite alternate}.cloze.cloze-error-duplicate .placeholder{color:var(--danger-color, #EF4444)!important;font-weight:700}#task-view .filter-group{margin-bottom:15px}#task-view .tag-list{display:flex;flex-wrap:wrap;gap:8px}#task-view .list-header{font-weight:600;color:var(--text-secondary);padding:10px 0;border-top:1px solid var(--border-color);margin-top:15px}#task_list .mistake-title{font-weight:500;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#task_list .mistake-meta{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-tertiary)}#task_yamlEditor{font-family:Consolas,Courier New,monospace;font-size:15px;resize:none;line-height:1.5;background-color:var(--bg-primary);color:var(--text-primary)}#task_previewContainer{flex:1;overflow-y:auto;padding:15px;background-color:var(--bg-elevated);display:block}#task_statsDashboard{display:flex;gap:15px;padding-bottom:15px}.stats-card{flex:1;background-color:var(--bg-elevated);border-radius:8px;border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000d;overflow:hidden}.stats-card-header{font-size:.9rem;font-weight:600;padding:8px 12px;background-color:var(--bg-tertiary);border-bottom:1px solid var(--border-color);color:var(--text-secondary)}.stats-card-header i{margin-right:8px;color:var(--primary-color)}.stats-card-body{padding:12px;display:flex;justify-content:space-around;align-items:center}.stat-item{display:flex;flex-direction:column;align-items:center;gap:4px}.stat-value{font-size:1.5rem;font-weight:700;color:var(--text-primary)}.stat-value.overdue{color:#d90429}.stat-value.today{color:#f77f00}.stat-label{font-size:.8rem;color:var(--text-tertiary)}.list-item{display:flex;justify-content:space-between;font-size:.85rem}.list-value{font-weight:600;padding:2px 6px;background-color:var(--bg-tertiary);border-radius:4px}.chart-container{position:relative;height:60vh;width:100%}.agent_topics-panel{width:300px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .3s ease,width .3s ease,padding .3s ease,border .3s ease}.agent_topics-panel.collapsed{width:0;padding-left:0;padding-right:0;border-width:0;transform:translate(-100%);overflow:hidden}.agent_topics-panel .topics-header{background:var(--header-bg);color:var(--text-on-primary);padding:10px 15px;font-size:var(--text-lg);font-weight:600;display:flex;justify-content:space-between;align-items:center;height:60px;flex-shrink:0}.agent_topics-panel .header-title-group{display:flex;align-items:center;gap:8px}.agent_topics-panel .header-actions-group{display:flex;align-items:center;gap:10px}.agent_topics-panel .topic-filter-select{padding:6px 30px 6px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.3);font-size:var(--text-sm);background:#ffffff1a;color:var(--text-on-primary);-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;cursor:pointer}.agent_topics-panel .topic-action-btn{background:#fff3;border:none;color:var(--text-on-primary);width:32px;height:32px;border-radius:50%;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;flex-shrink:0}.agent_topics-panel .topic-action-btn:hover{background:#fff6;transform:scale(1.1)}.agent_topics-panel .topics-batch-actions{padding:10px 15px;background-color:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;gap:10px;flex-shrink:0}.agent_topics-panel .batch-action-btn{padding:6px 12px;border-radius:6px;border:1px solid var(--border-color);background-color:var(--bg-primary);cursor:pointer}.agent_topics-panel .batch-action-btn.danger{background-color:var(--danger-light);color:var(--danger-color)}.agent_topics-panel .batch-action-btn:disabled{opacity:.5;cursor:not-allowed}.agent_topics-panel .topics-content{flex:1;padding:15px;overflow-y:auto}.agent_topics-panel .topic-list{list-style:none}.agent_topics-panel .topic-item{padding:12px 15px;border-radius:6px;margin-bottom:10px;background:var(--bg-secondary);border:1px solid var(--border-color);cursor:pointer;transition:var(--transition);position:relative;display:flex;align-items:center;gap:10px}.agent_topics-panel .topic-item:hover{transform:translate(5px);background:var(--bg-elevated);box-shadow:0 2px 8px #0000000f}.agent_topics-panel .topic-item.active{background:var(--primary-light);font-weight:600;border-left-color:var(--primary-color);border-left-width:4px}.agent_topics-panel .topic-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--text-on-primary);font-size:.8rem;flex-shrink:0}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+1){border-left-color:var(--topic-color-1)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+2){border-left-color:var(--topic-color-2)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+3){border-left-color:var(--topic-color-3)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+4){border-left-color:var(--topic-color-4)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+1) .topic-icon{background:var(--topic-color-1)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+2) .topic-icon{background:var(--topic-color-2)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+3) .topic-icon{background:var(--topic-color-3)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+4) .topic-icon{background:var(--topic-color-4)}.agent_history-panel{flex:1;background:var(--bg-elevated);border-radius:var(--border-radius);border:1px solid var(--border-color);display:flex;flex-direction:column;position:relative;min-width:0}.agent_history-panel .history-header{background:var(--header-bg);color:var(--text-on-primary);padding:15px 20px;display:flex;justify-content:space-between;align-items:center}.agent_history-panel .history-title{font-size:var(--text-lg);font-weight:600;display:flex;align-items:center;gap:10px}.agent_history-panel .history-header-actions{display:flex;align-items:center;gap:10px}.agent_history-panel .history-search{padding:8px 15px;border-radius:20px;border:none;width:250px;font-size:.9rem;background:#ffffffe6;box-shadow:0 2px 4px #0000001a;color:var(--text-primary)}.agent_history-panel .history-search:focus{background:var(--bg-elevated);box-shadow:0 4px 12px #00000026;outline:none}.agent_history-panel .role-selector{padding:8px 15px;border-radius:20px;border:1px solid rgba(255,255,255,.3);font-size:.9rem;background:#ffffff1a;color:var(--text-on-primary)}.agent_history-panel .history-content{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:20px;min-height:0;background:var(--bg-secondary)}.agent_history-panel .history-item{padding:15px;border-radius:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000a;border-left:3px solid var(--primary-color)}.agent_history-panel .history-item-header{display:flex;justify-content:space-between;margin-bottom:10px;color:var(--text-tertiary);font-size:.9rem}.agent_history-panel .history-item-content{line-height:1.6}.agent_history-panel .history-item-content img{max-width:100%;border-radius:8px;margin-top:10px}.agent_history-panel .history-item-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}.agent_history-panel .history-action-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;transition:var(--transition)}.agent_history-panel .history-action-btn:hover{background:#4361ee33}.agent_history-panel .chat-navigation{position:absolute;bottom:90px;right:25px;display:flex;flex-direction:column;gap:10px;z-index:10}.agent_history-panel .chat-nav-btn{width:40px;height:40px;border-radius:50%;background-color:var(--primary-color);color:var(--text-on-primary);border:none;cursor:pointer;box-shadow:0 2px 10px #0003;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:1rem}.agent_history-panel .chat-nav-btn:hover{background-color:var(--primary-hover);transform:scale(1.1)}.agent_history-panel .chat-nav-btn:disabled{opacity:.5;cursor:not-allowed}.agent_history-panel .chat-input-area{padding:15px 20px;border-top:1px solid var(--border-color);background:linear-gradient(to bottom,transparent,var(--bg-secondary));display:flex;flex-direction:column;gap:10px;flex-shrink:0}.agent_history-panel .input-controls{display:flex;align-items:flex-end;gap:10px}.agent_history-panel .chat-textarea{flex:1;border:2px solid var(--border-color);padding:10px 15px;font-family:inherit;font-size:var(--text-base);line-height:1.5;resize:vertical;transition:var(--transition);background:var(--bg-primary);color:var(--text-primary);border-radius:var(--border-radius)}.agent_history-panel .chat-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px #5b66f51a}.agent_history-panel .chat-action-btn{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:var(--transition);background:var(--gray-100);color:var(--text-secondary);flex-shrink:0}.agent_history-panel .chat-action-btn:hover{background:var(--gray-200);transform:translateY(-2px)}.agent_history-panel .chat-action-btn.send{background-color:var(--primary-color);color:var(--text-on-primary)}.agent_history-panel .chat-action-btn.send:hover{background-color:var(--secondary-color)}.agent_history-panel .attachment-preview-container{display:flex;gap:8px;flex-wrap:wrap;max-height:100px;overflow-y:auto}.agent_history-panel .attachment-preview-item{background:var(--bg-tertiary);padding:5px 12px;border-radius:15px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px;color:var(--text-primary);animation:fadeIn .3s ease}.agent_history-panel .attachment-preview-item i{color:var(--primary-color)}.agent_history-panel .remove-attachment-btn{cursor:pointer;font-weight:700;color:var(--text-tertiary);background:none;border:none;font-size:1.2rem;line-height:1;padding:0 2px;transition:var(--transition)}.agent_history-panel .remove-attachment-btn:hover{color:var(--danger-color);transform:scale(1.2)}.agent_history-panel .hint-panel{padding:20px;margin:-5px 0 15px;border-radius:8px;background-color:var(--bg-secondary);border:1px solid var(--border-color);display:flex;flex-direction:column;gap:15px;color:var(--text-secondary);opacity:0;animation:fadeIn .5s forwards}.agent_history-panel .hint-panel-header{display:flex;align-items:center;gap:12px}.agent_history-panel .hint-panel-avatar{width:32px;height:32px;border-radius:50%;background-color:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;flex-shrink:0}.agent_history-panel .hint-panel-title{font-weight:700;color:var(--text-primary)}.agent_history-panel .hint-panel-content{padding-left:44px;font-size:14px;line-height:1.6}.settings-nav-panel{width:280px;flex-shrink:0;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--border-radius);box-shadow:var(--shadow-sm);display:flex;flex-direction:column}.settings-nav-header{padding:20px;border-bottom:1px solid var(--border-color)}.settings-nav-header h3{font-size:var(--text-xl);color:var(--text-primary)}.settings-nav-list{padding:10px;overflow-y:auto;flex:1}.settings-nav-group{margin-bottom:20px}.settings-nav-group-title{padding:10px;font-size:var(--text-sm);font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}.add-item-btn{width:calc(100% - 20px);margin:0 10px 10px;padding:8px;background:var(--primary-light);color:var(--primary-color);border:1px dashed var(--primary-color);border-radius:6px;cursor:pointer;text-align:center;font-weight:600;transition:var(--transition)}.add-item-btn:hover{background:var(--primary-color);color:var(--text-on-primary);border-style:solid}.settings-nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:6px;cursor:pointer;transition:background-color .2s ease,color .2s ease;color:var(--text-secondary);font-weight:500;margin-bottom:4px}.settings-nav-item:hover{background-color:var(--bg-secondary);color:var(--text-primary)}.settings-nav-item.active{background-color:var(--primary-color);color:var(--text-on-primary);box-shadow:0 4px 8px #5b66f533}.settings-nav-item i,.settings-nav-item.active i{color:inherit;width:20px;text-align:center}.settings-detail-panel{flex:1;min-width:0;height:100%;display:flex;flex-direction:column}#settings_detailContent{flex-grow:1;overflow-y:auto;padding:25px}.placeholder-content{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center}.placeholder-content i{color:var(--gray-300)}.placeholder-content p{margin-top:15px;color:var(--text-tertiary)}.settings-section{margin-bottom:30px;max-width:600px}.settings-section-title{font-size:var(--text-xl);color:var(--text-primary);border-bottom:2px solid var(--primary-light);padding-bottom:10px;margin-bottom:20px;font-weight:600}.settings-detail-footer{margin-top:30px;padding-top:20px;border-top:1px solid var(--border-color)}.tags-input-container{display:flex;flex-direction:column;border:1px solid var(--border-color);border-radius:6px;padding:5px;background:var(--bg-primary)}.tags-input-container:focus-within{border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.tags-list{display:flex;flex-wrap:wrap;gap:8px;list-style:none;padding:5px}.tags-list li{background-color:var(--primary-color);color:var(--text-on-primary);padding:6px 12px;border-radius:20px;font-size:var(--text-sm);display:flex;align-items:center;gap:8px}.remove-tag-btn{background:none;border:none;color:var(--text-on-primary);cursor:pointer;font-size:1.2em;line-height:1;opacity:.7;padding:0}.remove-tag-btn:hover{opacity:1}.config-tags-input{border:none!important;box-shadow:none!important;flex-grow:1;padding:8px 7px!important}.config-tags-input:focus{outline:none}.form-checkbox-label{display:inline-flex;align-items:center;cursor:pointer;gap:10px}.form-checkbox-label input[type=checkbox]{width:1.2em;height:1.2em}.file-input{display:none}.hidden-session{transform:translate(-325px);opacity:0;width:0;overflow:hidden}.session-item-details{margin-bottom:8px;list-style:none}.session-item-details summary{list-style:none;cursor:pointer;outline:none;padding:12px 15px;border-radius:6px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;transition:var(--transition);position:relative}.session-item-details summary::-webkit-details-marker{display:none}.session-item-details summary:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item-details summary.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item-details summary .name:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900;margin-right:10px;transition:transform .2s ease-in-out;display:inline-block;color:var(--text-tertiary)}.session-item-details[open]>summary .name:before{transform:rotate(90deg)}@keyframes highlight{0%{background:#fff9c4}to{background:linear-gradient(120deg,#a1c4fd,#c2e9fb)}}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes slide-in{0%{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}@keyframes pulse-error{0%{box-shadow:0 0 #ef444466}to{box-shadow:0 0 0 5px #ef444400}}@keyframes pulse-alert{0%{opacity:.7}to{opacity:1}}@media (max-width: 1200px){body{flex-direction:column;height:auto;min-height:100vh}.sidebar{position:relative;width:100%;min-height:auto;flex-direction:row;align-items:center}.app-nav{flex-direction:row;padding:15px;flex:1;justify-content:center;background:#0000001a;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.app-nav-btn{margin:0 4px}.main-content{margin-left:0}.main-layout{flex-direction:column}.session-sidebar,.agent_topics-panel{width:100%;max-width:100%;max-height:40vh}.app-container{min-width:100%}}@media (max-width: 768px){.panel-header{flex-direction:column;align-items:flex-start;gap:10px;height:auto;padding:10px}.panel-header .panel-title{text-align:left}.panel-actions{width:100%;justify-content:space-between;flex-wrap:wrap}.app-nav{flex-wrap:wrap}}</style>
</head>
<body>
    <!-- 全局布局: 左侧导航栏 -->
    <div class="sidebar">
        
        <nav class="app-nav">
            <a href="#" class="app-nav-btn active" data-view="anki" id="nav-anki" title="Anki 笔记">
                <i class="fas fa-layer-group"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="task" id="nav-task" title="任务管理">
                <i class="fas fa-book"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="agent" id="nav-agent" title="AI角色">
                <i class="fas fa-robot"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="settings" id="nav-settings" title="设置">
                <i class="fas fa-cog"></i>
            </a>
        </nav>
    </div>

    <!-- 全局布局: 主内容区域 -->
    <div class="main-content">
        <div class="content-wrapper">

            <!-- ====================================================== -->
            <!--                  Anki 笔记视图                      -->
            <!-- ====================================================== -->
            <div id="anki-view" class="main-layout" style="display: none;">
                <div class="session-sidebar anki_session-sidebar">
                    <div class="session-header">
                        <div class="session-title" id="anki_sessionTitleContainer">
                            <span><i class="fas fa-layer-group"></i> 会话管理</span>
                        </div>
                        <div class="session-controls">
                            <button id="anki_newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                            <button id="anki_newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                            <button id="anki_openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                            <button id="anki_moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                            <button id="anki_deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="select-controls">
                            <label class="select-all"><input type="checkbox" id="anki_selectAllCheckbox"> 全选</label>
                        </div>
                        <div class="current-folder" id="anki_currentFolderContainer"></div>
                    </div>
                    <div class="session-content">
                        <div class="session-list-container">
                            <ul class="session-list" id="anki_sessionList"></ul>
                            <div class="empty-session" id="anki_emptySession">
                                <i class="fas fa-folder-open"></i>
                                <p>没有打开的会话</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-container">
                    <div class="panel editor-preview-panel" id="anki_editorPreviewPanel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                                <button id="anki_toggleSessionBtn" class="panel-btn" title="显示/隐藏会话栏"><i class="fas fa-bars"></i></button>
                                <button id="anki_toggleEditPreviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-book-open"></i> Preview</button>
                            </div>
                            <div class="panel-title"><i class="fas fa-edit"></i> Anki 编辑器</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="anki_startReviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 复习 (<span id="anki_reviewCount">0</span>)</button>
                                    <button id="anki_reviewOptionsBtn" class="panel-btn dropdown-toggle"><i class="fas fa-chevron-down"></i></button>
                                    <div id="anki_reviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                        <a href="#" id="anki_customStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
                                        <a href="#" id="anki_showStatsBtn"><i class="fas fa-chart-line"></i> 统计</a>
                                    </div>
                                </div>
                                <button id="anki_clozeNavUpBtn" class="panel-btn" title="上一个 Cloze"><i class="fas fa-arrow-up"></i></button>
                                <button id="anki_clozeNavDownBtn" class="panel-btn" title="下一个 Cloze"><i class="fas fa-arrow-down"></i></button>
                                <button id="anki_toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏"><i class="fas fa-eye-slash"></i></button>
                                <button id="anki_invertClozeBtn" class="panel-btn" title="反向显示/隐藏"><i class="fas fa-random"></i></button>
                                <button id="anki_saveBtn" class="panel-btn panel-btn-text" title="保存"><i class="fas fa-save"></i></button>
                                <button id="anki_exportFileBtn" class="panel-btn panel-btn-text" title="导出"><i class="fas fa-download"></i></button>
                                <button id="anki_printPreviewBtn" class="panel-btn panel-btn-text" title="打印预览内容" disabled><i class="fas fa-print"></i></button>
                                <button id="anki_toggleEditorBtn" class="panel-btn collapse-btn" title="收起/展开编辑器"><i class="fas fa-chevron-up"></i></button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="editor-sub-toolbar" id="anki_editorToolbar">
                                <button id="anki_clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
                                <button id="anki_boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
                                <button id="anki_italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
                                <button id="anki_insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
                                <button id="anki_codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
                                <button id="anki_linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
                                <button id="anki_audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
                            </div>
                            <div class="editor-container" id="anki_editorContainer">
                                <textarea id="anki_editor" class="editor"></textarea>
                                <div id="anki_preview"></div>
                            </div>
                            <div class="mode-indicator">
                                <div class="mode-dot active" id="anki_editModeDot" title="编辑模式"></div>
                                <div class="mode-dot" id="anki_previewModeDot" title="预览模式"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                任务/错题本视图 (重命名)               -->
            <!-- ====================================================== -->
            <div id="task-view" class="main-layout" style="display: none;">
                <div class="session-sidebar task_session-sidebar">
                    <div class="session-header">
                        <div class="session-title"><span><i class="fas fa-book-open"></i> 任务筛选与导航</span></div>
                        <div class="session-controls">
                            <select id="task_subjectFilter"></select>
                            <button id="task_refreshBtn" class="session-btn" title="刷新"><i class="fas fa-sync-alt"></i></button>
                            <button id="task_newFileBtn" class="session-btn" title="新建任务文件"><i class="fas fa-file-alt"></i></button>
                            <button id="task_loadYamlBtn" class="session-btn" title="导入YAML文件"><i class="fas fa-file-upload"></i></button>
                            <input type="file" id="task_yamlFileInput" accept=".yml,.yaml" style="display: none;">
                        </div>
                    </div>
                    <div class="session-content">
                        <div class="filter-group" data-type="tags">
                            <div class="tag-list" id="task_tagFilterContainer"></div>
                        </div>
                        <div class="filter-group" data-type="reasons">
                            <div class="tag-list" id="task_reasonFilterContainer"></div>
                        </div>
                        <div class="list-header"><i class="fas fa-list-ul"></i> 待复习列表</div>
                        <ul class="session-list" id="task_list"></ul>
                        <div class="pagination" id="task_paginationContainer"></div>
                    </div>
                </div>

                <div class="app-container">
                    <div id="task_statsDashboard" class="stats-dashboard-inline"></div>
                    <div id="task_editorPanel" class="panel editor-panel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                                <button id="task_toggleSessionBtn" class="panel-btn" title="显示/隐藏筛选栏"><i class="fas fa-bars"></i></button>
                            </div>
                            <div class="panel-title"><i class="fas fa-code"></i> YAML 编辑器</div>
                            <div class="panel-actions">
                                <button id="task_saveBtn" class="panel-btn" title="保存并刷新"><i class="fas fa-save"></i></button>
                                <button id="task_exportBtn" class="panel-btn" title="导出YAML"><i class="fas fa-download"></i></button>
                                <button id="task_collapseBtn" class="panel-btn collapse-btn" title="收起/展开"><i class="fas fa-chevron-up"></i></button>
                            </div>
                        </div>
                        <div class="panel-content"><textarea id="task_yamlEditor"></textarea></div>
                    </div>
                    <div id="task_previewPanel" class="panel preview-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-eye"></i> 任务预览</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="task_startReviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 开始复习</button>
                                </div>
                            </div>
                        </div>
                        <div class="panel-content"><div id="task_previewContainer"></div></div>
                    </div>
                </div>
            </div>
            
            <!-- ====================================================== -->
            <!--                  AI Agent 视图                       -->
            <!-- ====================================================== -->
            <div id="agent-view" class="main-layout" style="display: none;">
                <div class="topics-panel agent_topics-panel">
                    <div class="topics-header">
                        <div class="header-title-group"><i class="fas fa-book"></i> 聊天主题</div>
                        <div class="header-actions-group">
                            <select id="agent_topicTagFilter" class="topic-filter-select"></select>
                            <button id="agent_editTopicBtn" class="topic-action-btn" title="重命名"><i class="fas fa-pencil-alt"></i></button>
                            <button id="agent_manageTopicsBtn" class="topic-action-btn" title="管理"><i class="fas fa-tasks"></i></button>
                        </div>
                    </div>
                    <div class="topics-batch-actions" id="agent_topicsBatchActions" style="display: none;">
                        <button id="agent_selectAllTopicsBtn" class="batch-action-btn">全选</button>
                        <button id="agent_deleteSelectedTopicsBtn" class="batch-action-btn danger">删除</button>
                        <button id="agent_cancelTopicSelectionBtn" class="batch-action-btn">取消</button>
                    </div>
                    <div class="topics-content"><ul class="topic-list" id="agent_topicList"></ul></div>
                </div>

                <div class="history-panel agent_history-panel">
                    <div class="history-header">
                        <div class="history-title">
                            <button id="agent_toggleTopicsBtn" class="panel-btn"><i class="fas fa-bars"></i></button>
                            <i class="fas fa-comments"></i>
                            <span id="agent_historyHeaderTitle">对话记录</span>
                        </div>
                        <div class="history-header-actions">
                            <input type="text" id="agent_historySearch" class="history-search" placeholder="搜索...">
                            <select id="agent_conversationRoleSelector" class="role-selector"></select>
                        </div>
                    </div>
                    <div class="history-content" id="agent_historyContent"></div>
                    <div class="chat-navigation">
                        <button id="agent_chatNavUp" class="chat-nav-btn"><i class="fas fa-arrow-up"></i></button>
                        <button id="agent_chatNavDown" class="chat-nav-btn"><i class="fas fa-arrow-down"></i></button>
                    </div>
                    <div class="chat-input-area" id="agent_chatInputArea">
                        <div class="attachment-preview-container" id="agent_attachmentPreview"></div>
                        <div class="input-controls">
                            <textarea id="agent_chatInput" class="chat-textarea"></textarea>
                            <input type="file" id="agent_attachmentInput" multiple style="display: none;">
                            <button id="agent_attachFileBtn" class="chat-action-btn"><i class="fas fa-paperclip"></i></button>
                            <button id="agent_sendMessageBtn" class="chat-action-btn send"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                  设置视图                           -->
            <!-- ====================================================== -->
            <div id="settings-view" class="main-layout" style="display: none;">
                <!-- 内容由JS动态填充 -->
            </div>

        </div> <!-- .content-wrapper 结束 -->
    </div> <!-- .main-content 结束 -->

    <!-- ====================================================== -->
    <!--                  全局模态框与模板                      -->
    <!-- ====================================================== -->

    <!-- Anki 模块的音频播放器 -->
    <div class="audio-controls" id="anki_audioControls">
        <div class="audio-title" id="anki_audioTitle"></div>
        <div class="audio-progress"><div class="audio-progress-bar" id="anki_audioProgressBar"></div></div>
        <div class="audio-buttons">
            <button id="anki_playBtn" class="audio-btn"><i class="fas fa-play"></i> 播放</button>
            <button id="anki_pauseBtn" class="audio-btn"><i class="fas fa-pause"></i> 暂停</button>
            <button id="anki_stopBtn" class="audio-btn"><i class="fas fa-stop"></i> 停止</button>
        </div>
    </div>
    
    <!-- Anki 模块的移动文件模态框 -->
    <div class="move-modal" id="anki_moveModal">
        <div class="move-modal-content">
            <div class="move-modal-header">
                <div class="move-modal-title">移动到目录</div>
                <button class="move-modal-close" id="anki_closeMoveModalBtn">×</button>
            </div>
            <p>选择目标目录：</p>
            <div class="folder-list" id="anki_folderList"></div>
            <div class="move-modal-actions">
                <button class="move-modal-btn cancel" id="anki_cancelMoveBtn">取消</button>
                <button class="move-modal-btn confirm" id="anki_confirmMoveBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- Anki 模块的自定义复习模态框 -->
    <div class="modal-overlay" id="anki_customStudyModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>自定义复习</h2>
                <button class="modal-close" id="anki_customStudyCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <form id="anki_customStudyForm">
                    <div class="form-group"><label for="anki_filterByFile">按文件/目录筛选:</label><select id="anki_filterByFile" class="form-control"></select></div>
                    <div class="form-group">
                        <label>按卡片状态筛选:</label>
                        <div class="form-checkbox-group">
                            <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                            <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                            <label><input type="checkbox" name="cardState" value="review" checked> 复习中</label>
                            <!-- [恢复] 增加了 "重学中" 选项 -->
                            <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                        </div>
                    </div>
                    <!-- [恢复] 增加了 "按最后一次复习时间筛选" 的完整功能块 -->
                    <div class="form-group">
                        <label for="anki_filterByLastReview">按最后一次复习时间筛选:</label>
                        <select id="anki_filterByLastReview" class="form-control">
                            <option value="any">任何时间</option>
                            <option value="last7days">最近7天内</option>
                            <option value="last30days">最近30天内</option>
                            <option value="over30days">超过30天未复习</option>
                            <option value="never">从未复习过 (新卡片)</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="anki_maxCards">最大卡片数量:</label><input type="number" id="anki_maxCards" class="form-control" value="50" min="1"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="anki_customStudyCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="anki_startCustomStudyBtn" form="anki_customStudyForm">开始</button>
            </div>
        </div>
    </div>

    <!-- Anki 模块的统计模态框 -->
    <div class="modal-overlay" id="anki_statsModal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header"><h2>复习统计</h2><button class="modal-close" id="anki_statsModalCloseBtn">×</button></div>
            <div class="modal-body"><p>近30天每日复习卡片数量</p><div class="chart-container"><canvas id="anki_statsChart"></canvas></div></div>
        </div>
    </div>
    
    <!-- 设置模块使用的模板 -->
    <template id="settings_layoutTemplate">
        <div class="settings-nav-panel">
            <div class="settings-nav-header"><h3><i class="fas fa-sliders-h"></i> 设置</h3></div>
            <div class="settings-nav-list" id="settings_navList"></div>
        </div>
        <div class="settings-detail-panel">
            <div class="panel" style="height: 100%;">
                <div class="panel-header">
                    <div id="settings_detailTitle" class="panel-title"></div>
                    <div class="panel-actions"><button id="settings_saveBtn" class="panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button></div>
                </div>
                <div id="settings_detailContent" class="panel-content" style="padding: 25px; overflow-y: auto;">
                     <div class="placeholder-content"><i class="fas fa-cogs fa-3x"></i><p>从左侧选择一个项目进行配置</p></div>
                </div>
            </div>
        </div>
    </template>

    <template id="settings_generalFormTemplate">
        <div data-id="general" data-type="general">
            <div class="settings-section">
                <h3 class="settings-section-title">外观与主题</h3>
                <div class="form-group"><label for="settings_themeSelector">选择主题</label><select id="settings_themeSelector" class="form-control">
                    <option value="">默认 (亮色)</option><option value="dark">暗黑</option><option value="large-font">大号字体</option><option value="larger-font">更大号字体</option>
                </select></div>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">数据与同步</h3>
                <div class="form-group"><label for="settings_autosaveInterval">自动保存间隔 (分钟)</label><input type="number" id="settings_autosaveInterval" class="form-control" min="0"></div>
                <div class="form-group"><label>数据库同步</label><div style="display: flex; gap: 15px;">
                    <button id="settings_exportDbBtn" class="btn-secondary"><i class="fas fa-download"></i> 导出数据</button>
                    <button id="settings_importDbBtn" class="btn-danger"><i class="fas fa-upload"></i> 导入数据</button>
                </div><input type="file" id="settings_importFileInput" accept=".json" style="display: none;"></div>
            </div>
        </div>
    </template>

    <template id="settings_apiConfigFormTemplate">
        <div data-type="apiConfig">
            <form id="settings_apiConfigFormDynamic" novalidate>
                <input type="hidden" class="config-id"><div class="form-group"><label>配置名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>提供商</label><select class="config-provider form-control" required></select></div>
                <div class="form-group"><label>API 地址</label><input type="url" class="config-apiUrl form-control"></div>
                <div class="form-group"><label>API Key</label><div class="input-group">
                    <input type="password" class="config-apiKey form-control"><button type="button" class="toggle-api-key-visibility input-group-btn"><i class="fas fa-eye"></i></button>
                </div></div>
                <div class="form-group"><label>Models (别名:模型名)</label><textarea class="config-models form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此配置</button></div>
            </form>
        </div>
    </template>

    <template id="settings_agentFormTemplate">
        <div data-type="agent">
            <form id="settings_agentFormDynamic" novalidate>
                <input type="hidden" class="config-id"><div class="form-group"><label>角色名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>头像 (2字符)</label><input type="text" class="config-avatar form-control" required maxlength="2"></div>
                <div class="form-group"><label>选择模型</label><select class="config-model form-control" required></select></div>
                <div class="form-group"><label>System Prompt</label><textarea class="config-systemPrompt form-control" rows="8"></textarea></div>
                <div class="form-group"><label>标签</label><div class="tags-input-container"><ul class="tags-list"></ul><input type="text" class="config-tags-input form-control"></div></div>
                <div class="form-group"><label class="form-checkbox-label"><input type="checkbox" class="config-sendHistory"> 发送历史上下文</label></div>
                <div class="form-group"><label>欢迎语 (可选)</label><textarea class="config-hint form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此角色</button></div>
            </form>
        </div>
    </template>
    <div class="footer">
        <p>© 2024 智能学习套件 | 数据保存在浏览器本地存储中</p>
    </div>

</body>
</html>
