<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
  <script type="module" crossorigin>(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const b of document.querySelectorAll('link[rel="modulepreload"]'))l(b);new MutationObserver(b=>{for(const S of b)if(S.type==="childList")for(const x of S.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&l(x)}).observe(document,{childList:!0,subtree:!0});function u(b){const S={};return b.integrity&&(S.integrity=b.integrity),b.referrerPolicy&&(S.referrerPolicy=b.referrerPolicy),b.crossOrigin==="use-credentials"?S.credentials="include":b.crossOrigin==="anonymous"?S.credentials="omit":S.credentials="same-origin",S}function l(b){if(b.ep)return;b.ep=!0;const S=u(b);fetch(b.href,S)}})();const ce=o=>document.querySelector(o),G=o=>document.getElementById(o),yi=ce(".main-layout"),vi=ce(".agent-content-container");ce(".ai-agent-nav");let Li={activeView:"anki",sessions:[],folders:[],clozeStates:{},fileSubsessions:{},currentSessionId:null,currentFolderId:null,currentSubsessionId:null,folderStack:[],agents:[],topics:[],history:[],currentAgentId:null,currentTopicId:null,isLoading:!0,isAiThinking:!1,isSessionSidebarHidden:!1,areAllClozeVisible:!1,movingItems:[],selectedMoveTarget:null};const T=new Proxy(Li,{get(o,s){if(s in o){const u=o[s];return typeof u=="object"&&u!==null?JSON.parse(JSON.stringify(u)):u}},set(){return console.warn("Direct mutation of appState is not allowed. Use a data service function."),!1}});function W(o){Object.assign(Li,o)}var gi=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function zo(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var Pi={exports:{}};(function(o,s){(function(u,l){o.exports=l()})(gi,function(){var u=function(e,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(n[i]=r[i])})(e,t)},l=function(){return(l=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function b(e,t,n){for(var r,i=0,a=t.length;i<a;i++)!r&&i in t||((r=r||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}var S=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:gi,x=Object.keys,B=Array.isArray;function N(e,t){return typeof t!="object"||x(t).forEach(function(n){e[n]=t[n]}),e}typeof Promise>"u"||S.Promise||(S.Promise=Promise);var z=Object.getPrototypeOf,ee={}.hasOwnProperty;function Y(e,t){return ee.call(e,t)}function oe(e,t){typeof t=="function"&&(t=t(z(e))),(typeof Reflect>"u"?x:Reflect.ownKeys)(t).forEach(function(n){he(e,n,t[n])})}var ut=Object.defineProperty;function he(e,t,n,r){ut(e,t,N(n&&Y(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function me(e){return{from:function(t){return e.prototype=Object.create(t.prototype),he(e.prototype,"constructor",e),{extend:oe.bind(null,e.prototype)}}}}var De=Object.getOwnPropertyDescriptor,Ge=[].slice;function _e(e,t,n){return Ge.call(e,t,n)}function Se(e,t){return t(e)}function Te(e){if(!e)throw new Error("Assertion Failed")}function Et(e){S.setImmediate?setImmediate(e):setTimeout(e,0)}function Be(e,t){if(typeof t=="string"&&Y(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var n=[],r=0,i=t.length;r<i;++r){var a=Be(e,t[r]);n.push(a)}return n}var c=t.indexOf(".");if(c!==-1){var d=e[t.substr(0,c)];return d==null?void 0:Be(d,t.substr(c+1))}}function ve(e,t,n){if(e&&t!==void 0&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){Te(typeof n!="string"&&"length"in n);for(var r=0,i=t.length;r<i;++r)ve(e,t[r],n[r])}else{var a,c,d=t.indexOf(".");d!==-1?(a=t.substr(0,d),(c=t.substr(d+1))===""?n===void 0?B(e)&&!isNaN(parseInt(a))?e.splice(a,1):delete e[a]:e[a]=n:ve(d=!(d=e[a])||!Y(e,a)?e[a]={}:d,c,n)):n===void 0?B(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function Pr(e){var t,n={};for(t in e)Y(e,t)&&(n[t]=e[t]);return n}var ao=[].concat;function Or(e){return ao.apply([],e)}var Xe="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Or([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return S[e]}),Dr=new Set(Xe.map(function(e){return S[e]})),It=null;function Ye(e){return It=new WeakMap,e=function t(n){if(!n||typeof n!="object")return n;var r=It.get(n);if(r)return r;if(B(n)){r=[],It.set(n,r);for(var i=0,a=n.length;i<a;++i)r.push(t(n[i]))}else if(Dr.has(n.constructor))r=n;else{var c,d=z(n);for(c in r=d===Object.prototype?{}:Object.create(d),It.set(n,r),n)Y(n,c)&&(r[c]=t(n[c]))}return r}(e),It=null,e}var so={}.toString;function Bn(e){return so.call(e).slice(8,-1)}var Cn=typeof Symbol<"u"?Symbol.iterator:"@@iterator",co=typeof Cn=="symbol"?function(e){var t;return e!=null&&(t=e[Cn])&&t.apply(e)}:function(){return null};function Qe(e,t){return t=e.indexOf(t),0<=t&&e.splice(t,1),0<=t}var lt={};function Ce(e){var t,n,r,i;if(arguments.length===1){if(B(e))return e.slice();if(this===lt&&typeof e=="string")return[e];if(i=co(e)){for(n=[];!(r=i.next()).done;)n.push(r.value);return n}if(e==null)return[e];if(typeof(t=e.length)!="number")return[e];for(n=new Array(t);t--;)n[t]=e[t];return n}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var Ln=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Tt=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],we=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Tt),uo={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function dt(e,t){this.name=e,this.message=t}function Kr(e,t){return e+". Errors: "+Object.keys(t).map(function(n){return t[n].toString()}).filter(function(n,r,i){return i.indexOf(n)===r}).join(`
`)}function Yt(e,t,n,r){this.failures=t,this.failedKeys=r,this.successCount=n,this.message=Kr(e,t)}function ft(e,t){this.name="BulkError",this.failures=Object.keys(t).map(function(n){return t[n]}),this.failuresByPos=t,this.message=Kr(e,this.failures)}me(dt).from(Error).extend({toString:function(){return this.name+": "+this.message}}),me(Yt).from(dt),me(ft).from(dt);var Pn=we.reduce(function(e,t){return e[t]=t+"Error",e},{}),lo=dt,F=we.reduce(function(e,t){var n=t+"Error";function r(i,a){this.name=n,i?typeof i=="string"?(this.message="".concat(i).concat(a?`
 `+a:""),this.inner=a||null):typeof i=="object"&&(this.message="".concat(i.name," ").concat(i.message),this.inner=i):(this.message=uo[t]||n,this.inner=null)}return me(r).from(lo),e[t]=r,e},{});F.Syntax=SyntaxError,F.Type=TypeError,F.Range=RangeError;var Mr=Tt.reduce(function(e,t){return e[t+"Error"]=F[t],e},{}),Qt=we.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=F[t]),e},{});function Z(){}function xt(e){return e}function fo(e,t){return e==null||e===xt?t:function(n){return t(e(n))}}function Je(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function po(e,t){return e===Z?t:function(){var n=e.apply(this,arguments);n!==void 0&&(arguments[0]=n);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var a=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?Je(r,this.onsuccess):r),i&&(this.onerror=this.onerror?Je(i,this.onerror):i),a!==void 0?a:n}}function ho(e,t){return e===Z?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?Je(n,this.onsuccess):n),r&&(this.onerror=this.onerror?Je(r,this.onerror):r)}}function mo(e,t){return e===Z?t:function(n){var r=e.apply(this,arguments);N(n,r);var i=this.onsuccess,a=this.onerror;return this.onsuccess=null,this.onerror=null,n=t.apply(this,arguments),i&&(this.onsuccess=this.onsuccess?Je(i,this.onsuccess):i),a&&(this.onerror=this.onerror?Je(a,this.onerror):a),r===void 0?n===void 0?void 0:n:N(r,n)}}function yo(e,t){return e===Z?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function On(e,t){return e===Z?t:function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){for(var r=this,i=arguments.length,a=new Array(i);i--;)a[i]=arguments[i];return n.then(function(){return t.apply(r,a)})}return t.apply(this,arguments)}}Qt.ModifyError=Yt,Qt.DexieError=dt,Qt.BulkError=ft;var Ee=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Nr(e){Ee=e}var At={},Rr=100,Xe=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,z(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,z(t),e]}(),Tt=Xe[0],we=Xe[1],Xe=Xe[2],we=we&&we.then,Ze=Tt&&Tt.constructor,Dn=!!Xe,Bt=function(e,t){Ct.push([e,t]),Jt&&(queueMicrotask(go),Jt=!1)},Kn=!0,Jt=!0,et=[],Xt=[],Mn=xt,Ke={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Z,pgp:!1,env:{},finalize:Z},j=Ke,Ct=[],tt=0,Zt=[];function R(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var t=this._PSD=j;if(typeof e!="function"){if(e!==At)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Rn(this,this._value))}this._state=null,this._value=null,++t.ref,function n(r,i){try{i(function(a){if(r._state===null){if(a===r)throw new TypeError("A promise cannot be resolved with itself.");var c=r._lib&&pt();a&&typeof a.then=="function"?n(r,function(d,p){a instanceof R?a._then(d,p):a.then(d,p)}):(r._state=!0,r._value=a,jr(r)),c&&ht()}},Rn.bind(null,r))}catch(a){Rn(r,a)}}(this,e)}var Nn={get:function(){var e=j,t=rn;function n(r,i){var a=this,c=!e.global&&(e!==j||t!==rn),d=c&&!Ne(),p=new R(function(m,g){qn(a,new qr(zr(r,e,c,d),zr(i,e,c,d),m,g,e))});return this._consoleTask&&(p._consoleTask=this._consoleTask),p}return n.prototype=At,n},set:function(e){he(this,"then",e&&e.prototype===At?Nn:{get:function(){return e},set:Nn.set})}};function qr(e,t,n,r,i){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=n,this.reject=r,this.psd=i}function Rn(e,t){var n,r;Xt.push(t),e._state===null&&(n=e._lib&&pt(),t=Mn(t),e._state=!1,e._value=t,r=e,et.some(function(i){return i._value===r._value})||et.push(r),jr(e),n&&ht())}function jr(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)qn(e,t[n]);var i=e._PSD;--i.ref||i.finalize(),tt===0&&(++tt,Bt(function(){--tt==0&&jn()},[]))}function qn(e,t){if(e._state!==null){var n=e._state?t.onFulfilled:t.onRejected;if(n===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++tt,Bt(vo,[n,e,t])}else e._listeners.push(t)}function vo(e,t,n){try{var r,i=t._value;!t._state&&Xt.length&&(Xt=[]),r=Ee&&t._consoleTask?t._consoleTask.run(function(){return e(i)}):e(i),t._state||Xt.indexOf(i)!==-1||function(a){for(var c=et.length;c;)if(et[--c]._value===a._value)return et.splice(c,1)}(t),n.resolve(r)}catch(a){n.reject(a)}finally{--tt==0&&jn(),--n.psd.ref||n.psd.finalize()}}function go(){nt(Ke,function(){pt()&&ht()})}function pt(){var e=Kn;return Jt=Kn=!1,e}function ht(){var e,t,n;do for(;0<Ct.length;)for(e=Ct,Ct=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}while(0<Ct.length);Jt=Kn=!0}function jn(){var e=et;et=[],e.forEach(function(r){r._PSD.onunhandled.call(null,r._value,r)});for(var t=Zt.slice(0),n=t.length;n;)t[--n]()}function en(e){return new R(At,!1,e)}function ne(e,t){var n=j;return function(){var r=pt(),i=j;try{return Re(n,!0),e.apply(this,arguments)}catch(a){t&&t(a)}finally{Re(i,!1),r&&ht()}}}oe(R.prototype,{then:Nn,_then:function(e,t){qn(this,new qr(null,null,e,t,j))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=e,n=arguments[1];return typeof t=="function"?this.then(null,function(r){return(r instanceof t?n:en)(r)}):this.then(null,function(r){return(r&&r.name===t?n:en)(r)})},finally:function(e){return this.then(function(t){return R.resolve(e()).then(function(){return t})},function(t){return R.resolve(e()).then(function(){return en(t)})})},timeout:function(e,t){var n=this;return e<1/0?new R(function(r,i){var a=setTimeout(function(){return i(new F.Timeout(t))},e);n.then(r,i).finally(clearTimeout.bind(null,a))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&he(R.prototype,Symbol.toStringTag,"Dexie.Promise"),Ke.env=Fr(),oe(R,{all:function(){var e=Ce.apply(null,arguments).map(on);return new R(function(t,n){e.length===0&&t([]);var r=e.length;e.forEach(function(i,a){return R.resolve(i).then(function(c){e[a]=c,--r||t(e)},n)})})},resolve:function(e){return e instanceof R?e:e&&typeof e.then=="function"?new R(function(t,n){e.then(t,n)}):new R(At,!0,e)},reject:en,race:function(){var e=Ce.apply(null,arguments).map(on);return new R(function(t,n){e.map(function(r){return R.resolve(r).then(t,n)})})},PSD:{get:function(){return j},set:function(e){return j=e}},totalEchoes:{get:function(){return rn}},newPSD:Me,usePSD:nt,scheduler:{get:function(){return Bt},set:function(e){Bt=e}},rejectionMapper:{get:function(){return Mn},set:function(e){Mn=e}},follow:function(e,t){return new R(function(n,r){return Me(function(i,a){var c=j;c.unhandleds=[],c.onunhandled=a,c.finalize=Je(function(){var d,p=this;d=function(){p.unhandleds.length===0?i():a(p.unhandleds[0])},Zt.push(function m(){d(),Zt.splice(Zt.indexOf(m),1)}),++tt,Bt(function(){--tt==0&&jn()},[])},c.finalize),e()},t,n,r)})}}),Ze&&(Ze.allSettled&&he(R,"allSettled",function(){var e=Ce.apply(null,arguments).map(on);return new R(function(t){e.length===0&&t([]);var n=e.length,r=new Array(n);e.forEach(function(i,a){return R.resolve(i).then(function(c){return r[a]={status:"fulfilled",value:c}},function(c){return r[a]={status:"rejected",reason:c}}).then(function(){return--n||t(r)})})})}),Ze.any&&typeof AggregateError<"u"&&he(R,"any",function(){var e=Ce.apply(null,arguments).map(on);return new R(function(t,n){e.length===0&&n(new AggregateError([]));var r=e.length,i=new Array(r);e.forEach(function(a,c){return R.resolve(a).then(function(d){return t(d)},function(d){i[c]=d,--r||n(new AggregateError(i))})})})}),Ze.withResolvers&&(R.withResolvers=Ze.withResolvers));var ae={awaits:0,echoes:0,id:0},bo=0,tn=[],nn=0,rn=0,wo=0;function Me(e,t,n,r){var i=j,a=Object.create(i);return a.parent=i,a.ref=0,a.global=!1,a.id=++wo,Ke.env,a.env=Dn?{Promise:R,PromiseProp:{value:R,configurable:!0,writable:!0},all:R.all,race:R.race,allSettled:R.allSettled,any:R.any,resolve:R.resolve,reject:R.reject}:{},t&&N(a,t),++i.ref,a.finalize=function(){--this.parent.ref||this.parent.finalize()},r=nt(a,e,n,r),a.ref===0&&a.finalize(),r}function mt(){return ae.id||(ae.id=++bo),++ae.awaits,ae.echoes+=Rr,ae.id}function Ne(){return!!ae.awaits&&(--ae.awaits==0&&(ae.id=0),ae.echoes=ae.awaits*Rr,!0)}function on(e){return ae.echoes&&e&&e.constructor===Ze?(mt(),e.then(function(t){return Ne(),t},function(t){return Ne(),re(t)})):e}function ko(){var e=tn[tn.length-1];tn.pop(),Re(e,!1)}function Re(e,t){var n,r=j;(t?!ae.echoes||nn++&&e===j:!nn||--nn&&e===j)||queueMicrotask(t?(function(i){++rn,ae.echoes&&--ae.echoes!=0||(ae.echoes=ae.awaits=ae.id=0),tn.push(j),Re(i,!0)}).bind(null,e):ko),e!==j&&(j=e,r===Ke&&(Ke.env=Fr()),Dn&&(n=Ke.env.Promise,t=e.env,(r.global||e.global)&&(Object.defineProperty(S,"Promise",t.PromiseProp),n.all=t.all,n.race=t.race,n.resolve=t.resolve,n.reject=t.reject,t.allSettled&&(n.allSettled=t.allSettled),t.any&&(n.any=t.any))))}function Fr(){var e=S.Promise;return Dn?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(S,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject}:{}}function nt(e,t,n,r,i){var a=j;try{return Re(e,!0),t(n,r,i)}finally{Re(a,!1)}}function zr(e,t,n,r){return typeof e!="function"?e:function(){var i=j;n&&mt(),Re(t,!0);try{return e.apply(this,arguments)}finally{Re(i,!1),r&&queueMicrotask(Ne)}}}function Fn(e){Promise===Ze&&ae.echoes===0?nn===0?e():enqueueNativeMicroTask(e):setTimeout(e,0)}(""+we).indexOf("[native code]")===-1&&(mt=Ne=Z);var re=R.reject,rt="￿",Le="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",$r="String expected.",yt=[],an="__dbnames",zn="readonly",$n="readwrite";function it(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var Hr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function sn(e){return typeof e!="string"||/\./.test(e)?function(t){return t}:function(t){return t[e]===void 0&&e in t&&delete(t=Ye(t))[e],t}}function Vr(){throw F.Type()}function Q(e,t){try{var n=Ur(e),r=Ur(t);if(n!==r)return n==="Array"?1:r==="Array"?-1:n==="binary"?1:r==="binary"?-1:n==="string"?1:r==="string"?-1:n==="Date"?1:r!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return t<e?1:e<t?-1:0;case"binary":return function(i,a){for(var c=i.length,d=a.length,p=c<d?c:d,m=0;m<p;++m)if(i[m]!==a[m])return i[m]<a[m]?-1:1;return c===d?0:c<d?-1:1}(Wr(e),Wr(t));case"Array":return function(i,a){for(var c=i.length,d=a.length,p=c<d?c:d,m=0;m<p;++m){var g=Q(i[m],a[m]);if(g!==0)return g}return c===d?0:c<d?-1:1}(e,t)}}catch{}return NaN}function Ur(e){var t=typeof e;return t!="object"?t:ArrayBuffer.isView(e)?"binary":(e=Bn(e),e==="ArrayBuffer"?"binary":e)}function Wr(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var Gr=(te.prototype._trans=function(e,t,n){var r=this._tx||j.trans,i=this.name,a=Ee&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(e==="readonly"?"read":"write"," ").concat(this.name));function c(m,g,f){if(!f.schema[i])throw new F.NotFound("Table "+i+" not part of transaction");return t(f.idbtrans,f)}var d=pt();try{var p=r&&r.db._novip===this.db._novip?r===j.trans?r._promise(e,c,n):Me(function(){return r._promise(e,c,n)},{trans:r,transless:j.transless||j}):function m(g,f,k,h){if(g.idbdb&&(g._state.openComplete||j.letThrough||g._vip)){var v=g._createTransaction(f,k,g._dbSchema);try{v.create(),g._state.PR1398_maxLoop=3}catch(w){return w.name===Pn.InvalidState&&g.isOpen()&&0<--g._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),g.close({disableAutoOpen:!1}),g.open().then(function(){return m(g,f,k,h)})):re(w)}return v._promise(f,function(w,y){return Me(function(){return j.trans=v,h(w,y,v)})}).then(function(w){if(f==="readwrite")try{v.idbtrans.commit()}catch{}return f==="readonly"?w:v._completion.then(function(){return w})})}if(g._state.openComplete)return re(new F.DatabaseClosed(g._state.dbOpenError));if(!g._state.isBeingOpened){if(!g._state.autoOpen)return re(new F.DatabaseClosed);g.open().catch(Z)}return g._state.dbReadyPromise.then(function(){return m(g,f,k,h)})}(this.db,e,[this.name],c);return a&&(p._consoleTask=a,p=p.catch(function(m){return console.trace(m),re(m)})),p}finally{d&&ht()}},te.prototype.get=function(e,t){var n=this;return e&&e.constructor===Object?this.where(e).first(t):e==null?re(new F.Type("Invalid argument to Table.get()")):this._trans("readonly",function(r){return n.core.get({trans:r,key:e}).then(function(i){return n.hook.reading.fire(i)})}).then(t)},te.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(B(e))return new this.db.WhereClause(this,"[".concat(e.join("+"),"]"));var t=x(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var n=this.schema.indexes.concat(this.schema.primKey).filter(function(d){if(d.compound&&t.every(function(m){return 0<=d.keyPath.indexOf(m)})){for(var p=0;p<t.length;++p)if(t.indexOf(d.keyPath[p])===-1)return!1;return!0}return!1}).sort(function(d,p){return d.keyPath.length-p.keyPath.length})[0];if(n&&this.db._maxKey!==rt){var a=n.keyPath.slice(0,t.length);return this.where(a).equals(a.map(function(p){return e[p]}))}!n&&Ee&&console.warn("The query ".concat(JSON.stringify(e)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(t.join("+"),"]"));var r=this.schema.idxByName;function i(d,p){return Q(d,p)===0}var c=t.reduce(function(f,p){var m=f[0],g=f[1],f=r[p],k=e[p];return[m||f,m||!f?it(g,f&&f.multi?function(h){return h=Be(h,p),B(h)&&h.some(function(v){return i(k,v)})}:function(h){return i(k,Be(h,p))}):g]},[null,null]),a=c[0],c=c[1];return a?this.where(a.name).equals(e[a.keyPath]).filter(c):n?this.filter(c):this.where(t).equals("")},te.prototype.filter=function(e){return this.toCollection().and(e)},te.prototype.count=function(e){return this.toCollection().count(e)},te.prototype.offset=function(e){return this.toCollection().offset(e)},te.prototype.limit=function(e){return this.toCollection().limit(e)},te.prototype.each=function(e){return this.toCollection().each(e)},te.prototype.toArray=function(e){return this.toCollection().toArray(e)},te.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},te.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,B(e)?"[".concat(e.join("+"),"]"):e))},te.prototype.reverse=function(){return this.toCollection().reverse()},te.prototype.mapToClass=function(e){var t,n=this.db,r=this.name;function i(){return t!==null&&t.apply(this,arguments)||this}(this.schema.mappedClass=e).prototype instanceof Vr&&(function(p,m){if(typeof m!="function"&&m!==null)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");function g(){this.constructor=p}u(p,m),p.prototype=m===null?Object.create(m):(g.prototype=m.prototype,new g)}(i,t=e),Object.defineProperty(i.prototype,"db",{get:function(){return n},enumerable:!1,configurable:!0}),i.prototype.table=function(){return r},e=i);for(var a=new Set,c=e.prototype;c;c=z(c))Object.getOwnPropertyNames(c).forEach(function(p){return a.add(p)});function d(p){if(!p)return p;var m,g=Object.create(e.prototype);for(m in p)if(!a.has(m))try{g[m]=p[m]}catch{}return g}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=d,this.hook("reading",d),e},te.prototype.defineClass=function(){return this.mapToClass(function(e){N(this,e)})},te.prototype.add=function(e,t){var n=this,r=this.schema.primKey,i=r.auto,a=r.keyPath,c=e;return a&&i&&(c=sn(a)(e)),this._trans("readwrite",function(d){return n.core.mutate({trans:d,type:"add",keys:t!=null?[t]:null,values:[c]})}).then(function(d){return d.numFailures?R.reject(d.failures[0]):d.lastResult}).then(function(d){if(a)try{ve(e,a,d)}catch{}return d})},te.prototype.update=function(e,t){return typeof e!="object"||B(e)?this.where(":id").equals(e).modify(t):(e=Be(e,this.schema.primKey.keyPath),e===void 0?re(new F.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(e).modify(t))},te.prototype.put=function(e,t){var n=this,r=this.schema.primKey,i=r.auto,a=r.keyPath,c=e;return a&&i&&(c=sn(a)(e)),this._trans("readwrite",function(d){return n.core.mutate({trans:d,type:"put",values:[c],keys:t!=null?[t]:null})}).then(function(d){return d.numFailures?R.reject(d.failures[0]):d.lastResult}).then(function(d){if(a)try{ve(e,a,d)}catch{}return d})},te.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(n){return t.core.mutate({trans:n,type:"delete",keys:[e]})}).then(function(n){return n.numFailures?R.reject(n.failures[0]):void 0})},te.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:Hr})}).then(function(t){return t.numFailures?R.reject(t.failures[0]):void 0})},te.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(n){return t.core.getMany({keys:e,trans:n}).then(function(r){return r.map(function(i){return t.hook.reading.fire(i)})})})},te.prototype.bulkAdd=function(e,t,n){var r=this,i=Array.isArray(t)?t:void 0,a=(n=n||(i?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",function(c){var m=r.schema.primKey,d=m.auto,m=m.keyPath;if(m&&i)throw new F.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new F.InvalidArgument("Arguments objects and keys must have the same length");var p=e.length,m=m&&d?e.map(sn(m)):e;return r.core.mutate({trans:c,type:"add",keys:i,values:m,wantResults:a}).then(function(v){var f=v.numFailures,k=v.results,h=v.lastResult,v=v.failures;if(f===0)return a?k:h;throw new ft("".concat(r.name,".bulkAdd(): ").concat(f," of ").concat(p," operations failed"),v)})})},te.prototype.bulkPut=function(e,t,n){var r=this,i=Array.isArray(t)?t:void 0,a=(n=n||(i?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",function(c){var m=r.schema.primKey,d=m.auto,m=m.keyPath;if(m&&i)throw new F.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new F.InvalidArgument("Arguments objects and keys must have the same length");var p=e.length,m=m&&d?e.map(sn(m)):e;return r.core.mutate({trans:c,type:"put",keys:i,values:m,wantResults:a}).then(function(v){var f=v.numFailures,k=v.results,h=v.lastResult,v=v.failures;if(f===0)return a?k:h;throw new ft("".concat(r.name,".bulkPut(): ").concat(f," of ").concat(p," operations failed"),v)})})},te.prototype.bulkUpdate=function(e){var t=this,n=this.core,r=e.map(function(c){return c.key}),i=e.map(function(c){return c.changes}),a=[];return this._trans("readwrite",function(c){return n.getMany({trans:c,keys:r,cache:"clone"}).then(function(d){var p=[],m=[];e.forEach(function(f,k){var h=f.key,v=f.changes,w=d[k];if(w){for(var y=0,_=Object.keys(v);y<_.length;y++){var E=_[y],I=v[E];if(E===t.schema.primKey.keyPath){if(Q(I,h)!==0)throw new F.Constraint("Cannot update primary key in bulkUpdate()")}else ve(w,E,I)}a.push(k),p.push(h),m.push(w)}});var g=p.length;return n.mutate({trans:c,type:"put",keys:p,values:m,updates:{keys:r,changeSpecs:i}}).then(function(f){var k=f.numFailures,h=f.failures;if(k===0)return g;for(var v=0,w=Object.keys(h);v<w.length;v++){var y,_=w[v],E=a[Number(_)];E!=null&&(y=h[_],delete h[_],h[E]=y)}throw new ft("".concat(t.name,".bulkUpdate(): ").concat(k," of ").concat(g," operations failed"),h)})})})},te.prototype.bulkDelete=function(e){var t=this,n=e.length;return this._trans("readwrite",function(r){return t.core.mutate({trans:r,type:"delete",keys:e})}).then(function(c){var i=c.numFailures,a=c.lastResult,c=c.failures;if(i===0)return a;throw new ft("".concat(t.name,".bulkDelete(): ").concat(i," of ").concat(n," operations failed"),c)})},te);function te(){}function Lt(e){function t(c,d){if(d){for(var p=arguments.length,m=new Array(p-1);--p;)m[p-1]=arguments[p];return n[c].subscribe.apply(null,m),e}if(typeof c=="string")return n[c]}var n={};t.addEventType=a;for(var r=1,i=arguments.length;r<i;++r)a(arguments[r]);return t;function a(c,d,p){if(typeof c!="object"){var m;d=d||yo;var g={subscribers:[],fire:p=p||Z,subscribe:function(f){g.subscribers.indexOf(f)===-1&&(g.subscribers.push(f),g.fire=d(g.fire,f))},unsubscribe:function(f){g.subscribers=g.subscribers.filter(function(k){return k!==f}),g.fire=g.subscribers.reduce(d,p)}};return n[c]=t[c]=g}x(m=c).forEach(function(f){var k=m[f];if(B(k))a(f,m[f][0],m[f][1]);else{if(k!=="asap")throw new F.InvalidArgument("Invalid event config");var h=a(f,xt,function(){for(var v=arguments.length,w=new Array(v);v--;)w[v]=arguments[v];h.subscribers.forEach(function(y){Et(function(){y.apply(null,w)})})})}})}}function Pt(e,t){return me(t).from({prototype:e}),t}function vt(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Hn(e,t){e.filter=it(e.filter,t)}function Vn(e,t,n){var r=e.replayFilter;e.replayFilter=r?function(){return it(r(),t())}:t,e.justLimit=n&&!r}function cn(e,t){if(e.isPrimKey)return t.primaryKey;var n=t.getIndexByKeyPath(e.index);if(!n)throw new F.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return n}function Yr(e,t,n){var r=cn(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:r,range:e.range}})}function un(e,t,n,r){var i=e.replayFilter?it(e.filter,e.replayFilter()):e.filter;if(e.or){var a={},c=function(d,p,m){var g,f;i&&!i(p,m,function(k){return p.stop(k)},function(k){return p.fail(k)})||((f=""+(g=p.primaryKey))=="[object ArrayBuffer]"&&(f=""+new Uint8Array(g)),Y(a,f)||(a[f]=!0,t(d,p,m)))};return Promise.all([e.or._iterate(c,n),Qr(Yr(e,r,n),e.algorithm,c,!e.keysOnly&&e.valueMapper)])}return Qr(Yr(e,r,n),it(e.algorithm,i),t,!e.keysOnly&&e.valueMapper)}function Qr(e,t,n,r){var i=ne(r?function(a,c,d){return n(r(a),c,d)}:n);return e.then(function(a){if(a)return a.start(function(){var c=function(){return a.continue()};t&&!t(a,function(d){return c=d},function(d){a.stop(d),c=Z},function(d){a.fail(d),c=Z})||i(a.value,a,function(d){return c=d}),c()})})}var Ot=(Jr.prototype.execute=function(e){var t=this["@@propmod"];if(t.add!==void 0){var n=t.add;if(B(n))return b(b([],B(e)?e:[],!0),n).sort();if(typeof n=="number")return(Number(e)||0)+n;if(typeof n=="bigint")try{return BigInt(e)+n}catch{return BigInt(0)+n}throw new TypeError("Invalid term ".concat(n))}if(t.remove!==void 0){var r=t.remove;if(B(r))return B(e)?e.filter(function(i){return!r.includes(i)}).sort():[];if(typeof r=="number")return Number(e)-r;if(typeof r=="bigint")try{return BigInt(e)-r}catch{return BigInt(0)-r}throw new TypeError("Invalid subtrahend ".concat(r))}return n=(n=t.replacePrefix)===null||n===void 0?void 0:n[0],n&&typeof e=="string"&&e.startsWith(n)?t.replacePrefix[1]+e.substring(n.length):e},Jr);function Jr(e){this["@@propmod"]=e}var _o=(J.prototype._read=function(e,t){var n=this._ctx;return n.error?n.table._trans(null,re.bind(null,n.error)):n.table._trans("readonly",e).then(t)},J.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,re.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},J.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=it(t.algorithm,e)},J.prototype._iterate=function(e,t){return un(this._ctx,e,t,this._ctx.table.core)},J.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return e&&N(n,e),t._ctx=n,t},J.prototype.raw=function(){return this._ctx.valueMapper=null,this},J.prototype.each=function(e){var t=this._ctx;return this._read(function(n){return un(t,e,n,t.table.core)})},J.prototype.count=function(e){var t=this;return this._read(function(n){var r=t._ctx,i=r.table.core;if(vt(r,!0))return i.count({trans:n,query:{index:cn(r,i.schema),range:r.range}}).then(function(c){return Math.min(c,r.limit)});var a=0;return un(r,function(){return++a,!1},n,i).then(function(){return a})}).then(e)},J.prototype.sortBy=function(e,t){var n=e.split(".").reverse(),r=n[0],i=n.length-1;function a(p,m){return m?a(p[n[m]],m-1):p[r]}var c=this._ctx.dir==="next"?1:-1;function d(p,m){return Q(a(p,i),a(m,i))*c}return this.toArray(function(p){return p.sort(d)}).then(t)},J.prototype.toArray=function(e){var t=this;return this._read(function(n){var r=t._ctx;if(r.dir==="next"&&vt(r,!0)&&0<r.limit){var i=r.valueMapper,a=cn(r,r.table.core.schema);return r.table.core.query({trans:n,limit:r.limit,values:!0,query:{index:a,range:r.range}}).then(function(d){return d=d.result,i?d.map(i):d})}var c=[];return un(r,function(d){return c.push(d)},n,r.table.core).then(function(){return c})},e)},J.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,vt(t)?Vn(t,function(){var n=e;return function(r,i){return n===0||(n===1?--n:i(function(){r.advance(n),n=0}),!1)}}):Vn(t,function(){var n=e;return function(){return--n<0}})),this},J.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Vn(this._ctx,function(){var t=e;return function(n,r,i){return--t<=0&&r(i),0<=t}},!0),this},J.prototype.until=function(e,t){return Hn(this._ctx,function(n,r,i){return!e(n.value)||(r(i),t)}),this},J.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},J.prototype.last=function(e){return this.reverse().first(e)},J.prototype.filter=function(e){var t;return Hn(this._ctx,function(n){return e(n.value)}),(t=this._ctx).isMatch=it(t.isMatch,e),this},J.prototype.and=function(e){return this.filter(e)},J.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},J.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},J.prototype.desc=function(){return this.reverse()},J.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(n,r){e(r.key,r)})},J.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},J.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(n,r){e(r.primaryKey,r)})},J.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var n=[];return this.each(function(r,i){n.push(i.key)}).then(function(){return n}).then(e)},J.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&vt(t,!0)&&0<t.limit)return this._read(function(r){var i=cn(t,t.table.core.schema);return t.table.core.query({trans:r,values:!1,limit:t.limit,query:{index:i,range:t.range}})}).then(function(r){return r.result}).then(e);t.keysOnly=!t.isMatch;var n=[];return this.each(function(r,i){n.push(i.primaryKey)}).then(function(){return n}).then(e)},J.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},J.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},J.prototype.lastKey=function(e){return this.reverse().firstKey(e)},J.prototype.distinct=function(){var e=this._ctx,e=e.index&&e.table.schema.idxByName[e.index];if(!e||!e.multi)return this;var t={};return Hn(this._ctx,function(i){var r=i.primaryKey.toString(),i=Y(t,r);return t[r]=!0,!i}),this},J.prototype.modify=function(e){var t=this,n=this._ctx;return this._write(function(r){var i,a,c;c=typeof e=="function"?e:(i=x(e),a=i.length,function(y){for(var _=!1,E=0;E<a;++E){var I=i[E],A=e[I],C=Be(y,I);A instanceof Ot?(ve(y,I,A.execute(C)),_=!0):C!==A&&(ve(y,I,A),_=!0)}return _});var d=n.table.core,f=d.schema.primaryKey,p=f.outbound,m=f.extractKey,g=200,f=t.db._options.modifyChunkSize;f&&(g=typeof f=="object"?f[d.name]||f["*"]||200:f);function k(y,I){var E=I.failures,I=I.numFailures;v+=y-I;for(var A=0,C=x(E);A<C.length;A++){var D=C[A];h.push(E[D])}}var h=[],v=0,w=[];return t.clone().primaryKeys().then(function(y){function _(I){var A=Math.min(g,y.length-I);return d.getMany({trans:r,keys:y.slice(I,I+A),cache:"immutable"}).then(function(C){for(var D=[],L=[],P=p?[]:null,K=[],O=0;O<A;++O){var q=C[O],H={value:Ye(q),primKey:y[I+O]};c.call(H,H.value,H)!==!1&&(H.value==null?K.push(y[I+O]):p||Q(m(q),m(H.value))===0?(L.push(H.value),p&&P.push(y[I+O])):(K.push(y[I+O]),D.push(H.value)))}return Promise.resolve(0<D.length&&d.mutate({trans:r,type:"add",values:D}).then(function(V){for(var U in V.failures)K.splice(parseInt(U),1);k(D.length,V)})).then(function(){return(0<L.length||E&&typeof e=="object")&&d.mutate({trans:r,type:"put",keys:P,values:L,criteria:E,changeSpec:typeof e!="function"&&e,isAdditionalChunk:0<I}).then(function(V){return k(L.length,V)})}).then(function(){return(0<K.length||E&&e===Un)&&d.mutate({trans:r,type:"delete",keys:K,criteria:E,isAdditionalChunk:0<I}).then(function(V){return k(K.length,V)})}).then(function(){return y.length>I+A&&_(I+g)})})}var E=vt(n)&&n.limit===1/0&&(typeof e!="function"||e===Un)&&{index:n.index,range:n.range};return _(0).then(function(){if(0<h.length)throw new Yt("Error modifying one or more objects",h,v,w);return y.length})})})},J.prototype.delete=function(){var e=this._ctx,t=e.range;return vt(e)&&(e.isPrimKey||t.type===3)?this._write(function(n){var r=e.table.core.schema.primaryKey,i=t;return e.table.core.count({trans:n,query:{index:r,range:i}}).then(function(a){return e.table.core.mutate({trans:n,type:"deleteRange",range:i}).then(function(c){var d=c.failures;if(c.lastResult,c.results,c=c.numFailures,c)throw new Yt("Could not delete some values",Object.keys(d).map(function(p){return d[p]}),a-c);return a-c})})}):this.modify(Un)},J);function J(){}var Un=function(e,t){return t.value=null};function So(e,t){return e<t?-1:e===t?0:1}function Eo(e,t){return t<e?-1:e===t?0:1}function ge(e,t,n){return e=e instanceof Zr?new e.Collection(e):e,e._ctx.error=new(n||TypeError)(t),e}function gt(e){return new e.Collection(e,function(){return Xr("")}).limit(0)}function ln(e,t,n,r){var i,a,c,d,p,m,g,f=n.length;if(!n.every(function(v){return typeof v=="string"}))return ge(e,$r);function k(v){i=v==="next"?function(y){return y.toUpperCase()}:function(y){return y.toLowerCase()},a=v==="next"?function(y){return y.toLowerCase()}:function(y){return y.toUpperCase()},c=v==="next"?So:Eo;var w=n.map(function(y){return{lower:a(y),upper:i(y)}}).sort(function(y,_){return c(y.lower,_.lower)});d=w.map(function(y){return y.upper}),p=w.map(function(y){return y.lower}),g=(m=v)==="next"?"":r}k("next"),e=new e.Collection(e,function(){return qe(d[0],p[f-1]+r)}),e._ondirectionchange=function(v){k(v)};var h=0;return e._addAlgorithm(function(v,w,y){var _=v.key;if(typeof _!="string")return!1;var E=a(_);if(t(E,p,h))return!0;for(var I=null,A=h;A<f;++A){var C=function(D,L,P,K,O,q){for(var H=Math.min(D.length,K.length),V=-1,U=0;U<H;++U){var be=L[U];if(be!==K[U])return O(D[U],P[U])<0?D.substr(0,U)+P[U]+P.substr(U+1):O(D[U],K[U])<0?D.substr(0,U)+K[U]+P.substr(U+1):0<=V?D.substr(0,V)+L[V]+P.substr(V+1):null;O(D[U],be)<0&&(V=U)}return H<K.length&&q==="next"?D+P.substr(D.length):H<D.length&&q==="prev"?D.substr(0,P.length):V<0?null:D.substr(0,V)+K[V]+P.substr(V+1)}(_,E,d[A],p[A],c,m);C===null&&I===null?h=A+1:(I===null||0<c(I,C))&&(I=C)}return w(I!==null?function(){v.continue(I+g)}:y),!1}),e}function qe(e,t,n,r){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:r}}function Xr(e){return{type:1,lower:e,upper:e}}var Zr=(Object.defineProperty(se.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),se.prototype.between=function(e,t,n,r){n=n!==!1,r=r===!0;try{return 0<this._cmp(e,t)||this._cmp(e,t)===0&&(n||r)&&(!n||!r)?gt(this):new this.Collection(this,function(){return qe(e,t,!n,!r)})}catch{return ge(this,Le)}},se.prototype.equals=function(e){return e==null?ge(this,Le):new this.Collection(this,function(){return Xr(e)})},se.prototype.above=function(e){return e==null?ge(this,Le):new this.Collection(this,function(){return qe(e,void 0,!0)})},se.prototype.aboveOrEqual=function(e){return e==null?ge(this,Le):new this.Collection(this,function(){return qe(e,void 0,!1)})},se.prototype.below=function(e){return e==null?ge(this,Le):new this.Collection(this,function(){return qe(void 0,e,!1,!0)})},se.prototype.belowOrEqual=function(e){return e==null?ge(this,Le):new this.Collection(this,function(){return qe(void 0,e)})},se.prototype.startsWith=function(e){return typeof e!="string"?ge(this,$r):this.between(e,e+rt,!0,!0)},se.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):ln(this,function(t,n){return t.indexOf(n[0])===0},[e],rt)},se.prototype.equalsIgnoreCase=function(e){return ln(this,function(t,n){return t===n[0]},[e],"")},se.prototype.anyOfIgnoreCase=function(){var e=Ce.apply(lt,arguments);return e.length===0?gt(this):ln(this,function(t,n){return n.indexOf(t)!==-1},e,"")},se.prototype.startsWithAnyOfIgnoreCase=function(){var e=Ce.apply(lt,arguments);return e.length===0?gt(this):ln(this,function(t,n){return n.some(function(r){return t.indexOf(r)===0})},e,rt)},se.prototype.anyOf=function(){var e=this,t=Ce.apply(lt,arguments),n=this._cmp;try{t.sort(n)}catch{return ge(this,Le)}if(t.length===0)return gt(this);var r=new this.Collection(this,function(){return qe(t[0],t[t.length-1])});r._ondirectionchange=function(a){n=a==="next"?e._ascending:e._descending,t.sort(n)};var i=0;return r._addAlgorithm(function(a,c,d){for(var p=a.key;0<n(p,t[i]);)if(++i===t.length)return c(d),!1;return n(p,t[i])===0||(c(function(){a.continue(t[i])}),!1)}),r},se.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},se.prototype.noneOf=function(){var e=Ce.apply(lt,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return ge(this,Le)}var t=e.reduce(function(n,r){return n?n.concat([[n[n.length-1][1],r]]):[[-1/0,r]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},se.prototype.inAnyRange=function(_,t){var n=this,r=this._cmp,i=this._ascending,a=this._descending,c=this._min,d=this._max;if(_.length===0)return gt(this);if(!_.every(function(E){return E[0]!==void 0&&E[1]!==void 0&&i(E[0],E[1])<=0}))return ge(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",F.InvalidArgument);var p=!t||t.includeLowers!==!1,m=t&&t.includeUppers===!0,g,f=i;function k(E,I){return f(E[0],I[0])}try{(g=_.reduce(function(E,I){for(var A=0,C=E.length;A<C;++A){var D=E[A];if(r(I[0],D[1])<0&&0<r(I[1],D[0])){D[0]=c(D[0],I[0]),D[1]=d(D[1],I[1]);break}}return A===C&&E.push(I),E},[])).sort(k)}catch{return ge(this,Le)}var h=0,v=m?function(E){return 0<i(E,g[h][1])}:function(E){return 0<=i(E,g[h][1])},w=p?function(E){return 0<a(E,g[h][0])}:function(E){return 0<=a(E,g[h][0])},y=v,_=new this.Collection(this,function(){return qe(g[0][0],g[g.length-1][1],!p,!m)});return _._ondirectionchange=function(E){f=E==="next"?(y=v,i):(y=w,a),g.sort(k)},_._addAlgorithm(function(E,I,A){for(var C,D=E.key;y(D);)if(++h===g.length)return I(A),!1;return!v(C=D)&&!w(C)||(n._cmp(D,g[h][1])===0||n._cmp(D,g[h][0])===0||I(function(){f===i?E.continue(g[h][0]):E.continue(g[h][1])}),!1)}),_},se.prototype.startsWithAnyOf=function(){var e=Ce.apply(lt,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?gt(this):this.inAnyRange(e.map(function(t){return[t,t+rt]})):ge(this,"startsWithAnyOf() only works with strings")},se);function se(){}function Ie(e){return ne(function(t){return Dt(t),e(t.target.error),!1})}function Dt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var Kt="storagemutated",Wn="x-storagemutated-1",je=Lt(null,Kt),Io=(xe.prototype._lock=function(){return Te(!j.global),++this._reculock,this._reculock!==1||j.global||(j.lockOwnerFor=this),this},xe.prototype._unlock=function(){if(Te(!j.global),--this._reculock==0)for(j.global||(j.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var e=this._blockedFuncs.shift();try{nt(e[1],e[0])}catch{}}return this},xe.prototype._locked=function(){return this._reculock&&j.lockOwnerFor!==this},xe.prototype.create=function(e){var t=this;if(!this.mode)return this;var n=this.db.idbdb,r=this.db._state.dbOpenError;if(Te(!this.idbtrans),!e&&!n)switch(r&&r.name){case"DatabaseClosedError":throw new F.DatabaseClosed(r);case"MissingAPIError":throw new F.MissingAPI(r.message,r);default:throw new F.OpenFailed(r)}if(!this.active)throw new F.TransactionInactive;return Te(this._completion._state===null),(e=this.idbtrans=e||(this.db.core||n).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=ne(function(i){Dt(i),t._reject(e.error)}),e.onabort=ne(function(i){Dt(i),t.active&&t._reject(new F.Abort(e.error)),t.active=!1,t.on("abort").fire(i)}),e.oncomplete=ne(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&je.storagemutated.fire(e.mutatedParts)}),this},xe.prototype._promise=function(e,t,n){var r=this;if(e==="readwrite"&&this.mode!=="readwrite")return re(new F.ReadOnly("Transaction is readonly"));if(!this.active)return re(new F.TransactionInactive);if(this._locked())return new R(function(a,c){r._blockedFuncs.push([function(){r._promise(e,t,n).then(a,c)},j])});if(n)return Me(function(){var a=new R(function(c,d){r._lock();var p=t(c,d,r);p&&p.then&&p.then(c,d)});return a.finally(function(){return r._unlock()}),a._lib=!0,a});var i=new R(function(a,c){var d=t(a,c,r);d&&d.then&&d.then(a,c)});return i._lib=!0,i},xe.prototype._root=function(){return this.parent?this.parent._root():this},xe.prototype.waitFor=function(e){var t,n=this._root(),r=R.resolve(e);n._waitingFor?n._waitingFor=n._waitingFor.then(function(){return r}):(n._waitingFor=r,n._waitingQueue=[],t=n.idbtrans.objectStore(n.storeNames[0]),function a(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(t.get(-1/0).onsuccess=a)}());var i=n._waitingFor;return new R(function(a,c){r.then(function(d){return n._waitingQueue.push(ne(a.bind(null,d)))},function(d){return n._waitingQueue.push(ne(c.bind(null,d)))}).finally(function(){n._waitingFor===i&&(n._waitingFor=null)})})},xe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new F.Abort))},xe.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(Y(t,e))return t[e];var n=this.schema[e];if(!n)throw new F.NotFound("Table "+e+" not part of transaction");return n=new this.db.Table(e,n,this),n.core=this.db.core.table(e),t[e]=n},xe);function xe(){}function Gn(e,t,n,r,i,a,c){return{name:e,keyPath:t,unique:n,multi:r,auto:i,compound:a,src:(n&&!c?"&":"")+(r?"*":"")+(i?"++":"")+ei(t)}}function ei(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Yn(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:(r=function(i){return[i.name,i]},n.reduce(function(i,a,c){return c=r(a,c),c&&(i[c[0]]=c[1]),i},{}))};var r}var Mt=function(e){try{return e.only([[]]),Mt=function(){return[[]]},[[]]}catch{return Mt=function(){return rt},rt}};function Qn(e){return e==null?function(){}:typeof e=="string"?(t=e).split(".").length===1?function(n){return n[t]}:function(n){return Be(n,t)}:function(n){return Be(n,e)};var t}function ti(e){return[].slice.call(e)}var xo=0;function Nt(e){return e==null?":id":typeof e=="string"?e:"[".concat(e.join("+"),"]")}function Ao(e,t,p){function r(y){if(y.type===3)return null;if(y.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var h=y.lower,v=y.upper,w=y.lowerOpen,y=y.upperOpen;return h===void 0?v===void 0?null:t.upperBound(v,!!y):v===void 0?t.lowerBound(h,!!w):t.bound(h,v,!!w,!!y)}function i(k){var h,v=k.name;return{name:v,schema:k,mutate:function(w){var y=w.trans,_=w.type,E=w.keys,I=w.values,A=w.range;return new Promise(function(C,D){C=ne(C);var L=y.objectStore(v),P=L.keyPath==null,K=_==="put"||_==="add";if(!K&&_!=="delete"&&_!=="deleteRange")throw new Error("Invalid operation type: "+_);var O,q=(E||I||{length:1}).length;if(E&&I&&E.length!==I.length)throw new Error("Given keys array must have same length as given values array.");if(q===0)return C({numFailures:0,failures:{},results:[],lastResult:void 0});function H(fe){++be,Dt(fe)}var V=[],U=[],be=0;if(_==="deleteRange"){if(A.type===4)return C({numFailures:be,failures:U,results:[],lastResult:void 0});A.type===3?V.push(O=L.clear()):V.push(O=L.delete(r(A)))}else{var P=K?P?[I,E]:[I,null]:[E,null],$=P[0],le=P[1];if(K)for(var de=0;de<q;++de)V.push(O=le&&le[de]!==void 0?L[_]($[de],le[de]):L[_]($[de])),O.onerror=H;else for(de=0;de<q;++de)V.push(O=L[_]($[de])),O.onerror=H}function Sn(fe){fe=fe.target.result,V.forEach(function(st,hr){return st.error!=null&&(U[hr]=st.error)}),C({numFailures:be,failures:U,results:_==="delete"?E:V.map(function(st){return st.result}),lastResult:fe})}O.onerror=function(fe){H(fe),Sn(fe)},O.onsuccess=Sn})},getMany:function(w){var y=w.trans,_=w.keys;return new Promise(function(E,I){E=ne(E);for(var A,C=y.objectStore(v),D=_.length,L=new Array(D),P=0,K=0,O=function(V){V=V.target,L[V._pos]=V.result,++K===P&&E(L)},q=Ie(I),H=0;H<D;++H)_[H]!=null&&((A=C.get(_[H]))._pos=H,A.onsuccess=O,A.onerror=q,++P);P===0&&E(L)})},get:function(w){var y=w.trans,_=w.key;return new Promise(function(E,I){E=ne(E);var A=y.objectStore(v).get(_);A.onsuccess=function(C){return E(C.target.result)},A.onerror=Ie(I)})},query:(h=m,function(w){return new Promise(function(y,_){y=ne(y);var E,I,A,P=w.trans,C=w.values,D=w.limit,O=w.query,L=D===1/0?void 0:D,K=O.index,O=O.range,P=P.objectStore(v),K=K.isPrimaryKey?P:P.index(K.name),O=r(O);if(D===0)return y({result:[]});h?((L=C?K.getAll(O,L):K.getAllKeys(O,L)).onsuccess=function(q){return y({result:q.target.result})},L.onerror=Ie(_)):(E=0,I=!C&&"openKeyCursor"in K?K.openKeyCursor(O):K.openCursor(O),A=[],I.onsuccess=function(q){var H=I.result;return H?(A.push(C?H.value:H.primaryKey),++E===D?y({result:A}):void H.continue()):y({result:A})},I.onerror=Ie(_))})}),openCursor:function(w){var y=w.trans,_=w.values,E=w.query,I=w.reverse,A=w.unique;return new Promise(function(C,D){C=ne(C);var K=E.index,L=E.range,P=y.objectStore(v),P=K.isPrimaryKey?P:P.index(K.name),K=I?A?"prevunique":"prev":A?"nextunique":"next",O=!_&&"openKeyCursor"in P?P.openKeyCursor(r(L),K):P.openCursor(r(L),K);O.onerror=Ie(D),O.onsuccess=ne(function(q){var H,V,U,be,$=O.result;$?($.___id=++xo,$.done=!1,H=$.continue.bind($),V=(V=$.continuePrimaryKey)&&V.bind($),U=$.advance.bind($),be=function(){throw new Error("Cursor not stopped")},$.trans=y,$.stop=$.continue=$.continuePrimaryKey=$.advance=function(){throw new Error("Cursor not started")},$.fail=ne(D),$.next=function(){var le=this,de=1;return this.start(function(){return de--?le.continue():le.stop()}).then(function(){return le})},$.start=function(le){function de(){if(O.result)try{le()}catch(fe){$.fail(fe)}else $.done=!0,$.start=function(){throw new Error("Cursor behind last entry")},$.stop()}var Sn=new Promise(function(fe,st){fe=ne(fe),O.onerror=Ie(st),$.fail=st,$.stop=function(hr){$.stop=$.continue=$.continuePrimaryKey=$.advance=be,fe(hr)}});return O.onsuccess=ne(function(fe){O.onsuccess=de,de()}),$.continue=H,$.continuePrimaryKey=V,$.advance=U,de(),Sn},C($)):C(null)},D)})},count:function(w){var y=w.query,_=w.trans,E=y.index,I=y.range;return new Promise(function(A,C){var D=_.objectStore(v),L=E.isPrimaryKey?D:D.index(E.name),D=r(I),L=D?L.count(D):L.count();L.onsuccess=ne(function(P){return A(P.target.result)}),L.onerror=Ie(C)})}}}var a,c,d,g=(c=p,d=ti((a=e).objectStoreNames),{schema:{name:a.name,tables:d.map(function(k){return c.objectStore(k)}).map(function(k){var h=k.keyPath,y=k.autoIncrement,v=B(h),w={},y={name:k.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:h==null,compound:v,keyPath:h,autoIncrement:y,unique:!0,extractKey:Qn(h)},indexes:ti(k.indexNames).map(function(_){return k.index(_)}).map(function(A){var E=A.name,I=A.unique,C=A.multiEntry,A=A.keyPath,C={name:E,compound:B(A),keyPath:A,unique:I,multiEntry:C,extractKey:Qn(A)};return w[Nt(A)]=C}),getIndexByKeyPath:function(_){return w[Nt(_)]}};return w[":id"]=y.primaryKey,h!=null&&(w[Nt(h)]=y.primaryKey),y})},hasGetAll:0<d.length&&"getAll"in c.objectStore(d[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),p=g.schema,m=g.hasGetAll,g=p.tables.map(i),f={};return g.forEach(function(k){return f[k.name]=k}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(k){if(!f[k])throw new Error("Table '".concat(k,"' not found"));return f[k]},MIN_KEY:-1/0,MAX_KEY:Mt(t),schema:p}}function To(e,t,n,r){var i=n.IDBKeyRange;return n.indexedDB,{dbcore:(r=Ao(t,i,r),e.dbcore.reduce(function(a,c){return c=c.create,l(l({},a),c(a))},r))}}function dn(e,r){var n=r.db,r=To(e._middlewares,n,e._deps,r);e.core=r.dbcore,e.tables.forEach(function(i){var a=i.name;e.core.schema.tables.some(function(c){return c.name===a})&&(i.core=e.core.table(a),e[a]instanceof e.Table&&(e[a].core=i.core))})}function fn(e,t,n,r){n.forEach(function(i){var a=r[i];t.forEach(function(c){var d=function p(m,g){return De(m,g)||(m=z(m))&&p(m,g)}(c,i);(!d||"value"in d&&d.value===void 0)&&(c===e.Transaction.prototype||c instanceof e.Transaction?he(c,i,{get:function(){return this.table(i)},set:function(p){ut(this,i,{value:p,writable:!0,configurable:!0,enumerable:!0})}}):c[i]=new e.Table(i,a))})})}function Jn(e,t){t.forEach(function(n){for(var r in n)n[r]instanceof e.Table&&delete n[r]})}function Bo(e,t){return e._cfg.version-t._cfg.version}function Co(e,t,n,r){var i=e._dbSchema;n.objectStoreNames.contains("$meta")&&!i.$meta&&(i.$meta=Yn("$meta",ri("")[0],[]),e._storeNames.push("$meta"));var a=e._createTransaction("readwrite",e._storeNames,i);a.create(n),a._completion.catch(r);var c=a._reject.bind(a),d=j.transless||j;Me(function(){return j.trans=a,j.transless=d,t!==0?(dn(e,n),m=t,((p=a).storeNames.includes("$meta")?p.table("$meta").get("version").then(function(g){return g??m}):R.resolve(m)).then(function(g){return k=g,h=a,v=n,w=[],g=(f=e)._versions,y=f._dbSchema=hn(0,f.idbdb,v),(g=g.filter(function(_){return _._cfg.version>=k})).length!==0?(g.forEach(function(_){w.push(function(){var E=y,I=_._cfg.dbschema;mn(f,E,v),mn(f,I,v),y=f._dbSchema=I;var A=Xn(E,I);A.add.forEach(function(K){Zn(v,K[0],K[1].primKey,K[1].indexes)}),A.change.forEach(function(K){if(K.recreate)throw new F.Upgrade("Not yet support for changing primary key");var O=v.objectStore(K.name);K.add.forEach(function(q){return pn(O,q)}),K.change.forEach(function(q){O.deleteIndex(q.name),pn(O,q)}),K.del.forEach(function(q){return O.deleteIndex(q)})});var C=_._cfg.contentUpgrade;if(C&&_._cfg.version>k){dn(f,v),h._memoizedTables={};var D=Pr(I);A.del.forEach(function(K){D[K]=E[K]}),Jn(f,[f.Transaction.prototype]),fn(f,[f.Transaction.prototype],x(D),D),h.schema=D;var L,P=Ln(C);return P&&mt(),A=R.follow(function(){var K;(L=C(h))&&P&&(K=Ne.bind(null,null),L.then(K,K))}),L&&typeof L.then=="function"?R.resolve(L):A.then(function(){return L})}}),w.push(function(E){var I,A,C=_._cfg.dbschema;I=C,A=E,[].slice.call(A.db.objectStoreNames).forEach(function(D){return I[D]==null&&A.db.deleteObjectStore(D)}),Jn(f,[f.Transaction.prototype]),fn(f,[f.Transaction.prototype],f._storeNames,f._dbSchema),h.schema=f._dbSchema}),w.push(function(E){f.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(f.idbdb.version/10)===_._cfg.version?(f.idbdb.deleteObjectStore("$meta"),delete f._dbSchema.$meta,f._storeNames=f._storeNames.filter(function(I){return I!=="$meta"})):E.objectStore("$meta").put(_._cfg.version,"version"))})}),function _(){return w.length?R.resolve(w.shift()(h.idbtrans)).then(_):R.resolve()}().then(function(){ni(y,v)})):R.resolve();var f,k,h,v,w,y}).catch(c)):(x(i).forEach(function(g){Zn(n,g,i[g].primKey,i[g].indexes)}),dn(e,n),void R.follow(function(){return e.on.populate.fire(a)}).catch(c));var p,m})}function Lo(e,t){ni(e._dbSchema,t),t.db.version%10!=0||t.objectStoreNames.contains("$meta")||t.db.createObjectStore("$meta").add(Math.ceil(t.db.version/10-1),"version");var n=hn(0,e.idbdb,t);mn(e,e._dbSchema,t);for(var r=0,i=Xn(n,e._dbSchema).change;r<i.length;r++){var a=function(c){if(c.change.length||c.recreate)return console.warn("Unable to patch indexes of table ".concat(c.name," because it has changes on the type of index or primary key.")),{value:void 0};var d=t.objectStore(c.name);c.add.forEach(function(p){Ee&&console.debug("Dexie upgrade patch: Creating missing index ".concat(c.name,".").concat(p.src)),pn(d,p)})}(i[r]);if(typeof a=="object")return a.value}}function Xn(e,t){var n,r={del:[],add:[],change:[]};for(n in e)t[n]||r.del.push(n);for(n in t){var i=e[n],a=t[n];if(i){var c={name:n,def:a,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(a.primKey.keyPath||"")||i.primKey.auto!==a.primKey.auto)c.recreate=!0,r.change.push(c);else{var d=i.idxByName,p=a.idxByName,m=void 0;for(m in d)p[m]||c.del.push(m);for(m in p){var g=d[m],f=p[m];g?g.src!==f.src&&c.change.push(f):c.add.push(f)}(0<c.del.length||0<c.add.length||0<c.change.length)&&r.change.push(c)}}else r.add.push([n,a])}return r}function Zn(e,t,n,r){var i=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(function(a){return pn(i,a)}),i}function ni(e,t){x(e).forEach(function(n){t.db.objectStoreNames.contains(n)||(Ee&&console.debug("Dexie: Creating missing table",n),Zn(t,n,e[n].primKey,e[n].indexes))})}function pn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function hn(e,t,n){var r={};return _e(t.objectStoreNames,0).forEach(function(i){for(var a=n.objectStore(i),c=Gn(ei(m=a.keyPath),m||"",!0,!1,!!a.autoIncrement,m&&typeof m!="string",!0),d=[],p=0;p<a.indexNames.length;++p){var g=a.index(a.indexNames[p]),m=g.keyPath,g=Gn(g.name,m,!!g.unique,!!g.multiEntry,!1,m&&typeof m!="string",!1);d.push(g)}r[i]=Yn(i,c,d)}),r}function mn(e,t,n){for(var r=n.db.objectStoreNames,i=0;i<r.length;++i){var a=r[i],c=n.objectStore(a);e._hasGetAll="getAll"in c;for(var d=0;d<c.indexNames.length;++d){var p=c.indexNames[d],m=c.index(p).keyPath,g=typeof m=="string"?m:"["+_e(m).join("+")+"]";!t[a]||(m=t[a].idxByName[g])&&(m.name=p,delete t[a].idxByName[g],t[a].idxByName[p]=m)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&S.WorkerGlobalScope&&S instanceof S.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}function ri(e){return e.split(",").map(function(t,n){var r=(t=t.trim()).replace(/([&*]|\+\+)/g,""),i=/^\[/.test(r)?r.match(/^\[(.*)\]$/)[1].split("+"):r;return Gn(r,i||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),B(i),n===0)})}var Po=(yn.prototype._parseStoresSpec=function(e,t){x(e).forEach(function(n){if(e[n]!==null){var r=ri(e[n]),i=r.shift();if(i.unique=!0,i.multi)throw new F.Schema("Primary key cannot be multi-valued");r.forEach(function(a){if(a.auto)throw new F.Schema("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new F.Schema("Index must have a name and cannot be an empty string")}),t[n]=Yn(n,i,r)}})},yn.prototype.stores=function(n){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?N(this._cfg.storesSource,n):n;var n=t._versions,r={},i={};return n.forEach(function(a){N(r,a._cfg.storesSource),i=a._cfg.dbschema={},a._parseStoresSpec(r,i)}),t._dbSchema=i,Jn(t,[t._allTables,t,t.Transaction.prototype]),fn(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],x(i),i),t._storeNames=x(i),this},yn.prototype.upgrade=function(e){return this._cfg.contentUpgrade=On(this._cfg.contentUpgrade||Z,e),this},yn);function yn(){}function er(e,t){var n=e._dbNamesDB;return n||(n=e._dbNamesDB=new Pe(an,{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),n.table("dbnames")}function tr(e){return e&&typeof e.databases=="function"}function nr(e){return Me(function(){return j.letThrough=!0,e()})}function rr(e){return!("from"in e)}var ue=function(e,t){if(!this){var n=new ue;return e&&"d"in e&&N(n,e),n}N(this,arguments.length?{d:1,from:e,to:1<arguments.length?t:e}:{d:0})};function Rt(e,t,n){var r=Q(t,n);if(!isNaN(r)){if(0<r)throw RangeError();if(rr(e))return N(e,{from:t,to:n,d:1});var i=e.l,r=e.r;if(Q(n,e.from)<0)return i?Rt(i,t,n):e.l={from:t,to:n,d:1,l:null,r:null},oi(e);if(0<Q(t,e.to))return r?Rt(r,t,n):e.r={from:t,to:n,d:1,l:null,r:null},oi(e);Q(t,e.from)<0&&(e.from=t,e.l=null,e.d=r?r.d+1:1),0<Q(n,e.to)&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1),n=!e.r,i&&!e.l&&qt(e,i),r&&n&&qt(e,r)}}function qt(e,t){rr(t)||function n(r,p){var a=p.from,c=p.to,d=p.l,p=p.r;Rt(r,a,c),d&&n(r,d),p&&n(r,p)}(e,t)}function ii(e,t){var n=vn(t),r=n.next();if(r.done)return!1;for(var i=r.value,a=vn(e),c=a.next(i.from),d=c.value;!r.done&&!c.done;){if(Q(d.from,i.to)<=0&&0<=Q(d.to,i.from))return!0;Q(i.from,d.from)<0?i=(r=n.next(d.from)).value:d=(c=a.next(i.from)).value}return!1}function vn(e){var t=rr(e)?null:{s:0,n:e};return{next:function(n){for(var r=0<arguments.length;t;)switch(t.s){case 0:if(t.s=1,r)for(;t.n.l&&Q(n,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!r||Q(n,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function oi(e){var t,n,r=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((n=e.l)===null||n===void 0?void 0:n.d)||0),i=1<r?"r":r<-1?"l":"";i&&(t=i=="r"?"l":"r",n=l({},e),r=e[i],e.from=r.from,e.to=r.to,e[i]=r[i],n[i]=r[t],(e[t]=n).d=ai(n)),e.d=ai(e)}function ai(n){var t=n.r,n=n.l;return(t?n?Math.max(t.d,n.d):t.d:n?n.d:0)+1}function gn(e,t){return x(t).forEach(function(n){e[n]?qt(e[n],t[n]):e[n]=function r(i){var a,c,d={};for(a in i)Y(i,a)&&(c=i[a],d[a]=!c||typeof c!="object"||Dr.has(c.constructor)?c:r(c));return d}(t[n])}),e}function ir(e,t){return e.all||t.all||Object.keys(e).some(function(n){return t[n]&&ii(t[n],e[n])})}oe(ue.prototype,((we={add:function(e){return qt(this,e),this},addKey:function(e){return Rt(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(n){return Rt(t,n,n)}),this},hasKey:function(e){var t=vn(this).next(e).value;return t&&Q(t.from,e)<=0&&0<=Q(t.to,e)}})[Cn]=function(){return vn(this)},we));var ot={},or={},ar=!1;function bn(e){gn(or,e),ar||(ar=!0,setTimeout(function(){ar=!1,sr(or,!(or={}))},0))}function sr(e,t){t===void 0&&(t=!1);var n=new Set;if(e.all)for(var r=0,i=Object.values(ot);r<i.length;r++)si(c=i[r],e,n,t);else for(var a in e){var c,d=/^idb\:\/\/(.*)\/(.*)\//.exec(a);d&&(a=d[1],d=d[2],(c=ot["idb://".concat(a,"/").concat(d)])&&si(c,e,n,t))}n.forEach(function(p){return p()})}function si(e,t,n,r){for(var i=[],a=0,c=Object.entries(e.queries.query);a<c.length;a++){for(var d=c[a],p=d[0],m=[],g=0,f=d[1];g<f.length;g++){var k=f[g];ir(t,k.obsSet)?k.subscribers.forEach(function(y){return n.add(y)}):r&&m.push(k)}r&&i.push([p,m])}if(r)for(var h=0,v=i;h<v.length;h++){var w=v[h],p=w[0],m=w[1];e.queries.query[p]=m}}function Oo(e){var t=e._state,n=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?re(t.dbOpenError):e});t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var r=t.openCanceller,i=Math.round(10*e.verno),a=!1;function c(){if(t.openCanceller!==r)throw new F.DatabaseClosed("db.open() was cancelled")}function d(){return new R(function(k,h){if(c(),!n)throw new F.MissingAPI;var v=e.name,w=t.autoSchema||!i?n.open(v):n.open(v,i);if(!w)throw new F.MissingAPI;w.onerror=Ie(h),w.onblocked=ne(e._fireOnBlocked),w.onupgradeneeded=ne(function(y){var _;g=w.transaction,t.autoSchema&&!e._options.allowEmptyDB?(w.onerror=Dt,g.abort(),w.result.close(),(_=n.deleteDatabase(v)).onsuccess=_.onerror=ne(function(){h(new F.NoSuchDatabase("Database ".concat(v," doesnt exist")))})):(g.onerror=Ie(h),y=y.oldVersion>Math.pow(2,62)?0:y.oldVersion,f=y<1,e.idbdb=w.result,a&&Lo(e,g),Co(e,y/10,g,h))},h),w.onsuccess=ne(function(){g=null;var y,_,E,I,A,C=e.idbdb=w.result,D=_e(C.objectStoreNames);if(0<D.length)try{var L=C.transaction((I=D).length===1?I[0]:I,"readonly");if(t.autoSchema)_=C,E=L,(y=e).verno=_.version/10,E=y._dbSchema=hn(0,_,E),y._storeNames=_e(_.objectStoreNames,0),fn(y,[y._allTables],x(E),E);else if(mn(e,e._dbSchema,L),((A=Xn(hn(0,(A=e).idbdb,L),A._dbSchema)).add.length||A.change.some(function(P){return P.add.length||P.change.length}))&&!a)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),C.close(),i=C.version+1,a=!0,k(d());dn(e,L)}catch{}yt.push(e),C.onversionchange=ne(function(P){t.vcFired=!0,e.on("versionchange").fire(P)}),C.onclose=ne(function(P){e.on("close").fire(P)}),f&&(A=e._deps,L=v,C=A.indexedDB,A=A.IDBKeyRange,tr(C)||L===an||er(C,A).put({name:L}).catch(Z)),k()},h)}).catch(function(k){switch(k==null?void 0:k.name){case"UnknownError":if(0<t.PR1398_maxLoop)return t.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),d();break;case"VersionError":if(0<i)return i=0,d()}return R.reject(k)})}var p,m=t.dbReadyResolve,g=null,f=!1;return R.race([r,(typeof navigator>"u"?R.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(k){function h(){return indexedDB.databases().finally(k)}p=setInterval(h,100),h()}).finally(function(){return clearInterval(p)}):Promise.resolve()).then(d)]).then(function(){return c(),t.onReadyBeingFired=[],R.resolve(nr(function(){return e.on.ready.fire(e.vip)})).then(function k(){if(0<t.onReadyBeingFired.length){var h=t.onReadyBeingFired.reduce(On,Z);return t.onReadyBeingFired=[],R.resolve(nr(function(){return h(e.vip)})).then(k)}})}).finally(function(){t.openCanceller===r&&(t.onReadyBeingFired=null,t.isBeingOpened=!1)}).catch(function(k){t.dbOpenError=k;try{g&&g.abort()}catch{}return r===t.openCanceller&&e._close(),re(k)}).finally(function(){t.openComplete=!0,m()}).then(function(){var k;return f&&(k={},e.tables.forEach(function(h){h.schema.indexes.forEach(function(v){v.name&&(k["idb://".concat(e.name,"/").concat(h.name,"/").concat(v.name)]=new ue(-1/0,[[[]]]))}),k["idb://".concat(e.name,"/").concat(h.name,"/")]=k["idb://".concat(e.name,"/").concat(h.name,"/:dels")]=new ue(-1/0,[[[]]])}),je(Kt).fire(k),sr(k,!0)),e})}function cr(e){function t(a){return e.next(a)}var n=i(t),r=i(function(a){return e.throw(a)});function i(a){return function(p){var d=a(p),p=d.value;return d.done?p:p&&typeof p.then=="function"?p.then(n,r):B(p)?Promise.all(p).then(n,r):n(p)}}return i(t)()}function wn(e,t,n){for(var r=B(e)?e.slice():[e],i=0;i<n;++i)r.push(t);return r}var Do={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return l(l({},e),{table:function(t){var n=e.table(t),r=n.schema,i={},a=[];function c(f,k,h){var v=Nt(f),w=i[v]=i[v]||[],y=f==null?0:typeof f=="string"?1:f.length,_=0<k,_=l(l({},h),{name:_?"".concat(v,"(virtual-from:").concat(h.name,")"):h.name,lowLevelIndex:h,isVirtual:_,keyTail:k,keyLength:y,extractKey:Qn(f),unique:!_&&h.unique});return w.push(_),_.isPrimaryKey||a.push(_),1<y&&c(y===2?f[0]:f.slice(0,y-1),k+1,h),w.sort(function(E,I){return E.keyTail-I.keyTail}),_}t=c(r.primaryKey.keyPath,0,r.primaryKey),i[":id"]=[t];for(var d=0,p=r.indexes;d<p.length;d++){var m=p[d];c(m.keyPath,0,m)}function g(f){var k,h=f.query.index;return h.isVirtual?l(l({},f),{query:{index:h.lowLevelIndex,range:(k=f.query.range,h=h.keyTail,{type:k.type===1?2:k.type,lower:wn(k.lower,k.lowerOpen?e.MAX_KEY:e.MIN_KEY,h),lowerOpen:!0,upper:wn(k.upper,k.upperOpen?e.MIN_KEY:e.MAX_KEY,h),upperOpen:!0})}}):f}return l(l({},n),{schema:l(l({},r),{primaryKey:t,indexes:a,getIndexByKeyPath:function(f){return(f=i[Nt(f)])&&f[0]}}),count:function(f){return n.count(g(f))},query:function(f){return n.query(g(f))},openCursor:function(f){var k=f.query.index,h=k.keyTail,v=k.isVirtual,w=k.keyLength;return v?n.openCursor(g(f)).then(function(_){return _&&y(_)}):n.openCursor(f);function y(_){return Object.create(_,{continue:{value:function(E){E!=null?_.continue(wn(E,f.reverse?e.MAX_KEY:e.MIN_KEY,h)):f.unique?_.continue(_.key.slice(0,w).concat(f.reverse?e.MIN_KEY:e.MAX_KEY,h)):_.continue()}},continuePrimaryKey:{value:function(E,I){_.continuePrimaryKey(wn(E,e.MAX_KEY,h),I)}},primaryKey:{get:function(){return _.primaryKey}},key:{get:function(){var E=_.key;return w===1?E[0]:E.slice(0,w)}},value:{get:function(){return _.value}}})}}})}})}};function ur(e,t,n,r){return n=n||{},r=r||"",x(e).forEach(function(i){var a,c,d;Y(t,i)?(a=e[i],c=t[i],typeof a=="object"&&typeof c=="object"&&a&&c?(d=Bn(a))!==Bn(c)?n[r+i]=t[i]:d==="Object"?ur(a,c,n,r+i+"."):a!==c&&(n[r+i]=t[i]):a!==c&&(n[r+i]=t[i])):n[r+i]=void 0}),x(t).forEach(function(i){Y(e,i)||(n[r+i]=t[i])}),n}function lr(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var Ko={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return l(l({},e),{table:function(t){var n=e.table(t),r=n.schema.primaryKey;return l(l({},n),{mutate:function(i){var a=j.trans,c=a.table(t).hook,d=c.deleting,p=c.creating,m=c.updating;switch(i.type){case"add":if(p.fire===Z)break;return a._promise("readwrite",function(){return g(i)},!0);case"put":if(p.fire===Z&&m.fire===Z)break;return a._promise("readwrite",function(){return g(i)},!0);case"delete":if(d.fire===Z)break;return a._promise("readwrite",function(){return g(i)},!0);case"deleteRange":if(d.fire===Z)break;return a._promise("readwrite",function(){return function f(k,h,v){return n.query({trans:k,values:!1,query:{index:r,range:h},limit:v}).then(function(w){var y=w.result;return g({type:"delete",keys:y,trans:k}).then(function(_){return 0<_.numFailures?Promise.reject(_.failures[0]):y.length<v?{failures:[],numFailures:0,lastResult:void 0}:f(k,l(l({},h),{lower:y[y.length-1],lowerOpen:!0}),v)})})}(i.trans,i.range,1e4)},!0)}return n.mutate(i);function g(f){var k,h,v,w=j.trans,y=f.keys||lr(r,f);if(!y)throw new Error("Keys missing");return(f=f.type==="add"||f.type==="put"?l(l({},f),{keys:y}):l({},f)).type!=="delete"&&(f.values=b([],f.values)),f.keys&&(f.keys=b([],f.keys)),k=n,v=y,((h=f).type==="add"?Promise.resolve([]):k.getMany({trans:h.trans,keys:v,cache:"immutable"})).then(function(_){var E=y.map(function(I,A){var C,D,L,P=_[A],K={onerror:null,onsuccess:null};return f.type==="delete"?d.fire.call(K,I,P,w):f.type==="add"||P===void 0?(C=p.fire.call(K,I,f.values[A],w),I==null&&C!=null&&(f.keys[A]=I=C,r.outbound||ve(f.values[A],r.keyPath,I))):(C=ur(P,f.values[A]),(D=m.fire.call(K,C,I,P,w))&&(L=f.values[A],Object.keys(D).forEach(function(O){Y(L,O)?L[O]=D[O]:ve(L,O,D[O])}))),K});return n.mutate(f).then(function(I){for(var A=I.failures,C=I.results,D=I.numFailures,I=I.lastResult,L=0;L<y.length;++L){var P=(C||y)[L],K=E[L];P==null?K.onerror&&K.onerror(A[L]):K.onsuccess&&K.onsuccess(f.type==="put"&&_[L]?f.values[L]:P)}return{failures:A,results:C,numFailures:D,lastResult:I}}).catch(function(I){return E.forEach(function(A){return A.onerror&&A.onerror(I)}),Promise.reject(I)})})}}})}})}};function ci(e,t,n){try{if(!t||t.keys.length<e.length)return null;for(var r=[],i=0,a=0;i<t.keys.length&&a<e.length;++i)Q(t.keys[i],e[a])===0&&(r.push(n?Ye(t.values[i]):t.values[i]),++a);return r.length===e.length?r:null}catch{return null}}var Mo={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var n=e.table(t);return l(l({},n),{getMany:function(r){if(!r.cache)return n.getMany(r);var i=ci(r.keys,r.trans._cache,r.cache==="clone");return i?R.resolve(i):n.getMany(r).then(function(a){return r.trans._cache={keys:r.keys,values:r.cache==="clone"?Ye(a):a},a})},mutate:function(r){return r.type!=="add"&&(r.trans._cache=null),n.mutate(r)}})}}}};function ui(e,t){return e.trans.mode==="readonly"&&!!e.subscr&&!e.trans.explicit&&e.trans.db._options.cache!=="disabled"&&!t.schema.primaryKey.outbound}function li(e,t){switch(e){case"query":return t.values&&!t.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var No={stack:"dbcore",level:0,name:"Observability",create:function(e){var t=e.schema.name,n=new ue(e.MIN_KEY,e.MAX_KEY);return l(l({},e),{transaction:function(r,i,a){if(j.subscr&&i!=="readonly")throw new F.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(j.querier));return e.transaction(r,i,a)},table:function(r){var i=e.table(r),a=i.schema,c=a.primaryKey,f=a.indexes,d=c.extractKey,p=c.outbound,m=c.autoIncrement&&f.filter(function(h){return h.compound&&h.keyPath.includes(c.keyPath)}),g=l(l({},i),{mutate:function(h){function v(O){return O="idb://".concat(t,"/").concat(r,"/").concat(O),I[O]||(I[O]=new ue)}var w,y,_,E=h.trans,I=h.mutatedParts||(h.mutatedParts={}),A=v(""),C=v(":dels"),D=h.type,K=h.type==="deleteRange"?[h.range]:h.type==="delete"?[h.keys]:h.values.length<50?[lr(c,h).filter(function(O){return O}),h.values]:[],L=K[0],P=K[1],K=h.trans._cache;return B(L)?(A.addKeys(L),(K=D==="delete"||L.length===P.length?ci(L,K):null)||C.addKeys(L),(K||P)&&(w=v,y=K,_=P,a.indexes.forEach(function(O){var q=w(O.name||"");function H(U){return U!=null?O.extractKey(U):null}function V(U){return O.multiEntry&&B(U)?U.forEach(function(be){return q.addKey(be)}):q.addKey(U)}(y||_).forEach(function(U,le){var $=y&&H(y[le]),le=_&&H(_[le]);Q($,le)!==0&&($!=null&&V($),le!=null&&V(le))})}))):L?(P={from:(P=L.lower)!==null&&P!==void 0?P:e.MIN_KEY,to:(P=L.upper)!==null&&P!==void 0?P:e.MAX_KEY},C.add(P),A.add(P)):(A.add(n),C.add(n),a.indexes.forEach(function(O){return v(O.name).add(n)})),i.mutate(h).then(function(O){return!L||h.type!=="add"&&h.type!=="put"||(A.addKeys(O.results),m&&m.forEach(function(q){for(var H=h.values.map(function($){return q.extractKey($)}),V=q.keyPath.findIndex(function($){return $===c.keyPath}),U=0,be=O.results.length;U<be;++U)H[U][V]=O.results[U];v(q.name).addKeys(H)})),E.mutatedParts=gn(E.mutatedParts||{},I),O})}}),f=function(v){var w=v.query,v=w.index,w=w.range;return[v,new ue((v=w.lower)!==null&&v!==void 0?v:e.MIN_KEY,(w=w.upper)!==null&&w!==void 0?w:e.MAX_KEY)]},k={get:function(h){return[c,new ue(h.key)]},getMany:function(h){return[c,new ue().addKeys(h.keys)]},count:f,query:f,openCursor:f};return x(k).forEach(function(h){g[h]=function(v){var w=j.subscr,y=!!w,_=ui(j,i)&&li(h,v)?v.obsSet={}:w;if(y){var E=function(P){return P="idb://".concat(t,"/").concat(r,"/").concat(P),_[P]||(_[P]=new ue)},I=E(""),A=E(":dels"),w=k[h](v),y=w[0],w=w[1];if((h==="query"&&y.isPrimaryKey&&!v.values?A:E(y.name||"")).add(w),!y.isPrimaryKey){if(h!=="count"){var C=h==="query"&&p&&v.values&&i.query(l(l({},v),{values:!1}));return i[h].apply(this,arguments).then(function(P){if(h==="query"){if(p&&v.values)return C.then(function(H){return H=H.result,I.addKeys(H),P});var K=v.values?P.result.map(d):P.result;(v.values?I:A).addKeys(K)}else if(h==="openCursor"){var O=P,q=v.values;return O&&Object.create(O,{key:{get:function(){return A.addKey(O.primaryKey),O.key}},primaryKey:{get:function(){var H=O.primaryKey;return A.addKey(H),H}},value:{get:function(){return q&&I.addKey(O.primaryKey),O.value}}})}return P})}A.add(n)}}return i[h].apply(this,arguments)}}),g}})}};function di(e,t,n){if(n.numFailures===0)return t;if(t.type==="deleteRange")return null;var r=t.keys?t.keys.length:"values"in t&&t.values?t.values.length:1;return n.numFailures===r?null:(t=l({},t),B(t.keys)&&(t.keys=t.keys.filter(function(i,a){return!(a in n.failures)})),"values"in t&&B(t.values)&&(t.values=t.values.filter(function(i,a){return!(a in n.failures)})),t)}function dr(e,t){return n=e,((r=t).lower===void 0||(r.lowerOpen?0<Q(n,r.lower):0<=Q(n,r.lower)))&&(e=e,(t=t).upper===void 0||(t.upperOpen?Q(e,t.upper)<0:Q(e,t.upper)<=0));var n,r}function fi(e,t,k,r,i,a){if(!k||k.length===0)return e;var c=t.query.index,d=c.multiEntry,p=t.query.range,m=r.schema.primaryKey.extractKey,g=c.extractKey,f=(c.lowLevelIndex||c).extractKey,k=k.reduce(function(h,v){var w=h,y=[];if(v.type==="add"||v.type==="put")for(var _=new ue,E=v.values.length-1;0<=E;--E){var I,A=v.values[E],C=m(A);_.hasKey(C)||(I=g(A),(d&&B(I)?I.some(function(O){return dr(O,p)}):dr(I,p))&&(_.addKey(C),y.push(A)))}switch(v.type){case"add":var D=new ue().addKeys(t.values?h.map(function(q){return m(q)}):h),w=h.concat(t.values?y.filter(function(q){return q=m(q),!D.hasKey(q)&&(D.addKey(q),!0)}):y.map(function(q){return m(q)}).filter(function(q){return!D.hasKey(q)&&(D.addKey(q),!0)}));break;case"put":var L=new ue().addKeys(v.values.map(function(q){return m(q)}));w=h.filter(function(q){return!L.hasKey(t.values?m(q):q)}).concat(t.values?y:y.map(function(q){return m(q)}));break;case"delete":var P=new ue().addKeys(v.keys);w=h.filter(function(q){return!P.hasKey(t.values?m(q):q)});break;case"deleteRange":var K=v.range;w=h.filter(function(q){return!dr(m(q),K)})}return w},e);return k===e?e:(k.sort(function(h,v){return Q(f(h),f(v))||Q(m(h),m(v))}),t.limit&&t.limit<1/0&&(k.length>t.limit?k.length=t.limit:e.length===t.limit&&k.length<t.limit&&(i.dirty=!0)),a?Object.freeze(k):k)}function pi(e,t){return Q(e.lower,t.lower)===0&&Q(e.upper,t.upper)===0&&!!e.lowerOpen==!!t.lowerOpen&&!!e.upperOpen==!!t.upperOpen}function Ro(e,t){return function(n,r,i,a){if(n===void 0)return r!==void 0?-1:0;if(r===void 0)return 1;if((r=Q(n,r))===0){if(i&&a)return 0;if(i)return 1;if(a)return-1}return r}(e.lower,t.lower,e.lowerOpen,t.lowerOpen)<=0&&0<=function(n,r,i,a){if(n===void 0)return r!==void 0?1:0;if(r===void 0)return-1;if((r=Q(n,r))===0){if(i&&a)return 0;if(i)return-1;if(a)return 1}return r}(e.upper,t.upper,e.upperOpen,t.upperOpen)}function qo(e,t,n,r){e.subscribers.add(n),r.addEventListener("abort",function(){var i,a;e.subscribers.delete(n),e.subscribers.size===0&&(i=e,a=t,setTimeout(function(){i.subscribers.size===0&&Qe(a,i)},3e3))})}var jo={stack:"dbcore",level:0,name:"Cache",create:function(e){var t=e.schema.name;return l(l({},e),{transaction:function(n,r,i){var a,c,d=e.transaction(n,r,i);return r==="readwrite"&&(c=(a=new AbortController).signal,i=function(p){return function(){if(a.abort(),r==="readwrite"){for(var m=new Set,g=0,f=n;g<f.length;g++){var k=f[g],h=ot["idb://".concat(t,"/").concat(k)];if(h){var v=e.table(k),w=h.optimisticOps.filter(function(q){return q.trans===d});if(d._explicit&&p&&d.mutatedParts)for(var y=0,_=Object.values(h.queries.query);y<_.length;y++)for(var E=0,I=(D=_[y]).slice();E<I.length;E++)ir((L=I[E]).obsSet,d.mutatedParts)&&(Qe(D,L),L.subscribers.forEach(function(q){return m.add(q)}));else if(0<w.length){h.optimisticOps=h.optimisticOps.filter(function(q){return q.trans!==d});for(var A=0,C=Object.values(h.queries.query);A<C.length;A++)for(var D,L,P,K=0,O=(D=C[A]).slice();K<O.length;K++)(L=O[K]).res!=null&&d.mutatedParts&&(p&&!L.dirty?(P=Object.isFrozen(L.res),P=fi(L.res,L.req,w,v,L,P),L.dirty?(Qe(D,L),L.subscribers.forEach(function(q){return m.add(q)})):P!==L.res&&(L.res=P,L.promise=R.resolve({result:P}))):(L.dirty&&Qe(D,L),L.subscribers.forEach(function(q){return m.add(q)})))}}}m.forEach(function(q){return q()})}}},d.addEventListener("abort",i(!1),{signal:c}),d.addEventListener("error",i(!1),{signal:c}),d.addEventListener("complete",i(!0),{signal:c})),d},table:function(n){var r=e.table(n),i=r.schema.primaryKey;return l(l({},r),{mutate:function(a){var c=j.trans;if(i.outbound||c.db._options.cache==="disabled"||c.explicit||c.idbtrans.mode!=="readwrite")return r.mutate(a);var d=ot["idb://".concat(t,"/").concat(n)];return d?(c=r.mutate(a),a.type!=="add"&&a.type!=="put"||!(50<=a.values.length||lr(i,a).some(function(p){return p==null}))?(d.optimisticOps.push(a),a.mutatedParts&&bn(a.mutatedParts),c.then(function(p){0<p.numFailures&&(Qe(d.optimisticOps,a),(p=di(0,a,p))&&d.optimisticOps.push(p),a.mutatedParts&&bn(a.mutatedParts))}),c.catch(function(){Qe(d.optimisticOps,a),a.mutatedParts&&bn(a.mutatedParts)})):c.then(function(p){var m=di(0,l(l({},a),{values:a.values.map(function(g,f){var k;return p.failures[f]?g:(g=(k=i.keyPath)!==null&&k!==void 0&&k.includes(".")?Ye(g):l({},g),ve(g,i.keyPath,p.results[f]),g)})}),p);d.optimisticOps.push(m),queueMicrotask(function(){return a.mutatedParts&&bn(a.mutatedParts)})}),c):r.mutate(a)},query:function(a){if(!ui(j,r)||!li("query",a))return r.query(a);var c=((m=j.trans)===null||m===void 0?void 0:m.db._options.cache)==="immutable",f=j,d=f.requery,p=f.signal,m=function(v,w,y,_){var E=ot["idb://".concat(v,"/").concat(w)];if(!E)return[];if(!(w=E.queries[y]))return[null,!1,E,null];var I=w[(_.query?_.query.index.name:null)||""];if(!I)return[null,!1,E,null];switch(y){case"query":var A=I.find(function(C){return C.req.limit===_.limit&&C.req.values===_.values&&pi(C.req.query.range,_.query.range)});return A?[A,!0,E,I]:[I.find(function(C){return("limit"in C.req?C.req.limit:1/0)>=_.limit&&(!_.values||C.req.values)&&Ro(C.req.query.range,_.query.range)}),!1,E,I];case"count":return A=I.find(function(C){return pi(C.req.query.range,_.query.range)}),[A,!!A,E,I]}}(t,n,"query",a),g=m[0],f=m[1],k=m[2],h=m[3];return g&&f?g.obsSet=a.obsSet:(f=r.query(a).then(function(v){var w=v.result;if(g&&(g.res=w),c){for(var y=0,_=w.length;y<_;++y)Object.freeze(w[y]);Object.freeze(w)}else v.result=Ye(w);return v}).catch(function(v){return h&&g&&Qe(h,g),Promise.reject(v)}),g={obsSet:a.obsSet,promise:f,subscribers:new Set,type:"query",req:a,dirty:!1},h?h.push(g):(h=[g],(k=k||(ot["idb://".concat(t,"/").concat(n)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[a.query.index.name||""]=h)),qo(g,h,d,p),g.promise.then(function(v){return{result:fi(v.result,a,k==null?void 0:k.optimisticOps,r,g,c)}})}})}})}};function kn(e,t){return new Proxy(e,{get:function(n,r,i){return r==="db"?t:Reflect.get(n,r,i)}})}var Pe=(ie.prototype.version=function(e){if(isNaN(e)||e<.1)throw new F.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new F.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,n=t.filter(function(r){return r._cfg.version===e})[0];return n||(n=new this.Version(e),t.push(n),t.sort(Bo),n.stores({}),this._state.autoSchema=!1,n)},ie.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||j.letThrough||this._vip)?e():new R(function(n,r){if(t._state.openComplete)return r(new F.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._state.autoOpen)return void r(new F.DatabaseClosed);t.open().catch(Z)}t._state.dbReadyPromise.then(n,r)}).then(e)},ie.prototype.use=function(e){var t=e.stack,n=e.create,r=e.level,i=e.name;return i&&this.unuse({stack:t,name:i}),e=this._middlewares[t]||(this._middlewares[t]=[]),e.push({stack:t,create:n,level:r??10,name:i}),e.sort(function(a,c){return a.level-c.level}),this},ie.prototype.unuse=function(e){var t=e.stack,n=e.name,r=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(i){return r?i.create!==r:!!n&&i.name!==n})),this},ie.prototype.open=function(){var e=this;return nt(Ke,function(){return Oo(e)})},ie.prototype._close=function(){var e=this._state,t=yt.indexOf(this);if(0<=t&&yt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}e.isBeingOpened||(e.dbReadyPromise=new R(function(n){e.dbReadyResolve=n}),e.openCanceller=new R(function(n,r){e.cancelOpen=r}))},ie.prototype.close=function(n){var t=(n===void 0?{disableAutoOpen:!0}:n).disableAutoOpen,n=this._state;t?(n.isBeingOpened&&n.cancelOpen(new F.DatabaseClosed),this._close(),n.autoOpen=!1,n.dbOpenError=new F.DatabaseClosed):(this._close(),n.autoOpen=this._options.autoOpen||n.isBeingOpened,n.openComplete=!1,n.dbOpenError=null)},ie.prototype.delete=function(e){var t=this;e===void 0&&(e={disableAutoOpen:!0});var n=0<arguments.length&&typeof arguments[0]!="object",r=this._state;return new R(function(i,a){function c(){t.close(e);var d=t._deps.indexedDB.deleteDatabase(t.name);d.onsuccess=ne(function(){var p,m,g;p=t._deps,m=t.name,g=p.indexedDB,p=p.IDBKeyRange,tr(g)||m===an||er(g,p).delete(m).catch(Z),i()}),d.onerror=Ie(a),d.onblocked=t._fireOnBlocked}if(n)throw new F.InvalidArgument("Invalid closeOptions argument to db.delete()");r.isBeingOpened?r.dbReadyPromise.then(c):c()})},ie.prototype.backendDB=function(){return this.idbdb},ie.prototype.isOpen=function(){return this.idbdb!==null},ie.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},ie.prototype.hasFailed=function(){return this._state.dbOpenError!==null},ie.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(ie.prototype,"tables",{get:function(){var e=this;return x(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),ie.prototype.transaction=function(){var e=(function(t,n,r){var i=arguments.length;if(i<2)throw new F.InvalidArgument("Too few arguments");for(var a=new Array(i-1);--i;)a[i-1]=arguments[i];return r=a.pop(),[t,Or(a),r]}).apply(this,arguments);return this._transaction.apply(this,e)},ie.prototype._transaction=function(e,t,n){var r=this,i=j.trans;i&&i.db===this&&e.indexOf("!")===-1||(i=null);var a,c,d=e.indexOf("?")!==-1;e=e.replace("!","").replace("?","");try{if(c=t.map(function(m){if(m=m instanceof r.Table?m.name:m,typeof m!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return m}),e=="r"||e===zn)a=zn;else{if(e!="rw"&&e!=$n)throw new F.InvalidArgument("Invalid transaction mode: "+e);a=$n}if(i){if(i.mode===zn&&a===$n){if(!d)throw new F.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");i=null}i&&c.forEach(function(m){if(i&&i.storeNames.indexOf(m)===-1){if(!d)throw new F.SubTransaction("Table "+m+" not included in parent transaction.");i=null}}),d&&i&&!i.active&&(i=null)}}catch(m){return i?i._promise(null,function(g,f){f(m)}):re(m)}var p=(function m(g,f,k,h,v){return R.resolve().then(function(){var w=j.transless||j,y=g._createTransaction(f,k,g._dbSchema,h);if(y.explicit=!0,w={trans:y,transless:w},h)y.idbtrans=h.idbtrans;else try{y.create(),y.idbtrans._explicit=!0,g._state.PR1398_maxLoop=3}catch(I){return I.name===Pn.InvalidState&&g.isOpen()&&0<--g._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),g.close({disableAutoOpen:!1}),g.open().then(function(){return m(g,f,k,null,v)})):re(I)}var _,E=Ln(v);return E&&mt(),w=R.follow(function(){var I;(_=v.call(y,y))&&(E?(I=Ne.bind(null,null),_.then(I,I)):typeof _.next=="function"&&typeof _.throw=="function"&&(_=cr(_)))},w),(_&&typeof _.then=="function"?R.resolve(_).then(function(I){return y.active?I:re(new F.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):w.then(function(){return _})).then(function(I){return h&&y._resolve(),y._completion.then(function(){return I})}).catch(function(I){return y._reject(I),re(I)})})}).bind(null,this,a,c,i,n);return i?i._promise(a,p,"lock"):j.trans?nt(j.transless,function(){return r._whenReady(p)}):this._whenReady(p)},ie.prototype.table=function(e){if(!Y(this._allTables,e))throw new F.InvalidTable("Table ".concat(e," does not exist"));return this._allTables[e]},ie);function ie(e,t){var n=this;this._middlewares={},this.verno=0;var r=ie.dependencies;this._options=t=l({addons:ie.addons,autoOpen:!0,indexedDB:r.indexedDB,IDBKeyRange:r.IDBKeyRange,cache:"cloned"},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange},r=t.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var i,a,c,d,p,m={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Z,dbReadyPromise:null,cancelOpen:Z,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:t.autoOpen};m.dbReadyPromise=new R(function(f){m.dbReadyResolve=f}),m.openCanceller=new R(function(f,k){m.cancelOpen=k}),this._state=m,this.name=e,this.on=Lt(this,"populate","blocked","versionchange","close",{ready:[On,Z]}),this.on.ready.subscribe=Se(this.on.ready.subscribe,function(f){return function(k,h){ie.vip(function(){var v,w=n._state;w.openComplete?(w.dbOpenError||R.resolve().then(k),h&&f(k)):w.onReadyBeingFired?(w.onReadyBeingFired.push(k),h&&f(k)):(f(k),v=n,h||f(function y(){v.on.ready.unsubscribe(k),v.on.ready.unsubscribe(y)}))})}}),this.Collection=(i=this,Pt(_o.prototype,function(_,y){this.db=i;var h=Hr,v=null;if(y)try{h=y()}catch(E){v=E}var w=_._ctx,y=w.table,_=y.hook.reading.fire;this._ctx={table:y,index:w.index,isPrimKey:!w.index||y.schema.primKey.keyPath&&w.index===y.schema.primKey.name,range:h,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:v,or:w.or,valueMapper:_!==xt?_:null}})),this.Table=(a=this,Pt(Gr.prototype,function(f,k,h){this.db=a,this._tx=h,this.name=f,this.schema=k,this.hook=a._allTables[f]?a._allTables[f].hook:Lt(null,{creating:[po,Z],reading:[fo,xt],updating:[mo,Z],deleting:[ho,Z]})})),this.Transaction=(c=this,Pt(Io.prototype,function(f,k,h,v,w){var y=this;this.db=c,this.mode=f,this.storeNames=k,this.schema=h,this.chromeTransactionDurability=v,this.idbtrans=null,this.on=Lt(this,"complete","error","abort"),this.parent=w||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new R(function(_,E){y._resolve=_,y._reject=E}),this._completion.then(function(){y.active=!1,y.on.complete.fire()},function(_){var E=y.active;return y.active=!1,y.on.error.fire(_),y.parent?y.parent._reject(_):E&&y.idbtrans&&y.idbtrans.abort(),re(_)})})),this.Version=(d=this,Pt(Po.prototype,function(f){this.db=d,this._cfg={version:f,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(p=this,Pt(Zr.prototype,function(f,k,h){if(this.db=p,this._ctx={table:f,index:k===":id"?null:k,or:h},this._cmp=this._ascending=Q,this._descending=function(v,w){return Q(w,v)},this._max=function(v,w){return 0<Q(v,w)?v:w},this._min=function(v,w){return Q(v,w)<0?v:w},this._IDBKeyRange=p._deps.IDBKeyRange,!this._IDBKeyRange)throw new F.MissingAPI})),this.on("versionchange",function(f){0<f.newVersion?console.warn("Another connection wants to upgrade database '".concat(n.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(n.name,"'. Closing db now to resume the delete request.")),n.close({disableAutoOpen:!1})}),this.on("blocked",function(f){!f.newVersion||f.newVersion<f.oldVersion?console.warn("Dexie.delete('".concat(n.name,"') was blocked")):console.warn("Upgrade '".concat(n.name,"' blocked by other connection holding version ").concat(f.oldVersion/10))}),this._maxKey=Mt(t.IDBKeyRange),this._createTransaction=function(f,k,h,v){return new n.Transaction(f,k,h,n._options.chromeTransactionDurability,v)},this._fireOnBlocked=function(f){n.on("blocked").fire(f),yt.filter(function(k){return k.name===n.name&&k!==n&&!k._state.vcFired}).map(function(k){return k.on("versionchange").fire(f)})},this.use(Mo),this.use(jo),this.use(No),this.use(Do),this.use(Ko);var g=new Proxy(this,{get:function(f,k,h){if(k==="_vip")return!0;if(k==="table")return function(w){return kn(n.table(w),g)};var v=Reflect.get(f,k,h);return v instanceof Gr?kn(v,g):k==="tables"?v.map(function(w){return kn(w,g)}):k==="_createTransaction"?function(){return kn(v.apply(this,arguments),g)}:v}});this.vip=g,r.forEach(function(f){return f(n)})}var _n,we=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Fo=(fr.prototype.subscribe=function(e,t,n){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:n})},fr.prototype[we]=function(){return this},fr);function fr(e){this._subscribe=e}try{_n={indexedDB:S.indexedDB||S.mozIndexedDB||S.webkitIndexedDB||S.msIndexedDB,IDBKeyRange:S.IDBKeyRange||S.webkitIDBKeyRange}}catch{_n={indexedDB:null,IDBKeyRange:null}}function hi(e){var t,n=!1,r=new Fo(function(i){var a=Ln(e),c,d=!1,p={},m={},g={get closed(){return d},unsubscribe:function(){d||(d=!0,c&&c.abort(),f&&je.storagemutated.unsubscribe(h))}};i.start&&i.start(g);var f=!1,k=function(){return Fn(v)},h=function(w){gn(p,w),ir(m,p)&&k()},v=function(){var w,y,_;!d&&_n.indexedDB&&(p={},w={},c&&c.abort(),c=new AbortController,_=function(E){var I=pt();try{a&&mt();var A=Me(e,E);return A=a?A.finally(Ne):A}finally{I&&ht()}}(y={subscr:w,signal:c.signal,requery:k,querier:e,trans:null}),Promise.resolve(_).then(function(E){n=!0,t=E,d||y.signal.aborted||(p={},function(I){for(var A in I)if(Y(I,A))return;return 1}(m=w)||f||(je(Kt,h),f=!0),Fn(function(){return!d&&i.next&&i.next(E)}))},function(E){n=!1,["DatabaseClosedError","AbortError"].includes(E==null?void 0:E.name)||d||Fn(function(){d||i.error&&i.error(E)})}))};return setTimeout(k,0),g});return r.hasValue=function(){return n},r.getValue=function(){return t},r}var at=Pe;function pr(e){var t=Fe;try{Fe=!0,je.storagemutated.fire(e),sr(e,!0)}finally{Fe=t}}oe(at,l(l({},Qt),{delete:function(e){return new at(e,{addons:[]}).delete()},exists:function(e){return new at(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return t=at.dependencies,n=t.indexedDB,t=t.IDBKeyRange,(tr(n)?Promise.resolve(n.databases()).then(function(r){return r.map(function(i){return i.name}).filter(function(i){return i!==an})}):er(n,t).toCollection().primaryKeys()).then(e)}catch{return re(new F.MissingAPI)}var t,n},defineClass:function(){return function(e){N(this,e)}},ignoreTransaction:function(e){return j.trans?nt(j.transless,e):e()},vip:nr,async:function(e){return function(){try{var t=cr(e.apply(this,arguments));return t&&typeof t.then=="function"?t:R.resolve(t)}catch(n){return re(n)}}},spawn:function(e,t,n){try{var r=cr(e.apply(n,t||[]));return r&&typeof r.then=="function"?r:R.resolve(r)}catch(i){return re(i)}},currentTransaction:{get:function(){return j.trans||null}},waitFor:function(e,t){return t=R.resolve(typeof e=="function"?at.ignoreTransaction(e):e).timeout(t||6e4),j.trans?j.trans.waitFor(t):t},Promise:R,debug:{get:function(){return Ee},set:function(e){Nr(e)}},derive:me,extend:N,props:oe,override:Se,Events:Lt,on:je,liveQuery:hi,extendObservabilitySet:gn,getByKeyPath:Be,setByKeyPath:ve,delByKeyPath:function(e,t){typeof t=="string"?ve(e,t,void 0):"length"in t&&[].map.call(t,function(n){ve(e,n,void 0)})},shallowClone:Pr,deepClone:Ye,getObjectDiff:ur,cmp:Q,asap:Et,minKey:-1/0,addons:[],connections:yt,errnames:Pn,dependencies:_n,cache:ot,semVer:"4.0.11",version:"4.0.11".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,2*n)})})),at.maxKey=Mt(at.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(je(Kt,function(e){Fe||(e=new CustomEvent(Wn,{detail:e}),Fe=!0,dispatchEvent(e),Fe=!1)}),addEventListener(Wn,function(e){e=e.detail,Fe||pr(e)}));var bt,Fe=!1,mi=function(){};return typeof BroadcastChannel<"u"&&((mi=function(){(bt=new BroadcastChannel(Wn)).onmessage=function(e){return e.data&&pr(e.data)}})(),typeof bt.unref=="function"&&bt.unref(),je(Kt,function(e){Fe||bt.postMessage(e)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(e){if(!Pe.disableBfCache&&e.persisted){Ee&&console.debug("Dexie: handling persisted pagehide"),bt!=null&&bt.close();for(var t=0,n=yt;t<n.length;t++)n[t].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(e){!Pe.disableBfCache&&e.persisted&&(Ee&&console.debug("Dexie: handling persisted pageshow"),mi(),pr({all:new ue(-1/0,[[]])}))})),R.rejectionMapper=function(e,t){return!e||e instanceof dt||e instanceof TypeError||e instanceof SyntaxError||!e.name||!Mr[e.name]?e:(t=new Mr[e.name](t||e.message,e),"stack"in e&&he(t,"stack",{get:function(){return this.inner.stack}}),t)},Nr(Ee),l(Pe,Object.freeze({__proto__:null,Dexie:Pe,liveQuery:hi,Entity:Vr,cmp:Q,PropModification:Ot,replacePrefix:function(e,t){return new Ot({replacePrefix:[e,t]})},add:function(e){return new Ot({add:e})},remove:function(e){return new Ot({remove:e})},default:Pe,RangeSet:ue,mergeRanges:qt,rangesOverlap:ii}),{default:Pe}),Pe})})(Pi);var $o=Pi.exports;const yr=zo($o),bi=Symbol.for("Dexie"),Tn=globalThis[bi]||(globalThis[bi]=yr);if(yr.semVer!==Tn.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${yr.semVer} and ${Tn.semVer}`);const{liveQuery:Vs,mergeRanges:Us,rangesOverlap:Ws,RangeSet:Gs,cmp:Ys,Entity:Qs,PropModification:Js,replacePrefix:Xs,add:Zs,remove:ec}=Tn,Ho="AnkiAppDB",Vo=2,vr=`# 新文件

开始编写您的内容...

使用 --内容-- 创建Cloze记忆卡片`,X=new Tn(Ho);X.version(Vo).stores({folders:"id, name, folderId",sessions:"id, name, folderId",clozeAccessTimes:"content",appState:"key",agents:"id, &name",topics:"id, title, agentId, createdAt",history:"id, topicId, timestamp"});async function Uo(){try{await X.open(),console.log("Database connection established.")}catch(o){console.error("Failed to open database:",o)}}const wi=10*60*1e3,Wo=2.5;function Go(o,s){const u=Date.now();let{interval:l=0,easeFactor:b=Wo,state:S="new"}=o;if(S==="new")switch(s){case 0:return{due:u+wi,interval:0,easeFactor:b,state:"learning"};case 1:return{due:u+1*24*3600*1e3,interval:1,easeFactor:b,state:"review"};case 2:return{due:u+3*24*3600*1e3,interval:3,easeFactor:b,state:"review"};case 3:return{due:u+5*24*3600*1e3,interval:5,easeFactor:b,state:"review"}}switch(s){case 0:return b=Math.max(1.3,b-.2),{due:u+wi,interval:0,easeFactor:b,state:"learning"};case 1:l=Math.max(1,l*1.2),b=Math.max(1.3,b-.15);break;case 2:break;case 3:b+=.15;break}const x=Math.max(1,l*b);return{due:u+x*24*3600*1e3,interval:x,easeFactor:b,state:"review"}}async function Yo(){const[o,s,u,l]=await Promise.all([X.sessions.toArray(),X.folders.toArray(),X.clozeAccessTimes.toArray(),X.appState.toArray()]),b=u.reduce((x,B)=>(x[B.content]=B.time,x),{}),S=l.reduce((x,B)=>(x[B.key]=B.value,x),{});return{sessions:o||[],folders:s||[],clozeAccessTimes:b||{},persistentAppState:S||{}}}async function Qo({sessions:o,folders:s,clozeAccessTimes:u,persistentAppState:l}){const b=[X.sessions,X.folders,X.clozeAccessTimes,X.appState];await X.transaction("rw",b,async()=>{const S=Object.entries(u).map(([Y,oe])=>({content:Y,time:oe})),x=Object.entries(l).map(([Y,oe])=>({key:Y,value:oe})),B=new Set(o.map(Y=>Y.id)),N=new Set(s.map(Y=>Y.id)),z=new Set(Object.keys(u)),ee=new Set(Object.keys(l));await Promise.all([X.sessions.where("id").noneOf(Array.from(B)).delete(),X.folders.where("id").noneOf(Array.from(N)).delete(),X.clozeAccessTimes.where("content").noneOf(Array.from(z)).delete(),X.appState.where("key").noneOf(Array.from(ee)).delete()]),await Promise.all([X.sessions.bulkPut(o),X.folders.bulkPut(s),X.clozeAccessTimes.bulkPut(S),X.appState.bulkPut(x)])})}async function Jo(){const[o,s,u]=await Promise.all([X.agents.toArray(),X.topics.toArray(),X.history.toArray()]);return{agents:o||[],topics:s||[],history:u||[]}}async function Xo({agents:o,topics:s,history:u}){await X.transaction("rw",X.agents,X.topics,X.history,async()=>{const l=new Set(o.map(x=>x.id)),b=new Set(s.map(x=>x.id)),S=new Set(u.map(x=>x.id));await Promise.all([X.agents.where("id").noneOf(Array.from(l)).delete(),X.topics.where("id").noneOf(Array.from(b)).delete(),X.history.where("id").noneOf(Array.from(S)).delete()]),await Promise.all([X.agents.bulkPut(o),X.topics.bulkPut(s),X.history.bulkPut(u)])})}function Ve(){return"id_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function Ue(o){return o?o.replace(/[&<>"']/g,s=>({"&":"&","<":"<",">":">",'"':'"',"'":"'"})[s]||s):""}function Zo(o){let s=0;for(let u=0;u<o.length;u++){const l=o.charCodeAt(u);s=(s<<5)-s+l,s|=0}return s.toString(36)}const Gt={火山:{adapter:"openAICompatible",baseURL:"https://ark.cn-beijing.volces.com/api/v3/",models:["deepseek-r1-250528","deepseek-v3-250324"]},deepseek:{adapter:"openAICompatible",baseURL:"https://api.deepseek.com/v1/chat/completions",models:["deepseek-reasoner","deepseek-chat"]},open_routers:{adapter:"openAICompatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",models:["anthropic/claude-opus-4","anthropic/claude-sonnet-4"]},gemini:{adapter:"gemini",baseURL:"https://generativelanguage.googleapis.com",models:["gemini-2.5-pro","gemini-2.5-flash"]},openai_compatible:{adapter:"openAICompatible",baseURL:"",models:[]}};function ea(o){var s;return((s=Gt[o])==null?void 0:s.models[0])||""}function ta(o){const s=Gt[o];return s?s.adapter==="openAICompatible"&&s.baseURL.endsWith("/")?`${s.baseURL}chat/completions`:s.baseURL:""}class Oi{constructor(s){this.config=s}async chatStream(s,{onChunk:u,onDone:l,onError:b}){throw new Error("Adapter must implement chatStream method.")}_preparePayload(s){throw new Error("Adapter must implement _preparePayload method.")}}class na extends Oi{_preparePayload(s){return{model:this.config.model,messages:s,stream:!0}}async chatStream(s,{onChunk:u,onDone:l,onError:b}){var x;const S=this._preparePayload(s);try{const B=await fetch(this.config.apiPath,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(S)});if(!B.ok){const ee=await B.text();throw new Error(`API Error: ${B.status} ${B.statusText} - ${ee}`)}const N=B.body.getReader(),z=new TextDecoder("utf-8");for(;;){const{done:ee,value:Y}=await N.read();if(ee){l();break}const ut=z.decode(Y).split(`
`).filter(he=>he.trim().startsWith("data:"));for(const he of ut){const me=he.replace(/^data: /,"").trim();if(me==="[DONE]"){l();return}try{const Ge=(x=JSON.parse(me).choices[0])==null?void 0:x.delta;if(Ge){const _e=Ge.content;_e&&u({type:"content",text:_e});const Se=Ge.reasoning_content;if(Se){const Te=`<thinking>${Se}</thinking>`;u({type:"thinking",text:Te})}}}catch(De){console.error("Error parsing stream data chunk:",me,De)}}}}catch(B){console.error("LLM Stream Error:",B),b(B)}}}class ra extends Oi{_preparePayload(s){return{contents:s.map(l=>({role:l.role==="assistant"?"model":"user",parts:[{text:l.content}]}))}}async chatStream(s,{onChunk:u,onDone:l,onError:b}){var B,N,z,ee,Y;const S=this._preparePayload(s),x=`${this.config.apiPath}/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`;try{const oe=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)});if(!oe.ok){const De=await oe.text();throw new Error(`API Error: ${oe.status} ${oe.statusText} - ${De}`)}const ut=oe.body.getReader(),he=new TextDecoder("utf-8");let me="";for(;;){const{done:De,value:Ge}=await ut.read();if(De){l();break}me+=he.decode(Ge,{stream:!0});const _e=me.split(`
`);me=_e.pop();for(const Se of _e)if(!(Se.trim().startsWith("[")||Se.trim().startsWith(","))&&!Se.trim().endsWith("]"))try{const Et=((Y=(ee=(z=(N=(B=JSON.parse(Se).candidates)==null?void 0:B[0])==null?void 0:N.content)==null?void 0:z.parts)==null?void 0:ee[0])==null?void 0:Y.text)||"";Et&&u(Et)}catch{}}}catch(oe){console.error("Gemini Stream Error:",oe),b(oe)}}}const ki={openAICompatible:na,gemini:ra};function ia(o){const s=Gt[o];if(!s||!ki[s.adapter])throw new Error(`Unsupported provider or adapter: ${o}`);return ki[s.adapter]}async function oa(o,s,u){const l=ia(o.provider),b=new l(o),S=[];o.systemPrompt&&S.push({role:"system",content:o.systemPrompt}),s.forEach(x=>{S.push({role:x.role,content:x.content})}),await b.chatStream(S,u)}const In=ce(".ai-agent-nav .agent-list");ce(".agent-content-container .topics-panel");ce(".agent-content-container .history-panel");const xn=ce(".agent-content-container .topic-list"),ye=ce(".agent-content-container .history-content"),En=ce(".chat-input-area"),An=ce("#chatInput"),aa=ce("#sendMessageBtn");ce("#attachFileBtn");const sa=ce("#attachmentInput"),gr=ce("#attachmentPreview");function ca(o){const s=o.id===T.currentAgentId,u=document.createElement("div");return u.className=`agent-item ${s?"active":""}`,u.dataset.agentId=o.id,u.innerHTML=`
        <div class="agent-avatar">${Ue(o.avatar)}</div>
        <span>${Ue(o.displayName)}</span>
    `,u}function ua(o){const s=o.id===T.currentTopicId,u=document.createElement("li");return u.className=`topic-item ${s?"active":""}`,u.dataset.topicId=o.id,u.innerHTML=`
        <div class="topic-icon"><i class="${Ue(o.icon)}"></i></div>
        <span>${Ue(o.title)}</span>
    `,u}function la(o){if(!o)return"";const s=o.replace(/<\/thinking>\s*<thinking>/gi," "),u=/<thinking>([\s\S]*?)<\/thinking>/gi;return s.replace(u,`<details class="thinking-block">
            <summary>AI 思考过程</summary>
            <pre><code class="language-text">$1</code></pre>
         </details>`)}function da(o){const s=document.createElement("div");s.className=`history-item role-${o.role}`,s.dataset.messageId=o.id;let u="",l="";o.role==="assistant"?o.status==="streaming"?(u=`
                <details class="thinking-block" open>
                    <summary>AI 思考过程</summary>
                    <pre><code class="language-text streaming-reasoning-container"></code></pre>
                </details>
            `,l='<div class="streaming-content-container"><p><i class="fas fa-spinner fa-pulse"></i></p></div>'):(o.reasoning&&o.reasoning.trim()&&(u=la(o.reasoning)),l=marked.parse(o.content||"")):l=marked.parse(o.content||"");const b=(o.images||[]).map(x=>`<img src="${x}" alt="Uploaded image" class="history-image">`).join("");s.innerHTML=`
        <div class="history-item-header">
            <span class="role ${o.role}">${o.role==="user"?"用户":"AI助手"}</span>
            <span>${new Date(o.timestamp).toLocaleString()}</span>
        </div>
        <div class="history-item-content">
            ${u}
            ${l}
            <div class="image-previews">${b}</div>
        </div>
        <div class="history-item-actions">
            <button class="history-action-btn regenerate-btn" title="重新生成"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" title="编辑"><i class="fas fa-edit"></i> 编辑</button>
            <button class="history-action-btn delete-btn" title="删除"><i class="fas fa-trash"></i> 删除</button>
        </div>
    `;const S=s.querySelector(".history-item-actions");return o.role==="user"?S.querySelector(".regenerate-btn").style.display="none":S.querySelector(".edit-btn").style.display="none",o.status==="streaming"&&(S.style.display="none"),s}function ct(){fa(),ha(),Vt()}function fa(){In.innerHTML="",T.agents.forEach(s=>{In.appendChild(ca(s))});const o=document.createElement("div");o.className="agent-item add-agent-btn",o.innerHTML='<div class="agent-avatar">+</div><span>添加Agent</span>',In.appendChild(o)}function pa(){const o=document.getElementById("historyHeaderTitle"),s=document.getElementById("agentSettingsTriggerBtn"),u=Cr(T.currentAgentId);u?(o.textContent=`${u.displayName} - 对话记录`,s.style.display="flex"):(o.textContent="历史对话记录",s.style.display="none")}function ha(){xn.innerHTML="",T.topics.filter(u=>u.agentId===T.currentAgentId).forEach(u=>{xn.appendChild(ua(u))});const s=document.createElement("li");s.className="topic-item add-topic-btn",s.innerHTML='<div class="topic-icon"><i class="fas fa-plus-circle"></i></div><span>添加新主题</span>',xn.appendChild(s)}function Vt(){pa();const o=ye.scrollHeight-ye.clientHeight<=ye.scrollTop+1;if(ye.innerHTML="",!T.currentTopicId){ye.innerHTML='<div class="no-history"><i class="fas fa-comments"></i><p>请选择或创建一个主题来开始聊天</p></div>',En&&(En.style.display="none");return}En&&(En.style.display="flex");const s=T.history.filter(u=>u.topicId===T.currentTopicId).sort((u,l)=>new Date(u.timestamp)-new Date(l.timestamp));if(s.length===0){ye.innerHTML='<div class="no-history"><i class="fas fa-comment-dots"></i><p>这个主题还没有对话记录，开始提问吧！</p></div>';return}s.forEach(u=>{(u.status!=="streaming"||u.content.length>0||T.isAiThinking)&&ye.appendChild(da(u))}),o&&(ye.scrollTop=ye.scrollHeight),ya()}function Ar(o){gr.innerHTML="",o.forEach((s,u)=>{const l=document.createElement("div");l.className="attachment-preview-item",l.innerHTML=`
            <span><i class="fas fa-file-image"></i> ${Ue(s.name)}</span>
            <button class="remove-attachment-btn" data-index="${u}">×</button>
        `,gr.appendChild(l)})}function ma(o,s,u){const l=document.querySelector(`.history-item[data-message-id="${o}"]`);if(!l)return;let b;s==="thinking"?(b=l.querySelector(".streaming-reasoning-container"),u=u.replace(/<\/?thinking>/g,"")):s==="content"&&(b=l.querySelector(".streaming-content-container"),b.querySelector(".fa-spinner")&&(b.innerHTML="")),b&&(b.innerText+=u,ye.scrollTop=ye.scrollHeight)}function _i(o){const s=document.querySelector(`.history-item[data-message-id="${o}"]`);if(!s)return;const u=s.querySelector(".thinking-block");u&&u.removeAttribute("open");const l=s.querySelector(".history-item-actions");l&&(l.style.display="flex")}function ya(){const o=document.getElementById("chatNavUp"),s=document.getElementById("chatNavDown"),u=ye.querySelector(".history-item .role.user");o&&s&&(o.disabled=!u,s.disabled=!u)}function Di(o){const s=/^(#{1,2})\s+(.+)$/gm,u=[];let l;for(;(l=s.exec(o))!==null;){const b={level:l[1].length,text:l[2].trim(),start:l.index,end:l.index+l[0].length,content:""};u.push(b)}for(let b=0;b<u.length;b++){const S=u[b].end+1,x=b<u.length-1?u[b+1].start:o.length;u[b].content=o.substring(S,x).trim()}return u}function Tr(o,s){const l=Di(s).filter(S=>S.level===1||S.level===2).map(S=>({id:Ve(),parentId:o,title:S.text,content:`# ${S.text}

${S.content}`,level:S.level})),b={...T.fileSubsessions,[o]:l};W({fileSubsessions:b})}async function va(){W({isLoading:!0});try{const{sessions:o,folders:s,clozeStates:u,persistentAppState:l}=await Yo(),b={sessions:o||[],folders:s||[],clozeStates:u||{},currentSessionId:l.currentSessionId||null,currentFolderId:l.currentFolderId||null,currentSubsessionId:l.currentSubsessionId||null,folderStack:l.folderStack||[],fileSubsessions:{}};if(b.sessions.forEach(S=>{const x=Di(S.content).filter(B=>B.level===1||B.level===2).map(B=>({id:Ve(),parentId:S.id,title:B.text,content:`# ${B.text}

${B.content}`,level:B.level}));b.fileSubsessions[S.id]=x}),b.sessions.length===0){const S=Ve();b.sessions.push({id:S,name:"初始会话",content:vr,type:"file",folderId:null,createdAt:new Date}),b.currentSessionId=S,Tr(S,vr)}b.sessions.some(S=>S.id===b.currentSessionId)||(b.currentSessionId=b.sessions.length>0?b.sessions[0].id:null),W(b)}catch(o){console.error("Failed to initialize application state:",o)}finally{W({isLoading:!1})}}async function We(){try{await Qo({sessions:T.sessions,folders:T.folders,clozeStates:T.clozeStates,persistentAppState:{currentSessionId:T.currentSessionId,currentFolderId:T.currentFolderId,currentSubsessionId:T.currentSubsessionId,folderStack:T.folderStack}}),console.log("State persisted successfully.")}catch(o){console.error("Failed to persist state:",o)}}async function Ki(o,s=vr){const u=Ve(),l={id:u,name:o||`新文件 ${T.sessions.length+1}`,content:s,type:"file",folderId:T.currentFolderId,createdAt:new Date},b=[...T.sessions,l];W({sessions:b,currentSessionId:u,currentSubsessionId:null}),Tr(u,s),await We()}async function ga(o){const s={id:Ve(),name:o||`新目录 ${T.folders.length+1}`,type:"folder",folderId:T.currentFolderId,createdAt:new Date},u=[...T.folders,s];W({folders:u}),await We()}async function Mi(o){const s=new Set(o.map(x=>x.id));let u=[...T.sessions],l=[...T.folders],b={...T.fileSubsessions};o.forEach(x=>{if(x.type==="file")u=u.filter(B=>B.id!==x.id),delete b[x.id];else if(x.type==="folder"){const B=new Set([x.id]);let N=!0;for(;N;)N=!1,l.filter(ee=>B.has(ee.folderId)).forEach(ee=>{B.has(ee.id)||(B.add(ee.id),N=!0)});l=l.filter(z=>!B.has(z.id)),u=u.filter(z=>!B.has(z.folderId))}});let S=T.currentSessionId;s.has(S)&&(S=u.length>0?u[0].id:null),W({sessions:u,folders:l,fileSubsessions:b,currentSessionId:S}),await We()}async function ba(o,s){const u=T.sessions.map(b=>o.some(S=>S.id===b.id&&S.type==="file")?{...b,folderId:s}:b),l=T.folders.map(b=>o.some(S=>S.id===b.id&&S.type==="folder")?{...b,folderId:s}:b);W({sessions:u,folders:l}),await We()}async function wa(o,s,u){if(u==="file"){const l=T.sessions.map(b=>b.id===o?{...b,name:s}:b);W({sessions:l})}else{const l=T.folders.map(b=>b.id===o?{...b,name:s}:b);W({folders:l})}await We()}async function ka(o){const s=Ni();if(s&&s.content!==o){const u=T.sessions.map(l=>l.id===T.currentSessionId?{...l,content:o,lastActive:new Date}:l);return W({sessions:u}),Tr(T.currentSessionId,o),await We(),!0}return!1}function Ni(){return T.currentSessionId?T.sessions.find(o=>o.id===T.currentSessionId):null}function _a(o){W({currentSessionId:o,currentSubsessionId:null})}function Sa(o){const s=[...T.folderStack,T.currentFolderId].filter(u=>u!=null);W({currentFolderId:o,folderStack:s})}function Ea(o,s){W({currentSessionId:o,currentSubsessionId:s})}function Ia(){if(T.folderStack.length>0){const o=[...T.folderStack],s=o.pop();W({currentFolderId:s,folderStack:o})}}function xa(o,s){const u=T.folderStack.slice(0,s);W({currentFolderId:o,folderStack:u})}function Aa(){W({currentFolderId:null,folderStack:[]})}function Br(o,s){const u=`${o}_${Zo(s)}`,l=T.clozeStates;return l[u]?l[u]:{id:u,fileId:o,content:s,state:"new",due:Date.now(),interval:0,easeFactor:2.5,lastReview:null}}function Ta(o,s,u){const l=Br(o,s),b=Go(l,u),S=T.clozeStates;S[l.id]={...l,...b,lastReview:Date.now()},W({clozeStates:S})}async function Ba(){const{agents:o,topics:s,history:u}=await Jo(),l={agents:o||[],topics:s||[],history:u||[]};if(l.agents.length>0){l.currentAgentId=l.agents[0].id;const b=l.topics.find(S=>S.agentId===l.currentAgentId);b&&(l.currentTopicId=b.id)}W(l)}async function Ae(){try{await Xo({agents:T.agents,topics:T.topics,history:T.history}),console.log("Agent state persisted.")}catch(o){console.error("Failed to persist agent state:",o)}}function Cr(o){if(o)return T.agents.find(s=>s.id===o)}async function Ca(o){const s=o.displayName.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");let u=s,l=1;for(;T.agents.some(x=>x.name===u);)u=`${s}_${l++}`;const b={id:Ve(),name:u,displayName:o.displayName,avatar:o.avatar,config:o.config},S=[...T.agents,b];return W({agents:S,currentAgentId:b.id,currentTopicId:null}),await Ae(),b}async function La(o,s){const u=T.agents.map(l=>l.id===o?{...l,...s}:l);W({agents:u}),await Ae()}async function Pa(o){const s=T.topics.filter(N=>N.agentId===o),u=new Set(s.map(N=>N.id)),l=T.history.filter(N=>!u.has(N.topicId)),b=T.topics.filter(N=>N.agentId!==o),S=T.agents.filter(N=>N.id!==o);let x=T.currentAgentId,B=T.currentTopicId;if(x===o){x=S.length>0?S[0].id:null;const N=b.find(z=>z.agentId===x);B=N?N.id:null}W({agents:S,topics:b,history:l,currentAgentId:x,currentTopicId:B}),await Ae()}async function Oa(o,s){if(!T.currentAgentId){alert("Please select an AI Agent first.");return}const u={id:Ve(),agentId:T.currentAgentId,title:o,icon:"fas fa-comment",createdAt:new Date},l=[...T.topics,u];W({topics:l,currentTopicId:u.id}),await Ae()}async function Si(o,s,u,l=[],b="completed",S=null){const x={id:Ve(),topicId:o,role:s,content:u,reasoning:S,images:l,timestamp:new Date().toISOString(),status:b},B=[...T.history,x];return W({history:B}),b!=="streaming"&&await Ae(),x}async function Da(o,s){if(!T.currentTopicId||T.isAiThinking)return;const u=T.currentTopicId,l=Cr(T.currentAgentId);if(!l){alert("错误：找不到当前Agent的配置。");return}W({isAiThinking:!0}),await Si(u,"user",o,[]),Vt();const b=await Si(u,"assistant","",[],"streaming","");Vt();let S="",x="";const B=T.history.filter(N=>N.topicId===u&&N.status==="completed");await oa(l.config,B,{onChunk:({type:N,text:z})=>{N==="content"?S+=z:N==="thinking"&&(x+=z),ma(b.id,N,z)},onDone:async()=>{const N=T.history.map(z=>z.id===b.id?{...z,content:S,reasoning:x,status:"completed"}:z);_i(b.id),W({history:N,isAiThinking:!1}),await Ae()},onError:async N=>{const z=`

**错误:** ${N.message}`;S+=z,_i(b.id);const ee=T.history.map(Y=>Y.id===b.id?{...Y,content:S,reasoning:x,status:"error"}:Y);W({history:ee,isAiThinking:!1}),await Ae()}})}async function Ka(o){const s=new Set(o),u=T.history.filter(l=>!s.has(l.id));W({history:u}),await Ae()}async function Ma(o,s){console.log(`Editing message ${o} with content: ${s}`)}function Na(o){const s=T.topics.find(u=>u.agentId===o);W({currentAgentId:o,currentTopicId:s?s.id:null})}function Ra(o){W({currentTopicId:o})}function br(o){(o==="anki"||o==="agent")&&W({activeView:o})}const ke=G("editor"),ze=G("preview"),$e=G("sessionList"),qa=G("emptySession"),wt=G("currentFolderContainer"),wr=G("fileInput"),ja=G("newFileBtn"),Fa=G("newFolderBtn"),za=G("openFileBtn"),kr=G("saveBtn");G("exportFileBtn");const $a=G("deleteSelectedBtn"),Ha=G("moveSelectedBtn"),Va=G("helpBtn"),Ei=G("toggleSessionBtn"),_r=G("toggleEditorBtn"),Ri=G("clozeBtn"),qi=G("boldBtn"),ji=G("italicBtn"),Fi=G("codeBtn"),zi=G("linkBtn"),Ua=G("audioBtn"),$i=G("insertLinebreakBtn"),Ii=ce(".session-sidebar"),xi=G("editorPanel"),Hi=G("selectAllCheckbox"),Vi=G("moveModal"),$t=G("folderList"),Wa=G("closeMoveModalBtn"),Ga=G("confirmMoveBtn"),Ya=G("cancelMoveBtn"),Ui=G("audioControls"),Qa=G("audioTitle"),Wi=G("audioProgress"),Ja=G("playBtn"),Xa=G("pauseBtn"),Za=G("stopBtn"),es=ce(".session-title"),ts=ce(".instructions"),zt=G("toggleVisibilityClozeBtn"),ns=G("invertClozeBtn");let Oe;function Ai(o,s){const u=document.createElement("a");return u.href="#",u.className="breadcrumb-link",u.innerHTML=o,u.addEventListener("click",l=>{l.preventDefault(),s()}),u}function rs(o,s,u){wt.innerHTML="";const l=Ai('<i class="fas fa-folder-open"></i> 根目录',u);if(wt.appendChild(l),T.folderStack.forEach((b,S)=>{const x=document.createElement("span");x.className="breadcrumb-separator",x.textContent=">",wt.appendChild(x);const B=T.folders.find(N=>N.id===b);if(B){const N=Ai(B.name,()=>s(b,S));wt.appendChild(N)}}),T.currentFolderId){const b=T.folders.find(S=>S.id===T.currentFolderId);if(b){const S=document.createElement("span");S.className="breadcrumb-separator",S.textContent=">",wt.appendChild(S);const x=document.createElement("span");x.className="breadcrumb-current",x.textContent=b.name,wt.appendChild(x)}}Oe.style.display=T.folderStack.length>0?"inline-flex":"none"}function is(o){Oe=document.createElement("button"),Oe.id="backButton",Oe.className="session-btn",Oe.title="返回上级目录",Oe.innerHTML='<i class="fas fa-arrow-left"></i>',Oe.style.display="none",Oe.addEventListener("click",o),es.prepend(Oe)}let _t=null,Ut=null;function Gi(){if(!_t||!_t.startTime)return;const o=(Date.now()-_t.startTime)/1e3,s=_t.text.length/10,u=Math.min(100,o/s*100);Wi.style.width=`${u}%`}function mr(o){if(!("speechSynthesis"in window)){alert("抱歉，您的浏览器不支持语音合成。");return}Sr();const s=new SpeechSynthesisUtterance(o);s.lang="en-US",s.rate=1,s.onstart=()=>{s.startTime=Date.now(),Ut=setInterval(Gi,100)},s.onend=()=>{Sr()},_t=s,Qa.textContent=`正在播放: ${o.substring(0,30)}${o.length>30?"...":""}`,Ui.style.display="block",window.speechSynthesis.speak(s)}function os(){window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),clearInterval(Ut))}function as(){window.speechSynthesis.paused&&(window.speechSynthesis.resume(),Ut=setInterval(Gi,100))}function Sr(){window.speechSynthesis.cancel(),Ut&&clearInterval(Ut),Ui.style.display="none",Wi.style.width="0%",_t=null}function Yi(o){const s=Date.now();if(o.due>s){const u=(o.due-s)/864e5;return u<1?"cloze-1d":u<2?"cloze-2d":u<3?"cloze-3d":u<5?"cloze-5d":u<7?"cloze-7d":u<14?"cloze-14d":"cloze-28d"}return o.lastReview&&s-o.lastReview<15*60*1e3&&o.interval===0?"cloze-10m":"cloze-28plus"}function Qi(o){if(o.nodeType===Node.TEXT_NODE){const s=/--(.*?)--(?:\^\^audio:(.*?)\^\^)?/g,u=o.parentNode;if(!u||["CODE","PRE","SCRIPT","STYLE"].includes(u.tagName))return;let l;const b=[];let S=0;for(;(l=s.exec(o.nodeValue))!==null;){l.index>S&&b.push(document.createTextNode(o.nodeValue.substring(S,l.index)));const x=l[1],B=x.replace(/¶/g,"<br>"),N=l[2]?l[2].trim():null,z=T.currentSessionId,ee=Br(z,x),Y=document.createElement("span");Y.className=`cloze hidden ${Yi(ee)}`,Y.dataset.content=x,N&&(Y.dataset.multimedia=N),Y.innerHTML=`
                ${N?'<span class="media-icon" title="播放音频"><i class="fas fa-volume-up"></i></span>':""}
                <span class="cloze-content">${B}</span>
                <span class="placeholder">[...]</span>
                <div class="cloze-actions" style="display: none;">
                    <button class="cloze-btn again" data-rating="0">重来</button>
                    <button class="cloze-btn hard" data-rating="1">困难</button>
                    <button class="cloze-btn good" data-rating="2">良好</button>
                    <button class="cloze-btn easy" data-rating="3">简单</button>
                </div>
            `,b.push(Y),S=s.lastIndex}b.length>0&&(S<o.nodeValue.length&&b.push(document.createTextNode(o.nodeValue.substring(S))),b.forEach(x=>u.insertBefore(x,o)),u.removeChild(o))}else o.nodeType===Node.ELEMENT_NODE&&Array.from(o.childNodes).forEach(s=>Qi(s))}function ss(){ze.addEventListener("click",o=>{var u;const s=o.target.closest(".cloze");if(s){if(o.target.closest(".cloze-btn")){o.stopPropagation();const l=o.target.closest(".cloze-btn"),b=parseInt(l.dataset.rating,10),S=T.currentSessionId,x=s.dataset.content;clearTimeout(s.closeTimer),Ta(S,x,b);const B=Br(S,x),N=Yi(B);(u=s.className.match(/cloze-(\w+)/g))==null||u.forEach(z=>s.classList.remove(z)),s.classList.add(N),s.querySelector(".cloze-actions").style.display="none",b===3?(s.classList.remove("hidden","permanent-view"),s.classList.add("easy-open")):(s.classList.add("hidden"),s.classList.remove("easy-open","permanent-view"));return}if(o.target.closest(".media-icon")){o.stopPropagation(),mr(s.dataset.multimedia);return}s.classList.contains("hidden")&&!s.classList.contains("permanent-view")&&(clearTimeout(s.closeTimer),s.classList.remove("hidden"),s.querySelector(".cloze-actions").style.display="flex",s.dataset.multimedia&&mr(s.dataset.multimedia),s.closeTimer=setTimeout(()=>{!s.classList.contains("easy-open")&&!s.classList.contains("permanent-view")&&(s.classList.add("hidden"),s.querySelector(".cloze-actions").style.display="none")},6e4))}}),ze.addEventListener("dblclick",o=>{const s=o.target.closest(".cloze");s&&(o.stopPropagation(),clearTimeout(s.closeTimer),s.classList.contains("hidden")?(s.classList.remove("hidden"),s.classList.add("permanent-view"),s.dataset.multimedia&&mr(s.dataset.multimedia),s.querySelector(".cloze-actions").style.display="none"):(s.classList.add("hidden"),s.classList.remove("permanent-view","easy-open"),s.querySelector(".cloze-actions").style.display="none"))})}function cs(){const o=!T.areAllClozeVisible;ze.querySelectorAll(".cloze").forEach(s=>{clearTimeout(s.timer),o?(s.classList.remove("hidden","temporary"),s.classList.add("permanent")):(s.classList.remove("permanent","temporary"),s.classList.add("hidden"))}),Ji(o),W({areAllClozeVisible:o})}function us(){let o=!0;ze.querySelectorAll(".cloze").forEach(s=>{clearTimeout(s.timer),s.classList.contains("hidden")?(s.classList.remove("hidden"),s.classList.add("permanent")):(s.classList.remove("permanent","temporary"),s.classList.add("hidden"),o=!1)}),Ji(o),W({areAllClozeVisible:o})}function Ji(o){o?(zt.innerHTML='<i class="fas fa-eye"></i>',zt.title="全部隐藏"):(zt.innerHTML='<i class="fas fa-eye-slash"></i>',zt.title="全部显示")}function Xi(){var x;const{currentSessionId:o,currentSubsessionId:s,fileSubsessions:u,sessions:l}=T,b=l.find(B=>B.id===o);if(!b){ze.innerHTML="";return}let S=b.content;if(s){const B=(x=u[o])==null?void 0:x.find(N=>N.id===s);B&&(S=B.content)}ze.innerHTML=window.marked.parse(S||""),Qi(ze),window.MathJax&&window.MathJax.typesetPromise([ze]).catch(B=>console.log("MathJax error:",B))}function ls(){window.marked.setOptions({breaks:!0}),ss()}function ds(o){const s=document.createElement("li");return s.className=`session-item ${o.type} ${o.id===T.currentSessionId?"active":""}`,s.dataset.id=o.id,s.dataset.type=o.type,s.innerHTML=`
        <div class="name-container">
            <input type="checkbox" class="select-checkbox" data-id="${o.id}" data-type="${o.type}">
            <span class="name">
                <i class="${o.type==="folder"?"fas fa-folder folder-icon":"fas fa-file file-icon"}"></i>
                <span class="item-name">${Ue(o.name)}</span>
            </span>
        </div>
        <div class="actions">
            <span class="move-btn" title="移动"><i class="fas fa-arrows-alt"></i></span>
            <span class="edit-btn" title="编辑"><i class="fas fa-pencil-alt"></i></span>
            <span class="delete-btn" title="删除"><i class="fas fa-trash"></i></span>
        </div>
    `,s}function fs(o){const s=document.createElement("li");return s.className=`session-item subsession ${o.id===T.currentSubsessionId?"active":""}`,s.dataset.id=o.id,s.dataset.parent=o.parentId,s.innerHTML=`
        <div class="name-container">
            <span class="name">
                <i class="fas fa-stream"></i>
                ${Ue(o.title)}
            </span>
        </div>`,s}function ps(){$e.innerHTML="";const{sessions:o,folders:s,currentFolderId:u,fileSubsessions:l,currentSessionId:b}=T,S=[...s.filter(x=>x.folderId===u),...o.filter(x=>x.folderId===u)].sort((x,B)=>x.type==="folder"&&B.type==="file"?-1:x.type==="file"&&B.type==="folder"?1:x.name.localeCompare(B.name));qa.style.display=S.length===0&&u===null?"block":"none",S.length===0&&u!==null&&($e.innerHTML='<li class="empty-folder"><div class="empty-message"><i class="fas fa-inbox"></i> 此目录为空</div></li>'),S.forEach(x=>{var N;const B=ds(x);if($e.appendChild(B),x.type==="file"&&x.id===b&&((N=l[x.id])==null?void 0:N.length)>0){const z=document.createElement("ul");z.className="nested-items",l[x.id].forEach(ee=>{z.appendChild(fs(ee))}),$e.appendChild(z)}})}function pe(){ps(),rs(no,ys,vs);const o=Ni(),s=o?o.content:"";ke.value!==s&&(ke.value=s),Xi()}let St=[],Ht=-1;function Ti(o=null){let s=Object.values(T.clozeStates),u;if(o?(console.log("Starting custom study with filters:",o),u=s.filter(l=>{if(o.fileOrFolder!=="all"){const[B,N]=o.fileOrFolder.split("_");if(B==="file"){if(l.fileId!==N)return!1}else if(B==="folder"&&!T.sessions.find(ee=>ee.id===l.fileId&&ee.folderId===N))return!1}if(!o.cardStates.includes(l.state))return!1;const b=Date.now(),S=l.lastReview||0,x=(b-S)/(1e3*60*60*24);switch(o.lastReview){case"last7days":if(S===0||x>7)return!1;break;case"last30days":if(S===0||x>30)return!1;break;case"over30days":if(S!==0&&x<=30)return!1;break;case"never":if(S!==0)return!1;break}return!0}),u.sort(()=>Math.random()-.5),St=u.slice(0,o.maxCards)):(console.log("Starting automatic review."),St=s.filter(l=>l.due<=Date.now()).sort((l,b)=>l.due-b.due)),St.length===0){alert("没有找到符合条件的卡片。");return}Ht=0,Zi()}function Zi(){if(Ht>=St.length){alert("复习会话结束！"),St=[],Ht=-1,pe();return}const o=St[Ht];T.currentSessionId!==o.fileId&&(W({currentSessionId:o.fileId}),pe()),setTimeout(()=>{document.querySelectorAll(".highlight-review").forEach(u=>u.classList.remove("highlight-review"));const s=document.querySelector(`.cloze[data-content="${o.content}"]`);s?(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("highlight-review"),s.classList.contains("hidden")&&s.click()):(console.error("Could not find cloze element for review:",o),hs())},T.currentSessionId!==o.fileId?300:50)}function hs(){Ht++,Zi()}function eo(o){let s=[];const u=T.folders.filter(l=>l.folderId===o);for(const l of u)s.push(l.id),s=s.concat(eo(l.id));return s}function to(){$t.innerHTML="";const o=T.movingItems.filter(l=>l.type==="folder").map(l=>l.id),s=new Set(o);o.forEach(l=>{eo(l).forEach(b=>s.add(b))});const u=document.createElement("div");u.className="folder-item",u.dataset.id="root",u.innerHTML='<i class="fas fa-folder-open"></i> 根目录',$t.appendChild(u),T.folders.forEach(l=>{if(!s.has(l.id)){const b=document.createElement("div");b.className="folder-item",b.dataset.id=l.id,b.innerHTML=`<i class="fas fa-folder"></i> ${Ue(l.name)}`,$t.appendChild(b)}}),Vi.classList.add("active")}function Er(){Vi.classList.remove("active"),W({movingItems:[],selectedMoveTarget:null})}function ms(o){Wa.addEventListener("click",Er),Ya.addEventListener("click",Er),Ga.addEventListener("click",o),$t.addEventListener("click",s=>{const u=s.target.closest(".folder-item");if(!u)return;$t.querySelectorAll(".folder-item").forEach(b=>b.classList.remove("selected")),u.classList.add("selected");const l=u.dataset.id==="root"?null:u.dataset.id;W({selectedMoveTarget:l})})}function no(){Ia(),pe()}function ys(o,s){xa(o,s),pe()}function vs(){Aa(),pe()}async function gs(){const o=prompt("请输入新文件的名称：","新文件");o!==null&&(await Ki(o.trim()),pe(),ke.focus())}async function bs(){const o=prompt("请输入新目录的名称：","新目录");o!==null&&(await ga(o.trim()),pe())}async function ro(){await ka(ke.value)&&(kr.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>kr.innerHTML='<i class="fas fa-save"></i> 保存',2e3),pe())}async function ws(o){const s=o.target.closest(".session-item");if(!s)return;const{id:u,type:l,parent:b}=s.dataset,S=o.target.closest(".actions span");if(S){if(o.stopPropagation(),S.classList.contains("delete-btn"))confirm(`确定删除此 ${l==="file"?"文件":"目录"}?`)&&(await Mi([{id:u,type:l}]),pe());else if(S.classList.contains("edit-btn")){const x=prompt("输入新名称:",s.querySelector(".item-name").textContent);x&&x.trim()&&(await wa(u,x.trim(),l),pe())}else S.classList.contains("move-btn")&&(W({movingItems:[{id:u,type:l}]}),to());return}l==="file"?_a(u):l==="folder"?Sa(u):s.classList.contains("subsession")&&Ea(b,u),pe()}async function ks(){T.selectedMoveTarget!==void 0&&T.movingItems.length>0?(await ba(T.movingItems,T.selectedMoveTarget),Er(),pe()):alert("请选择一个目标目录。")}async function _s(){const o=Array.from($e.querySelectorAll(".select-checkbox:checked")).map(s=>({id:s.dataset.id,type:s.dataset.type}));if(o.length===0)return alert("请先选择要删除的项目。");confirm(`确定要删除选中的 ${o.length} 个项目吗？`)&&(await Mi(o),Hi.checked=!1,pe())}function Lr(){clearTimeout(window.previewDebounce),window.previewDebounce=setTimeout(Xi,300)}async function Ss(o){const s=o.target.files[0];if(!s)return;const u=new FileReader;u.onload=async l=>{await Ki(s.name,l.target.result),pe()},u.readAsText(s),wr.value=""}function jt(o,s=o){const{selectionStart:u,selectionEnd:l,value:b}=ke,S=b.substring(u,l),x=`${o}${S}${s}`;ke.setRangeText(x,u,l,"select"),Lr(),ke.focus()}function Es(o){const{selectionStart:s,selectionEnd:u}=ke;ke.setRangeText(o,s,u,"end"),Lr(),ke.focus()}function Is(){xi.classList.toggle("collapsed");const o=xi.classList.contains("collapsed");_r.innerHTML=o?'<i class="fas fa-chevron-down"></i>':'<i class="fas fa-chevron-up"></i>',_r.title=o?"展开编辑器":"收起编辑器",[Ri,qi,ji,Fi,zi,Ua,$i].forEach(s=>s.disabled=o),o&&ro()}function xs(){const{sessions:o,folders:s}=T,u=document.getElementById("filterByFile");u.innerHTML='<option value="all">所有文件</option>',s.forEach(l=>{const b=document.createElement("option");b.value=`folder_${l.id}`,b.textContent=`目录: ${l.name}`,u.appendChild(b)}),o.forEach(l=>{const b=document.createElement("option");b.value=`file_${l.id}`,b.textContent=`文件: ${l.name}`,u.appendChild(b)})}function As(){const o=document.getElementById("reviewOptionsBtn"),s=document.getElementById("reviewDropdownMenu"),u=document.getElementById("customStudyBtn"),l=document.getElementById("customStudyModal"),b=document.getElementById("customStudyCloseBtn"),S=document.getElementById("customStudyCancelBtn"),x=document.getElementById("customStudyForm");document.getElementById("startReviewBtn").addEventListener("click",()=>Ti()),o.addEventListener("click",N=>{N.stopPropagation();const z=s.style.display==="block";s.style.display=z?"none":"block"}),document.addEventListener("click",N=>{const z=document.querySelector(".review-btn-group");z&&!z.contains(N.target)&&(s.style.display="none")}),u.addEventListener("click",N=>{N.preventDefault(),s.style.display="none",xs(),l.style.display="flex"});const B=()=>l.style.display="none";b.addEventListener("click",B),S.addEventListener("click",B),x.addEventListener("submit",N=>{N.preventDefault();const z={fileOrFolder:document.getElementById("filterByFile").value,cardStates:Array.from(document.querySelectorAll('input[name="cardState"]:checked')).map(ee=>ee.value),lastReview:document.getElementById("filterByLastReview").value,maxCards:parseInt(document.getElementById("maxCards").value,10)};B(),Ti(z)})}function Ts(){ja.addEventListener("click",gs),Fa.addEventListener("click",bs),kr.addEventListener("click",ro),$e.addEventListener("click",ws),$a.addEventListener("click",_s),ke.addEventListener("input",Lr),za.addEventListener("click",()=>wr.click()),wr.addEventListener("change",Ss),Ha.addEventListener("click",()=>{const o=Array.from($e.querySelectorAll(".select-checkbox:checked")).map(s=>({id:s.dataset.id,type:s.dataset.type}));o.length>0?(W({movingItems:o}),to()):alert("请选择要移动的项目。")}),Hi.addEventListener("change",o=>{$e.querySelectorAll(".select-checkbox").forEach(s=>s.checked=o.target.checked)}),Ei.addEventListener("click",()=>{Ii.classList.toggle("hidden-session");const o=Ii.classList.contains("hidden-session");Ei.innerHTML=o?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}),Va.addEventListener("click",()=>ts.scrollIntoView({behavior:"smooth"})),_r.addEventListener("click",Is),Ri.addEventListener("click",()=>jt("--","--")),qi.addEventListener("click",()=>jt("**")),ji.addEventListener("click",()=>jt("*")),$i.addEventListener("click",()=>Es("¶")),Fi.addEventListener("click",()=>jt("`")),zi.addEventListener("click",()=>jt("[",`](${prompt("URL:","https://")})`)),zt.addEventListener("click",cs),ns.addEventListener("click",us),Ja.addEventListener("click",as),Xa.addEventListener("click",os),Za.addEventListener("click",Sr),ms(ks),As()}async function Bs(){console.log("Initializing Anki module..."),await va(),is(no),ls(),pe(),Ts()}let He=[],Ft=[],kt=-1;const M={el:document.getElementById("agentSettingsModal"),title:document.getElementById("agentSettingsModalTitle"),form:document.getElementById("agentSettingsForm"),id:document.getElementById("agentSettingsId"),name:document.getElementById("agentSettingsName"),displayName:document.getElementById("agentSettingsDisplayName"),avatar:document.getElementById("agentSettingsAvatar"),provider:document.getElementById("agentSettingsProvider"),apiPath:document.getElementById("agentSettingsApiPath"),apiKey:document.getElementById("agentSettingsApiKey"),apiKeyGroup:document.querySelector(".api-key-group"),model:document.getElementById("agentSettingsModel"),isLocal:document.getElementById("agentSettingsIsLocal"),systemPrompt:document.getElementById("agentSettingsSystemPrompt"),deleteBtn:document.getElementById("deleteAgentBtn"),deleteConfirmZone:document.querySelector(".delete-confirm-zone"),agentNameToConfirm:document.getElementById("agentNameToConfirm"),deleteConfirmInput:document.getElementById("deleteConfirmInput"),finalDeleteBtn:document.getElementById("finalDeleteBtn"),saveBtn:document.getElementById("agentSettingsSaveBtn"),cancelBtn:document.getElementById("agentSettingsCancelBtn"),closeBtn:document.getElementById("agentSettingsCloseBtn")};function Cs(){M.provider.innerHTML="";for(const o in Gt){const s=document.createElement("option");s.value=o,s.textContent=o,M.provider.appendChild(s)}}function io(o=null){M.el.style.display="flex",oo(),M.deleteConfirmZone.style.display="none",Cs(),o?(M.title.textContent=`Agent 设置: ${o.displayName}`,M.deleteBtn.style.display="block",M.id.value=o.id,M.name.value=o.name,M.displayName.value=o.displayName,M.avatar.value=o.avatar||"",M.systemPrompt.value=o.config.systemPrompt||"",M.provider.value=o.config.provider||"火山",M.provider.dispatchEvent(new Event("change",{bubbles:!0})),M.apiPath.value=o.config.apiPath||"",M.apiKey.value=o.config.apiKey||"",M.model.value=o.config.model||"",M.isLocal.checked=o.config.isLocal||!1):(M.title.textContent="创建新 Agent",M.deleteBtn.style.display="none",M.form.reset(),M.id.value="",M.name.value="",M.provider.value="火山",M.provider.dispatchEvent(new Event("change",{bubbles:!0}))),Ir()}function Wt(){M.el.style.display="none"}function Ir(){const o=M.provider.value,s=Gt[o];if(M.model.innerHTML="",s&&s.models&&s.models.length>0)s.models.forEach(u=>{const l=document.createElement("option");l.value=u,l.textContent=u,M.model.appendChild(l)}),M.model.disabled=!1;else{const u=document.createElement("option");u.textContent="请在下方手动输入模型名",u.value="",M.model.appendChild(u),M.model.disabled=!0}M.isLocal.checked?(M.apiKeyGroup.style.display="none",M.apiKey.required=!1):(M.apiKeyGroup.style.display="block",M.apiKey.required=!0)}function oo(){M.form.querySelectorAll(".is-invalid").forEach(o=>o.classList.remove("is-invalid"))}function Ls(){oo();let o=!0;const s=M.id.value;M.displayName.checkValidity()||(M.displayName.classList.add("is-invalid"),o=!1),M.avatar.checkValidity()||(M.avatar.classList.add("is-invalid"),o=!1);const u=M.name.value;if(u){const b=T.agents.some(S=>S.id!==s&&S.name===u);(!M.name.checkValidity()||b)&&(M.name.classList.add("is-invalid"),o=!1)}if(!o)return;const l={displayName:M.displayName.value,avatar:M.avatar.value.substring(0,2).toUpperCase(),config:{provider:M.provider.value,apiPath:M.apiPath.value,apiKey:M.apiKey.value,model:M.model.value,isLocal:M.isLocal.checked,systemPrompt:M.systemPrompt.value}};s?(l.id=s,l.name=M.name.value,La(s,l).then(()=>{Wt(),ct()})):Ca(l).then(()=>{Wt(),ct()})}async function Ps(){confirm(`您确定要永久删除Agent "${M.displayName.value}" 吗？此操作无法撤销！`)&&(await Pa(M.id.value),Wt(),ct())}async function Os(o){const s=o.target.closest(".agent-item");if(!s)return;if(s.classList.contains("add-agent-btn")){io();return}const u=s.dataset.agentId;u&&!s.classList.contains("active")&&(Na(u),ct())}async function Ds(o){const s=o.target.closest(".topic-item");if(!s)return;if(s.classList.contains("add-topic-btn")){const l=prompt("请输入新主题的名称:");l&&(await Oa(l),ct());return}const u=s.dataset.topicId;u&&(Ra(u),ct())}function Ks(){const o=Cr(T.currentAgentId);o?io(o):console.error("No agent selected to configure.")}async function Ms(o){const s=o.target.closest(".history-action-btn");if(!s)return;const u=s.closest(".history-item"),l=u.dataset.messageId;if(s.classList.contains("delete-btn"))confirm("确定要删除这条消息吗？")&&(await Ka([l]),Vt());else if(s.classList.contains("edit-btn")){const b=u.querySelector(".history-item-content p"),S=prompt("编辑你的消息:",b.textContent);S&&(await Ma(l,S),Vt())}else s.classList.contains("regenerate-btn")&&console.log(`Regenerating response for message ${l}`)}async function Bi(){const o=An.value.trim();!o&&He.length===0||T.isAiThinking||([...He],An.value="",He=[],Ar([]),await Da(o),An.focus())}function Ns(o){const s=Array.from(o.target.files);s.length!==0&&(He=[],s.forEach(u=>{const l=new FileReader;l.onload=b=>{He.push({name:u.name,data:b.target.result}),Ar(He)},l.readAsDataURL(u)}),o.target.value="")}function Rs(o){const s=o.target.closest(".remove-attachment-btn");if(!s)return;const u=parseInt(s.dataset.index,10);He.splice(u,1),Ar(He)}function qs(){const o=document.getElementById("chatNavUp"),s=document.getElementById("chatNavDown");o.addEventListener("click",()=>Ci(-1)),s.addEventListener("click",()=>Ci(1))}function Ci(o){if(Ft=Array.from(ye.querySelectorAll(".history-item .role.user")),Ft.length===0)return;document.querySelectorAll(".history-item.highlighted").forEach(u=>u.classList.remove("highlighted")),kt+=o,kt<0?kt=Ft.length-1:kt>=Ft.length&&(kt=0);const s=Ft[kt].closest(".history-item");if(s){s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("highlighted");const u=s.nextElementSibling;u&&u.classList.contains("history-item")&&u.classList.add("highlighted")}}function js(){M.form.addEventListener("submit",s=>{s.preventDefault(),Ls()}),M.closeBtn.addEventListener("click",Wt),M.cancelBtn.addEventListener("click",Wt),M.provider.addEventListener("change",()=>{const s=M.provider.value;M.apiPath.value=ta(s),Ir(),M.model.value=ea(s)}),M.isLocal.addEventListener("change",Ir),M.deleteBtn.addEventListener("click",()=>{M.deleteConfirmZone.style.display="block",M.agentNameToConfirm.textContent=M.name.value,M.deleteConfirmInput.value="",M.finalDeleteBtn.disabled=!0}),M.deleteConfirmInput.addEventListener("input",s=>{M.finalDeleteBtn.disabled=s.target.value!==M.name.value}),M.finalDeleteBtn.addEventListener("click",Ps);const o=document.getElementById("toggleApiKeyVisibility");o.addEventListener("click",()=>{const s=o.querySelector("i");M.apiKey.type==="password"?(M.apiKey.type="text",s.classList.replace("fa-eye","fa-eye-slash")):(M.apiKey.type="password",s.classList.replace("fa-eye-slash","fa-eye"))})}function Fs(){In.addEventListener("click",Os),xn.addEventListener("click",Ds),ye.addEventListener("click",Ms),document.getElementById("agentSettingsTriggerBtn").addEventListener("click",Ks),aa.addEventListener("click",Bi),An.addEventListener("keydown",s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),Bi())}),sa.addEventListener("change",Ns),gr.addEventListener("click",Rs),js(),qs()}async function zs(){console.log("Initializing AI Agent module..."),await Ba(),ct(),Fs()}function xr(){const{activeView:o}=T,s=document.getElementById("nav-anki-btn"),u=document.getElementById("nav-agent-btn"),l=document.querySelector(".ai-agent-nav");o==="anki"?(yi.style.display="flex",vi.style.display="none",l.style.display="none",s.classList.add("active"),u.classList.remove("active")):o==="agent"&&(yi.style.display="none",vi.style.display="flex",l.style.display="flex",s.classList.remove("active"),u.classList.add("active"))}function $s(){const o=document.getElementById("nav-anki-btn"),s=document.getElementById("nav-agent-btn");o.addEventListener("click",()=>{br("anki"),xr()}),s.addEventListener("click",()=>{br("agent"),xr()})}async function Hs(){document.body.classList.add("is-loading");try{await Uo(),await Promise.all([Bs(),zs()]),$s(),window.addEventListener("beforeunload",()=>{We(),Ae()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(We(),Ae())}),br("anki"),xr(),console.log("Application initialized successfully.")}catch(o){console.error("Application failed to initialize:",o),document.body.innerHTML="<h1>应用程序加载失败</h1><p>无法连接到数据库或初始化模块。请检查控制台获取更多信息。</p>"}finally{document.body.classList.remove("is-loading")}}document.addEventListener("DOMContentLoaded",Hs);</script>
  <style rel="stylesheet" crossorigin>:root{--agent-color-1: #4361ee;--agent-color-2: #3f37c9;--agent-color-3: #4895ef;--agent-color-4: #7209b7;--agent-color-5: #f72585;--topic-color-1: #ffd166;--topic-color-2: #06d6a0;--topic-color-3: #118ab2;--topic-color-4: #ef476f}.app-nav{display:flex;justify-content:center;gap:15px;margin:15px 0}.app-nav-btn{padding:10px 20px;font-size:1rem;font-weight:600;border:2px solid transparent;border-radius:30px;cursor:pointer;background-color:#eef2ff;color:var(--primary-color);transition:all .3s ease;display:flex;align-items:center;gap:8px}.app-nav-btn:hover{background-color:#dbe4ff}.app-nav-btn.active{background-color:var(--primary-color);color:#fff;box-shadow:0 4px 10px #4361ee4d}.ai-agent-nav{background:#fffffff2;border-radius:var(--border-radius);box-shadow:var(--shadow);padding:12px 20px;margin:0 auto 20px;max-width:1800px;display:flex;justify-content:space-between;align-items:center}.nav-title{font-size:1.3rem;color:var(--secondary-color);font-weight:600;display:flex;align-items:center;gap:10px}.nav-title i{color:var(--accent-color)}.agent-list{display:flex;gap:15px;overflow-x:auto;padding:5px 0}.agent-item{background:linear-gradient(135deg,var(--agent-color-1) 0%,var(--agent-color-2) 100%);color:#fff;padding:8px 20px;border-radius:30px;cursor:pointer;transition:var(--transition);font-size:.95rem;display:flex;align-items:center;gap:8px;white-space:nowrap;box-shadow:0 3px 8px #00000026}.agent-item:nth-child(2){background:linear-gradient(135deg,var(--agent-color-3) 0%,var(--agent-color-1) 100%)}.agent-item:nth-child(3){background:linear-gradient(135deg,var(--agent-color-4) 0%,var(--agent-color-5) 100%)}.agent-item:hover{transform:translateY(-3px);box-shadow:0 5px 15px #0003}.agent-item.active{box-shadow:0 0 0 3px #fffc,0 5px 15px #0003}.nav-actions{display:flex;gap:12px}.nav-action-btn{background:var(--primary-color);color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:var(--transition);font-size:.9rem}.nav-action-btn:hover{background:var(--secondary-color);transform:translateY(-2px)}.agent-content-container{display:flex;gap:20px;margin-bottom:20px}.topics-panel{width:300px;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}.topics-header{background:var(--primary-color);color:#fff;padding:15px 20px;font-size:1.1rem;font-weight:600}.topics-content{flex:1;padding:15px;overflow-y:auto;max-height:500px}.topic-list{list-style:none}.topic-item{padding:12px 15px;border-radius:6px;margin-bottom:10px;background:#f8f9ff;cursor:pointer;transition:var(--transition);border-left:4px solid var(--topic-color-1);position:relative;display:flex;align-items:center;gap:10px}.topic-item:nth-child(2n){border-left-color:var(--topic-color-2)}.topic-item:nth-child(3n){border-left-color:var(--topic-color-3)}.topic-item:nth-child(4n){border-left-color:var(--topic-color-4)}.topic-item:hover{transform:translate(5px);background:#eef2ff}.topic-item.active{background:linear-gradient(120deg,#a1c4fd,#c2e9fb);font-weight:600}.history-panel{flex:1;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);display:flex;flex-direction:column}.history-header{background:var(--primary-color);color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}.history-title{font-size:1.1rem;font-weight:600}.history-search{padding:8px 15px;border-radius:20px;border:none;width:250px;font-size:.9rem}.history-content{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:20px}.history-item{padding:15px;border-radius:8px;background:#f8f9ff;box-shadow:0 2px 6px #0000000d;border-left:3px solid var(--primary-color)}.history-item-header{display:flex;justify-content:space-between;margin-bottom:10px;color:#666;font-size:.9rem}.history-item-content{line-height:1.6}.history-item-content img{max-width:100%;border-radius:8px;margin-top:10px}.history-item-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}.history-action-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;transition:var(--transition)}.history-action-btn:hover{background:#4361ee33}.agent-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#4361ee,#3f37c9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;flex-shrink:0}.topic-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.8rem;flex-shrink:0}.topic-item:nth-child(1) .topic-icon{background:var(--topic-color-1)}.topic-item:nth-child(2) .topic-icon{background:var(--topic-color-2)}.topic-item:nth-child(3) .topic-icon{background:var(--topic-color-3)}.topic-item:nth-child(4) .topic-icon{background:var(--topic-color-4)}.no-history{text-align:center;padding:40px;color:#888}.no-history i{font-size:3rem;margin-bottom:15px;color:#c3cfe2}.main-layout{display:flex;gap:20px;margin-bottom:25px;flex-wrap:wrap}.app-container{flex:1;min-width:600px}@media (max-width: 1400px){.agent-content-container{flex-direction:column}.topics-panel{width:100%}.app-container{min-width:100%}}@media (max-width: 768px){.ai-agent-nav{flex-direction:column;gap:15px}.agent-list{width:100%}.nav-actions{width:100%;justify-content:center}.history-header{flex-direction:column;gap:15px}.history-search{width:100%}}:root{--primary-color: #4361ee;--secondary-color: #3f37c9;--accent-color: #4895ef;--light-color: #f8f9fa;--dark-color: #212529;--success-color: #4caf50;--warning-color: #ff9800;--danger-color: #f44336;--border-radius: 8px;--shadow: 0 4px 12px rgba(0, 0, 0, .1);--transition: all .3s ease;--session-width: 300px;--folder-color: #ffd166;--file-color: #a1c4fd;--cloze-easy-open: #E8F5E9;--cloze-10m: #FF6666;--cloze-1d: #FFCCCC;--cloze-2d: #FFDDAA;--cloze-3d: #FFFF99;--cloze-5d: #CCFFCC;--cloze-7d: #CCEEFF;--cloze-14d: #DDCCFF;--cloze-28d: #E0E0E0;--cloze-28plus: #F0F0F0}.cloze.easy-open{background-color:var(--cloze-easy-open)!important;border:1px dashed #C8E6C9;color:#333!important;font-weight:400;opacity:.9}.cloze-10m{background-color:var(--cloze-10m)!important;border-color:#f33!important;animation:pulse-alert 1.5s infinite alternate;color:#fff!important;font-weight:700}.cloze.permanent-view{background-color:#f0f4ff!important;border:1px solid #d0d9ff!important;font-weight:400!important}@keyframes pulse-alert{0%{opacity:.8;box-shadow:0 0 #ff6666b3}to{opacity:1;box-shadow:0 0 0 6px #f660}}*{margin:0;padding:0;box-sizing:border-box}body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;background:linear-gradient(135deg,#f5f7fa,#e4e7f1);color:var(--dark-color);min-height:100vh;padding:20px}.container{max-width:1800px;margin:0 auto}header{text-align:center;margin-bottom:20px;padding:20px;background:#fffffff2;border-radius:var(--border-radius);box-shadow:var(--shadow);position:relative}h1{color:var(--secondary-color);margin-bottom:10px;font-size:2.2rem}.subtitle{color:var(--primary-color);font-size:1.1rem;max-width:800px;margin:0 auto}.main-layout{display:flex;gap:20px;margin-bottom:25px}.session-sidebar{width:var(--session-width);background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:var(--transition)}.session-header{background:var(--primary-color);color:#fff;padding:15px 20px;display:flex;flex-direction:column;gap:12px}.session-title{font-size:1.2rem;font-weight:600;display:flex;align-items:center;justify-content:space-between}.session-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}.session-btn{background:#fff3;border:none;color:#fff;padding:8px;border-radius:4px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;width:36px;height:36px;transition:var(--transition)}.session-btn:hover{background:#ffffff4d}.session-content{flex:1;padding:15px;overflow-y:auto;max-height:750px}.session-list{list-style:none;margin-top:10px}.session-item{padding:12px 15px 12px 30px;border-radius:6px;margin-bottom:8px;background:#f8f9ff;cursor:pointer;transition:var(--transition);border:1px solid #e0e0e0;position:relative}.session-item.folder{background:#ffd1661a;border-left:4px solid var(--folder-color);padding-left:26px}.session-item.file{background:#a1c4fd1a;border-left:4px solid var(--file-color);padding-left:26px}.session-item:hover{background:#eef2ff;transform:translate(3px)}.session-item.active{background:linear-gradient(120deg,#a1c4fd,#c2e9fb);border-color:var(--accent-color);font-weight:600}.session-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:60px;display:flex;align-items:center;gap:8px}.session-item .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}.session-item .edit-btn,.session-item .delete-btn,.session-item .move-btn{color:#666;cursor:pointer;padding:4px;border-radius:4px;transition:var(--transition);background:#fff9;width:24px;height:24px;display:flex;align-items:center;justify-content:center}.session-item .edit-btn:hover{background:var(--accent-color);color:#fff}.session-item .delete-btn:hover{background:var(--danger-color);color:#fff}.session-item .move-btn:hover{background:var(--success-color);color:#fff}.session-item input[type=text]{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:inherit;font-size:.95rem}.app-container{flex:1;display:flex;flex-direction:column;gap:20px}.panel{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:var(--transition)}.panel.collapsed .panel-content{display:none}.panel-header{background:var(--primary-color);color:#fff;padding:0 20px;display:flex;justify-content:space-between;align-items:center;height:60px}.panel-title{font-size:1.2rem;font-weight:600;display:flex;align-items:center;gap:8px}.panel-actions{display:flex;gap:8px}.panel-btn{background:#fff3;border:none;color:#fff;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition)}.panel-btn:hover{background:#ffffff4d}.panel-btn-text{width:auto;padding:8px 15px}.panel-content{flex:1;padding:18px;overflow:auto;transition:var(--transition)}.editor-container{width:100%;height:100%;display:flex;flex-direction:column;gap:10px}.editor{width:100%;height:100%;min-height:280px;padding:14px;font-family:Consolas,Courier New,monospace;font-size:15px;border:1px solid #e0e0e0;border-radius:6px;resize:none;line-height:1.5}.editor:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px #4895ef33}#preview{min-height:280px;padding:15px;border:1px solid #e0e0e0;border-radius:6px;background:#fcfcfc}#preview h1,#preview h2,#preview h3{margin-top:1.1em;margin-bottom:.7em;color:var(--secondary-color)}#preview p{margin-bottom:.9em}#preview code{background:#f5f5f5;padding:2px 5px;border-radius:4px;font-family:monospace}#preview pre{background:#2d2d2d;color:#f8f8f2;padding:14px;border-radius:6px;overflow:auto;margin:1.4em 0}#preview blockquote{border-left:4px solid var(--accent-color);padding:10px 18px;background:#f9f9f9;margin:1.4em 0}.cloze{padding:2px 6px;border-radius:4px;cursor:pointer;position:relative;transition:var(--transition);border:1px dashed rgba(67,97,238,.3);font-weight:700;background:var(--cloze-28plus)}.cloze.hidden .cloze-content{display:none}.cloze.hidden .placeholder{display:inline}.cloze:not(.hidden) .placeholder{display:none}.placeholder{color:var(--primary-color);font-weight:700}.cloze.temporary{animation:highlight .5s ease}.cloze.shown{background:linear-gradient(120deg,#d4fc79,#96e6a1)}.cloze.permanent{border:1px solid var(--success-color)}.cloze-1d{background:var(--cloze-1d)!important}.cloze-2d{background:var(--cloze-2d)!important}.cloze-3d{background:var(--cloze-3d)!important}.cloze-5d{background:var(--cloze-5d)!important}.cloze-7d{background:var(--cloze-7d)!important}.cloze-14d{background:var(--cloze-14d)!important}.cloze-28d{background:var(--cloze-28d)!important}.cloze-28plus{background:var(--cloze-28plus)!important}@keyframes highlight{0%{background:#fff9c4}to{background:linear-gradient(120deg,#a1c4fd,#c2e9fb)}}.editor-toolbar{display:flex;justify-content:space-between;align-items:center;padding:10px 18px;background:#f0f4ff;border-bottom:1px solid #d0d9ff}.toolbar-left,.toolbar-right{display:flex;gap:10px}.toolbar-middle{flex:1;display:flex;justify-content:center;gap:10px}.editor-btn{background:#eef2ff;border:1px solid #d0d9ff;padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem}.editor-btn:hover:not(:disabled){background:var(--accent-color);color:#fff;border-color:var(--accent-color)}.editor-btn:disabled{opacity:.5;cursor:not-allowed}.editor-btn-text{width:auto;padding:8px 15px}.hidden-session{transform:translate(calc(-1 * var(--session-width) - 25px));opacity:0;width:0;overflow:hidden}.instructions{background:#fff;padding:22px;border-radius:var(--border-radius);box-shadow:var(--shadow);margin-top:25px}.instructions h2{color:var(--secondary-color);margin-bottom:18px;text-align:center;font-size:1.4rem}.instructions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px}.instruction-card{background:#f8f9ff;border-radius:var(--border-radius);padding:18px;box-shadow:0 2px 8px #00000014;transition:var(--transition)}.instruction-card:hover{transform:translateY(-4px);box-shadow:0 6px 15px #0000001a}.instruction-card h3{color:var(--primary-color);margin-bottom:14px;display:flex;align-items:center;gap:8px;font-size:1.1rem}.instruction-card h3 i{background:var(--primary-color);color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem}.example{background:#f0f4ff;padding:12px;border-radius:6px;margin-top:12px;font-family:monospace;font-size:.9rem}.footer{text-align:center;margin-top:35px;padding:18px;color:#666;font-size:.85rem}.file-input{display:none}.empty-session{text-align:center;padding:28px;color:#666}.empty-session i{font-size:2.8rem;margin-bottom:14px;color:#c3cfe2}.select-controls{display:flex;gap:8px;margin-top:10px;padding:8px 0;border-top:1px solid rgba(255,255,255,.2)}.select-all{display:flex;align-items:center;gap:5px;color:#fff;font-size:.85rem}.session-item .select-checkbox{margin-right:8px}.session-item .name-container{display:flex;flex:1;overflow:hidden}.folder-icon{color:var(--folder-color)}.file-icon{color:var(--file-color)}.nested-items{margin-left:20px;margin-top:8px;border-left:2px solid #e0e0e0;padding-left:15px}.current-folder{margin-top:10px;padding:8px;background:#eef2ff;border-radius:4px;font-size:.9rem;color:var(--dark-color);display:flex;align-items:center;flex-wrap:wrap;gap:4px}.current-folder i{margin-right:5px;color:var(--folder-color)}.breadcrumb-link{color:var(--primary-color);cursor:pointer;text-decoration:none}.breadcrumb-link:hover{text-decoration:underline}.breadcrumb-separator{margin:0 4px;color:#6c757d}.breadcrumb-current{font-weight:700;color:var(--secondary-color)}.move-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:var(--transition)}.move-modal.active{opacity:1;pointer-events:all}.move-modal-content{background:#fff;border-radius:var(--border-radius);padding:20px;width:400px;max-width:90%;box-shadow:var(--shadow)}.move-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.move-modal-title{font-size:1.2rem;font-weight:600;color:var(--primary-color)}.move-modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666}.folder-list{max-height:300px;overflow-y:auto;margin:15px 0;border:1px solid #e0e0e0;border-radius:var(--border-radius);padding:10px}.folder-item{padding:8px 10px;border-radius:4px;margin-bottom:5px;background:#f8f9ff;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}.folder-item:hover{background:#eef2ff}.folder-item.selected{background:#4361ee1a;border-left:3px solid var(--primary-color)}.move-modal-actions{display:flex;justify-content:flex-end;gap:10px}.move-modal-btn{padding:8px 15px;border-radius:4px;cursor:pointer;border:none;font-weight:500;transition:var(--transition)}.move-modal-btn.confirm{background:var(--primary-color);color:#fff}.move-modal-btn.cancel{background:#f0f0f0;color:var(--dark-color)}@media (max-width: 1200px){.main-layout{flex-direction:column}.session-sidebar{width:100%;max-width:100%}.app-container{flex-direction:column}.panel{min-height:280px}}@media (max-width: 768px){.panel-header{flex-direction:column;align-items:flex-start;gap:10px;height:auto;padding:10px}.panel-actions{width:100%;justify-content:flex-end;flex-wrap:wrap}.editor-toolbar{flex-direction:column;gap:10px}.toolbar-left,.toolbar-middle,.toolbar-right{width:100%;justify-content:center}}.media-icon{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;margin-right:5px;background:#4361ee1a;border-radius:50%;color:var(--primary-color);cursor:pointer;transition:var(--transition)}.media-icon:hover{background:#4361ee33;transform:scale(1.1)}.audio-controls{position:fixed;bottom:20px;right:20px;background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);padding:15px;z-index:1000;display:none}.audio-title{margin-bottom:10px;font-weight:600;color:var(--secondary-color)}.audio-progress{width:300px;height:6px;background:#e0e0e0;border-radius:3px;margin:10px 0;overflow:hidden}.audio-progress-bar{height:100%;background:var(--primary-color);width:0%;transition:width .1s linear}.audio-buttons{display:flex;justify-content:space-between}.audio-btn{background:var(--primary-color);color:#fff;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:5px}.audio-edit-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;margin-top:5px;transition:var(--transition)}.audio-edit-btn:hover{background:#4361ee33}.history-panel{display:flex;flex-direction:column;overflow:hidden;max-height:80vh}.history-content{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:20px}.chat-input-area{padding:15px 20px;border-top:1px solid #e0e6f0;background-color:#f8f9ff;display:flex;flex-direction:column;gap:10px;flex-shrink:0}.input-controls{display:flex;align-items:flex-end;gap:10px}.chat-textarea{flex:1;border:1px solid #d0d9ff;border-radius:var(--border-radius);padding:10px 15px;font-family:inherit;font-size:1rem;line-height:1.5;resize:vertical;transition:var(--transition);background-color:#fff}.chat-textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px #4895ef33}.chat-action-btn{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:var(--transition);background:#eef2ff;color:var(--primary-color);flex-shrink:0}.chat-action-btn:hover{background:#dbe4ff;transform:translateY(-2px)}.chat-action-btn.send{background-color:var(--primary-color);color:#fff}.chat-action-btn.send:hover{background-color:var(--secondary-color)}.attachment-preview-container{display:flex;gap:8px;flex-wrap:wrap;max-height:100px;overflow-y:auto}.attachment-preview-item{background:#e0e6f0;padding:5px 12px;border-radius:15px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px;color:#333;animation:fadeIn .3s ease}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}.attachment-preview-item i{color:var(--primary-color)}.remove-attachment-btn{cursor:pointer;font-weight:700;color:#666;background:none;border:none;font-size:1.2rem;line-height:1;padding:0 2px;transition:var(--transition)}.remove-attachment-btn:hover{color:var(--danger-color);transform:scale(1.2)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:2000;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}.modal-content{background:#fff;border-radius:var(--border-radius);box-shadow:0 10px 30px #0003;width:90%;max-width:600px;display:flex;flex-direction:column;max-height:90vh;animation:slide-in .3s ease-out}@keyframes slide-in{0%{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}.modal-header{padding:15px 25px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:1.4rem;color:var(--secondary-color)}.modal-close{background:none;border:none;font-size:1.8rem;cursor:pointer;color:#888}.modal-body{padding:25px;overflow-y:auto}.modal-footer{padding:15px 25px;border-top:1px solid #e0e0e0;display:flex;justify-content:flex-end;gap:10px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#333}.form-control{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:6px;font-size:1rem;transition:var(--transition)}.form-control:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px #4895ef33}.form-control.is-invalid{border-color:var(--danger-color)}.invalid-feedback{color:var(--danger-color);font-size:.85rem;margin-top:5px;display:none}.form-control.is-invalid+.invalid-feedback{display:block}.input-group{display:flex}.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}.input-group-btn{padding:0 12px;border:1px solid #ccc;border-left:none;background-color:#f0f0f0;border-top-right-radius:6px;border-bottom-right-radius:6px;cursor:pointer}.form-check{display:flex;align-items:center;gap:8px;margin-top:15px}.btn-primary,.btn-secondary,.btn-danger{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1rem;transition:var(--transition)}.btn-primary{background-color:var(--primary-color);color:#fff}.btn-primary:hover{background-color:var(--secondary-color)}.btn-secondary{background-color:#e0e0e0;color:#333}.btn-secondary:hover{background-color:#ccc}.btn-danger{background-color:var(--danger-color);color:#fff}.btn-danger:hover{opacity:.85}.delete-confirm-zone{margin-top:15px;padding:15px;background-color:#f443361a;border:1px solid var(--danger-color);border-radius:6px}.delete-confirm-zone #finalDeleteBtn{margin-top:10px;width:100%}.delete-confirm-zone #finalDeleteBtn:disabled{background-color:#ccc;cursor:not-allowed}.agent-item.active .agent-settings-btn{opacity:1}.history-header{display:flex;justify-content:space-between;align-items:center}.history-title{display:flex;align-items:center;gap:10px;font-size:1.1rem;font-weight:600}.history-header-actions{display:flex;align-items:center;gap:10px}.header-action-btn{background:#fff3;border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}.header-action-btn:hover{background:#fff6;transform:rotate(45deg)}.agent-settings-modal .form-control[rows]{line-height:1.5;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif}.thinking-block{background-color:#f0f4ff;border:1px solid #d0d9ff;border-radius:6px;padding:10px 15px;margin:12px 0}.thinking-block summary{cursor:pointer;font-weight:700;color:var(--primary-color);outline:none}.thinking-block summary::marker{color:var(--primary-color)}.thinking-content{margin-top:10px;padding-top:10px;border-top:1px dashed #d0d9ff;white-space:pre-wrap;word-wrap:break-word}.history-panel{position:relative}.chat-navigation{position:absolute;bottom:90px;right:25px;display:flex;flex-direction:column;gap:10px;z-index:10}.chat-nav-btn{width:40px;height:40px;border-radius:50%;background-color:#4361eecc;color:#fff;border:none;cursor:pointer;box-shadow:0 2px 10px #0003;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:1rem}.chat-nav-btn:hover{background-color:var(--secondary-color);transform:scale(1.1)}.chat-nav-btn:disabled{opacity:.5;cursor:not-allowed}.history-item.highlighted{transition:background-color .5s ease;background-color:#e0e7ff;border-color:var(--accent-color)}.global-review-area{margin:15px 0;display:flex;justify-content:center}.review-btn-group{display:flex;position:relative;box-shadow:0 4px 10px #4361ee4d;border-radius:30px}.review-btn-group .app-nav-btn{margin:0;box-shadow:none}.review-btn-group .app-nav-btn.main-action{border-top-right-radius:0;border-bottom-right-radius:0}.review-btn-group .app-nav-btn.dropdown-toggle{border-top-left-radius:0;border-bottom-left-radius:0;border-left:1px solid rgba(255,255,255,.3);padding:10px 12px}.dropdown-menu{position:absolute;top:105%;right:0;background-color:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;padding:8px 0;min-width:180px;border:1px solid #ddd}.dropdown-menu a{display:block;padding:10px 15px;color:var(--dark-color);text-decoration:none;transition:background-color .2s ease;font-size:.9rem}.dropdown-menu a:hover{background-color:#f0f4ff}.dropdown-menu a i{margin-right:10px;color:var(--primary-color);width:20px;text-align:center}.form-checkbox-group{display:flex;flex-wrap:wrap;gap:10px 20px;padding:5px 0}.form-checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer}.cloze.permanent-view .cloze-actions{display:none!important}.cloze-actions{display:flex;justify-content:space-between;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.08)}.cloze-btn{flex:1;padding:10px 5px;border-radius:20px;border:none;background-color:#f5f7fa;cursor:pointer;font-size:.9rem;font-weight:600;text-align:center;transition:all .2s ease-in-out;outline:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;box-shadow:0 2px 4px #0000000d}.cloze-btn i{font-size:1.2rem;margin-bottom:5px}.cloze-btn.again{color:#e53935;background-color:#e539351a}.cloze-btn.again:hover{background-color:#e53935;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #e539354d}.cloze-btn.hard{color:#fb8c00;background-color:#fb8c001a}.cloze-btn.hard:hover{background-color:#fb8c00;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #fb8c004d}.cloze-btn.good{color:#43a047;background-color:#43a0471a}.cloze-btn.good:hover{background-color:#43a047;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #43a0474d}.cloze-btn.easy{color:#1e88e5;background-color:#1e88e51a}.cloze-btn.easy:hover{background-color:#1e88e5;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #1e88e54d}</style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-folder-tree"></i> Anki / AI Agent 系统</h1>
            <!-- NEW NAVIGATION BUTTONS -->
            <div class="app-nav">
                <button id="nav-anki-btn" class="app-nav-btn active">
                    <i class="fas fa-book-open"></i> Anki 笔记
                </button>
                <button id="nav-agent-btn" class="app-nav-btn">
                    <i class="fas fa-robot"></i> AI Agents
                </button>
            </div>
            <p class="subtitle">创建、组织、预览Markdown笔记, 并与AI助手互动</p>
        </header>
        
        <!-- 新增的AI Agent导航栏 -->
        <nav class="ai-agent-nav">
            <div class="nav-title">
                <i class="fas fa-robot"></i> AI Agent管理
            </div>
            <div class="agent-list">
                <div class="agent-item active" data-agent="1">
                    <div class="agent-avatar">AI</div>
                    <span>数学学习助手</span>
                </div>
                <div class="agent-item" data-agent="2">
                    <div class="agent-avatar">MD</div>
                    <span>语言学习助手</span>
                </div>
                <div class="agent-item" data-agent="3">
                    <div class="agent-avatar">CS</div>
                    <span>计算机科学助手</span>
                </div>
                <div class="agent-item">
                    <div class="agent-avatar">+</div>
                    <span>添加新Agent</span>
                </div>
            </div>
            <div class="nav-actions">
                <button class="nav-action-btn">
                    <i class="fas fa-history"></i> 历史记录
                </button>
                <button class="nav-action-btn">
                    <i class="fas fa-cog"></i> 设置
                </button>
            </div>
        </nav>
        
        <div class="audio-controls" id="audioControls">
            <div class="audio-title" id="audioTitle">音频播放</div>
            <div class="audio-progress">
                <div class="audio-progress-bar" id="audioProgress"></div>
            </div>
            <div class="audio-buttons">
                <button class="audio-btn" id="playBtn"><i class="fas fa-play"></i> 播放</button>
                <button class="audio-btn" id="pauseBtn"><i class="fas fa-pause"></i> 暂停</button>
                <button class="audio-btn" id="stopBtn"><i class="fas fa-stop"></i> 停止</button>
            </div>
        </div>
        
        <!-- AI Agent内容区域 -->
        <div class="agent-content-container">
            <div class="topics-panel">
                <div class="topics-header">
                    <i class="fas fa-book"></i> 聊天主题
                </div>
                <div class="topics-content">
                    <ul class="topic-list">
                        <li class="topic-item active">
                            <div class="topic-icon"><i class="fas fa-calculator"></i></div>
                            <span>线性代数</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-infinity"></i></div>
                            <span>微积分</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-project-diagram"></i></div>
                            <span>概率统计</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-cube"></i></div>
                            <span>几何学</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-plus-circle"></i></div>
                            <span>添加新主题</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="history-panel">
    <div class="history-header">
        <div class="history-title">
            <i class="fas fa-comments"></i>
            <span id="historyHeaderTitle">历史对话记录</span> 
        </div>
        <div class="history-header-actions">
            <button id="agentSettingsTriggerBtn" class="header-action-btn" title="当前Agent设置" style="display: none;">
                <i class="fas fa-cog"></i>
            </button>
            <input type="text" class="history-search" placeholder="搜索历史记录...">
        </div>
    </div>
                <div class="history-content">
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-15 14:30</span>
                            <span>线性代数 - 矩阵运算</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 请解释矩阵的逆是什么？</p>
                            <p><strong>AI助手:</strong> 矩阵的逆类似于数字的倒数。对于一个n×n矩阵A，如果存在另一个n×n矩阵B，使得AB = BA = I（单位矩阵），那么B就是A的逆矩阵，记作A⁻¹。只有方阵且行列式不为零的矩阵才有逆矩阵。</p>
                            <img src="https://via.placeholder.com/600x150/4361ee/ffffff?text=矩阵逆运算示例" alt="矩阵逆运算示例">
                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                    
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-14 09:15</span>
                            <span>线性代数 - 特征值与特征向量</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 特征值和特征向量有什么实际应用？</p>
                            <p><strong>AI助手:</strong> 特征值和特征向量在多个领域有广泛应用：</p>
                            <ol>
                                <li>物理学：分析振动系统的主振动模式</li>
                                <li>计算机图形学：用于图像压缩和特征提取</li>
                                <li>机器学习：主成分分析(PCA)的核心</li>
                                <li>工程学：结构稳定性分析</li>
                            </ol>
                            <p>例如，在PCA中，我们通过计算协方差矩阵的特征值和特征向量来降低数据维度。</p>
                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                    
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-12 16:45</span>
                            <span>微积分 - 极限与连续</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 请证明lim(x→0) sin(x)/x = 1</p>
                            <p><strong>AI助手:</strong> 这个重要极限可以通过几何方法或泰勒级数证明。几何证明如下：</p>
                            <p>考虑单位圆中的扇形OAB，其中OA和OB是半径，角AOB为x弧度。三角形OAB的面积小于扇形OAB的面积，后者又小于直角三角形OAC的面积（AC是切线）。</p>

                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                </div>
                <div class="chat-navigation">
                    <button id="chatNavUp" class="chat-nav-btn" title="上一轮对话"><i class="fas fa-arrow-up"></i></button>
                    <button id="chatNavDown" class="chat-nav-btn" title="下一轮对话"><i class="fas fa-arrow-down"></i></button>
                </div>
                <!-- ==================== 新增的聊天输入区域 ==================== -->
                <div class="chat-input-area">
                    <div class="attachment-preview-container" id="attachmentPreview">
                        <!-- 附件预览将动态添加到这里 -->
                        <!-- 示例: 
                        <div class="attachment-preview-item">
                            <span><i class="fas fa-file-image"></i> image_01.jpg</span>
                            <button class="remove-attachment-btn">×</button>
                        </div> 
                        -->
                    </div>
                    <div class="input-controls">
                        <textarea id="chatInput" class="chat-textarea" rows="3" placeholder="输入消息... (Shift + Enter 换行)"></textarea>
                        <!-- 隐藏的文件输入框，通过JS点击附件按钮来触发 -->
                        <input type="file" id="attachmentInput" multiple style="display: none;">
                        <button id="attachFileBtn" class="chat-action-btn" title="添加附件" onclick="document.getElementById('attachmentInput').click();">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button id="sendMessageBtn" class="chat-action-btn send" title="发送">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <!-- ==================== 聊天输入区域结束 ==================== -->
            </div>
        </div>
        
        <div class="main-layout">
            <div class="session-sidebar">
                <div class="session-header">
                    <div class="session-title">
                        <span><i class="fas fa-layer-group"></i> 会话管理</span>
                    </div>
                    <div class="session-controls">
                        <button id="newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                        <button id="newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                        <button id="openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                        <button id="moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                        <button id="deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="select-controls">
                        <label class="select-all">
                            <input type="checkbox" id="selectAllCheckbox"> 全选
                        </label>
                    </div>
                    <div class="current-folder" id="currentFolderContainer"></div>
                </div>
                <div class="session-content">
                    <div class="session-list-container">
                        <ul class="session-list" id="sessionList"></ul>
                        <div class="empty-session" id="emptySession">
                            <i class="fas fa-folder-open"></i>
                            <p>没有打开的会话</p>
                            <p>点击"新建文件"或"打开文件"开始</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="app-container">
                <div class="panel" id="editorPanel">
                    <div class="editor-toolbar">
                        <div class="toolbar-left">
                            <button id="toggleSessionBtn" class="editor-btn" title="显示/隐藏会话栏"><i class="fas fa-arrow-left"></i></button>
                            <button id="toggleEditorBtn" class="editor-btn" title="收起编辑器"><i class="fas fa-chevron-up"></i></button>
                        </div>
                        <div class="toolbar-middle">
                            <button id="clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
                            <button id="boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
                            <button id="italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
                            <!-- [MODIFIED] 新增按钮 -->
                            <button id="insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
                            <button id="codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
                            <button id="linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
                            <button id="audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
                        </div>
                        <div class="toolbar-right">
					        <div class="review-btn-group">
					            <button id="startReviewBtn" class="editor-btn editor-btn-text">
					                <i class="fas fa-play-circle"></i> 复习 (<span id="reviewCount">0</span>)
					            </button>
					            <button id="reviewOptionsBtn" class="editor-btn dropdown-toggle">
					                <i class="fas fa-chevron-down"></i>
					            </button>
					            <div id="reviewDropdownMenu" class="dropdown-menu" style="display: none;">
					                <a href="#" id="customStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
					            </div>
					        </div>
                            <button id="saveBtn" class="editor-btn editor-btn-text" title="保存"><i class="fas fa-save"></i> 保存</button>
                            <button id="exportFileBtn" class="editor-btn editor-btn-text" title="导出"><i class="fas fa-download"></i> 导出</button>
                            <button id="helpBtn" class="editor-btn editor-btn-text" title="帮助"><i class="fas fa-question-circle"></i> 帮助</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="editor-container">
                            <textarea id="editor" class="editor"># Anki MD管理系统

## 使用说明

### 目录结构
- 创建目录来组织您的会话
- 在目录中创建文件
- 将文件移动到不同的目录

### 操作指南
1. 点击"新建目录"按钮创建新目录
2. 选择一个目录后，新建的文件会自动放入该目录
3. 使用移动按钮将项目移动到其他目录
4. 选中目录时会选中其下所有内容
5. 删除目录时会删除其下所有内容

### 数学公式示例
行内公式：\\( E = mc^2 \\)

块级公式：
\\[ 
x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} 
\\]

### Cloze 记忆卡片
牛顿第二定律：--\\( F = ma \\)--
量子力学基础：--\\( \psi = \psi(x,t) \\)--
相对论：--\\( E = \gamma m c^2 \\)--
电磁学：--\\( \nabla \times \mathbf{B} = \mu_0 \mathbf{J} + \mu_0 \epsilon_0 \frac{\partial \mathbf{E}}{\partial t} \\)--</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><i class="fas fa-eye"></i> 预览</div>
                        <div class="panel-actions">
            <!-- 新的合并后的按钮 -->
            <button id="toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏">
                <i class="fas fa-eye-slash"></i>
            </button>
            <button id="invertClozeBtn" class="panel-btn" title="反向显示/隐藏">
                <i class="fas fa-exchange-alt"></i>
            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div id="preview"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
             <h2><i class="fas fa-info-circle"></i> 使用说明</h2>
            <div class="instructions-grid">
                <div class="instruction-card">
                    <h3><i class="fas fa-folder"></i> 目录管理</h3>
                    <p>• <strong>新建目录</strong>：点击文件夹+图标创建新目录<br>
                    • <strong>选择目录</strong>：点击目录名称设为当前目录<br>
                    • <strong>移动项目</strong>：使用移动按钮将项目移动到其他目录<br>
                    • <strong>删除目录</strong>：删除目录会同时删除其下所有内容</p>
                </div>
                
                <div class="instruction-card">
                    <h3><i class="fas fa-file"></i> 文件管理</h3>
                    <p>• <strong>新建文件</strong>：在当前目录下创建新文件<br>
                    • <strong>打开文件</strong>：导入外部文件到当前目录<br>
                    • <strong>移动文件</strong>：可将文件移动到其他目录<br>
                    • <strong>编辑内容</strong>：点击文件名称编辑其内容</p>
                </div>
                
                <div class="instruction-card">
                    <h3><i class="fas fa-check-square"></i> 批量操作</h3>
                    <p>• <strong>全选</strong>：选中所有可见项目<br>
                    • <strong>目录选择</strong>：选中目录会自动选中其下所有内容<br>
                    • <strong>批量删除</strong>：删除所有选中的项目<br>
                    • <strong>跨目录操作</strong>：可同时选择不同目录下的项目</p>
                </div>
                
                <div class="instruction-card">
                    <h3><i class="fas fa-edit"></i> 编辑器工具</h3>
                    <p>• <strong>转换为Cloze</strong>：将选中文本转换为记忆卡片<br>
                    • <strong>格式工具</strong>：支持加粗、斜体、代码块等格式<br>
                    • <strong>保存/导出</strong>：保存当前内容或导出为Markdown文件<br>
                    • <strong>收起/展开</strong>：优化工作区空间管理</p>
                </div>
            </div>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept=".md, .txt">
        
        <div class="move-modal" id="moveModal">
            <div class="move-modal-content">
                <div class="move-modal-header">
                    <div class="move-modal-title">移动到目录</div>
                    <button class="move-modal-close" id="closeMoveModalBtn">×</button>
                </div>
                <p>请选择目标目录：</p>
                <div class="folder-list" id="folderList"></div>
                <div class="move-modal-actions">
                    <button class="move-modal-btn cancel" id="cancelMoveBtn">取消</button>
                    <button class="move-modal-btn confirm" id="confirmMoveBtn">确认移动</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2024 Anki MD管理系统 | 数据保存在浏览器本地存储中</p>
        </div>
    </div>

    <!-- ====================================================== -->
    <!--          AGENT SETTINGS MODAL (Initially Hidden)       -->
    <!-- ====================================================== -->
    <div class="modal-overlay" id="agentSettingsModal" style="display: none;">
        <div class="modal-content agent-settings-modal">
            <div class="modal-header">
                <h2 id="agentSettingsModalTitle">Agent 设置</h2>
                <button class="modal-close" id="agentSettingsCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <form id="agentSettingsForm" novalidate>
                    <input type="hidden" id="agentSettingsId">

                    <div class="form-group">
                        <label for="agentSettingsName">Agent名 (内部标识) <i class="fas fa-info-circle" title="唯一标识，仅限字母、数字、下划线。"></i></label>
                        <input type="text" id="agentSettingsName" class="form-control" required pattern="[a-zA-Z0-9_]+">
                        <div class="invalid-feedback">名称已被使用或格式不正确。</div>
                    </div>

                    <div class="form-group">
                        <label for="agentSettingsDisplayName">会话显示名</label>
                        <input type="text" id="agentSettingsDisplayName" class="form-control" required>
                    </div>
                    <!-- 新增 Avatar 输入框 -->
                    <div class="form-group">
                        <label for="agentSettingsAvatar">头像 (2个字符)</label>
                        <input type="text" id="agentSettingsAvatar" class="form-control" required maxlength="2" placeholder="例如：AI, 数, 语">
                    </div>
                    <hr>

                    <h4>模型配置</h4>

                    <div class="form-group">
                        <label for="agentSettingsProvider">提供商</label>
                        <select id="agentSettingsProvider" class="form-control" required>
                            <!-- 选项将由JS动态填充 -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="agentSettingsApiPath">API 地址</label>
                        <input type="url" id="agentSettingsApiPath" class="form-control">
                    </div>
                    
                    <div class="form-group api-key-group">
                        <label for="agentSettingsApiKey">API Key</label>
                        <div class="input-group">
                            <input type="password" id="agentSettingsApiKey" class="form-control">
                            <button type="button" id="toggleApiKeyVisibility" class="input-group-btn" title="显示/隐藏"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="agentSettingsModel">模型名</label>
                        <select id="agentSettingsModel" class="form-control" required>
                            <!-- 选项将由JS动态填充 -->
                        </select>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="agentSettingsIsLocal" class="form-check-input">
                        <label for="agentSettingsIsLocal">这是一个本地推理模型 (无需API Key)</label>
                    </div>

                    <hr>

                    <h4>危险操作区</h4>
                    <button type="button" class="btn-danger" id="deleteAgentBtn"><i class="fas fa-trash"></i> 删除此 Agent</button>
                    <div class="delete-confirm-zone" style="display:none;">
                        <p>请输入Agent名 "<b><span id="agentNameToConfirm"></span></b>" 以确认删除：</p>
                        <input type="text" id="deleteConfirmInput" class="form-control">
                        <button type="button" class="btn-danger" id="finalDeleteBtn" disabled>我已了解后果，永久删除</button>
                    </div>
                    <hr>
                    <h4>Agent 行为设定</h4>
                    <div class="form-group">
                        <label for="agentSettingsSystemPrompt">System Prompt (系统提示词)</label>
                        <textarea id="agentSettingsSystemPrompt" class="form-control" rows="5" placeholder="定义Agent的角色和行为，例如：你是一个专业的数学学习助手..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="agentSettingsCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="agentSettingsSaveBtn" form="agentSettingsForm">保存更改</button>
            </div>
        </div>
    </div>

        <!-- [NEW] 自定义复习模态框 -->
    <div class="modal-overlay" id="customStudyModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>自定义复习会话</h2>
                <button class="modal-close" id="customStudyCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <form id="customStudyForm">
                    <div class="form-group">
                        <label for="filterByFile">按文件/目录筛选:</label>
                        <select id="filterByFile" class="form-control">
                            <option value="all">所有文件</option>
                            <!-- 选项将由JS动态填充 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>按卡片状态筛选:</label>
                        <div class="form-checkbox-group">
                            <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                            <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                            <label><input type="checkbox" name="cardState" value="review" checked> 复习中</label>
                            <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>按最后一次复习时间筛选:</label>
                        <select id="filterByLastReview" class="form-control">
                            <option value="any">任何时间</option>
                            <option value="last7days">最近7天内</option>
                            <option value="last30days">最近30天内</option>
                            <option value="over30days">超过30天未复习</option>
                            <option value="never">从未复习过 (新卡片)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maxCards">最大卡片数量:</label>
                        <input type="number" id="maxCards" class="form-control" value="50" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="customStudyCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="startCustomStudyBtn" form="customStudyForm">开始自定义复习</button>
            </div>
        </div>
    </div>
</body>
</html>
