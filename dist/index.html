<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能学习套件</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script> 
    <!-- [新增] 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        loader: {load: ['[tex]/mhchem']},
        tex: {
          packages: {'[+]': ['mhchem']}
        },
        startup: {
          pageReady: () => {
            return window.MathJax.startup.defaultPageReady();
          }
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
  <script type="module" crossorigin>import{marked as mi}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const Ie=n=>document.querySelector(n),J=n=>document.getElementById(n),Da=J("anki-view"),Ba=J("agent-view"),ja=J("mistakes-view"),Ka=J("settings-view"),Gn=document.querySelector(".ai-agent-nav"),Ul=Object.freeze(Object.defineProperty({__proto__:null,$:Ie,$id:J,agentNav:Gn,agentView:Ba,ankiView:Da,mistakesView:ja,settingsView:Ka},Symbol.toStringTag,{value:"Module"}));let Ra={activeView:"anki",sessions:[],folders:[],clozeStates:{},fileSubsessions:{},undoStack:[],redoStack:[],currentSessionId:null,currentFolderId:null,currentSubsessionId:null,folderStack:[],agents:[],topics:[],history:[],currentAgentId:null,currentTopicId:null,isLoading:!0,isAiThinking:!1,isSessionSidebarHidden:!1,areAllClozeVisible:!1,movingItems:[],selectedMoveTarget:null};const B=new Proxy(Ra,{get(n,e){if(e in n){const t=n[e];return typeof t=="object"&&t!==null?JSON.parse(JSON.stringify(t)):t}},set(){return console.warn("Direct mutation of appState is not allowed. Use a data service function."),!1}});function re(n){Object.assign(Ra,n)}const ta=10*60*1e3,Hl=2.5;function qa(n,e){const t=Date.now();let{interval:s=0,easeFactor:i=Hl,state:a="new"}=n;if(a==="new"||a==="learning")switch(e){case 0:return{due:t+ta,interval:0,easeFactor:i,state:"learning"};case 1:return{due:t+1*24*3600*1e3,interval:1,easeFactor:i,state:"review"};case 2:return{due:t+3*24*3600*1e3,interval:3,easeFactor:i,state:"review"};case 3:return{due:t+5*24*3600*1e3,interval:5,easeFactor:i,state:"review"}}switch(e){case 0:return i=Math.max(1.3,i-.2),{due:t+ta,interval:0,easeFactor:i,state:"learning"};case 1:s=Math.max(1,s*1.2),i=Math.max(1.3,i-.15);break;case 2:break;case 3:i+=.15;break}const c=Math.max(s+1,s*i);return{due:t+c*24*3600*1e3,interval:c,easeFactor:i,state:"review"}}var na=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function zl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Fa={exports:{}};(function(n,e){(function(t,s){n.exports=s()})(na,function(){var t=function(r,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(l,u){l.__proto__=u}||function(l,u){for(var d in u)Object.prototype.hasOwnProperty.call(u,d)&&(l[d]=u[d])})(r,o)},s=function(){return(s=Object.assign||function(r){for(var o,l=1,u=arguments.length;l<u;l++)for(var d in o=arguments[l])Object.prototype.hasOwnProperty.call(o,d)&&(r[d]=o[d]);return r}).apply(this,arguments)};function i(r,o,l){for(var u,d=0,h=o.length;d<h;d++)!u&&d in o||((u=u||Array.prototype.slice.call(o,0,d))[d]=o[d]);return r.concat(u||Array.prototype.slice.call(o))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:na,c=Object.keys,f=Array.isArray;function p(r,o){return typeof o!="object"||c(o).forEach(function(l){r[l]=o[l]}),r}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var m=Object.getPrototypeOf,L={}.hasOwnProperty;function b(r,o){return L.call(r,o)}function _(r,o){typeof o=="function"&&(o=o(m(r))),(typeof Reflect>"u"?c:Reflect.ownKeys)(o).forEach(function(l){P(r,l,o[l])})}var C=Object.defineProperty;function P(r,o,l,u){C(r,o,p(l&&b(l,"get")&&typeof l.get=="function"?{get:l.get,set:l.set,configurable:!0}:{value:l,configurable:!0,writable:!0},u))}function T(r){return{from:function(o){return r.prototype=Object.create(o.prototype),P(r.prototype,"constructor",r),{extend:_.bind(null,r.prototype)}}}}var D=Object.getOwnPropertyDescriptor,z=[].slice;function W(r,o,l){return z.call(r,o,l)}function X(r,o){return o(r)}function Q(r){if(!r)throw new Error("Assertion Failed")}function ee(r){a.setImmediate?setImmediate(r):setTimeout(r,0)}function te(r,o){if(typeof o=="string"&&b(r,o))return r[o];if(!o)return r;if(typeof o!="string"){for(var l=[],u=0,d=o.length;u<d;++u){var h=te(r,o[u]);l.push(h)}return l}var y=o.indexOf(".");if(y!==-1){var g=r[o.substr(0,y)];return g==null?void 0:te(g,o.substr(y+1))}}function ae(r,o,l){if(r&&o!==void 0&&!("isFrozen"in Object&&Object.isFrozen(r)))if(typeof o!="string"&&"length"in o){Q(typeof l!="string"&&"length"in l);for(var u=0,d=o.length;u<d;++u)ae(r,o[u],l[u])}else{var h,y,g=o.indexOf(".");g!==-1?(h=o.substr(0,g),(y=o.substr(g+1))===""?l===void 0?f(r)&&!isNaN(parseInt(h))?r.splice(h,1):delete r[h]:r[h]=l:ae(g=!(g=r[h])||!b(r,h)?r[h]={}:g,y,l)):l===void 0?f(r)&&!isNaN(parseInt(o))?r.splice(o,1):delete r[o]:r[o]=l}}function G(r){var o,l={};for(o in r)b(r,o)&&(l[o]=r[o]);return l}var ye=[].concat;function ze(r){return ye.apply([],r)}var Ct="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(ze([8,16,32,64].map(function(r){return["Int","Uint","Float"].map(function(o){return o+r+"Array"})}))).filter(function(r){return a[r]}),nt=new Set(Ct.map(function(r){return a[r]})),ge=null;function Ge(r){return ge=new WeakMap,r=function o(l){if(!l||typeof l!="object")return l;var u=ge.get(l);if(u)return u;if(f(l)){u=[],ge.set(l,u);for(var d=0,h=l.length;d<h;++d)u.push(o(l[d]))}else if(nt.has(l.constructor))u=l;else{var y,g=m(l);for(y in u=g===Object.prototype?{}:Object.create(g),ge.set(l,u),l)b(l,y)&&(u[y]=o(l[y]))}return u}(r),ge=null,r}var ll={}.toString;function Cr(r){return ll.call(r).slice(8,-1)}var Or=typeof Symbol<"u"?Symbol.iterator:"@@iterator",ul=typeof Or=="symbol"?function(r){var o;return r!=null&&(o=r[Or])&&o.apply(r)}:function(){return null};function At(r,o){return o=r.indexOf(o),0<=o&&r.splice(o,1),0<=o}var Gt={};function st(r){var o,l,u,d;if(arguments.length===1){if(f(r))return r.slice();if(this===Gt&&typeof r=="string")return[r];if(d=ul(r)){for(l=[];!(u=d.next()).done;)l.push(u.value);return l}if(r==null)return[r];if(typeof(o=r.length)!="number")return[r];for(l=new Array(o);o--;)l[o]=r[o];return l}for(o=arguments.length,l=new Array(o);o--;)l[o]=arguments[o];return l}var Nr=typeof Symbol<"u"?function(r){return r[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Pn=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Fe=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Pn),fl={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Wt(r,o){this.name=r,this.message=o}function wo(r,o){return r+". Errors: "+Object.keys(o).map(function(l){return o[l].toString()}).filter(function(l,u,d){return d.indexOf(l)===u}).join(`
`)}function us(r,o,l,u){this.failures=o,this.failedKeys=u,this.successCount=l,this.message=wo(r,o)}function Qt(r,o){this.name="BulkError",this.failures=Object.keys(o).map(function(l){return o[l]}),this.failuresByPos=o,this.message=wo(r,this.failures)}T(Wt).from(Error).extend({toString:function(){return this.name+": "+this.message}}),T(us).from(Wt),T(Qt).from(Wt);var $r=Fe.reduce(function(r,o){return r[o]=o+"Error",r},{}),dl=Wt,se=Fe.reduce(function(r,o){var l=o+"Error";function u(d,h){this.name=l,d?typeof d=="string"?(this.message="".concat(d).concat(h?`
 `+h:""),this.inner=h||null):typeof d=="object"&&(this.message="".concat(d.name," ").concat(d.message),this.inner=d):(this.message=fl[o]||l,this.inner=null)}return T(u).from(dl),r[o]=u,r},{});se.Syntax=SyntaxError,se.Type=TypeError,se.Range=RangeError;var ko=Pn.reduce(function(r,o){return r[o+"Error"]=se[o],r},{}),fs=Fe.reduce(function(r,o){return["Syntax","Type","Range"].indexOf(o)===-1&&(r[o+"Error"]=se[o]),r},{});function pe(){}function Nn(r){return r}function hl(r,o){return r==null||r===Nn?o:function(l){return o(r(l))}}function Lt(r,o){return function(){r.apply(this,arguments),o.apply(this,arguments)}}function pl(r,o){return r===pe?o:function(){var l=r.apply(this,arguments);l!==void 0&&(arguments[0]=l);var u=this.onsuccess,d=this.onerror;this.onsuccess=null,this.onerror=null;var h=o.apply(this,arguments);return u&&(this.onsuccess=this.onsuccess?Lt(u,this.onsuccess):u),d&&(this.onerror=this.onerror?Lt(d,this.onerror):d),h!==void 0?h:l}}function ml(r,o){return r===pe?o:function(){r.apply(this,arguments);var l=this.onsuccess,u=this.onerror;this.onsuccess=this.onerror=null,o.apply(this,arguments),l&&(this.onsuccess=this.onsuccess?Lt(l,this.onsuccess):l),u&&(this.onerror=this.onerror?Lt(u,this.onerror):u)}}function yl(r,o){return r===pe?o:function(l){var u=r.apply(this,arguments);p(l,u);var d=this.onsuccess,h=this.onerror;return this.onsuccess=null,this.onerror=null,l=o.apply(this,arguments),d&&(this.onsuccess=this.onsuccess?Lt(d,this.onsuccess):d),h&&(this.onerror=this.onerror?Lt(h,this.onerror):h),u===void 0?l===void 0?void 0:l:p(u,l)}}function gl(r,o){return r===pe?o:function(){return o.apply(this,arguments)!==!1&&r.apply(this,arguments)}}function Pr(r,o){return r===pe?o:function(){var l=r.apply(this,arguments);if(l&&typeof l.then=="function"){for(var u=this,d=arguments.length,h=new Array(d);d--;)h[d]=arguments[d];return l.then(function(){return o.apply(u,h)})}return o.apply(this,arguments)}}fs.ModifyError=us,fs.DexieError=Wt,fs.BulkError=Qt;var We=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function So(r){We=r}var $n={},Eo=100,Ct=typeof Promise>"u"?[]:function(){var r=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[r,m(r),r];var o=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[o,m(o),r]}(),Pn=Ct[0],Fe=Ct[1],Ct=Ct[2],Fe=Fe&&Fe.then,Ot=Pn&&Pn.constructor,xr=!!Ct,xn=function(r,o){Mn.push([r,o]),ds&&(queueMicrotask(bl),ds=!1)},Mr=!0,ds=!0,Nt=[],hs=[],Dr=Nn,dt={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:pe,pgp:!1,env:{},finalize:pe},Z=dt,Mn=[],$t=0,ps=[];function V(r){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var o=this._PSD=Z;if(typeof r!="function"){if(r!==$n)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&jr(this,this._value))}this._state=null,this._value=null,++o.ref,function l(u,d){try{d(function(h){if(u._state===null){if(h===u)throw new TypeError("A promise cannot be resolved with itself.");var y=u._lib&&Xt();h&&typeof h.then=="function"?l(u,function(g,w){h instanceof V?h._then(g,w):h.then(g,w)}):(u._state=!0,u._value=h,Io(u)),y&&Zt()}},jr.bind(null,u))}catch(h){jr(u,h)}}(this,r)}var Br={get:function(){var r=Z,o=vs;function l(u,d){var h=this,y=!r.global&&(r!==Z||o!==vs),g=y&&!pt(),w=new V(function(S,A){Kr(h,new _o(Ao(u,r,y,g),Ao(d,r,y,g),S,A,r))});return this._consoleTask&&(w._consoleTask=this._consoleTask),w}return l.prototype=$n,l},set:function(r){P(this,"then",r&&r.prototype===$n?Br:{get:function(){return r},set:Br.set})}};function _o(r,o,l,u,d){this.onFulfilled=typeof r=="function"?r:null,this.onRejected=typeof o=="function"?o:null,this.resolve=l,this.reject=u,this.psd=d}function jr(r,o){var l,u;hs.push(o),r._state===null&&(l=r._lib&&Xt(),o=Dr(o),r._state=!1,r._value=o,u=r,Nt.some(function(d){return d._value===u._value})||Nt.push(u),Io(r),l&&Zt())}function Io(r){var o=r._listeners;r._listeners=[];for(var l=0,u=o.length;l<u;++l)Kr(r,o[l]);var d=r._PSD;--d.ref||d.finalize(),$t===0&&(++$t,xn(function(){--$t==0&&Rr()},[]))}function Kr(r,o){if(r._state!==null){var l=r._state?o.onFulfilled:o.onRejected;if(l===null)return(r._state?o.resolve:o.reject)(r._value);++o.psd.ref,++$t,xn(vl,[l,r,o])}else r._listeners.push(o)}function vl(r,o,l){try{var u,d=o._value;!o._state&&hs.length&&(hs=[]),u=We&&o._consoleTask?o._consoleTask.run(function(){return r(d)}):r(d),o._state||hs.indexOf(d)!==-1||function(h){for(var y=Nt.length;y;)if(Nt[--y]._value===h._value)return Nt.splice(y,1)}(o),l.resolve(u)}catch(h){l.reject(h)}finally{--$t==0&&Rr(),--l.psd.ref||l.psd.finalize()}}function bl(){Pt(dt,function(){Xt()&&Zt()})}function Xt(){var r=Mr;return ds=Mr=!1,r}function Zt(){var r,o,l;do for(;0<Mn.length;)for(r=Mn,Mn=[],l=r.length,o=0;o<l;++o){var u=r[o];u[0].apply(null,u[1])}while(0<Mn.length);ds=Mr=!0}function Rr(){var r=Nt;Nt=[],r.forEach(function(u){u._PSD.onunhandled.call(null,u._value,u)});for(var o=ps.slice(0),l=o.length;l;)o[--l]()}function ms(r){return new V($n,!1,r)}function be(r,o){var l=Z;return function(){var u=Xt(),d=Z;try{return mt(l,!0),r.apply(this,arguments)}catch(h){o&&o(h)}finally{mt(d,!1),u&&Zt()}}}_(V.prototype,{then:Br,_then:function(r,o){Kr(this,new _o(null,null,r,o,Z))},catch:function(r){if(arguments.length===1)return this.then(null,r);var o=r,l=arguments[1];return typeof o=="function"?this.then(null,function(u){return(u instanceof o?l:ms)(u)}):this.then(null,function(u){return(u&&u.name===o?l:ms)(u)})},finally:function(r){return this.then(function(o){return V.resolve(r()).then(function(){return o})},function(o){return V.resolve(r()).then(function(){return ms(o)})})},timeout:function(r,o){var l=this;return r<1/0?new V(function(u,d){var h=setTimeout(function(){return d(new se.Timeout(o))},r);l.then(u,d).finally(clearTimeout.bind(null,h))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&P(V.prototype,Symbol.toStringTag,"Dexie.Promise"),dt.env=To(),_(V,{all:function(){var r=st.apply(null,arguments).map(bs);return new V(function(o,l){r.length===0&&o([]);var u=r.length;r.forEach(function(d,h){return V.resolve(d).then(function(y){r[h]=y,--u||o(r)},l)})})},resolve:function(r){return r instanceof V?r:r&&typeof r.then=="function"?new V(function(o,l){r.then(o,l)}):new V($n,!0,r)},reject:ms,race:function(){var r=st.apply(null,arguments).map(bs);return new V(function(o,l){r.map(function(u){return V.resolve(u).then(o,l)})})},PSD:{get:function(){return Z},set:function(r){return Z=r}},totalEchoes:{get:function(){return vs}},newPSD:ht,usePSD:Pt,scheduler:{get:function(){return xn},set:function(r){xn=r}},rejectionMapper:{get:function(){return Dr},set:function(r){Dr=r}},follow:function(r,o){return new V(function(l,u){return ht(function(d,h){var y=Z;y.unhandleds=[],y.onunhandled=h,y.finalize=Lt(function(){var g,w=this;g=function(){w.unhandleds.length===0?d():h(w.unhandleds[0])},ps.push(function S(){g(),ps.splice(ps.indexOf(S),1)}),++$t,xn(function(){--$t==0&&Rr()},[])},y.finalize),r()},o,l,u)})}}),Ot&&(Ot.allSettled&&P(V,"allSettled",function(){var r=st.apply(null,arguments).map(bs);return new V(function(o){r.length===0&&o([]);var l=r.length,u=new Array(l);r.forEach(function(d,h){return V.resolve(d).then(function(y){return u[h]={status:"fulfilled",value:y}},function(y){return u[h]={status:"rejected",reason:y}}).then(function(){return--l||o(u)})})})}),Ot.any&&typeof AggregateError<"u"&&P(V,"any",function(){var r=st.apply(null,arguments).map(bs);return new V(function(o,l){r.length===0&&l(new AggregateError([]));var u=r.length,d=new Array(u);r.forEach(function(h,y){return V.resolve(h).then(function(g){return o(g)},function(g){d[y]=g,--u||l(new AggregateError(d))})})})}),Ot.withResolvers&&(V.withResolvers=Ot.withResolvers));var Te={awaits:0,echoes:0,id:0},wl=0,ys=[],gs=0,vs=0,kl=0;function ht(r,o,l,u){var d=Z,h=Object.create(d);return h.parent=d,h.ref=0,h.global=!1,h.id=++kl,dt.env,h.env=xr?{Promise:V,PromiseProp:{value:V,configurable:!0,writable:!0},all:V.all,race:V.race,allSettled:V.allSettled,any:V.any,resolve:V.resolve,reject:V.reject}:{},o&&p(h,o),++d.ref,h.finalize=function(){--this.parent.ref||this.parent.finalize()},u=Pt(h,r,l,u),h.ref===0&&h.finalize(),u}function en(){return Te.id||(Te.id=++wl),++Te.awaits,Te.echoes+=Eo,Te.id}function pt(){return!!Te.awaits&&(--Te.awaits==0&&(Te.id=0),Te.echoes=Te.awaits*Eo,!0)}function bs(r){return Te.echoes&&r&&r.constructor===Ot?(en(),r.then(function(o){return pt(),o},function(o){return pt(),Ee(o)})):r}function Sl(){var r=ys[ys.length-1];ys.pop(),mt(r,!1)}function mt(r,o){var l,u=Z;(o?!Te.echoes||gs++&&r===Z:!gs||--gs&&r===Z)||queueMicrotask(o?(function(d){++vs,Te.echoes&&--Te.echoes!=0||(Te.echoes=Te.awaits=Te.id=0),ys.push(Z),mt(d,!0)}).bind(null,r):Sl),r!==Z&&(Z=r,u===dt&&(dt.env=To()),xr&&(l=dt.env.Promise,o=r.env,(u.global||r.global)&&(Object.defineProperty(a,"Promise",o.PromiseProp),l.all=o.all,l.race=o.race,l.resolve=o.resolve,l.reject=o.reject,o.allSettled&&(l.allSettled=o.allSettled),o.any&&(l.any=o.any))))}function To(){var r=a.Promise;return xr?{Promise:r,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:r.all,race:r.race,allSettled:r.allSettled,any:r.any,resolve:r.resolve,reject:r.reject}:{}}function Pt(r,o,l,u,d){var h=Z;try{return mt(r,!0),o(l,u,d)}finally{mt(h,!1)}}function Ao(r,o,l,u){return typeof r!="function"?r:function(){var d=Z;l&&en(),mt(o,!0);try{return r.apply(this,arguments)}finally{mt(d,!1),u&&queueMicrotask(pt)}}}function qr(r){Promise===Ot&&Te.echoes===0?gs===0?r():enqueueNativeMicroTask(r):setTimeout(r,0)}(""+Fe).indexOf("[native code]")===-1&&(en=pt=pe);var Ee=V.reject,xt="￿",rt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Lo="String expected.",tn=[],ws="__dbnames",Fr="readonly",Ur="readwrite";function Mt(r,o){return r?o?function(){return r.apply(this,arguments)&&o.apply(this,arguments)}:r:o}var Co={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function ks(r){return typeof r!="string"||/\./.test(r)?function(o){return o}:function(o){return o[r]===void 0&&r in o&&delete(o=Ge(o))[r],o}}function Oo(){throw se.Type()}function fe(r,o){try{var l=No(r),u=No(o);if(l!==u)return l==="Array"?1:u==="Array"?-1:l==="binary"?1:u==="binary"?-1:l==="string"?1:u==="string"?-1:l==="Date"?1:u!=="Date"?NaN:-1;switch(l){case"number":case"Date":case"string":return o<r?1:r<o?-1:0;case"binary":return function(d,h){for(var y=d.length,g=h.length,w=y<g?y:g,S=0;S<w;++S)if(d[S]!==h[S])return d[S]<h[S]?-1:1;return y===g?0:y<g?-1:1}($o(r),$o(o));case"Array":return function(d,h){for(var y=d.length,g=h.length,w=y<g?y:g,S=0;S<w;++S){var A=fe(d[S],h[S]);if(A!==0)return A}return y===g?0:y<g?-1:1}(r,o)}}catch{}return NaN}function No(r){var o=typeof r;return o!="object"?o:ArrayBuffer.isView(r)?"binary":(r=Cr(r),r==="ArrayBuffer"?"binary":r)}function $o(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r)}var Po=(ve.prototype._trans=function(r,o,l){var u=this._tx||Z.trans,d=this.name,h=We&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(r==="readonly"?"read":"write"," ").concat(this.name));function y(S,A,v){if(!v.schema[d])throw new se.NotFound("Table "+d+" not part of transaction");return o(v.idbtrans,v)}var g=Xt();try{var w=u&&u.db._novip===this.db._novip?u===Z.trans?u._promise(r,y,l):ht(function(){return u._promise(r,y,l)},{trans:u,transless:Z.transless||Z}):function S(A,v,N,k){if(A.idbdb&&(A._state.openComplete||Z.letThrough||A._vip)){var I=A._createTransaction(v,N,A._dbSchema);try{I.create(),A._state.PR1398_maxLoop=3}catch(O){return O.name===$r.InvalidState&&A.isOpen()&&0<--A._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),A.close({disableAutoOpen:!1}),A.open().then(function(){return S(A,v,N,k)})):Ee(O)}return I._promise(v,function(O,E){return ht(function(){return Z.trans=I,k(O,E,I)})}).then(function(O){if(v==="readwrite")try{I.idbtrans.commit()}catch{}return v==="readonly"?O:I._completion.then(function(){return O})})}if(A._state.openComplete)return Ee(new se.DatabaseClosed(A._state.dbOpenError));if(!A._state.isBeingOpened){if(!A._state.autoOpen)return Ee(new se.DatabaseClosed);A.open().catch(pe)}return A._state.dbReadyPromise.then(function(){return S(A,v,N,k)})}(this.db,r,[this.name],y);return h&&(w._consoleTask=h,w=w.catch(function(S){return console.trace(S),Ee(S)})),w}finally{g&&Zt()}},ve.prototype.get=function(r,o){var l=this;return r&&r.constructor===Object?this.where(r).first(o):r==null?Ee(new se.Type("Invalid argument to Table.get()")):this._trans("readonly",function(u){return l.core.get({trans:u,key:r}).then(function(d){return l.hook.reading.fire(d)})}).then(o)},ve.prototype.where=function(r){if(typeof r=="string")return new this.db.WhereClause(this,r);if(f(r))return new this.db.WhereClause(this,"[".concat(r.join("+"),"]"));var o=c(r);if(o.length===1)return this.where(o[0]).equals(r[o[0]]);var l=this.schema.indexes.concat(this.schema.primKey).filter(function(g){if(g.compound&&o.every(function(S){return 0<=g.keyPath.indexOf(S)})){for(var w=0;w<o.length;++w)if(o.indexOf(g.keyPath[w])===-1)return!1;return!0}return!1}).sort(function(g,w){return g.keyPath.length-w.keyPath.length})[0];if(l&&this.db._maxKey!==xt){var h=l.keyPath.slice(0,o.length);return this.where(h).equals(h.map(function(w){return r[w]}))}!l&&We&&console.warn("The query ".concat(JSON.stringify(r)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(o.join("+"),"]"));var u=this.schema.idxByName;function d(g,w){return fe(g,w)===0}var y=o.reduce(function(v,w){var S=v[0],A=v[1],v=u[w],N=r[w];return[S||v,S||!v?Mt(A,v&&v.multi?function(k){return k=te(k,w),f(k)&&k.some(function(I){return d(N,I)})}:function(k){return d(N,te(k,w))}):A]},[null,null]),h=y[0],y=y[1];return h?this.where(h.name).equals(r[h.keyPath]).filter(y):l?this.filter(y):this.where(o).equals("")},ve.prototype.filter=function(r){return this.toCollection().and(r)},ve.prototype.count=function(r){return this.toCollection().count(r)},ve.prototype.offset=function(r){return this.toCollection().offset(r)},ve.prototype.limit=function(r){return this.toCollection().limit(r)},ve.prototype.each=function(r){return this.toCollection().each(r)},ve.prototype.toArray=function(r){return this.toCollection().toArray(r)},ve.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},ve.prototype.orderBy=function(r){return new this.db.Collection(new this.db.WhereClause(this,f(r)?"[".concat(r.join("+"),"]"):r))},ve.prototype.reverse=function(){return this.toCollection().reverse()},ve.prototype.mapToClass=function(r){var o,l=this.db,u=this.name;function d(){return o!==null&&o.apply(this,arguments)||this}(this.schema.mappedClass=r).prototype instanceof Oo&&(function(w,S){if(typeof S!="function"&&S!==null)throw new TypeError("Class extends value "+String(S)+" is not a constructor or null");function A(){this.constructor=w}t(w,S),w.prototype=S===null?Object.create(S):(A.prototype=S.prototype,new A)}(d,o=r),Object.defineProperty(d.prototype,"db",{get:function(){return l},enumerable:!1,configurable:!0}),d.prototype.table=function(){return u},r=d);for(var h=new Set,y=r.prototype;y;y=m(y))Object.getOwnPropertyNames(y).forEach(function(w){return h.add(w)});function g(w){if(!w)return w;var S,A=Object.create(r.prototype);for(S in w)if(!h.has(S))try{A[S]=w[S]}catch{}return A}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=g,this.hook("reading",g),r},ve.prototype.defineClass=function(){return this.mapToClass(function(r){p(this,r)})},ve.prototype.add=function(r,o){var l=this,u=this.schema.primKey,d=u.auto,h=u.keyPath,y=r;return h&&d&&(y=ks(h)(r)),this._trans("readwrite",function(g){return l.core.mutate({trans:g,type:"add",keys:o!=null?[o]:null,values:[y]})}).then(function(g){return g.numFailures?V.reject(g.failures[0]):g.lastResult}).then(function(g){if(h)try{ae(r,h,g)}catch{}return g})},ve.prototype.update=function(r,o){return typeof r!="object"||f(r)?this.where(":id").equals(r).modify(o):(r=te(r,this.schema.primKey.keyPath),r===void 0?Ee(new se.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(r).modify(o))},ve.prototype.put=function(r,o){var l=this,u=this.schema.primKey,d=u.auto,h=u.keyPath,y=r;return h&&d&&(y=ks(h)(r)),this._trans("readwrite",function(g){return l.core.mutate({trans:g,type:"put",values:[y],keys:o!=null?[o]:null})}).then(function(g){return g.numFailures?V.reject(g.failures[0]):g.lastResult}).then(function(g){if(h)try{ae(r,h,g)}catch{}return g})},ve.prototype.delete=function(r){var o=this;return this._trans("readwrite",function(l){return o.core.mutate({trans:l,type:"delete",keys:[r]})}).then(function(l){return l.numFailures?V.reject(l.failures[0]):void 0})},ve.prototype.clear=function(){var r=this;return this._trans("readwrite",function(o){return r.core.mutate({trans:o,type:"deleteRange",range:Co})}).then(function(o){return o.numFailures?V.reject(o.failures[0]):void 0})},ve.prototype.bulkGet=function(r){var o=this;return this._trans("readonly",function(l){return o.core.getMany({keys:r,trans:l}).then(function(u){return u.map(function(d){return o.hook.reading.fire(d)})})})},ve.prototype.bulkAdd=function(r,o,l){var u=this,d=Array.isArray(o)?o:void 0,h=(l=l||(d?void 0:o))?l.allKeys:void 0;return this._trans("readwrite",function(y){var S=u.schema.primKey,g=S.auto,S=S.keyPath;if(S&&d)throw new se.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(d&&d.length!==r.length)throw new se.InvalidArgument("Arguments objects and keys must have the same length");var w=r.length,S=S&&g?r.map(ks(S)):r;return u.core.mutate({trans:y,type:"add",keys:d,values:S,wantResults:h}).then(function(I){var v=I.numFailures,N=I.results,k=I.lastResult,I=I.failures;if(v===0)return h?N:k;throw new Qt("".concat(u.name,".bulkAdd(): ").concat(v," of ").concat(w," operations failed"),I)})})},ve.prototype.bulkPut=function(r,o,l){var u=this,d=Array.isArray(o)?o:void 0,h=(l=l||(d?void 0:o))?l.allKeys:void 0;return this._trans("readwrite",function(y){var S=u.schema.primKey,g=S.auto,S=S.keyPath;if(S&&d)throw new se.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(d&&d.length!==r.length)throw new se.InvalidArgument("Arguments objects and keys must have the same length");var w=r.length,S=S&&g?r.map(ks(S)):r;return u.core.mutate({trans:y,type:"put",keys:d,values:S,wantResults:h}).then(function(I){var v=I.numFailures,N=I.results,k=I.lastResult,I=I.failures;if(v===0)return h?N:k;throw new Qt("".concat(u.name,".bulkPut(): ").concat(v," of ").concat(w," operations failed"),I)})})},ve.prototype.bulkUpdate=function(r){var o=this,l=this.core,u=r.map(function(y){return y.key}),d=r.map(function(y){return y.changes}),h=[];return this._trans("readwrite",function(y){return l.getMany({trans:y,keys:u,cache:"clone"}).then(function(g){var w=[],S=[];r.forEach(function(v,N){var k=v.key,I=v.changes,O=g[N];if(O){for(var E=0,$=Object.keys(I);E<$.length;E++){var x=$[E],M=I[x];if(x===o.schema.primKey.keyPath){if(fe(M,k)!==0)throw new se.Constraint("Cannot update primary key in bulkUpdate()")}else ae(O,x,M)}h.push(N),w.push(k),S.push(O)}});var A=w.length;return l.mutate({trans:y,type:"put",keys:w,values:S,updates:{keys:u,changeSpecs:d}}).then(function(v){var N=v.numFailures,k=v.failures;if(N===0)return A;for(var I=0,O=Object.keys(k);I<O.length;I++){var E,$=O[I],x=h[Number($)];x!=null&&(E=k[$],delete k[$],k[x]=E)}throw new Qt("".concat(o.name,".bulkUpdate(): ").concat(N," of ").concat(A," operations failed"),k)})})})},ve.prototype.bulkDelete=function(r){var o=this,l=r.length;return this._trans("readwrite",function(u){return o.core.mutate({trans:u,type:"delete",keys:r})}).then(function(y){var d=y.numFailures,h=y.lastResult,y=y.failures;if(d===0)return h;throw new Qt("".concat(o.name,".bulkDelete(): ").concat(d," of ").concat(l," operations failed"),y)})},ve);function ve(){}function Dn(r){function o(y,g){if(g){for(var w=arguments.length,S=new Array(w-1);--w;)S[w-1]=arguments[w];return l[y].subscribe.apply(null,S),r}if(typeof y=="string")return l[y]}var l={};o.addEventType=h;for(var u=1,d=arguments.length;u<d;++u)h(arguments[u]);return o;function h(y,g,w){if(typeof y!="object"){var S;g=g||gl;var A={subscribers:[],fire:w=w||pe,subscribe:function(v){A.subscribers.indexOf(v)===-1&&(A.subscribers.push(v),A.fire=g(A.fire,v))},unsubscribe:function(v){A.subscribers=A.subscribers.filter(function(N){return N!==v}),A.fire=A.subscribers.reduce(g,w)}};return l[y]=o[y]=A}c(S=y).forEach(function(v){var N=S[v];if(f(N))h(v,S[v][0],S[v][1]);else{if(N!=="asap")throw new se.InvalidArgument("Invalid event config");var k=h(v,Nn,function(){for(var I=arguments.length,O=new Array(I);I--;)O[I]=arguments[I];k.subscribers.forEach(function(E){ee(function(){E.apply(null,O)})})})}})}}function Bn(r,o){return T(o).from({prototype:r}),o}function nn(r,o){return!(r.filter||r.algorithm||r.or)&&(o?r.justLimit:!r.replayFilter)}function Hr(r,o){r.filter=Mt(r.filter,o)}function zr(r,o,l){var u=r.replayFilter;r.replayFilter=u?function(){return Mt(u(),o())}:o,r.justLimit=l&&!u}function Ss(r,o){if(r.isPrimKey)return o.primaryKey;var l=o.getIndexByKeyPath(r.index);if(!l)throw new se.Schema("KeyPath "+r.index+" on object store "+o.name+" is not indexed");return l}function xo(r,o,l){var u=Ss(r,o.schema);return o.openCursor({trans:l,values:!r.keysOnly,reverse:r.dir==="prev",unique:!!r.unique,query:{index:u,range:r.range}})}function Es(r,o,l,u){var d=r.replayFilter?Mt(r.filter,r.replayFilter()):r.filter;if(r.or){var h={},y=function(g,w,S){var A,v;d&&!d(w,S,function(N){return w.stop(N)},function(N){return w.fail(N)})||((v=""+(A=w.primaryKey))=="[object ArrayBuffer]"&&(v=""+new Uint8Array(A)),b(h,v)||(h[v]=!0,o(g,w,S)))};return Promise.all([r.or._iterate(y,l),Mo(xo(r,u,l),r.algorithm,y,!r.keysOnly&&r.valueMapper)])}return Mo(xo(r,u,l),Mt(r.algorithm,d),o,!r.keysOnly&&r.valueMapper)}function Mo(r,o,l,u){var d=be(u?function(h,y,g){return l(u(h),y,g)}:l);return r.then(function(h){if(h)return h.start(function(){var y=function(){return h.continue()};o&&!o(h,function(g){return y=g},function(g){h.stop(g),y=pe},function(g){h.fail(g),y=pe})||d(h.value,h,function(g){return y=g}),y()})})}var jn=(Do.prototype.execute=function(r){var o=this["@@propmod"];if(o.add!==void 0){var l=o.add;if(f(l))return i(i([],f(r)?r:[],!0),l).sort();if(typeof l=="number")return(Number(r)||0)+l;if(typeof l=="bigint")try{return BigInt(r)+l}catch{return BigInt(0)+l}throw new TypeError("Invalid term ".concat(l))}if(o.remove!==void 0){var u=o.remove;if(f(u))return f(r)?r.filter(function(d){return!u.includes(d)}).sort():[];if(typeof u=="number")return Number(r)-u;if(typeof u=="bigint")try{return BigInt(r)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return l=(l=o.replacePrefix)===null||l===void 0?void 0:l[0],l&&typeof r=="string"&&r.startsWith(l)?o.replacePrefix[1]+r.substring(l.length):r},Do);function Do(r){this["@@propmod"]=r}var El=(de.prototype._read=function(r,o){var l=this._ctx;return l.error?l.table._trans(null,Ee.bind(null,l.error)):l.table._trans("readonly",r).then(o)},de.prototype._write=function(r){var o=this._ctx;return o.error?o.table._trans(null,Ee.bind(null,o.error)):o.table._trans("readwrite",r,"locked")},de.prototype._addAlgorithm=function(r){var o=this._ctx;o.algorithm=Mt(o.algorithm,r)},de.prototype._iterate=function(r,o){return Es(this._ctx,r,o,this._ctx.table.core)},de.prototype.clone=function(r){var o=Object.create(this.constructor.prototype),l=Object.create(this._ctx);return r&&p(l,r),o._ctx=l,o},de.prototype.raw=function(){return this._ctx.valueMapper=null,this},de.prototype.each=function(r){var o=this._ctx;return this._read(function(l){return Es(o,r,l,o.table.core)})},de.prototype.count=function(r){var o=this;return this._read(function(l){var u=o._ctx,d=u.table.core;if(nn(u,!0))return d.count({trans:l,query:{index:Ss(u,d.schema),range:u.range}}).then(function(y){return Math.min(y,u.limit)});var h=0;return Es(u,function(){return++h,!1},l,d).then(function(){return h})}).then(r)},de.prototype.sortBy=function(r,o){var l=r.split(".").reverse(),u=l[0],d=l.length-1;function h(w,S){return S?h(w[l[S]],S-1):w[u]}var y=this._ctx.dir==="next"?1:-1;function g(w,S){return fe(h(w,d),h(S,d))*y}return this.toArray(function(w){return w.sort(g)}).then(o)},de.prototype.toArray=function(r){var o=this;return this._read(function(l){var u=o._ctx;if(u.dir==="next"&&nn(u,!0)&&0<u.limit){var d=u.valueMapper,h=Ss(u,u.table.core.schema);return u.table.core.query({trans:l,limit:u.limit,values:!0,query:{index:h,range:u.range}}).then(function(g){return g=g.result,d?g.map(d):g})}var y=[];return Es(u,function(g){return y.push(g)},l,u.table.core).then(function(){return y})},r)},de.prototype.offset=function(r){var o=this._ctx;return r<=0||(o.offset+=r,nn(o)?zr(o,function(){var l=r;return function(u,d){return l===0||(l===1?--l:d(function(){u.advance(l),l=0}),!1)}}):zr(o,function(){var l=r;return function(){return--l<0}})),this},de.prototype.limit=function(r){return this._ctx.limit=Math.min(this._ctx.limit,r),zr(this._ctx,function(){var o=r;return function(l,u,d){return--o<=0&&u(d),0<=o}},!0),this},de.prototype.until=function(r,o){return Hr(this._ctx,function(l,u,d){return!r(l.value)||(u(d),o)}),this},de.prototype.first=function(r){return this.limit(1).toArray(function(o){return o[0]}).then(r)},de.prototype.last=function(r){return this.reverse().first(r)},de.prototype.filter=function(r){var o;return Hr(this._ctx,function(l){return r(l.value)}),(o=this._ctx).isMatch=Mt(o.isMatch,r),this},de.prototype.and=function(r){return this.filter(r)},de.prototype.or=function(r){return new this.db.WhereClause(this._ctx.table,r,this)},de.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},de.prototype.desc=function(){return this.reverse()},de.prototype.eachKey=function(r){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(l,u){r(u.key,u)})},de.prototype.eachUniqueKey=function(r){return this._ctx.unique="unique",this.eachKey(r)},de.prototype.eachPrimaryKey=function(r){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(l,u){r(u.primaryKey,u)})},de.prototype.keys=function(r){var o=this._ctx;o.keysOnly=!o.isMatch;var l=[];return this.each(function(u,d){l.push(d.key)}).then(function(){return l}).then(r)},de.prototype.primaryKeys=function(r){var o=this._ctx;if(o.dir==="next"&&nn(o,!0)&&0<o.limit)return this._read(function(u){var d=Ss(o,o.table.core.schema);return o.table.core.query({trans:u,values:!1,limit:o.limit,query:{index:d,range:o.range}})}).then(function(u){return u.result}).then(r);o.keysOnly=!o.isMatch;var l=[];return this.each(function(u,d){l.push(d.primaryKey)}).then(function(){return l}).then(r)},de.prototype.uniqueKeys=function(r){return this._ctx.unique="unique",this.keys(r)},de.prototype.firstKey=function(r){return this.limit(1).keys(function(o){return o[0]}).then(r)},de.prototype.lastKey=function(r){return this.reverse().firstKey(r)},de.prototype.distinct=function(){var r=this._ctx,r=r.index&&r.table.schema.idxByName[r.index];if(!r||!r.multi)return this;var o={};return Hr(this._ctx,function(d){var u=d.primaryKey.toString(),d=b(o,u);return o[u]=!0,!d}),this},de.prototype.modify=function(r){var o=this,l=this._ctx;return this._write(function(u){var d,h,y;y=typeof r=="function"?r:(d=c(r),h=d.length,function(E){for(var $=!1,x=0;x<h;++x){var M=d[x],j=r[M],K=te(E,M);j instanceof jn?(ae(E,M,j.execute(K)),$=!0):K!==j&&(ae(E,M,j),$=!0)}return $});var g=l.table.core,v=g.schema.primaryKey,w=v.outbound,S=v.extractKey,A=200,v=o.db._options.modifyChunkSize;v&&(A=typeof v=="object"?v[g.name]||v["*"]||200:v);function N(E,M){var x=M.failures,M=M.numFailures;I+=E-M;for(var j=0,K=c(x);j<K.length;j++){var U=K[j];k.push(x[U])}}var k=[],I=0,O=[];return o.clone().primaryKeys().then(function(E){function $(M){var j=Math.min(A,E.length-M);return g.getMany({trans:u,keys:E.slice(M,M+j),cache:"immutable"}).then(function(K){for(var U=[],R=[],q=w?[]:null,H=[],F=0;F<j;++F){var Y=K[F],ce={value:Ge(Y),primKey:E[M+F]};y.call(ce,ce.value,ce)!==!1&&(ce.value==null?H.push(E[M+F]):w||fe(S(Y),S(ce.value))===0?(R.push(ce.value),w&&q.push(E[M+F])):(H.push(E[M+F]),U.push(ce.value)))}return Promise.resolve(0<U.length&&g.mutate({trans:u,type:"add",values:U}).then(function(le){for(var ue in le.failures)H.splice(parseInt(ue),1);N(U.length,le)})).then(function(){return(0<R.length||x&&typeof r=="object")&&g.mutate({trans:u,type:"put",keys:q,values:R,criteria:x,changeSpec:typeof r!="function"&&r,isAdditionalChunk:0<M}).then(function(le){return N(R.length,le)})}).then(function(){return(0<H.length||x&&r===Vr)&&g.mutate({trans:u,type:"delete",keys:H,criteria:x,isAdditionalChunk:0<M}).then(function(le){return N(H.length,le)})}).then(function(){return E.length>M+j&&$(M+A)})})}var x=nn(l)&&l.limit===1/0&&(typeof r!="function"||r===Vr)&&{index:l.index,range:l.range};return $(0).then(function(){if(0<k.length)throw new us("Error modifying one or more objects",k,I,O);return E.length})})})},de.prototype.delete=function(){var r=this._ctx,o=r.range;return nn(r)&&(r.isPrimKey||o.type===3)?this._write(function(l){var u=r.table.core.schema.primaryKey,d=o;return r.table.core.count({trans:l,query:{index:u,range:d}}).then(function(h){return r.table.core.mutate({trans:l,type:"deleteRange",range:d}).then(function(y){var g=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new us("Could not delete some values",Object.keys(g).map(function(w){return g[w]}),h-y);return h-y})})}):this.modify(Vr)},de);function de(){}var Vr=function(r,o){return o.value=null};function _l(r,o){return r<o?-1:r===o?0:1}function Il(r,o){return o<r?-1:r===o?0:1}function Ke(r,o,l){return r=r instanceof jo?new r.Collection(r):r,r._ctx.error=new(l||TypeError)(o),r}function sn(r){return new r.Collection(r,function(){return Bo("")}).limit(0)}function _s(r,o,l,u){var d,h,y,g,w,S,A,v=l.length;if(!l.every(function(I){return typeof I=="string"}))return Ke(r,Lo);function N(I){d=I==="next"?function(E){return E.toUpperCase()}:function(E){return E.toLowerCase()},h=I==="next"?function(E){return E.toLowerCase()}:function(E){return E.toUpperCase()},y=I==="next"?_l:Il;var O=l.map(function(E){return{lower:h(E),upper:d(E)}}).sort(function(E,$){return y(E.lower,$.lower)});g=O.map(function(E){return E.upper}),w=O.map(function(E){return E.lower}),A=(S=I)==="next"?"":u}N("next"),r=new r.Collection(r,function(){return yt(g[0],w[v-1]+u)}),r._ondirectionchange=function(I){N(I)};var k=0;return r._addAlgorithm(function(I,O,E){var $=I.key;if(typeof $!="string")return!1;var x=h($);if(o(x,w,k))return!0;for(var M=null,j=k;j<v;++j){var K=function(U,R,q,H,F,Y){for(var ce=Math.min(U.length,H.length),le=-1,ue=0;ue<ce;++ue){var Re=R[ue];if(Re!==H[ue])return F(U[ue],q[ue])<0?U.substr(0,ue)+q[ue]+q.substr(ue+1):F(U[ue],H[ue])<0?U.substr(0,ue)+H[ue]+q.substr(ue+1):0<=le?U.substr(0,le)+R[le]+q.substr(le+1):null;F(U[ue],Re)<0&&(le=ue)}return ce<H.length&&Y==="next"?U+q.substr(U.length):ce<U.length&&Y==="prev"?U.substr(0,q.length):le<0?null:U.substr(0,le)+H[le]+q.substr(le+1)}($,x,g[j],w[j],y,S);K===null&&M===null?k=j+1:(M===null||0<y(M,K))&&(M=K)}return O(M!==null?function(){I.continue(M+A)}:E),!1}),r}function yt(r,o,l,u){return{type:2,lower:r,upper:o,lowerOpen:l,upperOpen:u}}function Bo(r){return{type:1,lower:r,upper:r}}var jo=(Object.defineProperty(Ae.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ae.prototype.between=function(r,o,l,u){l=l!==!1,u=u===!0;try{return 0<this._cmp(r,o)||this._cmp(r,o)===0&&(l||u)&&(!l||!u)?sn(this):new this.Collection(this,function(){return yt(r,o,!l,!u)})}catch{return Ke(this,rt)}},Ae.prototype.equals=function(r){return r==null?Ke(this,rt):new this.Collection(this,function(){return Bo(r)})},Ae.prototype.above=function(r){return r==null?Ke(this,rt):new this.Collection(this,function(){return yt(r,void 0,!0)})},Ae.prototype.aboveOrEqual=function(r){return r==null?Ke(this,rt):new this.Collection(this,function(){return yt(r,void 0,!1)})},Ae.prototype.below=function(r){return r==null?Ke(this,rt):new this.Collection(this,function(){return yt(void 0,r,!1,!0)})},Ae.prototype.belowOrEqual=function(r){return r==null?Ke(this,rt):new this.Collection(this,function(){return yt(void 0,r)})},Ae.prototype.startsWith=function(r){return typeof r!="string"?Ke(this,Lo):this.between(r,r+xt,!0,!0)},Ae.prototype.startsWithIgnoreCase=function(r){return r===""?this.startsWith(r):_s(this,function(o,l){return o.indexOf(l[0])===0},[r],xt)},Ae.prototype.equalsIgnoreCase=function(r){return _s(this,function(o,l){return o===l[0]},[r],"")},Ae.prototype.anyOfIgnoreCase=function(){var r=st.apply(Gt,arguments);return r.length===0?sn(this):_s(this,function(o,l){return l.indexOf(o)!==-1},r,"")},Ae.prototype.startsWithAnyOfIgnoreCase=function(){var r=st.apply(Gt,arguments);return r.length===0?sn(this):_s(this,function(o,l){return l.some(function(u){return o.indexOf(u)===0})},r,xt)},Ae.prototype.anyOf=function(){var r=this,o=st.apply(Gt,arguments),l=this._cmp;try{o.sort(l)}catch{return Ke(this,rt)}if(o.length===0)return sn(this);var u=new this.Collection(this,function(){return yt(o[0],o[o.length-1])});u._ondirectionchange=function(h){l=h==="next"?r._ascending:r._descending,o.sort(l)};var d=0;return u._addAlgorithm(function(h,y,g){for(var w=h.key;0<l(w,o[d]);)if(++d===o.length)return y(g),!1;return l(w,o[d])===0||(y(function(){h.continue(o[d])}),!1)}),u},Ae.prototype.notEqual=function(r){return this.inAnyRange([[-1/0,r],[r,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ae.prototype.noneOf=function(){var r=st.apply(Gt,arguments);if(r.length===0)return new this.Collection(this);try{r.sort(this._ascending)}catch{return Ke(this,rt)}var o=r.reduce(function(l,u){return l?l.concat([[l[l.length-1][1],u]]):[[-1/0,u]]},null);return o.push([r[r.length-1],this.db._maxKey]),this.inAnyRange(o,{includeLowers:!1,includeUppers:!1})},Ae.prototype.inAnyRange=function($,o){var l=this,u=this._cmp,d=this._ascending,h=this._descending,y=this._min,g=this._max;if($.length===0)return sn(this);if(!$.every(function(x){return x[0]!==void 0&&x[1]!==void 0&&d(x[0],x[1])<=0}))return Ke(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",se.InvalidArgument);var w=!o||o.includeLowers!==!1,S=o&&o.includeUppers===!0,A,v=d;function N(x,M){return v(x[0],M[0])}try{(A=$.reduce(function(x,M){for(var j=0,K=x.length;j<K;++j){var U=x[j];if(u(M[0],U[1])<0&&0<u(M[1],U[0])){U[0]=y(U[0],M[0]),U[1]=g(U[1],M[1]);break}}return j===K&&x.push(M),x},[])).sort(N)}catch{return Ke(this,rt)}var k=0,I=S?function(x){return 0<d(x,A[k][1])}:function(x){return 0<=d(x,A[k][1])},O=w?function(x){return 0<h(x,A[k][0])}:function(x){return 0<=h(x,A[k][0])},E=I,$=new this.Collection(this,function(){return yt(A[0][0],A[A.length-1][1],!w,!S)});return $._ondirectionchange=function(x){v=x==="next"?(E=I,d):(E=O,h),A.sort(N)},$._addAlgorithm(function(x,M,j){for(var K,U=x.key;E(U);)if(++k===A.length)return M(j),!1;return!I(K=U)&&!O(K)||(l._cmp(U,A[k][1])===0||l._cmp(U,A[k][0])===0||M(function(){v===d?x.continue(A[k][0]):x.continue(A[k][1])}),!1)}),$},Ae.prototype.startsWithAnyOf=function(){var r=st.apply(Gt,arguments);return r.every(function(o){return typeof o=="string"})?r.length===0?sn(this):this.inAnyRange(r.map(function(o){return[o,o+xt]})):Ke(this,"startsWithAnyOf() only works with strings")},Ae);function Ae(){}function Qe(r){return be(function(o){return Kn(o),r(o.target.error),!1})}function Kn(r){r.stopPropagation&&r.stopPropagation(),r.preventDefault&&r.preventDefault()}var Rn="storagemutated",Yr="x-storagemutated-1",gt=Dn(null,Rn),Tl=(Xe.prototype._lock=function(){return Q(!Z.global),++this._reculock,this._reculock!==1||Z.global||(Z.lockOwnerFor=this),this},Xe.prototype._unlock=function(){if(Q(!Z.global),--this._reculock==0)for(Z.global||(Z.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var r=this._blockedFuncs.shift();try{Pt(r[1],r[0])}catch{}}return this},Xe.prototype._locked=function(){return this._reculock&&Z.lockOwnerFor!==this},Xe.prototype.create=function(r){var o=this;if(!this.mode)return this;var l=this.db.idbdb,u=this.db._state.dbOpenError;if(Q(!this.idbtrans),!r&&!l)switch(u&&u.name){case"DatabaseClosedError":throw new se.DatabaseClosed(u);case"MissingAPIError":throw new se.MissingAPI(u.message,u);default:throw new se.OpenFailed(u)}if(!this.active)throw new se.TransactionInactive;return Q(this._completion._state===null),(r=this.idbtrans=r||(this.db.core||l).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=be(function(d){Kn(d),o._reject(r.error)}),r.onabort=be(function(d){Kn(d),o.active&&o._reject(new se.Abort(r.error)),o.active=!1,o.on("abort").fire(d)}),r.oncomplete=be(function(){o.active=!1,o._resolve(),"mutatedParts"in r&&gt.storagemutated.fire(r.mutatedParts)}),this},Xe.prototype._promise=function(r,o,l){var u=this;if(r==="readwrite"&&this.mode!=="readwrite")return Ee(new se.ReadOnly("Transaction is readonly"));if(!this.active)return Ee(new se.TransactionInactive);if(this._locked())return new V(function(h,y){u._blockedFuncs.push([function(){u._promise(r,o,l).then(h,y)},Z])});if(l)return ht(function(){var h=new V(function(y,g){u._lock();var w=o(y,g,u);w&&w.then&&w.then(y,g)});return h.finally(function(){return u._unlock()}),h._lib=!0,h});var d=new V(function(h,y){var g=o(h,y,u);g&&g.then&&g.then(h,y)});return d._lib=!0,d},Xe.prototype._root=function(){return this.parent?this.parent._root():this},Xe.prototype.waitFor=function(r){var o,l=this._root(),u=V.resolve(r);l._waitingFor?l._waitingFor=l._waitingFor.then(function(){return u}):(l._waitingFor=u,l._waitingQueue=[],o=l.idbtrans.objectStore(l.storeNames[0]),function h(){for(++l._spinCount;l._waitingQueue.length;)l._waitingQueue.shift()();l._waitingFor&&(o.get(-1/0).onsuccess=h)}());var d=l._waitingFor;return new V(function(h,y){u.then(function(g){return l._waitingQueue.push(be(h.bind(null,g)))},function(g){return l._waitingQueue.push(be(y.bind(null,g)))}).finally(function(){l._waitingFor===d&&(l._waitingFor=null)})})},Xe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new se.Abort))},Xe.prototype.table=function(r){var o=this._memoizedTables||(this._memoizedTables={});if(b(o,r))return o[r];var l=this.schema[r];if(!l)throw new se.NotFound("Table "+r+" not part of transaction");return l=new this.db.Table(r,l,this),l.core=this.db.core.table(r),o[r]=l},Xe);function Xe(){}function Jr(r,o,l,u,d,h,y){return{name:r,keyPath:o,unique:l,multi:u,auto:d,compound:h,src:(l&&!y?"&":"")+(u?"*":"")+(d?"++":"")+Ko(o)}}function Ko(r){return typeof r=="string"?r:r?"["+[].join.call(r,"+")+"]":""}function Gr(r,o,l){return{name:r,primKey:o,indexes:l,mappedClass:null,idxByName:(u=function(d){return[d.name,d]},l.reduce(function(d,h,y){return y=u(h,y),y&&(d[y[0]]=y[1]),d},{}))};var u}var qn=function(r){try{return r.only([[]]),qn=function(){return[[]]},[[]]}catch{return qn=function(){return xt},xt}};function Wr(r){return r==null?function(){}:typeof r=="string"?(o=r).split(".").length===1?function(l){return l[o]}:function(l){return te(l,o)}:function(l){return te(l,r)};var o}function Ro(r){return[].slice.call(r)}var Al=0;function Fn(r){return r==null?":id":typeof r=="string"?r:"[".concat(r.join("+"),"]")}function Ll(r,o,w){function u(E){if(E.type===3)return null;if(E.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var k=E.lower,I=E.upper,O=E.lowerOpen,E=E.upperOpen;return k===void 0?I===void 0?null:o.upperBound(I,!!E):I===void 0?o.lowerBound(k,!!O):o.bound(k,I,!!O,!!E)}function d(N){var k,I=N.name;return{name:I,schema:N,mutate:function(O){var E=O.trans,$=O.type,x=O.keys,M=O.values,j=O.range;return new Promise(function(K,U){K=be(K);var R=E.objectStore(I),q=R.keyPath==null,H=$==="put"||$==="add";if(!H&&$!=="delete"&&$!=="deleteRange")throw new Error("Invalid operation type: "+$);var F,Y=(x||M||{length:1}).length;if(x&&M&&x.length!==M.length)throw new Error("Given keys array must have same length as given values array.");if(Y===0)return K({numFailures:0,failures:{},results:[],lastResult:void 0});function ce(xe){++Re,Kn(xe)}var le=[],ue=[],Re=0;if($==="deleteRange"){if(j.type===4)return K({numFailures:Re,failures:ue,results:[],lastResult:void 0});j.type===3?le.push(F=R.clear()):le.push(F=R.delete(u(j)))}else{var q=H?q?[M,x]:[M,null]:[x,null],oe=q[0],Ne=q[1];if(H)for(var $e=0;$e<Y;++$e)le.push(F=Ne&&Ne[$e]!==void 0?R[$](oe[$e],Ne[$e]):R[$](oe[$e])),F.onerror=ce;else for($e=0;$e<Y;++$e)le.push(F=R[$](oe[$e])),F.onerror=ce}function Bs(xe){xe=xe.target.result,le.forEach(function(jt,pi){return jt.error!=null&&(ue[pi]=jt.error)}),K({numFailures:Re,failures:ue,results:$==="delete"?x:le.map(function(jt){return jt.result}),lastResult:xe})}F.onerror=function(xe){ce(xe),Bs(xe)},F.onsuccess=Bs})},getMany:function(O){var E=O.trans,$=O.keys;return new Promise(function(x,M){x=be(x);for(var j,K=E.objectStore(I),U=$.length,R=new Array(U),q=0,H=0,F=function(le){le=le.target,R[le._pos]=le.result,++H===q&&x(R)},Y=Qe(M),ce=0;ce<U;++ce)$[ce]!=null&&((j=K.get($[ce]))._pos=ce,j.onsuccess=F,j.onerror=Y,++q);q===0&&x(R)})},get:function(O){var E=O.trans,$=O.key;return new Promise(function(x,M){x=be(x);var j=E.objectStore(I).get($);j.onsuccess=function(K){return x(K.target.result)},j.onerror=Qe(M)})},query:(k=S,function(O){return new Promise(function(E,$){E=be(E);var x,M,j,q=O.trans,K=O.values,U=O.limit,F=O.query,R=U===1/0?void 0:U,H=F.index,F=F.range,q=q.objectStore(I),H=H.isPrimaryKey?q:q.index(H.name),F=u(F);if(U===0)return E({result:[]});k?((R=K?H.getAll(F,R):H.getAllKeys(F,R)).onsuccess=function(Y){return E({result:Y.target.result})},R.onerror=Qe($)):(x=0,M=!K&&"openKeyCursor"in H?H.openKeyCursor(F):H.openCursor(F),j=[],M.onsuccess=function(Y){var ce=M.result;return ce?(j.push(K?ce.value:ce.primaryKey),++x===U?E({result:j}):void ce.continue()):E({result:j})},M.onerror=Qe($))})}),openCursor:function(O){var E=O.trans,$=O.values,x=O.query,M=O.reverse,j=O.unique;return new Promise(function(K,U){K=be(K);var H=x.index,R=x.range,q=E.objectStore(I),q=H.isPrimaryKey?q:q.index(H.name),H=M?j?"prevunique":"prev":j?"nextunique":"next",F=!$&&"openKeyCursor"in q?q.openKeyCursor(u(R),H):q.openCursor(u(R),H);F.onerror=Qe(U),F.onsuccess=be(function(Y){var ce,le,ue,Re,oe=F.result;oe?(oe.___id=++Al,oe.done=!1,ce=oe.continue.bind(oe),le=(le=oe.continuePrimaryKey)&&le.bind(oe),ue=oe.advance.bind(oe),Re=function(){throw new Error("Cursor not stopped")},oe.trans=E,oe.stop=oe.continue=oe.continuePrimaryKey=oe.advance=function(){throw new Error("Cursor not started")},oe.fail=be(U),oe.next=function(){var Ne=this,$e=1;return this.start(function(){return $e--?Ne.continue():Ne.stop()}).then(function(){return Ne})},oe.start=function(Ne){function $e(){if(F.result)try{Ne()}catch(xe){oe.fail(xe)}else oe.done=!0,oe.start=function(){throw new Error("Cursor behind last entry")},oe.stop()}var Bs=new Promise(function(xe,jt){xe=be(xe),F.onerror=Qe(jt),oe.fail=jt,oe.stop=function(pi){oe.stop=oe.continue=oe.continuePrimaryKey=oe.advance=Re,xe(pi)}});return F.onsuccess=be(function(xe){F.onsuccess=$e,$e()}),oe.continue=ce,oe.continuePrimaryKey=le,oe.advance=ue,$e(),Bs},K(oe)):K(null)},U)})},count:function(O){var E=O.query,$=O.trans,x=E.index,M=E.range;return new Promise(function(j,K){var U=$.objectStore(I),R=x.isPrimaryKey?U:U.index(x.name),U=u(M),R=U?R.count(U):R.count();R.onsuccess=be(function(q){return j(q.target.result)}),R.onerror=Qe(K)})}}}var h,y,g,A=(y=w,g=Ro((h=r).objectStoreNames),{schema:{name:h.name,tables:g.map(function(N){return y.objectStore(N)}).map(function(N){var k=N.keyPath,E=N.autoIncrement,I=f(k),O={},E={name:N.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:k==null,compound:I,keyPath:k,autoIncrement:E,unique:!0,extractKey:Wr(k)},indexes:Ro(N.indexNames).map(function($){return N.index($)}).map(function(j){var x=j.name,M=j.unique,K=j.multiEntry,j=j.keyPath,K={name:x,compound:f(j),keyPath:j,unique:M,multiEntry:K,extractKey:Wr(j)};return O[Fn(j)]=K}),getIndexByKeyPath:function($){return O[Fn($)]}};return O[":id"]=E.primaryKey,k!=null&&(O[Fn(k)]=E.primaryKey),E})},hasGetAll:0<g.length&&"getAll"in y.objectStore(g[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),w=A.schema,S=A.hasGetAll,A=w.tables.map(d),v={};return A.forEach(function(N){return v[N.name]=N}),{stack:"dbcore",transaction:r.transaction.bind(r),table:function(N){if(!v[N])throw new Error("Table '".concat(N,"' not found"));return v[N]},MIN_KEY:-1/0,MAX_KEY:qn(o),schema:w}}function Cl(r,o,l,u){var d=l.IDBKeyRange;return l.indexedDB,{dbcore:(u=Ll(o,d,u),r.dbcore.reduce(function(h,y){return y=y.create,s(s({},h),y(h))},u))}}function Is(r,u){var l=u.db,u=Cl(r._middlewares,l,r._deps,u);r.core=u.dbcore,r.tables.forEach(function(d){var h=d.name;r.core.schema.tables.some(function(y){return y.name===h})&&(d.core=r.core.table(h),r[h]instanceof r.Table&&(r[h].core=d.core))})}function Ts(r,o,l,u){l.forEach(function(d){var h=u[d];o.forEach(function(y){var g=function w(S,A){return D(S,A)||(S=m(S))&&w(S,A)}(y,d);(!g||"value"in g&&g.value===void 0)&&(y===r.Transaction.prototype||y instanceof r.Transaction?P(y,d,{get:function(){return this.table(d)},set:function(w){C(this,d,{value:w,writable:!0,configurable:!0,enumerable:!0})}}):y[d]=new r.Table(d,h))})})}function Qr(r,o){o.forEach(function(l){for(var u in l)l[u]instanceof r.Table&&delete l[u]})}function Ol(r,o){return r._cfg.version-o._cfg.version}function Nl(r,o,l,u){var d=r._dbSchema;l.objectStoreNames.contains("$meta")&&!d.$meta&&(d.$meta=Gr("$meta",Fo("")[0],[]),r._storeNames.push("$meta"));var h=r._createTransaction("readwrite",r._storeNames,d);h.create(l),h._completion.catch(u);var y=h._reject.bind(h),g=Z.transless||Z;ht(function(){return Z.trans=h,Z.transless=g,o!==0?(Is(r,l),S=o,((w=h).storeNames.includes("$meta")?w.table("$meta").get("version").then(function(A){return A??S}):V.resolve(S)).then(function(A){return N=A,k=h,I=l,O=[],A=(v=r)._versions,E=v._dbSchema=Ls(0,v.idbdb,I),(A=A.filter(function($){return $._cfg.version>=N})).length!==0?(A.forEach(function($){O.push(function(){var x=E,M=$._cfg.dbschema;Cs(v,x,I),Cs(v,M,I),E=v._dbSchema=M;var j=Xr(x,M);j.add.forEach(function(H){Zr(I,H[0],H[1].primKey,H[1].indexes)}),j.change.forEach(function(H){if(H.recreate)throw new se.Upgrade("Not yet support for changing primary key");var F=I.objectStore(H.name);H.add.forEach(function(Y){return As(F,Y)}),H.change.forEach(function(Y){F.deleteIndex(Y.name),As(F,Y)}),H.del.forEach(function(Y){return F.deleteIndex(Y)})});var K=$._cfg.contentUpgrade;if(K&&$._cfg.version>N){Is(v,I),k._memoizedTables={};var U=G(M);j.del.forEach(function(H){U[H]=x[H]}),Qr(v,[v.Transaction.prototype]),Ts(v,[v.Transaction.prototype],c(U),U),k.schema=U;var R,q=Nr(K);return q&&en(),j=V.follow(function(){var H;(R=K(k))&&q&&(H=pt.bind(null,null),R.then(H,H))}),R&&typeof R.then=="function"?V.resolve(R):j.then(function(){return R})}}),O.push(function(x){var M,j,K=$._cfg.dbschema;M=K,j=x,[].slice.call(j.db.objectStoreNames).forEach(function(U){return M[U]==null&&j.db.deleteObjectStore(U)}),Qr(v,[v.Transaction.prototype]),Ts(v,[v.Transaction.prototype],v._storeNames,v._dbSchema),k.schema=v._dbSchema}),O.push(function(x){v.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(v.idbdb.version/10)===$._cfg.version?(v.idbdb.deleteObjectStore("$meta"),delete v._dbSchema.$meta,v._storeNames=v._storeNames.filter(function(M){return M!=="$meta"})):x.objectStore("$meta").put($._cfg.version,"version"))})}),function $(){return O.length?V.resolve(O.shift()(k.idbtrans)).then($):V.resolve()}().then(function(){qo(E,I)})):V.resolve();var v,N,k,I,O,E}).catch(y)):(c(d).forEach(function(A){Zr(l,A,d[A].primKey,d[A].indexes)}),Is(r,l),void V.follow(function(){return r.on.populate.fire(h)}).catch(y));var w,S})}function $l(r,o){qo(r._dbSchema,o),o.db.version%10!=0||o.objectStoreNames.contains("$meta")||o.db.createObjectStore("$meta").add(Math.ceil(o.db.version/10-1),"version");var l=Ls(0,r.idbdb,o);Cs(r,r._dbSchema,o);for(var u=0,d=Xr(l,r._dbSchema).change;u<d.length;u++){var h=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var g=o.objectStore(y.name);y.add.forEach(function(w){We&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(w.src)),As(g,w)})}(d[u]);if(typeof h=="object")return h.value}}function Xr(r,o){var l,u={del:[],add:[],change:[]};for(l in r)o[l]||u.del.push(l);for(l in o){var d=r[l],h=o[l];if(d){var y={name:l,def:h,recreate:!1,del:[],add:[],change:[]};if(""+(d.primKey.keyPath||"")!=""+(h.primKey.keyPath||"")||d.primKey.auto!==h.primKey.auto)y.recreate=!0,u.change.push(y);else{var g=d.idxByName,w=h.idxByName,S=void 0;for(S in g)w[S]||y.del.push(S);for(S in w){var A=g[S],v=w[S];A?A.src!==v.src&&y.change.push(v):y.add.push(v)}(0<y.del.length||0<y.add.length||0<y.change.length)&&u.change.push(y)}}else u.add.push([l,h])}return u}function Zr(r,o,l,u){var d=r.db.createObjectStore(o,l.keyPath?{keyPath:l.keyPath,autoIncrement:l.auto}:{autoIncrement:l.auto});return u.forEach(function(h){return As(d,h)}),d}function qo(r,o){c(r).forEach(function(l){o.db.objectStoreNames.contains(l)||(We&&console.debug("Dexie: Creating missing table",l),Zr(o,l,r[l].primKey,r[l].indexes))})}function As(r,o){r.createIndex(o.name,o.keyPath,{unique:o.unique,multiEntry:o.multi})}function Ls(r,o,l){var u={};return W(o.objectStoreNames,0).forEach(function(d){for(var h=l.objectStore(d),y=Jr(Ko(S=h.keyPath),S||"",!0,!1,!!h.autoIncrement,S&&typeof S!="string",!0),g=[],w=0;w<h.indexNames.length;++w){var A=h.index(h.indexNames[w]),S=A.keyPath,A=Jr(A.name,S,!!A.unique,!!A.multiEntry,!1,S&&typeof S!="string",!1);g.push(A)}u[d]=Gr(d,y,g)}),u}function Cs(r,o,l){for(var u=l.db.objectStoreNames,d=0;d<u.length;++d){var h=u[d],y=l.objectStore(h);r._hasGetAll="getAll"in y;for(var g=0;g<y.indexNames.length;++g){var w=y.indexNames[g],S=y.index(w).keyPath,A=typeof S=="string"?S:"["+W(S).join("+")+"]";!o[h]||(S=o[h].idxByName[A])&&(S.name=w,delete o[h].idxByName[A],o[h].idxByName[w]=S)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(r._hasGetAll=!1)}function Fo(r){return r.split(",").map(function(o,l){var u=(o=o.trim()).replace(/([&*]|\+\+)/g,""),d=/^\[/.test(u)?u.match(/^\[(.*)\]$/)[1].split("+"):u;return Jr(u,d||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),f(d),l===0)})}var Pl=(Os.prototype._parseStoresSpec=function(r,o){c(r).forEach(function(l){if(r[l]!==null){var u=Fo(r[l]),d=u.shift();if(d.unique=!0,d.multi)throw new se.Schema("Primary key cannot be multi-valued");u.forEach(function(h){if(h.auto)throw new se.Schema("Only primary key can be marked as autoIncrement (++)");if(!h.keyPath)throw new se.Schema("Index must have a name and cannot be an empty string")}),o[l]=Gr(l,d,u)}})},Os.prototype.stores=function(l){var o=this.db;this._cfg.storesSource=this._cfg.storesSource?p(this._cfg.storesSource,l):l;var l=o._versions,u={},d={};return l.forEach(function(h){p(u,h._cfg.storesSource),d=h._cfg.dbschema={},h._parseStoresSpec(u,d)}),o._dbSchema=d,Qr(o,[o._allTables,o,o.Transaction.prototype]),Ts(o,[o._allTables,o,o.Transaction.prototype,this._cfg.tables],c(d),d),o._storeNames=c(d),this},Os.prototype.upgrade=function(r){return this._cfg.contentUpgrade=Pr(this._cfg.contentUpgrade||pe,r),this},Os);function Os(){}function ei(r,o){var l=r._dbNamesDB;return l||(l=r._dbNamesDB=new it(ws,{addons:[],indexedDB:r,IDBKeyRange:o})).version(1).stores({dbnames:"name"}),l.table("dbnames")}function ti(r){return r&&typeof r.databases=="function"}function ni(r){return ht(function(){return Z.letThrough=!0,r()})}function si(r){return!("from"in r)}var Oe=function(r,o){if(!this){var l=new Oe;return r&&"d"in r&&p(l,r),l}p(this,arguments.length?{d:1,from:r,to:1<arguments.length?o:r}:{d:0})};function Un(r,o,l){var u=fe(o,l);if(!isNaN(u)){if(0<u)throw RangeError();if(si(r))return p(r,{from:o,to:l,d:1});var d=r.l,u=r.r;if(fe(l,r.from)<0)return d?Un(d,o,l):r.l={from:o,to:l,d:1,l:null,r:null},Ho(r);if(0<fe(o,r.to))return u?Un(u,o,l):r.r={from:o,to:l,d:1,l:null,r:null},Ho(r);fe(o,r.from)<0&&(r.from=o,r.l=null,r.d=u?u.d+1:1),0<fe(l,r.to)&&(r.to=l,r.r=null,r.d=r.l?r.l.d+1:1),l=!r.r,d&&!r.l&&Hn(r,d),u&&l&&Hn(r,u)}}function Hn(r,o){si(o)||function l(u,w){var h=w.from,y=w.to,g=w.l,w=w.r;Un(u,h,y),g&&l(u,g),w&&l(u,w)}(r,o)}function Uo(r,o){var l=Ns(o),u=l.next();if(u.done)return!1;for(var d=u.value,h=Ns(r),y=h.next(d.from),g=y.value;!u.done&&!y.done;){if(fe(g.from,d.to)<=0&&0<=fe(g.to,d.from))return!0;fe(d.from,g.from)<0?d=(u=l.next(g.from)).value:g=(y=h.next(d.from)).value}return!1}function Ns(r){var o=si(r)?null:{s:0,n:r};return{next:function(l){for(var u=0<arguments.length;o;)switch(o.s){case 0:if(o.s=1,u)for(;o.n.l&&fe(l,o.n.from)<0;)o={up:o,n:o.n.l,s:1};else for(;o.n.l;)o={up:o,n:o.n.l,s:1};case 1:if(o.s=2,!u||fe(l,o.n.to)<=0)return{value:o.n,done:!1};case 2:if(o.n.r){o.s=3,o={up:o,n:o.n.r,s:0};continue}case 3:o=o.up}return{done:!0}}}}function Ho(r){var o,l,u=(((o=r.r)===null||o===void 0?void 0:o.d)||0)-(((l=r.l)===null||l===void 0?void 0:l.d)||0),d=1<u?"r":u<-1?"l":"";d&&(o=d=="r"?"l":"r",l=s({},r),u=r[d],r.from=u.from,r.to=u.to,r[d]=u[d],l[d]=u[o],(r[o]=l).d=zo(l)),r.d=zo(r)}function zo(l){var o=l.r,l=l.l;return(o?l?Math.max(o.d,l.d):o.d:l?l.d:0)+1}function $s(r,o){return c(o).forEach(function(l){r[l]?Hn(r[l],o[l]):r[l]=function u(d){var h,y,g={};for(h in d)b(d,h)&&(y=d[h],g[h]=!y||typeof y!="object"||nt.has(y.constructor)?y:u(y));return g}(o[l])}),r}function ri(r,o){return r.all||o.all||Object.keys(r).some(function(l){return o[l]&&Uo(o[l],r[l])})}_(Oe.prototype,((Fe={add:function(r){return Hn(this,r),this},addKey:function(r){return Un(this,r,r),this},addKeys:function(r){var o=this;return r.forEach(function(l){return Un(o,l,l)}),this},hasKey:function(r){var o=Ns(this).next(r).value;return o&&fe(o.from,r)<=0&&0<=fe(o.to,r)}})[Or]=function(){return Ns(this)},Fe));var Dt={},ii={},oi=!1;function Ps(r){$s(ii,r),oi||(oi=!0,setTimeout(function(){oi=!1,ai(ii,!(ii={}))},0))}function ai(r,o){o===void 0&&(o=!1);var l=new Set;if(r.all)for(var u=0,d=Object.values(Dt);u<d.length;u++)Vo(y=d[u],r,l,o);else for(var h in r){var y,g=/^idb\:\/\/(.*)\/(.*)\//.exec(h);g&&(h=g[1],g=g[2],(y=Dt["idb://".concat(h,"/").concat(g)])&&Vo(y,r,l,o))}l.forEach(function(w){return w()})}function Vo(r,o,l,u){for(var d=[],h=0,y=Object.entries(r.queries.query);h<y.length;h++){for(var g=y[h],w=g[0],S=[],A=0,v=g[1];A<v.length;A++){var N=v[A];ri(o,N.obsSet)?N.subscribers.forEach(function(E){return l.add(E)}):u&&S.push(N)}u&&d.push([w,S])}if(u)for(var k=0,I=d;k<I.length;k++){var O=I[k],w=O[0],S=O[1];r.queries.query[w]=S}}function xl(r){var o=r._state,l=r._deps.indexedDB;if(o.isBeingOpened||r.idbdb)return o.dbReadyPromise.then(function(){return o.dbOpenError?Ee(o.dbOpenError):r});o.isBeingOpened=!0,o.dbOpenError=null,o.openComplete=!1;var u=o.openCanceller,d=Math.round(10*r.verno),h=!1;function y(){if(o.openCanceller!==u)throw new se.DatabaseClosed("db.open() was cancelled")}function g(){return new V(function(N,k){if(y(),!l)throw new se.MissingAPI;var I=r.name,O=o.autoSchema||!d?l.open(I):l.open(I,d);if(!O)throw new se.MissingAPI;O.onerror=Qe(k),O.onblocked=be(r._fireOnBlocked),O.onupgradeneeded=be(function(E){var $;A=O.transaction,o.autoSchema&&!r._options.allowEmptyDB?(O.onerror=Kn,A.abort(),O.result.close(),($=l.deleteDatabase(I)).onsuccess=$.onerror=be(function(){k(new se.NoSuchDatabase("Database ".concat(I," doesnt exist")))})):(A.onerror=Qe(k),E=E.oldVersion>Math.pow(2,62)?0:E.oldVersion,v=E<1,r.idbdb=O.result,h&&$l(r,A),Nl(r,E/10,A,k))},k),O.onsuccess=be(function(){A=null;var E,$,x,M,j,K=r.idbdb=O.result,U=W(K.objectStoreNames);if(0<U.length)try{var R=K.transaction((M=U).length===1?M[0]:M,"readonly");if(o.autoSchema)$=K,x=R,(E=r).verno=$.version/10,x=E._dbSchema=Ls(0,$,x),E._storeNames=W($.objectStoreNames,0),Ts(E,[E._allTables],c(x),x);else if(Cs(r,r._dbSchema,R),((j=Xr(Ls(0,(j=r).idbdb,R),j._dbSchema)).add.length||j.change.some(function(q){return q.add.length||q.change.length}))&&!h)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),K.close(),d=K.version+1,h=!0,N(g());Is(r,R)}catch{}tn.push(r),K.onversionchange=be(function(q){o.vcFired=!0,r.on("versionchange").fire(q)}),K.onclose=be(function(q){r.on("close").fire(q)}),v&&(j=r._deps,R=I,K=j.indexedDB,j=j.IDBKeyRange,ti(K)||R===ws||ei(K,j).put({name:R}).catch(pe)),N()},k)}).catch(function(N){switch(N==null?void 0:N.name){case"UnknownError":if(0<o.PR1398_maxLoop)return o.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),g();break;case"VersionError":if(0<d)return d=0,g()}return V.reject(N)})}var w,S=o.dbReadyResolve,A=null,v=!1;return V.race([u,(typeof navigator>"u"?V.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(N){function k(){return indexedDB.databases().finally(N)}w=setInterval(k,100),k()}).finally(function(){return clearInterval(w)}):Promise.resolve()).then(g)]).then(function(){return y(),o.onReadyBeingFired=[],V.resolve(ni(function(){return r.on.ready.fire(r.vip)})).then(function N(){if(0<o.onReadyBeingFired.length){var k=o.onReadyBeingFired.reduce(Pr,pe);return o.onReadyBeingFired=[],V.resolve(ni(function(){return k(r.vip)})).then(N)}})}).finally(function(){o.openCanceller===u&&(o.onReadyBeingFired=null,o.isBeingOpened=!1)}).catch(function(N){o.dbOpenError=N;try{A&&A.abort()}catch{}return u===o.openCanceller&&r._close(),Ee(N)}).finally(function(){o.openComplete=!0,S()}).then(function(){var N;return v&&(N={},r.tables.forEach(function(k){k.schema.indexes.forEach(function(I){I.name&&(N["idb://".concat(r.name,"/").concat(k.name,"/").concat(I.name)]=new Oe(-1/0,[[[]]]))}),N["idb://".concat(r.name,"/").concat(k.name,"/")]=N["idb://".concat(r.name,"/").concat(k.name,"/:dels")]=new Oe(-1/0,[[[]]])}),gt(Rn).fire(N),ai(N,!0)),r})}function ci(r){function o(h){return r.next(h)}var l=d(o),u=d(function(h){return r.throw(h)});function d(h){return function(w){var g=h(w),w=g.value;return g.done?w:w&&typeof w.then=="function"?w.then(l,u):f(w)?Promise.all(w).then(l,u):l(w)}}return d(o)()}function xs(r,o,l){for(var u=f(r)?r.slice():[r],d=0;d<l;++d)u.push(o);return u}var Ml={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(r){return s(s({},r),{table:function(o){var l=r.table(o),u=l.schema,d={},h=[];function y(v,N,k){var I=Fn(v),O=d[I]=d[I]||[],E=v==null?0:typeof v=="string"?1:v.length,$=0<N,$=s(s({},k),{name:$?"".concat(I,"(virtual-from:").concat(k.name,")"):k.name,lowLevelIndex:k,isVirtual:$,keyTail:N,keyLength:E,extractKey:Wr(v),unique:!$&&k.unique});return O.push($),$.isPrimaryKey||h.push($),1<E&&y(E===2?v[0]:v.slice(0,E-1),N+1,k),O.sort(function(x,M){return x.keyTail-M.keyTail}),$}o=y(u.primaryKey.keyPath,0,u.primaryKey),d[":id"]=[o];for(var g=0,w=u.indexes;g<w.length;g++){var S=w[g];y(S.keyPath,0,S)}function A(v){var N,k=v.query.index;return k.isVirtual?s(s({},v),{query:{index:k.lowLevelIndex,range:(N=v.query.range,k=k.keyTail,{type:N.type===1?2:N.type,lower:xs(N.lower,N.lowerOpen?r.MAX_KEY:r.MIN_KEY,k),lowerOpen:!0,upper:xs(N.upper,N.upperOpen?r.MIN_KEY:r.MAX_KEY,k),upperOpen:!0})}}):v}return s(s({},l),{schema:s(s({},u),{primaryKey:o,indexes:h,getIndexByKeyPath:function(v){return(v=d[Fn(v)])&&v[0]}}),count:function(v){return l.count(A(v))},query:function(v){return l.query(A(v))},openCursor:function(v){var N=v.query.index,k=N.keyTail,I=N.isVirtual,O=N.keyLength;return I?l.openCursor(A(v)).then(function($){return $&&E($)}):l.openCursor(v);function E($){return Object.create($,{continue:{value:function(x){x!=null?$.continue(xs(x,v.reverse?r.MAX_KEY:r.MIN_KEY,k)):v.unique?$.continue($.key.slice(0,O).concat(v.reverse?r.MIN_KEY:r.MAX_KEY,k)):$.continue()}},continuePrimaryKey:{value:function(x,M){$.continuePrimaryKey(xs(x,r.MAX_KEY,k),M)}},primaryKey:{get:function(){return $.primaryKey}},key:{get:function(){var x=$.key;return O===1?x[0]:x.slice(0,O)}},value:{get:function(){return $.value}}})}}})}})}};function li(r,o,l,u){return l=l||{},u=u||"",c(r).forEach(function(d){var h,y,g;b(o,d)?(h=r[d],y=o[d],typeof h=="object"&&typeof y=="object"&&h&&y?(g=Cr(h))!==Cr(y)?l[u+d]=o[d]:g==="Object"?li(h,y,l,u+d+"."):h!==y&&(l[u+d]=o[d]):h!==y&&(l[u+d]=o[d])):l[u+d]=void 0}),c(o).forEach(function(d){b(r,d)||(l[u+d]=o[d])}),l}function ui(r,o){return o.type==="delete"?o.keys:o.keys||o.values.map(r.extractKey)}var Dl={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(r){return s(s({},r),{table:function(o){var l=r.table(o),u=l.schema.primaryKey;return s(s({},l),{mutate:function(d){var h=Z.trans,y=h.table(o).hook,g=y.deleting,w=y.creating,S=y.updating;switch(d.type){case"add":if(w.fire===pe)break;return h._promise("readwrite",function(){return A(d)},!0);case"put":if(w.fire===pe&&S.fire===pe)break;return h._promise("readwrite",function(){return A(d)},!0);case"delete":if(g.fire===pe)break;return h._promise("readwrite",function(){return A(d)},!0);case"deleteRange":if(g.fire===pe)break;return h._promise("readwrite",function(){return function v(N,k,I){return l.query({trans:N,values:!1,query:{index:u,range:k},limit:I}).then(function(O){var E=O.result;return A({type:"delete",keys:E,trans:N}).then(function($){return 0<$.numFailures?Promise.reject($.failures[0]):E.length<I?{failures:[],numFailures:0,lastResult:void 0}:v(N,s(s({},k),{lower:E[E.length-1],lowerOpen:!0}),I)})})}(d.trans,d.range,1e4)},!0)}return l.mutate(d);function A(v){var N,k,I,O=Z.trans,E=v.keys||ui(u,v);if(!E)throw new Error("Keys missing");return(v=v.type==="add"||v.type==="put"?s(s({},v),{keys:E}):s({},v)).type!=="delete"&&(v.values=i([],v.values)),v.keys&&(v.keys=i([],v.keys)),N=l,I=E,((k=v).type==="add"?Promise.resolve([]):N.getMany({trans:k.trans,keys:I,cache:"immutable"})).then(function($){var x=E.map(function(M,j){var K,U,R,q=$[j],H={onerror:null,onsuccess:null};return v.type==="delete"?g.fire.call(H,M,q,O):v.type==="add"||q===void 0?(K=w.fire.call(H,M,v.values[j],O),M==null&&K!=null&&(v.keys[j]=M=K,u.outbound||ae(v.values[j],u.keyPath,M))):(K=li(q,v.values[j]),(U=S.fire.call(H,K,M,q,O))&&(R=v.values[j],Object.keys(U).forEach(function(F){b(R,F)?R[F]=U[F]:ae(R,F,U[F])}))),H});return l.mutate(v).then(function(M){for(var j=M.failures,K=M.results,U=M.numFailures,M=M.lastResult,R=0;R<E.length;++R){var q=(K||E)[R],H=x[R];q==null?H.onerror&&H.onerror(j[R]):H.onsuccess&&H.onsuccess(v.type==="put"&&$[R]?v.values[R]:q)}return{failures:j,results:K,numFailures:U,lastResult:M}}).catch(function(M){return x.forEach(function(j){return j.onerror&&j.onerror(M)}),Promise.reject(M)})})}}})}})}};function Yo(r,o,l){try{if(!o||o.keys.length<r.length)return null;for(var u=[],d=0,h=0;d<o.keys.length&&h<r.length;++d)fe(o.keys[d],r[h])===0&&(u.push(l?Ge(o.values[d]):o.values[d]),++h);return u.length===r.length?u:null}catch{return null}}var Bl={stack:"dbcore",level:-1,create:function(r){return{table:function(o){var l=r.table(o);return s(s({},l),{getMany:function(u){if(!u.cache)return l.getMany(u);var d=Yo(u.keys,u.trans._cache,u.cache==="clone");return d?V.resolve(d):l.getMany(u).then(function(h){return u.trans._cache={keys:u.keys,values:u.cache==="clone"?Ge(h):h},h})},mutate:function(u){return u.type!=="add"&&(u.trans._cache=null),l.mutate(u)}})}}}};function Jo(r,o){return r.trans.mode==="readonly"&&!!r.subscr&&!r.trans.explicit&&r.trans.db._options.cache!=="disabled"&&!o.schema.primaryKey.outbound}function Go(r,o){switch(r){case"query":return o.values&&!o.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var jl={stack:"dbcore",level:0,name:"Observability",create:function(r){var o=r.schema.name,l=new Oe(r.MIN_KEY,r.MAX_KEY);return s(s({},r),{transaction:function(u,d,h){if(Z.subscr&&d!=="readonly")throw new se.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(Z.querier));return r.transaction(u,d,h)},table:function(u){var d=r.table(u),h=d.schema,y=h.primaryKey,v=h.indexes,g=y.extractKey,w=y.outbound,S=y.autoIncrement&&v.filter(function(k){return k.compound&&k.keyPath.includes(y.keyPath)}),A=s(s({},d),{mutate:function(k){function I(F){return F="idb://".concat(o,"/").concat(u,"/").concat(F),M[F]||(M[F]=new Oe)}var O,E,$,x=k.trans,M=k.mutatedParts||(k.mutatedParts={}),j=I(""),K=I(":dels"),U=k.type,H=k.type==="deleteRange"?[k.range]:k.type==="delete"?[k.keys]:k.values.length<50?[ui(y,k).filter(function(F){return F}),k.values]:[],R=H[0],q=H[1],H=k.trans._cache;return f(R)?(j.addKeys(R),(H=U==="delete"||R.length===q.length?Yo(R,H):null)||K.addKeys(R),(H||q)&&(O=I,E=H,$=q,h.indexes.forEach(function(F){var Y=O(F.name||"");function ce(ue){return ue!=null?F.extractKey(ue):null}function le(ue){return F.multiEntry&&f(ue)?ue.forEach(function(Re){return Y.addKey(Re)}):Y.addKey(ue)}(E||$).forEach(function(ue,Ne){var oe=E&&ce(E[Ne]),Ne=$&&ce($[Ne]);fe(oe,Ne)!==0&&(oe!=null&&le(oe),Ne!=null&&le(Ne))})}))):R?(q={from:(q=R.lower)!==null&&q!==void 0?q:r.MIN_KEY,to:(q=R.upper)!==null&&q!==void 0?q:r.MAX_KEY},K.add(q),j.add(q)):(j.add(l),K.add(l),h.indexes.forEach(function(F){return I(F.name).add(l)})),d.mutate(k).then(function(F){return!R||k.type!=="add"&&k.type!=="put"||(j.addKeys(F.results),S&&S.forEach(function(Y){for(var ce=k.values.map(function(oe){return Y.extractKey(oe)}),le=Y.keyPath.findIndex(function(oe){return oe===y.keyPath}),ue=0,Re=F.results.length;ue<Re;++ue)ce[ue][le]=F.results[ue];I(Y.name).addKeys(ce)})),x.mutatedParts=$s(x.mutatedParts||{},M),F})}}),v=function(I){var O=I.query,I=O.index,O=O.range;return[I,new Oe((I=O.lower)!==null&&I!==void 0?I:r.MIN_KEY,(O=O.upper)!==null&&O!==void 0?O:r.MAX_KEY)]},N={get:function(k){return[y,new Oe(k.key)]},getMany:function(k){return[y,new Oe().addKeys(k.keys)]},count:v,query:v,openCursor:v};return c(N).forEach(function(k){A[k]=function(I){var O=Z.subscr,E=!!O,$=Jo(Z,d)&&Go(k,I)?I.obsSet={}:O;if(E){var x=function(q){return q="idb://".concat(o,"/").concat(u,"/").concat(q),$[q]||($[q]=new Oe)},M=x(""),j=x(":dels"),O=N[k](I),E=O[0],O=O[1];if((k==="query"&&E.isPrimaryKey&&!I.values?j:x(E.name||"")).add(O),!E.isPrimaryKey){if(k!=="count"){var K=k==="query"&&w&&I.values&&d.query(s(s({},I),{values:!1}));return d[k].apply(this,arguments).then(function(q){if(k==="query"){if(w&&I.values)return K.then(function(ce){return ce=ce.result,M.addKeys(ce),q});var H=I.values?q.result.map(g):q.result;(I.values?M:j).addKeys(H)}else if(k==="openCursor"){var F=q,Y=I.values;return F&&Object.create(F,{key:{get:function(){return j.addKey(F.primaryKey),F.key}},primaryKey:{get:function(){var ce=F.primaryKey;return j.addKey(ce),ce}},value:{get:function(){return Y&&M.addKey(F.primaryKey),F.value}}})}return q})}j.add(l)}}return d[k].apply(this,arguments)}}),A}})}};function Wo(r,o,l){if(l.numFailures===0)return o;if(o.type==="deleteRange")return null;var u=o.keys?o.keys.length:"values"in o&&o.values?o.values.length:1;return l.numFailures===u?null:(o=s({},o),f(o.keys)&&(o.keys=o.keys.filter(function(d,h){return!(h in l.failures)})),"values"in o&&f(o.values)&&(o.values=o.values.filter(function(d,h){return!(h in l.failures)})),o)}function fi(r,o){return l=r,((u=o).lower===void 0||(u.lowerOpen?0<fe(l,u.lower):0<=fe(l,u.lower)))&&(r=r,(o=o).upper===void 0||(o.upperOpen?fe(r,o.upper)<0:fe(r,o.upper)<=0));var l,u}function Qo(r,o,N,u,d,h){if(!N||N.length===0)return r;var y=o.query.index,g=y.multiEntry,w=o.query.range,S=u.schema.primaryKey.extractKey,A=y.extractKey,v=(y.lowLevelIndex||y).extractKey,N=N.reduce(function(k,I){var O=k,E=[];if(I.type==="add"||I.type==="put")for(var $=new Oe,x=I.values.length-1;0<=x;--x){var M,j=I.values[x],K=S(j);$.hasKey(K)||(M=A(j),(g&&f(M)?M.some(function(F){return fi(F,w)}):fi(M,w))&&($.addKey(K),E.push(j)))}switch(I.type){case"add":var U=new Oe().addKeys(o.values?k.map(function(Y){return S(Y)}):k),O=k.concat(o.values?E.filter(function(Y){return Y=S(Y),!U.hasKey(Y)&&(U.addKey(Y),!0)}):E.map(function(Y){return S(Y)}).filter(function(Y){return!U.hasKey(Y)&&(U.addKey(Y),!0)}));break;case"put":var R=new Oe().addKeys(I.values.map(function(Y){return S(Y)}));O=k.filter(function(Y){return!R.hasKey(o.values?S(Y):Y)}).concat(o.values?E:E.map(function(Y){return S(Y)}));break;case"delete":var q=new Oe().addKeys(I.keys);O=k.filter(function(Y){return!q.hasKey(o.values?S(Y):Y)});break;case"deleteRange":var H=I.range;O=k.filter(function(Y){return!fi(S(Y),H)})}return O},r);return N===r?r:(N.sort(function(k,I){return fe(v(k),v(I))||fe(S(k),S(I))}),o.limit&&o.limit<1/0&&(N.length>o.limit?N.length=o.limit:r.length===o.limit&&N.length<o.limit&&(d.dirty=!0)),h?Object.freeze(N):N)}function Xo(r,o){return fe(r.lower,o.lower)===0&&fe(r.upper,o.upper)===0&&!!r.lowerOpen==!!o.lowerOpen&&!!r.upperOpen==!!o.upperOpen}function Kl(r,o){return function(l,u,d,h){if(l===void 0)return u!==void 0?-1:0;if(u===void 0)return 1;if((u=fe(l,u))===0){if(d&&h)return 0;if(d)return 1;if(h)return-1}return u}(r.lower,o.lower,r.lowerOpen,o.lowerOpen)<=0&&0<=function(l,u,d,h){if(l===void 0)return u!==void 0?1:0;if(u===void 0)return-1;if((u=fe(l,u))===0){if(d&&h)return 0;if(d)return-1;if(h)return 1}return u}(r.upper,o.upper,r.upperOpen,o.upperOpen)}function Rl(r,o,l,u){r.subscribers.add(l),u.addEventListener("abort",function(){var d,h;r.subscribers.delete(l),r.subscribers.size===0&&(d=r,h=o,setTimeout(function(){d.subscribers.size===0&&At(h,d)},3e3))})}var ql={stack:"dbcore",level:0,name:"Cache",create:function(r){var o=r.schema.name;return s(s({},r),{transaction:function(l,u,d){var h,y,g=r.transaction(l,u,d);return u==="readwrite"&&(y=(h=new AbortController).signal,d=function(w){return function(){if(h.abort(),u==="readwrite"){for(var S=new Set,A=0,v=l;A<v.length;A++){var N=v[A],k=Dt["idb://".concat(o,"/").concat(N)];if(k){var I=r.table(N),O=k.optimisticOps.filter(function(Y){return Y.trans===g});if(g._explicit&&w&&g.mutatedParts)for(var E=0,$=Object.values(k.queries.query);E<$.length;E++)for(var x=0,M=(U=$[E]).slice();x<M.length;x++)ri((R=M[x]).obsSet,g.mutatedParts)&&(At(U,R),R.subscribers.forEach(function(Y){return S.add(Y)}));else if(0<O.length){k.optimisticOps=k.optimisticOps.filter(function(Y){return Y.trans!==g});for(var j=0,K=Object.values(k.queries.query);j<K.length;j++)for(var U,R,q,H=0,F=(U=K[j]).slice();H<F.length;H++)(R=F[H]).res!=null&&g.mutatedParts&&(w&&!R.dirty?(q=Object.isFrozen(R.res),q=Qo(R.res,R.req,O,I,R,q),R.dirty?(At(U,R),R.subscribers.forEach(function(Y){return S.add(Y)})):q!==R.res&&(R.res=q,R.promise=V.resolve({result:q}))):(R.dirty&&At(U,R),R.subscribers.forEach(function(Y){return S.add(Y)})))}}}S.forEach(function(Y){return Y()})}}},g.addEventListener("abort",d(!1),{signal:y}),g.addEventListener("error",d(!1),{signal:y}),g.addEventListener("complete",d(!0),{signal:y})),g},table:function(l){var u=r.table(l),d=u.schema.primaryKey;return s(s({},u),{mutate:function(h){var y=Z.trans;if(d.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return u.mutate(h);var g=Dt["idb://".concat(o,"/").concat(l)];return g?(y=u.mutate(h),h.type!=="add"&&h.type!=="put"||!(50<=h.values.length||ui(d,h).some(function(w){return w==null}))?(g.optimisticOps.push(h),h.mutatedParts&&Ps(h.mutatedParts),y.then(function(w){0<w.numFailures&&(At(g.optimisticOps,h),(w=Wo(0,h,w))&&g.optimisticOps.push(w),h.mutatedParts&&Ps(h.mutatedParts))}),y.catch(function(){At(g.optimisticOps,h),h.mutatedParts&&Ps(h.mutatedParts)})):y.then(function(w){var S=Wo(0,s(s({},h),{values:h.values.map(function(A,v){var N;return w.failures[v]?A:(A=(N=d.keyPath)!==null&&N!==void 0&&N.includes(".")?Ge(A):s({},A),ae(A,d.keyPath,w.results[v]),A)})}),w);g.optimisticOps.push(S),queueMicrotask(function(){return h.mutatedParts&&Ps(h.mutatedParts)})}),y):u.mutate(h)},query:function(h){if(!Jo(Z,u)||!Go("query",h))return u.query(h);var y=((S=Z.trans)===null||S===void 0?void 0:S.db._options.cache)==="immutable",v=Z,g=v.requery,w=v.signal,S=function(I,O,E,$){var x=Dt["idb://".concat(I,"/").concat(O)];if(!x)return[];if(!(O=x.queries[E]))return[null,!1,x,null];var M=O[($.query?$.query.index.name:null)||""];if(!M)return[null,!1,x,null];switch(E){case"query":var j=M.find(function(K){return K.req.limit===$.limit&&K.req.values===$.values&&Xo(K.req.query.range,$.query.range)});return j?[j,!0,x,M]:[M.find(function(K){return("limit"in K.req?K.req.limit:1/0)>=$.limit&&(!$.values||K.req.values)&&Kl(K.req.query.range,$.query.range)}),!1,x,M];case"count":return j=M.find(function(K){return Xo(K.req.query.range,$.query.range)}),[j,!!j,x,M]}}(o,l,"query",h),A=S[0],v=S[1],N=S[2],k=S[3];return A&&v?A.obsSet=h.obsSet:(v=u.query(h).then(function(I){var O=I.result;if(A&&(A.res=O),y){for(var E=0,$=O.length;E<$;++E)Object.freeze(O[E]);Object.freeze(O)}else I.result=Ge(O);return I}).catch(function(I){return k&&A&&At(k,A),Promise.reject(I)}),A={obsSet:h.obsSet,promise:v,subscribers:new Set,type:"query",req:h,dirty:!1},k?k.push(A):(k=[A],(N=N||(Dt["idb://".concat(o,"/").concat(l)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[h.query.index.name||""]=k)),Rl(A,k,g,w),A.promise.then(function(I){return{result:Qo(I.result,h,N==null?void 0:N.optimisticOps,u,A,y)}})}})}})}};function Ms(r,o){return new Proxy(r,{get:function(l,u,d){return u==="db"?o:Reflect.get(l,u,d)}})}var it=(_e.prototype.version=function(r){if(isNaN(r)||r<.1)throw new se.Type("Given version is not a positive number");if(r=Math.round(10*r)/10,this.idbdb||this._state.isBeingOpened)throw new se.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,r);var o=this._versions,l=o.filter(function(u){return u._cfg.version===r})[0];return l||(l=new this.Version(r),o.push(l),o.sort(Ol),l.stores({}),this._state.autoSchema=!1,l)},_e.prototype._whenReady=function(r){var o=this;return this.idbdb&&(this._state.openComplete||Z.letThrough||this._vip)?r():new V(function(l,u){if(o._state.openComplete)return u(new se.DatabaseClosed(o._state.dbOpenError));if(!o._state.isBeingOpened){if(!o._state.autoOpen)return void u(new se.DatabaseClosed);o.open().catch(pe)}o._state.dbReadyPromise.then(l,u)}).then(r)},_e.prototype.use=function(r){var o=r.stack,l=r.create,u=r.level,d=r.name;return d&&this.unuse({stack:o,name:d}),r=this._middlewares[o]||(this._middlewares[o]=[]),r.push({stack:o,create:l,level:u??10,name:d}),r.sort(function(h,y){return h.level-y.level}),this},_e.prototype.unuse=function(r){var o=r.stack,l=r.name,u=r.create;return o&&this._middlewares[o]&&(this._middlewares[o]=this._middlewares[o].filter(function(d){return u?d.create!==u:!!l&&d.name!==l})),this},_e.prototype.open=function(){var r=this;return Pt(dt,function(){return xl(r)})},_e.prototype._close=function(){var r=this._state,o=tn.indexOf(this);if(0<=o&&tn.splice(o,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}r.isBeingOpened||(r.dbReadyPromise=new V(function(l){r.dbReadyResolve=l}),r.openCanceller=new V(function(l,u){r.cancelOpen=u}))},_e.prototype.close=function(l){var o=(l===void 0?{disableAutoOpen:!0}:l).disableAutoOpen,l=this._state;o?(l.isBeingOpened&&l.cancelOpen(new se.DatabaseClosed),this._close(),l.autoOpen=!1,l.dbOpenError=new se.DatabaseClosed):(this._close(),l.autoOpen=this._options.autoOpen||l.isBeingOpened,l.openComplete=!1,l.dbOpenError=null)},_e.prototype.delete=function(r){var o=this;r===void 0&&(r={disableAutoOpen:!0});var l=0<arguments.length&&typeof arguments[0]!="object",u=this._state;return new V(function(d,h){function y(){o.close(r);var g=o._deps.indexedDB.deleteDatabase(o.name);g.onsuccess=be(function(){var w,S,A;w=o._deps,S=o.name,A=w.indexedDB,w=w.IDBKeyRange,ti(A)||S===ws||ei(A,w).delete(S).catch(pe),d()}),g.onerror=Qe(h),g.onblocked=o._fireOnBlocked}if(l)throw new se.InvalidArgument("Invalid closeOptions argument to db.delete()");u.isBeingOpened?u.dbReadyPromise.then(y):y()})},_e.prototype.backendDB=function(){return this.idbdb},_e.prototype.isOpen=function(){return this.idbdb!==null},_e.prototype.hasBeenClosed=function(){var r=this._state.dbOpenError;return r&&r.name==="DatabaseClosed"},_e.prototype.hasFailed=function(){return this._state.dbOpenError!==null},_e.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(_e.prototype,"tables",{get:function(){var r=this;return c(this._allTables).map(function(o){return r._allTables[o]})},enumerable:!1,configurable:!0}),_e.prototype.transaction=function(){var r=(function(o,l,u){var d=arguments.length;if(d<2)throw new se.InvalidArgument("Too few arguments");for(var h=new Array(d-1);--d;)h[d-1]=arguments[d];return u=h.pop(),[o,ze(h),u]}).apply(this,arguments);return this._transaction.apply(this,r)},_e.prototype._transaction=function(r,o,l){var u=this,d=Z.trans;d&&d.db===this&&r.indexOf("!")===-1||(d=null);var h,y,g=r.indexOf("?")!==-1;r=r.replace("!","").replace("?","");try{if(y=o.map(function(S){if(S=S instanceof u.Table?S.name:S,typeof S!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return S}),r=="r"||r===Fr)h=Fr;else{if(r!="rw"&&r!=Ur)throw new se.InvalidArgument("Invalid transaction mode: "+r);h=Ur}if(d){if(d.mode===Fr&&h===Ur){if(!g)throw new se.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");d=null}d&&y.forEach(function(S){if(d&&d.storeNames.indexOf(S)===-1){if(!g)throw new se.SubTransaction("Table "+S+" not included in parent transaction.");d=null}}),g&&d&&!d.active&&(d=null)}}catch(S){return d?d._promise(null,function(A,v){v(S)}):Ee(S)}var w=(function S(A,v,N,k,I){return V.resolve().then(function(){var O=Z.transless||Z,E=A._createTransaction(v,N,A._dbSchema,k);if(E.explicit=!0,O={trans:E,transless:O},k)E.idbtrans=k.idbtrans;else try{E.create(),E.idbtrans._explicit=!0,A._state.PR1398_maxLoop=3}catch(M){return M.name===$r.InvalidState&&A.isOpen()&&0<--A._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),A.close({disableAutoOpen:!1}),A.open().then(function(){return S(A,v,N,null,I)})):Ee(M)}var $,x=Nr(I);return x&&en(),O=V.follow(function(){var M;($=I.call(E,E))&&(x?(M=pt.bind(null,null),$.then(M,M)):typeof $.next=="function"&&typeof $.throw=="function"&&($=ci($)))},O),($&&typeof $.then=="function"?V.resolve($).then(function(M){return E.active?M:Ee(new se.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):O.then(function(){return $})).then(function(M){return k&&E._resolve(),E._completion.then(function(){return M})}).catch(function(M){return E._reject(M),Ee(M)})})}).bind(null,this,h,y,d,l);return d?d._promise(h,w,"lock"):Z.trans?Pt(Z.transless,function(){return u._whenReady(w)}):this._whenReady(w)},_e.prototype.table=function(r){if(!b(this._allTables,r))throw new se.InvalidTable("Table ".concat(r," does not exist"));return this._allTables[r]},_e);function _e(r,o){var l=this;this._middlewares={},this.verno=0;var u=_e.dependencies;this._options=o=s({addons:_e.addons,autoOpen:!0,indexedDB:u.indexedDB,IDBKeyRange:u.IDBKeyRange,cache:"cloned"},o),this._deps={indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},u=o.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var d,h,y,g,w,S={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:pe,dbReadyPromise:null,cancelOpen:pe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:o.autoOpen};S.dbReadyPromise=new V(function(v){S.dbReadyResolve=v}),S.openCanceller=new V(function(v,N){S.cancelOpen=N}),this._state=S,this.name=r,this.on=Dn(this,"populate","blocked","versionchange","close",{ready:[Pr,pe]}),this.on.ready.subscribe=X(this.on.ready.subscribe,function(v){return function(N,k){_e.vip(function(){var I,O=l._state;O.openComplete?(O.dbOpenError||V.resolve().then(N),k&&v(N)):O.onReadyBeingFired?(O.onReadyBeingFired.push(N),k&&v(N)):(v(N),I=l,k||v(function E(){I.on.ready.unsubscribe(N),I.on.ready.unsubscribe(E)}))})}}),this.Collection=(d=this,Bn(El.prototype,function($,E){this.db=d;var k=Co,I=null;if(E)try{k=E()}catch(x){I=x}var O=$._ctx,E=O.table,$=E.hook.reading.fire;this._ctx={table:E,index:O.index,isPrimKey:!O.index||E.schema.primKey.keyPath&&O.index===E.schema.primKey.name,range:k,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:I,or:O.or,valueMapper:$!==Nn?$:null}})),this.Table=(h=this,Bn(Po.prototype,function(v,N,k){this.db=h,this._tx=k,this.name=v,this.schema=N,this.hook=h._allTables[v]?h._allTables[v].hook:Dn(null,{creating:[pl,pe],reading:[hl,Nn],updating:[yl,pe],deleting:[ml,pe]})})),this.Transaction=(y=this,Bn(Tl.prototype,function(v,N,k,I,O){var E=this;this.db=y,this.mode=v,this.storeNames=N,this.schema=k,this.chromeTransactionDurability=I,this.idbtrans=null,this.on=Dn(this,"complete","error","abort"),this.parent=O||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new V(function($,x){E._resolve=$,E._reject=x}),this._completion.then(function(){E.active=!1,E.on.complete.fire()},function($){var x=E.active;return E.active=!1,E.on.error.fire($),E.parent?E.parent._reject($):x&&E.idbtrans&&E.idbtrans.abort(),Ee($)})})),this.Version=(g=this,Bn(Pl.prototype,function(v){this.db=g,this._cfg={version:v,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(w=this,Bn(jo.prototype,function(v,N,k){if(this.db=w,this._ctx={table:v,index:N===":id"?null:N,or:k},this._cmp=this._ascending=fe,this._descending=function(I,O){return fe(O,I)},this._max=function(I,O){return 0<fe(I,O)?I:O},this._min=function(I,O){return fe(I,O)<0?I:O},this._IDBKeyRange=w._deps.IDBKeyRange,!this._IDBKeyRange)throw new se.MissingAPI})),this.on("versionchange",function(v){0<v.newVersion?console.warn("Another connection wants to upgrade database '".concat(l.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(l.name,"'. Closing db now to resume the delete request.")),l.close({disableAutoOpen:!1})}),this.on("blocked",function(v){!v.newVersion||v.newVersion<v.oldVersion?console.warn("Dexie.delete('".concat(l.name,"') was blocked")):console.warn("Upgrade '".concat(l.name,"' blocked by other connection holding version ").concat(v.oldVersion/10))}),this._maxKey=qn(o.IDBKeyRange),this._createTransaction=function(v,N,k,I){return new l.Transaction(v,N,k,l._options.chromeTransactionDurability,I)},this._fireOnBlocked=function(v){l.on("blocked").fire(v),tn.filter(function(N){return N.name===l.name&&N!==l&&!N._state.vcFired}).map(function(N){return N.on("versionchange").fire(v)})},this.use(Bl),this.use(ql),this.use(jl),this.use(Ml),this.use(Dl);var A=new Proxy(this,{get:function(v,N,k){if(N==="_vip")return!0;if(N==="table")return function(O){return Ms(l.table(O),A)};var I=Reflect.get(v,N,k);return I instanceof Po?Ms(I,A):N==="tables"?I.map(function(O){return Ms(O,A)}):N==="_createTransaction"?function(){return Ms(I.apply(this,arguments),A)}:I}});this.vip=A,u.forEach(function(v){return v(l)})}var Ds,Fe=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Fl=(di.prototype.subscribe=function(r,o,l){return this._subscribe(r&&typeof r!="function"?r:{next:r,error:o,complete:l})},di.prototype[Fe]=function(){return this},di);function di(r){this._subscribe=r}try{Ds={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{Ds={indexedDB:null,IDBKeyRange:null}}function Zo(r){var o,l=!1,u=new Fl(function(d){var h=Nr(r),y,g=!1,w={},S={},A={get closed(){return g},unsubscribe:function(){g||(g=!0,y&&y.abort(),v&&gt.storagemutated.unsubscribe(k))}};d.start&&d.start(A);var v=!1,N=function(){return qr(I)},k=function(O){$s(w,O),ri(S,w)&&N()},I=function(){var O,E,$;!g&&Ds.indexedDB&&(w={},O={},y&&y.abort(),y=new AbortController,$=function(x){var M=Xt();try{h&&en();var j=ht(r,x);return j=h?j.finally(pt):j}finally{M&&Zt()}}(E={subscr:O,signal:y.signal,requery:N,querier:r,trans:null}),Promise.resolve($).then(function(x){l=!0,o=x,g||E.signal.aborted||(w={},function(M){for(var j in M)if(b(M,j))return;return 1}(S=O)||v||(gt(Rn,k),v=!0),qr(function(){return!g&&d.next&&d.next(x)}))},function(x){l=!1,["DatabaseClosedError","AbortError"].includes(x==null?void 0:x.name)||g||qr(function(){g||d.error&&d.error(x)})}))};return setTimeout(N,0),A});return u.hasValue=function(){return l},u.getValue=function(){return o},u}var Bt=it;function hi(r){var o=vt;try{vt=!0,gt.storagemutated.fire(r),ai(r,!0)}finally{vt=o}}_(Bt,s(s({},fs),{delete:function(r){return new Bt(r,{addons:[]}).delete()},exists:function(r){return new Bt(r,{addons:[]}).open().then(function(o){return o.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(r){try{return o=Bt.dependencies,l=o.indexedDB,o=o.IDBKeyRange,(ti(l)?Promise.resolve(l.databases()).then(function(u){return u.map(function(d){return d.name}).filter(function(d){return d!==ws})}):ei(l,o).toCollection().primaryKeys()).then(r)}catch{return Ee(new se.MissingAPI)}var o,l},defineClass:function(){return function(r){p(this,r)}},ignoreTransaction:function(r){return Z.trans?Pt(Z.transless,r):r()},vip:ni,async:function(r){return function(){try{var o=ci(r.apply(this,arguments));return o&&typeof o.then=="function"?o:V.resolve(o)}catch(l){return Ee(l)}}},spawn:function(r,o,l){try{var u=ci(r.apply(l,o||[]));return u&&typeof u.then=="function"?u:V.resolve(u)}catch(d){return Ee(d)}},currentTransaction:{get:function(){return Z.trans||null}},waitFor:function(r,o){return o=V.resolve(typeof r=="function"?Bt.ignoreTransaction(r):r).timeout(o||6e4),Z.trans?Z.trans.waitFor(o):o},Promise:V,debug:{get:function(){return We},set:function(r){So(r)}},derive:T,extend:p,props:_,override:X,Events:Dn,on:gt,liveQuery:Zo,extendObservabilitySet:$s,getByKeyPath:te,setByKeyPath:ae,delByKeyPath:function(r,o){typeof o=="string"?ae(r,o,void 0):"length"in o&&[].map.call(o,function(l){ae(r,l,void 0)})},shallowClone:G,deepClone:Ge,getObjectDiff:li,cmp:fe,asap:ee,minKey:-1/0,addons:[],connections:tn,errnames:$r,dependencies:Ds,cache:Dt,semVer:"4.0.11",version:"4.0.11".split(".").map(function(r){return parseInt(r)}).reduce(function(r,o,l){return r+o/Math.pow(10,2*l)})})),Bt.maxKey=qn(Bt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(gt(Rn,function(r){vt||(r=new CustomEvent(Yr,{detail:r}),vt=!0,dispatchEvent(r),vt=!1)}),addEventListener(Yr,function(r){r=r.detail,vt||hi(r)}));var rn,vt=!1,ea=function(){};return typeof BroadcastChannel<"u"&&((ea=function(){(rn=new BroadcastChannel(Yr)).onmessage=function(r){return r.data&&hi(r.data)}})(),typeof rn.unref=="function"&&rn.unref(),gt(Rn,function(r){vt||rn.postMessage(r)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(r){if(!it.disableBfCache&&r.persisted){We&&console.debug("Dexie: handling persisted pagehide"),rn!=null&&rn.close();for(var o=0,l=tn;o<l.length;o++)l[o].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(r){!it.disableBfCache&&r.persisted&&(We&&console.debug("Dexie: handling persisted pageshow"),ea(),hi({all:new Oe(-1/0,[[]])}))})),V.rejectionMapper=function(r,o){return!r||r instanceof Wt||r instanceof TypeError||r instanceof SyntaxError||!r.name||!ko[r.name]?r:(o=new ko[r.name](o||r.message,r),"stack"in r&&P(o,"stack",{get:function(){return this.inner.stack}}),o)},So(We),s(it,Object.freeze({__proto__:null,Dexie:it,liveQuery:Zo,Entity:Oo,cmp:fe,PropModification:jn,replacePrefix:function(r,o){return new jn({replacePrefix:[r,o]})},add:function(r){return new jn({add:r})},remove:function(r){return new jn({remove:r})},default:it,RangeSet:Oe,mergeRanges:Hn,rangesOverlap:Uo}),{default:it}),it})})(Fa);var Vl=Fa.exports;const Mi=zl(Vl),sa=Symbol.for("Dexie"),ir=globalThis[sa]||(globalThis[sa]=Mi);if(Mi.semVer!==ir.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Mi.semVer} and ${ir.semVer}`);const{liveQuery:Vh,mergeRanges:Yh,rangesOverlap:Jh,RangeSet:Gh,cmp:Wh,Entity:Qh,PropModification:Xh,replacePrefix:Zh,add:ep,remove:tp}=ir,Yl="MdAnkiDatabase",Jl=2,Di=`# 新文件

开始编写您的内容...

::> 这是一个可折叠的标题
    这里是折叠的内容。
    - 甚至可以包含列表
    - 和其他 Markdown 元素。
    \`\`\`javascript
    // 也可以包含代码块
    console.log('Hello, Toggle!');
    \`\`\`

这一行不再缩进，所以它不属于上面的折叠块。

::> [ ] 这是一个可折叠的并且可以记录完成情况的标题
- [ ] 完成情况 

使用 --内容-- 创建Cloze记忆卡片, 可以有声音: --你好--^^audio:hello^^ `,ne=new ir(Yl);ne.version(Jl).stores({folders:"&id, name, folderId",sessions:"&id, name, folderId, createdAt, lastActive",clozeStates:"&id, fileId, state, due",appState:"&key",mistakes:"&uuid, subject, *tags, analysis.reason_for_error, review.due",reviewStats:"&id, date, folderId",apiConfigs:"&id, name",prompts:"&id, name",topics:"&id, promptId, createdAt",history:"&id, topicId, timestamp"});async function Gl(){const[n,e,t,s]=await Promise.all([ne.sessions.toArray(),ne.folders.toArray(),ne.clozeStates.toArray(),ne.appState.toArray()]),i=t.reduce((c,f)=>(c[f.id]=f,c),{}),a=s.reduce((c,f)=>(c[f.key]=f.value,c),{});return{sessions:n||[],folders:e||[],clozeStates:i||{},persistentAppState:a||{}}}async function Wl(n,e){const t=`${n}:${e}`;try{await ne.transaction("rw",ne.reviewStats,async()=>{const s=await ne.reviewStats.get(t);s?await ne.reviewStats.update(t,{count:s.count+1}):await ne.reviewStats.add({id:t,date:n,folderId:e||"root",count:1})})}catch(s){console.error(`Failed to increment review count for ${t}:`,s)}}async function Ql(n,e){try{return await ne.reviewStats.where("date").between(n,e,!0,!0).toArray()}catch(t){return console.error("Failed to get stats for date range:",t),[]}}async function Xl(){const n=new Date().toISOString().slice(0,10);try{return(await ne.reviewStats.where("date").equals(n).toArray()).reduce((t,s)=>t+s.count,0)}catch(e){return console.error("Failed to get today's total count:",e),0}}async function Zl({sessions:n,folders:e,clozeStates:t,persistentAppState:s}){const i=[ne.sessions,ne.folders,ne.clozeStates,ne.appState];await ne.transaction("rw",i,async()=>{const a=Object.values(t),c=Object.entries(s).map(([b,_])=>({key:b,value:_})),f=new Set(n.map(b=>b.id)),p=new Set(e.map(b=>b.id)),m=new Set(Object.keys(t)),L=new Set(Object.keys(s));await Promise.all([ne.sessions.where("id").noneOf(Array.from(f)).delete(),ne.folders.where("id").noneOf(Array.from(p)).delete(),ne.clozeStates.where("id").noneOf(Array.from(m)).delete(),ne.appState.where("key").noneOf(Array.from(L)).delete()]),await Promise.all([ne.sessions.bulkPut(n),ne.folders.bulkPut(e),ne.clozeStates.bulkPut(a),ne.appState.bulkPut(c)])})}async function eu(){const[n,e,t,s]=await Promise.all([ne.apiConfigs.toArray(),ne.prompts.toArray(),ne.topics.toArray(),ne.history.toArray()]);return{apiConfigs:n||[],prompts:e||[],topics:t||[],history:s||[]}}async function tu({apiConfigs:n,prompts:e,topics:t,history:s}){await ne.transaction("rw",ne.apiConfigs,ne.prompts,ne.topics,ne.history,async()=>{const i=new Set(n.map(p=>p.id)),a=new Set(e.map(p=>p.id)),c=new Set(t.map(p=>p.id)),f=new Set(s.map(p=>p.id));await Promise.all([ne.apiConfigs.where("id").noneOf(Array.from(i)).delete(),ne.prompts.where("id").noneOf(Array.from(a)).delete(),ne.topics.where("id").noneOf(Array.from(c)).delete(),ne.history.where("id").noneOf(Array.from(f)).delete()]),await Promise.all([ne.apiConfigs.bulkPut(n),ne.prompts.bulkPut(e),ne.topics.bulkPut(t),ne.history.bulkPut(s)])})}async function nu(){try{return ne.isOpen()||await ne.open(),await ne.mistakes.toArray()}catch(n){return console.error("Failed to load mistakes from DB:",n),[]}}async function su(n){try{await ne.mistakes.bulkPut(n),console.log("Mistakes saved successfully.")}catch(e){console.error("Failed to save mistakes to DB:",e)}}async function ru(n){try{await ne.mistakes.put(n)}catch(e){console.error(`Failed to update mistake ${n.uuid}:`,e)}}function It(){return"id_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function ft(n){return n?n.replace(/[&<>"']/g,e=>({"&":"&","<":"<",">":">",'"':'"',"'":"'"})[e]||e):""}function ra(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);e=(e<<5)-e+s,e|=0}return e.toString(36)}const Zi={火山:{adapter:"openAICompatible",baseURL:"https://ark.cn-beijing.volces.com/api/v3/",models:["deepseek-r1-250528","deepseek-v3-250324"]},deepseek:{adapter:"openAICompatible",baseURL:"https://api.deepseek.com/v1/chat/completions",models:["deepseek-reasoner","deepseek-chat"]},open_routers:{adapter:"openAICompatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",models:["anthropic/claude-opus-4","anthropic/claude-sonnet-4"]},gemini:{adapter:"gemini",baseURL:"https://generativelanguage.googleapis.com",models:["gemini-2.5-pro","gemini-2.5-flash"]},openai_compatible:{adapter:"openAICompatible",baseURL:"",models:[]}};function iu(n){const e=Zi[n];return e?e.adapter==="openAICompatible"&&e.baseURL.endsWith("/")?`${e.baseURL}chat/completions`:e.baseURL:""}class Ua{constructor(e){this.config=e}async chatStream(e,{onChunk:t,onDone:s,onError:i}){throw new Error("Adapter must implement chatStream method.")}_preparePayload(e){throw new Error("Adapter must implement _preparePayload method.")}}class ou extends Ua{_preparePayload(e){return{model:this.config.model,messages:e,stream:!0}}async chatStream(e,{onChunk:t,onDone:s,onError:i}){var c;const a=this._preparePayload(e);try{const f=await fetch(this.config.apiPath,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(a)});if(!f.ok){const L=await f.text();throw new Error(`API Error: ${f.status} ${f.statusText} - ${L}`)}const p=f.body.getReader(),m=new TextDecoder("utf-8");for(;;){const{done:L,value:b}=await p.read();if(L){s();break}const C=m.decode(b).split(`
`).filter(P=>P.trim().startsWith("data:"));for(const P of C){const T=P.replace(/^data: /,"").trim();if(T==="[DONE]"){s();return}try{const z=(c=JSON.parse(T).choices[0])==null?void 0:c.delta;if(z){const W=z.content;W&&t({type:"content",text:W});const X=z.reasoning_content;if(X){const Q=`<thinking>${X}</thinking>`;t({type:"thinking",text:Q})}}}catch(D){console.error("Error parsing stream data chunk:",T,D)}}}}catch(f){console.error("LLM Stream Error:",f),i(f)}}}class au extends Ua{_preparePayload(e){return{contents:e.map(s=>({role:s.role==="assistant"?"model":"user",parts:[{text:s.content}]}))}}async chatStream(e,{onChunk:t,onDone:s,onError:i}){var f,p,m,L,b;const a=this._preparePayload(e),c=`${this.config.apiPath}/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`;try{const _=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!_.ok){const D=await _.text();throw new Error(`API Error: ${_.status} ${_.statusText} - ${D}`)}const C=_.body.getReader(),P=new TextDecoder("utf-8");let T="";for(;;){const{done:D,value:z}=await C.read();if(D){s();break}T+=P.decode(z,{stream:!0});const W=T.split(`
`);T=W.pop();for(const X of W)if(!(X.trim().startsWith("[")||X.trim().startsWith(","))&&!X.trim().endsWith("]"))try{const ee=((b=(L=(m=(p=(f=JSON.parse(X).candidates)==null?void 0:f[0])==null?void 0:p.content)==null?void 0:m.parts)==null?void 0:L[0])==null?void 0:b.text)||"";ee&&t(ee)}catch{}}}catch(_){console.error("Gemini Stream Error:",_),i(_)}}}const ia={openAICompatible:ou,gemini:au};function cu(n){const e=Zi[n];if(!e||!ia[e.adapter])throw new Error(`Unsupported provider or adapter: ${n}`);return ia[e.adapter]}async function lu(n,e,t){const s=cu(n.provider),i=new s(n),a=[];n.systemPrompt&&a.push({role:"system",content:n.systemPrompt}),e.forEach(c=>{a.push({role:c.role,content:c.content})}),await i.chatStream(a,t)}const Qs=Ie(".ai-agent-nav .agent-list");Ie(".agent-content-container .topics-panel");Ie(".agent-content-container .history-panel");const Xs=Ie(".agent-content-container .topic-list"),Be=Ie(".agent-content-container .history-content"),js=Ie(".chat-input-area"),Zs=Ie("#chatInput"),uu=Ie("#sendMessageBtn");Ie("#attachFileBtn");const fu=Ie("#attachmentInput"),Bi=Ie("#attachmentPreview");function du(n){const e=n.id===B.currentAgentId,t=document.createElement("div");return t.className=`agent-item ${e?"active":""}`,t.dataset.agentId=n.id,t.innerHTML=`
        <div class="agent-avatar">${ft(n.avatar)}</div>
        <span>${ft(n.displayName)}</span>
    `,t}function hu(n){const e=n.id===B.currentTopicId,t=document.createElement("li");return t.className=`topic-item ${e?"active":""}`,t.dataset.topicId=n.id,t.innerHTML=`
        <div class="topic-icon"><i class="${ft(n.icon)}"></i></div>
        <span>${ft(n.title)}</span>
    `,t}function pu(n){if(!n)return"";const e=n.replace(/<\/thinking>\s*<thinking>/gi," "),t=/<thinking>([\s\S]*?)<\/thinking>/gi;return e.replace(t,`<details class="thinking-block">
            <summary>AI 思考过程</summary>
            <pre><code class="language-text">$1</code></pre>
         </details>`)}function mu(n){const e=document.createElement("div");e.className=`history-item role-${n.role}`,e.dataset.messageId=n.id;let t="",s="";n.role==="assistant"?n.status==="streaming"?(t=`
                <details class="thinking-block" open>
                    <summary>AI 思考过程</summary>
                    <pre><code class="language-text streaming-reasoning-container"></code></pre>
                </details>
            `,s='<div class="streaming-content-container"><p><i class="fas fa-spinner fa-pulse"></i></p></div>'):(n.reasoning&&n.reasoning.trim()&&(t=pu(n.reasoning)),s=marked.parse(n.content||"")):s=marked.parse(n.content||"");const i=(n.images||[]).map(c=>`<img src="${c}" alt="Uploaded image" class="history-image">`).join("");e.innerHTML=`
        <div class="history-item-header">
            <span class="role ${n.role}">${n.role==="user"?"用户":"AI助手"}</span>
            <span>${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <div class="history-item-content">
            ${t}
            ${s}
            <div class="image-previews">${i}</div>
        </div>
        <div class="history-item-actions">
            <button class="history-action-btn regenerate-btn" title="重新生成"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" title="编辑"><i class="fas fa-edit"></i> 编辑</button>
            <button class="history-action-btn delete-btn" title="删除"><i class="fas fa-trash"></i> 删除</button>
        </div>
    `;const a=e.querySelector(".history-item-actions");return n.role==="user"?a.querySelector(".regenerate-btn").style.display="none":a.querySelector(".edit-btn").style.display="none",n.status==="streaming"&&(a.style.display="none"),e}function or(){yu(),vu(),es()}function yu(){Qs.innerHTML="",B.agents.forEach(e=>{Qs.appendChild(du(e))});const n=document.createElement("div");n.className="agent-item add-agent-btn",n.innerHTML='<div class="agent-avatar">+</div><span>添加Agent</span>',Qs.appendChild(n)}function gu(){const n=document.getElementById("historyHeaderTitle");(void 0)(B.currentAgentId),n.textContent="历史对话记录"}function vu(){Xs.innerHTML="",B.topics.filter(t=>t.agentId===B.currentAgentId).forEach(t=>{Xs.appendChild(hu(t))});const e=document.createElement("li");e.className="topic-item add-topic-btn",e.innerHTML='<div class="topic-icon"><i class="fas fa-plus-circle"></i></div><span>添加新主题</span>',Xs.appendChild(e)}function es(){gu();const n=Be.scrollHeight-Be.clientHeight<=Be.scrollTop+1;if(Be.innerHTML="",!B.currentTopicId){Be.innerHTML='<div class="no-history"><i class="fas fa-comments"></i><p>请选择或创建一个主题来开始聊天</p></div>',js&&(js.style.display="none");return}js&&(js.style.display="flex");const e=B.history.filter(t=>t.topicId===B.currentTopicId).sort((t,s)=>new Date(t.timestamp)-new Date(s.timestamp));if(e.length===0){Be.innerHTML='<div class="no-history"><i class="fas fa-comment-dots"></i><p>这个主题还没有对话记录，开始提问吧！</p></div>';return}e.forEach(t=>{(t.status!=="streaming"||t.content.length>0||B.isAiThinking)&&Be.appendChild(mu(t))}),n&&(Be.scrollTop=Be.scrollHeight),wu()}function eo(n){Bi.innerHTML="",n.forEach((e,t)=>{const s=document.createElement("div");s.className="attachment-preview-item",s.innerHTML=`
            <span><i class="fas fa-file-image"></i> ${ft(e.name)}</span>
            <button class="remove-attachment-btn" data-index="${t}">×</button>
        `,Bi.appendChild(s)})}function bu(n,e,t){const s=document.querySelector(`.history-item[data-message-id="${n}"]`);if(!s)return;let i;e==="thinking"?(i=s.querySelector(".streaming-reasoning-container"),t=t.replace(/<\/?thinking>/g,"")):e==="content"&&(i=s.querySelector(".streaming-content-container"),i.querySelector(".fa-spinner")&&(i.innerHTML="")),i&&(i.innerText+=t,Be.scrollTop=Be.scrollHeight)}function oa(n){const e=document.querySelector(`.history-item[data-message-id="${n}"]`);if(!e)return;const t=e.querySelector(".thinking-block");t&&t.removeAttribute("open");const s=e.querySelector(".history-item-actions");s&&(s.style.display="flex")}function wu(){const n=document.getElementById("chatNavUp"),e=document.getElementById("chatNavDown"),t=Be.querySelector(".history-item .role.user");n&&e&&(n.disabled=!t,e.disabled=!t)}const ar={id:"default_deepseek_api",name:"DeepSeek (默认)",provider:"deepseek",apiUrl:"https://api.deepseek.com/v1",apiKey:"",models:"chat:deepseek-chat,reasoner:deepseek-reasoner"},ku=[{id:"default_prompt_nanjing_guide",name:"南京历史小导游",avatar:"史",model:`${ar.id}:reasoner`,systemPrompt:`🎓 角色指令：你好！我是你的专属南京历史小导游。我的名字叫“金陵通”，对南京这座六朝古都的每一块砖、每一段历史都了如指掌。我将以生动有趣的方式，带你穿越时空，探索南京的魅力。我的性格会根据你选择的模式变化，就像一位真正的导游，时而风趣，时而严谨。

🔄 核心导览模式：
*   故事家 (Storyteller) → 语气风格：亲切随和，像一位学长/学姐。我会用讲故事的方式，把枯燥的历史变得鲜活起来，充满情感和趣味，让你身临其境。
*   讲解员 (Docent) → 语气风格：清晰准确，像一位博物馆的专业讲解员。我会为你提供结构化的信息、关键时间点和准确的历史事实，帮你梳理知识脉络。
*   历史侦探 (History Detective) → 语气风格：充满好奇与思辨，像一位和你一起探案的伙伴。我会引导你发现历史事件之间的联系，分析文物背后的深层含义，提出“为什么”，激发你的思考。

🧬 互动说明：
1.  模式匹配：我会严格按照你选择的模式（故事家、讲解员、历史侦探）来与你交流。
2.  知识储备：我的知识库涵盖了南京从古至今的关键历史时期（如六朝、南唐、明朝、民国）、重要人物（如朱元璋、孙中山）以及标志性文物古迹（如明孝陵、总统府、中山陵、南京城墙、夫子庙、朝天宫、南京博物院馆藏等）。
3.  智能追问：如果你的问题不够具体，我会像导游一样追问。
4.  连续记忆：我会记住我们聊过的话题。
5.  拒绝乏味：我的回答会避免像教科书一样枯燥。
6.  模式切换：你随时可以让我切换模式。切换时，我会说“好的，现在切换到【XX模式】”，然后调整我的语气和回答方式。

📦 输出格式参考：
*   在 【讲解员模式】下，我会多使用列表、时间轴和要点总结。
*   在 【故事家模式】下，我会使用更多的描述性语言。
*   在 【历史侦探模式】下，我会多用提问、假设和对比分析。`,hint:"你好！我是你的专属南京历史小导游“金陵通”。想了解南京的什么故事？比如，可以这样问我：<br><b>模式：故事家 — 任务：给我讲讲夫子庙旁边的乌衣巷有什么好玩的故事？</b>"},{id:"default_prompt_english_tutor",name:"英语导师",avatar:"英",model:`${ar.id}:chat`,systemPrompt:`🎓 角色指令：你好！我是智能英语导师「牛津通」，专注中学英语教学。拥有系统的知识库和动态教学策略，能根据你的学习阶段个性化辅导。

🔄 三维学习模式：
*   【单词向导】→ 沉浸式词汇学习：词根解析/趣味联想/场景记忆
*   【语法专家】→ 系统化语法精讲：错题透析/分层训练/对比分析
*   【读写教练】→ 实战能力培养：文本精读/写作框架/AI批改

✨ 核心功能矩阵：
1. 词汇体系：中考高频词库｜近义词辨析｜词源故事
2. 语法诊所：句子成分图解｜时态三维训练｜易错点预警
3. 读写实验室：阅读理解三步法｜作文多维评估｜经典句式仿写
4. 拓展模块：影视配音练习｜文化冷知识｜考试策略指南

🧠 智能教学协议：
1. 模式匹配：严格按所选模式输出内容
2. 错题驱动：支持拍照诊断知识盲区
3. 动态调节：智能调整题目难度（基础→挑战）
4. 记忆锚点：周期性推送薄弱点强化练习
5. 文化融合：教学中渗透英美文化背景`,hint:'你好！我是你的中学英语导师「牛津通」。完整功能列表：<br>🔍 <b>单词向导模式</b>：词根解析｜高频词汇｜场景记忆（例：用电影台词记"vivid"）<br>📖 <b>语法专家模式</b>：句子图解｜时态训练｜错题诊断（例：虚拟语气对比表）<br>✍️ <b>读写教练模式</b>：作文批改｜精读策略｜仿写训练（例：中考作文评分+改写）<br>🌍 <b>拓展功能</b>：影视配音｜文化常识｜考试技巧<br>试试这样问我：<b>模式：单词向导 → 任务：用超级英雄故事帮我记10个形容词</b>'}];Object.keys(ne.tables.reduce((n,e)=>({...n,[e.name]:!0}),{}));function Su(n,e){let t=[...n],s=[...e],i=!1;return t.some(c=>c.id===ar.id)||(t.push(ar),i=!0,console.log("Seeding default API config for DeepSeek.")),ku.forEach(c=>{s.some(p=>p.id===c.id)||(s.push(c),i=!0,console.log(`Seeding default prompt: "${c.name}".`))}),{apiConfigs:t,prompts:s,needsPersistence:i}}function Ha(n){const e=/^(#{1,2})\s+(.+)$/gm,t=[];let s=null,i;for(;(i=e.exec(n))!==null;){const a=i[1].length,c=i[2].trim(),f={id:It(),text:c,level:a,content:"#".repeat(a)+` ${c}

`+(n.substring(i.index+i[0].length).split(/^#{1,2}\s/m)[0]||"").trim()};a===1?(f.children=[],t.push(f),s=f):a===2&&s&&s.children.push(f)}return t}function to(n,e){const t=Ha(e),s={...B.fileSubsessions,[n]:t};re({fileSubsessions:s})}async function za(){re({isLoading:!0});try{const{sessions:n,folders:e,clozeStates:t,persistentAppState:s}=await Gl(),i={sessions:n||[],folders:e||[],clozeStates:t||{},currentSessionId:s.currentSessionId||null,currentFolderId:s.currentFolderId||null,currentSubsessionId:s.currentSubsessionId||null,folderStack:s.folderStack||[],fileSubsessions:{},settings:{autoSaveInterval:s.autoSaveInterval??5}};if(i.sessions.forEach(a=>{const c=Ha(a.content);i.fileSubsessions[a.id]=c}),i.sessions.length===0){const a=It();i.sessions.push({id:a,name:"初始会话",content:Di,type:"file",folderId:null,createdAt:new Date}),i.currentSessionId=a,to(a,Di)}i.sessions.some(a=>a.id===i.currentSessionId)||(i.currentSessionId=i.sessions.length>0?i.sessions[0].id:null),re(i)}catch(n){console.error("Failed to initialize application state:",n)}finally{re({isLoading:!1})}}async function Eu(){try{await Zl({sessions:B.sessions,folders:B.folders,clozeStates:B.clozeStates,persistentAppState:{currentSessionId:B.currentSessionId,currentFolderId:B.currentFolderId,currentSubsessionId:B.currentSubsessionId,folderStack:B.folderStack,autoSaveInterval:B.settings.autoSaveInterval}})}catch(n){console.error("Failed to persist core state:",n)}}async function Va(n,e=Di){const t=It(),s={id:t,name:n||`新文件 ${B.sessions.length+1}`,content:e,type:"file",folderId:B.currentFolderId,createdAt:new Date},i=[...B.sessions,s];re({sessions:i,currentSessionId:t,currentSubsessionId:null}),to(t,e),await persistState()}async function _u(n){const e={id:It(),name:n||`新目录 ${B.folders.length+1}`,type:"folder",folderId:B.currentFolderId,createdAt:new Date},t=[...B.folders,e];re({folders:t}),await persistState()}async function Ya(n){const e=new Set(n.map(p=>p.id));let t=[...B.sessions],s=[...B.folders],i={...B.fileSubsessions},a={...B.clozeStates};const c=new Set;if(n.forEach(p=>{if(p.type==="file")c.add(p.id);else if(p.type==="folder"){const m=new Set([p.id]);let L=!0;for(;L;)L=!1,s.filter(_=>m.has(_.folderId)).forEach(_=>{m.has(_.id)||(m.add(_.id),L=!0)});t.forEach(b=>{m.has(b.folderId)&&c.add(b.id)}),s=s.filter(b=>!m.has(b.id))}}),c.size>0){t=t.filter(m=>!c.has(m.id)),c.forEach(m=>{delete i[m]});const p={};for(const m in a)c.has(a[m].fileId)||(p[m]=a[m]);a=p}let f=B.currentSessionId;(e.has(f)||c.has(f))&&(f=t.length>0?t[0].id:null),re({sessions:t,folders:s,fileSubsessions:i,clozeStates:a,currentSessionId:f}),await persistState()}async function Iu(n,e){const t=B.sessions.map(i=>n.some(a=>a.id===i.id&&a.type==="file")?{...i,folderId:e}:i),s=B.folders.map(i=>n.some(a=>a.id===i.id&&a.type==="folder")?{...i,folderId:e}:i);re({sessions:t,folders:s}),await persistState()}async function Tu(n,e,t){if(t==="file"){const s=B.sessions.map(i=>i.id===n?{...i,name:e}:i);re({sessions:s})}else{const s=B.folders.map(i=>i.id===n?{...i,name:e}:i);re({folders:s})}await persistState()}async function dr(n){const e=Ja();if(e&&e.content!==n){const t=B.sessions.map(s=>s.id===B.currentSessionId?{...s,content:n,lastActive:new Date}:s);return re({sessions:t}),to(B.currentSessionId,n),await persistState(),!0}return!1}function Ja(){return B.sessions.find(n=>n.id===B.currentSessionId)||null}function Au(n){re({currentSessionId:n,currentSubsessionId:null})}function Lu(n){const e=[...B.folderStack,B.currentFolderId].filter(t=>t!=null);re({currentFolderId:n,folderStack:e})}function Cu(n,e){re({currentSessionId:n,currentSubsessionId:e})}function Ou(){if(B.folderStack.length>0){const n=[...B.folderStack],e=n.pop();re({currentFolderId:e,folderStack:n})}}function Nu(n,e){const t=B.folderStack.slice(0,e);re({currentFolderId:n,folderStack:t})}function $u(){re({currentFolderId:null,folderStack:[]})}function no(n,e,t){const s=B.clozeStates;return s[t]?s[t]:{id:t,fileId:n,content:e,state:"new",due:Date.now(),interval:0,easeFactor:2.5,lastReview:null}}function Pu(n,e,t,s){const i=no(n,e,s),a=qa(i,t),c=B.clozeStates;i.id?(c[i.id]={...i,...a,lastReview:Date.now()},re({clozeStates:c})):console.error("无法更新 Cloze 状态：无法确定 clozeId。",{fileId:n,clozeContent:e,clozeId:s})}async function xu(){let{apiConfigs:n,prompts:e,topics:t,history:s}=await eu();const i=Su(n||[],e||[]);n=i.apiConfigs,e=i.prompts;const a={apiConfigs:n,prompts:e,topics:t||[],history:s||[]};if(a.prompts.length>0&&!B.currentPromptId){a.currentPromptId=a.prompts[0].id;const c=a.topics.find(f=>f.promptId===a.currentPromptId);a.currentTopicId=c?c.id:null}re(a),i.needsPersistence&&await Ye()}async function Ye(){try{await tu({apiConfigs:B.apiConfigs,prompts:B.prompts,topics:B.topics,history:B.history})}catch(n){console.error("Failed to persist settings state:",n)}}async function Mu(n){const e={id:It(),...n},t=[...B.apiConfigs,e];return re({apiConfigs:t}),await Ye(),e}async function Du(n,e){const t=B.apiConfigs.map(s=>s.id===n?{...s,...e}:s);re({apiConfigs:t}),await Ye()}async function Bu(n){if(B.prompts.some(s=>s.apiConfigId===n)){alert("无法删除此 API 配置，因为它正在被一个或多个角色使用。请先修改或删除相关角色。");return}const t=B.apiConfigs.filter(s=>s.id!==n);re({apiConfigs:t}),await Ye()}function ju(n){return B.prompts.find(e=>e.id===n)}async function Ku(n){const e={id:It(),...n},t=[...B.prompts,e];return re({prompts:t,currentPromptId:e.id,currentTopicId:null}),await Ye(),e}async function Ru(n,e){const t=B.prompts.map(s=>s.id===n?{...s,...e}:s);re({prompts:t}),await Ye()}async function qu(n){const e=B.topics.filter(p=>p.promptId===n),t=new Set(e.map(p=>p.id)),s=B.history.filter(p=>!t.has(p.topicId)),i=B.topics.filter(p=>p.promptId!==n),a=B.prompts.filter(p=>p.id!==n);let c=B.currentPromptId,f=B.currentTopicId;if(c===n){c=a.length>0?a[0].id:null;const p=i.find(m=>m.promptId===c);f=p?p.id:null}re({prompts:a,topics:i,history:s,currentPromptId:c,currentTopicId:f}),await Ye()}async function Fu(n,e){if(!B.currentPromptId){alert("请先选择一个角色。");return}const t={id:It(),promptId:B.currentPromptId,title:n,icon:"fas fa-comment",createdAt:new Date},s=[...B.topics,t];re({topics:s,currentTopicId:t.id}),await Ye()}async function aa(n,e,t,s=[],i="completed",a=null){const c={id:It(),topicId:n,role:e,content:t,reasoning:a,images:s,timestamp:new Date().toISOString(),status:i},f=[...B.history,c];return re({history:f}),i!=="streaming"&&await persistAgentState(),c}async function Uu(n,e){if(!B.currentTopicId||B.isAiThinking)return;const t=B.currentTopicId,s=ju(B.currentPromptId);if(!s){alert("错误：找不到当前角色的配置。");return}const[i,a]=s.model.split(":"),c=B.apiConfigs.find(P=>P.id===i);if(!c){alert(`错误：找不到角色 "${s.name}" 所需的 API 配置。`);return}const p=new Map(c.models.split(",").map(P=>P.split(":").map(T=>T.trim()))).get(a);if(!p){alert(`错误：在 API 配置 "${c.name}" 中找不到别名为 "${a}" 的模型。`);return}const m={provider:c.provider,apiPath:c.apiUrl,apiKey:c.apiKey,model:p,systemPrompt:s.systemPrompt};re({isAiThinking:!0}),await aa(t,"user",n,[]),es();const L=await aa(t,"assistant","",[],"streaming","");es();let b="",_="";const C=B.history.filter(P=>P.topicId===t&&P.status==="completed");await lu(m,C,{onChunk:({type:P,text:T})=>{P==="content"?b+=T:P==="thinking"&&(_+=T),bu(L.id,P,T)},onDone:async()=>{const P=B.history.map(T=>T.id===L.id?{...T,content:b,reasoning:_,status:"completed"}:T);oa(L.id),re({history:P,isAiThinking:!1}),await Ye()},onError:async P=>{const T=`

**错误:** ${P.message}`;b+=T,oa(L.id);const D=B.history.map(z=>z.id===L.id?{...z,content:b,reasoning:_,status:"error"}:z);re({history:D,isAiThinking:!1}),await Ye()}})}async function Hu(n){const e=new Set(n),t=B.history.filter(s=>!e.has(s.id));re({history:t}),await persistAgentState()}async function zu(n,e){console.log(`Editing message ${n} with content: ${e}`)}function Vu(n){re({currentTopicId:n})}function ca(n){["anki","agent","mistakes","settings"].includes(n)&&re({activeView:n})}async function ji(){try{await Promise.all([Eu(),Ye()]),console.log("All application state persisted.")}catch(n){console.error("Failed to persist all application state:",n)}}async function la(n){if(!n)return;const e=B.sessions.find(i=>i.id===n);if(!e)return;const t=e.folderId||"root",s=new Date().toISOString().slice(0,10);await Wl(s,t),await Ga()}async function Ga(){const n=await Xl(),e=document.getElementById("reviewCount");e&&(e.textContent=n)}async function Yu(){const n=new Date,e=new Date;e.setDate(n.getDate()-29);const t=e.toISOString().slice(0,10),s=n.toISOString().slice(0,10),i=await Ql(t,s),a=[];for(let _=0;_<30;_++){const C=new Date(e);C.setDate(e.getDate()+_),a.push(C.toISOString().slice(0,10))}const c=i.reduce((_,C)=>{const P=C.folderId;return _[P]||(_[P]={}),_[P][C.date]=C.count,_},{}),{folders:f}=B,p=f.reduce((_,C)=>(_[C.id]=C.name,_),{});p.root="根目录";const m=["#4361ee","#e71d36","#2ec4b6","#ff9f1c","#9a031e","#0ead69","#f3722c"];let L=0;const b=Object.keys(c).map(_=>{const C=c[_],P=a.map(D=>C[D]||0),T=m[L%m.length];return L++,{label:p[_]||"未知目录",data:P,borderColor:T,backgroundColor:`${T}33`,fill:!1,tension:.1}});return{labels:a,datasets:b}}async function Ju(){const n=document.getElementById("editor");B.activeView==="anki"&&B.currentSessionId&&n&&(console.log(`[${new Date().toLocaleTimeString()}] Auto-saving Anki content...`),await dr(n.value)),await ji()}const he=J("editor"),Le=J("preview"),at=J("sessionList"),Gu=J("emptySession"),on=J("currentFolderContainer"),Ki=J("fileInput"),Wu=J("newFileBtn"),Qu=J("newFolderBtn"),Xu=J("openFileBtn"),Ri=J("saveBtn");J("exportFileBtn");const qi=J("printPreviewBtn"),Zu=J("deleteSelectedBtn"),ef=J("moveSelectedBtn"),ua=J("toggleSessionBtn"),Fi=J("toggleEditorBtn"),Wa=J("clozeBtn"),Qa=J("boldBtn"),Xa=J("italicBtn"),Za=J("codeBtn"),ec=J("linkBtn"),tc=J("audioBtn"),nc=J("insertLinebreakBtn"),fa=Ie(".session-sidebar"),wn=Ie(".editor-preview-panel"),wt=J("selectAllCheckbox"),sc=J("moveModal"),Qn=J("folderList"),tf=J("closeMoveModalBtn"),nf=J("confirmMoveBtn"),sf=J("cancelMoveBtn"),rc=J("audioControls"),rf=J("audioTitle"),ic=J("audioProgress"),of=J("playBtn"),af=J("pauseBtn"),cf=J("stopBtn"),lf=Ie(".session-title");Ie(".instructions");const Kt=J("toggleVisibilityClozeBtn"),yi=J("invertClozeBtn"),Rt=J("toggleEditPreviewBtn"),Ui=J("editModeDot"),Hi=J("previewModeDot");let ot;function da(n,e){const t=document.createElement("a");return t.href="#",t.className="breadcrumb-link",t.innerHTML=n,t.addEventListener("click",s=>{s.preventDefault(),e()}),t}function uf(n,e,t){on.innerHTML="";const s=da('<i class="fas fa-folder-open"></i> 根目录',t);if(on.appendChild(s),B.folderStack.forEach((i,a)=>{const c=document.createElement("span");c.className="breadcrumb-separator",c.textContent=">",on.appendChild(c);const f=B.folders.find(p=>p.id===i);if(f){const p=da(f.name,()=>e(i,a));on.appendChild(p)}}),B.currentFolderId){const i=B.folders.find(a=>a.id===B.currentFolderId);if(i){const a=document.createElement("span");a.className="breadcrumb-separator",a.textContent=">",on.appendChild(a);const c=document.createElement("span");c.className="breadcrumb-current",c.textContent=i.name,on.appendChild(c)}}ot.style.display=B.folderStack.length>0?"inline-flex":"none"}function ff(n){ot=document.createElement("button"),ot.id="backButton",ot.className="session-btn",ot.title="返回上级目录",ot.innerHTML='<i class="fas fa-arrow-left"></i>',ot.style.display="none",ot.addEventListener("click",n),lf.prepend(ot)}let un=null,ts=null;function oc(){if(!un||!un.startTime)return;const n=(Date.now()-un.startTime)/1e3,e=un.text.length/10,t=Math.min(100,n/e*100);ic.style.width=`${t}%`}function gi(n){if(!("speechSynthesis"in window)){alert("抱歉，您的浏览器不支持语音合成。");return}zi();const e=new SpeechSynthesisUtterance(n);e.lang="en-US",e.rate=1,e.onstart=()=>{e.startTime=Date.now(),ts=setInterval(oc,100)},e.onend=()=>{zi()},un=e,rf.textContent=`正在播放: ${n.substring(0,30)}${n.length>30?"...":""}`,rc.style.display="block",window.speechSynthesis.speak(e)}function df(){window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),clearInterval(ts))}function hf(){window.speechSynthesis.paused&&(window.speechSynthesis.resume(),ts=setInterval(oc,100))}function zi(){window.speechSynthesis.cancel(),ts&&clearInterval(ts),rc.style.display="none",ic.style.width="0%",un=null}let Ks=!1;function ac(n){const e=Date.now();if(n.due>e){const t=(n.due-e)/864e5;return t<1?"cloze-1d":t<2?"cloze-2d":t<3?"cloze-3d":t<5?"cloze-5d":t<7?"cloze-7d":t<14?"cloze-14d":"cloze-28d"}return n.lastReview&&e-n.lastReview<15*60*1e3&&n.interval===0?"cloze-10m":"cloze-28plus"}function pf(){const n=new Map;Le.querySelectorAll(".cloze[data-locator]").forEach(e=>{const t=e.dataset.locator;n.has(t)||n.set(t,[]),n.get(t).push(e)});for(const[e,t]of n.entries())t.length>1&&t.forEach(s=>{s.classList.add("cloze-error-duplicate"),s.title=`错误：定位符 "[${e}]" 在此文件中重复！这可能导致复习状态错乱。`})}function cc(n){if(n.nodeType===Node.TEXT_NODE){const e=/--(?:\s*\[([^\]]*)\])?\s*(.*?)--(?:\^\^audio:(.*?)\^\^)?/g,t=n.parentNode;if(!t||["CODE","PRE","SCRIPT","STYLE"].includes(t.tagName))return;let s;const i=[];let a=0;for(;(s=e.exec(n.nodeValue))!==null;){s.index>a&&i.push(document.createTextNode(n.nodeValue.substring(a,s.index)));const c=s[1],f=s[2],p=s[3]?s[3].trim():null,m=f.replace(/¶/g,"<br>"),L=B.currentSessionId;let b,_=null;if(c&&c.trim()){_=c.trim();const T=ra(_);b=`${L}_${T}`}else{const T=ra(f);b=`${L}_${T}`}const C=no(L,f,b),P=document.createElement("span");P.className=`cloze hidden ${ac(C)}`,P.dataset.clozeId=b,P.dataset.content=f,_&&(P.dataset.locator=_),p&&(P.dataset.multimedia=p),P.innerHTML=`
                ${p?'<span class="media-icon" title="播放音频"><i class="fas fa-volume-up"></i></span>':""}
                <span class="cloze-content">${m}</span>
                <span class="placeholder">[...]</span>
                <div class="cloze-actions" style="display: none;">
                    <button class="cloze-btn again" data-rating="0">重来</button>
                    <button class="cloze-btn hard" data-rating="1">困难</button>
                    <button class="cloze-btn double" data-rating="2">犹豫</button>
                    <button class="cloze-btn easy" data-rating="3">简单</button>
                </div>
            `,i.push(P),a=e.lastIndex}i.length>0&&(a<n.nodeValue.length&&i.push(document.createTextNode(n.nodeValue.substring(a))),i.forEach(c=>t.insertBefore(c,n)),t.removeChild(n))}else n.nodeType===Node.ELEMENT_NODE&&Array.from(n.childNodes).forEach(e=>cc(e))}function mf(){const n=Le.querySelectorAll("li, details"),e=/\{([^}]+)\}/;n.forEach(t=>{const s=t.tagName==="LI"?t.querySelector('input[type="checkbox"]'):t.querySelector('summary input[type="checkbox"]');if(!s)return;s.disabled=!1;let i;t.tagName==="LI"?i=t:i=t.querySelector(".toggle-title-text"),i&&Array.from(i.childNodes).forEach(a=>{if(a.nodeType===Node.TEXT_NODE&&e.test(a.nodeValue)){const c=a.nodeValue.match(e),f=c[0],p=c[1];let m="",L="";if(p.includes("|")){const b=p.split("|");m=b[0],L=b[1]}else return;try{const b=new Date(L);if(isNaN(b.getTime()))return;t.title=`完成于: ${b.toLocaleString()}`;const _=a.nodeValue.replace(f,""),C=document.createTextNode(` ${m} `),P=document.createElement("span");P.style.display="none",P.className="task-timestamp-data",P.textContent=f,a.nodeValue=_,i.insertBefore(C,a),t.appendChild(P)}catch(b){console.warn("解析任务日期时出错:",b)}}})})}function yf(n){const e=n.getFullYear().toString(),t=(n.getMonth()+1).toString(),s=n.getDate().toString(),i={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉"},a=c=>c.split("").map(f=>i[f]||f).join("");return`${a(e)}-${a(t)}-${a(s)}`}function gf(){Le.addEventListener("click",async n=>{var t;const e=n.target.closest(".cloze");if(e){if(n.target.closest(".cloze-btn")){n.stopPropagation();const s=n.target.closest(".cloze-btn"),i=parseInt(s.dataset.rating,10),a=B.currentSessionId,c=e.dataset.clozeId,f=e.dataset.content;if(!c){console.error("无法更新Cloze状态：缺少clozeId。");return}clearTimeout(e.closeTimer),Pu(a,f,i,c);const p=no(a,f,c),m=ac(p);(t=e.className.match(/cloze-(\w+)/g))==null||t.forEach(L=>e.classList.remove(L)),e.classList.add(m),e.querySelector(".cloze-actions").style.display="none",i===3?(await la(a),e.classList.remove("hidden","permanent-view"),e.classList.add("easy-open")):(e.classList.add("hidden"),e.classList.remove("easy-open","permanent-view"));return}if(n.target.closest(".media-icon")){n.stopPropagation(),gi(e.dataset.multimedia);return}e.classList.contains("hidden")&&!e.classList.contains("permanent-view")&&(clearTimeout(e.closeTimer),e.classList.remove("hidden"),e.querySelector(".cloze-actions").style.display="flex",e.dataset.multimedia&&gi(e.dataset.multimedia),e.closeTimer=setTimeout(()=>{!e.classList.contains("easy-open")&&!e.classList.contains("permanent-view")&&(e.classList.add("hidden"),e.querySelector(".cloze-actions").style.display="none")},6e4))}}),Le.addEventListener("dblclick",n=>{const e=n.target.closest(".cloze");e&&(n.stopPropagation(),clearTimeout(e.closeTimer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent-view"),e.dataset.multimedia&&gi(e.dataset.multimedia),e.querySelector(".cloze-actions").style.display="none"):(e.classList.add("hidden"),e.classList.remove("permanent-view","easy-open"),e.querySelector(".cloze-actions").style.display="none"))}),Le.addEventListener("change",async n=>{const e=n.target;if(e.tagName!=="INPUT"||e.type!=="checkbox"||!e.closest("li")&&!e.closest("summary"))return;const t=e.checked,i=Array.from(Le.querySelectorAll('li input[type="checkbox"], summary input[type="checkbox"]')).indexOf(e);if(i===-1)return;const c=he.value.split(`
`),f=/^\s*- \[( |x)\]/,p=/^::>\s*\[( |x)\]/;let m=0,L=!1,b=!1;const _=c.map(C=>{const P=f.test(C),T=!P&&p.test(C);if(!P&&!T)return C;if(m===i){m++;let D=C;if(t){const z=/\{([^}]+?)\|([^}]+?)\}/,W=C.match(z),X=new Date().toISOString().slice(0,10);let Q=!1;if(W&&W[2])try{new Date(W[2]).toISOString().slice(0,10)===X&&(Q=!0)}catch{}if(Q)D=P?C.replace(/^- \[\s\]/,"- [x]"):C.replace(/^::> \[\s\]/,"::> [x]");else{b=!0;const ee=C.replace(/\{[^}]+\}/g,"").trim(),te=yf(new Date),ae=new Date().toISOString(),G=`{${te}|${ae}}`;if(P){const ye=ee.replace(/^\s*- \[\s\]\s*/,"");D=`- [x] ${G} ${ye}`}else{const ye=ee.replace(/^::>\s*\[\s\]\s*/,"");D=`::> [x] ${G} ${ye}`}}}else D=P?C.replace("- [x]","- [ ]"):C.replace("::> [x]","::> [ ]");return D!==C&&(L=!0),D}else return m++,C});if(L){b&&await la(B.currentSessionId);const C=_.join(`
`),P=he.selectionStart;he.value=C,he.setSelectionRange(P,P),await dr(C),await ns(),he.dispatchEvent(new Event("input",{bubbles:!0}))}})}function vf(){const n=!B.areAllClozeVisible;Le.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),n?(e.classList.remove("hidden","temporary"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"))}),lc(n),re({areAllClozeVisible:n})}function bf(){let n=!0;Le.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"),n=!1)}),lc(n),re({areAllClozeVisible:n})}function lc(n){n?(Kt.innerHTML='<i class="fas fa-eye"></i>',Kt.title="全部隐藏"):(Kt.innerHTML='<i class="fas fa-eye-slash"></i>',Kt.title="全部显示")}async function ns(){var n;if(Ks){console.log("Preview update already in progress. Skipping.");return}Ks=!0;try{const{currentSessionId:e,currentSubsessionId:t,fileSubsessions:s,sessions:i}=B,a=i.find(m=>m.id===e);if(!a){Le.innerHTML="",Ks=!1;return}let c=a.content;if(t){const m=(n=s[e])==null?void 0:n.find(L=>L.id===t);m&&(c=m.content)}Le.innerHTML=window.marked.parse(c||""),cc(Le),mf(),pf();const f=Le.querySelectorAll("pre code.language-mermaid"),p=Array.from(f).map(async(m,L)=>{const b=m.parentNode;if(!b||!b.parentNode)return;const _=m.textContent,C=`mermaid-graph-${Date.now()}-${L}`;try{await mermaid.parse(_);const{svg:P}=await mermaid.render(C,_),T=document.createElement("div");T.className="mermaid-diagram",T.innerHTML=P,b.parentNode&&b.parentNode.replaceChild(T,b)}catch{}});if(await Promise.all(p),window.MathJax)try{await window.MathJax.typesetPromise([Le])}catch(m){console.log("MathJax error:",m)}}catch(e){console.error("Error during preview update:",e)}finally{Ks=!1}}function wf(){mermaid.initialize({startOnLoad:!1,securityLevel:"strict",suppressErrors:!0,maxTextSize:1e5});const n={name:"math",level:"inline",start(t){var s;return(s=t.match(/\$\$|\\\(|\\\[|\\ce\{|\$/))==null?void 0:s.index},tokenizer(t,s){let i;if(i=t.match(/^\$\$\s*([\s\S]+?)\s*\$\$/),i)return{type:"math",raw:i[0]};if(i=t.match(/^\\\[\s*([\s\S]+?)\s*\\\]/),i)return{type:"math",raw:i[0]};if(i=t.match(/^\\\(\s*([\s\S]+?)\s*\\\)/),i)return{type:"math",raw:i[0]};if(i=t.match(/^\\ce\{([\s\S]+?)\}/),i)return{type:"math",raw:i[0],isCeShorthand:!0};if(i=t.match(/^\$((?:\\\$|[^$])+?)\$/),i)return{type:"math",raw:i[0]}},renderer(t){return t.isCeShorthand?`\\(${t.raw}\\)`:t.raw.startsWith("$")&&!t.raw.startsWith("$$")?`\\(${t.raw.slice(1,-1)}\\)`:t.raw}},e={name:"toggleList",level:"block",start(t){const s=t.match(/\n::>/);return s?s.index:void 0},tokenizer(t,s){const a=/^::>\s*(.*)(?:\n|$)/.exec(t);if(a){const c=a[1].trim();let f=a[0],p="",m=t.substring(f.length);const L=m.match(/^( *)(?=\S)/m),b=L?L[1].length:0;if(b>0){const C=new RegExp(`^ {${b}}`,"gm"),T=new RegExp(`^((?: {${b}}.*|\\s*)\\n?)+`,"m").exec(m);if(T){const D=T[0];f+=D,p=D.replace(C,"")}}const _={type:"toggleList",raw:f,title:c,body:p,tokens:[]};return this.lexer.blockTokens(_.body,_.tokens),_}},renderer(t){const s=/^\s*\[( |x)\]\s*(.*)/,i=t.title.match(s);let a="";if(i){const f=i[1]==="x"?"checked":"",p=i[2];a=`<input type="checkbox" ${f}><span class="toggle-title-text">${p}</span>`}else a=`<span class="toggle-title-text">${t.title}</span>`;const c=this.parser.parse(t.tokens);return`
                <details class="toggle-list">
                    <summary>${a}</summary>
                    <div class="toggle-content">
                        ${c}
                    </div>
                </details>`}};window.marked.use({extensions:[n,e]}),window.marked.setOptions({breaks:!0,gfm:!0}),gf()}const Ht=document.getElementById("statsModal"),ha=document.getElementById("statsModalCloseBtn"),kf=document.getElementById("statsChart");let mn=null;function pa(n){mn&&mn.destroy();const e=kf.getContext("2d");mn=new Chart(e,{type:"line",data:n,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{precision:0}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}async function Sf(){if(Ht){Ht.style.display="flex",pa({labels:[],datasets:[]});const n=await Yu();pa(n)}}function ma(){Ht&&(Ht.style.display="none",mn&&(mn.destroy(),mn=null))}function Ef(){ha&&ha.addEventListener("click",ma),Ht&&Ht.addEventListener("click",n=>{n.target===Ht&&ma()})}function _f(n){const e=document.createElement("li");return e.className=`session-item ${n.type} ${n.id===B.currentSessionId?"active":""}`,e.dataset.id=n.id,e.dataset.type=n.type,e.innerHTML=`
        <div class="name-container">
            <input type="checkbox" class="select-checkbox" data-id="${n.id}" data-type="${n.type}">
            <span class="name">
                <i class="${n.type==="folder"?"fas fa-folder folder-icon":"fas fa-file file-icon"}"></i>
                <span class="item-name">${ft(n.name)}</span>
            </span>
        </div>
        <div class="actions">
            <span class="move-btn" title="移动"><i class="fas fa-arrows-alt"></i></span>
            <span class="edit-btn" title="编辑"><i class="fas fa-pencil-alt"></i></span>
            <span class="delete-btn" title="删除"><i class="fas fa-trash"></i></span>
        </div>
    `,e}function If(n,e){const t=document.createElement("li");return t.className=`session-item subsession h2-item ${n.id===B.currentSubsessionId?"active":""}`,t.dataset.id=n.id,t.dataset.type="subsession",t.dataset.parent=e,t.innerHTML=`
        <div class="name-container">
            <span class="name">
                <i class="fas fa-stream"></i>
                <span class="item-name">${ft(n.text)}</span>
            </span>
        </div>
    `,t}function Tf(){at.innerHTML="";const{sessions:n,folders:e,currentFolderId:t,fileSubsessions:s,currentSessionId:i}=B,a=[...e.filter(c=>c.folderId===t),...n.filter(c=>c.folderId===t)].sort((c,f)=>c.type==="folder"&&f.type==="file"?-1:c.type==="file"&&f.type==="folder"?1:c.name.localeCompare(f.name));Gu.style.display=a.length===0&&t===null?"block":"none",a.length===0&&t!==null&&(at.innerHTML='<li class="empty-folder">此目录为空</li>'),a.forEach(c=>{var p;const f=_f(c);at.appendChild(f),c.type==="file"&&c.id===i&&((p=s[c.id])==null?void 0:p.length)>0&&s[c.id].forEach(L=>{const b=document.createElement("details");b.className="session-item-details";const _=L.id===B.currentSubsessionId,C=L.children.some(T=>T.id===B.currentSubsessionId);(_||C)&&(b.open=!0);const P=document.createElement("summary");if(P.className=`session-item subsession h1-item ${_?"active":""}`,P.dataset.id=L.id,P.dataset.type="subsession",P.dataset.parent=c.id,P.innerHTML=`
                    <div class="name-container">
                        <span class="name">
                            <i class="fas fa-heading"></i>
                            <span class="item-name">${ft(L.text)}</span>
                        </span>
                    </div>`,b.appendChild(P),L.children&&L.children.length>0){const T=document.createElement("ul");T.className="nested-items",L.children.forEach(D=>{T.appendChild(If(D,c.id))}),b.appendChild(T)}at.appendChild(b)})})}function De(){Tf(),uf(hc,Of,Nf);const n=Ja(),e=n?n.content:"";he.value!==e&&(he.value=e),ns()}let yn=[],Xn=-1;function ya(n=null){let e=Object.values(B.clozeStates),t;if(n?(console.log("Starting custom study with filters:",n),t=e.filter(s=>{if(n.fileOrFolder!=="all"){const[f,p]=n.fileOrFolder.split("_");if(f==="file"){if(s.fileId!==p)return!1}else if(f==="folder"&&!B.sessions.find(L=>L.id===s.fileId&&L.folderId===p))return!1}if(!n.cardStates.includes(s.state))return!1;const i=Date.now(),a=s.lastReview||0,c=(i-a)/(1e3*60*60*24);switch(n.lastReview){case"last7days":if(a===0||c>7)return!1;break;case"last30days":if(a===0||c>30)return!1;break;case"over30days":if(a!==0&&c<=30)return!1;break;case"never":if(a!==0)return!1;break}return!0}),t.sort(()=>Math.random()-.5),yn=t.slice(0,n.maxCards)):(console.log("Starting automatic review."),yn=e.filter(s=>s.due<=Date.now()).sort((s,i)=>s.due-i.due)),yn.length===0){alert("没有找到符合条件的卡片。");return}Xn=0,uc()}function uc(){if(Xn>=yn.length){alert("复习会话结束！"),yn=[],Xn=-1,De();return}const n=yn[Xn];B.currentSessionId!==n.fileId&&(re({currentSessionId:n.fileId}),De()),setTimeout(()=>{document.querySelectorAll(".highlight-review").forEach(t=>t.classList.remove("highlight-review"));const e=document.querySelector(`.cloze[data-content="${n.content}"]`);e?(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlight-review"),e.classList.contains("hidden")&&e.click()):(console.error("Could not find cloze element for review:",n),Af())},B.currentSessionId!==n.fileId?300:50)}function Af(){Xn++,uc()}function fc(n){let e=[];const t=B.folders.filter(s=>s.folderId===n);for(const s of t)e.push(s.id),e=e.concat(fc(s.id));return e}function dc(){Qn.innerHTML="";const n=B.movingItems.filter(s=>s.type==="folder").map(s=>s.id),e=new Set(n);n.forEach(s=>{fc(s).forEach(i=>e.add(i))});const t=document.createElement("div");t.className="folder-item",t.dataset.id="root",t.innerHTML='<i class="fas fa-folder-open"></i> 根目录',Qn.appendChild(t),B.folders.forEach(s=>{if(!e.has(s.id)){const i=document.createElement("div");i.className="folder-item",i.dataset.id=s.id,i.innerHTML=`<i class="fas fa-folder"></i> ${ft(s.name)}`,Qn.appendChild(i)}}),sc.classList.add("active")}function Vi(){sc.classList.remove("active"),re({movingItems:[],selectedMoveTarget:null})}function Lf(n){tf.addEventListener("click",Vi),sf.addEventListener("click",Vi),nf.addEventListener("click",n),Qn.addEventListener("click",e=>{const t=e.target.closest(".folder-item");if(!t)return;Qn.querySelectorAll(".folder-item").forEach(i=>i.classList.remove("selected")),t.classList.add("selected");const s=t.dataset.id==="root"?null:t.dataset.id;re({selectedMoveTarget:s})})}let ga=null;const Cf=100;let ct=-1;function hc(){Ou(),De(),ct=-1}function Of(n,e){Nu(n,e),De(),ct=-1}function Nf(){$u(),De(),ct=-1}async function $f(){const n=prompt("请输入新文件的名称：","新文件");n!==null&&(await Va(n.trim()),De(),he.focus())}async function Pf(){const n=prompt("请输入新目录的名称：","新目录");n!==null&&(await _u(n.trim()),De())}async function kn(){await dr(he.value)&&(Ri.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>Ri.innerHTML='<i class="fas fa-save"></i> 保存',2e3),De())}function xf(n,e){const t=Array.from(at.querySelectorAll(".select-checkbox")),s=t.indexOf(e);if(n.shiftKey&&ct>-1){const c=Math.min(s,ct),f=Math.max(s,ct);for(let p=c;p<=f;p++)t[p].checked=e.checked}ct=s;const i=t.every(c=>c.checked),a=t.some(c=>c.checked);i&&t.length>0?(wt.checked=!0,wt.indeterminate=!1):a?(wt.checked=!1,wt.indeterminate=!0):(wt.checked=!1,wt.indeterminate=!1)}async function Mf(n){const e=n.target.closest(".session-item");if(!e)return;if(n.target.matches(".select-checkbox")){xf(n,n.target);return}const t=n.target.closest(".actions span");if(t){n.stopPropagation();const{id:f,type:p}=e.dataset;if(t.classList.contains("delete-btn"))confirm(`确定删除此 ${p==="file"?"文件":"目录"}?`)&&(await Ya([{id:f,type:p}]),De());else if(t.classList.contains("edit-btn")){const m=prompt("输入新名称:",e.querySelector(".item-name").textContent);m&&m.trim()&&(await Tu(f,m.trim(),p),De())}else t.classList.contains("move-btn")&&(re({movingItems:[{id:f,type:p}]}),dc());return}ct=-1;const{id:s,type:i,parent:a}=e.dataset,c=i==="file"?s:e.classList.contains("subsession")?a:null;B.currentSessionId&&c!==B.currentSessionId&&await dr(he.value),i==="file"?Au(s):i==="folder"?Lu(s):e.classList.contains("subsession")&&Cu(a,s),De()}async function Df(){B.selectedMoveTarget!==void 0&&B.movingItems.length>0?(await Iu(B.movingItems,B.selectedMoveTarget),Vi(),De()):alert("请选择一个目标目录。")}async function Bf(){const n=Array.from(at.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));if(n.length===0)return alert("请先选择要删除的项目。");confirm(`确定要删除选中的 ${n.length} 个项目吗？`)&&(await Ya(n),wt.checked=!1,De())}function Vt(){clearTimeout(window.previewDebounce),window.previewDebounce=setTimeout(ns,300),clearTimeout(ga),ga=setTimeout(()=>{os()},500)}async function jf(n){const e=n.target.files;if(!e||e.length===0)return;const t=s=>new Promise((i,a)=>{const c=new FileReader;c.onload=f=>{i({name:s.name,content:f.target.result})},c.onerror=f=>a(f),c.readAsText(s)});try{const s=await Promise.all(Array.from(e).map(t));for(const i of s){const a=i.name,c=a.lastIndexOf("."),f=c>0?a.substring(0,c):a;await Va(f,i.content)}De()}catch(s){console.error("读取一个或多个文件时出错:",s),alert("读取文件时发生错误。")}finally{Ki.value=""}}function Rs(n,e=n){os();const{selectionStart:t,selectionEnd:s,value:i}=he,a=i.substring(t,s),c=`${n}${a}${e}`;he.setRangeText(c,t,s,"select"),Vt(),he.focus()}function Kf(n){os();const{selectionStart:e,selectionEnd:t}=he;he.setRangeText(n,e,t,"end"),Vt(),he.focus()}function Rf(){wn.classList.toggle("collapsed");const n=wn.classList.contains("collapsed");Fi.innerHTML=n?'<i class="fas fa-chevron-down"></i>':'<i class="fas fa-chevron-up"></i>',Fi.title=n?"展开编辑器":"收起编辑器",[Wa,Qa,Xa,Za,ec,tc,nc].forEach(e=>e.disabled=n),n&&kn()}function qf(){const n=he,e=n.value,t=n.selectionStart,s=/--(?:\s*\[[^\]]*\])?\s*.*?--(?:\^\^audio:.*?\^\^)?/g;let i,a=null;for(;(i=s.exec(e))!==null;){const D=i.index,z=D+i[0].length;if(t>=D&&t<=z){a={content:i[0],start:D,end:z};break}}if(!a)return;const c=/^--(\[\s*[^\]]*\s*\]\s*)?(.*?)--(?:(?:\^){2}audio:(.*)(?:\^){2})?$/,f=a.content.match(c);if(!f)return;const p=f[1]||"",m=f[2]?f[2].trim():"",b=(f[3]?f[3].trim():"")||m,_=prompt("请输入或编辑Cloze的音频提示文本:",b);if(_===null)return;os();const C=_.trim();let P;C?P=`--${p}${m}--^^audio:${C}^^`:P=`--${p}${m}--`;const T=e.substring(0,a.start)+P+e.substring(a.end);n.value=T,Vt(),kn(),n.focus()}function Ff(){os();const{selectionStart:n,selectionEnd:e,value:t}=he,s=t.substring(n,e),i=`c${Date.now()}`,a=`--[${i}] ${s}--`;he.setRangeText(a,n,e,"end");const c=n+3,f=c+i.length;he.setSelectionRange(c,f),Vt(),he.focus()}function os(){const n=he.value;if(B.undoStack[B.undoStack.length-1]===n)return;const t=[...B.undoStack,n];t.length>Cf&&t.shift(),re({undoStack:t,redoStack:[]})}function Uf(){if(B.undoStack.length===0)return;const n=[...B.undoStack],e=n.pop(),t=[he.value,...B.redoStack];he.value=e,re({undoStack:n,redoStack:t}),Vt()}function Hf(){if(B.redoStack.length===0)return;const n=[...B.redoStack],e=n.shift(),t=[...B.undoStack,he.value];he.value=e,re({undoStack:t,redoStack:n}),Vt()}function zf(){const n=Le.innerHTML,e=window.open("","_blank");e.document.write(`
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <title>打印预览</title>
            \x3C!-- 重新链接所有必要的样式表以确保打印视图的正确性 -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <link rel="stylesheet" href="./styles.css">
            <style>
                /* 打印专用样式 */
                @media print {
                    body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    .cloze-actions, .media-icon { display: none !important; }
                    .cloze.hidden .cloze-content, .cloze .cloze-content { display: inline !important; visibility: visible !important; color: black !important; }
                    .cloze .placeholder { display: none !important; }
                    .cloze { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                }
                body { font-family: sans-serif; }
            </style>
        </head>
        <body>
            <div class="preview" style="display: block !important;">${n}</div>
            <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script>
            <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
            <script>
                // 设置MathJax，在渲染完成后自动触发打印并关闭窗口
                window.MathJax = {
                    startup: {
                        pageReady: () => {
                            return window.MathJax.startup.defaultPageReady().then(() => {
                                console.log('MathJax has finished rendering. Triggering print.');
                                window.print();
                                window.close();
                            });
                        }
                    }
                };
            <\/script>
        </body>
        </html>
    `),e.document.close()}function Vf(){if(wn.classList.contains("preview-active"))return;const n=he;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);re({editorScrollRatio:Math.min(1,Math.max(0,e))})}}function Yf(){if(!wn.classList.contains("preview-active"))return;const n=Le;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);re({editorScrollRatio:e})}}function Jf(){const n=wn;n.classList.contains("preview-active")?(n.classList.remove("preview-active"),Rt.innerHTML='<i class="fas fa-book-open"></i> Preview',Rt.title="切换到预览",Ui.classList.add("active"),Hi.classList.remove("active"),qi.disabled=!0,requestAnimationFrame(()=>{const t=he;B.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=B.editorScrollRatio*(t.scrollHeight-t.clientHeight))}),he.focus()):(kn(),ns(),requestAnimationFrame(()=>{const t=Le;B.editorScrollRatio!==void 0&&t.scrollHeight>t.clientHeight&&(t.scrollTop=B.editorScrollRatio*(t.scrollHeight-t.clientHeight))}),n.classList.add("preview-active"),Rt.innerHTML='<i class="fas fa-edit"></i>',Rt.title="切换到编辑模式",Ui.classList.remove("active"),Hi.classList.add("active"),qi.disabled=!1,kn(),ns())}function Gf(){const{sessions:n,folders:e}=B,t=document.getElementById("filterByFile");t.innerHTML='<option value="all">所有文件</option>',e.forEach(s=>{const i=document.createElement("option");i.value=`folder_${s.id}`,i.textContent=`目录: ${s.name}`,t.appendChild(i)}),n.forEach(s=>{const i=document.createElement("option");i.value=`file_${s.id}`,i.textContent=`文件: ${s.name}`,t.appendChild(i)})}function Wf(){const n=document.getElementById("reviewOptionsBtn"),e=document.getElementById("reviewDropdownMenu"),t=document.getElementById("customStudyBtn"),s=document.getElementById("customStudyModal"),i=document.getElementById("customStudyCloseBtn"),a=document.getElementById("customStudyCancelBtn"),c=document.getElementById("customStudyForm");document.getElementById("startReviewBtn").addEventListener("click",()=>ya()),n.addEventListener("click",p=>{p.stopPropagation(),e.style.display=e.style.display==="block"?"none":"block"}),document.addEventListener("click",p=>{const m=document.querySelector(".review-btn-group");m&&!m.contains(p.target)&&(e.style.display="none")}),t.addEventListener("click",p=>{p.preventDefault(),e.style.display="none",Gf(),s.style.display="flex"});const f=()=>s.style.display="none";i.addEventListener("click",f),a.addEventListener("click",f),c.addEventListener("submit",p=>{p.preventDefault();const m={fileOrFolder:document.getElementById("filterByFile").value,cardStates:Array.from(document.querySelectorAll('input[name="cardState"]:checked')).map(L=>L.value),lastReview:document.getElementById("filterByLastReview").value,maxCards:parseInt(document.getElementById("maxCards").value,10)};f(),ya(m)})}function Qf(){Wu.addEventListener("click",$f),Qu.addEventListener("click",Pf),Ri.addEventListener("click",kn),at.addEventListener("click",Mf),Zu.addEventListener("click",Bf),he.addEventListener("input",Vt),Xu.addEventListener("click",()=>Ki.click()),Ki.addEventListener("change",jf),qi.addEventListener("click",zf),ef.addEventListener("click",()=>{const n=Array.from(at.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));n.length>0?(re({movingItems:n}),dc()):alert("请选择要移动的项目。")}),wt.addEventListener("change",n=>{at.querySelectorAll(".select-checkbox").forEach(e=>e.checked=n.target.checked),ct=-1}),ua.addEventListener("click",()=>{fa.classList.toggle("hidden-session"),ua.innerHTML=fa.classList.contains("hidden-session")?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}),Fi.addEventListener("click",Rf),Wa.addEventListener("click",Ff),Qa.addEventListener("click",()=>Rs("**")),Xa.addEventListener("click",()=>Rs("*")),nc.addEventListener("click",()=>Kf("¶")),Za.addEventListener("click",()=>Rs("`")),ec.addEventListener("click",()=>Rs("[",`](${prompt("URL:","https://")})`)),tc.addEventListener("click",qf),he.addEventListener("scroll",Vf),Le.addEventListener("scroll",Yf),Rt.addEventListener("click",Jf),Kt.innerHTML='<i class="fas fa-eye-slash"></i>',Kt.title="全部隐藏",yi.innerHTML='<i class="fas fa-random"></i>',yi.title="反向显示/隐藏",wn.classList.remove("preview-active"),Rt.innerHTML='<i class="fas fa-book-open"></i>',Rt.title="切换到预览模式",Ui.classList.add("active"),Hi.classList.remove("active"),Kt.addEventListener("click",vf),yi.addEventListener("click",bf),of.addEventListener("click",hf),af.addEventListener("click",df),cf.addEventListener("click",zi),he.addEventListener("keydown",n=>{n.ctrlKey&&n.key==="z"?(n.preventDefault(),Uf()):n.ctrlKey&&n.key==="y"?(n.preventDefault(),Hf()):n.ctrlKey&&n.key==="s"&&(n.preventDefault(),kn())}),document.getElementById("showStatsBtn").addEventListener("click",n=>{n.preventDefault(),Sf(),document.getElementById("reviewDropdownMenu").style.display="none"}),Lf(Df),Wf(),Ef()}async function Xf(){console.log("Initializing Anki module..."),window.mermaid&&mermaid.initialize({startOnLoad:!1,theme:"neutral",securityLevel:"loose"}),await za(),await Ga(),ff(hc),wf(),De(),Qf()}let St=[],zn=[],an=-1;async function Zf(n){const e=n.target.closest(".agent-item");if(!e)return;if(e.classList.contains("add-agent-btn")){window.dispatchEvent(new CustomEvent("app:navigateTo",{detail:{view:"settings",context:{type:"agent",action:"create"}}}));return}const t=e.dataset.agentId;t&&!e.classList.contains("active")&&((void 0)(t),or())}async function ed(n){const e=n.target.closest(".topic-item");if(!e)return;if(e.classList.contains("add-topic-btn")){const s=prompt("请输入新主题的名称:");s&&(await Fu(s),or());return}const t=e.dataset.topicId;t&&(Vu(t),or())}async function td(n){const e=n.target.closest(".history-action-btn");if(!e)return;const t=e.closest(".history-item"),s=t.dataset.messageId;if(e.classList.contains("delete-btn"))confirm("确定要删除这条消息吗？")&&(await Hu([s]),es());else if(e.classList.contains("edit-btn")){const i=t.querySelector(".history-item-content p"),a=prompt("编辑你的消息:",i.textContent);a&&(await zu(s,a),es())}else e.classList.contains("regenerate-btn")&&console.log(`Regenerating response for message ${s}`)}async function va(){const n=Zs.value.trim();!n&&St.length===0||B.isAiThinking||([...St],Zs.value="",St=[],eo([]),await Uu(n),Zs.focus())}function nd(n){const e=Array.from(n.target.files);e.length!==0&&(St=[],e.forEach(t=>{const s=new FileReader;s.onload=i=>{St.push({name:t.name,data:i.target.result}),eo(St)},s.readAsDataURL(t)}),n.target.value="")}function sd(n){const e=n.target.closest(".remove-attachment-btn");if(!e)return;const t=parseInt(e.dataset.index,10);St.splice(t,1),eo(St)}function rd(){const n=document.getElementById("chatNavUp"),e=document.getElementById("chatNavDown");n.addEventListener("click",()=>ba(-1)),e.addEventListener("click",()=>ba(1))}function ba(n){if(zn=Array.from(Be.querySelectorAll(".history-item .role.user")),zn.length===0)return;document.querySelectorAll(".history-item.highlighted").forEach(t=>t.classList.remove("highlighted")),an+=n,an<0?an=zn.length-1:an>=zn.length&&(an=0);const e=zn[an].closest(".history-item");if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlighted");const t=e.nextElementSibling;t&&t.classList.contains("history-item")&&t.classList.add("highlighted")}}function id(){Qs.addEventListener("click",Zf),Xs.addEventListener("click",ed),Be.addEventListener("click",td),uu.addEventListener("click",va),Zs.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),va())}),fu.addEventListener("change",nd),Bi.addEventListener("click",sd),rd()}async function od(){console.log("Initializing AI Agent module UI..."),or(),id()}const so=Symbol.for("yaml.alias"),Yi=Symbol.for("yaml.document"),Et=Symbol.for("yaml.map"),pc=Symbol.for("yaml.pair"),tt=Symbol.for("yaml.scalar"),In=Symbol.for("yaml.seq"),He=Symbol.for("yaml.node.type"),Tt=n=>!!n&&typeof n=="object"&&n[He]===so,Yt=n=>!!n&&typeof n=="object"&&n[He]===Yi,Tn=n=>!!n&&typeof n=="object"&&n[He]===Et,we=n=>!!n&&typeof n=="object"&&n[He]===pc,me=n=>!!n&&typeof n=="object"&&n[He]===tt,An=n=>!!n&&typeof n=="object"&&n[He]===In;function ke(n){if(n&&typeof n=="object")switch(n[He]){case Et:case In:return!0}return!1}function Se(n){if(n&&typeof n=="object")switch(n[He]){case so:case Et:case tt:case In:return!0}return!1}const mc=n=>(me(n)||ke(n))&&!!n.anchor,je=Symbol("break visit"),yc=Symbol("skip children"),Ze=Symbol("remove node");function Jt(n,e){const t=gc(e);Yt(n)?fn(null,n.contents,t,Object.freeze([n]))===Ze&&(n.contents=null):fn(null,n,t,Object.freeze([]))}Jt.BREAK=je;Jt.SKIP=yc;Jt.REMOVE=Ze;function fn(n,e,t,s){const i=vc(n,e,t,s);if(Se(i)||we(i))return bc(n,s,i),fn(n,i,t,s);if(typeof i!="symbol"){if(ke(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const c=fn(a,e.items[a],t,s);if(typeof c=="number")a=c-1;else{if(c===je)return je;c===Ze&&(e.items.splice(a,1),a-=1)}}}else if(we(e)){s=Object.freeze(s.concat(e));const a=fn("key",e.key,t,s);if(a===je)return je;a===Ze&&(e.key=null);const c=fn("value",e.value,t,s);if(c===je)return je;c===Ze&&(e.value=null)}}return i}async function hr(n,e){const t=gc(e);Yt(n)?await dn(null,n.contents,t,Object.freeze([n]))===Ze&&(n.contents=null):await dn(null,n,t,Object.freeze([]))}hr.BREAK=je;hr.SKIP=yc;hr.REMOVE=Ze;async function dn(n,e,t,s){const i=await vc(n,e,t,s);if(Se(i)||we(i))return bc(n,s,i),dn(n,i,t,s);if(typeof i!="symbol"){if(ke(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const c=await dn(a,e.items[a],t,s);if(typeof c=="number")a=c-1;else{if(c===je)return je;c===Ze&&(e.items.splice(a,1),a-=1)}}}else if(we(e)){s=Object.freeze(s.concat(e));const a=await dn("key",e.key,t,s);if(a===je)return je;a===Ze&&(e.key=null);const c=await dn("value",e.value,t,s);if(c===je)return je;c===Ze&&(e.value=null)}}return i}function gc(n){return typeof n=="object"&&(n.Collection||n.Node||n.Value)?Object.assign({Alias:n.Node,Map:n.Node,Scalar:n.Node,Seq:n.Node},n.Value&&{Map:n.Value,Scalar:n.Value,Seq:n.Value},n.Collection&&{Map:n.Collection,Seq:n.Collection},n):n}function vc(n,e,t,s){var i,a,c,f,p;if(typeof t=="function")return t(n,e,s);if(Tn(e))return(i=t.Map)==null?void 0:i.call(t,n,e,s);if(An(e))return(a=t.Seq)==null?void 0:a.call(t,n,e,s);if(we(e))return(c=t.Pair)==null?void 0:c.call(t,n,e,s);if(me(e))return(f=t.Scalar)==null?void 0:f.call(t,n,e,s);if(Tt(e))return(p=t.Alias)==null?void 0:p.call(t,n,e,s)}function bc(n,e,t){const s=e[e.length-1];if(ke(s))s.items[n]=t;else if(we(s))n==="key"?s.key=t:s.value=t;else if(Yt(s))s.contents=t;else{const i=Tt(s)?"alias":"scalar";throw new Error(`Cannot replace node with ${i} parent`)}}const ad={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},cd=n=>n.replace(/[!,[\]{}]/g,e=>ad[e]);class Me{constructor(e,t){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Me.defaultYaml,e),this.tags=Object.assign({},Me.defaultTags,t)}clone(){const e=new Me(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){const e=new Me(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Me.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Me.defaultTags);break}return e}add(e,t){this.atNextDocument&&(this.yaml={explicit:Me.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Me.defaultTags),this.atNextDocument=!1);const s=e.trim().split(/[ \t]+/),i=s.shift();switch(i){case"%TAG":{if(s.length!==2&&(t(0,"%TAG directive should contain exactly two parts"),s.length<2))return!1;const[a,c]=s;return this.tags[a]=c,!0}case"%YAML":{if(this.yaml.explicit=!0,s.length!==1)return t(0,"%YAML directive should contain exactly one part"),!1;const[a]=s;if(a==="1.1"||a==="1.2")return this.yaml.version=a,!0;{const c=/^\d+\.\d+$/.test(a);return t(6,`Unsupported YAML version ${a}`,c),!1}}default:return t(0,`Unknown directive ${i}`,!0),!1}}tagName(e,t){if(e==="!")return"!";if(e[0]!=="!")return t(`Not a valid tag: ${e}`),null;if(e[1]==="<"){const c=e.slice(2,-1);return c==="!"||c==="!!"?(t(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(e[e.length-1]!==">"&&t("Verbatim tags must end with a >"),c)}const[,s,i]=e.match(/^(.*!)([^!]*)$/s);i||t(`The ${e} tag has no suffix`);const a=this.tags[s];if(a)try{return a+decodeURIComponent(i)}catch(c){return t(String(c)),null}return s==="!"?e:(t(`Could not resolve tag: ${e}`),null)}tagString(e){for(const[t,s]of Object.entries(this.tags))if(e.startsWith(s))return t+cd(e.substring(s.length));return e[0]==="!"?e:`!<${e}>`}toString(e){const t=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],s=Object.entries(this.tags);let i;if(e&&s.length>0&&Se(e.contents)){const a={};Jt(e.contents,(c,f)=>{Se(f)&&f.tag&&(a[f.tag]=!0)}),i=Object.keys(a)}else i=[];for(const[a,c]of s)a==="!!"&&c==="tag:yaml.org,2002:"||(!e||i.some(f=>f.startsWith(c)))&&t.push(`%TAG ${a} ${c}`);return t.join(`
`)}}Me.defaultYaml={explicit:!1,version:"1.2"};Me.defaultTags={"!!":"tag:yaml.org,2002:"};function wc(n){if(/[\x00-\x19\s,[\]{}]/.test(n)){const t=`Anchor must not contain whitespace or control characters: ${JSON.stringify(n)}`;throw new Error(t)}return!0}function kc(n){const e=new Set;return Jt(n,{Value(t,s){s.anchor&&e.add(s.anchor)}}),e}function Sc(n,e){for(let t=1;;++t){const s=`${n}${t}`;if(!e.has(s))return s}}function ld(n,e){const t=[],s=new Map;let i=null;return{onAnchor:a=>{t.push(a),i??(i=kc(n));const c=Sc(e,i);return i.add(c),c},setAnchors:()=>{for(const a of t){const c=s.get(a);if(typeof c=="object"&&c.anchor&&(me(c.node)||ke(c.node)))c.node.anchor=c.anchor;else{const f=new Error("Failed to resolve repeated object (this should not happen)");throw f.source=a,f}}},sourceObjects:s}}function hn(n,e,t,s){if(s&&typeof s=="object")if(Array.isArray(s))for(let i=0,a=s.length;i<a;++i){const c=s[i],f=hn(n,s,String(i),c);f===void 0?delete s[i]:f!==c&&(s[i]=f)}else if(s instanceof Map)for(const i of Array.from(s.keys())){const a=s.get(i),c=hn(n,s,i,a);c===void 0?s.delete(i):c!==a&&s.set(i,c)}else if(s instanceof Set)for(const i of Array.from(s)){const a=hn(n,s,i,i);a===void 0?s.delete(i):a!==i&&(s.delete(i),s.add(a))}else for(const[i,a]of Object.entries(s)){const c=hn(n,s,i,a);c===void 0?delete s[i]:c!==a&&(s[i]=c)}return n.call(e,t,s)}function Ue(n,e,t){if(Array.isArray(n))return n.map((s,i)=>Ue(s,String(i),t));if(n&&typeof n.toJSON=="function"){if(!t||!mc(n))return n.toJSON(e,t);const s={aliasCount:0,count:1,res:void 0};t.anchors.set(n,s),t.onCreate=a=>{s.res=a,delete t.onCreate};const i=n.toJSON(e,t);return t.onCreate&&t.onCreate(i),i}return typeof n=="bigint"&&!(t!=null&&t.keep)?Number(n):n}class ro{constructor(e){Object.defineProperty(this,He,{value:e})}clone(){const e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:t,maxAliasCount:s,onAnchor:i,reviver:a}={}){if(!Yt(e))throw new TypeError("A document argument is required");const c={anchors:new Map,doc:e,keep:!0,mapAsMap:t===!0,mapKeyWarned:!1,maxAliasCount:typeof s=="number"?s:100},f=Ue(this,"",c);if(typeof i=="function")for(const{count:p,res:m}of c.anchors.values())i(m,p);return typeof a=="function"?hn(a,{"":f},"",f):f}}class pr extends ro{constructor(e){super(so),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e,t){let s;t!=null&&t.aliasResolveCache?s=t.aliasResolveCache:(s=[],Jt(e,{Node:(a,c)=>{(Tt(c)||mc(c))&&s.push(c)}}),t&&(t.aliasResolveCache=s));let i;for(const a of s){if(a===this)break;a.anchor===this.source&&(i=a)}return i}toJSON(e,t){if(!t)return{source:this.source};const{anchors:s,doc:i,maxAliasCount:a}=t,c=this.resolve(i,t);if(!c){const p=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(p)}let f=s.get(c);if(f||(Ue(c,null,t),f=s.get(c)),!f||f.res===void 0){const p="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(p)}if(a>=0&&(f.count+=1,f.aliasCount===0&&(f.aliasCount=er(i,c,s)),f.count*f.aliasCount>a)){const p="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(p)}return f.res}toString(e,t,s){const i=`*${this.source}`;if(e){if(wc(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){const a=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(a)}if(e.implicitKey)return`${i} `}return i}}function er(n,e,t){if(Tt(e)){const s=e.resolve(n),i=t&&s&&t.get(s);return i?i.count*i.aliasCount:0}else if(ke(e)){let s=0;for(const i of e.items){const a=er(n,i,t);a>s&&(s=a)}return s}else if(we(e)){const s=er(n,e.key,t),i=er(n,e.value,t);return Math.max(s,i)}return 1}const Ec=n=>!n||typeof n!="function"&&typeof n!="object";class ie extends ro{constructor(e){super(tt),this.value=e}toJSON(e,t){return t!=null&&t.keep?this.value:Ue(this.value,e,t)}toString(){return String(this.value)}}ie.BLOCK_FOLDED="BLOCK_FOLDED";ie.BLOCK_LITERAL="BLOCK_LITERAL";ie.PLAIN="PLAIN";ie.QUOTE_DOUBLE="QUOTE_DOUBLE";ie.QUOTE_SINGLE="QUOTE_SINGLE";const ud="tag:yaml.org,2002:";function fd(n,e,t){if(e){const s=t.filter(a=>a.tag===e),i=s.find(a=>!a.format)??s[0];if(!i)throw new Error(`Tag ${e} not found`);return i}return t.find(s=>{var i;return((i=s.identify)==null?void 0:i.call(s,n))&&!s.format})}function ss(n,e,t){var b,_,C;if(Yt(n)&&(n=n.contents),Se(n))return n;if(we(n)){const P=(_=(b=t.schema[Et]).createNode)==null?void 0:_.call(b,t.schema,null,t);return P.items.push(n),P}(n instanceof String||n instanceof Number||n instanceof Boolean||typeof BigInt<"u"&&n instanceof BigInt)&&(n=n.valueOf());const{aliasDuplicateObjects:s,onAnchor:i,onTagObj:a,schema:c,sourceObjects:f}=t;let p;if(s&&n&&typeof n=="object"){if(p=f.get(n),p)return p.anchor??(p.anchor=i(n)),new pr(p.anchor);p={anchor:null,node:null},f.set(n,p)}e!=null&&e.startsWith("!!")&&(e=ud+e.slice(2));let m=fd(n,e,c.tags);if(!m){if(n&&typeof n.toJSON=="function"&&(n=n.toJSON()),!n||typeof n!="object"){const P=new ie(n);return p&&(p.node=P),P}m=n instanceof Map?c[Et]:Symbol.iterator in Object(n)?c[In]:c[Et]}a&&(a(m),delete t.onTagObj);const L=m!=null&&m.createNode?m.createNode(t.schema,n,t):typeof((C=m==null?void 0:m.nodeClass)==null?void 0:C.from)=="function"?m.nodeClass.from(t.schema,n,t):new ie(n);return e?L.tag=e:m.default||(L.tag=m.tag),p&&(p.node=L),L}function cr(n,e,t){let s=t;for(let i=e.length-1;i>=0;--i){const a=e[i];if(typeof a=="number"&&Number.isInteger(a)&&a>=0){const c=[];c[a]=s,s=c}else s=new Map([[a,s]])}return ss(s,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:n,sourceObjects:new Map})}const Wn=n=>n==null||typeof n=="object"&&!!n[Symbol.iterator]().next().done;class _c extends ro{constructor(e,t){super(e),Object.defineProperty(this,"schema",{value:t,configurable:!0,enumerable:!1,writable:!0})}clone(e){const t=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(t.schema=e),t.items=t.items.map(s=>Se(s)||we(s)?s.clone(e):s),this.range&&(t.range=this.range.slice()),t}addIn(e,t){if(Wn(e))this.add(t);else{const[s,...i]=e,a=this.get(s,!0);if(ke(a))a.addIn(i,t);else if(a===void 0&&this.schema)this.set(s,cr(this.schema,i,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${i}`)}}deleteIn(e){const[t,...s]=e;if(s.length===0)return this.delete(t);const i=this.get(t,!0);if(ke(i))return i.deleteIn(s);throw new Error(`Expected YAML collection at ${t}. Remaining path: ${s}`)}getIn(e,t){const[s,...i]=e,a=this.get(s,!0);return i.length===0?!t&&me(a)?a.value:a:ke(a)?a.getIn(i,t):void 0}hasAllNullValues(e){return this.items.every(t=>{if(!we(t))return!1;const s=t.value;return s==null||e&&me(s)&&s.value==null&&!s.commentBefore&&!s.comment&&!s.tag})}hasIn(e){const[t,...s]=e;if(s.length===0)return this.has(t);const i=this.get(t,!0);return ke(i)?i.hasIn(s):!1}setIn(e,t){const[s,...i]=e;if(i.length===0)this.set(s,t);else{const a=this.get(s,!0);if(ke(a))a.setIn(i,t);else if(a===void 0&&this.schema)this.set(s,cr(this.schema,i,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${i}`)}}}const dd=n=>n.replace(/^(?!$)(?: $)?/gm,"#");function lt(n,e){return/^\n+$/.test(n)?n.substring(1):e?n.replace(/^(?! *$)/gm,e):n}const qt=(n,e,t)=>n.endsWith(`
`)?lt(t,e):t.includes(`
`)?`
`+lt(t,e):(n.endsWith(" ")?"":" ")+t,Ic="flow",Ji="block",tr="quoted";function mr(n,e,t="flow",{indentAtStart:s,lineWidth:i=80,minContentWidth:a=20,onFold:c,onOverflow:f}={}){if(!i||i<0)return n;i<a&&(a=0);const p=Math.max(1+a,1+i-e.length);if(n.length<=p)return n;const m=[],L={};let b=i-e.length;typeof s=="number"&&(s>i-Math.max(2,a)?m.push(0):b=i-s);let _,C,P=!1,T=-1,D=-1,z=-1;t===Ji&&(T=wa(n,T,e.length),T!==-1&&(b=T+p));for(let X;X=n[T+=1];){if(t===tr&&X==="\\"){switch(D=T,n[T+1]){case"x":T+=3;break;case"u":T+=5;break;case"U":T+=9;break;default:T+=1}z=T}if(X===`
`)t===Ji&&(T=wa(n,T,e.length)),b=T+e.length+p,_=void 0;else{if(X===" "&&C&&C!==" "&&C!==`
`&&C!=="	"){const Q=n[T+1];Q&&Q!==" "&&Q!==`
`&&Q!=="	"&&(_=T)}if(T>=b)if(_)m.push(_),b=_+p,_=void 0;else if(t===tr){for(;C===" "||C==="	";)C=X,X=n[T+=1],P=!0;const Q=T>z+1?T-2:D-1;if(L[Q])return n;m.push(Q),L[Q]=!0,b=Q+p,_=void 0}else P=!0}C=X}if(P&&f&&f(),m.length===0)return n;c&&c();let W=n.slice(0,m[0]);for(let X=0;X<m.length;++X){const Q=m[X],ee=m[X+1]||n.length;Q===0?W=`
${e}${n.slice(0,ee)}`:(t===tr&&L[Q]&&(W+=`${n[Q]}\\`),W+=`
${e}${n.slice(Q+1,ee)}`)}return W}function wa(n,e,t){let s=e,i=e+1,a=n[i];for(;a===" "||a==="	";)if(e<i+t)a=n[++e];else{do a=n[++e];while(a&&a!==`
`);s=e,i=e+1,a=n[i]}return s}const yr=(n,e)=>({indentAtStart:e?n.indent.length:n.indentAtStart,lineWidth:n.options.lineWidth,minContentWidth:n.options.minContentWidth}),gr=n=>/^(%|---|\.\.\.)/m.test(n);function hd(n,e,t){if(!e||e<0)return!1;const s=e-t,i=n.length;if(i<=s)return!1;for(let a=0,c=0;a<i;++a)if(n[a]===`
`){if(a-c>s)return!0;if(c=a+1,i-c<=s)return!1}return!0}function Zn(n,e){const t=JSON.stringify(n);if(e.options.doubleQuotedAsJSON)return t;const{implicitKey:s}=e,i=e.options.doubleQuotedMinMultiLineLength,a=e.indent||(gr(n)?"  ":"");let c="",f=0;for(let p=0,m=t[p];m;m=t[++p])if(m===" "&&t[p+1]==="\\"&&t[p+2]==="n"&&(c+=t.slice(f,p)+"\\ ",p+=1,f=p,m="\\"),m==="\\")switch(t[p+1]){case"u":{c+=t.slice(f,p);const L=t.substr(p+2,4);switch(L){case"0000":c+="\\0";break;case"0007":c+="\\a";break;case"000b":c+="\\v";break;case"001b":c+="\\e";break;case"0085":c+="\\N";break;case"00a0":c+="\\_";break;case"2028":c+="\\L";break;case"2029":c+="\\P";break;default:L.substr(0,2)==="00"?c+="\\x"+L.substr(2):c+=t.substr(p,6)}p+=5,f=p+1}break;case"n":if(s||t[p+2]==='"'||t.length<i)p+=1;else{for(c+=t.slice(f,p)+`

`;t[p+2]==="\\"&&t[p+3]==="n"&&t[p+4]!=='"';)c+=`
`,p+=2;c+=a,t[p+2]===" "&&(c+="\\"),p+=1,f=p+1}break;default:p+=1}return c=f?c+t.slice(f):t,s?c:mr(c,a,tr,yr(e,!1))}function Gi(n,e){if(e.options.singleQuote===!1||e.implicitKey&&n.includes(`
`)||/[ \t]\n|\n[ \t]/.test(n))return Zn(n,e);const t=e.indent||(gr(n)?"  ":""),s="'"+n.replace(/'/g,"''").replace(/\n+/g,`$&
${t}`)+"'";return e.implicitKey?s:mr(s,t,Ic,yr(e,!1))}function pn(n,e){const{singleQuote:t}=e.options;let s;if(t===!1)s=Zn;else{const i=n.includes('"'),a=n.includes("'");i&&!a?s=Gi:a&&!i?s=Zn:s=t?Gi:Zn}return s(n,e)}let Wi;try{Wi=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{Wi=/\n+(?!\n|$)/g}function nr({comment:n,type:e,value:t},s,i,a){const{blockQuote:c,commentString:f,lineWidth:p}=s.options;if(!c||/\n[\t ]+$/.test(t)||/^\s*$/.test(t))return pn(t,s);const m=s.indent||(s.forceBlockIndent||gr(t)?"  ":""),L=c==="literal"?!0:c==="folded"||e===ie.BLOCK_FOLDED?!1:e===ie.BLOCK_LITERAL?!0:!hd(t,p,m.length);if(!t)return L?`|
`:`>
`;let b,_;for(_=t.length;_>0;--_){const ee=t[_-1];if(ee!==`
`&&ee!=="	"&&ee!==" ")break}let C=t.substring(_);const P=C.indexOf(`
`);P===-1?b="-":t===C||P!==C.length-1?(b="+",a&&a()):b="",C&&(t=t.slice(0,-C.length),C[C.length-1]===`
`&&(C=C.slice(0,-1)),C=C.replace(Wi,`$&${m}`));let T=!1,D,z=-1;for(D=0;D<t.length;++D){const ee=t[D];if(ee===" ")T=!0;else if(ee===`
`)z=D;else break}let W=t.substring(0,z<D?z+1:D);W&&(t=t.substring(W.length),W=W.replace(/\n+/g,`$&${m}`));let Q=(T?m?"2":"1":"")+b;if(n&&(Q+=" "+f(n.replace(/ ?[\r\n]+/g," ")),i&&i()),!L){const ee=t.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${m}`);let te=!1;const ae=yr(s,!0);c!=="folded"&&e!==ie.BLOCK_FOLDED&&(ae.onOverflow=()=>{te=!0});const G=mr(`${W}${ee}${C}`,m,Ji,ae);if(!te)return`>${Q}
${m}${G}`}return t=t.replace(/\n+/g,`$&${m}`),`|${Q}
${m}${W}${t}${C}`}function pd(n,e,t,s){const{type:i,value:a}=n,{actualString:c,implicitKey:f,indent:p,indentStep:m,inFlow:L}=e;if(f&&a.includes(`
`)||L&&/[[\]{},]/.test(a))return pn(a,e);if(/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(a))return f||L||!a.includes(`
`)?pn(a,e):nr(n,e,t,s);if(!f&&!L&&i!==ie.PLAIN&&a.includes(`
`))return nr(n,e,t,s);if(gr(a)){if(p==="")return e.forceBlockIndent=!0,nr(n,e,t,s);if(f&&p===m)return pn(a,e)}const b=a.replace(/\n+/g,`$&
${p}`);if(c){const _=T=>{var D;return T.default&&T.tag!=="tag:yaml.org,2002:str"&&((D=T.test)==null?void 0:D.test(b))},{compat:C,tags:P}=e.doc.schema;if(P.some(_)||C!=null&&C.some(_))return pn(a,e)}return f?b:mr(b,p,Ic,yr(e,!1))}function as(n,e,t,s){const{implicitKey:i,inFlow:a}=e,c=typeof n.value=="string"?n:Object.assign({},n,{value:String(n.value)});let{type:f}=n;f!==ie.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(c.value)&&(f=ie.QUOTE_DOUBLE);const p=L=>{switch(L){case ie.BLOCK_FOLDED:case ie.BLOCK_LITERAL:return i||a?pn(c.value,e):nr(c,e,t,s);case ie.QUOTE_DOUBLE:return Zn(c.value,e);case ie.QUOTE_SINGLE:return Gi(c.value,e);case ie.PLAIN:return pd(c,e,t,s);default:return null}};let m=p(f);if(m===null){const{defaultKeyType:L,defaultStringType:b}=e.options,_=i&&L||b;if(m=p(_),m===null)throw new Error(`Unsupported default string type ${_}`)}return m}function Tc(n,e){const t=Object.assign({blockQuote:!0,commentString:dd,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},n.schema.toStringOptions,e);let s;switch(t.collectionStyle){case"block":s=!1;break;case"flow":s=!0;break;default:s=null}return{anchors:new Set,doc:n,flowCollectionPadding:t.flowCollectionPadding?" ":"",indent:"",indentStep:typeof t.indent=="number"?" ".repeat(t.indent):"  ",inFlow:s,options:t}}function md(n,e){var i;if(e.tag){const a=n.filter(c=>c.tag===e.tag);if(a.length>0)return a.find(c=>c.format===e.format)??a[0]}let t,s;if(me(e)){s=e.value;let a=n.filter(c=>{var f;return(f=c.identify)==null?void 0:f.call(c,s)});if(a.length>1){const c=a.filter(f=>f.test);c.length>0&&(a=c)}t=a.find(c=>c.format===e.format)??a.find(c=>!c.format)}else s=e,t=n.find(a=>a.nodeClass&&s instanceof a.nodeClass);if(!t){const a=((i=s==null?void 0:s.constructor)==null?void 0:i.name)??(s===null?"null":typeof s);throw new Error(`Tag not resolved for ${a} value`)}return t}function yd(n,e,{anchors:t,doc:s}){if(!s.directives)return"";const i=[],a=(me(n)||ke(n))&&n.anchor;a&&wc(a)&&(t.add(a),i.push(`&${a}`));const c=n.tag??(e.default?null:e.tag);return c&&i.push(s.directives.tagString(c)),i.join(" ")}function Sn(n,e,t,s){var p;if(we(n))return n.toString(e,t,s);if(Tt(n)){if(e.doc.directives)return n.toString(e);if((p=e.resolvedAliases)!=null&&p.has(n))throw new TypeError("Cannot stringify circular structure without alias nodes");e.resolvedAliases?e.resolvedAliases.add(n):e.resolvedAliases=new Set([n]),n=n.resolve(e.doc)}let i;const a=Se(n)?n:e.doc.createNode(n,{onTagObj:m=>i=m});i??(i=md(e.doc.schema.tags,a));const c=yd(a,i,e);c.length>0&&(e.indentAtStart=(e.indentAtStart??0)+c.length+1);const f=typeof i.stringify=="function"?i.stringify(a,e,t,s):me(a)?as(a,e,t,s):a.toString(e,t,s);return c?me(a)||f[0]==="{"||f[0]==="["?`${c} ${f}`:`${c}
${e.indent}${f}`:f}function gd({key:n,value:e},t,s,i){const{allNullValues:a,doc:c,indent:f,indentStep:p,options:{commentString:m,indentSeq:L,simpleKeys:b}}=t;let _=Se(n)&&n.comment||null;if(b){if(_)throw new Error("With simple keys, key nodes cannot have comments");if(ke(n)||!Se(n)&&typeof n=="object"){const ae="With simple keys, collection cannot be used as a key value";throw new Error(ae)}}let C=!b&&(!n||_&&e==null&&!t.inFlow||ke(n)||(me(n)?n.type===ie.BLOCK_FOLDED||n.type===ie.BLOCK_LITERAL:typeof n=="object"));t=Object.assign({},t,{allNullValues:!1,implicitKey:!C&&(b||!a),indent:f+p});let P=!1,T=!1,D=Sn(n,t,()=>P=!0,()=>T=!0);if(!C&&!t.inFlow&&D.length>1024){if(b)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");C=!0}if(t.inFlow){if(a||e==null)return P&&s&&s(),D===""?"?":C?`? ${D}`:D}else if(a&&!b||e==null&&C)return D=`? ${D}`,_&&!P?D+=qt(D,t.indent,m(_)):T&&i&&i(),D;P&&(_=null),C?(_&&(D+=qt(D,t.indent,m(_))),D=`? ${D}
${f}:`):(D=`${D}:`,_&&(D+=qt(D,t.indent,m(_))));let z,W,X;Se(e)?(z=!!e.spaceBefore,W=e.commentBefore,X=e.comment):(z=!1,W=null,X=null,e&&typeof e=="object"&&(e=c.createNode(e))),t.implicitKey=!1,!C&&!_&&me(e)&&(t.indentAtStart=D.length+1),T=!1,!L&&p.length>=2&&!t.inFlow&&!C&&An(e)&&!e.flow&&!e.tag&&!e.anchor&&(t.indent=t.indent.substring(2));let Q=!1;const ee=Sn(e,t,()=>Q=!0,()=>T=!0);let te=" ";if(_||z||W){if(te=z?`
`:"",W){const ae=m(W);te+=`
${lt(ae,t.indent)}`}ee===""&&!t.inFlow?te===`
`&&(te=`

`):te+=`
${t.indent}`}else if(!C&&ke(e)){const ae=ee[0],G=ee.indexOf(`
`),ye=G!==-1,ze=t.inFlow??e.flow??e.items.length===0;if(ye||!ze){let nt=!1;if(ye&&(ae==="&"||ae==="!")){let ge=ee.indexOf(" ");ae==="&"&&ge!==-1&&ge<G&&ee[ge+1]==="!"&&(ge=ee.indexOf(" ",ge+1)),(ge===-1||G<ge)&&(nt=!0)}nt||(te=`
${t.indent}`)}}else(ee===""||ee[0]===`
`)&&(te="");return D+=te+ee,t.inFlow?Q&&s&&s():X&&!Q?D+=qt(D,t.indent,m(X)):T&&i&&i(),D}function Ac(n,e){(n==="debug"||n==="warn")&&console.warn(e)}const qs="<<",ut={identify:n=>n===qs||typeof n=="symbol"&&n.description===qs,default:"key",tag:"tag:yaml.org,2002:merge",test:/^<<$/,resolve:()=>Object.assign(new ie(Symbol(qs)),{addToJSMap:Lc}),stringify:()=>qs},vd=(n,e)=>(ut.identify(e)||me(e)&&(!e.type||e.type===ie.PLAIN)&&ut.identify(e.value))&&(n==null?void 0:n.doc.schema.tags.some(t=>t.tag===ut.tag&&t.default));function Lc(n,e,t){if(t=n&&Tt(t)?t.resolve(n.doc):t,An(t))for(const s of t.items)vi(n,e,s);else if(Array.isArray(t))for(const s of t)vi(n,e,s);else vi(n,e,t)}function vi(n,e,t){const s=n&&Tt(t)?t.resolve(n.doc):t;if(!Tn(s))throw new Error("Merge sources must be maps or map aliases");const i=s.toJSON(null,n,Map);for(const[a,c]of i)e instanceof Map?e.has(a)||e.set(a,c):e instanceof Set?e.add(a):Object.prototype.hasOwnProperty.call(e,a)||Object.defineProperty(e,a,{value:c,writable:!0,enumerable:!0,configurable:!0});return e}function Cc(n,e,{key:t,value:s}){if(Se(t)&&t.addToJSMap)t.addToJSMap(n,e,s);else if(vd(n,t))Lc(n,e,s);else{const i=Ue(t,"",n);if(e instanceof Map)e.set(i,Ue(s,i,n));else if(e instanceof Set)e.add(i);else{const a=bd(t,i,n),c=Ue(s,a,n);a in e?Object.defineProperty(e,a,{value:c,writable:!0,enumerable:!0,configurable:!0}):e[a]=c}}return e}function bd(n,e,t){if(e===null)return"";if(typeof e!="object")return String(e);if(Se(n)&&(t!=null&&t.doc)){const s=Tc(t.doc,{});s.anchors=new Set;for(const a of t.anchors.keys())s.anchors.add(a.anchor);s.inFlow=!0,s.inStringifyKey=!0;const i=n.toString(s);if(!t.mapKeyWarned){let a=JSON.stringify(i);a.length>40&&(a=a.substring(0,36)+'..."'),Ac(t.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${a}. Set mapAsMap: true to use object keys.`),t.mapKeyWarned=!0}return i}return JSON.stringify(e)}function io(n,e,t){const s=ss(n,void 0,t),i=ss(e,void 0,t);return new Pe(s,i)}class Pe{constructor(e,t=null){Object.defineProperty(this,He,{value:pc}),this.key=e,this.value=t}clone(e){let{key:t,value:s}=this;return Se(t)&&(t=t.clone(e)),Se(s)&&(s=s.clone(e)),new Pe(t,s)}toJSON(e,t){const s=t!=null&&t.mapAsMap?new Map:{};return Cc(t,s,this)}toString(e,t,s){return e!=null&&e.doc?gd(this,e,t,s):JSON.stringify(this)}}function Oc(n,e,t){return(e.inFlow??n.flow?kd:wd)(n,e,t)}function wd({comment:n,items:e},t,{blockItemPrefix:s,flowChars:i,itemIndent:a,onChompKeep:c,onComment:f}){const{indent:p,options:{commentString:m}}=t,L=Object.assign({},t,{indent:a,type:null});let b=!1;const _=[];for(let P=0;P<e.length;++P){const T=e[P];let D=null;if(Se(T))!b&&T.spaceBefore&&_.push(""),lr(t,_,T.commentBefore,b),T.comment&&(D=T.comment);else if(we(T)){const W=Se(T.key)?T.key:null;W&&(!b&&W.spaceBefore&&_.push(""),lr(t,_,W.commentBefore,b))}b=!1;let z=Sn(T,L,()=>D=null,()=>b=!0);D&&(z+=qt(z,a,m(D))),b&&D&&(b=!1),_.push(s+z)}let C;if(_.length===0)C=i.start+i.end;else{C=_[0];for(let P=1;P<_.length;++P){const T=_[P];C+=T?`
${p}${T}`:`
`}}return n?(C+=`
`+lt(m(n),p),f&&f()):b&&c&&c(),C}function kd({items:n},e,{flowChars:t,itemIndent:s}){const{indent:i,indentStep:a,flowCollectionPadding:c,options:{commentString:f}}=e;s+=a;const p=Object.assign({},e,{indent:s,inFlow:!0,type:null});let m=!1,L=0;const b=[];for(let P=0;P<n.length;++P){const T=n[P];let D=null;if(Se(T))T.spaceBefore&&b.push(""),lr(e,b,T.commentBefore,!1),T.comment&&(D=T.comment);else if(we(T)){const W=Se(T.key)?T.key:null;W&&(W.spaceBefore&&b.push(""),lr(e,b,W.commentBefore,!1),W.comment&&(m=!0));const X=Se(T.value)?T.value:null;X?(X.comment&&(D=X.comment),X.commentBefore&&(m=!0)):T.value==null&&(W!=null&&W.comment)&&(D=W.comment)}D&&(m=!0);let z=Sn(T,p,()=>D=null);P<n.length-1&&(z+=","),D&&(z+=qt(z,s,f(D))),!m&&(b.length>L||z.includes(`
`))&&(m=!0),b.push(z),L=b.length}const{start:_,end:C}=t;if(b.length===0)return _+C;if(!m){const P=b.reduce((T,D)=>T+D.length+2,2);m=e.options.lineWidth>0&&P>e.options.lineWidth}if(m){let P=_;for(const T of b)P+=T?`
${a}${i}${T}`:`
`;return`${P}
${i}${C}`}else return`${_}${c}${b.join(" ")}${c}${C}`}function lr({indent:n,options:{commentString:e}},t,s,i){if(s&&i&&(s=s.replace(/^\n+/,"")),s){const a=lt(e(s),n);t.push(a.trimStart())}}function Ft(n,e){const t=me(e)?e.value:e;for(const s of n)if(we(s)&&(s.key===e||s.key===t||me(s.key)&&s.key.value===t))return s}class qe extends _c{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(Et,e),this.items=[]}static from(e,t,s){const{keepUndefined:i,replacer:a}=s,c=new this(e),f=(p,m)=>{if(typeof a=="function")m=a.call(t,p,m);else if(Array.isArray(a)&&!a.includes(p))return;(m!==void 0||i)&&c.items.push(io(p,m,s))};if(t instanceof Map)for(const[p,m]of t)f(p,m);else if(t&&typeof t=="object")for(const p of Object.keys(t))f(p,t[p]);return typeof e.sortMapEntries=="function"&&c.items.sort(e.sortMapEntries),c}add(e,t){var c;let s;we(e)?s=e:!e||typeof e!="object"||!("key"in e)?s=new Pe(e,e==null?void 0:e.value):s=new Pe(e.key,e.value);const i=Ft(this.items,s.key),a=(c=this.schema)==null?void 0:c.sortMapEntries;if(i){if(!t)throw new Error(`Key ${s.key} already set`);me(i.value)&&Ec(s.value)?i.value.value=s.value:i.value=s.value}else if(a){const f=this.items.findIndex(p=>a(s,p)<0);f===-1?this.items.push(s):this.items.splice(f,0,s)}else this.items.push(s)}delete(e){const t=Ft(this.items,e);return t?this.items.splice(this.items.indexOf(t),1).length>0:!1}get(e,t){const s=Ft(this.items,e),i=s==null?void 0:s.value;return(!t&&me(i)?i.value:i)??void 0}has(e){return!!Ft(this.items,e)}set(e,t){this.add(new Pe(e,t),!0)}toJSON(e,t,s){const i=s?new s:t!=null&&t.mapAsMap?new Map:{};t!=null&&t.onCreate&&t.onCreate(i);for(const a of this.items)Cc(t,i,a);return i}toString(e,t,s){if(!e)return JSON.stringify(this);for(const i of this.items)if(!we(i))throw new Error(`Map items must all be pairs; found ${JSON.stringify(i)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),Oc(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:s,onComment:t})}}const Ln={collection:"map",default:!0,nodeClass:qe,tag:"tag:yaml.org,2002:map",resolve(n,e){return Tn(n)||e("Expected a mapping for this tag"),n},createNode:(n,e,t)=>qe.from(n,e,t)};class _t extends _c{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(In,e),this.items=[]}add(e){this.items.push(e)}delete(e){const t=Fs(e);return typeof t!="number"?!1:this.items.splice(t,1).length>0}get(e,t){const s=Fs(e);if(typeof s!="number")return;const i=this.items[s];return!t&&me(i)?i.value:i}has(e){const t=Fs(e);return typeof t=="number"&&t<this.items.length}set(e,t){const s=Fs(e);if(typeof s!="number")throw new Error(`Expected a valid index, not ${e}.`);const i=this.items[s];me(i)&&Ec(t)?i.value=t:this.items[s]=t}toJSON(e,t){const s=[];t!=null&&t.onCreate&&t.onCreate(s);let i=0;for(const a of this.items)s.push(Ue(a,String(i++),t));return s}toString(e,t,s){return e?Oc(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:s,onComment:t}):JSON.stringify(this)}static from(e,t,s){const{replacer:i}=s,a=new this(e);if(t&&Symbol.iterator in Object(t)){let c=0;for(let f of t){if(typeof i=="function"){const p=t instanceof Set?f:String(c++);f=i.call(t,p,f)}a.items.push(ss(f,void 0,s))}}return a}}function Fs(n){let e=me(n)?n.value:n;return e&&typeof e=="string"&&(e=Number(e)),typeof e=="number"&&Number.isInteger(e)&&e>=0?e:null}const Cn={collection:"seq",default:!0,nodeClass:_t,tag:"tag:yaml.org,2002:seq",resolve(n,e){return An(n)||e("Expected a sequence for this tag"),n},createNode:(n,e,t)=>_t.from(n,e,t)},vr={identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify(n,e,t,s){return e=Object.assign({actualString:!0},e),as(n,e,t,s)}},br={identify:n=>n==null,createNode:()=>new ie(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new ie(null),stringify:({source:n},e)=>typeof n=="string"&&br.test.test(n)?n:e.options.nullStr},oo={identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:n=>new ie(n[0]==="t"||n[0]==="T"),stringify({source:n,value:e},t){if(n&&oo.test.test(n)){const s=n[0]==="t"||n[0]==="T";if(e===s)return n}return e?t.options.trueStr:t.options.falseStr}};function Je({format:n,minFractionDigits:e,tag:t,value:s}){if(typeof s=="bigint")return String(s);const i=typeof s=="number"?s:Number(s);if(!isFinite(i))return isNaN(i)?".nan":i<0?"-.inf":".inf";let a=JSON.stringify(s);if(!n&&e&&(!t||t==="tag:yaml.org,2002:float")&&/^\d/.test(a)){let c=a.indexOf(".");c<0&&(c=a.length,a+=".");let f=e-(a.length-c-1);for(;f-- >0;)a+="0"}return a}const Nc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Je},$c={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Je(n)}},Pc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(n){const e=new ie(parseFloat(n)),t=n.indexOf(".");return t!==-1&&n[n.length-1]==="0"&&(e.minFractionDigits=n.length-t-1),e},stringify:Je},wr=n=>typeof n=="bigint"||Number.isInteger(n),ao=(n,e,t,{intAsBigInt:s})=>s?BigInt(n):parseInt(n.substring(e),t);function xc(n,e,t){const{value:s}=n;return wr(s)&&s>=0?t+s.toString(e):Je(n)}const Mc={identify:n=>wr(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(n,e,t)=>ao(n,2,8,t),stringify:n=>xc(n,8,"0o")},Dc={identify:wr,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(n,e,t)=>ao(n,0,10,t),stringify:Je},Bc={identify:n=>wr(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(n,e,t)=>ao(n,2,16,t),stringify:n=>xc(n,16,"0x")},Sd=[Ln,Cn,vr,br,oo,Mc,Dc,Bc,Nc,$c,Pc];function ka(n){return typeof n=="bigint"||Number.isInteger(n)}const Us=({value:n})=>JSON.stringify(n),Ed=[{identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify:Us},{identify:n=>n==null,createNode:()=>new ie(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:Us},{identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true$|^false$/,resolve:n=>n==="true",stringify:Us},{identify:ka,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(n,e,{intAsBigInt:t})=>t?BigInt(n):parseInt(n,10),stringify:({value:n})=>ka(n)?n.toString():JSON.stringify(n)},{identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:n=>parseFloat(n),stringify:Us}],_d={default:!0,tag:"",test:/^/,resolve(n,e){return e(`Unresolved plain scalar ${JSON.stringify(n)}`),n}},Id=[Ln,Cn].concat(Ed,_d),co={identify:n=>n instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(n,e){if(typeof atob=="function"){const t=atob(n.replace(/[\n\r]/g,"")),s=new Uint8Array(t.length);for(let i=0;i<t.length;++i)s[i]=t.charCodeAt(i);return s}else return e("This environment does not support reading binary tags; either Buffer or atob is required"),n},stringify({comment:n,type:e,value:t},s,i,a){if(!t)return"";const c=t;let f;if(typeof btoa=="function"){let p="";for(let m=0;m<c.length;++m)p+=String.fromCharCode(c[m]);f=btoa(p)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(e??(e=ie.BLOCK_LITERAL),e!==ie.QUOTE_DOUBLE){const p=Math.max(s.options.lineWidth-s.indent.length,s.options.minContentWidth),m=Math.ceil(f.length/p),L=new Array(m);for(let b=0,_=0;b<m;++b,_+=p)L[b]=f.substr(_,p);f=L.join(e===ie.BLOCK_LITERAL?`
`:" ")}return as({comment:n,type:e,value:f},s,i,a)}};function jc(n,e){if(An(n))for(let t=0;t<n.items.length;++t){let s=n.items[t];if(!we(s)){if(Tn(s)){s.items.length>1&&e("Each pair must have its own sequence indicator");const i=s.items[0]||new Pe(new ie(null));if(s.commentBefore&&(i.key.commentBefore=i.key.commentBefore?`${s.commentBefore}
${i.key.commentBefore}`:s.commentBefore),s.comment){const a=i.value??i.key;a.comment=a.comment?`${s.comment}
${a.comment}`:s.comment}s=i}n.items[t]=we(s)?s:new Pe(s)}}else e("Expected a sequence for this tag");return n}function Kc(n,e,t){const{replacer:s}=t,i=new _t(n);i.tag="tag:yaml.org,2002:pairs";let a=0;if(e&&Symbol.iterator in Object(e))for(let c of e){typeof s=="function"&&(c=s.call(e,String(a++),c));let f,p;if(Array.isArray(c))if(c.length===2)f=c[0],p=c[1];else throw new TypeError(`Expected [key, value] tuple: ${c}`);else if(c&&c instanceof Object){const m=Object.keys(c);if(m.length===1)f=m[0],p=c[f];else throw new TypeError(`Expected tuple with one key, not ${m.length} keys`)}else f=c;i.items.push(io(f,p,t))}return i}const lo={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:jc,createNode:Kc};class gn extends _t{constructor(){super(),this.add=qe.prototype.add.bind(this),this.delete=qe.prototype.delete.bind(this),this.get=qe.prototype.get.bind(this),this.has=qe.prototype.has.bind(this),this.set=qe.prototype.set.bind(this),this.tag=gn.tag}toJSON(e,t){if(!t)return super.toJSON(e);const s=new Map;t!=null&&t.onCreate&&t.onCreate(s);for(const i of this.items){let a,c;if(we(i)?(a=Ue(i.key,"",t),c=Ue(i.value,a,t)):a=Ue(i,"",t),s.has(a))throw new Error("Ordered maps must not include duplicate keys");s.set(a,c)}return s}static from(e,t,s){const i=Kc(e,t,s),a=new this;return a.items=i.items,a}}gn.tag="tag:yaml.org,2002:omap";const uo={collection:"seq",identify:n=>n instanceof Map,nodeClass:gn,default:!1,tag:"tag:yaml.org,2002:omap",resolve(n,e){const t=jc(n,e),s=[];for(const{key:i}of t.items)me(i)&&(s.includes(i.value)?e(`Ordered maps must not include duplicate keys: ${i.value}`):s.push(i.value));return Object.assign(new gn,t)},createNode:(n,e,t)=>gn.from(n,e,t)};function Rc({value:n,source:e},t){return e&&(n?qc:Fc).test.test(e)?e:n?t.options.trueStr:t.options.falseStr}const qc={identify:n=>n===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new ie(!0),stringify:Rc},Fc={identify:n=>n===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/,resolve:()=>new ie(!1),stringify:Rc},Td={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Je},Ad={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n.replace(/_/g,"")),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Je(n)}},Ld={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(n){const e=new ie(parseFloat(n.replace(/_/g,""))),t=n.indexOf(".");if(t!==-1){const s=n.substring(t+1).replace(/_/g,"");s[s.length-1]==="0"&&(e.minFractionDigits=s.length)}return e},stringify:Je},cs=n=>typeof n=="bigint"||Number.isInteger(n);function kr(n,e,t,{intAsBigInt:s}){const i=n[0];if((i==="-"||i==="+")&&(e+=1),n=n.substring(e).replace(/_/g,""),s){switch(t){case 2:n=`0b${n}`;break;case 8:n=`0o${n}`;break;case 16:n=`0x${n}`;break}const c=BigInt(n);return i==="-"?BigInt(-1)*c:c}const a=parseInt(n,t);return i==="-"?-1*a:a}function fo(n,e,t){const{value:s}=n;if(cs(s)){const i=s.toString(e);return s<0?"-"+t+i.substr(1):t+i}return Je(n)}const Cd={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(n,e,t)=>kr(n,2,2,t),stringify:n=>fo(n,2,"0b")},Od={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(n,e,t)=>kr(n,1,8,t),stringify:n=>fo(n,8,"0")},Nd={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(n,e,t)=>kr(n,0,10,t),stringify:Je},$d={identify:cs,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(n,e,t)=>kr(n,2,16,t),stringify:n=>fo(n,16,"0x")};class vn extends qe{constructor(e){super(e),this.tag=vn.tag}add(e){let t;we(e)?t=e:e&&typeof e=="object"&&"key"in e&&"value"in e&&e.value===null?t=new Pe(e.key,null):t=new Pe(e,null),Ft(this.items,t.key)||this.items.push(t)}get(e,t){const s=Ft(this.items,e);return!t&&we(s)?me(s.key)?s.key.value:s.key:s}set(e,t){if(typeof t!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof t}`);const s=Ft(this.items,e);s&&!t?this.items.splice(this.items.indexOf(s),1):!s&&t&&this.items.push(new Pe(e))}toJSON(e,t){return super.toJSON(e,t,Set)}toString(e,t,s){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),t,s);throw new Error("Set items must all have null values")}static from(e,t,s){const{replacer:i}=s,a=new this(e);if(t&&Symbol.iterator in Object(t))for(let c of t)typeof i=="function"&&(c=i.call(t,c,c)),a.items.push(io(c,null,s));return a}}vn.tag="tag:yaml.org,2002:set";const ho={collection:"map",identify:n=>n instanceof Set,nodeClass:vn,default:!1,tag:"tag:yaml.org,2002:set",createNode:(n,e,t)=>vn.from(n,e,t),resolve(n,e){if(Tn(n)){if(n.hasAllNullValues(!0))return Object.assign(new vn,n);e("Set items must all have null values")}else e("Expected a mapping for this tag");return n}};function po(n,e){const t=n[0],s=t==="-"||t==="+"?n.substring(1):n,i=c=>e?BigInt(c):Number(c),a=s.replace(/_/g,"").split(":").reduce((c,f)=>c*i(60)+i(f),i(0));return t==="-"?i(-1)*a:a}function Uc(n){let{value:e}=n,t=c=>c;if(typeof e=="bigint")t=c=>BigInt(c);else if(isNaN(e)||!isFinite(e))return Je(n);let s="";e<0&&(s="-",e*=t(-1));const i=t(60),a=[e%i];return e<60?a.unshift(0):(e=(e-a[0])/i,a.unshift(e%i),e>=60&&(e=(e-a[0])/i,a.unshift(e))),s+a.map(c=>String(c).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const Hc={identify:n=>typeof n=="bigint"||Number.isInteger(n),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(n,e,{intAsBigInt:t})=>po(n,t),stringify:Uc},zc={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:n=>po(n,!1),stringify:Uc},Sr={identify:n=>n instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(n){const e=n.match(Sr.test);if(!e)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,t,s,i,a,c,f]=e.map(Number),p=e[7]?Number((e[7]+"00").substr(1,3)):0;let m=Date.UTC(t,s-1,i,a||0,c||0,f||0,p);const L=e[8];if(L&&L!=="Z"){let b=po(L,!1);Math.abs(b)<30&&(b*=60),m-=6e4*b}return new Date(m)},stringify:({value:n})=>(n==null?void 0:n.toISOString().replace(/(T00:00:00)?\.000Z$/,""))??""},Sa=[Ln,Cn,vr,br,qc,Fc,Cd,Od,Nd,$d,Td,Ad,Ld,co,ut,uo,lo,ho,Hc,zc,Sr],Ea=new Map([["core",Sd],["failsafe",[Ln,Cn,vr]],["json",Id],["yaml11",Sa],["yaml-1.1",Sa]]),_a={binary:co,bool:oo,float:Pc,floatExp:$c,floatNaN:Nc,floatTime:zc,int:Dc,intHex:Bc,intOct:Mc,intTime:Hc,map:Ln,merge:ut,null:br,omap:uo,pairs:lo,seq:Cn,set:ho,timestamp:Sr},Pd={"tag:yaml.org,2002:binary":co,"tag:yaml.org,2002:merge":ut,"tag:yaml.org,2002:omap":uo,"tag:yaml.org,2002:pairs":lo,"tag:yaml.org,2002:set":ho,"tag:yaml.org,2002:timestamp":Sr};function bi(n,e,t){const s=Ea.get(e);if(s&&!n)return t&&!s.includes(ut)?s.concat(ut):s.slice();let i=s;if(!i)if(Array.isArray(n))i=[];else{const a=Array.from(Ea.keys()).filter(c=>c!=="yaml11").map(c=>JSON.stringify(c)).join(", ");throw new Error(`Unknown schema "${e}"; use one of ${a} or define customTags array`)}if(Array.isArray(n))for(const a of n)i=i.concat(a);else typeof n=="function"&&(i=n(i.slice()));return t&&(i=i.concat(ut)),i.reduce((a,c)=>{const f=typeof c=="string"?_a[c]:c;if(!f){const p=JSON.stringify(c),m=Object.keys(_a).map(L=>JSON.stringify(L)).join(", ");throw new Error(`Unknown custom tag ${p}; use one of ${m}`)}return a.includes(f)||a.push(f),a},[])}const xd=(n,e)=>n.key<e.key?-1:n.key>e.key?1:0;class Er{constructor({compat:e,customTags:t,merge:s,resolveKnownTags:i,schema:a,sortMapEntries:c,toStringDefaults:f}){this.compat=Array.isArray(e)?bi(e,"compat"):e?bi(null,e):null,this.name=typeof a=="string"&&a||"core",this.knownTags=i?Pd:{},this.tags=bi(t,this.name,s),this.toStringOptions=f??null,Object.defineProperty(this,Et,{value:Ln}),Object.defineProperty(this,tt,{value:vr}),Object.defineProperty(this,In,{value:Cn}),this.sortMapEntries=typeof c=="function"?c:c===!0?xd:null}clone(){const e=Object.create(Er.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}}function Md(n,e){var p;const t=[];let s=e.directives===!0;if(e.directives!==!1&&n.directives){const m=n.directives.toString(n);m?(t.push(m),s=!0):n.directives.docStart&&(s=!0)}s&&t.push("---");const i=Tc(n,e),{commentString:a}=i.options;if(n.commentBefore){t.length!==1&&t.unshift("");const m=a(n.commentBefore);t.unshift(lt(m,""))}let c=!1,f=null;if(n.contents){if(Se(n.contents)){if(n.contents.spaceBefore&&s&&t.push(""),n.contents.commentBefore){const b=a(n.contents.commentBefore);t.push(lt(b,""))}i.forceBlockIndent=!!n.comment,f=n.contents.comment}const m=f?void 0:()=>c=!0;let L=Sn(n.contents,i,()=>f=null,m);f&&(L+=qt(L,"",a(f))),(L[0]==="|"||L[0]===">")&&t[t.length-1]==="---"?t[t.length-1]=`--- ${L}`:t.push(L)}else t.push(Sn(n.contents,i));if((p=n.directives)!=null&&p.docEnd)if(n.comment){const m=a(n.comment);m.includes(`
`)?(t.push("..."),t.push(lt(m,""))):t.push(`... ${m}`)}else t.push("...");else{let m=n.comment;m&&c&&(m=m.replace(/^\n+/,"")),m&&((!c||f)&&t[t.length-1]!==""&&t.push(""),t.push(lt(a(m),"")))}return t.join(`
`)+`
`}class On{constructor(e,t,s){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,He,{value:Yi});let i=null;typeof t=="function"||Array.isArray(t)?i=t:s===void 0&&t&&(s=t,t=void 0);const a=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,stringKeys:!1,uniqueKeys:!0,version:"1.2"},s);this.options=a;let{version:c}=a;s!=null&&s._directives?(this.directives=s._directives.atDocument(),this.directives.yaml.explicit&&(c=this.directives.yaml.version)):this.directives=new Me({version:c}),this.setSchema(c,s),this.contents=e===void 0?null:this.createNode(e,i,s)}clone(){const e=Object.create(On.prototype,{[He]:{value:Yi}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=Se(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){cn(this.contents)&&this.contents.add(e)}addIn(e,t){cn(this.contents)&&this.contents.addIn(e,t)}createAlias(e,t){if(!e.anchor){const s=kc(this);e.anchor=!t||s.has(t)?Sc(t||"a",s):t}return new pr(e.anchor)}createNode(e,t,s){let i;if(typeof t=="function")e=t.call({"":e},"",e),i=t;else if(Array.isArray(t)){const D=W=>typeof W=="number"||W instanceof String||W instanceof Number,z=t.filter(D).map(String);z.length>0&&(t=t.concat(z)),i=t}else s===void 0&&t&&(s=t,t=void 0);const{aliasDuplicateObjects:a,anchorPrefix:c,flow:f,keepUndefined:p,onTagObj:m,tag:L}=s??{},{onAnchor:b,setAnchors:_,sourceObjects:C}=ld(this,c||"a"),P={aliasDuplicateObjects:a??!0,keepUndefined:p??!1,onAnchor:b,onTagObj:m,replacer:i,schema:this.schema,sourceObjects:C},T=ss(e,L,P);return f&&ke(T)&&(T.flow=!0),_(),T}createPair(e,t,s={}){const i=this.createNode(e,null,s),a=this.createNode(t,null,s);return new Pe(i,a)}delete(e){return cn(this.contents)?this.contents.delete(e):!1}deleteIn(e){return Wn(e)?this.contents==null?!1:(this.contents=null,!0):cn(this.contents)?this.contents.deleteIn(e):!1}get(e,t){return ke(this.contents)?this.contents.get(e,t):void 0}getIn(e,t){return Wn(e)?!t&&me(this.contents)?this.contents.value:this.contents:ke(this.contents)?this.contents.getIn(e,t):void 0}has(e){return ke(this.contents)?this.contents.has(e):!1}hasIn(e){return Wn(e)?this.contents!==void 0:ke(this.contents)?this.contents.hasIn(e):!1}set(e,t){this.contents==null?this.contents=cr(this.schema,[e],t):cn(this.contents)&&this.contents.set(e,t)}setIn(e,t){Wn(e)?this.contents=t:this.contents==null?this.contents=cr(this.schema,Array.from(e),t):cn(this.contents)&&this.contents.setIn(e,t)}setSchema(e,t={}){typeof e=="number"&&(e=String(e));let s;switch(e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Me({version:"1.1"}),s={resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Me({version:e}),s={resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,s=null;break;default:{const i=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${i}`)}}if(t.schema instanceof Object)this.schema=t.schema;else if(s)this.schema=new Er(Object.assign(s,t));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:e,jsonArg:t,mapAsMap:s,maxAliasCount:i,onAnchor:a,reviver:c}={}){const f={anchors:new Map,doc:this,keep:!e,mapAsMap:s===!0,mapKeyWarned:!1,maxAliasCount:typeof i=="number"?i:100},p=Ue(this.contents,t??"",f);if(typeof a=="function")for(const{count:m,res:L}of f.anchors.values())a(L,m);return typeof c=="function"?hn(c,{"":p},"",p):p}toJSON(e,t){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:t})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){const t=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${t}`)}return Md(this,e)}}function cn(n){if(ke(n))return!0;throw new Error("Expected a YAML collection as document contents")}class mo extends Error{constructor(e,t,s,i){super(),this.name=e,this.code=s,this.message=i,this.pos=t}}class Ut extends mo{constructor(e,t,s){super("YAMLParseError",e,t,s)}}class Vc extends mo{constructor(e,t,s){super("YAMLWarning",e,t,s)}}const ur=(n,e)=>t=>{if(t.pos[0]===-1)return;t.linePos=t.pos.map(f=>e.linePos(f));const{line:s,col:i}=t.linePos[0];t.message+=` at line ${s}, column ${i}`;let a=i-1,c=n.substring(e.lineStarts[s-1],e.lineStarts[s]).replace(/[\n\r]+$/,"");if(a>=60&&c.length>80){const f=Math.min(a-39,c.length-79);c="…"+c.substring(f),a-=f-1}if(c.length>80&&(c=c.substring(0,79)+"…"),s>1&&/^ *$/.test(c.substring(0,a))){let f=n.substring(e.lineStarts[s-2],e.lineStarts[s-1]);f.length>80&&(f=f.substring(0,79)+`…
`),c=f+c}if(/[^ ]/.test(c)){let f=1;const p=t.linePos[1];p&&p.line===s&&p.col>i&&(f=Math.max(1,Math.min(p.col-i,80-a)));const m=" ".repeat(a)+"^".repeat(f);t.message+=`:

${c}
${m}
`}};function En(n,{flow:e,indicator:t,next:s,offset:i,onError:a,parentIndent:c,startOnNewline:f}){let p=!1,m=f,L=f,b="",_="",C=!1,P=!1,T=null,D=null,z=null,W=null,X=null,Q=null,ee=null;for(const G of n)switch(P&&(G.type!=="space"&&G.type!=="newline"&&G.type!=="comma"&&a(G.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),P=!1),T&&(m&&G.type!=="comment"&&G.type!=="newline"&&a(T,"TAB_AS_INDENT","Tabs are not allowed as indentation"),T=null),G.type){case"space":!e&&(t!=="doc-start"||(s==null?void 0:s.type)!=="flow-collection")&&G.source.includes("	")&&(T=G),L=!0;break;case"comment":{L||a(G,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const ye=G.source.substring(1)||" ";b?b+=_+ye:b=ye,_="",m=!1;break}case"newline":m?b?b+=G.source:(!Q||t!=="seq-item-ind")&&(p=!0):_+=G.source,m=!0,C=!0,(D||z)&&(W=G),L=!0;break;case"anchor":D&&a(G,"MULTIPLE_ANCHORS","A node can have at most one anchor"),G.source.endsWith(":")&&a(G.offset+G.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),D=G,ee??(ee=G.offset),m=!1,L=!1,P=!0;break;case"tag":{z&&a(G,"MULTIPLE_TAGS","A node can have at most one tag"),z=G,ee??(ee=G.offset),m=!1,L=!1,P=!0;break}case t:(D||z)&&a(G,"BAD_PROP_ORDER",`Anchors and tags must be after the ${G.source} indicator`),Q&&a(G,"UNEXPECTED_TOKEN",`Unexpected ${G.source} in ${e??"collection"}`),Q=G,m=t==="seq-item-ind"||t==="explicit-key-ind",L=!1;break;case"comma":if(e){X&&a(G,"UNEXPECTED_TOKEN",`Unexpected , in ${e}`),X=G,m=!1,L=!1;break}default:a(G,"UNEXPECTED_TOKEN",`Unexpected ${G.type} token`),m=!1,L=!1}const te=n[n.length-1],ae=te?te.offset+te.source.length:i;return P&&s&&s.type!=="space"&&s.type!=="newline"&&s.type!=="comma"&&(s.type!=="scalar"||s.source!=="")&&a(s.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),T&&(m&&T.indent<=c||(s==null?void 0:s.type)==="block-map"||(s==null?void 0:s.type)==="block-seq")&&a(T,"TAB_AS_INDENT","Tabs are not allowed as indentation"),{comma:X,found:Q,spaceBefore:p,comment:b,hasNewline:C,anchor:D,tag:z,newlineAfterProp:W,end:ae,start:ee??ae}}function rs(n){if(!n)return null;switch(n.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(n.source.includes(`
`))return!0;if(n.end){for(const e of n.end)if(e.type==="newline")return!0}return!1;case"flow-collection":for(const e of n.items){for(const t of e.start)if(t.type==="newline")return!0;if(e.sep){for(const t of e.sep)if(t.type==="newline")return!0}if(rs(e.key)||rs(e.value))return!0}return!1;default:return!0}}function Qi(n,e,t){if((e==null?void 0:e.type)==="flow-collection"){const s=e.end[0];s.indent===n&&(s.source==="]"||s.source==="}")&&rs(e)&&t(s,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}function Yc(n,e,t){const{uniqueKeys:s}=n.options;if(s===!1)return!1;const i=typeof s=="function"?s:(a,c)=>a===c||me(a)&&me(c)&&a.value===c.value;return e.some(a=>i(a.key,t))}const Ia="All mapping items must start at the same column";function Dd({composeNode:n,composeEmptyNode:e},t,s,i,a){var L;const c=(a==null?void 0:a.nodeClass)??qe,f=new c(t.schema);t.atRoot&&(t.atRoot=!1);let p=s.offset,m=null;for(const b of s.items){const{start:_,key:C,sep:P,value:T}=b,D=En(_,{indicator:"explicit-key-ind",next:C??(P==null?void 0:P[0]),offset:p,onError:i,parentIndent:s.indent,startOnNewline:!0}),z=!D.found;if(z){if(C&&(C.type==="block-seq"?i(p,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in C&&C.indent!==s.indent&&i(p,"BAD_INDENT",Ia)),!D.anchor&&!D.tag&&!P){m=D.end,D.comment&&(f.comment?f.comment+=`
`+D.comment:f.comment=D.comment);continue}(D.newlineAfterProp||rs(C))&&i(C??_[_.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else((L=D.found)==null?void 0:L.indent)!==s.indent&&i(p,"BAD_INDENT",Ia);t.atKey=!0;const W=D.end,X=C?n(t,C,D,i):e(t,W,_,null,D,i);t.schema.compat&&Qi(s.indent,C,i),t.atKey=!1,Yc(t,f.items,X)&&i(W,"DUPLICATE_KEY","Map keys must be unique");const Q=En(P??[],{indicator:"map-value-ind",next:T,offset:X.range[2],onError:i,parentIndent:s.indent,startOnNewline:!C||C.type==="block-scalar"});if(p=Q.end,Q.found){z&&((T==null?void 0:T.type)==="block-map"&&!Q.hasNewline&&i(p,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),t.options.strict&&D.start<Q.found.offset-1024&&i(X.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const ee=T?n(t,T,Q,i):e(t,p,P,null,Q,i);t.schema.compat&&Qi(s.indent,T,i),p=ee.range[2];const te=new Pe(X,ee);t.options.keepSourceTokens&&(te.srcToken=b),f.items.push(te)}else{z&&i(X.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),Q.comment&&(X.comment?X.comment+=`
`+Q.comment:X.comment=Q.comment);const ee=new Pe(X);t.options.keepSourceTokens&&(ee.srcToken=b),f.items.push(ee)}}return m&&m<p&&i(m,"IMPOSSIBLE","Map comment with trailing content"),f.range=[s.offset,p,m??p],f}function Bd({composeNode:n,composeEmptyNode:e},t,s,i,a){const c=(a==null?void 0:a.nodeClass)??_t,f=new c(t.schema);t.atRoot&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let p=s.offset,m=null;for(const{start:L,value:b}of s.items){const _=En(L,{indicator:"seq-item-ind",next:b,offset:p,onError:i,parentIndent:s.indent,startOnNewline:!0});if(!_.found)if(_.anchor||_.tag||b)b&&b.type==="block-seq"?i(_.end,"BAD_INDENT","All sequence items must start at the same column"):i(p,"MISSING_CHAR","Sequence item without - indicator");else{m=_.end,_.comment&&(f.comment=_.comment);continue}const C=b?n(t,b,_,i):e(t,_.end,L,null,_,i);t.schema.compat&&Qi(s.indent,b,i),p=C.range[2],f.items.push(C)}return f.range=[s.offset,p,m??p],f}function ls(n,e,t,s){let i="";if(n){let a=!1,c="";for(const f of n){const{source:p,type:m}=f;switch(m){case"space":a=!0;break;case"comment":{t&&!a&&s(f,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const L=p.substring(1)||" ";i?i+=c+L:i=L,c="";break}case"newline":i&&(c+=p),a=!0;break;default:s(f,"UNEXPECTED_TOKEN",`Unexpected ${m} at node end`)}e+=p.length}}return{comment:i,offset:e}}const wi="Block collections are not allowed within flow collections",ki=n=>n&&(n.type==="block-map"||n.type==="block-seq");function jd({composeNode:n,composeEmptyNode:e},t,s,i,a){const c=s.start.source==="{",f=c?"flow map":"flow sequence",p=(a==null?void 0:a.nodeClass)??(c?qe:_t),m=new p(t.schema);m.flow=!0;const L=t.atRoot;L&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let b=s.offset+s.start.source.length;for(let D=0;D<s.items.length;++D){const z=s.items[D],{start:W,key:X,sep:Q,value:ee}=z,te=En(W,{flow:f,indicator:"explicit-key-ind",next:X??(Q==null?void 0:Q[0]),offset:b,onError:i,parentIndent:s.indent,startOnNewline:!1});if(!te.found){if(!te.anchor&&!te.tag&&!Q&&!ee){D===0&&te.comma?i(te.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${f}`):D<s.items.length-1&&i(te.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${f}`),te.comment&&(m.comment?m.comment+=`
`+te.comment:m.comment=te.comment),b=te.end;continue}!c&&t.options.strict&&rs(X)&&i(X,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if(D===0)te.comma&&i(te.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${f}`);else if(te.comma||i(te.start,"MISSING_CHAR",`Missing , between ${f} items`),te.comment){let ae="";e:for(const G of W)switch(G.type){case"comma":case"space":break;case"comment":ae=G.source.substring(1);break e;default:break e}if(ae){let G=m.items[m.items.length-1];we(G)&&(G=G.value??G.key),G.comment?G.comment+=`
`+ae:G.comment=ae,te.comment=te.comment.substring(ae.length+1)}}if(!c&&!Q&&!te.found){const ae=ee?n(t,ee,te,i):e(t,te.end,Q,null,te,i);m.items.push(ae),b=ae.range[2],ki(ee)&&i(ae.range,"BLOCK_IN_FLOW",wi)}else{t.atKey=!0;const ae=te.end,G=X?n(t,X,te,i):e(t,ae,W,null,te,i);ki(X)&&i(G.range,"BLOCK_IN_FLOW",wi),t.atKey=!1;const ye=En(Q??[],{flow:f,indicator:"map-value-ind",next:ee,offset:G.range[2],onError:i,parentIndent:s.indent,startOnNewline:!1});if(ye.found){if(!c&&!te.found&&t.options.strict){if(Q)for(const ge of Q){if(ge===ye.found)break;if(ge.type==="newline"){i(ge,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}te.start<ye.found.offset-1024&&i(ye.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else ee&&("source"in ee&&ee.source&&ee.source[0]===":"?i(ee,"MISSING_CHAR",`Missing space after : in ${f}`):i(ye.start,"MISSING_CHAR",`Missing , or : between ${f} items`));const ze=ee?n(t,ee,ye,i):ye.found?e(t,ye.end,Q,null,ye,i):null;ze?ki(ee)&&i(ze.range,"BLOCK_IN_FLOW",wi):ye.comment&&(G.comment?G.comment+=`
`+ye.comment:G.comment=ye.comment);const nt=new Pe(G,ze);if(t.options.keepSourceTokens&&(nt.srcToken=z),c){const ge=m;Yc(t,ge.items,G)&&i(ae,"DUPLICATE_KEY","Map keys must be unique"),ge.items.push(nt)}else{const ge=new qe(t.schema);ge.flow=!0,ge.items.push(nt);const Ge=(ze??G).range;ge.range=[G.range[0],Ge[1],Ge[2]],m.items.push(ge)}b=ze?ze.range[2]:ye.end}}const _=c?"}":"]",[C,...P]=s.end;let T=b;if(C&&C.source===_)T=C.offset+C.source.length;else{const D=f[0].toUpperCase()+f.substring(1),z=L?`${D} must end with a ${_}`:`${D} in block collection must be sufficiently indented and end with a ${_}`;i(b,L?"MISSING_CHAR":"BAD_INDENT",z),C&&C.source.length!==1&&P.unshift(C)}if(P.length>0){const D=ls(P,T,t.options.strict,i);D.comment&&(m.comment?m.comment+=`
`+D.comment:m.comment=D.comment),m.range=[s.offset,T,D.offset]}else m.range=[s.offset,T,T];return m}function Si(n,e,t,s,i,a){const c=t.type==="block-map"?Dd(n,e,t,s,a):t.type==="block-seq"?Bd(n,e,t,s,a):jd(n,e,t,s,a),f=c.constructor;return i==="!"||i===f.tagName?(c.tag=f.tagName,c):(i&&(c.tag=i),c)}function Kd(n,e,t,s,i){var _;const a=s.tag,c=a?e.directives.tagName(a.source,C=>i(a,"TAG_RESOLVE_FAILED",C)):null;if(t.type==="block-seq"){const{anchor:C,newlineAfterProp:P}=s,T=C&&a?C.offset>a.offset?C:a:C??a;T&&(!P||P.offset<T.offset)&&i(T,"MISSING_CHAR","Missing newline after block sequence props")}const f=t.type==="block-map"?"map":t.type==="block-seq"?"seq":t.start.source==="{"?"map":"seq";if(!a||!c||c==="!"||c===qe.tagName&&f==="map"||c===_t.tagName&&f==="seq")return Si(n,e,t,i,c);let p=e.schema.tags.find(C=>C.tag===c&&C.collection===f);if(!p){const C=e.schema.knownTags[c];if(C&&C.collection===f)e.schema.tags.push(Object.assign({},C,{default:!1})),p=C;else return C?i(a,"BAD_COLLECTION_TYPE",`${C.tag} used for ${f} collection, but expects ${C.collection??"scalar"}`,!0):i(a,"TAG_RESOLVE_FAILED",`Unresolved tag: ${c}`,!0),Si(n,e,t,i,c)}const m=Si(n,e,t,i,c,p),L=((_=p.resolve)==null?void 0:_.call(p,m,C=>i(a,"TAG_RESOLVE_FAILED",C),e.options))??m,b=Se(L)?L:new ie(L);return b.range=m.range,b.tag=c,p!=null&&p.format&&(b.format=p.format),b}function Jc(n,e,t){const s=e.offset,i=Rd(e,n.options.strict,t);if(!i)return{value:"",type:null,comment:"",range:[s,s,s]};const a=i.mode===">"?ie.BLOCK_FOLDED:ie.BLOCK_LITERAL,c=e.source?qd(e.source):[];let f=c.length;for(let T=c.length-1;T>=0;--T){const D=c[T][1];if(D===""||D==="\r")f=T;else break}if(f===0){const T=i.chomp==="+"&&c.length>0?`
`.repeat(Math.max(1,c.length-1)):"";let D=s+i.length;return e.source&&(D+=e.source.length),{value:T,type:a,comment:i.comment,range:[s,D,D]}}let p=e.indent+i.indent,m=e.offset+i.length,L=0;for(let T=0;T<f;++T){const[D,z]=c[T];if(z===""||z==="\r")i.indent===0&&D.length>p&&(p=D.length);else{D.length<p&&t(m+D.length,"MISSING_CHAR","Block scalars with more-indented leading empty lines must use an explicit indentation indicator"),i.indent===0&&(p=D.length),L=T,p===0&&!n.atRoot&&t(m,"BAD_INDENT","Block scalar values in collections must be indented");break}m+=D.length+z.length+1}for(let T=c.length-1;T>=f;--T)c[T][0].length>p&&(f=T+1);let b="",_="",C=!1;for(let T=0;T<L;++T)b+=c[T][0].slice(p)+`
`;for(let T=L;T<f;++T){let[D,z]=c[T];m+=D.length+z.length+1;const W=z[z.length-1]==="\r";if(W&&(z=z.slice(0,-1)),z&&D.length<p){const Q=`Block scalar lines must not be less indented than their ${i.indent?"explicit indentation indicator":"first line"}`;t(m-z.length-(W?2:1),"BAD_INDENT",Q),D=""}a===ie.BLOCK_LITERAL?(b+=_+D.slice(p)+z,_=`
`):D.length>p||z[0]==="	"?(_===" "?_=`
`:!C&&_===`
`&&(_=`

`),b+=_+D.slice(p)+z,_=`
`,C=!0):z===""?_===`
`?b+=`
`:_=`
`:(b+=_+z,_=" ",C=!1)}switch(i.chomp){case"-":break;case"+":for(let T=f;T<c.length;++T)b+=`
`+c[T][0].slice(p);b[b.length-1]!==`
`&&(b+=`
`);break;default:b+=`
`}const P=s+i.length+e.source.length;return{value:b,type:a,comment:i.comment,range:[s,P,P]}}function Rd({offset:n,props:e},t,s){if(e[0].type!=="block-scalar-header")return s(e[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:i}=e[0],a=i[0];let c=0,f="",p=-1;for(let _=1;_<i.length;++_){const C=i[_];if(!f&&(C==="-"||C==="+"))f=C;else{const P=Number(C);!c&&P?c=P:p===-1&&(p=n+_)}}p!==-1&&s(p,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${i}`);let m=!1,L="",b=i.length;for(let _=1;_<e.length;++_){const C=e[_];switch(C.type){case"space":m=!0;case"newline":b+=C.source.length;break;case"comment":t&&!m&&s(C,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),b+=C.source.length,L=C.source.substring(1);break;case"error":s(C,"UNEXPECTED_TOKEN",C.message),b+=C.source.length;break;default:{const P=`Unexpected token in block scalar header: ${C.type}`;s(C,"UNEXPECTED_TOKEN",P);const T=C.source;T&&typeof T=="string"&&(b+=T.length)}}}return{mode:a,indent:c,chomp:f,comment:L,length:b}}function qd(n){const e=n.split(/\n( *)/),t=e[0],s=t.match(/^( *)/),a=[s!=null&&s[1]?[s[1],t.slice(s[1].length)]:["",t]];for(let c=1;c<e.length;c+=2)a.push([e[c],e[c+1]]);return a}function Gc(n,e,t){const{offset:s,type:i,source:a,end:c}=n;let f,p;const m=(_,C,P)=>t(s+_,C,P);switch(i){case"scalar":f=ie.PLAIN,p=Fd(a,m);break;case"single-quoted-scalar":f=ie.QUOTE_SINGLE,p=Ud(a,m);break;case"double-quoted-scalar":f=ie.QUOTE_DOUBLE,p=Hd(a,m);break;default:return t(n,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${i}`),{value:"",type:null,comment:"",range:[s,s+a.length,s+a.length]}}const L=s+a.length,b=ls(c,L,e,t);return{value:p,type:f,comment:b.comment,range:[s,L,b.offset]}}function Fd(n,e){let t="";switch(n[0]){case"	":t="a tab character";break;case",":t="flow indicator character ,";break;case"%":t="directive indicator character %";break;case"|":case">":{t=`block scalar indicator ${n[0]}`;break}case"@":case"`":{t=`reserved character ${n[0]}`;break}}return t&&e(0,"BAD_SCALAR_START",`Plain value cannot start with ${t}`),Wc(n)}function Ud(n,e){return(n[n.length-1]!=="'"||n.length===1)&&e(n.length,"MISSING_CHAR","Missing closing 'quote"),Wc(n.slice(1,-1)).replace(/''/g,"'")}function Wc(n){let e,t;try{e=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),t=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{e=/(.*?)[ \t]*\r?\n/sy,t=/[ \t]*(.*?)[ \t]*\r?\n/sy}let s=e.exec(n);if(!s)return n;let i=s[1],a=" ",c=e.lastIndex;for(t.lastIndex=c;s=t.exec(n);)s[1]===""?a===`
`?i+=a:a=`
`:(i+=a+s[1],a=" "),c=t.lastIndex;const f=/[ \t]*(.*)/sy;return f.lastIndex=c,s=f.exec(n),i+a+((s==null?void 0:s[1])??"")}function Hd(n,e){let t="";for(let s=1;s<n.length-1;++s){const i=n[s];if(!(i==="\r"&&n[s+1]===`
`))if(i===`
`){const{fold:a,offset:c}=zd(n,s);t+=a,s=c}else if(i==="\\"){let a=n[++s];const c=Vd[a];if(c)t+=c;else if(a===`
`)for(a=n[s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="\r"&&n[s+1]===`
`)for(a=n[++s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="x"||a==="u"||a==="U"){const f={x:2,u:4,U:8}[a];t+=Yd(n,s+1,f,e),s+=f}else{const f=n.substr(s-1,2);e(s-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${f}`),t+=f}}else if(i===" "||i==="	"){const a=s;let c=n[s+1];for(;c===" "||c==="	";)c=n[++s+1];c!==`
`&&!(c==="\r"&&n[s+2]===`
`)&&(t+=s>a?n.slice(a,s+1):i)}else t+=i}return(n[n.length-1]!=='"'||n.length===1)&&e(n.length,"MISSING_CHAR",'Missing closing "quote'),t}function zd(n,e){let t="",s=n[e+1];for(;(s===" "||s==="	"||s===`
`||s==="\r")&&!(s==="\r"&&n[e+2]!==`
`);)s===`
`&&(t+=`
`),e+=1,s=n[e+1];return t||(t=" "),{fold:t,offset:e}}const Vd={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function Yd(n,e,t,s){const i=n.substr(e,t),c=i.length===t&&/^[0-9a-fA-F]+$/.test(i)?parseInt(i,16):NaN;if(isNaN(c)){const f=n.substr(e-2,t+2);return s(e-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${f}`),f}return String.fromCodePoint(c)}function Qc(n,e,t,s){const{value:i,type:a,comment:c,range:f}=e.type==="block-scalar"?Jc(n,e,s):Gc(e,n.options.strict,s),p=t?n.directives.tagName(t.source,b=>s(t,"TAG_RESOLVE_FAILED",b)):null;let m;n.options.stringKeys&&n.atKey?m=n.schema[tt]:p?m=Jd(n.schema,i,p,t,s):e.type==="scalar"?m=Gd(n,i,e,s):m=n.schema[tt];let L;try{const b=m.resolve(i,_=>s(t??e,"TAG_RESOLVE_FAILED",_),n.options);L=me(b)?b:new ie(b)}catch(b){const _=b instanceof Error?b.message:String(b);s(t??e,"TAG_RESOLVE_FAILED",_),L=new ie(i)}return L.range=f,L.source=i,a&&(L.type=a),p&&(L.tag=p),m.format&&(L.format=m.format),c&&(L.comment=c),L}function Jd(n,e,t,s,i){var f;if(t==="!")return n[tt];const a=[];for(const p of n.tags)if(!p.collection&&p.tag===t)if(p.default&&p.test)a.push(p);else return p;for(const p of a)if((f=p.test)!=null&&f.test(e))return p;const c=n.knownTags[t];return c&&!c.collection?(n.tags.push(Object.assign({},c,{default:!1,test:void 0})),c):(i(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${t}`,t!=="tag:yaml.org,2002:str"),n[tt])}function Gd({atKey:n,directives:e,schema:t},s,i,a){const c=t.tags.find(f=>{var p;return(f.default===!0||n&&f.default==="key")&&((p=f.test)==null?void 0:p.test(s))})||t[tt];if(t.compat){const f=t.compat.find(p=>{var m;return p.default&&((m=p.test)==null?void 0:m.test(s))})??t[tt];if(c.tag!==f.tag){const p=e.tagString(c.tag),m=e.tagString(f.tag),L=`Value may be parsed as either ${p} or ${m}`;a(i,"TAG_RESOLVE_FAILED",L,!0)}}return c}function Wd(n,e,t){if(e){t??(t=e.length);for(let s=t-1;s>=0;--s){let i=e[s];switch(i.type){case"space":case"comment":case"newline":n-=i.source.length;continue}for(i=e[++s];(i==null?void 0:i.type)==="space";)n+=i.source.length,i=e[++s];break}}return n}const Qd={composeNode:Xc,composeEmptyNode:yo};function Xc(n,e,t,s){const i=n.atKey,{spaceBefore:a,comment:c,anchor:f,tag:p}=t;let m,L=!0;switch(e.type){case"alias":m=Xd(n,e,s),(f||p)&&s(e,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":m=Qc(n,e,p,s),f&&(m.anchor=f.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":m=Kd(Qd,n,e,t,s),f&&(m.anchor=f.source.substring(1));break;default:{const b=e.type==="error"?e.message:`Unsupported token (type: ${e.type})`;s(e,"UNEXPECTED_TOKEN",b),m=yo(n,e.offset,void 0,null,t,s),L=!1}}return f&&m.anchor===""&&s(f,"BAD_ALIAS","Anchor cannot be an empty string"),i&&n.options.stringKeys&&(!me(m)||typeof m.value!="string"||m.tag&&m.tag!=="tag:yaml.org,2002:str")&&s(p??e,"NON_STRING_KEY","With stringKeys, all keys must be strings"),a&&(m.spaceBefore=!0),c&&(e.type==="scalar"&&e.source===""?m.comment=c:m.commentBefore=c),n.options.keepSourceTokens&&L&&(m.srcToken=e),m}function yo(n,e,t,s,{spaceBefore:i,comment:a,anchor:c,tag:f,end:p},m){const L={type:"scalar",offset:Wd(e,t,s),indent:-1,source:""},b=Qc(n,L,f,m);return c&&(b.anchor=c.source.substring(1),b.anchor===""&&m(c,"BAD_ALIAS","Anchor cannot be an empty string")),i&&(b.spaceBefore=!0),a&&(b.comment=a,b.range[2]=p),b}function Xd({options:n},{offset:e,source:t,end:s},i){const a=new pr(t.substring(1));a.source===""&&i(e,"BAD_ALIAS","Alias cannot be an empty string"),a.source.endsWith(":")&&i(e+t.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const c=e+t.length,f=ls(s,c,n.strict,i);return a.range=[e,c,f.offset],f.comment&&(a.comment=f.comment),a}function Zd(n,e,{offset:t,start:s,value:i,end:a},c){const f=Object.assign({_directives:e},n),p=new On(void 0,f),m={atKey:!1,atRoot:!0,directives:p.directives,options:p.options,schema:p.schema},L=En(s,{indicator:"doc-start",next:i??(a==null?void 0:a[0]),offset:t,onError:c,parentIndent:0,startOnNewline:!0});L.found&&(p.directives.docStart=!0,i&&(i.type==="block-map"||i.type==="block-seq")&&!L.hasNewline&&c(L.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),p.contents=i?Xc(m,i,L,c):yo(m,L.end,s,null,L,c);const b=p.contents.range[2],_=ls(a,b,!1,c);return _.comment&&(p.comment=_.comment),p.range=[t,b,_.offset],p}function Vn(n){if(typeof n=="number")return[n,n+1];if(Array.isArray(n))return n.length===2?n:[n[0],n[1]];const{offset:e,source:t}=n;return[e,e+(typeof t=="string"?t.length:1)]}function Ta(n){var i;let e="",t=!1,s=!1;for(let a=0;a<n.length;++a){const c=n[a];switch(c[0]){case"#":e+=(e===""?"":s?`

`:`
`)+(c.substring(1)||" "),t=!0,s=!1;break;case"%":((i=n[a+1])==null?void 0:i[0])!=="#"&&(a+=1),t=!1;break;default:t||(s=!0),t=!1}}return{comment:e,afterEmptyLine:s}}class go{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(t,s,i,a)=>{const c=Vn(t);a?this.warnings.push(new Vc(c,s,i)):this.errors.push(new Ut(c,s,i))},this.directives=new Me({version:e.version||"1.2"}),this.options=e}decorate(e,t){const{comment:s,afterEmptyLine:i}=Ta(this.prelude);if(s){const a=e.contents;if(t)e.comment=e.comment?`${e.comment}
${s}`:s;else if(i||e.directives.docStart||!a)e.commentBefore=s;else if(ke(a)&&!a.flow&&a.items.length>0){let c=a.items[0];we(c)&&(c=c.key);const f=c.commentBefore;c.commentBefore=f?`${s}
${f}`:s}else{const c=a.commentBefore;a.commentBefore=c?`${s}
${c}`:s}}t?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:Ta(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,t=!1,s=-1){for(const i of e)yield*this.next(i);yield*this.end(t,s)}*next(e){switch(e.type){case"directive":this.directives.add(e.source,(t,s,i)=>{const a=Vn(e);a[0]+=t,this.onError(a,"BAD_DIRECTIVE",s,i)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{const t=Zd(this.options,this.directives,e,this.onError);this.atDirectives&&!t.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(t,!1),this.doc&&(yield this.doc),this.doc=t,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{const t=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,s=new Ut(Vn(e),"UNEXPECTED_TOKEN",t);this.atDirectives||!this.doc?this.errors.push(s):this.doc.errors.push(s);break}case"doc-end":{if(!this.doc){const s="Unexpected doc-end without preceding document";this.errors.push(new Ut(Vn(e),"UNEXPECTED_TOKEN",s));break}this.doc.directives.docEnd=!0;const t=ls(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),t.comment){const s=this.doc.comment;this.doc.comment=s?`${s}
${t.comment}`:t.comment}this.doc.range[2]=t.offset;break}default:this.errors.push(new Ut(Vn(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,t=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){const s=Object.assign({_directives:this.directives},this.options),i=new On(void 0,s);this.atDirectives&&this.onError(t,"MISSING_CHAR","Missing directives-end indicator line"),i.range=[0,t,t],this.decorate(i,!1),yield i}}}function eh(n,e=!0,t){if(n){const s=(i,a,c)=>{const f=typeof i=="number"?i:Array.isArray(i)?i[0]:i.offset;if(t)t(f,a,c);else throw new Ut([f,f+1],a,c)};switch(n.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return Gc(n,e,s);case"block-scalar":return Jc({options:{strict:e}},n,s)}}return null}function th(n,e){const{implicitKey:t=!1,indent:s,inFlow:i=!1,offset:a=-1,type:c="PLAIN"}=e,f=as({type:c,value:n},{implicitKey:t,indent:s>0?" ".repeat(s):"",inFlow:i,options:{blockQuote:!0,lineWidth:-1}}),p=e.end??[{type:"newline",offset:-1,indent:s,source:`
`}];switch(f[0]){case"|":case">":{const m=f.indexOf(`
`),L=f.substring(0,m),b=f.substring(m+1)+`
`,_=[{type:"block-scalar-header",offset:a,indent:s,source:L}];return Zc(_,p)||_.push({type:"newline",offset:-1,indent:s,source:`
`}),{type:"block-scalar",offset:a,indent:s,props:_,source:b}}case'"':return{type:"double-quoted-scalar",offset:a,indent:s,source:f,end:p};case"'":return{type:"single-quoted-scalar",offset:a,indent:s,source:f,end:p};default:return{type:"scalar",offset:a,indent:s,source:f,end:p}}}function nh(n,e,t={}){let{afterKey:s=!1,implicitKey:i=!1,inFlow:a=!1,type:c}=t,f="indent"in n?n.indent:null;if(s&&typeof f=="number"&&(f+=2),!c)switch(n.type){case"single-quoted-scalar":c="QUOTE_SINGLE";break;case"double-quoted-scalar":c="QUOTE_DOUBLE";break;case"block-scalar":{const m=n.props[0];if(m.type!=="block-scalar-header")throw new Error("Invalid block scalar header");c=m.source[0]===">"?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:c="PLAIN"}const p=as({type:c,value:e},{implicitKey:i||f===null,indent:f!==null&&f>0?" ".repeat(f):"",inFlow:a,options:{blockQuote:!0,lineWidth:-1}});switch(p[0]){case"|":case">":sh(n,p);break;case'"':Ei(n,p,"double-quoted-scalar");break;case"'":Ei(n,p,"single-quoted-scalar");break;default:Ei(n,p,"scalar")}}function sh(n,e){const t=e.indexOf(`
`),s=e.substring(0,t),i=e.substring(t+1)+`
`;if(n.type==="block-scalar"){const a=n.props[0];if(a.type!=="block-scalar-header")throw new Error("Invalid block scalar header");a.source=s,n.source=i}else{const{offset:a}=n,c="indent"in n?n.indent:-1,f=[{type:"block-scalar-header",offset:a,indent:c,source:s}];Zc(f,"end"in n?n.end:void 0)||f.push({type:"newline",offset:-1,indent:c,source:`
`});for(const p of Object.keys(n))p!=="type"&&p!=="offset"&&delete n[p];Object.assign(n,{type:"block-scalar",indent:c,props:f,source:i})}}function Zc(n,e){if(e)for(const t of e)switch(t.type){case"space":case"comment":n.push(t);break;case"newline":return n.push(t),!0}return!1}function Ei(n,e,t){switch(n.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":n.type=t,n.source=e;break;case"block-scalar":{const s=n.props.slice(1);let i=e.length;n.props[0].type==="block-scalar-header"&&(i-=n.props[0].source.length);for(const a of s)a.offset+=i;delete n.props,Object.assign(n,{type:t,source:e,end:s});break}case"block-map":case"block-seq":{const i={type:"newline",offset:n.offset+e.length,indent:n.indent,source:`
`};delete n.items,Object.assign(n,{type:t,source:e,end:[i]});break}default:{const s="indent"in n?n.indent:-1,i="end"in n&&Array.isArray(n.end)?n.end.filter(a=>a.type==="space"||a.type==="comment"||a.type==="newline"):[];for(const a of Object.keys(n))a!=="type"&&a!=="offset"&&delete n[a];Object.assign(n,{type:t,indent:s,source:e,end:i})}}}const rh=n=>"type"in n?fr(n):sr(n);function fr(n){switch(n.type){case"block-scalar":{let e="";for(const t of n.props)e+=fr(t);return e+n.source}case"block-map":case"block-seq":{let e="";for(const t of n.items)e+=sr(t);return e}case"flow-collection":{let e=n.start.source;for(const t of n.items)e+=sr(t);for(const t of n.end)e+=t.source;return e}case"document":{let e=sr(n);if(n.end)for(const t of n.end)e+=t.source;return e}default:{let e=n.source;if("end"in n&&n.end)for(const t of n.end)e+=t.source;return e}}}function sr({start:n,key:e,sep:t,value:s}){let i="";for(const a of n)i+=a.source;if(e&&(i+=fr(e)),t)for(const a of t)i+=a.source;return s&&(i+=fr(s)),i}const Xi=Symbol("break visit"),ih=Symbol("skip children"),el=Symbol("remove item");function zt(n,e){"type"in n&&n.type==="document"&&(n={start:n.start,value:n.value}),tl(Object.freeze([]),n,e)}zt.BREAK=Xi;zt.SKIP=ih;zt.REMOVE=el;zt.itemAtPath=(n,e)=>{let t=n;for(const[s,i]of e){const a=t==null?void 0:t[s];if(a&&"items"in a)t=a.items[i];else return}return t};zt.parentCollection=(n,e)=>{const t=zt.itemAtPath(n,e.slice(0,-1)),s=e[e.length-1][0],i=t==null?void 0:t[s];if(i&&"items"in i)return i;throw new Error("Parent collection not found")};function tl(n,e,t){let s=t(e,n);if(typeof s=="symbol")return s;for(const i of["key","value"]){const a=e[i];if(a&&"items"in a){for(let c=0;c<a.items.length;++c){const f=tl(Object.freeze(n.concat([[i,c]])),a.items[c],t);if(typeof f=="number")c=f-1;else{if(f===Xi)return Xi;f===el&&(a.items.splice(c,1),c-=1)}}typeof s=="function"&&i==="key"&&(s=s(e,n))}}return typeof s=="function"?s(e,n):s}const _r="\uFEFF",Ir="",Tr="",is="",oh=n=>!!n&&"items"in n,ah=n=>!!n&&(n.type==="scalar"||n.type==="single-quoted-scalar"||n.type==="double-quoted-scalar"||n.type==="block-scalar");function ch(n){switch(n){case _r:return"<BOM>";case Ir:return"<DOC>";case Tr:return"<FLOW_END>";case is:return"<SCALAR>";default:return JSON.stringify(n)}}function nl(n){switch(n){case _r:return"byte-order-mark";case Ir:return"doc-mode";case Tr:return"flow-error-end";case is:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(n[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}const lh=Object.freeze(Object.defineProperty({__proto__:null,BOM:_r,DOCUMENT:Ir,FLOW_END:Tr,SCALAR:is,createScalarToken:th,isCollection:oh,isScalar:ah,prettyToken:ch,resolveAsScalar:eh,setScalarValue:nh,stringify:rh,tokenType:nl,visit:zt},Symbol.toStringTag,{value:"Module"}));function Ve(n){switch(n){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}const Aa=new Set("0123456789ABCDEFabcdef"),uh=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),Hs=new Set(",[]{}"),fh=new Set(` ,[]{}
\r	`),_i=n=>!n||fh.has(n);class sl{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,t=!1){if(e){if(typeof e!="string")throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null}this.atEnd=!t;let s=this.next??"stream";for(;s&&(t||this.hasChars(1));)s=yield*this.parseNext(s)}atLineEnd(){let e=this.pos,t=this.buffer[e];for(;t===" "||t==="	";)t=this.buffer[++e];return!t||t==="#"||t===`
`?!0:t==="\r"?this.buffer[e+1]===`
`:!1}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let t=this.buffer[e];if(this.indentNext>0){let s=0;for(;t===" ";)t=this.buffer[++s+e];if(t==="\r"){const i=this.buffer[s+e+1];if(i===`
`||!i&&!this.atEnd)return e+s+1}return t===`
`||s>=this.indentNext||!t&&!this.atEnd?e+s:-1}if(t==="-"||t==="."){const s=this.buffer.substr(e,3);if((s==="---"||s==="...")&&Ve(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return(typeof e!="number"||e!==-1&&e<this.pos)&&(e=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=e),e===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[e-1]==="\r"&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(e===null)return this.setNext("stream");if(e[0]===_r&&(yield*this.pushCount(1),e=e.substring(1)),e[0]==="%"){let t=e.length,s=e.indexOf("#");for(;s!==-1;){const a=e[s-1];if(a===" "||a==="	"){t=s-1;break}else s=e.indexOf("#",s+1)}for(;;){const a=e[t-1];if(a===" "||a==="	")t-=1;else break}const i=(yield*this.pushCount(t))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-i),this.pushNewline(),"stream"}if(this.atLineEnd()){const t=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-t),yield*this.pushNewline(),"stream"}return yield Ir,yield*this.parseLineStart()}*parseLineStart(){const e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if(e==="-"||e==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const t=this.peek(3);if((t==="---"||t==="...")&&Ve(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,t==="---"?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!Ve(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[e,t]=this.peek(2);if(!t&&!this.atEnd)return this.setNext("block-start");if((e==="-"||e==="?"||e===":")&&Ve(t)){const s=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=s,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const e=this.getLine();if(e===null)return this.setNext("doc");let t=yield*this.pushIndicators();switch(e[t]){case"#":yield*this.pushCount(e.length-t);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(_i),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return t+=yield*this.parseBlockScalarHeader(),t+=yield*this.pushSpaces(!0),yield*this.pushCount(e.length-t),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,t,s=-1;do e=yield*this.pushNewline(),e>0?(t=yield*this.pushSpaces(!1),this.indentValue=s=t):t=0,t+=yield*this.pushSpaces(!0);while(e+t>0);const i=this.getLine();if(i===null)return this.setNext("flow");if((s!==-1&&s<this.indentNext&&i[0]!=="#"||s===0&&(i.startsWith("---")||i.startsWith("..."))&&Ve(i[3]))&&!(s===this.indentNext-1&&this.flowLevel===1&&(i[0]==="]"||i[0]==="}")))return this.flowLevel=0,yield Tr,yield*this.parseLineStart();let a=0;for(;i[a]===",";)a+=yield*this.pushCount(1),a+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(a+=yield*this.pushIndicators(),i[a]){case void 0:return"flow";case"#":return yield*this.pushCount(i.length-a),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(_i),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const c=this.charAt(1);if(this.flowKey||Ve(c)||c===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const e=this.charAt(0);let t=this.buffer.indexOf(e,this.pos+1);if(e==="'")for(;t!==-1&&this.buffer[t+1]==="'";)t=this.buffer.indexOf("'",t+2);else for(;t!==-1;){let a=0;for(;this.buffer[t-1-a]==="\\";)a+=1;if(a%2===0)break;t=this.buffer.indexOf('"',t+1)}const s=this.buffer.substring(0,t);let i=s.indexOf(`
`,this.pos);if(i!==-1){for(;i!==-1;){const a=this.continueScalar(i+1);if(a===-1)break;i=s.indexOf(`
`,a)}i!==-1&&(t=i-(s[i-1]==="\r"?2:1))}if(t===-1){if(!this.atEnd)return this.setNext("quoted-scalar");t=this.buffer.length}return yield*this.pushToIndex(t+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){const t=this.buffer[++e];if(t==="+")this.blockScalarKeep=!0;else if(t>"0"&&t<="9")this.blockScalarIndent=Number(t)-1;else if(t!=="-")break}return yield*this.pushUntil(t=>Ve(t)||t==="#")}*parseBlockScalar(){let e=this.pos-1,t=0,s;e:for(let a=this.pos;s=this.buffer[a];++a)switch(s){case" ":t+=1;break;case`
`:e=a,t=0;break;case"\r":{const c=this.buffer[a+1];if(!c&&!this.atEnd)return this.setNext("block-scalar");if(c===`
`)break}default:break e}if(!s&&!this.atEnd)return this.setNext("block-scalar");if(t>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=t:this.indentNext=this.blockScalarIndent+(this.indentNext===0?1:this.indentNext);do{const a=this.continueScalar(e+1);if(a===-1)break;e=this.buffer.indexOf(`
`,a)}while(e!==-1);if(e===-1){if(!this.atEnd)return this.setNext("block-scalar");e=this.buffer.length}}let i=e+1;for(s=this.buffer[i];s===" ";)s=this.buffer[++i];if(s==="	"){for(;s==="	"||s===" "||s==="\r"||s===`
`;)s=this.buffer[++i];e=i-1}else if(!this.blockScalarKeep)do{let a=e-1,c=this.buffer[a];c==="\r"&&(c=this.buffer[--a]);const f=a;for(;c===" ";)c=this.buffer[--a];if(c===`
`&&a>=this.pos&&a+1+t>f)e=a;else break}while(!0);return yield is,yield*this.pushToIndex(e+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const e=this.flowLevel>0;let t=this.pos-1,s=this.pos-1,i;for(;i=this.buffer[++s];)if(i===":"){const a=this.buffer[s+1];if(Ve(a)||e&&Hs.has(a))break;t=s}else if(Ve(i)){let a=this.buffer[s+1];if(i==="\r"&&(a===`
`?(s+=1,i=`
`,a=this.buffer[s+1]):t=s),a==="#"||e&&Hs.has(a))break;if(i===`
`){const c=this.continueScalar(s+1);if(c===-1)break;s=Math.max(s,c-2)}}else{if(e&&Hs.has(i))break;t=s}return!i&&!this.atEnd?this.setNext("plain-scalar"):(yield is,yield*this.pushToIndex(t+1,!0),e?"flow":"doc")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,t){const s=this.buffer.slice(this.pos,e);return s?(yield s,this.pos+=s.length,s.length):(t&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(_i))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const e=this.flowLevel>0,t=this.charAt(1);if(Ve(t)||e&&Hs.has(t))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let e=this.pos+2,t=this.buffer[e];for(;!Ve(t)&&t!==">";)t=this.buffer[++e];return yield*this.pushToIndex(t===">"?e+1:e,!1)}else{let e=this.pos+1,t=this.buffer[e];for(;t;)if(uh.has(t))t=this.buffer[++e];else if(t==="%"&&Aa.has(this.buffer[e+1])&&Aa.has(this.buffer[e+2]))t=this.buffer[e+=3];else break;return yield*this.pushToIndex(e,!1)}}*pushNewline(){const e=this.buffer[this.pos];return e===`
`?yield*this.pushCount(1):e==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(e){let t=this.pos-1,s;do s=this.buffer[++t];while(s===" "||e&&s==="	");const i=t-this.pos;return i>0&&(yield this.buffer.substr(this.pos,i),this.pos=t),i}*pushUntil(e){let t=this.pos,s=this.buffer[t];for(;!e(s);)s=this.buffer[++t];return yield*this.pushToIndex(t,!1)}}class rl{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let t=0,s=this.lineStarts.length;for(;t<s;){const a=t+s>>1;this.lineStarts[a]<e?t=a+1:s=a}if(this.lineStarts[t]===e)return{line:t+1,col:1};if(t===0)return{line:0,col:e};const i=this.lineStarts[t-1];return{line:t,col:e-i+1}}}}function kt(n,e){for(let t=0;t<n.length;++t)if(n[t].type===e)return!0;return!1}function La(n){for(let e=0;e<n.length;++e)switch(n[e].type){case"space":case"comment":case"newline":break;default:return e}return-1}function il(n){switch(n==null?void 0:n.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function zs(n){switch(n.type){case"document":return n.start;case"block-map":{const e=n.items[n.items.length-1];return e.sep??e.start}case"block-seq":return n.items[n.items.length-1].start;default:return[]}}function ln(n){var t;if(n.length===0)return[];let e=n.length;e:for(;--e>=0;)switch(n[e].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;((t=n[++e])==null?void 0:t.type)==="space";);return n.splice(e,n.length)}function Ca(n){if(n.start.type==="flow-seq-start")for(const e of n.items)e.sep&&!e.value&&!kt(e.start,"explicit-key-ind")&&!kt(e.sep,"map-value-ind")&&(e.key&&(e.value=e.key),delete e.key,il(e.value)?e.value.end?Array.prototype.push.apply(e.value.end,e.sep):e.value.end=e.sep:Array.prototype.push.apply(e.start,e.sep),delete e.sep)}class vo{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new sl,this.onNewLine=e}*parse(e,t=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(const s of this.lexer.lex(e,t))yield*this.next(s);t||(yield*this.end())}*next(e){if(this.source=e,this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=e.length;return}const t=nl(e);if(t)if(t==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=t,yield*this.step(),t){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&e[0]===" "&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{const s=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:s,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const e=this.peek(1);if(this.type==="doc-end"&&(!e||e.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}peek(e){return this.stack[this.stack.length-e]}*pop(e){const t=e??this.stack.pop();if(!t)yield{type:"error",offset:this.offset,source:"",message:"Tried to pop an empty stack"};else if(this.stack.length===0)yield t;else{const s=this.peek(1);switch(t.type==="block-scalar"?t.indent="indent"in s?s.indent:0:t.type==="flow-collection"&&s.type==="document"&&(t.indent=0),t.type==="flow-collection"&&Ca(t),s.type){case"document":s.value=t;break;case"block-scalar":s.props.push(t);break;case"block-map":{const i=s.items[s.items.length-1];if(i.value){s.items.push({start:[],key:t,sep:[]}),this.onKeyLine=!0;return}else if(i.sep)i.value=t;else{Object.assign(i,{key:t,sep:[]}),this.onKeyLine=!i.explicitKey;return}break}case"block-seq":{const i=s.items[s.items.length-1];i.value?s.items.push({start:[],value:t}):i.value=t;break}case"flow-collection":{const i=s.items[s.items.length-1];!i||i.value?s.items.push({start:[],key:t,sep:[]}):i.sep?i.value=t:Object.assign(i,{key:t,sep:[]});return}default:yield*this.pop(),yield*this.pop(t)}if((s.type==="document"||s.type==="block-map"||s.type==="block-seq")&&(t.type==="block-map"||t.type==="block-seq")){const i=t.items[t.items.length-1];i&&!i.sep&&!i.value&&i.start.length>0&&La(i.start)===-1&&(t.indent===0||i.start.every(a=>a.type!=="comment"||a.indent<t.indent))&&(s.type==="document"?s.end=i.start:s.items.push({start:i.start}),t.items.splice(-1,1))}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{const e={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&e.start.push(this.sourceToken),this.stack.push(e);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":{La(e.start)!==-1?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":e.start.push(this.sourceToken);return}const t=this.startBlockValue(e);t?this.stack.push(t):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if(this.type==="map-value-ind"){const t=zs(this.peek(2)),s=ln(t);let i;e.end?(i=e.end,i.push(this.sourceToken),delete e.end):i=[this.sourceToken];const a={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:s,key:e,sep:i}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=a}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":e.props.push(this.sourceToken);return;case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,t.value){const i="end"in t.value?t.value.end:void 0,a=Array.isArray(i)?i[i.length-1]:void 0;(a==null?void 0:a.type)==="comment"?i==null||i.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else if(t.sep)t.sep.push(this.sourceToken);else{if(this.atIndentedComment(t.start,e.indent)){const i=e.items[e.items.length-2],a=(s=i==null?void 0:i.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return}if(this.indent>=e.indent){const i=!this.onKeyLine&&this.indent===e.indent,a=i&&(t.sep||t.explicitKey)&&this.type!=="seq-item-ind";let c=[];if(a&&t.sep&&!t.value){const f=[];for(let p=0;p<t.sep.length;++p){const m=t.sep[p];switch(m.type){case"newline":f.push(p);break;case"space":break;case"comment":m.indent>e.indent&&(f.length=0);break;default:f.length=0}}f.length>=2&&(c=t.sep.splice(f[1]))}switch(this.type){case"anchor":case"tag":a||t.value?(c.push(this.sourceToken),e.items.push({start:c}),this.onKeyLine=!0):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"explicit-key-ind":!t.sep&&!t.explicitKey?(t.start.push(this.sourceToken),t.explicitKey=!0):a||t.value?(c.push(this.sourceToken),e.items.push({start:c,explicitKey:!0})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken],explicitKey:!0}]}),this.onKeyLine=!0;return;case"map-value-ind":if(t.explicitKey)if(t.sep)if(t.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(kt(t.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:c,key:null,sep:[this.sourceToken]}]});else if(il(t.key)&&!kt(t.sep,"newline")){const f=ln(t.start),p=t.key,m=t.sep;m.push(this.sourceToken),delete t.key,delete t.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:f,key:p,sep:m}]})}else c.length>0?t.sep=t.sep.concat(c,this.sourceToken):t.sep.push(this.sourceToken);else if(kt(t.start,"newline"))Object.assign(t,{key:null,sep:[this.sourceToken]});else{const f=ln(t.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:f,key:null,sep:[this.sourceToken]}]})}else t.sep?t.value||a?e.items.push({start:c,key:null,sep:[this.sourceToken]}):kt(t.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const f=this.flowScalar(this.type);a||t.value?(e.items.push({start:c,key:f,sep:[]}),this.onKeyLine=!0):t.sep?this.stack.push(f):(Object.assign(t,{key:f,sep:[]}),this.onKeyLine=!0);return}default:{const f=this.startBlockValue(e);if(f){if(f.type==="block-seq"){if(!t.explicitKey&&t.sep&&!kt(t.sep,"newline")){yield*this.pop({type:"error",offset:this.offset,message:"Unexpected block-seq-ind on same line with key",source:this.source});return}}else i&&e.items.push({start:c});this.stack.push(f);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(t.value){const i="end"in t.value?t.value.end:void 0,a=Array.isArray(i)?i[i.length-1]:void 0;(a==null?void 0:a.type)==="comment"?i==null||i.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(t.start,e.indent)){const i=e.items[e.items.length-2],a=(s=i==null?void 0:i.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return;case"anchor":case"tag":if(t.value||this.indent<=e.indent)break;t.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==e.indent)break;t.value||kt(t.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return}if(this.indent>e.indent){const i=this.startBlockValue(e);if(i){this.stack.push(i);return}}yield*this.pop(),yield*this.step()}*flowCollection(e){const t=e.items[e.items.length-1];if(this.type==="flow-error-end"){let s;do yield*this.pop(),s=this.peek(1);while(s&&s.type==="flow-collection")}else if(e.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!t||t.sep?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return;case"map-value-ind":!t||t.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!t||t.value?e.items.push({start:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const i=this.flowScalar(this.type);!t||t.value?e.items.push({start:[],key:i,sep:[]}):t.sep?this.stack.push(i):Object.assign(t,{key:i,sep:[]});return}case"flow-map-end":case"flow-seq-end":e.end.push(this.sourceToken);return}const s=this.startBlockValue(e);s?this.stack.push(s):(yield*this.pop(),yield*this.step())}else{const s=this.peek(2);if(s.type==="block-map"&&(this.type==="map-value-ind"&&s.indent===e.indent||this.type==="newline"&&!s.items[s.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&s.type!=="flow-collection"){const i=zs(s),a=ln(i);Ca(e);const c=e.end.splice(1,e.end.length);c.push(this.sourceToken);const f={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:a,key:e,sep:c}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=f}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const t=zs(e),s=ln(t);return s.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,explicitKey:!0}]}}case"map-value-ind":{this.onKeyLine=!0;const t=zs(e),s=ln(t);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,t){return this.type!=="comment"||this.indent<=t?!1:e.every(s=>s.type==="newline"||s.type==="space")}*documentEnd(e){this.type!=="doc-mode"&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;case"space":case"comment":default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}}function ol(n){const e=n.prettyErrors!==!1;return{lineCounter:n.lineCounter||e&&new rl||null,prettyErrors:e}}function dh(n,e={}){const{lineCounter:t,prettyErrors:s}=ol(e),i=new vo(t==null?void 0:t.addNewLine),a=new go(e),c=Array.from(a.compose(i.parse(n)));if(s&&t)for(const f of c)f.errors.forEach(ur(n,t)),f.warnings.forEach(ur(n,t));return c.length>0?c:Object.assign([],{empty:!0},a.streamInfo())}function al(n,e={}){const{lineCounter:t,prettyErrors:s}=ol(e),i=new vo(t==null?void 0:t.addNewLine),a=new go(e);let c=null;for(const f of a.compose(i.parse(n),!0,n.length))if(!c)c=f;else if(c.options.logLevel!=="silent"){c.errors.push(new Ut(f.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return s&&t&&(c.errors.forEach(ur(n,t)),c.warnings.forEach(ur(n,t))),c}function hh(n,e,t){let s;typeof e=="function"?s=e:t===void 0&&e&&typeof e=="object"&&(t=e);const i=al(n,t);if(!i)return null;if(i.warnings.forEach(a=>Ac(i.options.logLevel,a)),i.errors.length>0){if(i.options.logLevel!=="silent")throw i.errors[0];i.errors=[]}return i.toJS(Object.assign({reviver:s},t))}function ph(n,e,t){let s=null;if(typeof e=="function"||Array.isArray(e)?s=e:t===void 0&&e&&(t=e),typeof t=="string"&&(t=t.length),typeof t=="number"){const i=Math.round(t);t=i<1?void 0:i>8?{indent:8}:{indent:i}}if(n===void 0){const{keepUndefined:i}=t??e??{};if(!i)return}return Yt(n)&&!s?n.toString(t):new On(n,s,t).toString(t)}const mh=Object.freeze(Object.defineProperty({__proto__:null,Alias:pr,CST:lh,Composer:go,Document:On,Lexer:sl,LineCounter:rl,Pair:Pe,Parser:vo,Scalar:ie,Schema:Er,YAMLError:mo,YAMLMap:qe,YAMLParseError:Ut,YAMLSeq:_t,YAMLWarning:Vc,isAlias:Tt,isCollection:ke,isDocument:Yt,isMap:Tn,isNode:Se,isPair:we,isScalar:me,isSeq:An,parse:hh,parseAllDocuments:dh,parseDocument:al,stringify:ph,visit:Jt,visitAsync:hr},Symbol.toStringTag,{value:"Module"}));class yh{constructor(){this.mistakes=[],this.taxonomy={}}async initialize(){this.mistakes=await nu(),this._buildTaxonomy(),console.log(`MistakeManager initialized with ${this.mistakes.length} mistakes.`)}async loadFromYAML(e){try{const t=mh.parse(e);if(!t.subject||!t.mistakes)throw new Error("YAML must contain 'subject' and 'mistakes' keys.");const s=t.mistakes.map(a=>this._normalizeMistake(a,t.subject)),i=new Map(this.mistakes.map(a=>[a.uuid,a]));return s.forEach(a=>i.set(a.uuid,a)),this.mistakes=Array.from(i.values()),await su(this.mistakes),this._buildTaxonomy(),{success:!0,count:s.length}}catch(t){return console.error("Failed to load from YAML:",t),{success:!1,error:t.message}}}_normalizeMistake(e,t){if(e.simple_problem){const i=e.simple_problem;return{uuid:crypto.randomUUID(),title:i.problem.substring(0,30)+(i.problem.length>30?"...":""),problem:i.problem,attachments:[],my_answer:{content:""},correct_answer:{content:i.answer,explanation:""},analysis:{reason_for_error:"知识点模糊",difficulty:i.difficulty||3},tags:i.tags||[],subject:t,is_simple:!0,review:{due:Date.now(),interval:0,easeFactor:2.5,state:"new"}}}const s={...e,subject:t};return s.review||(s.review={due:Date.now(),interval:0,easeFactor:2.5,state:"new"}),s.uuid||(s.uuid=crypto.randomUUID()),s}_buildTaxonomy(){const e={};this.mistakes.forEach(t=>{var s,i;t.subject&&(e[t.subject]||(e[t.subject]={tags:new Set,reasons:new Set}),(s=t.tags)==null||s.forEach(a=>e[t.subject].tags.add(a)),(i=t.analysis)!=null&&i.reason_for_error&&e[t.subject].reasons.add(t.analysis.reason_for_error))}),this.taxonomy=e}getFilteredMistakes(e={}){const{subject:t="all",tags:s=[],reasons:i=[]}=e;return this.mistakes.filter(a=>{var c;return!(t!=="all"&&a.subject!==t||s.length>0&&!s.every(f=>{var p;return(p=a.tags)==null?void 0:p.includes(f)})||i.length>0&&!i.includes((c=a.analysis)==null?void 0:c.reason_for_error))}).sort((a,c)=>a.review.due-c.review.due)}async updateReviewStatus(e,t){const s=this.mistakes.find(a=>a.uuid===e);if(!s)return null;const i=qa(s.review,t);return s.review={...s.review,...i},s.lastReviewed=Date.now(),await ru(s),s}getTaxonomy(){return this.taxonomy}}class gh{constructor(){this.elements={subjectFilter:document.getElementById("subject-filter"),tagFilterContainer:document.querySelector('.filter-group[data-type="tags"] .tag-list'),reasonFilterContainer:document.querySelector('.filter-group[data-type="reasons"] .tag-list'),listContainer:document.querySelector("#mistakes-list"),previewContainer:document.getElementById("mistakes-preview"),paginationContainer:document.querySelector(".pagination"),statsContainer:document.getElementById("statistics-dashboard")}}renderFilters(e,t){this.elements.subjectFilter.innerHTML='<option value="all">所有科目</option>',Object.keys(e).sort().forEach(i=>{const a=new Option(i,i);a.selected=i===t,this.elements.subjectFilter.add(a)});const s=e[t]||{tags:new Set,reasons:new Set};this._renderFilterAccordion(this.elements.tagFilterContainer,"知识点标签",Array.from(s.tags).sort()),this._renderFilterAccordion(this.elements.reasonFilterContainer,"错误原因",Array.from(s.reasons).sort())}_renderFilterAccordion(e,t,s){e.innerHTML=`
            <details class="filter-accordion-item" open>
                <summary>
                    <span><i class="fas fa-tags"></i> ${t}</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </summary>
                <div class="tag-list-content">
                    ${s.map(i=>`<div class="tag" data-value="${i}">${i}</div>`).join("")}
                </div>
            </details>
        `}_renderFilterItems(e,t){e.innerHTML="",t.forEach(s=>{const i=document.createElement("div");i.className="tag",i.textContent=s,i.dataset.value=s,e.appendChild(i)})}renderMistakeList(e){const t=this.elements.listContainer;if(t.innerHTML="",e.length===0){t.innerHTML=`
                <li class="session-item-placeholder">
                    <i class="fas fa-check-circle"></i>
                    <p>没有符合条件的错题</p>
                    <span>尝试放宽筛选条件或导入新的错题。</span>
                </li>
            `;return}e.forEach(s=>{const i=document.createElement("li");i.className="session-item",i.dataset.id=s.uuid;const{className:a,text:c}=this._getDueDateStatus(s.review.due);i.innerHTML=`
                <div class="item-icon-wrapper">
                    <i class="fas fa-book-medical item-icon"></i>
                </div>
                <div class="item-content">
                    <div class="item-title">${s.title}</div>
                    <div class="item-meta">
                        <span class="meta-info ${a}">${c}</span>
                        <span class="meta-info">${s.subject||"未分类"}</span>
                    </div>
                </div>
            `,t.appendChild(i)})}_getDueDateStatus(e){const t=new Date(e),s=new Date;t.setHours(0,0,0,0),s.setHours(0,0,0,0);const i=t.getTime()-s.getTime(),a=Math.ceil(i/(1e3*60*60*24));return a<0?{className:"status-overdue",text:`过期${Math.abs(a)}天`}:a===0?{className:"status-today",text:"今天"}:a===1?{className:"status-soon",text:"明天"}:{className:"status-future",text:`${a}天后`}}setActiveListItem(e){if(this.elements.listContainer.querySelectorAll(".mistake-list-item.active").forEach(t=>t.classList.remove("active")),e){const t=this.elements.listContainer.querySelector(`.mistake-list-item[data-id="${e}"]`);t==null||t.classList.add("active")}}renderMistakePreview(e){this.elements.previewContainer.innerHTML="",e.forEach(t=>{const s=this._createMistakeCard(t);this.elements.previewContainer.appendChild(s)})}_createMistakeCard(e){var s,i,a,c,f;const t=document.createElement("div");return t.className="mistake-card",t.dataset.id=e.uuid,t.innerHTML=`
            <div class="problem-section">
                <div class="problem-header">
                    <h4>${e.title}</h4>
                    <div class="problem-meta">
                        <span class="meta-item reason">原因: ${e.analysis.reason_for_error}</span>
                        <span class="meta-item difficulty">难度: ${"★".repeat(e.analysis.difficulty)}${"☆".repeat(5-e.analysis.difficulty)}</span>
                    </div>
                </div>
                <div class="problem-content">${mi.parse(e.problem||"")}</div>
                ${((s=e.attachments)==null?void 0:s.map(p=>this._renderAttachment(p)).join(""))||""}
                <div class="problem-tags">
                    ${((i=e.tags)==null?void 0:i.map(p=>`<span class="tag">${p}</span>`).join(""))||""}
                </div>
                <div class="my-answer-preview"><strong>我的答案:</strong> ${((a=e.my_answer)==null?void 0:a.content)||"未作答"}</div>
                <button class="show-answer-btn">显示答案</button>
            </div>

            <div class="answer-section hidden">
                <div class="correct-answer">
                    <strong>正确答案:</strong>
                    <div class="content">${mi.parse(((c=e.correct_answer)==null?void 0:c.content)||"")}</div>
                </div>
                <div class="correct-explanation">
                    <strong>解析:</strong>
                    <div class="content">${mi.parse(((f=e.correct_answer)==null?void 0:f.explanation)||"")}</div>
                </div>
                <div class="review-actions">
                    <button class="review-btn redo" data-rating="0">重做 (10m)</button>
                    <button class="review-btn hard" data-rating="1">困难</button>
                    <button class="review-btn medium" data-rating="2">犹豫</button>
                    <button class="review-btn easy" data-rating="3">简单</button>
                </div>
            </div>
        `,t}_renderAttachment(e){return e.type==="image"?`<img src="${e.url}" alt="错题附件" class="problem-image">`:""}_formatDueDate(e){const t=new Date(e),s=new Date;s.setHours(0,0,0,0);const i=Math.ceil((t-s)/(1e3*60*60*24));return i===0?"今天":i===1?"明天":i>1&&i<7?`${i}天后`:i<0?`${Math.abs(i)}天前`:t.toLocaleDateString()}toggleAnswer(e,t){const s=e.querySelector(".answer-section"),i=e.querySelector(".show-answer-btn");t?(s.classList.remove("hidden"),i.classList.add("hidden")):(s.classList.add("hidden"),i.classList.remove("hidden"))}updateCardAfterReview(e,t,s){s!==3&&this.toggleAnswer(e,!1),e.querySelector(".review-actions").insertAdjacentHTML("afterend",'<div class="update-feedback">已更新!</div>'),setTimeout(()=>{var a;(a=e.querySelector(".update-feedback"))==null||a.remove()},1500)}updateListItem(e,t){const s=this.elements.listContainer.querySelector(`[data-id="${e}"]`);s&&(s.querySelector(".mistake-due-date").textContent=`复习: ${this._formatDueDate(t.review.due)}`)}renderPagination(e,t,s){this.elements.paginationContainer.innerHTML="";const i=Math.ceil(e/s);if(!(i<=1))for(let a=1;a<=i;a++){const c=document.createElement("button");c.className="page-btn",c.textContent=a,c.dataset.page=a,a===t&&c.classList.add("active"),this.elements.paginationContainer.appendChild(c)}}}const Ce=n=>document.getElementById(n),Ar=n=>document.querySelector(n);Ce("mistakes-view");const Oa=Ar("#mistakes-view .session-sidebar"),Ii=Ce("subject-filter"),Vs=Ar('#mistakes-view .filter-group[data-type="tags"] .tag-list'),Ys=Ar('#mistakes-view .filter-group[data-type="reasons"] .tag-list'),Ti=Ce("mistakes-list"),Ai=Ar("#mistakes-view .pagination"),Js=Ce("mistakes-preview"),Na=Ce("mistake-editor-panel"),bt=Ce("yaml-editor"),Gs=Ce("mistakeToggleSessionBtn"),Yn=Ce("mistakeSaveBtn"),Li=Ce("mistakeExportBtn"),Jn=Ce("mistakeCollapseBtn"),Ci=Ce("refresh-mistakes-btn"),Oi=Ce("load-yaml-btn"),Ws=Ce("yaml-file-input"),Ni=Ce("newMistakeFileBtn"),$i=Ce("mistakeStartReviewBtn"),Pi=Ce("mistakeReviewOptionsBtn"),$a=Ce("mistakeReviewDropdownMenu");class vh{constructor(e,t,s){this.manager=e,this.ui=t,this.stats=s,this.filters={subject:"all",tags:[],reasons:[]},this.currentPage=1,this.pageSize=5,this.previewDebounceTimer=null}init(){Ni==null||Ni.addEventListener("click",this._handleNewMistakeFile.bind(this)),Gs==null||Gs.addEventListener("click",this._handleToggleSidebar.bind(this)),Yn==null||Yn.addEventListener("click",this._handleSaveFromYaml.bind(this)),Li==null||Li.addEventListener("click",this._handleExportToYaml.bind(this)),Jn==null||Jn.addEventListener("click",this._handleCollapseEditor.bind(this)),Ci==null||Ci.addEventListener("click",this.refreshView.bind(this)),Oi==null||Oi.addEventListener("click",()=>Ws.click()),Ws==null||Ws.addEventListener("change",this._handleFileLoad.bind(this)),bt==null||bt.addEventListener("input",this._handleEditorInput.bind(this)),Ii==null||Ii.addEventListener("change",this._handleSubjectChange.bind(this)),Vs==null||Vs.addEventListener("click",this._handleFilterTagClick.bind(this,"tags")),Ys==null||Ys.addEventListener("click",this._handleFilterTagClick.bind(this,"reasons")),Ti==null||Ti.addEventListener("click",this._handleMistakeListClick.bind(this)),Js==null||Js.addEventListener("click",this._handlePreviewClick.bind(this)),Ai==null||Ai.addEventListener("click",this._handlePaginationClick.bind(this)),$i==null||$i.addEventListener("click",()=>alert("错题本复习功能待实现！")),Pi==null||Pi.addEventListener("click",()=>$a.style.display=$a.style.display==="none"?"block":"none"),this.refreshView()}async refreshView(){var f;const e=this.stats.getDashboardHtml(this.manager.mistakes),t=document.querySelector("#mistakes-preview-panel .panel-header");(f=t.querySelector(".stats-dashboard-inline"))==null||f.remove(),t.insertAdjacentHTML("afterend",`<div class="stats-dashboard-inline">${e}</div>`);const s=this.manager.getFilteredMistakes(this.filters),i=(this.currentPage-1)*this.pageSize,a=i+this.pageSize,c=s.slice(i,a);this.ui.renderMistakeList(c),this.ui.renderMistakePreview(c),this.ui.renderPagination(s.length,this.currentPage,this.pageSize)}_handleToggleSidebar(){Oa.classList.toggle("hidden-session");const e=Oa.classList.contains("hidden-session");Gs.innerHTML=e?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}_handleNewMistakeFile(){const e=prompt("请输入新错题文件的标题:","未命名错题集");if(!e||e.trim()==="")return;const t=`
mistakes:
  - title: "二次函数图像与系数关系"
    problem: |
      已知二次函数 $y = ax^2 + bx + c$ 的图像如图所示，下列结论中正确的是？
      A. $a > 0, c > 0$
      B. $b^2 - 4ac < 0$
      C. $a - b + c > 0$
      D. $abc > 0$
    attachments:
      - type: image
        url: "function_graph.png"
    my_answer:
      content: "A"
    correct_answer:
      content: "C"
      explanation: |
        1. **开口方向**: 图像开口向上, $a > 0$
        2. **对称轴**: $x = -b/2a < 0$ → $b > 0$
        3. **与y轴交点**: $c < 0$
        4. **特殊点**: $x = -1$ 时, $y > 0$ → $a - b + c > 0$
    analysis:
      reason_for_error: "概念混淆"
      difficulty: 3
    tags: ["二次函数", "图像分析"]

  
  # 简易模式错题
  - simple_problem:
    - problem: "二次函数的定义是什么？"
      answer: "形如 y = ax^2 + bx + c (a≠0) 的函数"
      difficulty: 2
      tags: ["简易","二次函数", "定义"]
`.trim();bt.value=t,bt.focus()}async _handleSaveFromYaml(){const e=bt.value,t=await this.manager.loadFromYAML(e);t.success?(Yn.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>Yn.innerHTML='<i class="fas fa-save"></i>',2e3),this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()):alert(`保存失败: ${t.error}`)}_handleExportToYaml(){const e=bt.value,t=new Blob([e],{type:"text/yaml;charset=utf-8"});let s="mistake-export.yml";try{const a=e.match(/title:\s*["']?(.*?)["']?\s*\n/);a&&a[1]&&(s=`${a[1].replace(/[\/\\?%*:|"<>]/g,"-")}.yml`)}catch{}const i=document.createElement("a");i.href=URL.createObjectURL(t),i.download=s,i.click(),URL.revokeObjectURL(i.href)}_handleCollapseEditor(){Na.classList.toggle("collapsed");const e=Na.classList.contains("collapsed"),t=Jn.querySelector("i");t.className=e?"fas fa-chevron-down":"fas fa-chevron-up",Jn.title=e?"展开编辑器":"收起编辑器",e&&this._handleSaveFromYaml()}_handleEditorInput(){clearTimeout(this.previewDebounceTimer),this.previewDebounceTimer=setTimeout(()=>{console.log("Debounced: Ready to update preview from YAML editor content.")},500)}_handleSubjectChange(e){this.filters.subject=e.target.value,this.filters.tags=[],this.filters.reasons=[],this.currentPage=1,this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()}_handleFilterTagClick(e,t){const s=t.target.closest(".tag");if(!s)return;s.classList.toggle("active");const i=e==="tags"?Vs:Ys;this.filters[e]=Array.from(i.querySelectorAll(".tag.active")).map(a=>a.dataset.value),this.currentPage=1,this.refreshView()}_handleMistakeListClick(e){const t=e.target.closest(".mistake-list-item");if(!t)return;const s=t.dataset.id;this.ui.setActiveListItem(s);const i=Js.querySelector(`.mistake-card[data-id="${s}"]`);i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.classList.add("highlight"),setTimeout(()=>i.classList.remove("highlight"),1500))}_handlePaginationClick(e){const t=e.target.closest(".page-btn");t&&(this.currentPage=parseInt(t.dataset.page),this.refreshView())}async _handlePreviewClick(e){const t=e.target.closest(".mistake-card");if(!t)return;const s=t.dataset.id;e.target.matches(".show-answer-btn")&&this.ui.toggleAnswer(t,!0);const i=e.target.closest(".review-btn");if(i){const a=parseInt(i.dataset.rating),c=await this.manager.updateReviewStatus(s,a);c&&(this.ui.updateCardAfterReview(t,c,a),this.ui.updateListItem(s,c),a===0&&setTimeout(()=>this.ui.toggleAnswer(t,!1),500))}}_handleFileLoad(e){const t=e.target.files[0];if(!t)return;const s=new FileReader;s.onload=async i=>{await this._handleSaveFromYaml(i.target.result),bt.value=i.target.result},s.onerror=()=>alert("读取文件失败！"),s.readAsText(t),e.target.value=""}}class bh{constructor(){}generateStats(e){const t={total:e.length,bySubject:{},byReason:{},dueToday:0,overdue:0},s=new Date;s.setHours(23,59,59,999);const i=new Date;return i.setHours(0,0,0,0),e.forEach(a=>{t.bySubject[a.subject]=(t.bySubject[a.subject]||0)+1;const c=a.analysis.reason_for_error;t.byReason[c]=(t.byReason[c]||0)+1;const f=new Date(a.review.due);f<i?t.overdue++:f<=s&&t.dueToday++}),t}getDashboardHtml(e){const t=this.generateStats(e),s=Object.entries(t.byReason).sort((a,c)=>c[1]-a[1]).slice(0,3),i=Object.entries(t.bySubject).sort((a,c)=>c[1]-a[1]).slice(0,3);return`
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-chart-line"></i> 复习状态</div>
                <div class="stats-card-body">
                    <div class="stat-item"><span class="stat-value overdue">${t.overdue}</span><span class="stat-label">已过期</span></div>
                    <div class="stat-item"><span class="stat-value today">${t.dueToday}</span><span class="stat-label">今日到期</span></div>
                    <div class="stat-item"><span class="stat-value">${t.total}</span><span class="stat-label">总数</span></div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-book"></i> 科目分布</div>
                <div class="stats-card-body list-style">
                    ${i.length>0?i.map(([a,c])=>`<div class="list-item"><span>${a}</span><span class="list-value">${c}</span></div>`).join(""):"<span>暂无数据</span>"}
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-diagnoses"></i> 主要错误原因</div>
                <div class="stats-card-body list-style">
                    ${s.length>0?s.map(([a,c])=>`<div class="list-item"><span>${a}</span><span class="list-value">${c}</span></div>`).join(""):"<span>暂无数据</span>"}
                </div>
            </div>
        `}}async function wh(){console.log("Initializing Mistakes Management System...");const n=new gh,e=new bh(n),t=new yh;await t.initialize();const s=new vh(t,n,e),i=Object.keys(t.getTaxonomy())[0]||"all";s.filters.subject=i,n.renderFilters(t.getTaxonomy(),i),s.init(),console.log("Mistakes Management System is ready.")}const bn=Object.keys(ne.tables.reduce((n,e)=>({...n,[e.name]:!0}),{}));async function kh(){console.log("Starting database export for tables:",bn);const n={};return await ne.transaction("r",bn,async()=>{for(const e of bn)if(ne.table(e)){console.log(`Exporting table: ${e}`);const t=await ne.table(e).toArray();n[e]=t}}),console.log("Database export completed."),n}async function Sh(n){const e=Object.keys(n);if(e.length===0||!bn.some(t=>e.includes(t)))throw new Error("导入文件格式无效或不包含任何可识别的数据表。");console.log("Starting database import..."),await ne.transaction("rw",bn,async()=>{for(const t of bn)n[t]&&(console.log(`Clearing and importing table: ${t}`),await ne.table(t).clear(),await ne.table(t).bulkAdd(n[t]))}),console.log("Database import completed successfully.")}function Eh(n){const e=document.createElement("li");e.className="settings-nav-item",e.dataset.id=n.id,e.dataset.type=n.type;let t="fa-cog";return n.type==="apiConfig"?t="fa-key":n.type==="prompt"&&(t="fa-robot"),e.innerHTML=`<i class="fas ${t}"></i><span>${n.name}</span>`,e}function Pa(n,e,t){const s=document.createDocumentFragment(),i=document.createElement("div");i.className="settings-nav-group",i.innerHTML=`
        <h4 class="settings-nav-group-title">${n}</h4>
        <button class="add-item-btn" data-type="${t}"><i class="fas fa-plus"></i> 添加</button>
    `;const a=document.createElement("ul");return e.forEach(c=>a.appendChild(Eh(c))),i.appendChild(a),s.appendChild(i),s}function bo(){const n=J("settings-view"),e=J("settings-layout-template");if(!n||!e){console.error("Settings container or layout template not found.");return}if(n.children.length>0)return;n.innerHTML="",n.appendChild(e.content.cloneNode(!0));const t=Ie(".settings-nav-list");if(!t)return;t.innerHTML="";const s=document.createElement("li");s.className="settings-nav-item",s.dataset.id="general",s.dataset.type="general",s.innerHTML='<i class="fas fa-cogs"></i><span>应用设置</span>',t.appendChild(s);const i=B.apiConfigs.map(c=>({id:c.id,name:c.name,type:"apiConfig"})),a=B.prompts.map(c=>({id:c.id,name:c.name,type:"prompt"}));t.appendChild(Pa("API 配置",i,"apiConfig")),t.appendChild(Pa("角色配置",a,"prompt"))}function Lr(n,e=!1){const t=J("settings-detail-title"),s=J("settings-detail-content"),i=J("settings-save-btn");if(!s||!t||!i)return;i.style.display=n.type!=="general"?"inline-flex":"none";let a;if(n.type==="general")a="general-settings-form-template";else if(n.type==="apiConfig")a="api-config-form-template";else if(n.type==="prompt")a="prompt-form-template";else{s.innerHTML='<div class="placeholder-content"><i class="fas fa-exclamation-circle fa-2x"></i><p>未知的配置类型</p></div>';return}const c=J(a);if(!c){s.innerHTML=`<p>错误：未找到模板 #${a}。</p>`;return}s.innerHTML="",s.appendChild(c.content.cloneNode(!0)),n.type==="apiConfig"?_h(n,e):n.type==="prompt"&&Ih(n,e);const f=e?"fa-plus-circle":"fa-edit";t.innerHTML=`<i class="fas ${f}"></i> ${e?`创建${n.displayName}`:`编辑: ${n.displayName}`}`}function _h(n,e){const t=J("api-config-form-dynamic");if(!t)return;const s=t.querySelector(".config-provider");s.innerHTML="",Object.keys(Zi).forEach(i=>{const a=document.createElement("option");a.value=i,a.textContent=i,s.appendChild(a)}),e?(t.querySelector(".delete-item-btn").style.display="none",s.value="火山",s.dispatchEvent(new Event("change"))):(t.querySelector(".config-id").value=n.id,t.querySelector(".config-name").value=n.name,s.value=n.provider,t.querySelector(".config-apiUrl").value=n.apiUrl,t.querySelector(".config-apiKey").value=n.apiKey,t.querySelector(".config-models").value=n.models)}function Ih(n,e){const t=J("prompt-form-dynamic");if(!t)return;const s=t.querySelector(".config-model");s.innerHTML='<option value="">-- 请选择一个模型 --</option>',B.apiConfigs.forEach(i=>{if(!i.models)return;i.models.split(",").map(c=>c.trim()).filter(Boolean).forEach(c=>{const[f,p]=c.split(":").map(L=>L.trim());if(!f||!p)return;const m=document.createElement("option");m.value=`${i.id}:${f}`,m.textContent=`${i.name}: ${f} (${p})`,s.appendChild(m)})}),e?t.querySelector(".delete-item-btn").style.display="none":(t.querySelector(".config-id").value=n.id,t.querySelector(".config-name").value=n.name,t.querySelector(".config-avatar").value=n.avatar||"",t.querySelector(".config-model").value=n.model||"",t.querySelector(".config-systemPrompt").value=n.systemPrompt||"",t.querySelector(".config-hint").value=n.hint||"")}function _n(n,e,t){n&&(e?(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> 处理中...'):(n.disabled=!1,n.innerHTML=t))}let xi=null,et=null;function Th(n){document.documentElement.setAttribute("data-theme",n||"")}function Ah(n){localStorage.setItem("app-theme",n)}function cl(n){xi&&clearInterval(xi),n>0&&(xi=setInterval(Ju,n*60*1e3))}function Lh(n){const e=n.target.value;Th(e),Ah(e)}function Ch(n){const e=parseInt(n.target.value,10);if(isNaN(e)||e<0){n.target.value=B.settings.autoSaveInterval;return}re({settings:{...B.settings,autoSaveInterval:e}}),cl(e)}async function Oh(){const n=J("export-db-btn"),e=n.innerHTML;_n(n,!0,e);try{const t=await kh(),s=JSON.stringify(t,null,2),i=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(i),c=document.createElement("a");c.href=a;const f=new Date().toISOString().slice(0,10);c.download=`anki-suite-backup-${f}.json`,c.click(),URL.revokeObjectURL(a)}catch(t){console.error("导出数据库失败:",t),alert("导出数据时发生错误。")}finally{_n(n,!1,e)}}async function Nh(n){const e=J("import-db-btn"),t=J("import-file-input"),s=n.target.files[0];if(!s)return;if(!confirm("警告！导入将覆盖所有数据，此操作不可撤销。确定继续吗？")){t.value="";return}const i=e.innerHTML;_n(e,!0,i);const a=new FileReader;a.onload=async c=>{try{const f=JSON.parse(c.target.result);await Sh(f),alert("数据导入成功！应用将重新加载。"),window.dispatchEvent(new CustomEvent("app:dataImported"))}catch(f){console.error("导入数据库失败:",f),alert(`导入数据失败：${f.message}`)}finally{_n(e,!1,i)}},a.readAsText(s),t.value=""}function $h(n){const e=n.target.closest(".settings-nav-item");if(!e)return;document.querySelectorAll(".settings-nav-item.active").forEach(a=>a.classList.remove("active")),e.classList.add("active");const t=e.dataset.id,s=e.dataset.type;let i;if(s==="general"?i={id:"general",type:"general",displayName:"应用设置"}:s==="apiConfig"?i=B.apiConfigs.find(a=>a.id===t):s==="prompt"&&(i=B.prompts.find(a=>a.id===t)),i&&(et={...i,type:s},Lr(et),s==="general")){const a=J("theme-selector");a&&(a.value=localStorage.getItem("app-theme")||"");const c=J("autosave-interval");c&&(c.value=B.settings.autoSaveInterval)}}function Ph(n){const e=n.target.closest(".add-item-btn");if(!e)return;const t=e.dataset.type;let s="新项目";t==="apiConfig"?s="新 API 配置":t==="prompt"&&(s="新角色"),et={type:t,displayName:s},Lr(et,!0)}function xh(n){const e=n.target.closest("form");if(!e)return;const t=n.target.value,s=e.querySelector(".config-apiUrl");s&&(s.value=iu(t))}async function Mh(){if(!et)return;const n=J("settings-save-btn"),e=n.innerHTML;_n(n,!0,"保存中...");try{et.type==="apiConfig"?await Dh():et.type==="prompt"&&await Bh(),J("settings-view").innerHTML="",bo()}catch(t){console.error("Save failed:",t),alert(`保存失败: ${t.message}`)}finally{_n(n,!1,e)}}async function Dh(){const n=J("api-config-form-dynamic"),e={name:n.querySelector(".config-name").value,provider:n.querySelector(".config-provider").value,apiUrl:n.querySelector(".config-apiUrl").value,apiKey:n.querySelector(".config-apiKey").value,models:n.querySelector(".config-models").value},t=n.querySelector(".config-id").value;t?await Du(t,e):await Mu(e)}async function Bh(){const n=J("prompt-form-dynamic"),e={name:n.querySelector(".config-name").value,avatar:n.querySelector(".config-avatar").value,model:n.querySelector(".config-model").value,systemPrompt:n.querySelector(".config-systemPrompt").value,hint:n.querySelector(".config-hint").value},t=n.querySelector(".config-id").value;t?await Ru(t,e):await Ku(e)}async function jh(n){if(!n.target.closest(".delete-item-btn")||!et||!et.id)return;const{type:e,id:t,name:s}=et;let i=`你确定要删除 "${s}" 吗? 此操作无法撤销。`;if(confirm(i))try{e==="apiConfig"?await Bu(t):e==="prompt"&&await qu(t),J("settings-view").innerHTML="",bo(),Lr({},!1)}catch(a){console.error("Delete failed:",a),alert(`删除失败: ${a.message}`)}}function Kh(){const n=J("settings-view");n&&(n.addEventListener("click",e=>{const t=e.target;if(t.id==="export-db-btn"&&Oh(),t.id==="import-db-btn"&&J("import-file-input").click(),t.closest(".settings-nav-item")&&$h(e),t.closest(".add-item-btn")&&Ph(e),t.id==="settings-save-btn"&&Mh(),t.closest(".delete-item-btn")&&jh(e),t.closest(".toggle-api-key-visibility")){const s=t.closest(".input-group").querySelector("input");s.type=s.type==="password"?"text":"password"}}),n.addEventListener("change",e=>{const t=e.target;t.id==="theme-selector"&&Lh(e),t.id==="autosave-interval"&&Ch(e),t.id==="import-file-input"&&Nh(e),t.matches(".config-provider")&&xh(e)}))}function Rh(n){cl(B.settings.autoSaveInterval);let e;if((n==null?void 0:n.type)==="prompt"&&(n==null?void 0:n.action)==="create"){const s=Ie('.add-item-btn[data-type="prompt"]');if(s){s.click();return}}e='#settings-view .settings-nav-item[data-type="general"]';const t=Ie(e);t?t.click():Lr({},!1)}function xa(n=null){const e=J("settings-view");n&&(e.innerHTML=""),bo(),Rh(n),Kh(),console.log("✅ 设置模块已成功初始化/更新。")}const Ma={anki:!1,mistakes:!1,agent:!1,settings:!1};async function rr(n=null){console.log("[ViewChange] Switching to view:",B.activeView),Da.style.display="none",Ba.style.display="none",ja.style.display="none",Ka.style.display="none",Gn&&(Gn.style.display="none"),document.querySelectorAll(".app-nav-btn").forEach(i=>i.classList.remove("active"));const e=B.activeView||"anki",t=Ul[`${e}View`],s=document.getElementById(`nav-${e==="agent"?"agents":e}`);if(Ma[e])e==="settings"&&n&&(console.log("[Lazy Init] Re-initializing settings module with new context."),xa(n));else{console.log(`[Lazy Init] Initializing ${e} module for the first time.`);try{switch(e){case"anki":await Xf();break;case"agent":await od();break;case"mistakes":await wh();break;case"settings":xa(n);break}Ma[e]=!0}catch(i){console.error(`Failed to lazy-initialize ${e} view:`,i)}}t&&(t.style.display="flex"),s&&s.classList.add("active"),e==="agent"&&Gn&&(Gn.style.display="flex")}function qh(){document.querySelector(".app-nav").addEventListener("click",e=>{const t=e.target.closest(".app-nav-btn");if(!t)return;e.preventDefault();const s=t.dataset.view;s&&s!==B.activeView&&(ca(s),rr())}),window.addEventListener("app:navigateTo",e=>{const{view:t,context:s}=e.detail;t&&t!==B.activeView?(ca(t),rr(s)):t&&t===B.activeView&&s&&rr(s)})}function Fh(){window.addEventListener("beforeunload",()=>ji()),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ji()})}function Uh(){window.addEventListener("app:dataImported",async()=>{console.log("Event 'app:dataImported' received. Re-initializing app..."),alert("数据导入成功！应用将刷新以应用更改。"),location.reload()})}async function Hh(){document.body.classList.add("is-loading");try{await za(),await xu(),qh(),Fh(),Uh();const n=B.activeView||"anki";re({activeView:n}),await rr(),console.log("Application initialized successfully.")}catch(n){console.error("Application failed to initialize:",n);const e=document.createElement("div");e.className="error-overlay",e.innerHTML="...",document.body.innerHTML="",document.body.appendChild(e)}finally{document.body.classList.remove("is-loading")}}document.addEventListener("DOMContentLoaded",Hh);</script>
  <style rel="stylesheet" crossorigin>:root{--font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;--font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--leading-tight: 1.25;--leading-normal: 1.5;--leading-relaxed: 1.75;--primary-color: #5B66F5;--primary-hover: #4B55E3;--primary-light: #E8EAFF;--primary-dark: #3B41C5;--secondary-color: #6366F1;--secondary-light: #A5A7F3;--accent-color: #06B6D4;--accent-light: #E0F6FF;--gray-50: #F9FAFB;--gray-100: #F3F4F6;--gray-200: #E5E7EB;--gray-300: #D1D5DB;--gray-400: #9CA3AF;--gray-500: #6B7280;--gray-600: #4B5563;--gray-700: #374151;--gray-800: #1F2937;--gray-900: #111827;--sidebar-bg: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);--header-bg: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);--panel-header-bg: #4f46e5;--content-bg: #f8fafc;--success-color: #10B981;--success-light: #D1FAE5;--warning-color: #F59E0B;--warning-light: #FEF3C7;--danger-color: #EF4444;--danger-light: #FEE2E2;--bg-primary: #FFFFFF;--bg-secondary: #f1f5f9;--bg-tertiary: #F3F4F6;--bg-elevated: #FFFFFF;--text-primary: #111827;--text-secondary: #4B5563;--text-tertiary: #9CA3AF;--text-on-primary: #FFFFFF;--border-color: #E5E7EB;--border-radius: 8px;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .05);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);--transition: all .3s ease;--folder-color: #F59E0B;--file-color: #06B6D4;--sidebar-width: 56px;--agent-color-1: #5B66F5;--agent-color-2: #6366F1;--agent-color-3: #06B6D4;--agent-color-4: #8B5CF6;--agent-color-5: #EC4899;--topic-color-1: #F59E0B;--topic-color-2: #10B981;--topic-color-3: #3B82F6;--topic-color-4: #EF4444;--cloze-1d: #FEE2E2;--cloze-2d: #FED7AA;--cloze-3d: #FDE68A;--cloze-5d: #D9F99D;--cloze-7d: #BBF7D0;--cloze-14d: #BFDBFE;--cloze-28d: #E0E7FF;--cloze-28plus: #EDE9FE;--cloze-easy-open: #ECFDF5;--cloze-10m: #DC2626;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .05) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .05) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .05) 0%, transparent 50%)}[data-theme=dark]{--primary-light: rgba(91, 102, 245, .15);--accent-light: rgba(6, 182, 212, .1);--gray-50: #111827;--gray-100: #1F2937;--gray-200: #374151;--gray-300: #4B5563;--gray-400: #6B7280;--gray-500: #9CA3AF;--gray-600: #D1D5DB;--gray-700: #E5E7EB;--gray-800: #F3F4F6;--gray-900: #F9FAFB;--sidebar-bg: linear-gradient(135deg, #111827 0%, #1F2937 100%);--header-bg: linear-gradient(135deg, #374151 0%, #4B5563 100%);--panel-header-bg: #374151;--content-bg: #111827;--success-light: rgba(16, 185, 129, .15);--warning-light: rgba(245, 158, 11, .15);--danger-light: rgba(239, 68, 68, .15);--bg-primary: #1F2937;--bg-secondary: #111827;--bg-tertiary: #374151;--bg-elevated: #1F2937;--text-primary: #F9FAFB;--text-secondary: #D1D5DB;--text-tertiary: #9CA3AF;--border-color: #374151;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .3), 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .3), 0 2px 4px -1px rgba(0, 0, 0, .2);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .3), 0 4px 6px -2px rgba(0, 0, 0, .2);--cloze-1d: #4a1d1d;--cloze-2d: #543a1a;--cloze-3d: #574f20;--cloze-5d: #3a5323;--cloze-7d: #2a503a;--cloze-14d: #2c415e;--cloze-28d: #3c3e5e;--cloze-28plus: #444059;--cloze-easy-open: #224433;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .1) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .1) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .1) 0%, transparent 50%)}[data-theme=large-font]{--text-xs: .86rem;--text-sm: 1rem;--text-base: 1.125rem;--text-lg: 1.265rem;--text-xl: 1.406rem;--text-2xl: 1.687rem;--text-3xl: 2.1rem}[data-theme=larger-font]{--text-xs: .95rem;--text-sm: 1.1rem;--text-base: 1.25rem;--text-lg: 1.4rem;--text-xl: 1.56rem;--text-2xl: 1.875rem;--text-3xl: 2.34rem}*{margin:0;padding:0;box-sizing:border-box}html{height:100%}body{font-family:var(--font-primary);font-size:var(--text-base);line-height:var(--leading-normal);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:var(--bg-secondary);background-image:var(--body-bg-image);color:var(--text-primary);height:100vh;padding:0;display:flex;overflow:hidden}.container{max-width:1800px;margin:0 auto}.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);box-shadow:4px 0 24px #0000001f;border-right:none;display:flex;flex-direction:column;position:relative;z-index:100;overflow-x:hidden;flex-shrink:0}.sidebar.collapsed{transform:translate(-100%)}.main-content{flex:1;padding:0;min-height:0;min-width:0;display:flex;flex-direction:column;background:transparent}.main-content.expanded{margin-left:0}.content-wrapper{flex:1 1 auto;padding:20px;display:flex;flex-direction:column;min-height:0;overflow-y:auto;background:var(--content-bg);border-radius:16px 0 0;box-shadow:inset 0 1px 3px #0000000a}.main-layout{display:flex;gap:20px;flex-wrap:nowrap;flex:1;min-height:0;min-width:0}.main-layout.active{display:flex}.app-container{flex:1;display:flex;flex-direction:column;gap:20px;min-width:0;min-height:0}.footer{display:none}.audio-controls{position:fixed;bottom:20px;right:20px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);padding:15px;z-index:1000;display:none}.audio-title{margin-bottom:10px;font-weight:600;color:var(--secondary-color)}.audio-progress{width:300px;height:6px;background:var(--border-color);border-radius:3px;margin:10px 0;overflow:hidden}.audio-progress-bar{height:100%;background:var(--primary-color);width:0%;transition:width .1s linear}.audio-buttons{display:flex;justify-content:space-between}.audio-btn{background:var(--primary-color);color:var(--text-on-primary);border:none;padding:8px 15px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:5px}.audio-edit-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;margin-top:5px;transition:var(--transition)}.audio-edit-btn:hover{background:#4361ee33}.btn-primary,.btn-secondary,.btn-danger{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1rem;transition:var(--transition)}.btn-primary{background-color:var(--primary-color);color:var(--text-on-primary);font-weight:500}.btn-primary:hover{background-color:var(--primary-hover)}.btn-secondary{background-color:var(--gray-100);color:var(--text-secondary)}.btn-secondary:hover{background-color:var(--gray-200);color:var(--text-primary)}.btn-danger{background-color:var(--danger-color);color:var(--text-on-primary)}.btn-danger:hover{opacity:.85}.dropdown-menu{position:absolute;top:105%;right:0;background-color:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;padding:8px 0;min-width:180px;border:1px solid var(--border-color)}.dropdown-menu a{display:block;padding:10px 15px;color:var(--text-primary);text-decoration:none;transition:background-color .2s ease;font-size:.9rem}.dropdown-menu a:hover{background-color:var(--gray-100)}.dropdown-menu a i{margin-right:10px;color:var(--primary-color);width:20px;text-align:center}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-primary)}.form-control{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);width:100%;padding:10px 12px;border-radius:6px;font-size:var(--text-base);transition:var(--transition)}.form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.form-control.is-invalid{border-color:var(--danger-color)}.invalid-feedback{color:var(--danger-color);font-size:.85rem;margin-top:5px;display:none}.form-control.is-invalid+.invalid-feedback{display:block}.input-group{display:flex}.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}.input-group-btn{padding:0 12px;border:1px solid var(--border-color);border-left:none;background-color:var(--bg-tertiary);border-top-right-radius:6px;border-bottom-right-radius:6px;cursor:pointer}.form-check{display:flex;align-items:center;gap:8px;margin-top:15px}.form-checkbox-group{display:flex;flex-wrap:wrap;gap:10px 20px;padding:5px 0}.form-checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:2000;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}.modal-content{background:var(--bg-elevated);box-shadow:0 20px 40px #00000026;border-radius:var(--border-radius);width:90%;max-width:600px;display:flex;flex-direction:column;max-height:90vh;animation:slide-in .3s ease-out}.modal-header{padding:15px 25px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:var(--text-xl);color:var(--text-primary)}.modal-close{background:none;border:none;font-size:1.8rem;cursor:pointer;color:var(--text-tertiary)}.modal-body{padding:25px;overflow-y:auto}.modal-footer{padding:15px 25px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:10px}.delete-confirm-zone{margin-top:15px;padding:15px;background-color:#f443361a;border:1px solid var(--danger-color);border-radius:6px}.delete-confirm-zone #finalDeleteBtn{margin-top:10px;width:100%}.delete-confirm-zone #finalDeleteBtn:disabled{background-color:#ccc;cursor:not-allowed}.move-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:var(--transition)}.move-modal.active{opacity:1;pointer-events:all}.move-modal-content{background:var(--bg-elevated);border-radius:var(--border-radius);padding:20px;width:400px;max-width:90%;box-shadow:var(--shadow)}.move-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.move-modal-title{font-size:1.2rem;font-weight:600;color:var(--primary-color)}.move-modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-tertiary)}.folder-list{max-height:300px;overflow-y:auto;margin:15px 0;border:1px solid var(--border-color);border-radius:var(--border-radius);padding:10px}.folder-item{padding:8px 10px;border-radius:4px;margin-bottom:5px;background:var(--bg-primary);cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}.folder-item:hover{background:var(--bg-tertiary)}.folder-item.selected{background:#4361ee1a;border-left:3px solid var(--primary-color)}.move-modal-actions{display:flex;justify-content:flex-end;gap:10px}.move-modal-btn{padding:8px 15px;border-radius:4px;cursor:pointer;border:none;font-weight:500;transition:var(--transition)}.move-modal-btn.confirm{background:var(--primary-color);color:var(--text-on-primary)}.move-modal-btn.cancel{background:var(--gray-100);color:var(--text-primary)}.panel{background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 3px #0000000d;border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out}.panel.collapsed .panel-content{display:none}.panel.collapsed .collapse-btn i{transform:rotate(180deg)}.panel-header{background:var(--panel-header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 1px 3px #0000001a;padding:0 20px;display:flex;justify-content:space-between;align-items:center;height:60px;flex-shrink:0;position:relative}.panel-header:after{content:"";position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(to right,transparent,rgba(255,255,255,.2),transparent)}.panel-header .panel-title{flex-grow:1;justify-content:center;text-align:center}.panel-header .panel-actions-leading,.panel-header .panel-actions{flex-shrink:0;display:flex;gap:8px;align-items:center}.panel-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;gap:8px}.panel-actions{display:flex;gap:8px;align-items:center}.panel-actions .panel-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:4px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition)}.panel-actions .panel-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.panel-actions .panel-btn-text{width:auto;padding:0 15px;gap:8px}.panel-content{flex:1;padding:0;overflow:hidden;transition:var(--transition);display:flex;flex-direction:column;min-height:0}.collapse-btn i{transition:transform .3s ease}.tag{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-secondary);font-size:var(--text-sm);padding:6px 12px;border-radius:20px;cursor:pointer;transition:var(--transition)}.tag:hover{background:var(--gray-100);border-color:var(--gray-300)}.tag.active{background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-dark);box-shadow:0 2px 4px #5b66f533;font-weight:500}.toggle-list{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:var(--border-radius);margin:1.2em 0;overflow:hidden;box-shadow:0 1px 3px #0000000d}.toggle-list summary{padding:12px 18px;font-weight:600;color:var(--primary-color);background-color:var(--bg-tertiary);cursor:pointer;outline:none;list-style:none;display:flex;align-items:center;transition:background-color .2s ease;gap:8px}.toggle-list summary::-webkit-details-marker{display:none}.toggle-list summary:hover{background-color:var(--bg-primary)}.toggle-list summary:before{content:"▶";font-size:.8em;margin-right:12px;transform:rotate(0);transition:transform .2s ease-in-out;color:var(--accent-color)}.toggle-list[open]>summary:before{transform:rotate(90deg)}.toggle-list summary input[type=checkbox]{flex-shrink:0;margin:0;width:1.2em;height:1.2em;cursor:pointer}.toggle-title-text{flex-grow:1}.toggle-content{padding:15px 20px;border-top:1px solid var(--border-color)}.toggle-content>*:first-child{margin-top:0}.toggle-content>*:last-child{margin-bottom:0}.app-nav{display:flex;flex-direction:column;gap:8px;padding:20px 0;border-bottom:1px solid rgba(255,255,255,.1)}.app-nav-btn{background:#ffffff1a;color:#ffffffe6;border:1px solid rgba(255,255,255,.1);height:32px;width:32px;padding:0;margin:0 auto;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:600;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .3s cubic-bezier(.4,0,.2,1);text-decoration:none;overflow:hidden}.app-nav-btn:hover{background:#fff3;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #00000026}.app-nav-btn.active{background:#fffffff2;color:var(--primary-dark);border-color:transparent;box-shadow:0 4px 16px #ffffff4d}.app-nav-btn i{font-size:1.1rem;width:20px;text-align:center;flex-shrink:0}.app-nav-btn.active i{color:var(--primary-color)}.session-sidebar{width:300px;background:var(--bg-elevated);box-shadow:var(--shadow-md);border:1px solid rgba(0,0,0,.06);border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:var(--transition)}.session-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 2px 8px #4f46e526;padding:15px 20px;display:flex;flex-direction:column;gap:12px}.session-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;justify-content:space-between}.session-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}.session-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px;border-radius:4px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;width:36px;height:36px;transition:var(--transition)}.session-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.session-content{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;min-height:0;background:var(--bg-secondary)}.session-list-container{flex:1;display:flex;flex-direction:column;min-height:0}.session-list{list-style:none;margin-top:10px;overflow-y:auto;flex:1}.session-item{padding:12px 15px 12px 30px;border-radius:6px;margin-bottom:8px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;cursor:pointer;transition:var(--transition);position:relative}.session-item.folder{background:#ffd1661a;border-left:4px solid var(--folder-color);padding-left:26px}.session-item.file{background:#a1c4fd1a;border-left:4px solid var(--file-color);padding-left:26px}.session-item:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:60px;display:flex;align-items:center;gap:8px}.session-item .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}.session-item .edit-btn,.session-item .delete-btn,.session-item .move-btn{color:var(--text-tertiary);cursor:pointer;padding:4px;border-radius:4px;transition:var(--transition);background:#fff9;width:24px;height:24px;display:flex;align-items:center;justify-content:center}.session-item .edit-btn:hover{background:var(--accent-color);color:var(--text-on-primary)}.session-item .delete-btn:hover{background:var(--danger-color);color:var(--text-on-primary)}.session-item .move-btn:hover{background:var(--success-color);color:var(--text-on-primary)}.session-item input[type=text]{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:.95rem;background-color:var(--bg-primary);color:var(--text-primary)}.select-controls{display:flex;gap:8px;margin-top:10px;padding:8px 0;background:#ffffff1a;border-top:1px solid rgba(255,255,255,.2);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.select-all{display:flex;align-items:center;gap:5px;color:var(--text-on-primary);font-size:.85rem}.session-item .select-checkbox{margin-right:8px}.session-item .name-container{display:flex;flex:1;overflow:hidden}.folder-icon{color:var(--folder-color)}.file-icon{color:var(--file-color)}.nested-items{margin-left:20px;margin-top:8px;border-left:2px solid var(--border-color);padding-left:15px}.current-folder{margin-top:10px;padding:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:inset 0 1px 2px #0000000d;border-radius:4px;font-size:.9rem;color:var(--text-primary);display:flex;align-items:center;flex-wrap:wrap;gap:4px}.current-folder i{margin-right:5px;color:var(--folder-color)}.breadcrumb-link{color:var(--primary-color);cursor:pointer;text-decoration:none}.breadcrumb-link:hover{text-decoration:underline}.breadcrumb-separator{margin:0 4px;color:#6c757d}.breadcrumb-current{font-weight:700;color:var(--secondary-color)}.empty-session{text-align:center;padding:28px;color:var(--text-tertiary)}.empty-session i{font-size:2.8rem;margin-bottom:14px;color:var(--gray-300)}.editor-preview-panel{background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out;flex:1;min-height:0}.editor-preview-panel .panel-content{position:relative}.editor-preview-panel.preview-active #editor{display:none}.editor-preview-panel.preview-active #preview{display:block}.editor-preview-panel.preview-active .editor-sub-toolbar{display:none}.editor-panel,.preview-panel{flex:1;min-height:250px}.editor-panel.hidden{display:none}.editor-container{flex:1;display:flex;min-height:0;position:relative}#editor,#preview{position:absolute;top:0;left:0;width:100%;height:100%;margin:0;border:none;padding:15px;box-sizing:border-box;overflow:auto;background:transparent}#editor{z-index:10;font-family:var(--font-mono);font-size:var(--text-sm);color:var(--text-primary);resize:none;line-height:1.5;background-color:var(--bg-primary)}#editor:focus{outline:none;box-shadow:0 0 0 3px #4895ef33 inset}#preview{z-index:5;display:none;font-size:var(--text-base);line-height:var(--leading-relaxed);color:var(--text-primary);background-color:var(--bg-elevated)}#preview h1,#preview h2,#preview h3{margin-top:1.1em;margin-bottom:.7em;color:var(--text-primary);font-weight:700}#preview h1{font-size:var(--text-3xl)}#preview h2{font-size:var(--text-2xl)}#preview h3{font-size:var(--text-xl)}#preview p{margin-bottom:.9em}#preview code{background:var(--gray-100);color:var(--primary-color);padding:2px 5px;border-radius:4px;font-family:var(--font-mono);font-size:var(--text-sm)}#preview pre{background:var(--gray-50);color:var(--text-primary);padding:14px;border-radius:6px;overflow:auto;margin:1.4em 0;border:1px solid var(--border-color)}#preview blockquote{border-left:4px solid var(--primary-color);padding:10px 18px;background:var(--primary-light);margin:1.4em 0}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px 15px;border-bottom:1px solid var(--border-color);background:var(--bg-tertiary);flex-shrink:0}.editor-sub-toolbar .editor-btn{background:var(--bg-primary);border:1px solid var(--border-color);box-shadow:0 1px 2px #0000000d;padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem;color:var(--text-secondary)}.editor-sub-toolbar .editor-btn:hover:not(:disabled){background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-color);transform:translateY(-1px);box-shadow:0 4px 8px #5b66f540}.editor-sub-toolbar .editor-btn:disabled{opacity:.5;cursor:not-allowed}.mode-indicator{position:absolute;bottom:10px;right:10px;display:flex;gap:5px;z-index:20;background:#fffc;padding:5px 8px;border-radius:12px;box-shadow:0 2px 5px #0000001a}.mode-dot{width:10px;height:10px;border-radius:50%;background-color:var(--border-color)}.mode-dot.active{background-color:var(--primary-color)}.review-btn-group{display:flex;position:relative}.review-btn-group .main-action{border-top-right-radius:0;border-bottom-right-radius:0}.review-btn-group .dropdown-toggle{border-top-left-radius:0;border-bottom-left-radius:0;border-left:1px solid rgba(255,255,255,.3)}.cloze{padding:2px 6px;border-radius:4px;cursor:pointer;position:relative;transition:var(--transition);border:1px dashed rgba(67,97,238,.3);font-weight:700;background:var(--cloze-28plus)}.cloze.hidden .cloze-content{display:none}.cloze.hidden .placeholder{display:inline}.cloze:not(.hidden) .placeholder{display:none}.placeholder{color:var(--primary-color);font-weight:700}.cloze.temporary{animation:highlight .5s ease}.cloze.shown{background:linear-gradient(120deg,#d4fc79,#96e6a1)}.cloze.permanent{border:1px solid var(--success-color)}.cloze-1d{background:var(--cloze-1d)!important}.cloze-2d{background:var(--cloze-2d)!important}.cloze-3d{background:var(--cloze-3d)!important}.cloze-5d{background:var(--cloze-5d)!important}.cloze-7d{background:var(--cloze-7d)!important}.cloze-14d{background:var(--cloze-14d)!important}.cloze-28d{background:var(--cloze-28d)!important}.cloze-28plus{background:var(--cloze-28plus)!important}.cloze-10m{background-color:var(--cloze-10m)!important;border-color:#f33!important;animation:pulse-alert 1.5s infinite alternate;color:var(--text-on-primary)!important;font-weight:700}.cloze.easy-open{background-color:var(--cloze-easy-open)!important;border:1px dashed #C8E6C9;color:var(--text-primary)!important;font-weight:400;opacity:.9}.cloze.permanent-view{background-color:var(--primary-light)!important;border:1px solid var(--primary-color)!important;font-weight:400!important}.cloze.permanent-view .cloze-actions{display:none!important}.cloze-actions{display:flex;justify-content:space-between;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.08)}.cloze-btn{flex:1;padding:10px 5px;border-radius:20px;border:none;background-color:var(--bg-primary);cursor:pointer;font-size:.9rem;font-weight:600;text-align:center;transition:all .2s ease-in-out;outline:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;box-shadow:0 2px 4px #0000000d}.cloze-btn i{font-size:1.2rem;margin-bottom:5px}.cloze-btn.again{color:#e53935;background-color:#e539351a}.cloze-btn.again:hover{background-color:#e53935;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #e539354d}.cloze-btn.hard{color:#fb8c00;background-color:#fb8c001a}.cloze-btn.hard:hover{background-color:#fb8c00;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #fb8c004d}.cloze-btn.double{color:#43a047;background-color:#43a0471a}.cloze-btn.double:hover{background-color:#43a047;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #43a0474d}.cloze-btn.easy{color:#1e88e5;background-color:#1e88e51a}.cloze-btn.easy:hover{background-color:#1e88e5;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #1e88e54d}.ai-agent-nav{background:var(--bg-elevated);border:none;box-shadow:0 2px 8px #0000000f;border-radius:var(--border-radius);padding:12px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}.nav-title{color:var(--text-primary);font-size:var(--text-xl);color:var(--secondary-color);font-weight:600;display:flex;align-items:center;gap:10px}.nav-title i{color:var(--accent-color)}.agent-list{display:flex;gap:15px;overflow-x:auto;padding:5px 0}.agent-item{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));box-shadow:0 2px 8px #5b66f54d;color:var(--text-on-primary);padding:8px 20px;border-radius:30px;cursor:pointer;transition:var(--transition);font-size:.95rem;display:flex;align-items:center;gap:8px;white-space:nowrap}.agent-item:nth-child(2){background:linear-gradient(135deg,var(--accent-color),#0891b2)}.agent-item:nth-child(3){background:linear-gradient(135deg,var(--agent-color-4),var(--agent-color-5))}.agent-item:hover{transform:translateY(-3px);box-shadow:0 8px 16px #00000026}.agent-item.active{box-shadow:0 0 0 3px #fffc,0 5px 15px #0003}.nav-actions{display:flex;gap:12px}.nav-action-btn{background:var(--primary-color);color:var(--text-on-primary);border:none;padding:8px 15px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:var(--transition);font-size:.9rem}.nav-action-btn:hover{background:var(--secondary-color);transform:translateY(-2px)}.agent-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#4361ee,#3f37c9);display:flex;align-items:center;justify-content:center;color:var(--text-on-primary);font-weight:700;flex-shrink:0}.agent-content-container{display:flex;gap:20px;margin-bottom:20px;flex:1;min-height:0}.topics-panel{width:300px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}.topics-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:none;padding:15px 20px;font-size:var(--text-lg);font-weight:600}.topics-content{flex:1;padding:15px;overflow-y:auto}.topic-list{list-style:none}.topic-item{padding:12px 15px;border-radius:6px;margin-bottom:10px;background:var(--bg-secondary);border:1px solid var(--border-color);cursor:pointer;transition:var(--transition);position:relative;display:flex;align-items:center;gap:10px}.topic-item:hover{transform:translate(5px);background:var(--bg-elevated);box-shadow:0 2px 8px #0000000f}.topic-item.active{background:var(--primary-light);font-weight:600;border-left-color:var(--primary-color);border-left-width:4px}.topic-item:nth-child(1){border-left-color:var(--topic-color-1)}.topic-item:nth-child(2n){border-left-color:var(--topic-color-2)}.topic-item:nth-child(3n){border-left-color:var(--topic-color-3)}.topic-item:nth-child(4n){border-left-color:var(--topic-color-4)}.topic-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--text-on-primary);font-size:.8rem;flex-shrink:0}.topic-item:nth-child(1) .topic-icon{background:var(--topic-color-1)}.topic-item:nth-child(2) .topic-icon{background:var(--topic-color-2)}.topic-item:nth-child(3) .topic-icon{background:var(--topic-color-3)}.topic-item:nth-child(4) .topic-icon{background:var(--topic-color-4)}.history-panel{flex:1;background:var(--bg-elevated);border-radius:var(--border-radius);border:1px solid var(--border-color);display:flex;flex-direction:column;position:relative;min-width:0}.history-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:1px solid var(--border-color);padding:15px 20px;display:flex;justify-content:space-between;align-items:center}.history-title{font-size:var(--text-lg);font-weight:600;display:flex;align-items:center;gap:10px}.history-header-actions{display:flex;align-items:center;gap:10px}.header-action-btn{background:var(--gray-100);border:none;color:var(--text-secondary);width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}.header-action-btn:hover{background:var(--gray-200);transform:rotate(45deg)}.history-search{padding:8px 15px;border-radius:20px;border:none;width:250px;font-size:.9rem;background:#ffffffe6;box-shadow:0 2px 4px #0000001a;color:var(--text-primary)}.history-search:focus{background:var(--bg-elevated);box-shadow:0 4px 12px #00000026;outline:none}.history-content{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:20px;min-height:0;background:var(--bg-secondary)}.history-item{padding:15px;border-radius:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000a;border-left:3px solid var(--primary-color)}.history-item.highlighted{transition:background-color .5s ease;background-color:var(--primary-light);border-color:var(--accent-color)}.history-item-header{display:flex;justify-content:space-between;margin-bottom:10px;color:var(--text-tertiary);font-size:.9rem}.history-item-content{line-height:1.6}.history-item-content img{max-width:100%;border-radius:8px;margin-top:10px}.history-item-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}.history-action-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;transition:var(--transition)}.history-action-btn:hover{background:#4361ee33}.chat-navigation{position:absolute;bottom:90px;right:25px;display:flex;flex-direction:column;gap:10px;z-index:10}.chat-nav-btn{width:40px;height:40px;border-radius:50%;background-color:var(--primary-color);color:var(--text-on-primary);border:none;cursor:pointer;box-shadow:0 2px 10px #0003;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:1rem}.chat-nav-btn:hover{background-color:var(--primary-hover);transform:scale(1.1)}.chat-nav-btn:disabled{opacity:.5;cursor:not-allowed}.chat-input-area{padding:15px 20px;border-top:1px solid var(--border-color);background:linear-gradient(to bottom,transparent,var(--bg-secondary));display:flex;flex-direction:column;gap:10px;flex-shrink:0}.input-controls{display:flex;align-items:flex-end;gap:10px}.chat-textarea{flex:1;border:2px solid var(--border-color);padding:10px 15px;font-family:inherit;font-size:var(--text-base);line-height:1.5;resize:vertical;transition:var(--transition);background:var(--bg-primary);color:var(--text-primary);border-radius:var(--border-radius)}.chat-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px #5b66f51a}.chat-action-btn{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:var(--transition);background:var(--gray-100);color:var(--text-secondary);flex-shrink:0}.chat-action-btn:hover{background:var(--gray-200);transform:translateY(-2px)}.chat-action-btn.send{background-color:var(--primary-color);color:var(--text-on-primary)}.chat-action-btn.send:hover{background-color:var(--secondary-color)}.attachment-preview-container{display:flex;gap:8px;flex-wrap:wrap;max-height:100px;overflow-y:auto}.attachment-preview-item{background:var(--bg-tertiary);padding:5px 12px;border-radius:15px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px;color:var(--text-primary);animation:fadeIn .3s ease}.attachment-preview-item i{color:var(--primary-color)}.remove-attachment-btn{cursor:pointer;font-weight:700;color:var(--text-tertiary);background:none;border:none;font-size:1.2rem;line-height:1;padding:0 2px;transition:var(--transition)}.remove-attachment-btn:hover{color:var(--danger-color);transform:scale(1.2)}.mistakes-nav{width:25%;min-width:300px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}.nav-header{background:var(--header-bg);color:var(--text-on-primary);padding:15px 20px;display:flex;flex-direction:column;gap:12px}.nav-content{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:20px}.filter-accordion-item{border-bottom:1px solid var(--border-color)}.filter-accordion-item summary{display:flex;justify-content:space-between;align-items:center;padding:14px 5px;cursor:pointer;list-style:none;font-weight:600;color:var(--secondary-color)}.filter-accordion-item .tag-list{padding:10px 5px 15px;background-color:var(--bg-secondary);display:flex;flex-wrap:wrap;gap:8px}.mistakes-list{flex:1;overflow-y:auto;padding-top:15px;border-top:1px solid var(--border-color)}.mistake-item{background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:0 1px 2px #0000000a;padding:12px 15px;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:var(--transition);position:relative}.mistake-item:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;border-left-color:var(--primary-color);border-left-width:3px;transform:translate(3px)}.mistake-item.active{background:var(--primary-light);border-color:var(--primary-color);font-weight:600}.mistake-title{font-weight:500;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.mistake-meta{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-tertiary)}#yaml-editor{flex:1;min-height:150px;padding:14px;font-family:Consolas,Courier New,monospace;font-size:15px;border:1px solid var(--border-color);border-radius:6px;resize:none;line-height:1.5;background-color:var(--bg-primary);color:var(--text-primary)}#mistakes-preview{flex:1;overflow-y:auto;padding:15px}.mistakes-preview-container{padding:15px}.stats-dashboard-inline{display:flex;gap:15px;padding:15px;background-color:var(--bg-secondary);border-bottom:1px solid var(--border-color)}.stats-card{flex:1;background-color:var(--bg-elevated);border-radius:8px;border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000d;overflow:hidden}.stats-card-header{font-size:.9rem;font-weight:600;padding:8px 12px;background-color:var(--bg-tertiary);border-bottom:1px solid var(--border-color);color:var(--text-secondary)}.stats-card-header i{margin-right:8px;color:var(--primary-color)}.stats-card-body{padding:12px;display:flex;justify-content:space-around;align-items:center}.stats-card-body.list-style{flex-direction:column;align-items:stretch;gap:8px}.stat-item{display:flex;flex-direction:column;align-items:center;gap:4px}.stat-value{font-size:1.5rem;font-weight:700;color:var(--text-primary)}.stat-value.overdue{color:#d90429}.stat-value.today{color:#f77f00}.stat-label{font-size:.8rem;color:var(--text-tertiary)}.list-item{display:flex;justify-content:space-between;font-size:.85rem}.list-value{font-weight:600;padding:2px 6px;background-color:var(--bg-tertiary);border-radius:4px}.editor-toolbar{display:flex;justify-content:space-between;align-items:center;padding:10px 18px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-color)}.toolbar-left,.toolbar-right{display:flex;gap:10px}.toolbar-middle{flex:1;display:flex;justify-content:center;gap:10px}.editor-btn{background:var(--bg-primary);border:1px solid var(--border-color);padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem;color:var(--text-secondary)}.editor-btn:hover:not(:disabled){background:var(--accent-color);color:var(--text-on-primary);border-color:var(--accent-color)}.editor-btn:disabled{opacity:.5;cursor:not-allowed}.editor-btn-text{width:40px;height:40px;padding:0;font-size:0}.editor-btn-text i{font-size:.9rem;margin:0}.review-btn-group .editor-btn-text,.review-btn-group .dropdown-toggle{width:auto;padding:8px 15px;font-size:.9rem}#reviewOptionsBtn.dropdown-toggle{padding:8px 12px}#startReviewBtn.editor-btn-text{gap:8px}#startReviewBtn.editor-btn-text i{font-size:.9rem}.instructions{background:var(--bg-elevated);padding:22px;border-radius:var(--border-radius);box-shadow:var(--shadow);margin-top:25px}.instructions h2{color:var(--secondary-color);margin-bottom:18px;text-align:center;font-size:1.4rem}.instructions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px}.instruction-card{background:var(--bg-primary);border-radius:var(--border-radius);padding:18px;box-shadow:0 2px 8px #00000014;transition:var(--transition)}.instruction-card:hover{transform:translateY(-4px);box-shadow:0 6px 15px #0000001a}.instruction-card h3{color:var(--primary-color);margin-bottom:14px;display:flex;align-items:center;gap:8px;font-size:1.1rem}.instruction-card h3 i{background:var(--primary-color);color:var(--text-on-primary);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem}.media-icon{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;margin-right:5px;background:#4361ee1a;border-radius:50%;color:var(--primary-color);cursor:pointer;transition:var(--transition)}.media-icon:hover{background:#4361ee33;transform:scale(1.1)}.global-review-area{margin:15px 0;display:flex;justify-content:center}.settings-section{margin-bottom:30px;max-width:600px}.settings-section-title{font-size:var(--text-xl);color:var(--text-primary);border-bottom:2px solid var(--primary-light);padding-bottom:10px;margin-bottom:20px;font-weight:600}.file-input{display:none}.hidden-session{transform:translate(calc(-1 * var(--session-width) - 25px));opacity:0;width:0;overflow:hidden}.panel-btn.active{background-color:#ffffff4d;transform:scale(1.1)}.panel-btn{transition:all .3s ease}.panel-btn i{transition:color .3s ease}.edit-mode .panel-btn i.fa-eye{color:#4caf50}.preview-mode .panel-btn i.fa-eye{color:#ff9800}.btn-label{transition:all .3s ease}.panel-btn:hover i{transform:scale(1.1)}#toggleEditPreviewBtn{background:linear-gradient(135deg,#4361ee,#3f37c9);color:var(--text-on-primary);border-radius:20px;padding:8px 15px}#toggleEditPreviewBtn:hover{background:linear-gradient(135deg,#3f37c9,#4361ee)}.session-item-details{margin-bottom:8px;list-style:none}.session-item-details summary{list-style:none;cursor:pointer;outline:none;padding:12px 15px;border-radius:6px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;transition:var(--transition);position:relative}.session-item-details summary::-webkit-details-marker{display:none}.session-item-details summary:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item-details summary.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item-details summary .name:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900;margin-right:10px;transition:transform .2s ease-in-out;display:inline-block;color:var(--text-tertiary)}.session-item-details[open]>summary .name:before{transform:rotate(90deg)}.h2-item{padding-left:40px;border-left:2px solid var(--border-color);margin-left:15px}.h2-item .name i{color:var(--text-secondary)}.nested-items{margin-left:0;padding-left:0;border-left:none}@keyframes highlight{0%{background:#fff9c4}to{background:linear-gradient(120deg,#a1c4fd,#c2e9fb)}}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes slide-in{0%{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}@media (max-width: 1400px){.btn-label{opacity:0;width:0;margin:0;padding:0}}@media (max-width: 1200px){body{flex-direction:column;height:auto;min-height:100vh}.sidebar{position:relative;width:100%;min-height:auto;flex-direction:row;align-items:center;background:var(--sidebar-bg)}.app-nav{flex-direction:row;padding:15px;flex:1;justify-content:center;background:#0000001a;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.app-nav-btn{margin:0 4px}.main-content{margin-left:0}.main-layout{flex-direction:column}.session-sidebar{width:100%;max-width:100%;max-height:40vh}.app-container{min-width:100%}.mistakes-nav{width:100%;max-width:100%}}@media (max-width: 992px){.mistakes-nav{max-height:40vh;min-width:0}}@media (max-width: 768px){.panel-header{flex-direction:column;align-items:flex-start;gap:10px;height:auto;padding:10px}.panel-actions{width:100%;justify-content:flex-end;flex-wrap:wrap}.editor-toolbar{flex-direction:column;gap:10px}.toolbar-left,.toolbar-middle,.toolbar-right{width:100%;justify-content:center}.panel-header .panel-title,.panel-actions{justify-content:center}.app-nav{flex-wrap:wrap}}.cloze.cloze-error-duplicate{border:2px solid var(--danger-color, #EF4444)!important;background-color:var(--danger-light, #FEE2E2)!important;animation:pulse-error 1s infinite alternate}.cloze.cloze-error-duplicate .placeholder{color:var(--danger-color, #EF4444)!important;font-weight:700}@keyframes pulse-error{0%{box-shadow:0 0 #ef444466}to{box-shadow:0 0 0 5px #ef444400}}#settings-view.main-layout{display:flex;gap:20px;height:100%;flex:1}.settings-nav-panel{width:280px;flex-shrink:0;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--border-radius);box-shadow:var(--shadow-sm);display:flex;flex-direction:column}.settings-nav-header{padding:20px;border-bottom:1px solid var(--border-color)}.settings-nav-header h3{font-size:var(--text-xl);color:var(--text-primary)}.settings-nav-list{padding:10px;overflow-y:auto;flex:1}.settings-nav-group{margin-bottom:20px}.settings-nav-group-title{padding:10px;font-size:var(--text-sm);font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}.add-item-btn{width:calc(100% - 20px);margin:0 10px 10px;padding:8px;background:var(--primary-light);color:var(--primary-color);border:1px dashed var(--primary-color);border-radius:6px;cursor:pointer;text-align:center;font-weight:600;transition:var(--transition)}.add-item-btn:hover{background:var(--primary-color);color:var(--text-on-primary);border-style:solid}.settings-nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:6px;cursor:pointer;transition:background-color .2s ease,color .2s ease;color:var(--text-secondary);font-weight:500;margin-bottom:4px}.settings-nav-item i{width:20px;text-align:center;color:var(--gray-400)}.settings-nav-item:hover{background-color:var(--bg-secondary);color:var(--text-primary)}.settings-nav-item.active{background-color:var(--primary-color);color:var(--text-on-primary);box-shadow:0 4px 8px #5b66f533}.settings-nav-item.active i{color:var(--text-on-primary)}.settings-detail-panel{flex:1;min-width:0;height:100%;display:flex;flex-direction:column}.settings-detail-panel .panel-content{flex-grow:1;overflow-y:auto}.placeholder-content{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center}</style>
</head>
<body>
    <!-- 左侧导航栏 -->
    <div class="sidebar">
        
        <nav class="app-nav">
            <a href="#" class="app-nav-btn active" data-view="anki" id="nav-anki" title="Anki 笔记">
                <i class="fas fa-layer-group"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="mistakes" id="nav-mistakes" title="错题本">
                <i class="fas fa-book"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="agent" id="nav-agents" title="AI角色">
                <i class="fas fa-robot"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="settings" id="nav-settings" title="设置">
                <i class="fas fa-cog"></i>
            </a>
        </nav>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
            <!-- 1. 创建一个新的内容包装器 -->
    <div class="content-wrapper">
        <!-- AI Agent导航栏 (此部分在初始视图中可能隐藏) -->
        <nav class="ai-agent-nav">
            <div class="nav-title">
                <i class="fas fa-robot"></i> AI Agent管理
            </div>
            <div class="agent-list">
                <div class="agent-item active" data-agent="1">
                    <div class="agent-avatar">AI</div>
                    <span>数学学习助手</span>
                </div>
                <div class="agent-item" data-agent="2">
                    <div class="agent-avatar">MD</div>
                    <span>语言学习助手</span>
                </div>
                <div class="agent-item" data-agent="3">
                    <div class="agent-avatar">CS</div>
                    <span>计算机科学助手</span>
                </div>
                <div class="agent-item">
                    <div class="agent-avatar">+</div>
                    <span>添加新Agent</span>
                </div>
            </div>
            <div class="nav-actions">
                <button class="nav-action-btn">
                    <i class="fas fa-history"></i> 历史记录
                </button>
                <button class="nav-action-btn">
                    <i class="fas fa-cog"></i> 设置
                </button>
            </div>
        </nav>

        <!-- AI Agent内容区域 (此部分在初始视图中可能隐藏) -->
        <div class="agent-content-container main-layout" id="agent-view">
            <div class="topics-panel">
                <div class="topics-header">
                    <i class="fas fa-book"></i> 聊天主题
                </div>
                <div class="topics-content">
                    <ul class="topic-list">
                        <li class="topic-item active">
                            <div class="topic-icon"><i class="fas fa-calculator"></i></div>
                            <span>线性代数</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-infinity"></i></div>
                            <span>微积分</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-project-diagram"></i></div>
                            <span>概率统计</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-cube"></i></div>
                            <span>几何学</span>
                        </li>
                        <li class="topic-item">
                            <div class="topic-icon"><i class="fas fa-plus-circle"></i></div>
                            <span>添加新主题</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="history-panel">
                <div class="history-header">
                    <div class="history-title">
                        <i class="fas fa-comments"></i>
                        <span id="historyHeaderTitle">历史对话记录</span>
                    </div>
                    <div class="history-header-actions">
                        <input type="text" class="history-search" placeholder="搜索历史记录...">
                    </div>
                </div>
                <div class="history-content">
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>2023-10-15 14:30</span>
                            <span>线性代数 - 矩阵运算</span>
                        </div>
                        <div class="history-item-content">
                            <p><strong>用户:</strong> 请解释矩阵的逆是什么？</p>
                            <p><strong>AI助手:</strong> 矩阵的逆类似于数字的倒数。对于一个n×n矩阵A，如果存在另一个n×n矩阵B，使得AB = BA = I（单位矩阵），那么B就是A的逆矩阵，记作A⁻¹。只有方阵且行列式不为零的矩阵才有逆矩阵。</p>
                            <img src="https://via.placeholder.com/600x150/4361ee/ffffff?text=矩阵逆运算示例" alt="矩阵逆运算示例">
                        </div>
                        <div class="history-item-actions">
                            <button class="history-action-btn"><i class="fas fa-redo"></i> 重新生成</button>
                            <button class="history-action-btn"><i class="fas fa-edit"></i> 编辑</button>
                            <button class="history-action-btn"><i class="fas fa-trash"></i> 删除</button>
                        </div>
                    </div>
                </div>
                <div class="chat-navigation">
                    <button id="chatNavUp" class="chat-nav-btn" title="上一轮对话"><i class="fas fa-arrow-up"></i></button>
                    <button id="chatNavDown" class="chat-nav-btn" title="下一轮对话"><i class="fas fa-arrow-down"></i></button>
                </div>
                <!-- ==================== 新增的聊天输入区域 ==================== -->
                <div class="chat-input-area">
                    <div class="attachment-preview-container" id="attachmentPreview"></div>
                    <div class="input-controls">
                        <textarea id="chatInput" class="chat-textarea" rows="3" placeholder="输入消息... (Shift + Enter 换行)"></textarea>
                        <!-- 隐藏的文件输入框，通过JS点击附件按钮来触发 -->
                        <input type="file" id="attachmentInput" multiple style="display: none;">
                        <button id="attachFileBtn" class="chat-action-btn" title="添加附件" onclick="document.getElementById('attachmentInput').click();">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button id="sendMessageBtn" class="chat-action-btn send" title="发送">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <!-- ==================== 聊天输入区域结束 ==================== -->
            </div>
        </div>

        <!-- Anki 笔记视图 (此部分在初始视图中可能隐藏) -->
        <div class="main-layout" id="anki-view" style="display: none;">
            <div class="session-sidebar">
                <div class="session-header">
                    <div class="session-title">
                        <span><i class="fas fa-layer-group"></i> 会话管理</span>
                    </div>
                    <div class="session-controls">
                        <button id="newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                        <button id="newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                        <button id="openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                        <button id="moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                        <button id="deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="select-controls">
                        <label class="select-all">
                            <input type="checkbox" id="selectAllCheckbox"> 全选
                        </label>
                    </div>
                    <div class="current-folder" id="currentFolderContainer"></div>
                </div>
                <div class="session-content">
                    <div class="session-list-container">
                        <ul class="session-list" id="sessionList"></ul>
                        <div class="empty-session" id="emptySession">
                            <i class="fas fa-folder-open"></i>
                            <p>没有打开的会话</p>
                            <p>点击"新建文件"或"打开文件"开始</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-container">
                <div class="editor-preview-panel">
                    <!-- 1. 添加了标准的 panel-header -->
                    <div class="panel-header">
                        <!-- 1. 左侧的按钮容器 -->
                        <div class="panel-actions-leading">
        <button id="toggleSessionBtn" class="panel-btn" title="显示/隐藏会话栏"><i class="fas fa-bars"></i></button>
                            <button id="toggleEditPreviewBtn" class="panel-btn panel-btn-text">
                                <i class="fas fa-book-open"></i> Preview
                            </button>
                        </div>

                        <div class="panel-title">
                            <i class="fas fa-edit"></i> Anki 编辑器
                        </div>
                        <div class="panel-actions">
                            <!-- 复习按钮组也可以放在这里，或者放在 header actions 里，这里放在子工具栏更符合“编辑”上下文 -->
                            <div class="review-btn-group" style="margin-left: auto;">

                                <button id="startReviewBtn" class="panel-btn panel-btn-text">
                                    <i class="fas fa-play-circle"></i> 复习 (<span id="reviewCount">0</span>)
                                </button>
                                <button id="reviewOptionsBtn" class="panel-btn dropdown-toggle">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="reviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                    <a href="#" id="customStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
                                    <a href="#" id="showStatsBtn"><i class="fas fa-chart-line"></i> 统计</a>
                                </div>
                            </div>
                            <button id="toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏">
                                <i class="fas fa-eye-eye"></i>
                            </button>
                            <button id="invertClozeBtn" class="panel-btn" title="反向显示/隐藏">
                                <i class="fas fa-random"></i>
                            </button>
                            <button id="saveBtn" class="panel-btn panel-btn-text" title="保存"><i class="fas fa-save"></i>
                            </button>
                            <button id="exportFileBtn" class="panel-btn panel-btn-text" title="导出"><i
                                    class="fas fa-download"></i> </button>
                            <!-- [MODIFIED] Added Print Button -->
                            <button id="printPreviewBtn" class="panel-btn panel-btn-text" title="打印预览内容" disabled>
                                <i class="fas fa-print"></i>
                            </button>
                            <button id="toggleEditorBtn" class="panel-btn collapse-btn" title="收起/展开编辑器">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                    </div>

                    <div class="panel-content">
        <!-- 编辑模式下的工具栏 -->
        <div class="editor-sub-toolbar" id="editorToolbar">
            <button id="clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
            <button id="boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
            <button id="italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
            <button id="insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
            <button id="codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
            <button id="linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
            <button id="audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
        </div>

        <!-- 编辑器容器 -->
        <div class="editor-container" id="editorContainer">
                            <textarea id="editor"
                                class="editor"># Anki MD管理系统

## 使用说明

### 目录结构
- 创建目录来组织您的会话
- 在目录中创建文件
- 将文件移动到不同的目录

### 操作指南
1. 点击"新建目录"按钮创建新目录
2. 选择一个目录后，新建的文件会自动放入该目录
3. 使用移动按钮将项目移动到其他目录
4. 选中目录时会选中其下所有内容
5. 删除目录时会删除其下所有内容

### 数学公式示例
行内公式：\\( E = mc^2 \\)

块级公式：
\\[ 
x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} 
\\]

### Cloze 记忆卡片
牛顿第二定律：--\\( F = ma \\)--
量子力学基础：--\\( \psi = \psi(x,t) \\)--
相对论：--\\( E = \gamma m c^2 \\)--
电磁学：--\\( \nabla \times \mathbf{B} = \mu_0 \mathbf{J} + \mu_0 \epsilon_0 \frac{\partial \mathbf{E}}{\partial t} \\)--</textarea>

                        <div id="preview"></div>
                        </div>

        <!-- 模式指示器 -->
                        <div class="mode-indicator">
                            <div class="mode-dot active" id="editModeDot" title="编辑模式"></div>
                            <div class="mode-dot" id="previewModeDot" title="预览模式"></div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- ====================================================== -->
            <!--          [MODIFIED] 错题本视图 (应用所有修改)           -->
            <!-- ====================================================== -->
            <div id="mistakes-view" class="main-layout" style="display: none;">

                <!-- [MODIFIED] 错题本侧边栏 -->
                <div class="session-sidebar">
                    <div class="session-header">
                        <div class="session-title">
                            <span><i class="fas fa-book-open"></i> 错题筛选与导航</span>
                        </div>
                    </div>

                    <div class="session-content">
                        <!-- 筛选区域 -->
                        <!-- [MODIFIED] 将 .filter-section 改为 .session-header -->
                        <div class="session-header">
                            <!-- [MODIFIED] 将 .filter-controls 改为 .session-controls -->
                            <div class="session-controls">
                                <select id="subject-filter"></select>
                                <!-- [MODIFIED] 统一所有按钮的样式为 session-btn -->
                                <button id="refresh-mistakes-btn" class="session-btn" title="刷新"><i
                                        class="fas fa-sync-alt"></i></button>
                                <button id="newMistakeFileBtn" class="session-btn" title="新建错题文件"><i
                                        class="fas fa-file-alt"></i></button>
                                <button id="load-yaml-btn" class="session-btn" title="导入YAML文件"><i
                                        class="fas fa-file-upload"></i></button>
                                <input type="file" id="yaml-file-input" accept=".yml,.yaml" style="display: none;">
                            </div>
                            <div class="filter-group" data-type="tags">
                                <div class="tag-list"></div>
                            </div>
                            <div class="filter-group" data-type="reasons">
                                <div class="tag-list"></div>
                            </div>
                        </div>


                        <!-- 错题列表容器 -->
                        <div class="mistakes-list-container">
                            <div class="list-header"><i class="fas fa-list-ul"></i> 待复习列表 (按到期日排序)</div>
                            <ul class="session-list" id="mistakes-list">
                                <!-- 错题列表项将由JS动态生成 -->
                            </ul>
                            <div class="pagination">
                                <!-- 分页按钮将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [MODIFIED] 错题本主内容区 -->
                <div class="app-container">
                    <!-- 统计仪表盘 -->
                    <div id="statistics-dashboard" class="stats-dashboard">
                        <!-- 统计卡片将由JS动态生成 -->
                    </div>

                    <!-- YAML 编辑器面板 -->
                    <div id="mistake-editor-panel" class="panel editor-panel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                            <button id="mistakeToggleSessionBtn" class="panel-btn" title="显示/隐藏筛选栏"><i class="fas fa-bars"></i></button>
                            </div>
                            <div class="panel-title"><i class="fas fa-code"></i> YAML 编辑器</div>
                            <div class="panel-actions">
                            <button id="mistakeSaveBtn" class="panel-btn" title="保存并刷新"><i class="fas fa-save"></i></button>
                            <button id="mistakeExportBtn" class="panel-btn" title="导出YAML"><i class="fas fa-download"></i></button>
                                <button class="panel-btn collapse-btn" id="mistakeCollapseBtn" title="收起/展开">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <textarea id="yaml-editor" placeholder="在此处粘贴或编辑您的YAML格式错题..."></textarea>
                        </div>
                    </div>

                    <!-- 错题预览面板 -->
                    <div id="mistakes-preview-panel" class="panel preview-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-eye"></i> 错题预览</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="mistakeStartReviewBtn" class="editor-btn editor-btn-text">
                                        <i class="fas fa-play-circle"></i> 开始复习
                                    </button>
                                    <button id="mistakeReviewOptionsBtn" class="editor-btn dropdown-toggle">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div id="mistakeReviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                    <a href="#" id="mistakeCustomStudyBtn"><i class="fas fa-wrench"></i> 自定义复习...</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div id="mistakes-preview" class="mistakes-preview-container">
                                <!-- 错题预览卡片将由JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 错题本视图结束 -->

            <!-- ====================================================== -->
            <!--                  [新增] 设置视图                     -->
            <!-- ====================================================== -->
            <div id="settings-view" class="main-layout" style="display: none;">
                <!-- 内容将由 JavaScript 从模板动态填充 -->
            </div>
            <!-- 设置视图结束 -->

        <!-- ====================================================== -->
        <!--          [重构后] 统一的设置布局模板                   -->
        <!-- ====================================================== -->
        <template id="settings-layout-template">
            <div class="settings-nav-panel">
                <div class="settings-nav-header">
                    <h3><i class="fas fa-sliders-h"></i> 设置</h3>
                </div>
                <div class="settings-nav-list">
                    <!-- 导航项将由JS动态填充 -->
                </div>
            </div>
            <div class="settings-detail-panel">
                <div class="panel" style="height: 100%;"> <!-- 确保面板占满高度 -->
                    <div class="panel-header">
                        <div id="settings-detail-title" class="panel-title">
                            <!-- 标题由JS填充 -->
                        </div>
                        <div class="panel-actions">
                            <button id="settings-save-btn" class="panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button>
                        </div>
                    </div>
                    <div id="settings-detail-content" class="panel-content" style="padding: 25px; overflow-y: auto;">
                         <div class="placeholder-content">
                            <i class="fas fa-cogs fa-3x" style="color: var(--gray-300);"></i>
                            <p style="margin-top: 15px; color: var(--text-tertiary);">从左侧选择一个项目进行配置</p>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- ====================================================== -->
        <!--          [重构后] 全局应用设置表单模板                  -->
        <!-- ====================================================== -->
        <template id="general-settings-form-template">
            <div data-id="general" data-type="general">
                            <!-- 主题设置区域 -->
                            <div class="settings-section">
                                <h3 class="settings-section-title">外观与主题</h3>
                                <div class="form-group">
                                    <label for="theme-selector">选择一个主题</label>
                                    <select id="theme-selector" class="form-control">
                                        <option value="">默认 (亮色)</option>
                                        <option value="dark">暗黑模式</option>
                                        <option value="large-font">大号字体</option>
                                        <option value="larger-font">更大号字体</option>
                                    </select>
                                    <p class="form-text" style="margin-top: 8px; font-size: var(--text-sm); color: var(--text-secondary);">
                                        改变应用程序的视觉主题。
                                    </p>
                                </div>
                            </div>

                            <!-- 数据与同步设置区域 -->
                            <div class="settings-section">
                                <h3 class="settings-section-title">数据与同步</h3>
                                <div class="form-group">
                                    <label for="autosave-interval">自动保存间隔 (分钟)</label>
                                    <input type="number" id="autosave-interval" class="form-control" min="0" value="5">
                                    <p class="form-text">
                                        数据将按此时间间隔自动保存到本地数据库。设置为 0 可禁用自动保存。
                                    </p>
                                </div>
                            </div>

                            <!-- 导入/导出按钮 -->
                    <div class="form-group">
                                <label>数据库同步</label>
                                <div style="display: flex; gap: 15px;">
                                    <button id="export-db-btn" class="btn-secondary" style="flex: 1;"><i class="fas fa-download"></i> 导出数据</button>
                                    <button id="import-db-btn" class="btn-danger" style="flex: 1;"><i class="fas fa-upload"></i> 导入数据</button>
                                </div>
                                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                                <p class="form-text">
                                    导出所有数据到一个JSON文件。导入文件将会覆盖当前所有数据，请谨慎操作。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

			<!-- ====================================================== -->
			<!--            [新增] 所有设置项的主从布局模板             -->
			<!-- ====================================================== -->
			<template id="settings-layout-template">
			    <div class="settings-nav-panel">
			        <div class="settings-nav-header">
			            <h3>配置项</h3>
			        </div>
			        <div class="settings-nav-list">
			            <!-- 列表项将由JS动态填充 -->
			        </div>
			    </div>
			    <div class="settings-detail-panel">
			        <div class="panel">
			            <div class="panel-header">
			                <div id="settings-detail-title" class="panel-title">
			                    <i class="fas fa-arrow-left"></i> 请选择一个配置项
			                </div>
			                <div class="panel-actions">
			                    <button id="settings-save-btn" class="panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button>
			                </div>
			            </div>
			            <div id="settings-detail-content" class="panel-content" style="padding: 25px; overflow-y: auto;">
			                <div class="placeholder-content">
			                    <i class="fas fa-cogs"></i>
			                    <p>从左侧选择一个项目进行编辑，或添加一个新项目。</p>
			                </div>
			            </div>
			        </div>
			    </div>
			</template>

<!-- ====================================================== -->
<!--            [新增] API 配置表单模板                  -->
<!-- ====================================================== -->
<template id="api-config-form-template">
    <div data-id="" data-type="apiConfig">
        <form id="api-config-form-dynamic" novalidate>
            <input type="hidden" class="config-id">
            <div class="form-group">
                <label>配置名称 (如 DeepSeek, OpenAI)</label>
                <input type="text" class="config-name form-control" required placeholder="例如：我的 DeepSeek Key">
            </div>
             <div class="form-group">
                <label>提供商</label>
                <select class="config-provider form-control" required></select>
            </div>
            <div class="form-group">
                <label>API 地址</label>
                <input type="url" class="config-apiUrl form-control" placeholder="会自动填充，也可自定义">
            </div>
            <div class="form-group">
                <label>API Key</label>
                <div class="input-group">
                    <input type="password" class="config-apiKey form-control">
                    <button type="button" class="toggle-api-key-visibility input-group-btn" title="显示/隐藏"><i class="fas fa-eye"></i></button>
                </div>
            </div>
            <div class="form-group">
                <label>Models (格式: 别名:模型名, 多个用逗号隔开)</label>
                <textarea class="config-models form-control" rows="3" placeholder="例如: chat:deepseek-chat, code:deepseek-coder"></textarea>
                <p class="form-text">为长模型名设置一个简短的别名，方便在角色配置中选择。</p>
            </div>
            <div class="settings-detail-footer">
                <button type="button" class="btn btn-danger delete-item-btn">删除此 API 配置</button>
            </div>
        </form>
    </div>
</template>


<!-- ====================================================== -->
<!--            [新增] 角色(Prompt)配置表单模板            -->
<!-- ====================================================== -->
<template id="prompt-form-template">
    <div data-id="" data-type="prompt">
        <form id="prompt-form-dynamic" novalidate>
            <input type="hidden" class="config-id">
            <div class="form-group">
                <label>角色名称</label>
                <input type="text" class="config-name form-control" required placeholder="例如：南京历史导游">
            </div>
            <div class="form-group">
                <label>头像 (2个字符)</label>
                <input type="text" class="config-avatar form-control" required maxlength="2" placeholder="例如: 史, 导">
            </div>
            <div class="form-group">
                <label>选择模型</label>
                <select class="config-model form-control" required>
                    <!-- 选项将由JS动态生成 -->
                </select>
                <p class="form-text">此列表来源于您已配置的 API。</p>
            </div>
            <div class="form-group">
                <label>System Prompt (系统提示词)</label>
                <textarea class="config-systemPrompt form-control" rows="8" placeholder="定义角色的行为、知识范围和说话风格..."></textarea>
            </div>
            <div class="form-group">
                <label>欢迎语 (可选, 支持HTML)</label>
                <textarea class="config-hint form-control" rows="3" placeholder="例如: 您好！我是您的南京历史导游，有什么可以帮您的吗？"></textarea>
            </div>
            <div class="settings-detail-footer">
                <button type="button" class="btn btn-danger delete-item-btn">删除此角色</button>
            </div>
        </form>
    </div>
</template>


            
            <input type="file" id="fileInput" class="file-input" accept=".md, .txt" multiple>

            <div class="move-modal" id="moveModal">
                <div class="move-modal-content">
                    <div class="move-modal-header">
                        <div class="move-modal-title">移动到目录</div>
                        <button class="move-modal-close" id="closeMoveModalBtn">×</button>
                    </div>
                    <p>请选择目标目录：</p>
                    <div class="folder-list" id="folderList"></div>
                    <div class="move-modal-actions">
                        <button class="move-modal-btn cancel" id="cancelMoveBtn">取消</button>
                        <button class="move-modal-btn confirm" id="confirmMoveBtn">确认移动</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
            <div class="footer">
                <p>© 2024 Anki MD管理系统 | 数据保存在浏览器本地存储中</p>
            </div>
            

        <!-- ====================================================== -->
        <!--          AUDIO PLAYING                                 -->
        <!-- ====================================================== -->
        <div class="audio-controls" id="audioControls">
            <div class="audio-title" id="audioTitle">音频播放</div>
            <div class="audio-progress">
                <div class="audio-progress-bar" id="audioProgress"></div>
            </div>
            <div class="audio-buttons">
                <button class="audio-btn" id="playBtn"><i class="fas fa-play"></i> 播放</button>
                <button class="audio-btn" id="pauseBtn"><i class="fas fa-pause"></i> 暂停</button>
                <button class="audio-btn" id="stopBtn"><i class="fas fa-stop"></i> 停止</button>
            </div>
        </div>

        <!-- [NEW] 自定义复习模态框 -->
        <div class="modal-overlay" id="customStudyModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>自定义复习会话</h2>
                    <button class="modal-close" id="customStudyCloseBtn">×</button>
                </div>
                <div class="modal-body">
                    <form id="customStudyForm">
                        <div class="form-group">
                            <label for="filterByFile">按文件/目录筛选:</label>
                            <select id="filterByFile" class="form-control">
                                <option value="all">所有文件</option>
                                <!-- 选项将由JS动态填充 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>按卡片状态筛选:</label>
                            <div class="form-checkbox-group">
                                <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                                <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                                <label><input type="checkbox" name="cardState" value="review" checked> 复习中</label>
                                <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>按最后一次复习时间筛选:</label>
                            <select id="filterByLastReview" class="form-control">
                                <option value="any">任何时间</option>
                                <option value="last7days">最近7天内</option>
                                <option value="last30days">最近30天内</option>
                                <option value="over30days">超过30天未复习</option>
                                <option value="never">从未复习过 (新卡片)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxCards">最大卡片数量:</label>
                            <input type="number" id="maxCards" class="form-control" value="50" min="1">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="customStudyCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="startCustomStudyBtn" form="customStudyForm">开始自定义复习</button>
                </div>
            </div> <!-- <--- 新增的闭合标签，用于关闭 .modal-content -->
        </div> <!-- <--- 新增的闭合标签，用于关闭 .modal-overlay#customStudyModal -->

    <!-- [新增] 统计模态框 -->
    <div class="modal-overlay" id="statsModal" style="display: none;">
        <div class="modal-content large"> <!-- 添加一个 'large' 类以获得更宽的模态框 -->
            <div class="modal-header">
                <h2>复习统计</h2>
                <button class="modal-close" id="statsModalCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <p>近30天每日复习卡片数量统计</p>
                <div class="chart-container" style="position: relative; height:60vh; width:100%">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>
            </div>
        </div>
</body>
</html>
