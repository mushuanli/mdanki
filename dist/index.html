<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能学习套件</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        window.MathJax = {
            loader: { load: ['[tex]/mhchem'] },
            tex: { packages: { '[+]': ['mhchem'] } },
            startup: {
                pageReady: () => {
                    return window.MathJax.startup.defaultPageReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Local Stylesheet -->
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const cs=i=>document.getElementById(i),Jr={anki:cs("anki-view"),task:cs("task-view"),agent:cs("agent-view"),settings:cs("settings-view")};var Wr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Qo(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var ma={exports:{}};(function(i,e){(function(t,n){i.exports=n()})(Wr,function(){var t=function(r,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,d){c.__proto__=d}||function(c,d){for(var f in d)Object.prototype.hasOwnProperty.call(d,f)&&(c[f]=d[f])})(r,o)},n=function(){return(n=Object.assign||function(r){for(var o,c=1,d=arguments.length;c<d;c++)for(var f in o=arguments[c])Object.prototype.hasOwnProperty.call(o,f)&&(r[f]=o[f]);return r}).apply(this,arguments)};function s(r,o,c){for(var d,f=0,p=o.length;f<p;f++)!d&&f in o||((d=d||Array.prototype.slice.call(o,0,f))[f]=o[f]);return r.concat(d||Array.prototype.slice.call(o))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Wr,l=Object.keys,u=Array.isArray;function h(r,o){return typeof o!="object"||l(o).forEach(function(c){r[c]=o[c]}),r}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var m=Object.getPrototypeOf,w={}.hasOwnProperty;function v(r,o){return w.call(r,o)}function k(r,o){typeof o=="function"&&(o=o(m(r))),(typeof Reflect>"u"?l:Reflect.ownKeys)(o).forEach(function(c){F(r,c,o[c])})}var B=Object.defineProperty;function F(r,o,c,d){B(r,o,h(c&&v(c,"get")&&typeof c.get=="function"?{get:c.get,set:c.set,configurable:!0}:{value:c,configurable:!0,writable:!0},d))}function O(r){return{from:function(o){return r.prototype=Object.create(o.prototype),F(r.prototype,"constructor",r),{extend:k.bind(null,r.prototype)}}}}var N=Object.getOwnPropertyDescriptor,V=[].slice;function G(r,o,c){return V.call(r,o,c)}function Q(r,o){return o(r)}function W(r){if(!r)throw new Error("Assertion Failed")}function ee(r){a.setImmediate?setImmediate(r):setTimeout(r,0)}function Z(r,o){if(typeof o=="string"&&v(r,o))return r[o];if(!o)return r;if(typeof o!="string"){for(var c=[],d=0,f=o.length;d<f;++d){var p=Z(r,o[d]);c.push(p)}return c}var g=o.indexOf(".");if(g!==-1){var y=r[o.substr(0,g)];return y==null?void 0:Z(y,o.substr(g+1))}}function re(r,o,c){if(r&&o!==void 0&&!("isFrozen"in Object&&Object.isFrozen(r)))if(typeof o!="string"&&"length"in o){W(typeof c!="string"&&"length"in c);for(var d=0,f=o.length;d<f;++d)re(r,o[d],c[d])}else{var p,g,y=o.indexOf(".");y!==-1?(p=o.substr(0,y),(g=o.substr(y+1))===""?c===void 0?u(r)&&!isNaN(parseInt(p))?r.splice(p,1):delete r[p]:r[p]=c:re(y=!(y=r[p])||!v(r,p)?r[p]={}:y,g,c)):c===void 0?u(r)&&!isNaN(parseInt(o))?r.splice(o,1):delete r[o]:r[o]=c}}function J(r){var o,c={};for(o in r)v(r,o)&&(c[o]=r[o]);return c}var be=[].concat;function De(r){return be.apply([],r)}var mt="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(De([8,16,32,64].map(function(r){return["Int","Uint","Float"].map(function(o){return o+r+"Array"})}))).filter(function(r){return a[r]}),Ye=new Set(mt.map(function(r){return a[r]})),he=null;function Re(r){return he=new WeakMap,r=function o(c){if(!c||typeof c!="object")return c;var d=he.get(c);if(d)return d;if(u(c)){d=[],he.set(c,d);for(var f=0,p=c.length;f<p;++f)d.push(o(c[f]))}else if(Ye.has(c.constructor))d=c;else{var g,y=m(c);for(g in d=y===Object.prototype?{}:Object.create(y),he.set(c,d),c)v(c,g)&&(d[g]=o(c[g]))}return d}(r),he=null,r}var yo={}.toString;function Rs(r){return yo.call(r).slice(8,-1)}var js=typeof Symbol<"u"?Symbol.iterator:"@@iterator",vo=typeof js=="symbol"?function(r){var o;return r!=null&&(o=r[js])&&o.apply(r)}:function(){return null};function ht(r,o){return o=r.indexOf(o),0<=o&&r.splice(o,1),0<=o}var xt={};function Ge(r){var o,c,d,f;if(arguments.length===1){if(u(r))return r.slice();if(this===xt&&typeof r=="string")return[r];if(f=vo(r)){for(c=[];!(d=f.next()).done;)c.push(d.value);return c}if(r==null)return[r];if(typeof(o=r.length)!="number")return[r];for(c=new Array(o);o--;)c[o]=r[o];return c}for(o=arguments.length,c=new Array(o);o--;)c[o]=arguments[o];return c}var qs=typeof Symbol<"u"?function(r){return r[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},dn=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Pe=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(dn),bo={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Pt(r,o){this.name=r,this.message=o}function pr(r,o){return r+". Errors: "+Object.keys(o).map(function(c){return o[c].toString()}).filter(function(c,d,f){return f.indexOf(c)===d}).join(`
`)}function Nn(r,o,c,d){this.failures=o,this.failedKeys=d,this.successCount=c,this.message=pr(r,o)}function Nt(r,o){this.name="BulkError",this.failures=Object.keys(o).map(function(c){return o[c]}),this.failuresByPos=o,this.message=pr(r,this.failures)}O(Pt).from(Error).extend({toString:function(){return this.name+": "+this.message}}),O(Nn).from(Pt),O(Nt).from(Pt);var zs=Pe.reduce(function(r,o){return r[o]=o+"Error",r},{}),wo=Pt,te=Pe.reduce(function(r,o){var c=o+"Error";function d(f,p){this.name=c,f?typeof f=="string"?(this.message="".concat(f).concat(p?`
 `+p:""),this.inner=p||null):typeof f=="object"&&(this.message="".concat(f.name," ").concat(f.message),this.inner=f):(this.message=bo[o]||c,this.inner=null)}return O(d).from(wo),r[o]=d,r},{});te.Syntax=SyntaxError,te.Type=TypeError,te.Range=RangeError;var mr=dn.reduce(function(r,o){return r[o+"Error"]=te[o],r},{}),$n=Pe.reduce(function(r,o){return["Syntax","Type","Range"].indexOf(o)===-1&&(r[o+"Error"]=te[o]),r},{});function de(){}function cn(r){return r}function ko(r,o){return r==null||r===cn?o:function(c){return o(r(c))}}function pt(r,o){return function(){r.apply(this,arguments),o.apply(this,arguments)}}function So(r,o){return r===de?o:function(){var c=r.apply(this,arguments);c!==void 0&&(arguments[0]=c);var d=this.onsuccess,f=this.onerror;this.onsuccess=null,this.onerror=null;var p=o.apply(this,arguments);return d&&(this.onsuccess=this.onsuccess?pt(d,this.onsuccess):d),f&&(this.onerror=this.onerror?pt(f,this.onerror):f),p!==void 0?p:c}}function To(r,o){return r===de?o:function(){r.apply(this,arguments);var c=this.onsuccess,d=this.onerror;this.onsuccess=this.onerror=null,o.apply(this,arguments),c&&(this.onsuccess=this.onsuccess?pt(c,this.onsuccess):c),d&&(this.onerror=this.onerror?pt(d,this.onerror):d)}}function Io(r,o){return r===de?o:function(c){var d=r.apply(this,arguments);h(c,d);var f=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,c=o.apply(this,arguments),f&&(this.onsuccess=this.onsuccess?pt(f,this.onsuccess):f),p&&(this.onerror=this.onerror?pt(p,this.onerror):p),d===void 0?c===void 0?void 0:c:h(d,c)}}function _o(r,o){return r===de?o:function(){return o.apply(this,arguments)!==!1&&r.apply(this,arguments)}}function Hs(r,o){return r===de?o:function(){var c=r.apply(this,arguments);if(c&&typeof c.then=="function"){for(var d=this,f=arguments.length,p=new Array(f);f--;)p[f]=arguments[f];return c.then(function(){return o.apply(d,p)})}return o.apply(this,arguments)}}$n.ModifyError=Nn,$n.DexieError=Pt,$n.BulkError=Nt;var je=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function gr(r){je=r}var un={},yr=100,mt=typeof Promise>"u"?[]:function(){var r=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[r,m(r),r];var o=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[o,m(o),r]}(),dn=mt[0],Pe=mt[1],mt=mt[2],Pe=Pe&&Pe.then,gt=dn&&dn.constructor,Us=!!mt,fn=function(r,o){hn.push([r,o]),Dn&&(queueMicrotask(Eo),Dn=!1)},Vs=!0,Dn=!0,yt=[],Fn=[],Ys=cn,et={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:de,pgp:!1,env:{},finalize:de},X=et,hn=[],vt=0,Kn=[];function U(r){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var o=this._PSD=X;if(typeof r!="function"){if(r!==un)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Js(this,this._value))}this._state=null,this._value=null,++o.ref,function c(d,f){try{f(function(p){if(d._state===null){if(p===d)throw new TypeError("A promise cannot be resolved with itself.");var g=d._lib&&$t();p&&typeof p.then=="function"?c(d,function(y,S){p instanceof U?p._then(y,S):p.then(y,S)}):(d._state=!0,d._value=p,br(d)),g&&Dt()}},Js.bind(null,d))}catch(p){Js(d,p)}}(this,r)}var Gs={get:function(){var r=X,o=zn;function c(d,f){var p=this,g=!r.global&&(r!==X||o!==zn),y=g&&!nt(),S=new U(function(I,E){Ws(p,new vr(kr(d,r,g,y),kr(f,r,g,y),I,E,r))});return this._consoleTask&&(S._consoleTask=this._consoleTask),S}return c.prototype=un,c},set:function(r){F(this,"then",r&&r.prototype===un?Gs:{get:function(){return r},set:Gs.set})}};function vr(r,o,c,d,f){this.onFulfilled=typeof r=="function"?r:null,this.onRejected=typeof o=="function"?o:null,this.resolve=c,this.reject=d,this.psd=f}function Js(r,o){var c,d;Fn.push(o),r._state===null&&(c=r._lib&&$t(),o=Ys(o),r._state=!1,r._value=o,d=r,yt.some(function(f){return f._value===d._value})||yt.push(d),br(r),c&&Dt())}function br(r){var o=r._listeners;r._listeners=[];for(var c=0,d=o.length;c<d;++c)Ws(r,o[c]);var f=r._PSD;--f.ref||f.finalize(),vt===0&&(++vt,fn(function(){--vt==0&&Qs()},[]))}function Ws(r,o){if(r._state!==null){var c=r._state?o.onFulfilled:o.onRejected;if(c===null)return(r._state?o.resolve:o.reject)(r._value);++o.psd.ref,++vt,fn(Co,[c,r,o])}else r._listeners.push(o)}function Co(r,o,c){try{var d,f=o._value;!o._state&&Fn.length&&(Fn=[]),d=je&&o._consoleTask?o._consoleTask.run(function(){return r(f)}):r(f),o._state||Fn.indexOf(f)!==-1||function(p){for(var g=yt.length;g;)if(yt[--g]._value===p._value)return yt.splice(g,1)}(o),c.resolve(d)}catch(p){c.reject(p)}finally{--vt==0&&Qs(),--c.psd.ref||c.psd.finalize()}}function Eo(){bt(et,function(){$t()&&Dt()})}function $t(){var r=Vs;return Dn=Vs=!1,r}function Dt(){var r,o,c;do for(;0<hn.length;)for(r=hn,hn=[],c=r.length,o=0;o<c;++o){var d=r[o];d[0].apply(null,d[1])}while(0<hn.length);Dn=Vs=!0}function Qs(){var r=yt;yt=[],r.forEach(function(d){d._PSD.onunhandled.call(null,d._value,d)});for(var o=Kn.slice(0),c=o.length;c;)o[--c]()}function Rn(r){return new U(un,!1,r)}function me(r,o){var c=X;return function(){var d=$t(),f=X;try{return st(c,!0),r.apply(this,arguments)}catch(p){o&&o(p)}finally{st(f,!1),d&&Dt()}}}k(U.prototype,{then:Gs,_then:function(r,o){Ws(this,new vr(null,null,r,o,X))},catch:function(r){if(arguments.length===1)return this.then(null,r);var o=r,c=arguments[1];return typeof o=="function"?this.then(null,function(d){return(d instanceof o?c:Rn)(d)}):this.then(null,function(d){return(d&&d.name===o?c:Rn)(d)})},finally:function(r){return this.then(function(o){return U.resolve(r()).then(function(){return o})},function(o){return U.resolve(r()).then(function(){return Rn(o)})})},timeout:function(r,o){var c=this;return r<1/0?new U(function(d,f){var p=setTimeout(function(){return f(new te.Timeout(o))},r);c.then(d,f).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&F(U.prototype,Symbol.toStringTag,"Dexie.Promise"),et.env=wr(),k(U,{all:function(){var r=Ge.apply(null,arguments).map(Hn);return new U(function(o,c){r.length===0&&o([]);var d=r.length;r.forEach(function(f,p){return U.resolve(f).then(function(g){r[p]=g,--d||o(r)},c)})})},resolve:function(r){return r instanceof U?r:r&&typeof r.then=="function"?new U(function(o,c){r.then(o,c)}):new U(un,!0,r)},reject:Rn,race:function(){var r=Ge.apply(null,arguments).map(Hn);return new U(function(o,c){r.map(function(d){return U.resolve(d).then(o,c)})})},PSD:{get:function(){return X},set:function(r){return X=r}},totalEchoes:{get:function(){return zn}},newPSD:tt,usePSD:bt,scheduler:{get:function(){return fn},set:function(r){fn=r}},rejectionMapper:{get:function(){return Ys},set:function(r){Ys=r}},follow:function(r,o){return new U(function(c,d){return tt(function(f,p){var g=X;g.unhandleds=[],g.onunhandled=p,g.finalize=pt(function(){var y,S=this;y=function(){S.unhandleds.length===0?f():p(S.unhandleds[0])},Kn.push(function I(){y(),Kn.splice(Kn.indexOf(I),1)}),++vt,fn(function(){--vt==0&&Qs()},[])},g.finalize),r()},o,c,d)})}}),gt&&(gt.allSettled&&F(U,"allSettled",function(){var r=Ge.apply(null,arguments).map(Hn);return new U(function(o){r.length===0&&o([]);var c=r.length,d=new Array(c);r.forEach(function(f,p){return U.resolve(f).then(function(g){return d[p]={status:"fulfilled",value:g}},function(g){return d[p]={status:"rejected",reason:g}}).then(function(){return--c||o(d)})})})}),gt.any&&typeof AggregateError<"u"&&F(U,"any",function(){var r=Ge.apply(null,arguments).map(Hn);return new U(function(o,c){r.length===0&&c(new AggregateError([]));var d=r.length,f=new Array(d);r.forEach(function(p,g){return U.resolve(p).then(function(y){return o(y)},function(y){f[g]=y,--d||c(new AggregateError(f))})})})}),gt.withResolvers&&(U.withResolvers=gt.withResolvers));var Se={awaits:0,echoes:0,id:0},Ao=0,jn=[],qn=0,zn=0,Lo=0;function tt(r,o,c,d){var f=X,p=Object.create(f);return p.parent=f,p.ref=0,p.global=!1,p.id=++Lo,et.env,p.env=Us?{Promise:U,PromiseProp:{value:U,configurable:!0,writable:!0},all:U.all,race:U.race,allSettled:U.allSettled,any:U.any,resolve:U.resolve,reject:U.reject}:{},o&&h(p,o),++f.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},d=bt(p,r,c,d),p.ref===0&&p.finalize(),d}function Ft(){return Se.id||(Se.id=++Ao),++Se.awaits,Se.echoes+=yr,Se.id}function nt(){return!!Se.awaits&&(--Se.awaits==0&&(Se.id=0),Se.echoes=Se.awaits*yr,!0)}function Hn(r){return Se.echoes&&r&&r.constructor===gt?(Ft(),r.then(function(o){return nt(),o},function(o){return nt(),we(o)})):r}function Bo(){var r=jn[jn.length-1];jn.pop(),st(r,!1)}function st(r,o){var c,d=X;(o?!Se.echoes||qn++&&r===X:!qn||--qn&&r===X)||queueMicrotask(o?(function(f){++zn,Se.echoes&&--Se.echoes!=0||(Se.echoes=Se.awaits=Se.id=0),jn.push(X),st(f,!0)}).bind(null,r):Bo),r!==X&&(X=r,d===et&&(et.env=wr()),Us&&(c=et.env.Promise,o=r.env,(d.global||r.global)&&(Object.defineProperty(a,"Promise",o.PromiseProp),c.all=o.all,c.race=o.race,c.resolve=o.resolve,c.reject=o.reject,o.allSettled&&(c.allSettled=o.allSettled),o.any&&(c.any=o.any))))}function wr(){var r=a.Promise;return Us?{Promise:r,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:r.all,race:r.race,allSettled:r.allSettled,any:r.any,resolve:r.resolve,reject:r.reject}:{}}function bt(r,o,c,d,f){var p=X;try{return st(r,!0),o(c,d,f)}finally{st(p,!1)}}function kr(r,o,c,d){return typeof r!="function"?r:function(){var f=X;c&&Ft(),st(o,!0);try{return r.apply(this,arguments)}finally{st(f,!1),d&&queueMicrotask(nt)}}}function Xs(r){Promise===gt&&Se.echoes===0?qn===0?r():enqueueNativeMicroTask(r):setTimeout(r,0)}(""+Pe).indexOf("[native code]")===-1&&(Ft=nt=de);var we=U.reject,wt="￿",Je="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Sr="String expected.",Kt=[],Un="__dbnames",Zs="readonly",ei="readwrite";function kt(r,o){return r?o?function(){return r.apply(this,arguments)&&o.apply(this,arguments)}:r:o}var Tr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Vn(r){return typeof r!="string"||/\./.test(r)?function(o){return o}:function(o){return o[r]===void 0&&r in o&&delete(o=Re(o))[r],o}}function Ir(){throw te.Type()}function le(r,o){try{var c=_r(r),d=_r(o);if(c!==d)return c==="Array"?1:d==="Array"?-1:c==="binary"?1:d==="binary"?-1:c==="string"?1:d==="string"?-1:c==="Date"?1:d!=="Date"?NaN:-1;switch(c){case"number":case"Date":case"string":return o<r?1:r<o?-1:0;case"binary":return function(f,p){for(var g=f.length,y=p.length,S=g<y?g:y,I=0;I<S;++I)if(f[I]!==p[I])return f[I]<p[I]?-1:1;return g===y?0:g<y?-1:1}(Cr(r),Cr(o));case"Array":return function(f,p){for(var g=f.length,y=p.length,S=g<y?g:y,I=0;I<S;++I){var E=le(f[I],p[I]);if(E!==0)return E}return g===y?0:g<y?-1:1}(r,o)}}catch{}return NaN}function _r(r){var o=typeof r;return o!="object"?o:ArrayBuffer.isView(r)?"binary":(r=Rs(r),r==="ArrayBuffer"?"binary":r)}function Cr(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r)}var Er=(pe.prototype._trans=function(r,o,c){var d=this._tx||X.trans,f=this.name,p=je&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(r==="readonly"?"read":"write"," ").concat(this.name));function g(I,E,b){if(!b.schema[f])throw new te.NotFound("Table "+f+" not part of transaction");return o(b.idbtrans,b)}var y=$t();try{var S=d&&d.db._novip===this.db._novip?d===X.trans?d._promise(r,g,c):tt(function(){return d._promise(r,g,c)},{trans:d,transless:X.transless||X}):function I(E,b,L,T){if(E.idbdb&&(E._state.openComplete||X.letThrough||E._vip)){var C=E._createTransaction(b,L,E._dbSchema);try{C.create(),E._state.PR1398_maxLoop=3}catch(A){return A.name===zs.InvalidState&&E.isOpen()&&0<--E._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),E.close({disableAutoOpen:!1}),E.open().then(function(){return I(E,b,L,T)})):we(A)}return C._promise(b,function(A,_){return tt(function(){return X.trans=C,T(A,_,C)})}).then(function(A){if(b==="readwrite")try{C.idbtrans.commit()}catch{}return b==="readonly"?A:C._completion.then(function(){return A})})}if(E._state.openComplete)return we(new te.DatabaseClosed(E._state.dbOpenError));if(!E._state.isBeingOpened){if(!E._state.autoOpen)return we(new te.DatabaseClosed);E.open().catch(de)}return E._state.dbReadyPromise.then(function(){return I(E,b,L,T)})}(this.db,r,[this.name],g);return p&&(S._consoleTask=p,S=S.catch(function(I){return console.trace(I),we(I)})),S}finally{y&&Dt()}},pe.prototype.get=function(r,o){var c=this;return r&&r.constructor===Object?this.where(r).first(o):r==null?we(new te.Type("Invalid argument to Table.get()")):this._trans("readonly",function(d){return c.core.get({trans:d,key:r}).then(function(f){return c.hook.reading.fire(f)})}).then(o)},pe.prototype.where=function(r){if(typeof r=="string")return new this.db.WhereClause(this,r);if(u(r))return new this.db.WhereClause(this,"[".concat(r.join("+"),"]"));var o=l(r);if(o.length===1)return this.where(o[0]).equals(r[o[0]]);var c=this.schema.indexes.concat(this.schema.primKey).filter(function(y){if(y.compound&&o.every(function(I){return 0<=y.keyPath.indexOf(I)})){for(var S=0;S<o.length;++S)if(o.indexOf(y.keyPath[S])===-1)return!1;return!0}return!1}).sort(function(y,S){return y.keyPath.length-S.keyPath.length})[0];if(c&&this.db._maxKey!==wt){var p=c.keyPath.slice(0,o.length);return this.where(p).equals(p.map(function(S){return r[S]}))}!c&&je&&console.warn("The query ".concat(JSON.stringify(r)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(o.join("+"),"]"));var d=this.schema.idxByName;function f(y,S){return le(y,S)===0}var g=o.reduce(function(b,S){var I=b[0],E=b[1],b=d[S],L=r[S];return[I||b,I||!b?kt(E,b&&b.multi?function(T){return T=Z(T,S),u(T)&&T.some(function(C){return f(L,C)})}:function(T){return f(L,Z(T,S))}):E]},[null,null]),p=g[0],g=g[1];return p?this.where(p.name).equals(r[p.keyPath]).filter(g):c?this.filter(g):this.where(o).equals("")},pe.prototype.filter=function(r){return this.toCollection().and(r)},pe.prototype.count=function(r){return this.toCollection().count(r)},pe.prototype.offset=function(r){return this.toCollection().offset(r)},pe.prototype.limit=function(r){return this.toCollection().limit(r)},pe.prototype.each=function(r){return this.toCollection().each(r)},pe.prototype.toArray=function(r){return this.toCollection().toArray(r)},pe.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},pe.prototype.orderBy=function(r){return new this.db.Collection(new this.db.WhereClause(this,u(r)?"[".concat(r.join("+"),"]"):r))},pe.prototype.reverse=function(){return this.toCollection().reverse()},pe.prototype.mapToClass=function(r){var o,c=this.db,d=this.name;function f(){return o!==null&&o.apply(this,arguments)||this}(this.schema.mappedClass=r).prototype instanceof Ir&&(function(S,I){if(typeof I!="function"&&I!==null)throw new TypeError("Class extends value "+String(I)+" is not a constructor or null");function E(){this.constructor=S}t(S,I),S.prototype=I===null?Object.create(I):(E.prototype=I.prototype,new E)}(f,o=r),Object.defineProperty(f.prototype,"db",{get:function(){return c},enumerable:!1,configurable:!0}),f.prototype.table=function(){return d},r=f);for(var p=new Set,g=r.prototype;g;g=m(g))Object.getOwnPropertyNames(g).forEach(function(S){return p.add(S)});function y(S){if(!S)return S;var I,E=Object.create(r.prototype);for(I in S)if(!p.has(I))try{E[I]=S[I]}catch{}return E}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=y,this.hook("reading",y),r},pe.prototype.defineClass=function(){return this.mapToClass(function(r){h(this,r)})},pe.prototype.add=function(r,o){var c=this,d=this.schema.primKey,f=d.auto,p=d.keyPath,g=r;return p&&f&&(g=Vn(p)(r)),this._trans("readwrite",function(y){return c.core.mutate({trans:y,type:"add",keys:o!=null?[o]:null,values:[g]})}).then(function(y){return y.numFailures?U.reject(y.failures[0]):y.lastResult}).then(function(y){if(p)try{re(r,p,y)}catch{}return y})},pe.prototype.update=function(r,o){return typeof r!="object"||u(r)?this.where(":id").equals(r).modify(o):(r=Z(r,this.schema.primKey.keyPath),r===void 0?we(new te.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(r).modify(o))},pe.prototype.put=function(r,o){var c=this,d=this.schema.primKey,f=d.auto,p=d.keyPath,g=r;return p&&f&&(g=Vn(p)(r)),this._trans("readwrite",function(y){return c.core.mutate({trans:y,type:"put",values:[g],keys:o!=null?[o]:null})}).then(function(y){return y.numFailures?U.reject(y.failures[0]):y.lastResult}).then(function(y){if(p)try{re(r,p,y)}catch{}return y})},pe.prototype.delete=function(r){var o=this;return this._trans("readwrite",function(c){return o.core.mutate({trans:c,type:"delete",keys:[r]})}).then(function(c){return c.numFailures?U.reject(c.failures[0]):void 0})},pe.prototype.clear=function(){var r=this;return this._trans("readwrite",function(o){return r.core.mutate({trans:o,type:"deleteRange",range:Tr})}).then(function(o){return o.numFailures?U.reject(o.failures[0]):void 0})},pe.prototype.bulkGet=function(r){var o=this;return this._trans("readonly",function(c){return o.core.getMany({keys:r,trans:c}).then(function(d){return d.map(function(f){return o.hook.reading.fire(f)})})})},pe.prototype.bulkAdd=function(r,o,c){var d=this,f=Array.isArray(o)?o:void 0,p=(c=c||(f?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(g){var I=d.schema.primKey,y=I.auto,I=I.keyPath;if(I&&f)throw new te.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(f&&f.length!==r.length)throw new te.InvalidArgument("Arguments objects and keys must have the same length");var S=r.length,I=I&&y?r.map(Vn(I)):r;return d.core.mutate({trans:g,type:"add",keys:f,values:I,wantResults:p}).then(function(C){var b=C.numFailures,L=C.results,T=C.lastResult,C=C.failures;if(b===0)return p?L:T;throw new Nt("".concat(d.name,".bulkAdd(): ").concat(b," of ").concat(S," operations failed"),C)})})},pe.prototype.bulkPut=function(r,o,c){var d=this,f=Array.isArray(o)?o:void 0,p=(c=c||(f?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(g){var I=d.schema.primKey,y=I.auto,I=I.keyPath;if(I&&f)throw new te.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(f&&f.length!==r.length)throw new te.InvalidArgument("Arguments objects and keys must have the same length");var S=r.length,I=I&&y?r.map(Vn(I)):r;return d.core.mutate({trans:g,type:"put",keys:f,values:I,wantResults:p}).then(function(C){var b=C.numFailures,L=C.results,T=C.lastResult,C=C.failures;if(b===0)return p?L:T;throw new Nt("".concat(d.name,".bulkPut(): ").concat(b," of ").concat(S," operations failed"),C)})})},pe.prototype.bulkUpdate=function(r){var o=this,c=this.core,d=r.map(function(g){return g.key}),f=r.map(function(g){return g.changes}),p=[];return this._trans("readwrite",function(g){return c.getMany({trans:g,keys:d,cache:"clone"}).then(function(y){var S=[],I=[];r.forEach(function(b,L){var T=b.key,C=b.changes,A=y[L];if(A){for(var _=0,M=Object.keys(C);_<M.length;_++){var x=M[_],P=C[x];if(x===o.schema.primKey.keyPath){if(le(P,T)!==0)throw new te.Constraint("Cannot update primary key in bulkUpdate()")}else re(A,x,P)}p.push(L),S.push(T),I.push(A)}});var E=S.length;return c.mutate({trans:g,type:"put",keys:S,values:I,updates:{keys:d,changeSpecs:f}}).then(function(b){var L=b.numFailures,T=b.failures;if(L===0)return E;for(var C=0,A=Object.keys(T);C<A.length;C++){var _,M=A[C],x=p[Number(M)];x!=null&&(_=T[M],delete T[M],T[x]=_)}throw new Nt("".concat(o.name,".bulkUpdate(): ").concat(L," of ").concat(E," operations failed"),T)})})})},pe.prototype.bulkDelete=function(r){var o=this,c=r.length;return this._trans("readwrite",function(d){return o.core.mutate({trans:d,type:"delete",keys:r})}).then(function(g){var f=g.numFailures,p=g.lastResult,g=g.failures;if(f===0)return p;throw new Nt("".concat(o.name,".bulkDelete(): ").concat(f," of ").concat(c," operations failed"),g)})},pe);function pe(){}function pn(r){function o(g,y){if(y){for(var S=arguments.length,I=new Array(S-1);--S;)I[S-1]=arguments[S];return c[g].subscribe.apply(null,I),r}if(typeof g=="string")return c[g]}var c={};o.addEventType=p;for(var d=1,f=arguments.length;d<f;++d)p(arguments[d]);return o;function p(g,y,S){if(typeof g!="object"){var I;y=y||_o;var E={subscribers:[],fire:S=S||de,subscribe:function(b){E.subscribers.indexOf(b)===-1&&(E.subscribers.push(b),E.fire=y(E.fire,b))},unsubscribe:function(b){E.subscribers=E.subscribers.filter(function(L){return L!==b}),E.fire=E.subscribers.reduce(y,S)}};return c[g]=o[g]=E}l(I=g).forEach(function(b){var L=I[b];if(u(L))p(b,I[b][0],I[b][1]);else{if(L!=="asap")throw new te.InvalidArgument("Invalid event config");var T=p(b,cn,function(){for(var C=arguments.length,A=new Array(C);C--;)A[C]=arguments[C];T.subscribers.forEach(function(_){ee(function(){_.apply(null,A)})})})}})}}function mn(r,o){return O(o).from({prototype:r}),o}function Rt(r,o){return!(r.filter||r.algorithm||r.or)&&(o?r.justLimit:!r.replayFilter)}function ti(r,o){r.filter=kt(r.filter,o)}function ni(r,o,c){var d=r.replayFilter;r.replayFilter=d?function(){return kt(d(),o())}:o,r.justLimit=c&&!d}function Yn(r,o){if(r.isPrimKey)return o.primaryKey;var c=o.getIndexByKeyPath(r.index);if(!c)throw new te.Schema("KeyPath "+r.index+" on object store "+o.name+" is not indexed");return c}function Ar(r,o,c){var d=Yn(r,o.schema);return o.openCursor({trans:c,values:!r.keysOnly,reverse:r.dir==="prev",unique:!!r.unique,query:{index:d,range:r.range}})}function Gn(r,o,c,d){var f=r.replayFilter?kt(r.filter,r.replayFilter()):r.filter;if(r.or){var p={},g=function(y,S,I){var E,b;f&&!f(S,I,function(L){return S.stop(L)},function(L){return S.fail(L)})||((b=""+(E=S.primaryKey))=="[object ArrayBuffer]"&&(b=""+new Uint8Array(E)),v(p,b)||(p[b]=!0,o(y,S,I)))};return Promise.all([r.or._iterate(g,c),Lr(Ar(r,d,c),r.algorithm,g,!r.keysOnly&&r.valueMapper)])}return Lr(Ar(r,d,c),kt(r.algorithm,f),o,!r.keysOnly&&r.valueMapper)}function Lr(r,o,c,d){var f=me(d?function(p,g,y){return c(d(p),g,y)}:c);return r.then(function(p){if(p)return p.start(function(){var g=function(){return p.continue()};o&&!o(p,function(y){return g=y},function(y){p.stop(y),g=de},function(y){p.fail(y),g=de})||f(p.value,p,function(y){return g=y}),g()})})}var gn=(Br.prototype.execute=function(r){var o=this["@@propmod"];if(o.add!==void 0){var c=o.add;if(u(c))return s(s([],u(r)?r:[],!0),c).sort();if(typeof c=="number")return(Number(r)||0)+c;if(typeof c=="bigint")try{return BigInt(r)+c}catch{return BigInt(0)+c}throw new TypeError("Invalid term ".concat(c))}if(o.remove!==void 0){var d=o.remove;if(u(d))return u(r)?r.filter(function(f){return!d.includes(f)}).sort():[];if(typeof d=="number")return Number(r)-d;if(typeof d=="bigint")try{return BigInt(r)-d}catch{return BigInt(0)-d}throw new TypeError("Invalid subtrahend ".concat(d))}return c=(c=o.replacePrefix)===null||c===void 0?void 0:c[0],c&&typeof r=="string"&&r.startsWith(c)?o.replacePrefix[1]+r.substring(c.length):r},Br);function Br(r){this["@@propmod"]=r}var Oo=(ue.prototype._read=function(r,o){var c=this._ctx;return c.error?c.table._trans(null,we.bind(null,c.error)):c.table._trans("readonly",r).then(o)},ue.prototype._write=function(r){var o=this._ctx;return o.error?o.table._trans(null,we.bind(null,o.error)):o.table._trans("readwrite",r,"locked")},ue.prototype._addAlgorithm=function(r){var o=this._ctx;o.algorithm=kt(o.algorithm,r)},ue.prototype._iterate=function(r,o){return Gn(this._ctx,r,o,this._ctx.table.core)},ue.prototype.clone=function(r){var o=Object.create(this.constructor.prototype),c=Object.create(this._ctx);return r&&h(c,r),o._ctx=c,o},ue.prototype.raw=function(){return this._ctx.valueMapper=null,this},ue.prototype.each=function(r){var o=this._ctx;return this._read(function(c){return Gn(o,r,c,o.table.core)})},ue.prototype.count=function(r){var o=this;return this._read(function(c){var d=o._ctx,f=d.table.core;if(Rt(d,!0))return f.count({trans:c,query:{index:Yn(d,f.schema),range:d.range}}).then(function(g){return Math.min(g,d.limit)});var p=0;return Gn(d,function(){return++p,!1},c,f).then(function(){return p})}).then(r)},ue.prototype.sortBy=function(r,o){var c=r.split(".").reverse(),d=c[0],f=c.length-1;function p(S,I){return I?p(S[c[I]],I-1):S[d]}var g=this._ctx.dir==="next"?1:-1;function y(S,I){return le(p(S,f),p(I,f))*g}return this.toArray(function(S){return S.sort(y)}).then(o)},ue.prototype.toArray=function(r){var o=this;return this._read(function(c){var d=o._ctx;if(d.dir==="next"&&Rt(d,!0)&&0<d.limit){var f=d.valueMapper,p=Yn(d,d.table.core.schema);return d.table.core.query({trans:c,limit:d.limit,values:!0,query:{index:p,range:d.range}}).then(function(y){return y=y.result,f?y.map(f):y})}var g=[];return Gn(d,function(y){return g.push(y)},c,d.table.core).then(function(){return g})},r)},ue.prototype.offset=function(r){var o=this._ctx;return r<=0||(o.offset+=r,Rt(o)?ni(o,function(){var c=r;return function(d,f){return c===0||(c===1?--c:f(function(){d.advance(c),c=0}),!1)}}):ni(o,function(){var c=r;return function(){return--c<0}})),this},ue.prototype.limit=function(r){return this._ctx.limit=Math.min(this._ctx.limit,r),ni(this._ctx,function(){var o=r;return function(c,d,f){return--o<=0&&d(f),0<=o}},!0),this},ue.prototype.until=function(r,o){return ti(this._ctx,function(c,d,f){return!r(c.value)||(d(f),o)}),this},ue.prototype.first=function(r){return this.limit(1).toArray(function(o){return o[0]}).then(r)},ue.prototype.last=function(r){return this.reverse().first(r)},ue.prototype.filter=function(r){var o;return ti(this._ctx,function(c){return r(c.value)}),(o=this._ctx).isMatch=kt(o.isMatch,r),this},ue.prototype.and=function(r){return this.filter(r)},ue.prototype.or=function(r){return new this.db.WhereClause(this._ctx.table,r,this)},ue.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},ue.prototype.desc=function(){return this.reverse()},ue.prototype.eachKey=function(r){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,d){r(d.key,d)})},ue.prototype.eachUniqueKey=function(r){return this._ctx.unique="unique",this.eachKey(r)},ue.prototype.eachPrimaryKey=function(r){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,d){r(d.primaryKey,d)})},ue.prototype.keys=function(r){var o=this._ctx;o.keysOnly=!o.isMatch;var c=[];return this.each(function(d,f){c.push(f.key)}).then(function(){return c}).then(r)},ue.prototype.primaryKeys=function(r){var o=this._ctx;if(o.dir==="next"&&Rt(o,!0)&&0<o.limit)return this._read(function(d){var f=Yn(o,o.table.core.schema);return o.table.core.query({trans:d,values:!1,limit:o.limit,query:{index:f,range:o.range}})}).then(function(d){return d.result}).then(r);o.keysOnly=!o.isMatch;var c=[];return this.each(function(d,f){c.push(f.primaryKey)}).then(function(){return c}).then(r)},ue.prototype.uniqueKeys=function(r){return this._ctx.unique="unique",this.keys(r)},ue.prototype.firstKey=function(r){return this.limit(1).keys(function(o){return o[0]}).then(r)},ue.prototype.lastKey=function(r){return this.reverse().firstKey(r)},ue.prototype.distinct=function(){var r=this._ctx,r=r.index&&r.table.schema.idxByName[r.index];if(!r||!r.multi)return this;var o={};return ti(this._ctx,function(f){var d=f.primaryKey.toString(),f=v(o,d);return o[d]=!0,!f}),this},ue.prototype.modify=function(r){var o=this,c=this._ctx;return this._write(function(d){var f,p,g;g=typeof r=="function"?r:(f=l(r),p=f.length,function(_){for(var M=!1,x=0;x<p;++x){var P=f[x],D=r[P],K=Z(_,P);D instanceof gn?(re(_,P,D.execute(K)),M=!0):K!==D&&(re(_,P,D),M=!0)}return M});var y=c.table.core,b=y.schema.primaryKey,S=b.outbound,I=b.extractKey,E=200,b=o.db._options.modifyChunkSize;b&&(E=typeof b=="object"?b[y.name]||b["*"]||200:b);function L(_,P){var x=P.failures,P=P.numFailures;C+=_-P;for(var D=0,K=l(x);D<K.length;D++){var z=K[D];T.push(x[z])}}var T=[],C=0,A=[];return o.clone().primaryKeys().then(function(_){function M(P){var D=Math.min(E,_.length-P);return y.getMany({trans:d,keys:_.slice(P,P+D),cache:"immutable"}).then(function(K){for(var z=[],R=[],j=S?[]:null,H=[],q=0;q<D;++q){var Y=K[q],ie={value:Re(Y),primKey:_[P+q]};g.call(ie,ie.value,ie)!==!1&&(ie.value==null?H.push(_[P+q]):S||le(I(Y),I(ie.value))===0?(R.push(ie.value),S&&j.push(_[P+q])):(H.push(_[P+q]),z.push(ie.value)))}return Promise.resolve(0<z.length&&y.mutate({trans:d,type:"add",values:z}).then(function(ae){for(var oe in ae.failures)H.splice(parseInt(oe),1);L(z.length,ae)})).then(function(){return(0<R.length||x&&typeof r=="object")&&y.mutate({trans:d,type:"put",keys:j,values:R,criteria:x,changeSpec:typeof r!="function"&&r,isAdditionalChunk:0<P}).then(function(ae){return L(R.length,ae)})}).then(function(){return(0<H.length||x&&r===si)&&y.mutate({trans:d,type:"delete",keys:H,criteria:x,isAdditionalChunk:0<P}).then(function(ae){return L(H.length,ae)})}).then(function(){return _.length>P+D&&M(P+E)})})}var x=Rt(c)&&c.limit===1/0&&(typeof r!="function"||r===si)&&{index:c.index,range:c.range};return M(0).then(function(){if(0<T.length)throw new Nn("Error modifying one or more objects",T,C,A);return _.length})})})},ue.prototype.delete=function(){var r=this._ctx,o=r.range;return Rt(r)&&(r.isPrimKey||o.type===3)?this._write(function(c){var d=r.table.core.schema.primaryKey,f=o;return r.table.core.count({trans:c,query:{index:d,range:f}}).then(function(p){return r.table.core.mutate({trans:c,type:"deleteRange",range:f}).then(function(g){var y=g.failures;if(g.lastResult,g.results,g=g.numFailures,g)throw new Nn("Could not delete some values",Object.keys(y).map(function(S){return y[S]}),p-g);return p-g})})}):this.modify(si)},ue);function ue(){}var si=function(r,o){return o.value=null};function Mo(r,o){return r<o?-1:r===o?0:1}function xo(r,o){return o<r?-1:r===o?0:1}function Oe(r,o,c){return r=r instanceof Mr?new r.Collection(r):r,r._ctx.error=new(c||TypeError)(o),r}function jt(r){return new r.Collection(r,function(){return Or("")}).limit(0)}function Jn(r,o,c,d){var f,p,g,y,S,I,E,b=c.length;if(!c.every(function(C){return typeof C=="string"}))return Oe(r,Sr);function L(C){f=C==="next"?function(_){return _.toUpperCase()}:function(_){return _.toLowerCase()},p=C==="next"?function(_){return _.toLowerCase()}:function(_){return _.toUpperCase()},g=C==="next"?Mo:xo;var A=c.map(function(_){return{lower:p(_),upper:f(_)}}).sort(function(_,M){return g(_.lower,M.lower)});y=A.map(function(_){return _.upper}),S=A.map(function(_){return _.lower}),E=(I=C)==="next"?"":d}L("next"),r=new r.Collection(r,function(){return it(y[0],S[b-1]+d)}),r._ondirectionchange=function(C){L(C)};var T=0;return r._addAlgorithm(function(C,A,_){var M=C.key;if(typeof M!="string")return!1;var x=p(M);if(o(x,S,T))return!0;for(var P=null,D=T;D<b;++D){var K=function(z,R,j,H,q,Y){for(var ie=Math.min(z.length,H.length),ae=-1,oe=0;oe<ie;++oe){var Me=R[oe];if(Me!==H[oe])return q(z[oe],j[oe])<0?z.substr(0,oe)+j[oe]+j.substr(oe+1):q(z[oe],H[oe])<0?z.substr(0,oe)+H[oe]+j.substr(oe+1):0<=ae?z.substr(0,ae)+R[ae]+j.substr(ae+1):null;q(z[oe],Me)<0&&(ae=oe)}return ie<H.length&&Y==="next"?z+j.substr(z.length):ie<z.length&&Y==="prev"?z.substr(0,j.length):ae<0?null:z.substr(0,ae)+H[ae]+j.substr(ae+1)}(M,x,y[D],S[D],g,I);K===null&&P===null?T=D+1:(P===null||0<g(P,K))&&(P=K)}return A(P!==null?function(){C.continue(P+E)}:_),!1}),r}function it(r,o,c,d){return{type:2,lower:r,upper:o,lowerOpen:c,upperOpen:d}}function Or(r){return{type:1,lower:r,upper:r}}var Mr=(Object.defineProperty(Te.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Te.prototype.between=function(r,o,c,d){c=c!==!1,d=d===!0;try{return 0<this._cmp(r,o)||this._cmp(r,o)===0&&(c||d)&&(!c||!d)?jt(this):new this.Collection(this,function(){return it(r,o,!c,!d)})}catch{return Oe(this,Je)}},Te.prototype.equals=function(r){return r==null?Oe(this,Je):new this.Collection(this,function(){return Or(r)})},Te.prototype.above=function(r){return r==null?Oe(this,Je):new this.Collection(this,function(){return it(r,void 0,!0)})},Te.prototype.aboveOrEqual=function(r){return r==null?Oe(this,Je):new this.Collection(this,function(){return it(r,void 0,!1)})},Te.prototype.below=function(r){return r==null?Oe(this,Je):new this.Collection(this,function(){return it(void 0,r,!1,!0)})},Te.prototype.belowOrEqual=function(r){return r==null?Oe(this,Je):new this.Collection(this,function(){return it(void 0,r)})},Te.prototype.startsWith=function(r){return typeof r!="string"?Oe(this,Sr):this.between(r,r+wt,!0,!0)},Te.prototype.startsWithIgnoreCase=function(r){return r===""?this.startsWith(r):Jn(this,function(o,c){return o.indexOf(c[0])===0},[r],wt)},Te.prototype.equalsIgnoreCase=function(r){return Jn(this,function(o,c){return o===c[0]},[r],"")},Te.prototype.anyOfIgnoreCase=function(){var r=Ge.apply(xt,arguments);return r.length===0?jt(this):Jn(this,function(o,c){return c.indexOf(o)!==-1},r,"")},Te.prototype.startsWithAnyOfIgnoreCase=function(){var r=Ge.apply(xt,arguments);return r.length===0?jt(this):Jn(this,function(o,c){return c.some(function(d){return o.indexOf(d)===0})},r,wt)},Te.prototype.anyOf=function(){var r=this,o=Ge.apply(xt,arguments),c=this._cmp;try{o.sort(c)}catch{return Oe(this,Je)}if(o.length===0)return jt(this);var d=new this.Collection(this,function(){return it(o[0],o[o.length-1])});d._ondirectionchange=function(p){c=p==="next"?r._ascending:r._descending,o.sort(c)};var f=0;return d._addAlgorithm(function(p,g,y){for(var S=p.key;0<c(S,o[f]);)if(++f===o.length)return g(y),!1;return c(S,o[f])===0||(g(function(){p.continue(o[f])}),!1)}),d},Te.prototype.notEqual=function(r){return this.inAnyRange([[-1/0,r],[r,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Te.prototype.noneOf=function(){var r=Ge.apply(xt,arguments);if(r.length===0)return new this.Collection(this);try{r.sort(this._ascending)}catch{return Oe(this,Je)}var o=r.reduce(function(c,d){return c?c.concat([[c[c.length-1][1],d]]):[[-1/0,d]]},null);return o.push([r[r.length-1],this.db._maxKey]),this.inAnyRange(o,{includeLowers:!1,includeUppers:!1})},Te.prototype.inAnyRange=function(M,o){var c=this,d=this._cmp,f=this._ascending,p=this._descending,g=this._min,y=this._max;if(M.length===0)return jt(this);if(!M.every(function(x){return x[0]!==void 0&&x[1]!==void 0&&f(x[0],x[1])<=0}))return Oe(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",te.InvalidArgument);var S=!o||o.includeLowers!==!1,I=o&&o.includeUppers===!0,E,b=f;function L(x,P){return b(x[0],P[0])}try{(E=M.reduce(function(x,P){for(var D=0,K=x.length;D<K;++D){var z=x[D];if(d(P[0],z[1])<0&&0<d(P[1],z[0])){z[0]=g(z[0],P[0]),z[1]=y(z[1],P[1]);break}}return D===K&&x.push(P),x},[])).sort(L)}catch{return Oe(this,Je)}var T=0,C=I?function(x){return 0<f(x,E[T][1])}:function(x){return 0<=f(x,E[T][1])},A=S?function(x){return 0<p(x,E[T][0])}:function(x){return 0<=p(x,E[T][0])},_=C,M=new this.Collection(this,function(){return it(E[0][0],E[E.length-1][1],!S,!I)});return M._ondirectionchange=function(x){b=x==="next"?(_=C,f):(_=A,p),E.sort(L)},M._addAlgorithm(function(x,P,D){for(var K,z=x.key;_(z);)if(++T===E.length)return P(D),!1;return!C(K=z)&&!A(K)||(c._cmp(z,E[T][1])===0||c._cmp(z,E[T][0])===0||P(function(){b===f?x.continue(E[T][0]):x.continue(E[T][1])}),!1)}),M},Te.prototype.startsWithAnyOf=function(){var r=Ge.apply(xt,arguments);return r.every(function(o){return typeof o=="string"})?r.length===0?jt(this):this.inAnyRange(r.map(function(o){return[o,o+wt]})):Oe(this,"startsWithAnyOf() only works with strings")},Te);function Te(){}function qe(r){return me(function(o){return yn(o),r(o.target.error),!1})}function yn(r){r.stopPropagation&&r.stopPropagation(),r.preventDefault&&r.preventDefault()}var vn="storagemutated",ii="x-storagemutated-1",rt=pn(null,vn),Po=(ze.prototype._lock=function(){return W(!X.global),++this._reculock,this._reculock!==1||X.global||(X.lockOwnerFor=this),this},ze.prototype._unlock=function(){if(W(!X.global),--this._reculock==0)for(X.global||(X.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var r=this._blockedFuncs.shift();try{bt(r[1],r[0])}catch{}}return this},ze.prototype._locked=function(){return this._reculock&&X.lockOwnerFor!==this},ze.prototype.create=function(r){var o=this;if(!this.mode)return this;var c=this.db.idbdb,d=this.db._state.dbOpenError;if(W(!this.idbtrans),!r&&!c)switch(d&&d.name){case"DatabaseClosedError":throw new te.DatabaseClosed(d);case"MissingAPIError":throw new te.MissingAPI(d.message,d);default:throw new te.OpenFailed(d)}if(!this.active)throw new te.TransactionInactive;return W(this._completion._state===null),(r=this.idbtrans=r||(this.db.core||c).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=me(function(f){yn(f),o._reject(r.error)}),r.onabort=me(function(f){yn(f),o.active&&o._reject(new te.Abort(r.error)),o.active=!1,o.on("abort").fire(f)}),r.oncomplete=me(function(){o.active=!1,o._resolve(),"mutatedParts"in r&&rt.storagemutated.fire(r.mutatedParts)}),this},ze.prototype._promise=function(r,o,c){var d=this;if(r==="readwrite"&&this.mode!=="readwrite")return we(new te.ReadOnly("Transaction is readonly"));if(!this.active)return we(new te.TransactionInactive);if(this._locked())return new U(function(p,g){d._blockedFuncs.push([function(){d._promise(r,o,c).then(p,g)},X])});if(c)return tt(function(){var p=new U(function(g,y){d._lock();var S=o(g,y,d);S&&S.then&&S.then(g,y)});return p.finally(function(){return d._unlock()}),p._lib=!0,p});var f=new U(function(p,g){var y=o(p,g,d);y&&y.then&&y.then(p,g)});return f._lib=!0,f},ze.prototype._root=function(){return this.parent?this.parent._root():this},ze.prototype.waitFor=function(r){var o,c=this._root(),d=U.resolve(r);c._waitingFor?c._waitingFor=c._waitingFor.then(function(){return d}):(c._waitingFor=d,c._waitingQueue=[],o=c.idbtrans.objectStore(c.storeNames[0]),function p(){for(++c._spinCount;c._waitingQueue.length;)c._waitingQueue.shift()();c._waitingFor&&(o.get(-1/0).onsuccess=p)}());var f=c._waitingFor;return new U(function(p,g){d.then(function(y){return c._waitingQueue.push(me(p.bind(null,y)))},function(y){return c._waitingQueue.push(me(g.bind(null,y)))}).finally(function(){c._waitingFor===f&&(c._waitingFor=null)})})},ze.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new te.Abort))},ze.prototype.table=function(r){var o=this._memoizedTables||(this._memoizedTables={});if(v(o,r))return o[r];var c=this.schema[r];if(!c)throw new te.NotFound("Table "+r+" not part of transaction");return c=new this.db.Table(r,c,this),c.core=this.db.core.table(r),o[r]=c},ze);function ze(){}function ri(r,o,c,d,f,p,g){return{name:r,keyPath:o,unique:c,multi:d,auto:f,compound:p,src:(c&&!g?"&":"")+(d?"*":"")+(f?"++":"")+xr(o)}}function xr(r){return typeof r=="string"?r:r?"["+[].join.call(r,"+")+"]":""}function ai(r,o,c){return{name:r,primKey:o,indexes:c,mappedClass:null,idxByName:(d=function(f){return[f.name,f]},c.reduce(function(f,p,g){return g=d(p,g),g&&(f[g[0]]=g[1]),f},{}))};var d}var bn=function(r){try{return r.only([[]]),bn=function(){return[[]]},[[]]}catch{return bn=function(){return wt},wt}};function oi(r){return r==null?function(){}:typeof r=="string"?(o=r).split(".").length===1?function(c){return c[o]}:function(c){return Z(c,o)}:function(c){return Z(c,r)};var o}function Pr(r){return[].slice.call(r)}var No=0;function wn(r){return r==null?":id":typeof r=="string"?r:"[".concat(r.join("+"),"]")}function $o(r,o,S){function d(_){if(_.type===3)return null;if(_.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var T=_.lower,C=_.upper,A=_.lowerOpen,_=_.upperOpen;return T===void 0?C===void 0?null:o.upperBound(C,!!_):C===void 0?o.lowerBound(T,!!A):o.bound(T,C,!!A,!!_)}function f(L){var T,C=L.name;return{name:C,schema:L,mutate:function(A){var _=A.trans,M=A.type,x=A.keys,P=A.values,D=A.range;return new Promise(function(K,z){K=me(K);var R=_.objectStore(C),j=R.keyPath==null,H=M==="put"||M==="add";if(!H&&M!=="delete"&&M!=="deleteRange")throw new Error("Invalid operation type: "+M);var q,Y=(x||P||{length:1}).length;if(x&&P&&x.length!==P.length)throw new Error("Given keys array must have same length as given values array.");if(Y===0)return K({numFailures:0,failures:{},results:[],lastResult:void 0});function ie(Ae){++Me,yn(Ae)}var ae=[],oe=[],Me=0;if(M==="deleteRange"){if(D.type===4)return K({numFailures:Me,failures:oe,results:[],lastResult:void 0});D.type===3?ae.push(q=R.clear()):ae.push(q=R.delete(d(D)))}else{var j=H?j?[P,x]:[P,null]:[x,null],se=j[0],_e=j[1];if(H)for(var Ce=0;Ce<Y;++Ce)ae.push(q=_e&&_e[Ce]!==void 0?R[M](se[Ce],_e[Ce]):R[M](se[Ce])),q.onerror=ie;else for(Ce=0;Ce<Y;++Ce)ae.push(q=R[M](se[Ce])),q.onerror=ie}function ls(Ae){Ae=Ae.target.result,ae.forEach(function(It,_i){return It.error!=null&&(oe[_i]=It.error)}),K({numFailures:Me,failures:oe,results:M==="delete"?x:ae.map(function(It){return It.result}),lastResult:Ae})}q.onerror=function(Ae){ie(Ae),ls(Ae)},q.onsuccess=ls})},getMany:function(A){var _=A.trans,M=A.keys;return new Promise(function(x,P){x=me(x);for(var D,K=_.objectStore(C),z=M.length,R=new Array(z),j=0,H=0,q=function(ae){ae=ae.target,R[ae._pos]=ae.result,++H===j&&x(R)},Y=qe(P),ie=0;ie<z;++ie)M[ie]!=null&&((D=K.get(M[ie]))._pos=ie,D.onsuccess=q,D.onerror=Y,++j);j===0&&x(R)})},get:function(A){var _=A.trans,M=A.key;return new Promise(function(x,P){x=me(x);var D=_.objectStore(C).get(M);D.onsuccess=function(K){return x(K.target.result)},D.onerror=qe(P)})},query:(T=I,function(A){return new Promise(function(_,M){_=me(_);var x,P,D,j=A.trans,K=A.values,z=A.limit,q=A.query,R=z===1/0?void 0:z,H=q.index,q=q.range,j=j.objectStore(C),H=H.isPrimaryKey?j:j.index(H.name),q=d(q);if(z===0)return _({result:[]});T?((R=K?H.getAll(q,R):H.getAllKeys(q,R)).onsuccess=function(Y){return _({result:Y.target.result})},R.onerror=qe(M)):(x=0,P=!K&&"openKeyCursor"in H?H.openKeyCursor(q):H.openCursor(q),D=[],P.onsuccess=function(Y){var ie=P.result;return ie?(D.push(K?ie.value:ie.primaryKey),++x===z?_({result:D}):void ie.continue()):_({result:D})},P.onerror=qe(M))})}),openCursor:function(A){var _=A.trans,M=A.values,x=A.query,P=A.reverse,D=A.unique;return new Promise(function(K,z){K=me(K);var H=x.index,R=x.range,j=_.objectStore(C),j=H.isPrimaryKey?j:j.index(H.name),H=P?D?"prevunique":"prev":D?"nextunique":"next",q=!M&&"openKeyCursor"in j?j.openKeyCursor(d(R),H):j.openCursor(d(R),H);q.onerror=qe(z),q.onsuccess=me(function(Y){var ie,ae,oe,Me,se=q.result;se?(se.___id=++No,se.done=!1,ie=se.continue.bind(se),ae=(ae=se.continuePrimaryKey)&&ae.bind(se),oe=se.advance.bind(se),Me=function(){throw new Error("Cursor not stopped")},se.trans=_,se.stop=se.continue=se.continuePrimaryKey=se.advance=function(){throw new Error("Cursor not started")},se.fail=me(z),se.next=function(){var _e=this,Ce=1;return this.start(function(){return Ce--?_e.continue():_e.stop()}).then(function(){return _e})},se.start=function(_e){function Ce(){if(q.result)try{_e()}catch(Ae){se.fail(Ae)}else se.done=!0,se.start=function(){throw new Error("Cursor behind last entry")},se.stop()}var ls=new Promise(function(Ae,It){Ae=me(Ae),q.onerror=qe(It),se.fail=It,se.stop=function(_i){se.stop=se.continue=se.continuePrimaryKey=se.advance=Me,Ae(_i)}});return q.onsuccess=me(function(Ae){q.onsuccess=Ce,Ce()}),se.continue=ie,se.continuePrimaryKey=ae,se.advance=oe,Ce(),ls},K(se)):K(null)},z)})},count:function(A){var _=A.query,M=A.trans,x=_.index,P=_.range;return new Promise(function(D,K){var z=M.objectStore(C),R=x.isPrimaryKey?z:z.index(x.name),z=d(P),R=z?R.count(z):R.count();R.onsuccess=me(function(j){return D(j.target.result)}),R.onerror=qe(K)})}}}var p,g,y,E=(g=S,y=Pr((p=r).objectStoreNames),{schema:{name:p.name,tables:y.map(function(L){return g.objectStore(L)}).map(function(L){var T=L.keyPath,_=L.autoIncrement,C=u(T),A={},_={name:L.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:T==null,compound:C,keyPath:T,autoIncrement:_,unique:!0,extractKey:oi(T)},indexes:Pr(L.indexNames).map(function(M){return L.index(M)}).map(function(D){var x=D.name,P=D.unique,K=D.multiEntry,D=D.keyPath,K={name:x,compound:u(D),keyPath:D,unique:P,multiEntry:K,extractKey:oi(D)};return A[wn(D)]=K}),getIndexByKeyPath:function(M){return A[wn(M)]}};return A[":id"]=_.primaryKey,T!=null&&(A[wn(T)]=_.primaryKey),_})},hasGetAll:0<y.length&&"getAll"in g.objectStore(y[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),S=E.schema,I=E.hasGetAll,E=S.tables.map(f),b={};return E.forEach(function(L){return b[L.name]=L}),{stack:"dbcore",transaction:r.transaction.bind(r),table:function(L){if(!b[L])throw new Error("Table '".concat(L,"' not found"));return b[L]},MIN_KEY:-1/0,MAX_KEY:bn(o),schema:S}}function Do(r,o,c,d){var f=c.IDBKeyRange;return c.indexedDB,{dbcore:(d=$o(o,f,d),r.dbcore.reduce(function(p,g){return g=g.create,n(n({},p),g(p))},d))}}function Wn(r,d){var c=d.db,d=Do(r._middlewares,c,r._deps,d);r.core=d.dbcore,r.tables.forEach(function(f){var p=f.name;r.core.schema.tables.some(function(g){return g.name===p})&&(f.core=r.core.table(p),r[p]instanceof r.Table&&(r[p].core=f.core))})}function Qn(r,o,c,d){c.forEach(function(f){var p=d[f];o.forEach(function(g){var y=function S(I,E){return N(I,E)||(I=m(I))&&S(I,E)}(g,f);(!y||"value"in y&&y.value===void 0)&&(g===r.Transaction.prototype||g instanceof r.Transaction?F(g,f,{get:function(){return this.table(f)},set:function(S){B(this,f,{value:S,writable:!0,configurable:!0,enumerable:!0})}}):g[f]=new r.Table(f,p))})})}function li(r,o){o.forEach(function(c){for(var d in c)c[d]instanceof r.Table&&delete c[d]})}function Fo(r,o){return r._cfg.version-o._cfg.version}function Ko(r,o,c,d){var f=r._dbSchema;c.objectStoreNames.contains("$meta")&&!f.$meta&&(f.$meta=ai("$meta",$r("")[0],[]),r._storeNames.push("$meta"));var p=r._createTransaction("readwrite",r._storeNames,f);p.create(c),p._completion.catch(d);var g=p._reject.bind(p),y=X.transless||X;tt(function(){return X.trans=p,X.transless=y,o!==0?(Wn(r,c),I=o,((S=p).storeNames.includes("$meta")?S.table("$meta").get("version").then(function(E){return E??I}):U.resolve(I)).then(function(E){return L=E,T=p,C=c,A=[],E=(b=r)._versions,_=b._dbSchema=Zn(0,b.idbdb,C),(E=E.filter(function(M){return M._cfg.version>=L})).length!==0?(E.forEach(function(M){A.push(function(){var x=_,P=M._cfg.dbschema;es(b,x,C),es(b,P,C),_=b._dbSchema=P;var D=ci(x,P);D.add.forEach(function(H){ui(C,H[0],H[1].primKey,H[1].indexes)}),D.change.forEach(function(H){if(H.recreate)throw new te.Upgrade("Not yet support for changing primary key");var q=C.objectStore(H.name);H.add.forEach(function(Y){return Xn(q,Y)}),H.change.forEach(function(Y){q.deleteIndex(Y.name),Xn(q,Y)}),H.del.forEach(function(Y){return q.deleteIndex(Y)})});var K=M._cfg.contentUpgrade;if(K&&M._cfg.version>L){Wn(b,C),T._memoizedTables={};var z=J(P);D.del.forEach(function(H){z[H]=x[H]}),li(b,[b.Transaction.prototype]),Qn(b,[b.Transaction.prototype],l(z),z),T.schema=z;var R,j=qs(K);return j&&Ft(),D=U.follow(function(){var H;(R=K(T))&&j&&(H=nt.bind(null,null),R.then(H,H))}),R&&typeof R.then=="function"?U.resolve(R):D.then(function(){return R})}}),A.push(function(x){var P,D,K=M._cfg.dbschema;P=K,D=x,[].slice.call(D.db.objectStoreNames).forEach(function(z){return P[z]==null&&D.db.deleteObjectStore(z)}),li(b,[b.Transaction.prototype]),Qn(b,[b.Transaction.prototype],b._storeNames,b._dbSchema),T.schema=b._dbSchema}),A.push(function(x){b.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(b.idbdb.version/10)===M._cfg.version?(b.idbdb.deleteObjectStore("$meta"),delete b._dbSchema.$meta,b._storeNames=b._storeNames.filter(function(P){return P!=="$meta"})):x.objectStore("$meta").put(M._cfg.version,"version"))})}),function M(){return A.length?U.resolve(A.shift()(T.idbtrans)).then(M):U.resolve()}().then(function(){Nr(_,C)})):U.resolve();var b,L,T,C,A,_}).catch(g)):(l(f).forEach(function(E){ui(c,E,f[E].primKey,f[E].indexes)}),Wn(r,c),void U.follow(function(){return r.on.populate.fire(p)}).catch(g));var S,I})}function Ro(r,o){Nr(r._dbSchema,o),o.db.version%10!=0||o.objectStoreNames.contains("$meta")||o.db.createObjectStore("$meta").add(Math.ceil(o.db.version/10-1),"version");var c=Zn(0,r.idbdb,o);es(r,r._dbSchema,o);for(var d=0,f=ci(c,r._dbSchema).change;d<f.length;d++){var p=function(g){if(g.change.length||g.recreate)return console.warn("Unable to patch indexes of table ".concat(g.name," because it has changes on the type of index or primary key.")),{value:void 0};var y=o.objectStore(g.name);g.add.forEach(function(S){je&&console.debug("Dexie upgrade patch: Creating missing index ".concat(g.name,".").concat(S.src)),Xn(y,S)})}(f[d]);if(typeof p=="object")return p.value}}function ci(r,o){var c,d={del:[],add:[],change:[]};for(c in r)o[c]||d.del.push(c);for(c in o){var f=r[c],p=o[c];if(f){var g={name:c,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(f.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||f.primKey.auto!==p.primKey.auto)g.recreate=!0,d.change.push(g);else{var y=f.idxByName,S=p.idxByName,I=void 0;for(I in y)S[I]||g.del.push(I);for(I in S){var E=y[I],b=S[I];E?E.src!==b.src&&g.change.push(b):g.add.push(b)}(0<g.del.length||0<g.add.length||0<g.change.length)&&d.change.push(g)}}else d.add.push([c,p])}return d}function ui(r,o,c,d){var f=r.db.createObjectStore(o,c.keyPath?{keyPath:c.keyPath,autoIncrement:c.auto}:{autoIncrement:c.auto});return d.forEach(function(p){return Xn(f,p)}),f}function Nr(r,o){l(r).forEach(function(c){o.db.objectStoreNames.contains(c)||(je&&console.debug("Dexie: Creating missing table",c),ui(o,c,r[c].primKey,r[c].indexes))})}function Xn(r,o){r.createIndex(o.name,o.keyPath,{unique:o.unique,multiEntry:o.multi})}function Zn(r,o,c){var d={};return G(o.objectStoreNames,0).forEach(function(f){for(var p=c.objectStore(f),g=ri(xr(I=p.keyPath),I||"",!0,!1,!!p.autoIncrement,I&&typeof I!="string",!0),y=[],S=0;S<p.indexNames.length;++S){var E=p.index(p.indexNames[S]),I=E.keyPath,E=ri(E.name,I,!!E.unique,!!E.multiEntry,!1,I&&typeof I!="string",!1);y.push(E)}d[f]=ai(f,g,y)}),d}function es(r,o,c){for(var d=c.db.objectStoreNames,f=0;f<d.length;++f){var p=d[f],g=c.objectStore(p);r._hasGetAll="getAll"in g;for(var y=0;y<g.indexNames.length;++y){var S=g.indexNames[y],I=g.index(S).keyPath,E=typeof I=="string"?I:"["+G(I).join("+")+"]";!o[p]||(I=o[p].idxByName[E])&&(I.name=S,delete o[p].idxByName[E],o[p].idxByName[S]=I)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(r._hasGetAll=!1)}function $r(r){return r.split(",").map(function(o,c){var d=(o=o.trim()).replace(/([&*]|\+\+)/g,""),f=/^\[/.test(d)?d.match(/^\[(.*)\]$/)[1].split("+"):d;return ri(d,f||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),u(f),c===0)})}var jo=(ts.prototype._parseStoresSpec=function(r,o){l(r).forEach(function(c){if(r[c]!==null){var d=$r(r[c]),f=d.shift();if(f.unique=!0,f.multi)throw new te.Schema("Primary key cannot be multi-valued");d.forEach(function(p){if(p.auto)throw new te.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new te.Schema("Index must have a name and cannot be an empty string")}),o[c]=ai(c,f,d)}})},ts.prototype.stores=function(c){var o=this.db;this._cfg.storesSource=this._cfg.storesSource?h(this._cfg.storesSource,c):c;var c=o._versions,d={},f={};return c.forEach(function(p){h(d,p._cfg.storesSource),f=p._cfg.dbschema={},p._parseStoresSpec(d,f)}),o._dbSchema=f,li(o,[o._allTables,o,o.Transaction.prototype]),Qn(o,[o._allTables,o,o.Transaction.prototype,this._cfg.tables],l(f),f),o._storeNames=l(f),this},ts.prototype.upgrade=function(r){return this._cfg.contentUpgrade=Hs(this._cfg.contentUpgrade||de,r),this},ts);function ts(){}function di(r,o){var c=r._dbNamesDB;return c||(c=r._dbNamesDB=new We(Un,{addons:[],indexedDB:r,IDBKeyRange:o})).version(1).stores({dbnames:"name"}),c.table("dbnames")}function fi(r){return r&&typeof r.databases=="function"}function hi(r){return tt(function(){return X.letThrough=!0,r()})}function pi(r){return!("from"in r)}var Ie=function(r,o){if(!this){var c=new Ie;return r&&"d"in r&&h(c,r),c}h(this,arguments.length?{d:1,from:r,to:1<arguments.length?o:r}:{d:0})};function kn(r,o,c){var d=le(o,c);if(!isNaN(d)){if(0<d)throw RangeError();if(pi(r))return h(r,{from:o,to:c,d:1});var f=r.l,d=r.r;if(le(c,r.from)<0)return f?kn(f,o,c):r.l={from:o,to:c,d:1,l:null,r:null},Fr(r);if(0<le(o,r.to))return d?kn(d,o,c):r.r={from:o,to:c,d:1,l:null,r:null},Fr(r);le(o,r.from)<0&&(r.from=o,r.l=null,r.d=d?d.d+1:1),0<le(c,r.to)&&(r.to=c,r.r=null,r.d=r.l?r.l.d+1:1),c=!r.r,f&&!r.l&&Sn(r,f),d&&c&&Sn(r,d)}}function Sn(r,o){pi(o)||function c(d,S){var p=S.from,g=S.to,y=S.l,S=S.r;kn(d,p,g),y&&c(d,y),S&&c(d,S)}(r,o)}function Dr(r,o){var c=ns(o),d=c.next();if(d.done)return!1;for(var f=d.value,p=ns(r),g=p.next(f.from),y=g.value;!d.done&&!g.done;){if(le(y.from,f.to)<=0&&0<=le(y.to,f.from))return!0;le(f.from,y.from)<0?f=(d=c.next(y.from)).value:y=(g=p.next(f.from)).value}return!1}function ns(r){var o=pi(r)?null:{s:0,n:r};return{next:function(c){for(var d=0<arguments.length;o;)switch(o.s){case 0:if(o.s=1,d)for(;o.n.l&&le(c,o.n.from)<0;)o={up:o,n:o.n.l,s:1};else for(;o.n.l;)o={up:o,n:o.n.l,s:1};case 1:if(o.s=2,!d||le(c,o.n.to)<=0)return{value:o.n,done:!1};case 2:if(o.n.r){o.s=3,o={up:o,n:o.n.r,s:0};continue}case 3:o=o.up}return{done:!0}}}}function Fr(r){var o,c,d=(((o=r.r)===null||o===void 0?void 0:o.d)||0)-(((c=r.l)===null||c===void 0?void 0:c.d)||0),f=1<d?"r":d<-1?"l":"";f&&(o=f=="r"?"l":"r",c=n({},r),d=r[f],r.from=d.from,r.to=d.to,r[f]=d[f],c[f]=d[o],(r[o]=c).d=Kr(c)),r.d=Kr(r)}function Kr(c){var o=c.r,c=c.l;return(o?c?Math.max(o.d,c.d):o.d:c?c.d:0)+1}function ss(r,o){return l(o).forEach(function(c){r[c]?Sn(r[c],o[c]):r[c]=function d(f){var p,g,y={};for(p in f)v(f,p)&&(g=f[p],y[p]=!g||typeof g!="object"||Ye.has(g.constructor)?g:d(g));return y}(o[c])}),r}function mi(r,o){return r.all||o.all||Object.keys(r).some(function(c){return o[c]&&Dr(o[c],r[c])})}k(Ie.prototype,((Pe={add:function(r){return Sn(this,r),this},addKey:function(r){return kn(this,r,r),this},addKeys:function(r){var o=this;return r.forEach(function(c){return kn(o,c,c)}),this},hasKey:function(r){var o=ns(this).next(r).value;return o&&le(o.from,r)<=0&&0<=le(o.to,r)}})[js]=function(){return ns(this)},Pe));var St={},gi={},yi=!1;function is(r){ss(gi,r),yi||(yi=!0,setTimeout(function(){yi=!1,vi(gi,!(gi={}))},0))}function vi(r,o){o===void 0&&(o=!1);var c=new Set;if(r.all)for(var d=0,f=Object.values(St);d<f.length;d++)Rr(g=f[d],r,c,o);else for(var p in r){var g,y=/^idb\:\/\/(.*)\/(.*)\//.exec(p);y&&(p=y[1],y=y[2],(g=St["idb://".concat(p,"/").concat(y)])&&Rr(g,r,c,o))}c.forEach(function(S){return S()})}function Rr(r,o,c,d){for(var f=[],p=0,g=Object.entries(r.queries.query);p<g.length;p++){for(var y=g[p],S=y[0],I=[],E=0,b=y[1];E<b.length;E++){var L=b[E];mi(o,L.obsSet)?L.subscribers.forEach(function(_){return c.add(_)}):d&&I.push(L)}d&&f.push([S,I])}if(d)for(var T=0,C=f;T<C.length;T++){var A=C[T],S=A[0],I=A[1];r.queries.query[S]=I}}function qo(r){var o=r._state,c=r._deps.indexedDB;if(o.isBeingOpened||r.idbdb)return o.dbReadyPromise.then(function(){return o.dbOpenError?we(o.dbOpenError):r});o.isBeingOpened=!0,o.dbOpenError=null,o.openComplete=!1;var d=o.openCanceller,f=Math.round(10*r.verno),p=!1;function g(){if(o.openCanceller!==d)throw new te.DatabaseClosed("db.open() was cancelled")}function y(){return new U(function(L,T){if(g(),!c)throw new te.MissingAPI;var C=r.name,A=o.autoSchema||!f?c.open(C):c.open(C,f);if(!A)throw new te.MissingAPI;A.onerror=qe(T),A.onblocked=me(r._fireOnBlocked),A.onupgradeneeded=me(function(_){var M;E=A.transaction,o.autoSchema&&!r._options.allowEmptyDB?(A.onerror=yn,E.abort(),A.result.close(),(M=c.deleteDatabase(C)).onsuccess=M.onerror=me(function(){T(new te.NoSuchDatabase("Database ".concat(C," doesnt exist")))})):(E.onerror=qe(T),_=_.oldVersion>Math.pow(2,62)?0:_.oldVersion,b=_<1,r.idbdb=A.result,p&&Ro(r,E),Ko(r,_/10,E,T))},T),A.onsuccess=me(function(){E=null;var _,M,x,P,D,K=r.idbdb=A.result,z=G(K.objectStoreNames);if(0<z.length)try{var R=K.transaction((P=z).length===1?P[0]:P,"readonly");if(o.autoSchema)M=K,x=R,(_=r).verno=M.version/10,x=_._dbSchema=Zn(0,M,x),_._storeNames=G(M.objectStoreNames,0),Qn(_,[_._allTables],l(x),x);else if(es(r,r._dbSchema,R),((D=ci(Zn(0,(D=r).idbdb,R),D._dbSchema)).add.length||D.change.some(function(j){return j.add.length||j.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),K.close(),f=K.version+1,p=!0,L(y());Wn(r,R)}catch{}Kt.push(r),K.onversionchange=me(function(j){o.vcFired=!0,r.on("versionchange").fire(j)}),K.onclose=me(function(j){r.on("close").fire(j)}),b&&(D=r._deps,R=C,K=D.indexedDB,D=D.IDBKeyRange,fi(K)||R===Un||di(K,D).put({name:R}).catch(de)),L()},T)}).catch(function(L){switch(L==null?void 0:L.name){case"UnknownError":if(0<o.PR1398_maxLoop)return o.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),y();break;case"VersionError":if(0<f)return f=0,y()}return U.reject(L)})}var S,I=o.dbReadyResolve,E=null,b=!1;return U.race([d,(typeof navigator>"u"?U.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(L){function T(){return indexedDB.databases().finally(L)}S=setInterval(T,100),T()}).finally(function(){return clearInterval(S)}):Promise.resolve()).then(y)]).then(function(){return g(),o.onReadyBeingFired=[],U.resolve(hi(function(){return r.on.ready.fire(r.vip)})).then(function L(){if(0<o.onReadyBeingFired.length){var T=o.onReadyBeingFired.reduce(Hs,de);return o.onReadyBeingFired=[],U.resolve(hi(function(){return T(r.vip)})).then(L)}})}).finally(function(){o.openCanceller===d&&(o.onReadyBeingFired=null,o.isBeingOpened=!1)}).catch(function(L){o.dbOpenError=L;try{E&&E.abort()}catch{}return d===o.openCanceller&&r._close(),we(L)}).finally(function(){o.openComplete=!0,I()}).then(function(){var L;return b&&(L={},r.tables.forEach(function(T){T.schema.indexes.forEach(function(C){C.name&&(L["idb://".concat(r.name,"/").concat(T.name,"/").concat(C.name)]=new Ie(-1/0,[[[]]]))}),L["idb://".concat(r.name,"/").concat(T.name,"/")]=L["idb://".concat(r.name,"/").concat(T.name,"/:dels")]=new Ie(-1/0,[[[]]])}),rt(vn).fire(L),vi(L,!0)),r})}function bi(r){function o(p){return r.next(p)}var c=f(o),d=f(function(p){return r.throw(p)});function f(p){return function(S){var y=p(S),S=y.value;return y.done?S:S&&typeof S.then=="function"?S.then(c,d):u(S)?Promise.all(S).then(c,d):c(S)}}return f(o)()}function rs(r,o,c){for(var d=u(r)?r.slice():[r],f=0;f<c;++f)d.push(o);return d}var zo={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(r){return n(n({},r),{table:function(o){var c=r.table(o),d=c.schema,f={},p=[];function g(b,L,T){var C=wn(b),A=f[C]=f[C]||[],_=b==null?0:typeof b=="string"?1:b.length,M=0<L,M=n(n({},T),{name:M?"".concat(C,"(virtual-from:").concat(T.name,")"):T.name,lowLevelIndex:T,isVirtual:M,keyTail:L,keyLength:_,extractKey:oi(b),unique:!M&&T.unique});return A.push(M),M.isPrimaryKey||p.push(M),1<_&&g(_===2?b[0]:b.slice(0,_-1),L+1,T),A.sort(function(x,P){return x.keyTail-P.keyTail}),M}o=g(d.primaryKey.keyPath,0,d.primaryKey),f[":id"]=[o];for(var y=0,S=d.indexes;y<S.length;y++){var I=S[y];g(I.keyPath,0,I)}function E(b){var L,T=b.query.index;return T.isVirtual?n(n({},b),{query:{index:T.lowLevelIndex,range:(L=b.query.range,T=T.keyTail,{type:L.type===1?2:L.type,lower:rs(L.lower,L.lowerOpen?r.MAX_KEY:r.MIN_KEY,T),lowerOpen:!0,upper:rs(L.upper,L.upperOpen?r.MIN_KEY:r.MAX_KEY,T),upperOpen:!0})}}):b}return n(n({},c),{schema:n(n({},d),{primaryKey:o,indexes:p,getIndexByKeyPath:function(b){return(b=f[wn(b)])&&b[0]}}),count:function(b){return c.count(E(b))},query:function(b){return c.query(E(b))},openCursor:function(b){var L=b.query.index,T=L.keyTail,C=L.isVirtual,A=L.keyLength;return C?c.openCursor(E(b)).then(function(M){return M&&_(M)}):c.openCursor(b);function _(M){return Object.create(M,{continue:{value:function(x){x!=null?M.continue(rs(x,b.reverse?r.MAX_KEY:r.MIN_KEY,T)):b.unique?M.continue(M.key.slice(0,A).concat(b.reverse?r.MIN_KEY:r.MAX_KEY,T)):M.continue()}},continuePrimaryKey:{value:function(x,P){M.continuePrimaryKey(rs(x,r.MAX_KEY,T),P)}},primaryKey:{get:function(){return M.primaryKey}},key:{get:function(){var x=M.key;return A===1?x[0]:x.slice(0,A)}},value:{get:function(){return M.value}}})}}})}})}};function wi(r,o,c,d){return c=c||{},d=d||"",l(r).forEach(function(f){var p,g,y;v(o,f)?(p=r[f],g=o[f],typeof p=="object"&&typeof g=="object"&&p&&g?(y=Rs(p))!==Rs(g)?c[d+f]=o[f]:y==="Object"?wi(p,g,c,d+f+"."):p!==g&&(c[d+f]=o[f]):p!==g&&(c[d+f]=o[f])):c[d+f]=void 0}),l(o).forEach(function(f){v(r,f)||(c[d+f]=o[f])}),c}function ki(r,o){return o.type==="delete"?o.keys:o.keys||o.values.map(r.extractKey)}var Ho={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(r){return n(n({},r),{table:function(o){var c=r.table(o),d=c.schema.primaryKey;return n(n({},c),{mutate:function(f){var p=X.trans,g=p.table(o).hook,y=g.deleting,S=g.creating,I=g.updating;switch(f.type){case"add":if(S.fire===de)break;return p._promise("readwrite",function(){return E(f)},!0);case"put":if(S.fire===de&&I.fire===de)break;return p._promise("readwrite",function(){return E(f)},!0);case"delete":if(y.fire===de)break;return p._promise("readwrite",function(){return E(f)},!0);case"deleteRange":if(y.fire===de)break;return p._promise("readwrite",function(){return function b(L,T,C){return c.query({trans:L,values:!1,query:{index:d,range:T},limit:C}).then(function(A){var _=A.result;return E({type:"delete",keys:_,trans:L}).then(function(M){return 0<M.numFailures?Promise.reject(M.failures[0]):_.length<C?{failures:[],numFailures:0,lastResult:void 0}:b(L,n(n({},T),{lower:_[_.length-1],lowerOpen:!0}),C)})})}(f.trans,f.range,1e4)},!0)}return c.mutate(f);function E(b){var L,T,C,A=X.trans,_=b.keys||ki(d,b);if(!_)throw new Error("Keys missing");return(b=b.type==="add"||b.type==="put"?n(n({},b),{keys:_}):n({},b)).type!=="delete"&&(b.values=s([],b.values)),b.keys&&(b.keys=s([],b.keys)),L=c,C=_,((T=b).type==="add"?Promise.resolve([]):L.getMany({trans:T.trans,keys:C,cache:"immutable"})).then(function(M){var x=_.map(function(P,D){var K,z,R,j=M[D],H={onerror:null,onsuccess:null};return b.type==="delete"?y.fire.call(H,P,j,A):b.type==="add"||j===void 0?(K=S.fire.call(H,P,b.values[D],A),P==null&&K!=null&&(b.keys[D]=P=K,d.outbound||re(b.values[D],d.keyPath,P))):(K=wi(j,b.values[D]),(z=I.fire.call(H,K,P,j,A))&&(R=b.values[D],Object.keys(z).forEach(function(q){v(R,q)?R[q]=z[q]:re(R,q,z[q])}))),H});return c.mutate(b).then(function(P){for(var D=P.failures,K=P.results,z=P.numFailures,P=P.lastResult,R=0;R<_.length;++R){var j=(K||_)[R],H=x[R];j==null?H.onerror&&H.onerror(D[R]):H.onsuccess&&H.onsuccess(b.type==="put"&&M[R]?b.values[R]:j)}return{failures:D,results:K,numFailures:z,lastResult:P}}).catch(function(P){return x.forEach(function(D){return D.onerror&&D.onerror(P)}),Promise.reject(P)})})}}})}})}};function jr(r,o,c){try{if(!o||o.keys.length<r.length)return null;for(var d=[],f=0,p=0;f<o.keys.length&&p<r.length;++f)le(o.keys[f],r[p])===0&&(d.push(c?Re(o.values[f]):o.values[f]),++p);return d.length===r.length?d:null}catch{return null}}var Uo={stack:"dbcore",level:-1,create:function(r){return{table:function(o){var c=r.table(o);return n(n({},c),{getMany:function(d){if(!d.cache)return c.getMany(d);var f=jr(d.keys,d.trans._cache,d.cache==="clone");return f?U.resolve(f):c.getMany(d).then(function(p){return d.trans._cache={keys:d.keys,values:d.cache==="clone"?Re(p):p},p})},mutate:function(d){return d.type!=="add"&&(d.trans._cache=null),c.mutate(d)}})}}}};function qr(r,o){return r.trans.mode==="readonly"&&!!r.subscr&&!r.trans.explicit&&r.trans.db._options.cache!=="disabled"&&!o.schema.primaryKey.outbound}function zr(r,o){switch(r){case"query":return o.values&&!o.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Vo={stack:"dbcore",level:0,name:"Observability",create:function(r){var o=r.schema.name,c=new Ie(r.MIN_KEY,r.MAX_KEY);return n(n({},r),{transaction:function(d,f,p){if(X.subscr&&f!=="readonly")throw new te.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(X.querier));return r.transaction(d,f,p)},table:function(d){var f=r.table(d),p=f.schema,g=p.primaryKey,b=p.indexes,y=g.extractKey,S=g.outbound,I=g.autoIncrement&&b.filter(function(T){return T.compound&&T.keyPath.includes(g.keyPath)}),E=n(n({},f),{mutate:function(T){function C(q){return q="idb://".concat(o,"/").concat(d,"/").concat(q),P[q]||(P[q]=new Ie)}var A,_,M,x=T.trans,P=T.mutatedParts||(T.mutatedParts={}),D=C(""),K=C(":dels"),z=T.type,H=T.type==="deleteRange"?[T.range]:T.type==="delete"?[T.keys]:T.values.length<50?[ki(g,T).filter(function(q){return q}),T.values]:[],R=H[0],j=H[1],H=T.trans._cache;return u(R)?(D.addKeys(R),(H=z==="delete"||R.length===j.length?jr(R,H):null)||K.addKeys(R),(H||j)&&(A=C,_=H,M=j,p.indexes.forEach(function(q){var Y=A(q.name||"");function ie(oe){return oe!=null?q.extractKey(oe):null}function ae(oe){return q.multiEntry&&u(oe)?oe.forEach(function(Me){return Y.addKey(Me)}):Y.addKey(oe)}(_||M).forEach(function(oe,_e){var se=_&&ie(_[_e]),_e=M&&ie(M[_e]);le(se,_e)!==0&&(se!=null&&ae(se),_e!=null&&ae(_e))})}))):R?(j={from:(j=R.lower)!==null&&j!==void 0?j:r.MIN_KEY,to:(j=R.upper)!==null&&j!==void 0?j:r.MAX_KEY},K.add(j),D.add(j)):(D.add(c),K.add(c),p.indexes.forEach(function(q){return C(q.name).add(c)})),f.mutate(T).then(function(q){return!R||T.type!=="add"&&T.type!=="put"||(D.addKeys(q.results),I&&I.forEach(function(Y){for(var ie=T.values.map(function(se){return Y.extractKey(se)}),ae=Y.keyPath.findIndex(function(se){return se===g.keyPath}),oe=0,Me=q.results.length;oe<Me;++oe)ie[oe][ae]=q.results[oe];C(Y.name).addKeys(ie)})),x.mutatedParts=ss(x.mutatedParts||{},P),q})}}),b=function(C){var A=C.query,C=A.index,A=A.range;return[C,new Ie((C=A.lower)!==null&&C!==void 0?C:r.MIN_KEY,(A=A.upper)!==null&&A!==void 0?A:r.MAX_KEY)]},L={get:function(T){return[g,new Ie(T.key)]},getMany:function(T){return[g,new Ie().addKeys(T.keys)]},count:b,query:b,openCursor:b};return l(L).forEach(function(T){E[T]=function(C){var A=X.subscr,_=!!A,M=qr(X,f)&&zr(T,C)?C.obsSet={}:A;if(_){var x=function(j){return j="idb://".concat(o,"/").concat(d,"/").concat(j),M[j]||(M[j]=new Ie)},P=x(""),D=x(":dels"),A=L[T](C),_=A[0],A=A[1];if((T==="query"&&_.isPrimaryKey&&!C.values?D:x(_.name||"")).add(A),!_.isPrimaryKey){if(T!=="count"){var K=T==="query"&&S&&C.values&&f.query(n(n({},C),{values:!1}));return f[T].apply(this,arguments).then(function(j){if(T==="query"){if(S&&C.values)return K.then(function(ie){return ie=ie.result,P.addKeys(ie),j});var H=C.values?j.result.map(y):j.result;(C.values?P:D).addKeys(H)}else if(T==="openCursor"){var q=j,Y=C.values;return q&&Object.create(q,{key:{get:function(){return D.addKey(q.primaryKey),q.key}},primaryKey:{get:function(){var ie=q.primaryKey;return D.addKey(ie),ie}},value:{get:function(){return Y&&P.addKey(q.primaryKey),q.value}}})}return j})}D.add(c)}}return f[T].apply(this,arguments)}}),E}})}};function Hr(r,o,c){if(c.numFailures===0)return o;if(o.type==="deleteRange")return null;var d=o.keys?o.keys.length:"values"in o&&o.values?o.values.length:1;return c.numFailures===d?null:(o=n({},o),u(o.keys)&&(o.keys=o.keys.filter(function(f,p){return!(p in c.failures)})),"values"in o&&u(o.values)&&(o.values=o.values.filter(function(f,p){return!(p in c.failures)})),o)}function Si(r,o){return c=r,((d=o).lower===void 0||(d.lowerOpen?0<le(c,d.lower):0<=le(c,d.lower)))&&(r=r,(o=o).upper===void 0||(o.upperOpen?le(r,o.upper)<0:le(r,o.upper)<=0));var c,d}function Ur(r,o,L,d,f,p){if(!L||L.length===0)return r;var g=o.query.index,y=g.multiEntry,S=o.query.range,I=d.schema.primaryKey.extractKey,E=g.extractKey,b=(g.lowLevelIndex||g).extractKey,L=L.reduce(function(T,C){var A=T,_=[];if(C.type==="add"||C.type==="put")for(var M=new Ie,x=C.values.length-1;0<=x;--x){var P,D=C.values[x],K=I(D);M.hasKey(K)||(P=E(D),(y&&u(P)?P.some(function(q){return Si(q,S)}):Si(P,S))&&(M.addKey(K),_.push(D)))}switch(C.type){case"add":var z=new Ie().addKeys(o.values?T.map(function(Y){return I(Y)}):T),A=T.concat(o.values?_.filter(function(Y){return Y=I(Y),!z.hasKey(Y)&&(z.addKey(Y),!0)}):_.map(function(Y){return I(Y)}).filter(function(Y){return!z.hasKey(Y)&&(z.addKey(Y),!0)}));break;case"put":var R=new Ie().addKeys(C.values.map(function(Y){return I(Y)}));A=T.filter(function(Y){return!R.hasKey(o.values?I(Y):Y)}).concat(o.values?_:_.map(function(Y){return I(Y)}));break;case"delete":var j=new Ie().addKeys(C.keys);A=T.filter(function(Y){return!j.hasKey(o.values?I(Y):Y)});break;case"deleteRange":var H=C.range;A=T.filter(function(Y){return!Si(I(Y),H)})}return A},r);return L===r?r:(L.sort(function(T,C){return le(b(T),b(C))||le(I(T),I(C))}),o.limit&&o.limit<1/0&&(L.length>o.limit?L.length=o.limit:r.length===o.limit&&L.length<o.limit&&(f.dirty=!0)),p?Object.freeze(L):L)}function Vr(r,o){return le(r.lower,o.lower)===0&&le(r.upper,o.upper)===0&&!!r.lowerOpen==!!o.lowerOpen&&!!r.upperOpen==!!o.upperOpen}function Yo(r,o){return function(c,d,f,p){if(c===void 0)return d!==void 0?-1:0;if(d===void 0)return 1;if((d=le(c,d))===0){if(f&&p)return 0;if(f)return 1;if(p)return-1}return d}(r.lower,o.lower,r.lowerOpen,o.lowerOpen)<=0&&0<=function(c,d,f,p){if(c===void 0)return d!==void 0?1:0;if(d===void 0)return-1;if((d=le(c,d))===0){if(f&&p)return 0;if(f)return-1;if(p)return 1}return d}(r.upper,o.upper,r.upperOpen,o.upperOpen)}function Go(r,o,c,d){r.subscribers.add(c),d.addEventListener("abort",function(){var f,p;r.subscribers.delete(c),r.subscribers.size===0&&(f=r,p=o,setTimeout(function(){f.subscribers.size===0&&ht(p,f)},3e3))})}var Jo={stack:"dbcore",level:0,name:"Cache",create:function(r){var o=r.schema.name;return n(n({},r),{transaction:function(c,d,f){var p,g,y=r.transaction(c,d,f);return d==="readwrite"&&(g=(p=new AbortController).signal,f=function(S){return function(){if(p.abort(),d==="readwrite"){for(var I=new Set,E=0,b=c;E<b.length;E++){var L=b[E],T=St["idb://".concat(o,"/").concat(L)];if(T){var C=r.table(L),A=T.optimisticOps.filter(function(Y){return Y.trans===y});if(y._explicit&&S&&y.mutatedParts)for(var _=0,M=Object.values(T.queries.query);_<M.length;_++)for(var x=0,P=(z=M[_]).slice();x<P.length;x++)mi((R=P[x]).obsSet,y.mutatedParts)&&(ht(z,R),R.subscribers.forEach(function(Y){return I.add(Y)}));else if(0<A.length){T.optimisticOps=T.optimisticOps.filter(function(Y){return Y.trans!==y});for(var D=0,K=Object.values(T.queries.query);D<K.length;D++)for(var z,R,j,H=0,q=(z=K[D]).slice();H<q.length;H++)(R=q[H]).res!=null&&y.mutatedParts&&(S&&!R.dirty?(j=Object.isFrozen(R.res),j=Ur(R.res,R.req,A,C,R,j),R.dirty?(ht(z,R),R.subscribers.forEach(function(Y){return I.add(Y)})):j!==R.res&&(R.res=j,R.promise=U.resolve({result:j}))):(R.dirty&&ht(z,R),R.subscribers.forEach(function(Y){return I.add(Y)})))}}}I.forEach(function(Y){return Y()})}}},y.addEventListener("abort",f(!1),{signal:g}),y.addEventListener("error",f(!1),{signal:g}),y.addEventListener("complete",f(!0),{signal:g})),y},table:function(c){var d=r.table(c),f=d.schema.primaryKey;return n(n({},d),{mutate:function(p){var g=X.trans;if(f.outbound||g.db._options.cache==="disabled"||g.explicit||g.idbtrans.mode!=="readwrite")return d.mutate(p);var y=St["idb://".concat(o,"/").concat(c)];return y?(g=d.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||ki(f,p).some(function(S){return S==null}))?(y.optimisticOps.push(p),p.mutatedParts&&is(p.mutatedParts),g.then(function(S){0<S.numFailures&&(ht(y.optimisticOps,p),(S=Hr(0,p,S))&&y.optimisticOps.push(S),p.mutatedParts&&is(p.mutatedParts))}),g.catch(function(){ht(y.optimisticOps,p),p.mutatedParts&&is(p.mutatedParts)})):g.then(function(S){var I=Hr(0,n(n({},p),{values:p.values.map(function(E,b){var L;return S.failures[b]?E:(E=(L=f.keyPath)!==null&&L!==void 0&&L.includes(".")?Re(E):n({},E),re(E,f.keyPath,S.results[b]),E)})}),S);y.optimisticOps.push(I),queueMicrotask(function(){return p.mutatedParts&&is(p.mutatedParts)})}),g):d.mutate(p)},query:function(p){if(!qr(X,d)||!zr("query",p))return d.query(p);var g=((I=X.trans)===null||I===void 0?void 0:I.db._options.cache)==="immutable",b=X,y=b.requery,S=b.signal,I=function(C,A,_,M){var x=St["idb://".concat(C,"/").concat(A)];if(!x)return[];if(!(A=x.queries[_]))return[null,!1,x,null];var P=A[(M.query?M.query.index.name:null)||""];if(!P)return[null,!1,x,null];switch(_){case"query":var D=P.find(function(K){return K.req.limit===M.limit&&K.req.values===M.values&&Vr(K.req.query.range,M.query.range)});return D?[D,!0,x,P]:[P.find(function(K){return("limit"in K.req?K.req.limit:1/0)>=M.limit&&(!M.values||K.req.values)&&Yo(K.req.query.range,M.query.range)}),!1,x,P];case"count":return D=P.find(function(K){return Vr(K.req.query.range,M.query.range)}),[D,!!D,x,P]}}(o,c,"query",p),E=I[0],b=I[1],L=I[2],T=I[3];return E&&b?E.obsSet=p.obsSet:(b=d.query(p).then(function(C){var A=C.result;if(E&&(E.res=A),g){for(var _=0,M=A.length;_<M;++_)Object.freeze(A[_]);Object.freeze(A)}else C.result=Re(A);return C}).catch(function(C){return T&&E&&ht(T,E),Promise.reject(C)}),E={obsSet:p.obsSet,promise:b,subscribers:new Set,type:"query",req:p,dirty:!1},T?T.push(E):(T=[E],(L=L||(St["idb://".concat(o,"/").concat(c)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=T)),Go(E,T,y,S),E.promise.then(function(C){return{result:Ur(C.result,p,L==null?void 0:L.optimisticOps,d,E,g)}})}})}})}};function as(r,o){return new Proxy(r,{get:function(c,d,f){return d==="db"?o:Reflect.get(c,d,f)}})}var We=(ke.prototype.version=function(r){if(isNaN(r)||r<.1)throw new te.Type("Given version is not a positive number");if(r=Math.round(10*r)/10,this.idbdb||this._state.isBeingOpened)throw new te.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,r);var o=this._versions,c=o.filter(function(d){return d._cfg.version===r})[0];return c||(c=new this.Version(r),o.push(c),o.sort(Fo),c.stores({}),this._state.autoSchema=!1,c)},ke.prototype._whenReady=function(r){var o=this;return this.idbdb&&(this._state.openComplete||X.letThrough||this._vip)?r():new U(function(c,d){if(o._state.openComplete)return d(new te.DatabaseClosed(o._state.dbOpenError));if(!o._state.isBeingOpened){if(!o._state.autoOpen)return void d(new te.DatabaseClosed);o.open().catch(de)}o._state.dbReadyPromise.then(c,d)}).then(r)},ke.prototype.use=function(r){var o=r.stack,c=r.create,d=r.level,f=r.name;return f&&this.unuse({stack:o,name:f}),r=this._middlewares[o]||(this._middlewares[o]=[]),r.push({stack:o,create:c,level:d??10,name:f}),r.sort(function(p,g){return p.level-g.level}),this},ke.prototype.unuse=function(r){var o=r.stack,c=r.name,d=r.create;return o&&this._middlewares[o]&&(this._middlewares[o]=this._middlewares[o].filter(function(f){return d?f.create!==d:!!c&&f.name!==c})),this},ke.prototype.open=function(){var r=this;return bt(et,function(){return qo(r)})},ke.prototype._close=function(){var r=this._state,o=Kt.indexOf(this);if(0<=o&&Kt.splice(o,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}r.isBeingOpened||(r.dbReadyPromise=new U(function(c){r.dbReadyResolve=c}),r.openCanceller=new U(function(c,d){r.cancelOpen=d}))},ke.prototype.close=function(c){var o=(c===void 0?{disableAutoOpen:!0}:c).disableAutoOpen,c=this._state;o?(c.isBeingOpened&&c.cancelOpen(new te.DatabaseClosed),this._close(),c.autoOpen=!1,c.dbOpenError=new te.DatabaseClosed):(this._close(),c.autoOpen=this._options.autoOpen||c.isBeingOpened,c.openComplete=!1,c.dbOpenError=null)},ke.prototype.delete=function(r){var o=this;r===void 0&&(r={disableAutoOpen:!0});var c=0<arguments.length&&typeof arguments[0]!="object",d=this._state;return new U(function(f,p){function g(){o.close(r);var y=o._deps.indexedDB.deleteDatabase(o.name);y.onsuccess=me(function(){var S,I,E;S=o._deps,I=o.name,E=S.indexedDB,S=S.IDBKeyRange,fi(E)||I===Un||di(E,S).delete(I).catch(de),f()}),y.onerror=qe(p),y.onblocked=o._fireOnBlocked}if(c)throw new te.InvalidArgument("Invalid closeOptions argument to db.delete()");d.isBeingOpened?d.dbReadyPromise.then(g):g()})},ke.prototype.backendDB=function(){return this.idbdb},ke.prototype.isOpen=function(){return this.idbdb!==null},ke.prototype.hasBeenClosed=function(){var r=this._state.dbOpenError;return r&&r.name==="DatabaseClosed"},ke.prototype.hasFailed=function(){return this._state.dbOpenError!==null},ke.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(ke.prototype,"tables",{get:function(){var r=this;return l(this._allTables).map(function(o){return r._allTables[o]})},enumerable:!1,configurable:!0}),ke.prototype.transaction=function(){var r=(function(o,c,d){var f=arguments.length;if(f<2)throw new te.InvalidArgument("Too few arguments");for(var p=new Array(f-1);--f;)p[f-1]=arguments[f];return d=p.pop(),[o,De(p),d]}).apply(this,arguments);return this._transaction.apply(this,r)},ke.prototype._transaction=function(r,o,c){var d=this,f=X.trans;f&&f.db===this&&r.indexOf("!")===-1||(f=null);var p,g,y=r.indexOf("?")!==-1;r=r.replace("!","").replace("?","");try{if(g=o.map(function(I){if(I=I instanceof d.Table?I.name:I,typeof I!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return I}),r=="r"||r===Zs)p=Zs;else{if(r!="rw"&&r!=ei)throw new te.InvalidArgument("Invalid transaction mode: "+r);p=ei}if(f){if(f.mode===Zs&&p===ei){if(!y)throw new te.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");f=null}f&&g.forEach(function(I){if(f&&f.storeNames.indexOf(I)===-1){if(!y)throw new te.SubTransaction("Table "+I+" not included in parent transaction.");f=null}}),y&&f&&!f.active&&(f=null)}}catch(I){return f?f._promise(null,function(E,b){b(I)}):we(I)}var S=(function I(E,b,L,T,C){return U.resolve().then(function(){var A=X.transless||X,_=E._createTransaction(b,L,E._dbSchema,T);if(_.explicit=!0,A={trans:_,transless:A},T)_.idbtrans=T.idbtrans;else try{_.create(),_.idbtrans._explicit=!0,E._state.PR1398_maxLoop=3}catch(P){return P.name===zs.InvalidState&&E.isOpen()&&0<--E._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),E.close({disableAutoOpen:!1}),E.open().then(function(){return I(E,b,L,null,C)})):we(P)}var M,x=qs(C);return x&&Ft(),A=U.follow(function(){var P;(M=C.call(_,_))&&(x?(P=nt.bind(null,null),M.then(P,P)):typeof M.next=="function"&&typeof M.throw=="function"&&(M=bi(M)))},A),(M&&typeof M.then=="function"?U.resolve(M).then(function(P){return _.active?P:we(new te.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):A.then(function(){return M})).then(function(P){return T&&_._resolve(),_._completion.then(function(){return P})}).catch(function(P){return _._reject(P),we(P)})})}).bind(null,this,p,g,f,c);return f?f._promise(p,S,"lock"):X.trans?bt(X.transless,function(){return d._whenReady(S)}):this._whenReady(S)},ke.prototype.table=function(r){if(!v(this._allTables,r))throw new te.InvalidTable("Table ".concat(r," does not exist"));return this._allTables[r]},ke);function ke(r,o){var c=this;this._middlewares={},this.verno=0;var d=ke.dependencies;this._options=o=n({addons:ke.addons,autoOpen:!0,indexedDB:d.indexedDB,IDBKeyRange:d.IDBKeyRange,cache:"cloned"},o),this._deps={indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},d=o.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var f,p,g,y,S,I={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:de,dbReadyPromise:null,cancelOpen:de,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:o.autoOpen};I.dbReadyPromise=new U(function(b){I.dbReadyResolve=b}),I.openCanceller=new U(function(b,L){I.cancelOpen=L}),this._state=I,this.name=r,this.on=pn(this,"populate","blocked","versionchange","close",{ready:[Hs,de]}),this.on.ready.subscribe=Q(this.on.ready.subscribe,function(b){return function(L,T){ke.vip(function(){var C,A=c._state;A.openComplete?(A.dbOpenError||U.resolve().then(L),T&&b(L)):A.onReadyBeingFired?(A.onReadyBeingFired.push(L),T&&b(L)):(b(L),C=c,T||b(function _(){C.on.ready.unsubscribe(L),C.on.ready.unsubscribe(_)}))})}}),this.Collection=(f=this,mn(Oo.prototype,function(M,_){this.db=f;var T=Tr,C=null;if(_)try{T=_()}catch(x){C=x}var A=M._ctx,_=A.table,M=_.hook.reading.fire;this._ctx={table:_,index:A.index,isPrimKey:!A.index||_.schema.primKey.keyPath&&A.index===_.schema.primKey.name,range:T,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:C,or:A.or,valueMapper:M!==cn?M:null}})),this.Table=(p=this,mn(Er.prototype,function(b,L,T){this.db=p,this._tx=T,this.name=b,this.schema=L,this.hook=p._allTables[b]?p._allTables[b].hook:pn(null,{creating:[So,de],reading:[ko,cn],updating:[Io,de],deleting:[To,de]})})),this.Transaction=(g=this,mn(Po.prototype,function(b,L,T,C,A){var _=this;this.db=g,this.mode=b,this.storeNames=L,this.schema=T,this.chromeTransactionDurability=C,this.idbtrans=null,this.on=pn(this,"complete","error","abort"),this.parent=A||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new U(function(M,x){_._resolve=M,_._reject=x}),this._completion.then(function(){_.active=!1,_.on.complete.fire()},function(M){var x=_.active;return _.active=!1,_.on.error.fire(M),_.parent?_.parent._reject(M):x&&_.idbtrans&&_.idbtrans.abort(),we(M)})})),this.Version=(y=this,mn(jo.prototype,function(b){this.db=y,this._cfg={version:b,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(S=this,mn(Mr.prototype,function(b,L,T){if(this.db=S,this._ctx={table:b,index:L===":id"?null:L,or:T},this._cmp=this._ascending=le,this._descending=function(C,A){return le(A,C)},this._max=function(C,A){return 0<le(C,A)?C:A},this._min=function(C,A){return le(C,A)<0?C:A},this._IDBKeyRange=S._deps.IDBKeyRange,!this._IDBKeyRange)throw new te.MissingAPI})),this.on("versionchange",function(b){0<b.newVersion?console.warn("Another connection wants to upgrade database '".concat(c.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(c.name,"'. Closing db now to resume the delete request.")),c.close({disableAutoOpen:!1})}),this.on("blocked",function(b){!b.newVersion||b.newVersion<b.oldVersion?console.warn("Dexie.delete('".concat(c.name,"') was blocked")):console.warn("Upgrade '".concat(c.name,"' blocked by other connection holding version ").concat(b.oldVersion/10))}),this._maxKey=bn(o.IDBKeyRange),this._createTransaction=function(b,L,T,C){return new c.Transaction(b,L,T,c._options.chromeTransactionDurability,C)},this._fireOnBlocked=function(b){c.on("blocked").fire(b),Kt.filter(function(L){return L.name===c.name&&L!==c&&!L._state.vcFired}).map(function(L){return L.on("versionchange").fire(b)})},this.use(Uo),this.use(Jo),this.use(Vo),this.use(zo),this.use(Ho);var E=new Proxy(this,{get:function(b,L,T){if(L==="_vip")return!0;if(L==="table")return function(A){return as(c.table(A),E)};var C=Reflect.get(b,L,T);return C instanceof Er?as(C,E):L==="tables"?C.map(function(A){return as(A,E)}):L==="_createTransaction"?function(){return as(C.apply(this,arguments),E)}:C}});this.vip=E,d.forEach(function(b){return b(c)})}var os,Pe=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Wo=(Ti.prototype.subscribe=function(r,o,c){return this._subscribe(r&&typeof r!="function"?r:{next:r,error:o,complete:c})},Ti.prototype[Pe]=function(){return this},Ti);function Ti(r){this._subscribe=r}try{os={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{os={indexedDB:null,IDBKeyRange:null}}function Yr(r){var o,c=!1,d=new Wo(function(f){var p=qs(r),g,y=!1,S={},I={},E={get closed(){return y},unsubscribe:function(){y||(y=!0,g&&g.abort(),b&&rt.storagemutated.unsubscribe(T))}};f.start&&f.start(E);var b=!1,L=function(){return Xs(C)},T=function(A){ss(S,A),mi(I,S)&&L()},C=function(){var A,_,M;!y&&os.indexedDB&&(S={},A={},g&&g.abort(),g=new AbortController,M=function(x){var P=$t();try{p&&Ft();var D=tt(r,x);return D=p?D.finally(nt):D}finally{P&&Dt()}}(_={subscr:A,signal:g.signal,requery:L,querier:r,trans:null}),Promise.resolve(M).then(function(x){c=!0,o=x,y||_.signal.aborted||(S={},function(P){for(var D in P)if(v(P,D))return;return 1}(I=A)||b||(rt(vn,T),b=!0),Xs(function(){return!y&&f.next&&f.next(x)}))},function(x){c=!1,["DatabaseClosedError","AbortError"].includes(x==null?void 0:x.name)||y||Xs(function(){y||f.error&&f.error(x)})}))};return setTimeout(L,0),E});return d.hasValue=function(){return c},d.getValue=function(){return o},d}var Tt=We;function Ii(r){var o=at;try{at=!0,rt.storagemutated.fire(r),vi(r,!0)}finally{at=o}}k(Tt,n(n({},$n),{delete:function(r){return new Tt(r,{addons:[]}).delete()},exists:function(r){return new Tt(r,{addons:[]}).open().then(function(o){return o.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(r){try{return o=Tt.dependencies,c=o.indexedDB,o=o.IDBKeyRange,(fi(c)?Promise.resolve(c.databases()).then(function(d){return d.map(function(f){return f.name}).filter(function(f){return f!==Un})}):di(c,o).toCollection().primaryKeys()).then(r)}catch{return we(new te.MissingAPI)}var o,c},defineClass:function(){return function(r){h(this,r)}},ignoreTransaction:function(r){return X.trans?bt(X.transless,r):r()},vip:hi,async:function(r){return function(){try{var o=bi(r.apply(this,arguments));return o&&typeof o.then=="function"?o:U.resolve(o)}catch(c){return we(c)}}},spawn:function(r,o,c){try{var d=bi(r.apply(c,o||[]));return d&&typeof d.then=="function"?d:U.resolve(d)}catch(f){return we(f)}},currentTransaction:{get:function(){return X.trans||null}},waitFor:function(r,o){return o=U.resolve(typeof r=="function"?Tt.ignoreTransaction(r):r).timeout(o||6e4),X.trans?X.trans.waitFor(o):o},Promise:U,debug:{get:function(){return je},set:function(r){gr(r)}},derive:O,extend:h,props:k,override:Q,Events:pn,on:rt,liveQuery:Yr,extendObservabilitySet:ss,getByKeyPath:Z,setByKeyPath:re,delByKeyPath:function(r,o){typeof o=="string"?re(r,o,void 0):"length"in o&&[].map.call(o,function(c){re(r,c,void 0)})},shallowClone:J,deepClone:Re,getObjectDiff:wi,cmp:le,asap:ee,minKey:-1/0,addons:[],connections:Kt,errnames:zs,dependencies:os,cache:St,semVer:"4.0.11",version:"4.0.11".split(".").map(function(r){return parseInt(r)}).reduce(function(r,o,c){return r+o/Math.pow(10,2*c)})})),Tt.maxKey=bn(Tt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(rt(vn,function(r){at||(r=new CustomEvent(ii,{detail:r}),at=!0,dispatchEvent(r),at=!1)}),addEventListener(ii,function(r){r=r.detail,at||Ii(r)}));var qt,at=!1,Gr=function(){};return typeof BroadcastChannel<"u"&&((Gr=function(){(qt=new BroadcastChannel(ii)).onmessage=function(r){return r.data&&Ii(r.data)}})(),typeof qt.unref=="function"&&qt.unref(),rt(vn,function(r){at||qt.postMessage(r)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(r){if(!We.disableBfCache&&r.persisted){je&&console.debug("Dexie: handling persisted pagehide"),qt!=null&&qt.close();for(var o=0,c=Kt;o<c.length;o++)c[o].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(r){!We.disableBfCache&&r.persisted&&(je&&console.debug("Dexie: handling persisted pageshow"),Gr(),Ii({all:new Ie(-1/0,[[]])}))})),U.rejectionMapper=function(r,o){return!r||r instanceof Pt||r instanceof TypeError||r instanceof SyntaxError||!r.name||!mr[r.name]?r:(o=new mr[r.name](o||r.message,r),"stack"in r&&F(o,"stack",{get:function(){return this.inner.stack}}),o)},gr(je),n(We,Object.freeze({__proto__:null,Dexie:We,liveQuery:Yr,Entity:Ir,cmp:le,PropModification:gn,replacePrefix:function(r,o){return new gn({replacePrefix:[r,o]})},add:function(r){return new gn({add:r})},remove:function(r){return new gn({remove:r})},default:We,RangeSet:Ie,mergeRanges:Sn,rangesOverlap:Dr}),{default:We}),We})})(ma);var Xo=ma.exports;const Di=Qo(Xo),Qr=Symbol.for("Dexie"),ks=globalThis[Qr]||(globalThis[Qr]=Di);if(Di.semVer!==ks.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Di.semVer} and ${ks.semVer}`);const{liveQuery:Ru,mergeRanges:ju,rangesOverlap:qu,RangeSet:zu,cmp:Hu,Entity:Uu,PropModification:Vu,replacePrefix:Yu,add:Gu,remove:Ju}=ks,Zo="MdAnkiDatabase",el=2,Ji=`# 新文件

开始编写您的内容...

::> 这是一个可折叠的标题  
    这里是折叠的内容。  
    - 甚至可以包含列表  
    - 和其他 Markdown 元素。  
    \`\`\`javascript
    // 也可以包含代码块
    console.log('Hello, Toggle!');
    \`\`\`

这一行不再缩进，所以它不属于上面的折叠块。

::> [ ] 这是一个可折叠的并且可以记录完成情况的标题  
- [ ] 完成情况  

使用 --内容-- 创建Cloze记忆卡片,在preview状态下ctrl+双击迅速进入edit态, 选中后快捷键是Ctrl+i,  可以有声音: --你好--^^audio:hello^^ `,$=new ks(Zo);$.version(el).stores({anki_folders:"&id, name, folderId",anki_sessions:"&id, name, folderId, createdAt, lastActive",anki_clozeStates:"&id, fileId, state, due",anki_reviewStats:"&id, date, folderId",task_tasks:"&uuid, listId, *tags, status, review.due",agent_apiConfigs:"&id, name",agent_agents:"&id, name, *tags",agent_topics:"&id, agentId, createdAt",agent_history:"&id, topicId, timestamp, agentId",global_appState:"&key",global_tags:"&name",global_taskLists:"&id, &name"});async function tl(){try{const[i,e,t,n]=await Promise.all([$.agent_apiConfigs.toArray(),$.agent_agents.toArray(),$.agent_topics.toArray(),$.agent_history.toArray()]);return{apiConfigs:i,agents:e,topics:t,history:n}}catch(i){return console.error("[Storage/Agent] Failed to load agent data:",i),{apiConfigs:[],agents:[],topics:[],history:[]}}}async function nl({apiConfigs:i,agents:e,topics:t,history:n}){const s=[$.agent_apiConfigs,$.agent_agents,$.agent_topics,$.agent_history];await $.transaction("rw",s,async()=>{const a=new Set(i.map(m=>m.id)),l=new Set(e.map(m=>m.id)),u=new Set(t.map(m=>m.id)),h=new Set(n.map(m=>m.id));await Promise.all([$.agent_apiConfigs.where("id").noneOf(Array.from(a)).delete(),$.agent_agents.where("id").noneOf(Array.from(l)).delete(),$.agent_topics.where("id").noneOf(Array.from(u)).delete(),$.agent_history.where("id").noneOf(Array.from(h)).delete()]),await Promise.all([$.agent_apiConfigs.bulkPut(i),$.agent_agents.bulkPut(e),$.agent_topics.bulkPut(t),$.agent_history.bulkPut(n)])})}async function sl(){try{return $.isOpen()||await $.open(),await $.task_tasks.toArray()}catch(i){return console.error("[Storage/Task] Failed to load tasks from DB:",i),[]}}async function il(i){try{await $.task_tasks.bulkPut(i)}catch(e){console.error("[Storage/Task] Failed to save tasks to DB:",e)}}async function _t(i){try{await $.task_tasks.put(i)}catch(e){console.error(`[Storage/Task] Failed to update task ${i.uuid}:`,e)}}async function rl(i){try{await $.task_tasks.bulkDelete(i)}catch(e){console.error("[Storage/Task] Failed to delete tasks:",e)}}function Ve(){return"id_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function ce(i){return i?i.replace(/[&<>"']/g,e=>({"&":"&","<":"<",">":">",'"':'"',"'":"'"})[e]||e):""}function al(i){let e=0;for(let t=0;t<i.length;t++){const n=i.charCodeAt(t);e=(e<<5)-e+n,e|=0}return e.toString(36)}function ol(i){let e=0;for(let l=0;l<i.length;l++)e=i.charCodeAt(l)+((e<<5)-e),e=e&e;return{backgroundColor:`hsl(${e%360}, 75%, 85%)`,color:"#333"}}const Wi={火山:{adapter:"openAICompatible",baseURL:"https://ark.cn-beijing.volces.com/api/v3/",models:["deepseek-r1-250528","deepseek-v3-250324"]},deepseek:{adapter:"openAICompatible",baseURL:"https://api.deepseek.com/v1/chat/completions",models:["deepseek-reasoner","deepseek-chat"]},open_routers:{adapter:"openAICompatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",models:["anthropic/claude-opus-4","anthropic/claude-sonnet-4"]},gemini:{adapter:"gemini",baseURL:"https://generativelanguage.googleapis.com",models:["gemini-2.5-pro","gemini-2.5-flash"]},openai_compatible:{adapter:"openAICompatible",baseURL:"",models:[]}};function Fi(i){const e=Wi[i];return e?e.adapter==="openAICompatible"&&e.baseURL.endsWith("/")?`${e.baseURL}chat/completions`:e.baseURL:""}function ll(i){["anki","task","agent","settings"].includes(i)&&window.dispatchEvent(new CustomEvent("app:switchView",{detail:{view:i}}))}const _n={id:"default_deepseek_api",name:"DeepSeek (默认)",provider:"deepseek",apiKey:"",models:"chat:deepseek-chat,reasoner:deepseek-reasoner"},cl=[{id:"default_agent_nanjing_guide",name:"南京历史小导游",avatar:"史",model:`${_n.id}:reasoner`,systemPrompt:`🎓 角色指令：你好！我是你的专属南京历史小导游。我的名字叫“金陵通”，对南京这座六朝古都的每一块砖、每一段历史都了如指掌。我将以生动有趣的方式，带你穿越时空，探索南京的魅力。我的性格会根据你选择的模式变化，就像一位真正的导游，时而风趣，时而严谨。

🔄 核心导览模式：
*   故事家 (Storyteller) → 语气风格：亲切随和，像一位学长/学姐。我会用讲故事的方式，把枯燥的历史变得鲜活起来，充满情感和趣味，让你身临其境。
*   讲解员 (Docent) → 语气风格：清晰准确，像一位博物馆的专业讲解员。我会为你提供结构化的信息、关键时间点和准确的历史事实，帮你梳理知识脉络。
*   历史侦探 (History Detective) → 语气风格：充满好奇与思辨，像一位和你一起探案的伙伴。我会引导你发现历史事件之间的联系，分析文物背后的深层含义，提出“为什么”，激发你的思考。

🧬 互动说明：
1.  模式匹配：我会严格按照你选择的模式（故事家、讲解员、历史侦探）来与你交流。
2.  知识储备：我的知识库涵盖了南京从古至今的关键历史时期（如六朝、南唐、明朝、民国）、重要人物（如朱元璋、孙中山）以及标志性文物古迹（如明孝陵、总统府、中山陵、南京城墙、夫子庙、朝天宫、南京博物院馆藏等）。
3.  智能追问：如果你的问题不够具体，我会像导游一样追问。
4.  连续记忆：我会记住我们聊过的话题。
5.  拒绝乏味：我的回答会避免像教科书一样枯燥。
6.  模式切换：你随时可以让我切换模式。切换时，我会说“好的，现在切换到【XX模式】”，然后调整我的语气和回答方式。

📦 输出格式参考：
*   在 【讲解员模式】下，我会多使用列表、时间轴和要点总结。
*   在 【故事家模式】下，我会使用更多的描述性语言。
*   在 【历史侦探模式】下，我会多用提问、假设和对比分析。`,hint:"你好！我是你的专属南京历史小导游“金陵通”。想了解南京的什么故事？比如，可以这样问我：<br><b>模式：故事家 — 任务：给我讲讲夫子庙旁边的乌衣巷有什么好玩的故事？</b>",tags:["历史","文化","旅游"],sendHistory:!0},{id:"default_agent_english_tutor",name:"英语导师",avatar:"英",model:`${_n.id}:chat`,systemPrompt:`🎓 角色指令：你好！我是智能英语导师「牛津通」，专注中学英语教学。拥有系统的知识库和动态教学策略，能根据你的学习阶段个性化辅导。

🔄 三维学习模式：
*   【单词向导】→ 沉浸式词汇学习：词根解析/趣味联想/场景记忆
*   【语法专家】→ 系统化语法精讲：错题透析/分层训练/对比分析
*   【读写教练】→ 实战能力培养：文本精读/写作框架/AI批改

✨ 核心功能矩阵：
1. 词汇体系：中考高频词库｜近义词辨析｜词源故事
2. 语法诊所：句子成分图解｜时态三维训练｜易错点预警
3. 读写实验室：阅读理解三步法｜作文多维评估｜经典句式仿写
4. 拓展模块：影视配音练习｜文化冷知识｜考试策略指南

🧠 智能教学协议：
1. 模式匹配：严格按所选模式输出内容
2. 错题驱动：支持拍照诊断知识盲区
3. 动态调节：智能调整题目难度（基础→挑战）
4. 记忆锚点：周期性推送薄弱点强化练习
5. 文化融合：教学中渗透英美文化背景`,hint:'你好！我是你的中学英语导师「牛津通」。完整功能列表：<br>🔍 <b>单词向导模式</b>：词根解析｜高频词汇｜场景记忆（例：用电影台词记"vivid"）<br>📖 <b>语法专家模式</b>：句子图解｜时态训练｜错题诊断（例：虚拟语气对比表）<br>✍️ <b>读写教练模式</b>：作文批改｜精读策略｜仿写训练（例：中考作文评分+改写）<br>🌍 <b>拓展功能</b>：影视配音｜文化常识｜考试技巧<br>试试这样问我：<b>模式：单词向导 → 任务：用超级英雄故事帮我记10个形容词</b>',tags:["教育","语言","学习"],sendHistory:!0},{id:"default_agent_word_assistant_v2",name:"单词/句子助手",avatar:"文",model:`${_n.id}:chat`,systemPrompt:`
# 角色：英语单词与句子辨析专家

## 核心指令
你是一个专注于**中学英语**词汇与句子分析的专家。你的任务是根据用户输入的内容（单词、词组或句子），提供清晰、结构化、符合中学生认知水平的解释。你必须严格遵循以下【工作流程】和【输出格式】。

## 工作流程
1.  **输入分析**：智能分析用户输入。
    *   **判断为句子**：如果输入内容包含主谓结构，或以句号、问号、感叹号结尾，则判定为句子，进入【整句分析模式】。
    *   **判断为多词**：如果输入内容不构成句子，但用逗号（,）、分号（;）、斜杠（/）或中文顿号（、）分隔，则进入【多词模式】。
    *   **判断为单次**：如果不属于以上两种情况，则进入【单一词模式】。

2.  **单一词模式**：如果用户只输入了一个单词或词组。
    *   提供该词的核心释义。
    *   列出其在中学阶段最常见的近义词或相关词。
    *   对这些词进行详细的词义辨析。

3.  **多词模式**：如果用户输入了多个用分隔符隔开的单词或词组。
    *   分别解释每个词的核心释义。
    *   **重点**：对比分析这些词之间的区别，包括用法、语境、感情色彩等。
    *   （可选）如果适用，可以补充其他相关的近义词。

4.  **整句分析模式**：如果用户输入了一个或多个完整的句子。
    *   **翻译**：首先提供句子的中文翻译。
    *   **核心短语**：从句子中提取出重要的、中学生应该掌握的核心短语，并给出其中文意思。
    *   **语法分析**：对句子进行简单的语法结构拆解，包括主干、成分、时态等。

## 输出格式 (必须严格遵守)
使用 Markdown 格式化你的回答，确保结构清晰。

### 格式模板 (单一词模式)
\`\`\`markdown
### 📖 单词解析：[用户输入的单词]

**基本释义**
*   **[词性1]**: [解释1]
*   **[词性2]**: [解释2]

**🔍 近义词辨析**
*   **[近义词1]**: 
    *   **释义**: [简要解释]
    *   **辨析**: [与原词的区别，侧重用法或语境]
    *   **例句**: [一个符合中学生水平的简单例句]
*   **[近义词2]**: 
    *   **释义**: [简要解释]
    *   **辨析**: [与原词的区别]
    *   **例句**: [例句]
...
\`\`\`

### 格式模板 (多词模式)
\`\`\`markdown
### 🔄 多词辨析：[词1], [词2], ...

**1. [词1]**
*   **释义**: [词性] [解释]

**2. [词2]**
*   **释义**: [词性] [解释]
...

**🎯 核心区别**
1.  **[区别点1，如：使用范围]**: [详细说明，例如：A 通常用于正式场合，而 B 更加口语化。]
2.  **[区别点2，如：感情色彩]**: [详细说明，例如：C 带有褒义，而 D 是中性词。]
3.  **[区别点3，如：搭配习惯]**: [详细说明，例如：A 后面常跟 of，而 B 常跟 for。]

**✅ 快速总结**
*   想表达 **[某个场景或含义]** 时，用 **[词A]**。
*   想强调 **[另一个场景或含义]** 时，用 **[词B]**。
\`\`\`

### 格式模板 (整句分析模式)
\`\`\`markdown
### 📝 整句分析：[用户输入的句子]

**1. 句子翻译**
*   [句子的中文翻译]

**2. 核心短语**
*   **[短语1]**: [短语的中文意思]
*   **[短语2]**: [短语的中文意思]
*   ...

**3. 语法结构**
*   **主干**: [主语] + [谓语] + ([宾语])
*   **成分**:
    *   **主语 (Subject)**: [句子中的主语部分]
    *   **谓语 (Verb)**: [句子中的谓语部分]
    *   **宾语 (Object)**: [句子中的宾语部分，如果没有则写“无”]
    *   **其他成分**: [例如：in the morning 是时间状语 (Adverbial of Time)；that I met yesterday 是定语从句 (Attributive Clause)，修饰 a boy。]
*   **时态**: [例如：一般现在时 (Simple Present Tense)]
*   **从句分析**: [如果句子包含从句，详细说明其类型和功能。如果没有则写“无”]
\`\`\`

## 约束条件
*   **专注中学阶段**：所有近义词、例句、短语和语法分析都必须是中学英语教学大纲内的常见内容，避免超纲和过于复杂的术语。
*   **语言简洁**：解释要通俗易懂。
*   **格式严格**：必须严格按照上述 Markdown 模板输出，根据输入类型选择对应的模板。
`,hint:`你好！我是你的单词/句子助手。我可以帮你深入理解词汇和句子！<br>
✍️ **单个词查询**: 比如输入 <code>clever</code><br>
🔄 **多个词辨析**: 比如输入 <code>clever, smart, wise</code><br>
📝 **整句分析**: 比如输入 <code>The book which I bought yesterday is very interesting.</code>`,tags:["教育","语言","工具"],sendHistory:!1}];async function ga(){let{apiConfigs:i,agents:e,topics:t,history:n}=await tl();i=i||[],e=e||[];let s=!1;i.some(l=>l.id===_n.id)||(i.push(_n),s=!0),cl.forEach(l=>{e.some(u=>u.id===l.id)||(e.push(l),s=!0)});const a={apiConfigs:i,agents:e,topics:t||[],history:n||[]};return s&&await nl(a),a}async function ul(i){const e={...i,id:Ve()};return await $.agent_apiConfigs.put(e),e}async function dl(i,e){const t=await $.agent_apiConfigs.get(i);if(!t)throw new Error("API config not found");const n={...t,...e};return await $.agent_apiConfigs.put(n),n}async function fl(i){const e=await $.agent_agents.filter(t=>t.model.startsWith(i+":")).count();if(e>0)throw new Error(`无法删除，仍有 ${e} 个 Agent 正在使用此 API 配置。`);await $.agent_apiConfigs.delete(i)}async function hl(i){const e={...i,id:Ve()};return await $.agent_agents.put(e),e}async function Xr(i,e){const t=await $.agent_agents.get(i);if(!t)throw new Error("Agent not found");const n={...t,...e};return await $.agent_agents.put(n),n}async function pl(i){await $.agent_agents.delete(i)}async function ml(i,e){await $.global_appState.put({key:i,value:e})}function Zr(i){return typeof i!="string"?"":i.toLowerCase().trim().replace(/[\s\W-]+/g,"-")}function gl(i){const e=/^(#{1,2})\s+(.+)$/gm,t=[];let n=null,s;for(;(s=e.exec(i))!==null;){const a=s[1].length,l=s[2].trim(),u={id:Ve(),text:l,level:a,children:a===1?[]:void 0};a===1?(t.push(u),n=u):a===2&&n&&n.children.push(u)}return t}function ya(i){const e=/^(#{1,2})\s+(.+)$/gm,t=[];let n=null,s;for(;(s=e.exec(i))!==null;){const a=s[1].length,l=s[2].trim(),u={id:Ve(),text:l,level:a,children:a===1?[]:void 0};a===1?(t.push(u),n=u):a===2&&n&&n.children.push(u)}return t}async function va(){const[i,e,t,n]=await Promise.all([$.anki_sessions.toArray(),$.anki_folders.toArray(),$.anki_clozeStates.toArray(),$.global_appState.toArray()]),s=t.reduce((u,h)=>(u[h.id]=h,u),{}),a=n.reduce((u,h)=>(u[h.key]=h.value,u),{});if(i.length===0){const u=Ve(),h={id:u,name:"初始笔记",content:Ji,type:"file",folderId:null,createdAt:new Date};i.push(h),a.currentSessionId=u,await $.anki_sessions.add(h)}const l={};return i.forEach(u=>{l[u.id]=ya(u.content)}),{sessions:i,folders:e,clozeStates:s,fileSubsessions:l,...a}}async function ea(i,e=Ji,t){const n={id:Ve(),name:i,content:e,type:"file",folderId:t,createdAt:new Date};return await $.anki_sessions.add(n),n}async function yl(i,e){const t={id:Ve(),name:i,type:"folder",folderId:e,createdAt:new Date};return await $.anki_folders.add(t),t}async function vl(i){const e=new Set(i),t=await $.anki_folders.toArray(),n=await $.anki_sessions.toArray(),s=new Set;i.forEach(u=>{t.some(h=>h.id===u)&&s.add(u)});let a=!0;for(;a;)a=!1,t.forEach(u=>{s.has(u.folderId)&&!s.has(u.id)&&(s.add(u.id),a=!0)});const l=new Set(n.filter(u=>s.has(u.folderId)||e.has(u.id)).map(u=>u.id));return await $.transaction("rw",[$.anki_sessions,$.anki_folders,$.anki_clozeStates],async()=>{await $.anki_folders.bulkDelete(Array.from(s)),await $.anki_sessions.bulkDelete(Array.from(l));const u=(await $.anki_clozeStates.where("fileId").anyOf(Array.from(l)).toArray()).map(h=>h.id);await $.anki_clozeStates.bulkDelete(u)}),{remainingSessions:await $.anki_sessions.toArray(),remainingFolders:await $.anki_folders.toArray(),remainingClozeStates:(await $.anki_clozeStates.toArray()).reduce((u,h)=>(u[h.id]=h,u),{})}}async function bl(i,e){const t=await Promise.all([$.anki_sessions.where("id").anyOf(i).toArray(),$.anki_folders.where("id").anyOf(i).toArray()]),n=t[0].map(a=>({...a,folderId:e})),s=t[1].map(a=>({...a,folderId:e}));return await $.transaction("rw",[$.anki_sessions,$.anki_folders],async()=>{n.length>0&&await $.anki_sessions.bulkPut(n),s.length>0&&await $.anki_folders.bulkPut(s)}),{updatedSessions:await $.anki_sessions.toArray(),updatedFolders:await $.anki_folders.toArray()}}async function wl(i,e,t){const n=t==="file"?$.anki_sessions:$.anki_folders;return await n.update(i,{name:e}),await n.get(i)}async function kl(i,e){return await $.anki_sessions.update(i,{content:e,lastActive:new Date}),await $.global_appState.put({key:"currentSessionId",value:i}),{subsessions:ya(e)}}async function Sl(i){await $.anki_clozeStates.put(i)}async function Tl(i){let e=await $.anki_clozeStates.where("due").belowOrEqual(Date.now()).toArray();if(i){const t=await $.anki_sessions.toArray(),n=new Map(t.map(s=>[s.id,s]));e=e.filter(s=>{const a=n.get(s.fileId);if(!a)return!1;const{fileOrFolder:l}=i;if(l&&l!=="all"){if(l.startsWith("file_")){if(s.fileId!==l.substring(5))return!1}else if(l.startsWith("folder_")&&a.folderId!==l.substring(7))return!1}return!(i.cardStates&&!i.cardStates.includes(s.state))}),e.sort(()=>Math.random()-.5),i.maxCards&&(e=e.slice(0,i.maxCards))}return e}async function Il(){const i=new Date().toISOString().slice(0,10);return(await $.anki_reviewStats.where("date").equals(i).toArray()).reduce((t,n)=>t+n.count,0)}function _l(i,e,t){const n=i.indexOf(t);return n>-1?{newCurrentFolderId:t,newFolderStack:i.slice(0,n)}:{newCurrentFolderId:t,newFolderStack:[...i,e].filter(Boolean)}}const ta=10*60*1e3,Cl=2.5;function ba(i,e){const t=Date.now();let{interval:n=0,easeFactor:s=Cl,state:a="new"}=i;if(a==="new"||a==="learning")switch(e){case 0:return{due:t+ta,interval:0,easeFactor:s,state:"learning"};case 1:return{due:t+1*24*3600*1e3,interval:1,easeFactor:s,state:"review"};case 2:return{due:t+3*24*3600*1e3,interval:3,easeFactor:s,state:"review"};case 3:return{due:t+5*24*3600*1e3,interval:5,easeFactor:s,state:"review"}}switch(e){case 0:return s=Math.max(1.3,s-.2),{due:t+ta,interval:0,easeFactor:s,state:"learning"};case 1:n=Math.max(1,n*1.2),s=Math.max(1.3,s-.15);break;case 2:break;case 3:s+=.15;break}const l=Math.max(n+1,n*s);return{due:t+l*24*3600*1e3,interval:l,easeFactor:s,state:"review"}}class Cn{static async render(e,t,n={}){if(!e)return;const s=new Map;let a=0;const l=(t||"").replace(/^::>\s*(?:\[([ xX])]\s*)?(.*)\n?((?:^[ \t]{4,}.*\n?|^\s*\n)*)/gm,(h,m,w,v)=>{const k=`\x3C!-- FOLDABLE_BLOCK_${a} -->`,B=v.split(`
`).map(F=>F.substring(4)).join(`
`);return s.set(k,{checkmark:m,label:w.trim(),rawContent:B}),a++,`
${k}
`});let u=this.parseMarkdown(l);for(const[h,m]of s.entries()){const w=this.parseMarkdown(m.rawContent);let v=ce(m.label);if(m.checkmark!==void 0){const B=m.checkmark.toLowerCase()==="x";v=`
                    <input type="checkbox" class="task-checkbox-in-summary" data-task-title="${ce(m.label)}" ${B?"checked":""}>
                    ${ce(m.label)}
                `}const k=`
                <details class="foldable-block" open>
                    <summary>${v}</summary>
                    <div class="foldable-content">${w}</div>
                </details>`;u=u.replace(new RegExp(`<p>${h}</p>|${h}`),k)}n.fileId&&n.clozeStates&&(u=this.processCloze(u,n.fileId,n.clozeStates)),e.innerHTML=u,await this.renderMathAndMermaid(e)}static parseMarkdown(e){if(!window.marked)return`<p>${e||""}</p>`;const t=new window.marked.Renderer;return t.listitem=n=>{console.log("[Marked Renderer] Received token:",n);const s=n.text,a=n.task,l=n.checked;return a?(console.log(`[Marked Renderer] Rendering a TASK item. Text: "${s}", Checked: ${l}`),`<li class="task-list-item"><input type="checkbox" ${l?"checked":""}> ${s}</li>`):`<li>${s}</li>`},window.marked.setOptions({gfm:!0,breaks:!0,renderer:t}),window.marked.parse(e||"")}static processCloze(e,t,n){const s=/--(?:\s*\[([^\]]*)\])?\s*(.*?)--(?:\^\^audio:(.*?)\^\^)?/g;return e.replace(s,(a,l,u,h)=>{const m=u.trim(),w=`${t}_${al(l?l.trim():m)}`;return`<span class="cloze ${(n[w]||{state:"new"}).state!=="mastered"?"hidden":""}" data-cloze-id="${w}" data-multimedia="${h||""}">
                        ${h?'<span class="media-icon" title="Play audio"><i class="fas fa-volume-up"></i></span>':""}
                        <span class="cloze-content">${m.replace(/¶/g,"<br>")}</span>
                        <span class="placeholder">[...]</span>
                    </span>`})}static async renderMathAndMermaid(e){if(window.mermaid)try{const t=e.querySelectorAll("pre.mermaid, .mermaid");t.length>0&&await mermaid.run({nodes:t})}catch(t){console.error("Mermaid rendering failed:",t)}if(window.MathJax&&typeof window.MathJax.typesetPromise=="function")try{await window.MathJax.typesetPromise([e])}catch(t){console.error("MathJax typesetting failed:",t)}}}const El=100;class Al{constructor(){this.state={currentSessionId:null,currentFolderId:null,folderStack:[],sessions:[],folders:[],clozeStates:{},reviewCount:0,viewMode:"preview",isEditorCollapsed:!1,isSidebarVisible:!0,selectedItemIds:new Set,areAllClozesVisible:!1,expandedHeadingIds:new Set,isMoveModalVisible:!1,isCustomStudyModalVisible:!1,isStatsModalVisible:!1,editorContent:"",undoStack:[],redoStack:[],editorScrollRatio:0,editorSelection:{start:0,end:0,text:"",hasSelection:!1},pendingEditorSelection:null,previewSelection:{text:"",hasSelection:!1,timestamp:0},clozeOrderInCurrentFile:[],previewContent:"",lastInteractedClozeId:null,highlightedClozeId:null,highlightedHeadingId:null,reviewQueue:[],currentReviewIndex:-1,isNavigating:!1,isSaving:!1,isUpdatingPreview:!1},this._lastToggledItemId=null,this.listeners=new Set,this.currentUpdatePromise=null}getState(){return{...this.state}}setState(e){const t={...this.state};Object.keys(e).some(s=>this.state[s]!==e[s])&&(this.state={...this.state,...e},this.notify(t,this.state))}subscribe(e,t){const n={callback:e,keys:t?new Set(t):null};return this.listeners.add(n),()=>this.listeners.delete(n)}notify(e,t){const n=new Set;for(const s in t)e[s]!==t[s]&&n.add(s);n.size!==0&&this.listeners.forEach(s=>{(!s.keys||[...s.keys].some(a=>n.has(a)))&&s.callback(t,e)})}async toggleTaskInContent(e){const{editorContent:t}=this.state,n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(`(::>\\s*\\[)([ xX])(\\]\\s*${n})`,"m"),a=t.match(s);if(a){const l=a[2].trim().toLowerCase()==="x"?" ":"x",u=t.replace(s,`${a[1]}${l}${a[3]}`);this.recordUndoState(t),this.setState({editorContent:u}),await this.updatePreview()}else console.warn("Could not find task to toggle in editorContent:",e)}async toggleListItemTask(e){const{editorContent:t}=this.state,n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(`(^\\s*[-*+]\\s*\\[)([ xX])(\\]\\s*${n})`,"m"),a=t.match(s);if(a){const l=a[2].trim().toLowerCase()==="x"?" ":"x",u=t.replace(s,`${a[1]}${l}${a[3]}`);this.recordUndoState(t),this.setState({editorContent:u}),await this.updatePreview()}else console.warn("Could not find list item task to toggle:",e)}async initialize(){const e=await va();this.setState(e),await this.updateReviewCount(),e.currentSessionId&&await this.updatePreview()}async createFile(){const e=prompt("请输入新文件的名称：","新笔记");if(!(!e||!e.trim()))try{const t=await ea(e.trim(),Ji,this.state.currentFolderId);this.setState({sessions:[...this.state.sessions,t]}),await this.navigateToFile(t.id)}catch(t){console.error("Failed to create file:",t),alert("创建文件失败，请重试。")}}async createFolder(){const e=prompt("请输入新目录的名称：","新目录");if(!e||!e.trim())return;const t=await yl(e.trim(),this.state.currentFolderId);this.setState({folders:[...this.state.folders,t]})}async deleteSelectedItems(){const{selectedItemIds:e}=this.state;if(e.size===0||!confirm(`确定要删除选中的 ${e.size} 个项目吗？`))return;const{remainingSessions:t,remainingFolders:n,remainingClozeStates:s}=await vl(Array.from(e)),a={sessions:t,folders:n,clozeStates:s,selectedItemIds:new Set};if(e.has(this.state.currentSessionId)){const l=t.length>0?t[0].id:null;await this.navigateToFile(l)}this.setState(a),await this.updateReviewCount()}async moveSelectedItems(e){const t=Array.from(this.state.selectedItemIds);if(t.length===0)return;const{updatedSessions:n,updatedFolders:s}=await bl(t,e);this.setState({sessions:n,folders:s,isMoveModalVisible:!1,selectedItemIds:new Set})}async importFiles(e){if(!e||e.length===0)return;const t=n=>new Promise((s,a)=>{const l=new FileReader;l.onload=u=>s({name:n.name,content:u.target.result}),l.onerror=u=>a(u),l.readAsText(n)});try{const n=await Promise.all(Array.from(e).map(t)),s=[];for(const a of n){const l=a.name.lastIndexOf(".")>0?a.name.substring(0,a.name.lastIndexOf(".")):a.name,u=await ea(l,a.content,this.state.currentFolderId);s.push(u)}this.setState({sessions:[...this.state.sessions,...s]}),s.length>0&&await this.navigateToFile(s[s.length-1].id)}catch(n){console.error("文件导入失败:",n),alert("读取文件时发生错误。")}}async renameItem(e,t){const n=t==="file"?this.state.sessions:this.state.folders,s=n.find(h=>h.id===e);if(!s)return;const a=prompt("输入新名称:",s.name);if(!a||a.trim()===s.name)return;const l=await wl(e,a.trim(),t),u=n.map(h=>h.id===e?l:h);this.setState(t==="file"?{sessions:u}:{folders:u})}async navigateToFile(e){if(!(this.state.isNavigating||this.state.currentSessionId===e)){this.setState({isNavigating:!0});try{this.state.currentSessionId&&await this.saveCurrentSession();const t=this.state.sessions.find(n=>n.id===e);if(!t){this.setState({currentSessionId:null,editorContent:"",previewContent:"",viewMode:"preview",isNavigating:!1});return}this.setState({currentSessionId:e,editorContent:t.content||"",viewMode:"preview",expandedHeadingIds:new Set}),await this.updatePreview()}catch(t){console.error("Navigation failed:",t)}finally{this.setState({isNavigating:!1})}}}async goToFolder(e){const{newCurrentFolderId:t,newFolderStack:n}=_l(this.state.folderStack,this.state.currentFolderId,e);this.setState({currentFolderId:t,folderStack:n,currentSessionId:null,editorContent:"",previewContent:""})}goBack(){const e=[...this.state.folderStack],t=e.pop()||null;this.setState({currentFolderId:t,folderStack:e,currentSessionId:null,editorContent:"",previewContent:""})}goToRoot(){this.setState({currentFolderId:null,folderStack:[]})}toggleItemSelection(e,t){const n=new Set(this.state.selectedItemIds),s=[...this.state.folders,...this.state.sessions].filter(a=>a.folderId===this.state.currentFolderId);if(t&&this._lastToggledItemId){const a=s.findIndex(u=>u.id===this._lastToggledItemId),l=s.findIndex(u=>u.id===e);if(a!==-1&&l!==-1){const u=Math.min(a,l),h=Math.max(a,l);for(let m=u;m<=h;m++)n.add(s[m].id)}}else n.has(e)?n.delete(e):n.add(e);this._lastToggledItemId=e,this.setState({selectedItemIds:n})}selectAllItems(){const e=[...this.state.folders,...this.state.sessions].filter(t=>t.folderId===this.state.currentFolderId).map(t=>t.id);this.setState({selectedItemIds:new Set(e)})}deselectAllItems(){this.setState({selectedItemIds:new Set})}toggleSidebar(){this.setState({isSidebarVisible:!this.state.isSidebarVisible})}setScrollRatio(e){typeof e=="number"&&e>=0&&e<=1&&this.setState({editorScrollRatio:e})}recordUndoState(e){const{undoStack:t}=this.state;if(t[t.length-1]===e)return;const n=[...t,e];n.length>El&&n.shift(),this.setState({undoStack:n,redoStack:[]})}undo(){const{undoStack:e,editorContent:t}=this.state;if(e.length===0)return;const n=[...e],s=n.pop();this.setState({undoStack:n,redoStack:[t,...this.state.redoStack],editorContent:s}),this.updatePreview()}redo(){const{redoStack:e,editorContent:t}=this.state;if(e.length===0)return;const n=[...e],s=n.shift();this.setState({undoStack:[...this.state.undoStack,t],redoStack:n,editorContent:s}),this.updatePreview()}setPreviewSelection(e){const t=!!(e&&e.trim().length>0);this.setState({previewSelection:{text:t?e.trim():"",hasSelection:t,timestamp:Date.now()}})}selectTextInEditor(e){e&&(this.setState({pendingEditorSelection:e,viewMode:"edit"}),setTimeout(()=>{this.state.pendingEditorSelection===e&&this.setState({pendingEditorSelection:null})},100))}wrapEditorSelection({prefix:e,suffix:t=e,selectionStart:n,selectionEnd:s}){const{editorContent:a}=this.state,l=a.substring(n,s),u=`${e}${l}${t}`,h=a.substring(0,n)+u+a.substring(s);this.recordUndoState(a),this.setState({editorContent:h}),this.updatePreview()}createOrUpdateClozeFromSelection({selectionStart:e,selectionEnd:t}){const{editorContent:n}=this.state,s=new RegExp("--.*?--","gd"),a=[...n.matchAll(s)].map(B=>({start:B.indices[0][0],end:B.indices[0][1],content:B[0]}));for(const B of a)if(e>=B.start+2&&t<=B.end-2)return;let l=e,u=t;for(const B of a){const F=B.start<u&&B.end>l,O=n.substring(B.end,l),N=O.trim()===""&&O.length>=0,V=n.substring(u,B.start),G=V.trim()===""&&V.length>=0;(F||N||G)&&(l=Math.min(l,B.start),u=Math.max(u,B.end))}const m=n.substring(l,u).replace(/--/g,""),v=`--[${`c${Date.now()}`}] ${m}--`,k=n.substring(0,l)+v+n.substring(u);this.recordUndoState(n),this.setState({editorContent:k}),this.updatePreview()}insertCloze({selectionStart:e,selectionEnd:t}){this.createOrUpdateClozeFromSelection({selectionStart:e,selectionEnd:t})}insertAudioPrompt({selectionStart:e,selectionEnd:t}){const{editorContent:n}=this.state,s=n.substring(e,t),a=prompt("请输入Cloze的音频提示文本:",s);if(a===null)return;const l=`--${s}--^^audio:${a.trim()}^^`,u=n.substring(0,e)+l+n.substring(t);this.recordUndoState(n),this.setState({editorContent:u}),this.updatePreview()}async rateCloze(e,t){const{clozeStates:n}=this.state,s=n[e];if(!s)return;const a=ba(s,t),l={...s,...a,lastReview:Date.now(),tempVisible:!1},u={...n,[e]:l};this.setState({clozeStates:u}),await Sl(l),await this.updateReviewCount()}toggleClozeVisibility(e){const{clozeStates:t}=this.state,n=t[e];if(!n){console.warn(`Cloze with id "${e}" not found in state. Preview might be out of sync.`);return}const s={...n,tempVisible:!n.tempVisible};this.setState({clozeStates:{...t,[e]:s}})}toggleAllClozesVisibility(){this.setState({areAllClozesVisible:!this.state.areAllClozesVisible})}invertAllClozesVisibility(){const{clozeStates:e,areAllClozesVisible:t}=this.state,n={...e};let s=!0;Object.keys(n).forEach(a=>{n[a].fileId===this.state.currentSessionId&&(n[a].tempVisible=t?!1:!n[a].tempVisible,n[a].tempVisible||(s=!1))}),this.setState({clozeStates:n,areAllClozesVisible:s})}recordClozeInteraction(e){this.setState({lastInteractedClozeId:e})}navigateToCloze(e){const t=document.getElementById("anki_preview");if(!t)return;const{scrollTop:n,clientHeight:s}=t,l=Array.from(t.querySelectorAll(".cloze.hidden")).filter(w=>{const v=w.offsetTop,k=v+w.offsetHeight;return Math.max(v,n)<Math.min(k,n+s)});if(l.length===0){this.performPageTurn(e,t,!1);return}const{lastInteractedClozeId:u}=this.state;let h=-1;u&&(h=l.findIndex(w=>w.dataset.clozeId===u));let m=null;if(h===-1)e===1?m=l[0]:m=l[l.length-1];else{const w=h+e;w>=0&&w<l.length&&(m=l[w])}m?this.highlightCloze(m.dataset.clozeId):this.performPageTurn(e,t,!0)}highlightCloze(e){this.setState({highlightedClozeId:e,lastInteractedClozeId:e}),setTimeout(()=>this.setState({highlightedClozeId:null}),1500)}performPageTurn(e,t,n=!1){const{scrollTop:s,clientHeight:a,scrollHeight:l}=t,u=1;if(e===1){if(s+a>=l-u){alert("已到文件结尾"),t.scrollTo({top:0,behavior:"smooth"});return}t.scrollTo({top:s+a,behavior:"smooth"})}else{if(s<=u){alert("已到文件顶部"),t.scrollTo({top:l,behavior:"smooth"});return}t.scrollTo({top:Math.max(0,s-a),behavior:"smooth"})}n&&setTimeout(()=>{const h=t.scrollTop,m=h+t.clientHeight,w=Array.from(t.querySelectorAll(".cloze.hidden"));let v=null;e===1?v=w.find(k=>k.offsetTop>=h):v=w.filter(k=>k.offsetTop<m).pop(),v&&this.highlightCloze(v.dataset.clozeId)},350)}async updateReviewCount(){const e=await Il();this.setState({reviewCount:e})}async startReviewSession(e){const t=await Tl(e);if(t.length===0){alert("太棒了！当前范围内没有需要复习的卡片。");return}this.setState({reviewQueue:t,currentReviewIndex:0,isCustomStudyModalVisible:!1}),await this.showNextReviewCard()}async showNextReviewCard(){const{reviewQueue:e,currentReviewIndex:t}=this.state;if(t>=e.length){alert("复习会话结束！"),this.setState({reviewQueue:[],currentReviewIndex:-1});return}const n=e[t];this.state.currentSessionId!==n.fileId?await this.navigateToFile(n.fileId):this.setViewMode("preview")}moveToNextCardInSession(){this.setState({currentReviewIndex:this.state.currentReviewIndex+1}),this.showNextReviewCard()}showMoveModal(){this.setState({isMoveModalVisible:!0})}showCustomStudyModal(){this.setState({isCustomStudyModalVisible:!0})}showStatsModal(){this.setState({isStatsModalVisible:!0})}hideAllModals(){this.setState({isMoveModalVisible:!1,isCustomStudyModalVisible:!1,isStatsModalVisible:!1})}toggleHeadingExpansion(e){const t=new Set(this.state.expandedHeadingIds);t.has(e)?t.delete(e):t.add(e),this.setState({expandedHeadingIds:t})}navigateToHeading(e){this.setState({highlightedHeadingId:e}),setTimeout(()=>{this.state.highlightedHeadingId===e&&this.setState({highlightedHeadingId:null})},1e3)}async saveCurrentSession(){const{currentSessionId:e,editorContent:t,sessions:n}=this.state;if(!(this.state.isSaving||!e)){this.setState({isSaving:!0});try{const{subsessions:s}=await kl(e,t),a=n.map(l=>l.id===e?{...l,content:t}:l);this.setState({sessions:a,fileSubsessions:{...this.state.fileSubsessions,[e]:s}})}catch(s){console.error("Failed to save session:",s)}finally{this.setState({isSaving:!1})}}}async updatePreview(){if(this.state.isUpdatingPreview)return this.currentUpdatePromise;this.setState({isUpdatingPreview:!0}),this.currentUpdatePromise=this._doUpdatePreview();try{await this.currentUpdatePromise}catch(e){console.error("Preview update failed:",e)}finally{this.setState({isUpdatingPreview:!1}),this.currentUpdatePromise=null}}async _doUpdatePreview(){const{editorContent:e,currentSessionId:t,clozeStates:n}=this.state,s=document.getElementById("anki_preview");if(!s){console.error("Preview element not found in DOM.");return}if(!t){this.setState({previewContent:"",clozeStates:{},clozeOrderInCurrentFile:[]}),s.innerHTML='<div class="empty-preview"><p>请选择一个文件</p></div>';return}try{await Cn.render(s,e,{fileId:t,clozeStates:n});const a=gl(e||""),l=new Map,u=[];s.querySelectorAll(".cloze[data-cloze-id]").forEach(v=>{const k=v.dataset.clozeId;u.push(k),n[k]||l.set(k,{id:k,fileId:t,state:"new",due:Date.now(),tempVisible:!1})});const h={...n};let m=!1;for(const[v,k]of l.entries())h[v]||(h[v]=k,m=!0);const w={previewContent:s.innerHTML,fileSubsessions:{...this.state.fileSubsessions,[t]:a},clozeOrderInCurrentFile:u};m&&(w.clozeStates=h),this.setState(w)}catch(a){console.error("Preview rendering failed:",a),this.setState({previewContent:"<p>预览渲染失败</p>"})}}setViewMode(e){e!==this.state.viewMode&&(e==="preview"?this.updatePreview().then(()=>{this.setState({viewMode:e})}):this.setState({viewMode:e}))}debugState(){var e,t;console.log("Current Anki State:",{currentSessionId:this.state.currentSessionId,sessionsCount:this.state.sessions.length,editorContent:((e=this.state.editorContent)==null?void 0:e.substring(0,100))+"...",previewContent:((t=this.state.previewContent)==null?void 0:t.substring(0,100))+"...",viewMode:this.state.viewMode})}}const Ll=new Al,Bl=(i,e,t)=>{let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>i.apply(t,s),e)}};let Ol=class{constructor(e){this.store=e,this.element=document.getElementById("anki_editor"),this.container=document.getElementById("anki_editorContainer"),this.isUpdatingInternally=!1,this.setupEventListeners(),this.unsubscribe=e.subscribe(this.handleStateChange.bind(this),["editorContent","viewMode","editorScrollRatio","pendingEditorSelection"])}setupEventListeners(){this.element.addEventListener("input",Bl(e=>{this.isUpdatingInternally||(this.store.recordUndoState(this.store.getState().editorContent),this.store.setState({editorContent:e.target.value}),this.store.updatePreview())},300,this)),this.element.addEventListener("keydown",e=>{if(e.ctrlKey||e.metaKey)switch(e.key){case"s":e.preventDefault(),this.store.saveCurrentSession();break;case"z":e.preventDefault(),this.store.undo();break;case"y":e.preventDefault(),this.store.redo();break}}),this.element.addEventListener("mouseup",()=>this.checkAndSaveSelection("mouseup")),this.element.addEventListener("keyup",()=>this.checkAndSaveSelection("keyup")),this.element.addEventListener("dblclick",()=>this.checkAndSaveSelection("dblclick")),this.element.addEventListener("scroll",()=>{if(this.store.getState().viewMode==="edit"){const e=this.element;if(e.scrollHeight>e.clientHeight){const t=e.scrollTop/(e.scrollHeight-e.clientHeight);this.store.setScrollRatio(Math.min(1,Math.max(0,t)))}}})}checkAndSaveSelection(e="unknown"){const t=this.element.selectionStart,n=this.element.selectionEnd,s=this.element.value.substring(t,n),a=t!==n&&s.trim().length>0;this.store.setState({editorSelection:{start:t,end:n,text:a?s.trim():"",hasSelection:a,timestamp:Date.now()}}),a&&console.log(`✅ [EditorComponent] Selection saved to store from ${e}`)}handleStateChange(e,t){if(e.pendingEditorSelection&&e.pendingEditorSelection!==t.pendingEditorSelection){const n=e.pendingEditorSelection,s=this.element.value.indexOf(n,this.element.selectionStart);if(s!==-1){const a=s+n.length;this.element.style.display="block",this.element.focus(),this.element.setSelectionRange(s,a);const u=this.element.value.substring(0,s).match(/\n/g),h=u?u.length:0,m=parseFloat(getComputedStyle(this.element).lineHeight)||24;this.element.scrollTop=h*m-this.element.clientHeight/2+m/2,this.checkAndSaveSelection("programmatic_jump")}else{const a=this.element.value.indexOf(n);a!==-1&&(this.element.focus(),this.element.setSelectionRange(a,a+n.length),this.checkAndSaveSelection("programmatic_jump_fallback"))}}if(e.editorContent!==t.editorContent&&e.editorContent!==this.element.value){const n=this.element.selectionStart;this.isUpdatingInternally=!0,this.element.value=e.editorContent,this.element.setSelectionRange(n,n),this.isUpdatingInternally=!1}e.viewMode!==t.viewMode&&(this.element.style.display=e.viewMode==="edit"?"":"none"),e.viewMode==="edit"&&t.viewMode==="preview"&&requestAnimationFrame(()=>{const n=this.element;n.scrollHeight>n.clientHeight&&(n.scrollTop=e.editorScrollRatio*(n.scrollHeight-n.clientHeight))})}destroy(){this.unsubscribe()}};class Ml{constructor(){this.dom={audioControls:document.getElementById("anki_audioControls"),audioTitle:document.getElementById("anki_audioTitle"),audioProgress:document.getElementById("anki_audioProgressBar"),playBtn:document.getElementById("anki_playBtn"),pauseBtn:document.getElementById("anki_pauseBtn"),stopBtn:document.getElementById("anki_stopBtn")},this.currentUtterance=null,this.progressInterval=null}initialize(){this.dom.playBtn&&(this.dom.playBtn.addEventListener("click",()=>this.resume()),this.dom.pauseBtn.addEventListener("click",()=>this.pause()),this.dom.stopBtn.addEventListener("click",()=>this.stop()))}play(e){if(!("speechSynthesis"in window)){alert("抱歉，您的浏览器不支持语音合成。");return}this.stop();const t=new SpeechSynthesisUtterance(e);t.lang="en-US",t.rate=1,t.onstart=()=>{t.startTime=Date.now(),this.progressInterval=setInterval(()=>this._updateProgress(),100),this.dom.audioControls.style.display="flex"},t.onend=()=>{this.stop()},this.currentUtterance=t,this.dom.audioTitle.textContent=`正在播放: ${e.substring(0,30)}${e.length>30?"...":""}`,window.speechSynthesis.speak(t)}pause(){window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),clearInterval(this.progressInterval))}resume(){window.speechSynthesis.paused&&(window.speechSynthesis.resume(),this.progressInterval=setInterval(()=>this._updateProgress(),100))}stop(){window.speechSynthesis.cancel(),this.progressInterval&&clearInterval(this.progressInterval),this.dom.audioControls&&(this.dom.audioControls.style.display="none"),this.dom.audioProgress&&(this.dom.audioProgress.style.width="0%"),this.currentUtterance=null}_updateProgress(){if(!this.currentUtterance||!this.currentUtterance.startTime)return;const e=(Date.now()-this.currentUtterance.startTime)/1e3,t=this.currentUtterance.text.length/10,n=Math.min(100,e/t*100);this.dom.audioProgress.style.width=`${n}%`}}const Ki=new Ml;let xl=class{constructor(e){this.store=e,this.element=document.getElementById("anki_preview"),this.unsubscribe=e.subscribe(this.handleStateChange.bind(this),["previewContent","viewMode","clozeStates","areAllClozesVisible","highlightedClozeId","editorScrollRatio","highlightedHeadingId"]),this.setupEventListeners()}setupEventListeners(){this.element.addEventListener("click",this.handleClick.bind(this)),this.element.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.element.addEventListener("mouseup",this.handleSelection.bind(this)),this.element.addEventListener("scroll",()=>{if(this.store.getState().viewMode==="preview"){const e=this.element;if(e.scrollHeight>e.clientHeight){const t=e.scrollTop/(e.scrollHeight-e.clientHeight);this.store.setScrollRatio(Math.min(1,Math.max(0,t)))}}})}handleSelection(e){if(e.target.closest(".cloze, a, button, input"))return;const t=window.getSelection().toString();this.store.setPreviewSelection(t)}handleClick(e){const t=e.target.closest(".task-checkbox-in-summary");if(t){e.preventDefault();const l=t.dataset.taskTitle;l&&this.store.toggleTaskInContent(l);return}if(e.target.matches('.task-list-item input[type="checkbox"]')){const l=e.target.closest(".task-list-item");if(l){e.preventDefault();const u=l.textContent.trim();u&&this.store.toggleListItemTask(u)}return}const n=e.target.closest(".cloze");if(!n)return;if(e.target.closest(".cloze-btn")){e.stopPropagation();const l=e.target.closest(".cloze-btn"),u=parseInt(l.dataset.rating,10);this.store.rateCloze(n.dataset.clozeId,u);return}if(e.target.closest(".media-icon")){e.stopPropagation();const l=n.dataset.multimedia;l&&Ki.play(l);return}this.store.recordClozeInteraction(n.dataset.clozeId);const s=n.dataset.multimedia;n.classList.contains("hidden")&&s&&Ki.play(s),this.store.toggleClozeVisibility(n.dataset.clozeId)}handleDoubleClick(e){const t=e.target.closest(".cloze");if(t){e.stopPropagation(),this.store.toggleClozeVisibility(t.dataset.clozeId);return}if(e.ctrlKey||e.metaKey){const n=window.getSelection().toString().trim();n&&this.store.selectTextInEditor(n)}}async handleStateChange(e,t){if(e.previewContent!==t.previewContent&&e.previewContent||!t.previewContent&&e.previewContent?this.element.innerHTML=e.previewContent:!e.previewContent&&!this.element.innerHTML.includes("empty-preview")&&(this.element.innerHTML='<div class="empty-preview"><p>暂无内容</p></div>'),(e.clozeStates!==t.clozeStates||e.areAllClozesVisible!==t.areAllClozesVisible)&&this.updateClozeVisibility(e),e.viewMode!==t.viewMode||t.viewMode===void 0){const s=e.viewMode==="preview";this.element.style.display=s?"block":"none"}e.viewMode==="preview"&&t.viewMode==="edit"&&requestAnimationFrame(()=>{const s=this.element;s.scrollHeight>s.clientHeight&&(s.scrollTop=e.editorScrollRatio*(s.scrollHeight-s.clientHeight))}),e.highlightedClozeId&&e.highlightedClozeId!==t.highlightedClozeId&&this.highlightAndScrollToCloze(e.highlightedClozeId),e.highlightedHeadingId&&e.highlightedHeadingId!==t.highlightedHeadingId&&this.highlightAndScrollToHeading(e.highlightedHeadingId)}updateClozeVisibility(e){this.element.querySelectorAll(".cloze").forEach(n=>{const s=n.dataset.clozeId,a=e.clozeStates[s];if(!a)return;const l=!e.areAllClozesVisible&&!a.tempVisible;n.classList.toggle("hidden",l);const u=n.querySelector(".cloze-actions");u&&(u.style.display=!l&&!e.areAllClozesVisible?"flex":"none")})}highlightAndScrollToCloze(e){const t=this.element.querySelector(`.cloze[data-cloze-id="${e}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("cloze-nav-active"),setTimeout(()=>t.classList.remove("cloze-nav-active"),1500))}highlightAndScrollToHeading(e){try{const t=this.element.querySelector(`#${CSS.escape(e)}`);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-heading"),setTimeout(()=>{t.classList.remove("highlight-heading")},1500)):console.warn(`Heading with ID #${e} not found in preview.`)}catch(t){console.error(`Error scrolling to heading with ID: #${e}`,t)}}destroy(){this.unsubscribe()}};class Pl{constructor(e){this.store=e,this.listElement=document.getElementById("anki_sessionList"),this.headerElement=document.querySelector(".session-header"),this.breadcrumbsElement=document.getElementById("anki_currentFolderContainer"),this.emptySessionElement=document.getElementById("anki_emptySession"),this.unsubscribe=e.subscribe(this.handleStateChange.bind(this),["sessions","folders","currentSessionId","currentFolderId","selectedItemIds","folderStack","fileSubsessions","expandedHeadingIds"]),this.setupEventListeners()}setupEventListeners(){this.listElement.addEventListener("click",n=>{const s=n.target.closest(".subsession-item");if(s){if(n.stopPropagation(),s.classList.contains("h1")&&s.classList.contains("expandable")){const h=s.dataset.headingId;this.store.toggleHeadingExpansion(h)}else{const h=s.dataset.targetId;h&&this.store.navigateToHeading(h)}return}const a=n.target.closest(".session-item");if(!a)return;const{id:l,type:u}=a.dataset;if(n.target.matches(".select-checkbox")){this.store.toggleItemSelection(l,n.shiftKey);return}if(!n.target.closest(".actions"))if(u==="file"){this.store.navigateToFile(l);const h=this.store.getState().sessions.find(m=>m.id===l);h&&(document.title=`Anki - ${h.name}`)}else u==="folder"&&(this.store.goToFolder(l),document.title="智能学习套件")}),this.breadcrumbsElement.addEventListener("click",n=>{const s=n.target.closest("[data-folder-id]");if(s){n.preventDefault();const a=s.dataset.folderId;a==="root"?this.store.goToRoot():this.store.goToFolder(a)}}),this.headerElement.addEventListener("click",n=>{const s=n.target.closest("button");if(s)switch(s.id){case"anki_newFileBtn":this.store.createFile();break;case"anki_newFolderBtn":this.store.createFolder();break;case"anki_deleteSelectedBtn":this.store.deleteSelectedItems();break;case"anki_moveSelectedBtn":this.store.showMoveModal();break;case"anki_openFileBtn":document.getElementById("anki_fileInput").click();break}}),document.getElementById("anki_selectAllCheckbox").addEventListener("change",n=>{n.target.checked?this.store.selectAllItems():this.store.deselectAllItems()}),document.getElementById("anki_fileInput").addEventListener("change",n=>{this.store.importFiles(n.target.files),n.target.value=""})}handleStateChange(e){this.render(e)}render(e){this.renderBreadcrumbs(e);const t=[...e.folders.filter(n=>n.folderId===e.currentFolderId),...e.sessions.filter(n=>n.folderId===e.currentFolderId)].sort((n,s)=>n.type==="folder"&&s.type==="file"?-1:n.type==="file"&&s.type==="folder"?1:(n.name||"").localeCompare(s.name||""));if(t.length===0)this.listElement.innerHTML="",e.currentFolderId===null?this.emptySessionElement.style.display="block":(this.listElement.innerHTML='<li class="empty-folder">此目录为空</li>',this.emptySessionElement.style.display="none");else{this.emptySessionElement.style.display="none";const n=document.createDocumentFragment();t.forEach(s=>{const a=this.createItemElement(s,e);n.appendChild(a)}),this.listElement.innerHTML="",this.listElement.appendChild(n)}this.updateSelectAllCheckbox(t,e.selectedItemIds)}_createHeadingsListHtml(e,t){if(!e||e.length===0)return"";const{expandedHeadingIds:n}=t;let s='<ul class="subsession-list">';return e.forEach(a=>{const l=Zr(a.text),u=a.children&&a.children.length>0,h=n.has(a.id),m=`subsession-item h1 ${u?"expandable":""} ${h?"expanded":""}`,w=u?'<i class="fas fa-chevron-right heading-toggle-icon"></i>':"";s+=`<li class="${m}" data-heading-id="${a.id}" data-target-id="${l}">
                        ${w}
                        <span class="heading-level">H1</span>
                        <span class="heading-text">${ce(a.text)}</span>
                     </li>`,u&&h&&(s+='<ul class="subsession-list-h2">',a.children.forEach(v=>{const k=Zr(v.text);s+=`<li class="subsession-item h2" data-heading-id="${v.id}" data-target-id="${k}">
                                <span class="heading-level">H2</span>
                                <span class="heading-text">${ce(v.text)}</span>
                             </li>`}),s+="</ul>")}),s+="</ul>",s}createItemElement(e,t){const n=document.createElement("li");n.className=`session-item ${e.type}`,n.dataset.id=e.id,n.dataset.type=e.type,e.id===t.currentSessionId&&n.classList.add("active");const s=t.selectedItemIds.has(e.id),a=e.type==="folder"?"fa-folder folder-icon":"fa-file-alt file-icon";let l="";return e.type==="file"&&e.id===t.currentSessionId&&t.fileSubsessions&&t.fileSubsessions[e.id]&&(l=this._createHeadingsListHtml(t.fileSubsessions[e.id],t)),n.innerHTML=`
            <div class="name-container">
                <input type="checkbox" class="select-checkbox" data-id="${e.id}" ${s?"checked":""}>
                <span class="name"><i class="fas ${a}"></i>${ce(e.name)}</span>
            </div>
            <div class="actions">
                 <i class="fas fa-pencil-alt edit-btn" title="重命名"></i>
            </div>
            ${l} 
        `,n}renderBreadcrumbs(e){let t='<a href="#" data-folder-id="root"><i class="fas fa-folder-open"></i> 根目录</a>';const n=new Map(e.folders.map(s=>[s.id,s.name]));e.folderStack.forEach(s=>{t+=` / <a href="#" data-folder-id="${s}">${ce(n.get(s)||"...")}</a>`}),e.currentFolderId&&(t+=` / <span>${ce(n.get(e.currentFolderId)||"...")}</span>`),this.breadcrumbsElement.innerHTML=t}updateSelectAllCheckbox(e,t){const n=document.getElementById("anki_selectAllCheckbox");if(e.length===0){n.checked=!1,n.indeterminate=!1;return}const s=e.filter(a=>t.has(a.id)).length;n.checked=s===e.length,n.indeterminate=s>0&&s<e.length}destroy(){this.unsubscribe()}}let Nl=class{constructor(e){this.store=e,this.dom={toggleSessionBtn:document.getElementById("anki_toggleSessionBtn"),toggleEditPreviewBtn:document.getElementById("anki_toggleEditPreviewBtn"),saveBtn:document.getElementById("anki_saveBtn"),startReviewBtn:document.getElementById("anki_startReviewBtn"),reviewCount:document.getElementById("anki_reviewCount"),customStudyBtn:document.getElementById("anki_customStudyBtn"),showStatsBtn:document.getElementById("anki_showStatsBtn"),clozeNavUpBtn:document.getElementById("anki_clozeNavUpBtn"),clozeNavDownBtn:document.getElementById("anki_clozeNavDownBtn"),toggleVisibilityClozeBtn:document.getElementById("anki_toggleVisibilityClozeBtn"),invertClozeBtn:document.getElementById("anki_invertClozeBtn"),aiBtn:document.getElementById("anki_aiBtn"),exportFileBtn:document.getElementById("anki_exportFileBtn"),printPreviewBtn:document.getElementById("anki_printPreviewBtn"),editorToolbar:document.getElementById("anki_editorToolbar"),clozeBtn:document.getElementById("anki_clozeBtn"),boldBtn:document.getElementById("anki_boldBtn"),italicBtn:document.getElementById("anki_italicBtn"),codeBtn:document.getElementById("anki_codeBtn"),linkBtn:document.getElementById("anki_linkBtn"),audioBtn:document.getElementById("anki_audioBtn"),insertLinebreakBtn:document.getElementById("anki_insertLinebreakBtn"),editModeDot:document.getElementById("anki_editModeDot"),previewModeDot:document.getElementById("anki_previewModeDot")},this.unsubscribe=e.subscribe(this.handleStateChange.bind(this),["viewMode","isSaving","isSidebarVisible","reviewCount","areAllClozesVisible","currentSessionId","sessions"]),this.setupEventListeners()}setupEventListeners(){this.handleGlobalKeyDown=this.handleGlobalKeyDown.bind(this),document.addEventListener("keydown",this.handleGlobalKeyDown),this.dom.toggleSessionBtn.addEventListener("click",()=>this.store.toggleSidebar()),this.dom.toggleEditPreviewBtn.addEventListener("click",()=>this.store.setViewMode(this.store.getState().viewMode==="edit"?"preview":"edit")),this.dom.saveBtn.addEventListener("click",()=>this.store.saveCurrentSession()),this.dom.startReviewBtn.addEventListener("click",()=>this.store.startReviewSession()),this.dom.customStudyBtn.addEventListener("click",n=>{n.preventDefault(),this.store.showCustomStudyModal()}),this.dom.showStatsBtn.addEventListener("click",n=>{n.preventDefault(),this.store.showStatsModal()}),this.dom.clozeNavUpBtn.addEventListener("click",()=>this.store.navigateToCloze(-1)),this.dom.clozeNavDownBtn.addEventListener("click",()=>this.store.navigateToCloze(1)),this.dom.toggleVisibilityClozeBtn.addEventListener("click",()=>this.store.toggleAllClozesVisibility()),this.dom.invertClozeBtn.addEventListener("click",()=>this.store.invertAllClozesVisibility()),this.dom.aiBtn.addEventListener("click",n=>this.handleAiButtonClick(n)),this.dom.exportFileBtn.addEventListener("click",()=>this.handleExportFile()),this.dom.printPreviewBtn.addEventListener("click",()=>this.handlePrintPreview());const e=document.getElementById("anki_editor"),t=()=>({selectionStart:e.selectionStart,selectionEnd:e.selectionEnd});this.dom.clozeBtn.addEventListener("click",()=>this.store.insertCloze(t())),this.dom.boldBtn.addEventListener("click",()=>this.store.wrapEditorSelection({prefix:"**",...t()})),this.dom.italicBtn.addEventListener("click",()=>this.store.wrapEditorSelection({prefix:"*",...t()})),this.dom.codeBtn.addEventListener("click",()=>this.store.wrapEditorSelection({prefix:"`",...t()})),this.dom.insertLinebreakBtn.addEventListener("click",()=>this.store.wrapEditorSelection({prefix:"¶",suffix:"",...t()})),this.dom.linkBtn.addEventListener("click",()=>this.store.wrapEditorSelection({prefix:"[",suffix:`](${prompt("URL:","https://")})`,...t()})),this.dom.audioBtn.addEventListener("click",()=>this.store.insertAudioPrompt(t()))}handleGlobalKeyDown(e){if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="i"&&this.store.getState().viewMode==="edit"&&document.activeElement.id==="anki_editor"){e.preventDefault();const n=document.getElementById("anki_editor"),{selectionStart:s,selectionEnd:a}=n;s!==a&&this.store.createOrUpdateClozeFromSelection({selectionStart:s,selectionEnd:a})}}handleAiButtonClick(e){console.log("🤖 [ToolbarComponent] AI button clicked"),e.preventDefault();let t="",n="";const s=this.store.getState();let a=null;if(s.viewMode==="edit"?(a=s.editorSelection,n="Editor Selection from Store"):(a=s.previewSelection,n="Preview Selection from Store"),a&&a.hasSelection&&(t=a.text,console.log(`✅ [ToolbarComponent] Using selection from: ${n}`)),t||(t=s.editorContent.trim(),n="Full Content Fallback",console.log("⚠️ [ToolbarComponent] No selection found, using full content as fallback")),console.log("🤖 [ToolbarComponent] Final content decision:",{source:n,contentLength:t.length,contentPreview:t.substring(0,100)+(t.length>100?"...":"")}),!t){console.warn("🤖 [ToolbarComponent] No content to send to AI"),alert("没有内容可以发送给 AI。请先选择文本或确保编辑器中有内容。");return}window.appController&&typeof window.appController.showAiPopup=="function"?(console.log("🤖 [ToolbarComponent] Calling appController.showAiPopup with content from:",n),window.appController.showAiPopup(t)):console.error("🤖 [ToolbarComponent] appController is not available to show AI popup.")}handleExportFile(){const e=this.store.getState();if(!e.currentSessionId){alert("请先选择一个文件进行导出。");return}const t=e.sessions.find(h=>h.id===e.currentSessionId);if(!t)return;const n=e.editorContent,s=`${t.name}.md`,a=new Blob([n],{type:"text/markdown;charset=utf-8"}),l=URL.createObjectURL(a),u=document.createElement("a");u.href=l,u.setAttribute("download",s),document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(l)}handlePrintPreview(){const e=this.store.getState().previewContent;if(!e)return;const t=window.open("","_blank");t.document.write(`
            <!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>打印预览</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <link rel="stylesheet" href="./styles.css">
            <style> 
                @media print { 
                    body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; } 
                    .cloze-actions, .media-icon { display: none !important; } 
                    .cloze.hidden .cloze-content, .cloze .cloze-content { display: inline !important; visibility: visible !important; color: black !important; } 
                    .cloze .placeholder { display: none !important; } 
                    .cloze { -webkit-print-color-adjust: exact; print-color-adjust: exact; border-bottom: 1px dotted #ccc; } 
                    .cloze.hidden { background-color: #f0f0f0 !important; }
                } 
                body { font-family: sans-serif; } 
                .preview { display: block !important; padding: 20px; }
            </style></head><body>
            <div class="preview">${e}</div>
            <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script>
            <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
            <script> 
                window.MathJax = { 
                    startup: { 
                        pageReady: () => { 
                            return window.MathJax.startup.defaultPageReady().then(() => { 
                                setTimeout(() => { // 等待渲染稳定
                                    window.print(); 
                                    window.close(); 
                                }, 500);
                            }); 
                        } 
                    } 
                }; 
            <\/script>
            </body></html>
        `),t.document.close()}handleStateChange(e,t){const n='<i class="fas fa-book-open"></i>';this.dom.toggleEditPreviewBtn.innerHTML=`${n} ${e.viewMode==="edit"?"Preview":"Edit"}`,this.dom.editorToolbar&&(this.dom.editorToolbar.style.display=e.viewMode==="edit"?"flex":"none"),this.dom.saveBtn.disabled=e.isSaving,this.dom.saveBtn.innerHTML=e.isSaving?'<i class="fas fa-spinner fa-spin"></i> Saving...':'<i class="fas fa-save"></i> Save',this.dom.printPreviewBtn.disabled=e.viewMode!=="preview",this.dom.reviewCount.textContent=e.reviewCount,e.areAllClozesVisible?(this.dom.toggleVisibilityClozeBtn.innerHTML='<i class="fas fa-eye"></i>',this.dom.toggleVisibilityClozeBtn.title="全部隐藏"):(this.dom.toggleVisibilityClozeBtn.innerHTML='<i class="fas fa-eye-slash"></i>',this.dom.toggleVisibilityClozeBtn.title="全部显示"),document.querySelector(".anki_session-sidebar").classList.toggle("hidden-session",!e.isSidebarVisible),t&&(e.currentSessionId!==t.currentSessionId||e.sessions!==t.sessions)?this.updatePanelTitle(e):t||this.updatePanelTitle(e),this.dom.editModeDot&&this.dom.previewModeDot&&(this.dom.editModeDot.classList.toggle("active",e.viewMode==="edit"),this.dom.previewModeDot.classList.toggle("active",e.viewMode==="preview"))}updatePanelTitle(e){const t=document.getElementById("anki_panelTitle");if(t){if(e.currentSessionId&&e.sessions){const n=e.sessions.find(s=>s.id===e.currentSessionId);if(n){t.innerHTML=`<i class="fas fa-edit"></i> ${n.name}`;return}}t.innerHTML='<i class="fas fa-edit"></i> Anki 编辑器'}}destroy(){this.unsubscribe(),document.removeEventListener("keydown",this.handleGlobalKeyDown)}};class $l{constructor(){this.store=Ll,this.components=[],typeof window<"u"&&(window.ankiApp=this)}async initialize(){await this.loadInitialData(),Ki.initialize(),this.components=[new Ol(this.store),new xl(this.store),new Pl(this.store),new Nl(this.store)],this.store.subscribe((n,s)=>{(!s||n.currentSessionId!==s.currentSessionId||n.sessions!==s.sessions)&&this.updateDocumentTitle(n)},["currentSessionId","sessions"]);const e=this.store.getState();this.updateDocumentTitle(e),e.currentSessionId&&!e.previewContent&&await this.store.updatePreview();const t={editorContent:"",previewContent:"",viewMode:"edit",currentSessionId:null,sessions:[],isSaving:!1,isSidebarVisible:!0,reviewCount:0,areAllClozesVisible:!1,folders:[],currentFolderId:null,selectedItemIds:new Set,folderStack:[]};this.store.notify(t,this.store.getState()),console.log("AnkiApp initialized successfully.")}updateDocumentTitle(e){if(e.currentSessionId&&e.sessions){const t=e.sessions.find(n=>n.id===e.currentSessionId);if(t){document.title=`Anki - ${t.name}`;return}}document.title="智能学习套件"}async loadInitialData(){const e=await va();if(this.store.state={...this.store.state,...e},e.currentSessionId){const t=e.sessions.find(n=>n.id===e.currentSessionId);t&&(this.store.state.editorContent=t.content)}await this.store.updatePreview()}destroy(){this.components.forEach(e=>e.destroy()),this.components=[]}}const ms=new $l;async function Dl(i){const{apiConfigs:e,agents:t,topics:n,history:s}=i;try{await $.transaction("rw",[$.agent_apiConfigs,$.agent_agents,$.agent_topics,$.agent_history],async()=>{const a=new Set(e.map(m=>m.id)),l=new Set(t.map(m=>m.id)),u=new Set(n.map(m=>m.id)),h=new Set(s.map(m=>m.id));await Promise.all([$.agent_apiConfigs.where("id").noneOf(Array.from(a)).delete(),$.agent_agents.where("id").noneOf(Array.from(l)).delete(),$.agent_topics.where("id").noneOf(Array.from(u)).delete(),$.agent_history.where("id").noneOf(Array.from(h)).delete()]),await Promise.all([$.agent_apiConfigs.bulkPut(e),$.agent_agents.bulkPut(t),$.agent_topics.bulkPut(n),$.agent_history.bulkPut(s)])})}catch(a){throw console.error("Failed to persist agent data:",a),a}}async function Fl(i,e){if(!i||!e)return console.error("需要标题和agentId才能创建新主题。"),null;const t={id:Ve(),agentId:e,title:i,icon:"fas fa-comment",createdAt:new Date().toISOString()};return await $.agent_topics.put(t),t}async function na(i,e){const t=await $.agent_topics.get(i);if(!t)return null;const n={...t,...e};return await $.agent_topics.put(n),n}async function Kl(i){await $.transaction("rw",[$.agent_topics,$.agent_history],async()=>{await $.agent_topics.bulkDelete(i);const n=await $.agent_history.where("topicId").anyOf(i).keys();await $.agent_history.bulkDelete(n)});const e=await $.agent_topics.toArray(),t=await $.agent_history.toArray();return{remainingTopics:e,remainingHistory:t}}async function sa(i,e,t,n=[],s="completed",a=null,l=null){const u={id:Ve(),topicId:i,role:e,content:t,attachments:n,status:s,reasoning:l,agentId:e==="assistant"?a:null,timestamp:new Date().toISOString()};return await $.agent_history.put(u),u}async function Ci(i){return await $.agent_history.put(i)}async function Ei(i){return await $.agent_history.bulkDelete(i)}function Rl(i,e){const{topics:t,history:n,agents:s}=e,a=t.find(h=>h.id===i);if(!a)return{topic:null,lastConversationAgentId:null};if(a.lastUsedAgentId&&s.some(h=>h.id===a.lastUsedAgentId))return{topic:a,lastConversationAgentId:a.lastUsedAgentId};const l=n.filter(h=>h.topicId===i&&h.role==="assistant"&&h.agentId).sort((h,m)=>new Date(m.timestamp)-new Date(h.timestamp))[0];if(l&&l.agentId)return{topic:a,lastConversationAgentId:l.agentId};if(a.agentId)return{topic:a,lastConversationAgentId:a.agentId};const u=s.length>0?s[0].id:null;return{topic:a,lastConversationAgentId:u}}function jl(i,e,t){const n=e.find(s=>s.id===i);if(n){const[s,a]=n.model.split(":"),l=t.find(h=>h.id===s);if(!l)return{error:`错误：找不到角色 "${n.name}" 所需的 API 配置。`};const u=new Map((l.models||"").split(",").map(h=>h.split(":").map(m=>m.trim()))).get(a);return u?{provider:l.provider,apiPath:l.apiUrl||Fi(l.provider),apiKey:l.apiKey,model:u,systemPrompt:n.systemPrompt}:{error:`错误：在 API 配置 "${l.name}" 中找不到别名 "${a}"。`}}else{const s=t[0];if(!s)return{error:"错误：没有找到可用的 API 配置。"};const l=new Map((s.models||"").split(",").map(u=>u.split(":").map(h=>h.trim()))).values().next().value;return l?{provider:s.provider,apiPath:s.apiUrl||Fi(s.provider),apiKey:s.apiKey,model:l,systemPrompt:""}:{error:`错误：在 API 配置 "${s.name}" 中找不到任何模型。`}}}class wa{constructor(e){this.config=e}async chatStream(e,{onChunk:t,onDone:n,onError:s}){throw new Error("Adapter must implement chatStream method.")}_preparePayload(e){throw new Error("Adapter must implement _preparePayload method.")}}class ql extends wa{_preparePayload(e){return{model:this.config.model,messages:e,stream:!0}}async chatStream(e,{onChunk:t,onDone:n,onError:s}){var l;const a=this._preparePayload(e);try{const u=await fetch(this.config.apiPath,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(a)});if(!u.ok){const w=await u.text();throw new Error(`API Error: ${u.status} ${u.statusText} - ${w}`)}const h=u.body.getReader(),m=new TextDecoder("utf-8");for(;;){const{done:w,value:v}=await h.read();if(w){n();break}const B=m.decode(v).split(`
`).filter(F=>F.trim().startsWith("data:"));for(const F of B){const O=F.replace(/^data: /,"").trim();if(O==="[DONE]"){n();return}try{const V=(l=JSON.parse(O).choices[0])==null?void 0:l.delta;if(V){const G=V.content;G&&t({type:"content",text:G});const Q=V.reasoning_content;if(Q){const W=`<thinking>${Q}</thinking>`;t({type:"thinking",text:W})}}}catch(N){console.error("Error parsing stream data chunk:",O,N)}}}}catch(u){console.error("LLM Stream Error:",u),s(u)}}}class zl extends wa{_preparePayload(e){return{contents:e.map(n=>({role:n.role==="assistant"?"model":"user",parts:[{text:n.content}]}))}}async chatStream(e,{onChunk:t,onDone:n,onError:s}){var u,h,m,w,v;const a=this._preparePayload(e),l=`${this.config.apiPath}/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`;try{const k=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!k.ok){const N=await k.text();throw new Error(`API Error: ${k.status} ${k.statusText} - ${N}`)}const B=k.body.getReader(),F=new TextDecoder("utf-8");let O="";for(;;){const{done:N,value:V}=await B.read();if(N){n();break}O+=F.decode(V,{stream:!0});const G=O.split(`
`);O=G.pop();for(const Q of G)if(!(Q.trim().startsWith("[")||Q.trim().startsWith(","))&&!Q.trim().endsWith("]"))try{const ee=((v=(w=(m=(h=(u=JSON.parse(Q).candidates)==null?void 0:u[0])==null?void 0:h.content)==null?void 0:m.parts)==null?void 0:w[0])==null?void 0:v.text)||"";ee&&t({type:"content",text:ee})}catch{}}}catch(k){console.error("Gemini Stream Error:",k),s(k)}}}const ia={openAICompatible:ql,gemini:zl};function Hl(i){const e=Wi[i];if(!e||!ia[e.adapter])throw new Error(`Unsupported provider or adapter: ${i}`);return ia[e.adapter]}async function Ul(i,e,t){const n=Hl(i.provider),s=new n(i),a=[];i.systemPrompt&&a.push({role:"system",content:i.systemPrompt}),e.forEach(l=>{a.push({role:l.role,content:l.content})}),await s.chatStream(a,t)}class Vl{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(n=>n(t))}off(e,t){if(this.listeners.has(e)){const n=this.listeners.get(e),s=n.indexOf(t);s>-1&&n.splice(s,1)}}}class Yl{constructor(){this.state={apiConfigs:[],agents:[],topics:[],history:[],currentTopicId:null,currentConversationAgentId:null,topicScrollPositions:{},topicListFilterTag:"all",editorSelection:{start:0,end:0,text:"",hasSelection:!1},previewSelection:{text:"",hasSelection:!1,timestamp:0},isAiThinking:!1,isTopicsPanelHidden:!1,isTopicSelectionMode:!1,selectedTopicIds:new Set},this.listeners=new Set,this.streamEmitter=new Vl}subscribe(e,t){const n={callback:e,keys:t?new Set(t):null};return this.listeners.add(n),()=>this.listeners.delete(n)}setState(e){const t={...this.state};!Object.keys(e).some(s=>this.state[s]!==e[s])&&Object.keys(e).length>0||(this.state={...this.state,...e},this.notify(t,this.state))}notify(e,t){const n=new Set;for(const s in t)e[s]!==t[s]&&n.add(s);n.size!==0&&this.listeners.forEach(s=>{(!s.keys||[...s.keys].some(a=>n.has(a)))&&s.callback(t,e)})}getState(){return{...this.state}}async persistState(){try{const{apiConfigs:e,agents:t,topics:n,history:s}=this.state;await Dl({apiConfigs:e,agents:t,topics:n,history:s})}catch(e){console.error("Failed to persist agent state:",e)}}getFilteredTopics(){const{topicListFilterTag:e,topics:t,history:n,agents:s}=this.state;if(!t)return[];const a=[...t].sort((u,h)=>new Date(h.createdAt)-new Date(u.createdAt));if(e==="all")return a;const l=new Map(s.map(u=>[u.id,u]));return a.filter(u=>{var w;const h=u.lastUsedAgentId||u.agentId;if(!h)return!1;const m=l.get(h);return(w=m==null?void 0:m.tags)==null?void 0:w.includes(e)})}setPreviewSelection(e){const t=!!(e&&e.trim().length>0);this.setState({previewSelection:{text:t?e.trim():"",hasSelection:t,timestamp:Date.now()}})}async initialize(e){this.setState({apiConfigs:e.apiConfigs||[],agents:e.agents||[],topics:e.topics||[],history:e.history||[]})}async addTopic(e){var t;if(e)try{const n=await Fl(e,(t=this.state.agents[0])==null?void 0:t.id);n?(this.setState({topics:[...this.state.topics,n],currentTopicId:n.id}),await this.persistState()):console.error("Failed to add a new topic.")}catch(n){console.error("Error adding topic:",n),alert("创建主题失败，请重试。")}}async selectTopic(e){if(!e||e===this.state.currentTopicId)return;const t=document.getElementById("agent_historyContent"),n=t?t.scrollTop:0,s={...this.state.topicScrollPositions,[this.state.currentTopicId]:n},{topic:a,lastConversationAgentId:l}=Rl(e,this.state);a?this.setState({currentTopicId:a.id,currentConversationAgentId:l,topicScrollPositions:s}):console.warn(`selectTopic: Topic with ID "${e}" not found.`)}async renameCurrentTopic(e){const{currentTopicId:t}=this.state;if(!(!t||!e))try{const n=await na(t,{title:e});this.setState({topics:this.state.topics.map(s=>s.id===t?n:s)}),await this.persistState()}catch(n){console.error("Error renaming topic:",n),alert("重命名主题失败，请重试。")}}async deleteTopics(e){const t=Array.isArray(e)?e:Array.from(e);if(t.length!==0)try{const{remainingTopics:n,remainingHistory:s}=await Kl(t);let a=this.state.currentTopicId;t.includes(a)&&(a=n.length>0?n[0].id:null),this.setState({topics:n,history:s,currentTopicId:a,isTopicSelectionMode:!1,selectedTopicIds:new Set}),await this.persistState()}catch(n){console.error("Error deleting topics:",n),alert("删除主题失败，请重试。")}}setTopicFilter(e){this.setState({topicListFilterTag:e})}enterSelectionMode(){this.setState({isTopicSelectionMode:!0,selectedTopicIds:new Set})}cancelSelectionMode(){this.setState({isTopicSelectionMode:!1,selectedTopicIds:new Set})}toggleTopicSelection(e){const t=new Set(this.state.selectedTopicIds);t.has(e)?t.delete(e):t.add(e),this.setState({selectedTopicIds:t})}selectAllTopics(){const e=this.getFilteredTopics().map(n=>n.id),t=e.length>0&&e.length===this.state.selectedTopicIds.size;this.setState({selectedTopicIds:t?new Set:new Set(e)})}async sendMessage(e,t){const{currentTopicId:n,isAiThinking:s}=this.state;if(!(!n||s))try{const a=await sa(n,"user",e,t);this.setState({history:[...this.state.history,a]}),await this.persistState();const l=this.state.history.filter(u=>u.topicId===n&&u.status!=="streaming");await this._fetchAIResponse(l)}catch(a){console.error("Error sending message:",a),alert("发送消息失败，请重试。")}}async deleteMessagePair(e){var t,n;try{const s=this.state.history,a=s.find(w=>w.id===e);if(!a)return;const l=s.filter(w=>w.topicId===a.topicId).sort((w,v)=>new Date(w.timestamp)-new Date(v.timestamp)),u=l.findIndex(w=>w.id===e);let h=new Set([e]);a.role==="user"&&((t=l[u+1])==null?void 0:t.role)==="assistant"?h.add(l[u+1].id):a.role==="assistant"&&((n=l[u-1])==null?void 0:n.role)==="user"&&h.add(l[u-1].id);const m=s.filter(w=>!h.has(w.id));await Ei(Array.from(h)),this.setState({history:m}),await this.persistState()}catch(s){console.error("Error deleting message pair:",s),alert("删除消息失败，请重试。")}}async regenerateAssistantResponse(e){if(!this.state.isAiThinking)try{const t=this.state.history,n=t.findIndex(u=>u.id===e);if(n===-1||t[n].role!=="assistant")return;const s=t[n].topicId,a=t.filter(u=>u.id!==e);this.setState({history:a}),await Ei([e]),await this.persistState();const l=a.filter(u=>u.topicId===s&&u.status!=="streaming");await this._fetchAIResponse(l)}catch(t){console.error("Error regenerating response:",t),alert("重新生成回复失败，请重试。")}}async editUserMessage(e,t){if(!this.state.isAiThinking)try{const n=this.state.history,s=n.findIndex(k=>k.id===e);if(s===-1||n[s].role!=="user")return;const a=n[s].topicId,l=n.filter(k=>k.topicId===a).sort((k,B)=>new Date(k.timestamp)-new Date(B.timestamp)),u=l.findIndex(k=>k.id===e),h=l.slice(u+1).map(k=>k.id);await Ei(h);const m={...n[s],content:t};await Ci(m);const w=n.filter(k=>!h.has(k.id)).map(k=>k.id===e?m:k);this.setState({history:w}),await this.persistState();const v=w.filter(k=>k.topicId===a&&k.status!=="streaming");await this._fetchAIResponse(v)}catch(n){console.error("Error editing user message:",n),alert("编辑消息失败，请重试。")}}async _fetchAIResponse(e){const{currentTopicId:t,currentConversationAgentId:n,apiConfigs:s,agents:a}=this.state;try{const l=jl(n,a,s);if(l.error){alert(l.error);return}this.setState({isAiThinking:!0});const u=await sa(t,"assistant","",[],"streaming");this.setState({history:[...this.state.history,u]});const h=a.find(k=>k.id===n),m=h&&h.sendHistory===!1?e.slice(-1):e;let w="",v="";await Ul(l,m,{onChunk:({type:k,text:B})=>{k==="content"?w+=B:k==="thinking"&&(v+=B),this.streamEmitter.emit("chunk",{messageId:u.id,type:k,text:B})},onDone:async()=>{const k=this.state.history.find(B=>B.id===u.id);if(k){const B={...k,content:w,reasoning:v,status:"completed"};await Ci(B),this.setState({history:this.state.history.map(F=>F.id===u.id?B:F),isAiThinking:!1}),await this.persistState()}},onError:async k=>{console.error("AI response error:",k);const B=`

**错误:** ${k.message}`;w+=B;const F=this.state.history.find(O=>O.id===u.id);if(F){const O={...F,content:w,reasoning:v,status:"error"};await Ci(O),this.setState({history:this.state.history.map(N=>N.id===u.id?O:N),isAiThinking:!1}),await this.persistState()}}})}catch(l){console.error("Error in AI response:",l),this.setState({isAiThinking:!1}),alert("AI 回复失败，请重试。")}}toggleTopicsPanel(){this.setState({isTopicsPanelHidden:!this.state.isTopicsPanelHidden})}async setConversationAgent(e){const{currentTopicId:t,topics:n}=this.state;if(t)try{this.setState({currentConversationAgentId:e});const s=n.find(a=>a.id===t);if(s&&s.lastUsedAgentId!==e){const a={...s,lastUsedAgentId:e};await na(t,{lastUsedAgentId:e});const l=n.map(h=>h.id===t?a:h),u={...this.state};this.state.topics=l,this.notify(u,this.state),await this.persistState()}}catch(s){console.error("Error setting conversation agent:",s),alert("切换 Agent 失败，请重试。")}}async startConversationFromExternal(e,t=null){if(!(!e||this.state.isAiThinking))try{const n=`AI 助手: "${e.substring(0,30)}..."`;if(await this.addTopic(n),this.getState().currentTopicId)t&&await this.setConversationAgent(t),await this.sendMessage(e,[]);else throw new Error("Failed to create a new topic for the conversation.")}catch(n){console.error("Error starting conversation from external source:",n),alert(`发起对话失败: ${n.message}`)}}}const Ri=new Yl;let Gl=class{constructor(e){this.store=e,this.dom={toggleTopicsBtn:document.getElementById("agent_toggleTopicsBtn"),editTopicBtn:document.getElementById("agent_editTopicBtn"),manageTopicsBtn:document.getElementById("agent_manageTopicsBtn"),historyHeaderTitle:document.getElementById("agent_historyHeaderTitle"),conversationRoleSelector:document.getElementById("agent_conversationRoleSelector"),aiBtn:document.getElementById("agent_aiBtn")},this.store.subscribe(this.render.bind(this),["isTopicsPanelHidden","currentTopicId","topics","agents","currentConversationAgentId","editorSelection","previewSelection"]),this.setupEventListeners()}setupEventListeners(){this.dom.toggleTopicsBtn.addEventListener("click",()=>this.store.toggleTopicsPanel()),this.dom.manageTopicsBtn.addEventListener("click",()=>this.store.enterSelectionMode()),this.dom.editTopicBtn.addEventListener("click",()=>{const e=this.store.getState().topics.find(t=>t.id===this.store.getState().currentTopicId);if(e){const t=prompt("请输入新的主题名称:",e.title);t&&t.trim()!==e.title&&this.store.renameCurrentTopic(t.trim())}}),this.dom.conversationRoleSelector.addEventListener("change",e=>{this.store.setConversationAgent(e.target.value||null)}),this.dom.aiBtn.addEventListener("click",()=>this.handleAiButtonClick())}handleAiButtonClick(){console.log("🤖 [Agent ToolbarComponent] AI button clicked");const e=this.store.getState(),t=document.getElementById("agent_chatInput");let n="",s="";e.previewSelection&&e.previewSelection.hasSelection?(n=e.previewSelection.text,s="History Panel Selection"):e.editorSelection&&e.editorSelection.hasSelection?(n=e.editorSelection.text,s="Chat Input Selection"):t&&t.value.trim()&&(n=t.value.trim(),s="Full Chat Input Fallback"),n?(console.log(`✅ [Agent ToolbarComponent] Using content from: ${s}`),window.appController&&typeof window.appController.showAiPopup=="function"?window.appController.showAiPopup(n):console.error("appController is not available to show AI popup.")):(console.warn("⚠️ [Agent ToolbarComponent] No content available to send to AI."),alert("没有可发送给 AI 的内容。请先在聊天记录或输入框中选择文本，或在输入框中输入内容。"))}render(e){if(this.dom.toggleTopicsBtn.title=e.isTopicsPanelHidden?"显示主题栏":"隐藏主题栏",this.dom.editTopicBtn.style.display=e.currentTopicId?"block":"none",e.currentTopicId){const t=e.topics.find(n=>n.id===e.currentTopicId);this.dom.historyHeaderTitle.textContent=t?`${ce(t.title)} - 对话记录`:"对话记录"}else this.dom.historyHeaderTitle.textContent="选择一个主题开始";this.dom.conversationRoleSelector.innerHTML='<option value="">默认 AI (无角色)</option>',e.agents.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,this.dom.conversationRoleSelector.appendChild(n)}),this.dom.conversationRoleSelector.value=e.currentConversationAgentId||""}};class Jl{constructor(e){this.store=e,this.dom={panel:document.querySelector(".agent_topics-panel"),list:document.getElementById("agent_topicList"),filter:document.getElementById("agent_topicTagFilter"),batchActions:document.getElementById("agent_topicsBatchActions"),selectAllBtn:document.getElementById("agent_selectAllTopicsBtn"),deleteSelectedBtn:document.getElementById("agent_deleteSelectedTopicsBtn"),cancelBtn:document.getElementById("agent_cancelTopicSelectionBtn"),addTopicBtnHeader:document.getElementById("agent_addTopicHeaderBtn")},this.store.subscribe(this.render.bind(this),["isTopicsPanelHidden","topics","currentTopicId","agents","isTopicSelectionMode","selectedTopicIds","topicListFilterTag","history"]),this.setupEventListeners()}setupEventListeners(){this.dom.filter.addEventListener("change",e=>this.store.setTopicFilter(e.target.value)),this.dom.list.addEventListener("click",e=>this.handleListClick(e)),this.dom.cancelBtn.addEventListener("click",()=>this.store.cancelSelectionMode()),this.dom.selectAllBtn.addEventListener("click",()=>this.store.selectAllTopics()),this.dom.deleteSelectedBtn.addEventListener("click",()=>{const e=this.store.getState().selectedTopicIds;e.size>0&&confirm(`确定要删除选中的 ${e.size} 个主题吗？`)&&this.store.deleteTopics(Array.from(e))}),this.dom.addTopicBtnHeader.addEventListener("click",()=>this.handleAddTopicClick())}handleAddTopicClick(){const e=prompt("请输入新主题的名称:");e&&this.store.addTopic(e)}handleListClick(e){const t=this.store.getState(),n=e.target.closest(".topic-item");if(!n)return;if(n.classList.contains("add-topic-btn")){this.handleAddTopicClick();return}const s=n.dataset.topicId;t.isTopicSelectionMode?this.store.toggleTopicSelection(s):this.store.selectTopic(s)}render(e){this.dom.panel.classList.toggle("collapsed",e.isTopicsPanelHidden);const t=[...new Set(e.agents.flatMap(a=>a.tags||[]))];this.dom.filter.innerHTML='<option value="all">所有主题</option>',t.forEach(a=>{const l=document.createElement("option");l.value=a,l.textContent=a,this.dom.filter.appendChild(l)}),this.dom.filter.value=e.topicListFilterTag,this.dom.list.innerHTML="";const n=this.store.getFilteredTopics();n.forEach(a=>this.dom.list.appendChild(this.createTopicItem(a,e)));const s=document.createElement("li");if(s.className="topic-item add-topic-btn",s.innerHTML='<div class="topic-item-content"><div class="topic-icon"><i class="fas fa-plus"></i></div><span>添加新主题</span></div>',this.dom.list.appendChild(s),this.dom.batchActions.style.display=e.isTopicSelectionMode?"flex":"none",e.isTopicSelectionMode){const a=e.selectedTopicIds.size;this.dom.deleteSelectedBtn.textContent=`删除选中 (${a})`,this.dom.deleteSelectedBtn.disabled=a===0;const l=n.map(u=>u.id);this.dom.selectAllBtn.textContent=l.length>0&&a===l.length?"全不选":"全选"}}createTopicItem(e,t){const n=document.createElement("li");n.className=`topic-item ${e.id===t.currentTopicId?"active":""}`,n.dataset.topicId=e.id;const s=t.isTopicSelectionMode?`<input type="checkbox" class="topic-selection-checkbox" ${t.selectedTopicIds.has(e.id)?"checked":""}>`:"";return n.innerHTML=`
            ${s}
            <div class="topic-item-content">
                <div class="topic-icon"><i class="${ce(e.icon||"fas fa-comment")}"></i></div>
                <span>${ce(e.title)}</span>
            </div>
        `,n}}function Wl(i,e){let t;return function(){const n=arguments,s=this;t||(i.apply(s,n),t=!0,setTimeout(()=>t=!1,e))}}class Ql{constructor(e){this.store=e,this.dom={content:document.getElementById("agent_historyContent"),chatInputArea:document.getElementById("agent_chatInputArea"),chatNavUp:document.getElementById("agent_chatNavUp"),chatNavDown:document.getElementById("agent_chatNavDown")},this.turnElements=[],this.currentTurnIndex=-1,this.streamingMessages=new Map,this.throttledRenderStream=Wl(this.renderStreamingMessage,150),this.store.subscribe(this.render.bind(this),["history","currentTopicId","isAiThinking"]),this.handleStreamChunk=this.handleStreamChunk.bind(this),this.setupEventListeners()}setupEventListeners(){this.dom.content.addEventListener("mouseup",this.handleSelection.bind(this)),this.dom.content.addEventListener("click",e=>this.handleActionClick(e)),this.dom.chatNavUp.addEventListener("click",()=>this.navigateTurns(-1)),this.dom.chatNavDown.addEventListener("click",()=>this.navigateTurns(1)),this.store.streamEmitter.on("chunk",this.handleStreamChunk)}destroy(){this.store.streamEmitter.off("chunk",this.handleStreamChunk)}handleStreamChunk({messageId:e,type:t,text:n}){this.streamingMessages.has(e)||this.streamingMessages.set(e,{content:"",reasoning:""});const s=this.streamingMessages.get(e);t==="content"?s.content+=n:t==="thinking"&&(s.reasoning+=n),this.throttledRenderStream(e)}async renderStreamingMessage(e){const t=this.dom.content.querySelector(`[data-message-id="${e}"]`),n=this.streamingMessages.get(e);if(!t||!n)return;const s=t.querySelector(".history-item-content");if(!s)return;const a=this.dom.content.scrollHeight-this.dom.content.clientHeight<=this.dom.content.scrollTop+10;if(await Cn.render(s,n.content,{}),!s.querySelector(".streaming-cursor")){const l=document.createElement("span");l.className="streaming-cursor",s.appendChild(l)}a&&(this.dom.content.scrollTop=this.dom.content.scrollHeight)}handleActionClick(e){var a;if(this.store.getState().isAiThinking){alert("AI 正在思考中，请稍后再试。");return}const t=e.target.closest(".history-action-btn");if(!t)return;const s=t.closest(".history-item").dataset.messageId;if(t.classList.contains("delete-btn"))confirm("确定要删除这组对话吗？")&&this.store.deleteMessagePair(s);else if(t.classList.contains("edit-btn")){const l=((a=this.store.getState().history.find(h=>h.id===s))==null?void 0:a.content)||"",u=prompt("编辑你的消息:",l);u&&u.trim()!==l&&confirm("编辑将删除此后的对话并重新生成回应，是否继续？")&&this.store.editUserMessage(s,u.trim())}else t.classList.contains("regenerate-btn")&&confirm("确定要重新生成这条回应吗？")&&this.store.regenerateAssistantResponse(s)}async render(e,t={}){var a;if(this.dom.content.innerHTML="",!e.currentTopicId){this.dom.content.innerHTML='<div class="no-history"><p>请选择或创建一个主题来开始聊天</p></div>',this.dom.chatInputArea.style.display="none";return}this.dom.chatInputArea.style.display="flex";const n=e.history.filter(l=>l.topicId===e.currentTopicId).sort((l,u)=>new Date(l.timestamp)-new Date(u.timestamp));if(n.length===0){this.dom.content.innerHTML='<div class="no-history"><p>这个主题还没有对话记录。</p></div>',this.updateNavState();return}const s=this.dom.content.scrollHeight-this.dom.content.clientHeight<=this.dom.content.scrollTop+5;await this.updateMessageList(n),this.updateNavState(),e.history.length>(((a=t.history)==null?void 0:a.length)||0)||s?setTimeout(()=>this.dom.content.scrollTop=this.dom.content.scrollHeight,50):e.currentTopicId!==t.currentTopicId&&(this.dom.content.scrollTop=e.topicScrollPositions[e.currentTopicId]||0,this.currentTurnIndex=-1)}async updateMessageList(e){for(const t of e){const n=document.createElement("div");n.dataset.messageId=t.id,await this.renderMessageItem(n,t),this.dom.content.appendChild(n)}}async renderMessageItem(e,t){e.className=`history-item role-${t.role}`,e.innerHTML=`
            <div class="history-item-header">
                <span class="role ${t.role}">${t.role==="user"?"用户":"AI助手"}</span>
                <span>${new Date(t.timestamp).toLocaleString()}</span>
            </div>
            <div class="history-item-content"></div>
            <div class="history-item-actions">
                <button class="history-action-btn regenerate-btn" title="重新生成" style="display: ${t.role==="assistant"?"inline-flex":"none"};"><i class="fas fa-redo"></i></button>
                <button class="history-action-btn edit-btn" title="编辑并重新生成" style="display: ${t.role==="user"?"inline-flex":"none"};"><i class="fas fa-edit"></i></button>
                <button class="history-action-btn delete-btn" title="删除"><i class="fas fa-trash"></i></button>
            </div>
        `,e.dataset.lastStatus=t.status;const n=e.querySelector(".history-item-content");if(t.status==="streaming")n.innerHTML='<p class="streaming-initial-loader"><i class="fas fa-spinner fa-pulse"></i></p>';else{this.streamingMessages.has(t.id)&&this.streamingMessages.delete(t.id);let s=t.content||"";t.role==="assistant"&&t.reasoning&&(s=`<details class="thinking-block"><summary>AI 思考过程</summary><pre><code>${ce(t.reasoning)}</code></pre></details>`+s),await Cn.render(n,s,{})}}async updateMessageContent(e,t){if(t.status==="streaming")e.hasChildNodes()||(e.innerHTML=`
                    <div class="streaming-content-container">
                        <p><i class="fas fa-spinner fa-pulse"></i></p>
                        <div class="streaming-content-body"></div>
                    </div>`);else{let n=t.content||"";t.role==="assistant"&&t.reasoning&&(n=`<details class="thinking-block"><summary>AI 思考过程</summary><pre><code>${ce(t.reasoning)}</code></pre></details>`+n),await Cn.render(e,n,{})}}getContentHash(e){const t=`${e.content||""}${e.reasoning||""}`;return t.length+"_"+(t.slice(0,50)+t.slice(-50))}updateNavState(){this.turnElements=Array.from(this.dom.content.querySelectorAll(".history-item.role-user"));const e=this.turnElements.length>0;this.dom.chatNavUp.disabled=!e,this.dom.chatNavDown.disabled=!e,e||(this.currentTurnIndex=-1)}navigateTurns(e){if(this.turnElements.length===0)return;this.dom.content.querySelectorAll(".highlighted").forEach(n=>n.classList.remove("highlighted")),this.currentTurnIndex===-1?this.currentTurnIndex=e===1?0:this.turnElements.length-1:this.currentTurnIndex=(this.currentTurnIndex+e+this.turnElements.length)%this.turnElements.length;const t=this.turnElements[this.currentTurnIndex];if(t){t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlighted");const n=t.nextElementSibling;n&&n.classList.contains("role-assistant")&&n.classList.add("highlighted")}}handleSelection(e){if(e.target.closest(".history-action-btn, a, button, summary"))return;const t=window.getSelection().toString();this.store.setPreviewSelection(t),t.trim()&&console.log("✅ [Agent HistoryPanel] Selection saved to store.")}destroy(){this.store.streamEmitter.off("chunk",this.handleStreamChunk)}}class Xl{constructor(e){this.store=e,this.dom={input:document.getElementById("agent_chatInput"),sendBtn:document.getElementById("agent_sendMessageBtn"),attachFileBtn:document.getElementById("agent_attachFileBtn"),attachmentInput:document.getElementById("agent_attachmentInput"),attachmentPreviewContainer:document.getElementById("agent_attachmentPreview")},this.attachments=[],this.store.subscribe(this.render.bind(this),["isAiThinking"]),this.setupEventListeners()}setupEventListeners(){this.dom.sendBtn.addEventListener("click",()=>this.sendMessage()),this.dom.input.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}),this.dom.input.addEventListener("input",()=>{this.updateSendButtonState()}),this.dom.input.addEventListener("mouseup",()=>this.updateSelection()),this.dom.input.addEventListener("keyup",()=>this.updateSelection()),this.dom.attachFileBtn.addEventListener("click",()=>this.dom.attachmentInput.click()),this.dom.attachmentInput.addEventListener("change",e=>this.handleAttachmentChange(e)),this.dom.attachmentPreviewContainer.addEventListener("click",e=>this.handleRemoveAttachment(e))}updateSelection(){const e=this.dom.input.selectionStart,t=this.dom.input.selectionEnd,n=this.dom.input.value.substring(e,t),s=e!==t&&n.trim().length>0;this.store.setState({editorSelection:{start:e,end:t,text:s?n.trim():"",hasSelection:s,timestamp:Date.now()}}),s&&console.log("✅ [Agent ChatInput] Selection saved to store.")}updateSendButtonState(){const t=this.store.getState().isAiThinking,n=this.dom.input.value.trim()!==""||this.attachments.length>0;this.dom.sendBtn.disabled=t||!n}sendMessage(){const e=this.dom.input.value.trim();!e&&this.attachments.length===0||this.store.getState().isAiThinking||(this.store.sendMessage(e,[...this.attachments]),this.dom.input.value="",this.attachments=[],this.renderAttachments(),this.dom.input.focus())}handleAttachmentChange(e){this.attachments=[];const t=Array.from(e.target.files);t.length!==0&&(t.forEach(n=>{const s=new FileReader;s.onload=a=>{this.attachments.push({name:n.name,data:a.target.result}),this.renderAttachments()},s.readAsDataURL(n)}),e.target.value="")}handleRemoveAttachment(e){const t=e.target.closest(".remove-attachment-btn");if(!t)return;const n=parseInt(t.dataset.index,10);this.attachments.splice(n,1),this.renderAttachments()}renderAttachments(){this.dom.attachmentPreviewContainer.innerHTML="",this.attachments.forEach((e,t)=>{const n=document.createElement("div");n.className="attachment-preview-item";const s=e.data.startsWith("data:image/")?"fa-file-image":"fa-file";n.innerHTML=`<span><i class="fas ${s}"></i> ${ce(e.name)}</span><button class="remove-attachment-btn" data-index="${t}" title="移除">×</button>`,this.dom.attachmentPreviewContainer.appendChild(n)})}render(e){this.updateSendButtonState(),this.dom.input.disabled=e.isAiThinking,this.dom.sendBtn.innerHTML=e.isAiThinking?'<i class="fas fa-spinner fa-spin"></i>':'<i class="fas fa-paper-plane"></i>'}}class Zl{constructor(){this.store=Ri,this.components=[]}async initialize(e){console.log("Initializing AI Agent module with new architecture..."),await this.store.initialize(e),this.components=[new Gl(this.store),new Jl(this.store),new Ql(this.store),new Xl(this.store)];const t=this.store.getState();this.store.notify({},t),console.log("AgentApp initialized successfully.")}destroy(){this.components.forEach(e=>{typeof e.destroy=="function"&&e.destroy()}),this.components=[],console.log("AgentApp destroyed and listeners cleaned up.")}}const Qi=new Zl,Xi=Symbol.for("yaml.alias"),ji=Symbol.for("yaml.document"),lt=Symbol.for("yaml.map"),ka=Symbol.for("yaml.pair"),Ue=Symbol.for("yaml.scalar"),nn=Symbol.for("yaml.seq"),$e=Symbol.for("yaml.node.type"),ft=i=>!!i&&typeof i=="object"&&i[$e]===Xi,Ot=i=>!!i&&typeof i=="object"&&i[$e]===ji,sn=i=>!!i&&typeof i=="object"&&i[$e]===lt,ge=i=>!!i&&typeof i=="object"&&i[$e]===ka,fe=i=>!!i&&typeof i=="object"&&i[$e]===Ue,rn=i=>!!i&&typeof i=="object"&&i[$e]===nn;function ye(i){if(i&&typeof i=="object")switch(i[$e]){case lt:case nn:return!0}return!1}function ve(i){if(i&&typeof i=="object")switch(i[$e]){case Xi:case lt:case Ue:case nn:return!0}return!1}const Sa=i=>(fe(i)||ye(i))&&!!i.anchor,Be=Symbol("break visit"),Ta=Symbol("skip children"),He=Symbol("remove node");function Mt(i,e){const t=Ia(e);Ot(i)?Ut(null,i.contents,t,Object.freeze([i]))===He&&(i.contents=null):Ut(null,i,t,Object.freeze([]))}Mt.BREAK=Be;Mt.SKIP=Ta;Mt.REMOVE=He;function Ut(i,e,t,n){const s=_a(i,e,t,n);if(ve(s)||ge(s))return Ca(i,n,s),Ut(i,s,t,n);if(typeof s!="symbol"){if(ye(e)){n=Object.freeze(n.concat(e));for(let a=0;a<e.items.length;++a){const l=Ut(a,e.items[a],t,n);if(typeof l=="number")a=l-1;else{if(l===Be)return Be;l===He&&(e.items.splice(a,1),a-=1)}}}else if(ge(e)){n=Object.freeze(n.concat(e));const a=Ut("key",e.key,t,n);if(a===Be)return Be;a===He&&(e.key=null);const l=Ut("value",e.value,t,n);if(l===Be)return Be;l===He&&(e.value=null)}}return s}async function Cs(i,e){const t=Ia(e);Ot(i)?await Vt(null,i.contents,t,Object.freeze([i]))===He&&(i.contents=null):await Vt(null,i,t,Object.freeze([]))}Cs.BREAK=Be;Cs.SKIP=Ta;Cs.REMOVE=He;async function Vt(i,e,t,n){const s=await _a(i,e,t,n);if(ve(s)||ge(s))return Ca(i,n,s),Vt(i,s,t,n);if(typeof s!="symbol"){if(ye(e)){n=Object.freeze(n.concat(e));for(let a=0;a<e.items.length;++a){const l=await Vt(a,e.items[a],t,n);if(typeof l=="number")a=l-1;else{if(l===Be)return Be;l===He&&(e.items.splice(a,1),a-=1)}}}else if(ge(e)){n=Object.freeze(n.concat(e));const a=await Vt("key",e.key,t,n);if(a===Be)return Be;a===He&&(e.key=null);const l=await Vt("value",e.value,t,n);if(l===Be)return Be;l===He&&(e.value=null)}}return s}function Ia(i){return typeof i=="object"&&(i.Collection||i.Node||i.Value)?Object.assign({Alias:i.Node,Map:i.Node,Scalar:i.Node,Seq:i.Node},i.Value&&{Map:i.Value,Scalar:i.Value,Seq:i.Value},i.Collection&&{Map:i.Collection,Seq:i.Collection},i):i}function _a(i,e,t,n){var s,a,l,u,h;if(typeof t=="function")return t(i,e,n);if(sn(e))return(s=t.Map)==null?void 0:s.call(t,i,e,n);if(rn(e))return(a=t.Seq)==null?void 0:a.call(t,i,e,n);if(ge(e))return(l=t.Pair)==null?void 0:l.call(t,i,e,n);if(fe(e))return(u=t.Scalar)==null?void 0:u.call(t,i,e,n);if(ft(e))return(h=t.Alias)==null?void 0:h.call(t,i,e,n)}function Ca(i,e,t){const n=e[e.length-1];if(ye(n))n.items[i]=t;else if(ge(n))i==="key"?n.key=t:n.value=t;else if(Ot(n))n.contents=t;else{const s=ft(n)?"alias":"scalar";throw new Error(`Cannot replace node with ${s} parent`)}}const ec={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},tc=i=>i.replace(/[!,[\]{}]/g,e=>ec[e]);class Le{constructor(e,t){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Le.defaultYaml,e),this.tags=Object.assign({},Le.defaultTags,t)}clone(){const e=new Le(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){const e=new Le(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Le.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Le.defaultTags);break}return e}add(e,t){this.atNextDocument&&(this.yaml={explicit:Le.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Le.defaultTags),this.atNextDocument=!1);const n=e.trim().split(/[ \t]+/),s=n.shift();switch(s){case"%TAG":{if(n.length!==2&&(t(0,"%TAG directive should contain exactly two parts"),n.length<2))return!1;const[a,l]=n;return this.tags[a]=l,!0}case"%YAML":{if(this.yaml.explicit=!0,n.length!==1)return t(0,"%YAML directive should contain exactly one part"),!1;const[a]=n;if(a==="1.1"||a==="1.2")return this.yaml.version=a,!0;{const l=/^\d+\.\d+$/.test(a);return t(6,`Unsupported YAML version ${a}`,l),!1}}default:return t(0,`Unknown directive ${s}`,!0),!1}}tagName(e,t){if(e==="!")return"!";if(e[0]!=="!")return t(`Not a valid tag: ${e}`),null;if(e[1]==="<"){const l=e.slice(2,-1);return l==="!"||l==="!!"?(t(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(e[e.length-1]!==">"&&t("Verbatim tags must end with a >"),l)}const[,n,s]=e.match(/^(.*!)([^!]*)$/s);s||t(`The ${e} tag has no suffix`);const a=this.tags[n];if(a)try{return a+decodeURIComponent(s)}catch(l){return t(String(l)),null}return n==="!"?e:(t(`Could not resolve tag: ${e}`),null)}tagString(e){for(const[t,n]of Object.entries(this.tags))if(e.startsWith(n))return t+tc(e.substring(n.length));return e[0]==="!"?e:`!<${e}>`}toString(e){const t=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],n=Object.entries(this.tags);let s;if(e&&n.length>0&&ve(e.contents)){const a={};Mt(e.contents,(l,u)=>{ve(u)&&u.tag&&(a[u.tag]=!0)}),s=Object.keys(a)}else s=[];for(const[a,l]of n)a==="!!"&&l==="tag:yaml.org,2002:"||(!e||s.some(u=>u.startsWith(l)))&&t.push(`%TAG ${a} ${l}`);return t.join(`
`)}}Le.defaultYaml={explicit:!1,version:"1.2"};Le.defaultTags={"!!":"tag:yaml.org,2002:"};function Ea(i){if(/[\x00-\x19\s,[\]{}]/.test(i)){const t=`Anchor must not contain whitespace or control characters: ${JSON.stringify(i)}`;throw new Error(t)}return!0}function Aa(i){const e=new Set;return Mt(i,{Value(t,n){n.anchor&&e.add(n.anchor)}}),e}function La(i,e){for(let t=1;;++t){const n=`${i}${t}`;if(!e.has(n))return n}}function nc(i,e){const t=[],n=new Map;let s=null;return{onAnchor:a=>{t.push(a),s??(s=Aa(i));const l=La(e,s);return s.add(l),l},setAnchors:()=>{for(const a of t){const l=n.get(a);if(typeof l=="object"&&l.anchor&&(fe(l.node)||ye(l.node)))l.node.anchor=l.anchor;else{const u=new Error("Failed to resolve repeated object (this should not happen)");throw u.source=a,u}}},sourceObjects:n}}function Yt(i,e,t,n){if(n&&typeof n=="object")if(Array.isArray(n))for(let s=0,a=n.length;s<a;++s){const l=n[s],u=Yt(i,n,String(s),l);u===void 0?delete n[s]:u!==l&&(n[s]=u)}else if(n instanceof Map)for(const s of Array.from(n.keys())){const a=n.get(s),l=Yt(i,n,s,a);l===void 0?n.delete(s):l!==a&&n.set(s,l)}else if(n instanceof Set)for(const s of Array.from(n)){const a=Yt(i,n,s,s);a===void 0?n.delete(s):a!==s&&(n.delete(s),n.add(a))}else for(const[s,a]of Object.entries(n)){const l=Yt(i,n,s,a);l===void 0?delete n[s]:l!==a&&(n[s]=l)}return i.call(e,t,n)}function Ne(i,e,t){if(Array.isArray(i))return i.map((n,s)=>Ne(n,String(s),t));if(i&&typeof i.toJSON=="function"){if(!t||!Sa(i))return i.toJSON(e,t);const n={aliasCount:0,count:1,res:void 0};t.anchors.set(i,n),t.onCreate=a=>{n.res=a,delete t.onCreate};const s=i.toJSON(e,t);return t.onCreate&&t.onCreate(s),s}return typeof i=="bigint"&&!(t!=null&&t.keep)?Number(i):i}class Zi{constructor(e){Object.defineProperty(this,$e,{value:e})}clone(){const e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:t,maxAliasCount:n,onAnchor:s,reviver:a}={}){if(!Ot(e))throw new TypeError("A document argument is required");const l={anchors:new Map,doc:e,keep:!0,mapAsMap:t===!0,mapKeyWarned:!1,maxAliasCount:typeof n=="number"?n:100},u=Ne(this,"",l);if(typeof s=="function")for(const{count:h,res:m}of l.anchors.values())s(m,h);return typeof a=="function"?Yt(a,{"":u},"",u):u}}class Es extends Zi{constructor(e){super(Xi),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e,t){let n;t!=null&&t.aliasResolveCache?n=t.aliasResolveCache:(n=[],Mt(e,{Node:(a,l)=>{(ft(l)||Sa(l))&&n.push(l)}}),t&&(t.aliasResolveCache=n));let s;for(const a of n){if(a===this)break;a.anchor===this.source&&(s=a)}return s}toJSON(e,t){if(!t)return{source:this.source};const{anchors:n,doc:s,maxAliasCount:a}=t,l=this.resolve(s,t);if(!l){const h=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(h)}let u=n.get(l);if(u||(Ne(l,null,t),u=n.get(l)),!u||u.res===void 0){const h="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(h)}if(a>=0&&(u.count+=1,u.aliasCount===0&&(u.aliasCount=gs(s,l,n)),u.count*u.aliasCount>a)){const h="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(h)}return u.res}toString(e,t,n){const s=`*${this.source}`;if(e){if(Ea(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){const a=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(a)}if(e.implicitKey)return`${s} `}return s}}function gs(i,e,t){if(ft(e)){const n=e.resolve(i),s=t&&n&&t.get(n);return s?s.count*s.aliasCount:0}else if(ye(e)){let n=0;for(const s of e.items){const a=gs(i,s,t);a>n&&(n=a)}return n}else if(ge(e)){const n=gs(i,e.key,t),s=gs(i,e.value,t);return Math.max(n,s)}return 1}const Ba=i=>!i||typeof i!="function"&&typeof i!="object";class ne extends Zi{constructor(e){super(Ue),this.value=e}toJSON(e,t){return t!=null&&t.keep?this.value:Ne(this.value,e,t)}toString(){return String(this.value)}}ne.BLOCK_FOLDED="BLOCK_FOLDED";ne.BLOCK_LITERAL="BLOCK_LITERAL";ne.PLAIN="PLAIN";ne.QUOTE_DOUBLE="QUOTE_DOUBLE";ne.QUOTE_SINGLE="QUOTE_SINGLE";const sc="tag:yaml.org,2002:";function ic(i,e,t){if(e){const n=t.filter(a=>a.tag===e),s=n.find(a=>!a.format)??n[0];if(!s)throw new Error(`Tag ${e} not found`);return s}return t.find(n=>{var s;return((s=n.identify)==null?void 0:s.call(n,i))&&!n.format})}function Ln(i,e,t){var v,k,B;if(Ot(i)&&(i=i.contents),ve(i))return i;if(ge(i)){const F=(k=(v=t.schema[lt]).createNode)==null?void 0:k.call(v,t.schema,null,t);return F.items.push(i),F}(i instanceof String||i instanceof Number||i instanceof Boolean||typeof BigInt<"u"&&i instanceof BigInt)&&(i=i.valueOf());const{aliasDuplicateObjects:n,onAnchor:s,onTagObj:a,schema:l,sourceObjects:u}=t;let h;if(n&&i&&typeof i=="object"){if(h=u.get(i),h)return h.anchor??(h.anchor=s(i)),new Es(h.anchor);h={anchor:null,node:null},u.set(i,h)}e!=null&&e.startsWith("!!")&&(e=sc+e.slice(2));let m=ic(i,e,l.tags);if(!m){if(i&&typeof i.toJSON=="function"&&(i=i.toJSON()),!i||typeof i!="object"){const F=new ne(i);return h&&(h.node=F),F}m=i instanceof Map?l[lt]:Symbol.iterator in Object(i)?l[nn]:l[lt]}a&&(a(m),delete t.onTagObj);const w=m!=null&&m.createNode?m.createNode(t.schema,i,t):typeof((B=m==null?void 0:m.nodeClass)==null?void 0:B.from)=="function"?m.nodeClass.from(t.schema,i,t):new ne(i);return e?w.tag=e:m.default||(w.tag=m.tag),h&&(h.node=w),w}function Ss(i,e,t){let n=t;for(let s=e.length-1;s>=0;--s){const a=e[s];if(typeof a=="number"&&Number.isInteger(a)&&a>=0){const l=[];l[a]=n,n=l}else n=new Map([[a,n]])}return Ln(n,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:i,sourceObjects:new Map})}const In=i=>i==null||typeof i=="object"&&!!i[Symbol.iterator]().next().done;class Oa extends Zi{constructor(e,t){super(e),Object.defineProperty(this,"schema",{value:t,configurable:!0,enumerable:!1,writable:!0})}clone(e){const t=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(t.schema=e),t.items=t.items.map(n=>ve(n)||ge(n)?n.clone(e):n),this.range&&(t.range=this.range.slice()),t}addIn(e,t){if(In(e))this.add(t);else{const[n,...s]=e,a=this.get(n,!0);if(ye(a))a.addIn(s,t);else if(a===void 0&&this.schema)this.set(n,Ss(this.schema,s,t));else throw new Error(`Expected YAML collection at ${n}. Remaining path: ${s}`)}}deleteIn(e){const[t,...n]=e;if(n.length===0)return this.delete(t);const s=this.get(t,!0);if(ye(s))return s.deleteIn(n);throw new Error(`Expected YAML collection at ${t}. Remaining path: ${n}`)}getIn(e,t){const[n,...s]=e,a=this.get(n,!0);return s.length===0?!t&&fe(a)?a.value:a:ye(a)?a.getIn(s,t):void 0}hasAllNullValues(e){return this.items.every(t=>{if(!ge(t))return!1;const n=t.value;return n==null||e&&fe(n)&&n.value==null&&!n.commentBefore&&!n.comment&&!n.tag})}hasIn(e){const[t,...n]=e;if(n.length===0)return this.has(t);const s=this.get(t,!0);return ye(s)?s.hasIn(n):!1}setIn(e,t){const[n,...s]=e;if(s.length===0)this.set(n,t);else{const a=this.get(n,!0);if(ye(a))a.setIn(s,t);else if(a===void 0&&this.schema)this.set(n,Ss(this.schema,s,t));else throw new Error(`Expected YAML collection at ${n}. Remaining path: ${s}`)}}}const rc=i=>i.replace(/^(?!$)(?: $)?/gm,"#");function Qe(i,e){return/^\n+$/.test(i)?i.substring(1):e?i.replace(/^(?! *$)/gm,e):i}const Et=(i,e,t)=>i.endsWith(`
`)?Qe(t,e):t.includes(`
`)?`
`+Qe(t,e):(i.endsWith(" ")?"":" ")+t,Ma="flow",qi="block",ys="quoted";function As(i,e,t="flow",{indentAtStart:n,lineWidth:s=80,minContentWidth:a=20,onFold:l,onOverflow:u}={}){if(!s||s<0)return i;s<a&&(a=0);const h=Math.max(1+a,1+s-e.length);if(i.length<=h)return i;const m=[],w={};let v=s-e.length;typeof n=="number"&&(n>s-Math.max(2,a)?m.push(0):v=s-n);let k,B,F=!1,O=-1,N=-1,V=-1;t===qi&&(O=ra(i,O,e.length),O!==-1&&(v=O+h));for(let Q;Q=i[O+=1];){if(t===ys&&Q==="\\"){switch(N=O,i[O+1]){case"x":O+=3;break;case"u":O+=5;break;case"U":O+=9;break;default:O+=1}V=O}if(Q===`
`)t===qi&&(O=ra(i,O,e.length)),v=O+e.length+h,k=void 0;else{if(Q===" "&&B&&B!==" "&&B!==`
`&&B!=="	"){const W=i[O+1];W&&W!==" "&&W!==`
`&&W!=="	"&&(k=O)}if(O>=v)if(k)m.push(k),v=k+h,k=void 0;else if(t===ys){for(;B===" "||B==="	";)B=Q,Q=i[O+=1],F=!0;const W=O>V+1?O-2:N-1;if(w[W])return i;m.push(W),w[W]=!0,v=W+h,k=void 0}else F=!0}B=Q}if(F&&u&&u(),m.length===0)return i;l&&l();let G=i.slice(0,m[0]);for(let Q=0;Q<m.length;++Q){const W=m[Q],ee=m[Q+1]||i.length;W===0?G=`
${e}${i.slice(0,ee)}`:(t===ys&&w[W]&&(G+=`${i[W]}\\`),G+=`
${e}${i.slice(W+1,ee)}`)}return G}function ra(i,e,t){let n=e,s=e+1,a=i[s];for(;a===" "||a==="	";)if(e<s+t)a=i[++e];else{do a=i[++e];while(a&&a!==`
`);n=e,s=e+1,a=i[s]}return n}const Ls=(i,e)=>({indentAtStart:e?i.indent.length:i.indentAtStart,lineWidth:i.options.lineWidth,minContentWidth:i.options.minContentWidth}),Bs=i=>/^(%|---|\.\.\.)/m.test(i);function ac(i,e,t){if(!e||e<0)return!1;const n=e-t,s=i.length;if(s<=n)return!1;for(let a=0,l=0;a<s;++a)if(i[a]===`
`){if(a-l>n)return!0;if(l=a+1,s-l<=n)return!1}return!0}function En(i,e){const t=JSON.stringify(i);if(e.options.doubleQuotedAsJSON)return t;const{implicitKey:n}=e,s=e.options.doubleQuotedMinMultiLineLength,a=e.indent||(Bs(i)?"  ":"");let l="",u=0;for(let h=0,m=t[h];m;m=t[++h])if(m===" "&&t[h+1]==="\\"&&t[h+2]==="n"&&(l+=t.slice(u,h)+"\\ ",h+=1,u=h,m="\\"),m==="\\")switch(t[h+1]){case"u":{l+=t.slice(u,h);const w=t.substr(h+2,4);switch(w){case"0000":l+="\\0";break;case"0007":l+="\\a";break;case"000b":l+="\\v";break;case"001b":l+="\\e";break;case"0085":l+="\\N";break;case"00a0":l+="\\_";break;case"2028":l+="\\L";break;case"2029":l+="\\P";break;default:w.substr(0,2)==="00"?l+="\\x"+w.substr(2):l+=t.substr(h,6)}h+=5,u=h+1}break;case"n":if(n||t[h+2]==='"'||t.length<s)h+=1;else{for(l+=t.slice(u,h)+`

`;t[h+2]==="\\"&&t[h+3]==="n"&&t[h+4]!=='"';)l+=`
`,h+=2;l+=a,t[h+2]===" "&&(l+="\\"),h+=1,u=h+1}break;default:h+=1}return l=u?l+t.slice(u):t,n?l:As(l,a,ys,Ls(e,!1))}function zi(i,e){if(e.options.singleQuote===!1||e.implicitKey&&i.includes(`
`)||/[ \t]\n|\n[ \t]/.test(i))return En(i,e);const t=e.indent||(Bs(i)?"  ":""),n="'"+i.replace(/'/g,"''").replace(/\n+/g,`$&
${t}`)+"'";return e.implicitKey?n:As(n,t,Ma,Ls(e,!1))}function Gt(i,e){const{singleQuote:t}=e.options;let n;if(t===!1)n=En;else{const s=i.includes('"'),a=i.includes("'");s&&!a?n=zi:a&&!s?n=En:n=t?zi:En}return n(i,e)}let Hi;try{Hi=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{Hi=/\n+(?!\n|$)/g}function vs({comment:i,type:e,value:t},n,s,a){const{blockQuote:l,commentString:u,lineWidth:h}=n.options;if(!l||/\n[\t ]+$/.test(t)||/^\s*$/.test(t))return Gt(t,n);const m=n.indent||(n.forceBlockIndent||Bs(t)?"  ":""),w=l==="literal"?!0:l==="folded"||e===ne.BLOCK_FOLDED?!1:e===ne.BLOCK_LITERAL?!0:!ac(t,h,m.length);if(!t)return w?`|
`:`>
`;let v,k;for(k=t.length;k>0;--k){const ee=t[k-1];if(ee!==`
`&&ee!=="	"&&ee!==" ")break}let B=t.substring(k);const F=B.indexOf(`
`);F===-1?v="-":t===B||F!==B.length-1?(v="+",a&&a()):v="",B&&(t=t.slice(0,-B.length),B[B.length-1]===`
`&&(B=B.slice(0,-1)),B=B.replace(Hi,`$&${m}`));let O=!1,N,V=-1;for(N=0;N<t.length;++N){const ee=t[N];if(ee===" ")O=!0;else if(ee===`
`)V=N;else break}let G=t.substring(0,V<N?V+1:N);G&&(t=t.substring(G.length),G=G.replace(/\n+/g,`$&${m}`));let W=(O?m?"2":"1":"")+v;if(i&&(W+=" "+u(i.replace(/ ?[\r\n]+/g," ")),s&&s()),!w){const ee=t.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${m}`);let Z=!1;const re=Ls(n,!0);l!=="folded"&&e!==ne.BLOCK_FOLDED&&(re.onOverflow=()=>{Z=!0});const J=As(`${G}${ee}${B}`,m,qi,re);if(!Z)return`>${W}
${m}${J}`}return t=t.replace(/\n+/g,`$&${m}`),`|${W}
${m}${G}${t}${B}`}function oc(i,e,t,n){const{type:s,value:a}=i,{actualString:l,implicitKey:u,indent:h,indentStep:m,inFlow:w}=e;if(u&&a.includes(`
`)||w&&/[[\]{},]/.test(a))return Gt(a,e);if(/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(a))return u||w||!a.includes(`
`)?Gt(a,e):vs(i,e,t,n);if(!u&&!w&&s!==ne.PLAIN&&a.includes(`
`))return vs(i,e,t,n);if(Bs(a)){if(h==="")return e.forceBlockIndent=!0,vs(i,e,t,n);if(u&&h===m)return Gt(a,e)}const v=a.replace(/\n+/g,`$&
${h}`);if(l){const k=O=>{var N;return O.default&&O.tag!=="tag:yaml.org,2002:str"&&((N=O.test)==null?void 0:N.test(v))},{compat:B,tags:F}=e.doc.schema;if(F.some(k)||B!=null&&B.some(k))return Gt(a,e)}return u?v:As(v,h,Ma,Ls(e,!1))}function Mn(i,e,t,n){const{implicitKey:s,inFlow:a}=e,l=typeof i.value=="string"?i:Object.assign({},i,{value:String(i.value)});let{type:u}=i;u!==ne.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(l.value)&&(u=ne.QUOTE_DOUBLE);const h=w=>{switch(w){case ne.BLOCK_FOLDED:case ne.BLOCK_LITERAL:return s||a?Gt(l.value,e):vs(l,e,t,n);case ne.QUOTE_DOUBLE:return En(l.value,e);case ne.QUOTE_SINGLE:return zi(l.value,e);case ne.PLAIN:return oc(l,e,t,n);default:return null}};let m=h(u);if(m===null){const{defaultKeyType:w,defaultStringType:v}=e.options,k=s&&w||v;if(m=h(k),m===null)throw new Error(`Unsupported default string type ${k}`)}return m}function xa(i,e){const t=Object.assign({blockQuote:!0,commentString:rc,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},i.schema.toStringOptions,e);let n;switch(t.collectionStyle){case"block":n=!1;break;case"flow":n=!0;break;default:n=null}return{anchors:new Set,doc:i,flowCollectionPadding:t.flowCollectionPadding?" ":"",indent:"",indentStep:typeof t.indent=="number"?" ".repeat(t.indent):"  ",inFlow:n,options:t}}function lc(i,e){var s;if(e.tag){const a=i.filter(l=>l.tag===e.tag);if(a.length>0)return a.find(l=>l.format===e.format)??a[0]}let t,n;if(fe(e)){n=e.value;let a=i.filter(l=>{var u;return(u=l.identify)==null?void 0:u.call(l,n)});if(a.length>1){const l=a.filter(u=>u.test);l.length>0&&(a=l)}t=a.find(l=>l.format===e.format)??a.find(l=>!l.format)}else n=e,t=i.find(a=>a.nodeClass&&n instanceof a.nodeClass);if(!t){const a=((s=n==null?void 0:n.constructor)==null?void 0:s.name)??(n===null?"null":typeof n);throw new Error(`Tag not resolved for ${a} value`)}return t}function cc(i,e,{anchors:t,doc:n}){if(!n.directives)return"";const s=[],a=(fe(i)||ye(i))&&i.anchor;a&&Ea(a)&&(t.add(a),s.push(`&${a}`));const l=i.tag??(e.default?null:e.tag);return l&&s.push(n.directives.tagString(l)),s.join(" ")}function Zt(i,e,t,n){var h;if(ge(i))return i.toString(e,t,n);if(ft(i)){if(e.doc.directives)return i.toString(e);if((h=e.resolvedAliases)!=null&&h.has(i))throw new TypeError("Cannot stringify circular structure without alias nodes");e.resolvedAliases?e.resolvedAliases.add(i):e.resolvedAliases=new Set([i]),i=i.resolve(e.doc)}let s;const a=ve(i)?i:e.doc.createNode(i,{onTagObj:m=>s=m});s??(s=lc(e.doc.schema.tags,a));const l=cc(a,s,e);l.length>0&&(e.indentAtStart=(e.indentAtStart??0)+l.length+1);const u=typeof s.stringify=="function"?s.stringify(a,e,t,n):fe(a)?Mn(a,e,t,n):a.toString(e,t,n);return l?fe(a)||u[0]==="{"||u[0]==="["?`${l} ${u}`:`${l}
${e.indent}${u}`:u}function uc({key:i,value:e},t,n,s){const{allNullValues:a,doc:l,indent:u,indentStep:h,options:{commentString:m,indentSeq:w,simpleKeys:v}}=t;let k=ve(i)&&i.comment||null;if(v){if(k)throw new Error("With simple keys, key nodes cannot have comments");if(ye(i)||!ve(i)&&typeof i=="object"){const re="With simple keys, collection cannot be used as a key value";throw new Error(re)}}let B=!v&&(!i||k&&e==null&&!t.inFlow||ye(i)||(fe(i)?i.type===ne.BLOCK_FOLDED||i.type===ne.BLOCK_LITERAL:typeof i=="object"));t=Object.assign({},t,{allNullValues:!1,implicitKey:!B&&(v||!a),indent:u+h});let F=!1,O=!1,N=Zt(i,t,()=>F=!0,()=>O=!0);if(!B&&!t.inFlow&&N.length>1024){if(v)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");B=!0}if(t.inFlow){if(a||e==null)return F&&n&&n(),N===""?"?":B?`? ${N}`:N}else if(a&&!v||e==null&&B)return N=`? ${N}`,k&&!F?N+=Et(N,t.indent,m(k)):O&&s&&s(),N;F&&(k=null),B?(k&&(N+=Et(N,t.indent,m(k))),N=`? ${N}
${u}:`):(N=`${N}:`,k&&(N+=Et(N,t.indent,m(k))));let V,G,Q;ve(e)?(V=!!e.spaceBefore,G=e.commentBefore,Q=e.comment):(V=!1,G=null,Q=null,e&&typeof e=="object"&&(e=l.createNode(e))),t.implicitKey=!1,!B&&!k&&fe(e)&&(t.indentAtStart=N.length+1),O=!1,!w&&h.length>=2&&!t.inFlow&&!B&&rn(e)&&!e.flow&&!e.tag&&!e.anchor&&(t.indent=t.indent.substring(2));let W=!1;const ee=Zt(e,t,()=>W=!0,()=>O=!0);let Z=" ";if(k||V||G){if(Z=V?`
`:"",G){const re=m(G);Z+=`
${Qe(re,t.indent)}`}ee===""&&!t.inFlow?Z===`
`&&(Z=`

`):Z+=`
${t.indent}`}else if(!B&&ye(e)){const re=ee[0],J=ee.indexOf(`
`),be=J!==-1,De=t.inFlow??e.flow??e.items.length===0;if(be||!De){let Ye=!1;if(be&&(re==="&"||re==="!")){let he=ee.indexOf(" ");re==="&"&&he!==-1&&he<J&&ee[he+1]==="!"&&(he=ee.indexOf(" ",he+1)),(he===-1||J<he)&&(Ye=!0)}Ye||(Z=`
${t.indent}`)}}else(ee===""||ee[0]===`
`)&&(Z="");return N+=Z+ee,t.inFlow?W&&n&&n():Q&&!W?N+=Et(N,t.indent,m(Q)):O&&s&&s(),N}function Pa(i,e){(i==="debug"||i==="warn")&&console.warn(e)}const us="<<",Xe={identify:i=>i===us||typeof i=="symbol"&&i.description===us,default:"key",tag:"tag:yaml.org,2002:merge",test:/^<<$/,resolve:()=>Object.assign(new ne(Symbol(us)),{addToJSMap:Na}),stringify:()=>us},dc=(i,e)=>(Xe.identify(e)||fe(e)&&(!e.type||e.type===ne.PLAIN)&&Xe.identify(e.value))&&(i==null?void 0:i.doc.schema.tags.some(t=>t.tag===Xe.tag&&t.default));function Na(i,e,t){if(t=i&&ft(t)?t.resolve(i.doc):t,rn(t))for(const n of t.items)Ai(i,e,n);else if(Array.isArray(t))for(const n of t)Ai(i,e,n);else Ai(i,e,t)}function Ai(i,e,t){const n=i&&ft(t)?t.resolve(i.doc):t;if(!sn(n))throw new Error("Merge sources must be maps or map aliases");const s=n.toJSON(null,i,Map);for(const[a,l]of s)e instanceof Map?e.has(a)||e.set(a,l):e instanceof Set?e.add(a):Object.prototype.hasOwnProperty.call(e,a)||Object.defineProperty(e,a,{value:l,writable:!0,enumerable:!0,configurable:!0});return e}function $a(i,e,{key:t,value:n}){if(ve(t)&&t.addToJSMap)t.addToJSMap(i,e,n);else if(dc(i,t))Na(i,e,n);else{const s=Ne(t,"",i);if(e instanceof Map)e.set(s,Ne(n,s,i));else if(e instanceof Set)e.add(s);else{const a=fc(t,s,i),l=Ne(n,a,i);a in e?Object.defineProperty(e,a,{value:l,writable:!0,enumerable:!0,configurable:!0}):e[a]=l}}return e}function fc(i,e,t){if(e===null)return"";if(typeof e!="object")return String(e);if(ve(i)&&(t!=null&&t.doc)){const n=xa(t.doc,{});n.anchors=new Set;for(const a of t.anchors.keys())n.anchors.add(a.anchor);n.inFlow=!0,n.inStringifyKey=!0;const s=i.toString(n);if(!t.mapKeyWarned){let a=JSON.stringify(s);a.length>40&&(a=a.substring(0,36)+'..."'),Pa(t.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${a}. Set mapAsMap: true to use object keys.`),t.mapKeyWarned=!0}return s}return JSON.stringify(e)}function er(i,e,t){const n=Ln(i,void 0,t),s=Ln(e,void 0,t);return new Ee(n,s)}class Ee{constructor(e,t=null){Object.defineProperty(this,$e,{value:ka}),this.key=e,this.value=t}clone(e){let{key:t,value:n}=this;return ve(t)&&(t=t.clone(e)),ve(n)&&(n=n.clone(e)),new Ee(t,n)}toJSON(e,t){const n=t!=null&&t.mapAsMap?new Map:{};return $a(t,n,this)}toString(e,t,n){return e!=null&&e.doc?uc(this,e,t,n):JSON.stringify(this)}}function Da(i,e,t){return(e.inFlow??i.flow?pc:hc)(i,e,t)}function hc({comment:i,items:e},t,{blockItemPrefix:n,flowChars:s,itemIndent:a,onChompKeep:l,onComment:u}){const{indent:h,options:{commentString:m}}=t,w=Object.assign({},t,{indent:a,type:null});let v=!1;const k=[];for(let F=0;F<e.length;++F){const O=e[F];let N=null;if(ve(O))!v&&O.spaceBefore&&k.push(""),Ts(t,k,O.commentBefore,v),O.comment&&(N=O.comment);else if(ge(O)){const G=ve(O.key)?O.key:null;G&&(!v&&G.spaceBefore&&k.push(""),Ts(t,k,G.commentBefore,v))}v=!1;let V=Zt(O,w,()=>N=null,()=>v=!0);N&&(V+=Et(V,a,m(N))),v&&N&&(v=!1),k.push(n+V)}let B;if(k.length===0)B=s.start+s.end;else{B=k[0];for(let F=1;F<k.length;++F){const O=k[F];B+=O?`
${h}${O}`:`
`}}return i?(B+=`
`+Qe(m(i),h),u&&u()):v&&l&&l(),B}function pc({items:i},e,{flowChars:t,itemIndent:n}){const{indent:s,indentStep:a,flowCollectionPadding:l,options:{commentString:u}}=e;n+=a;const h=Object.assign({},e,{indent:n,inFlow:!0,type:null});let m=!1,w=0;const v=[];for(let F=0;F<i.length;++F){const O=i[F];let N=null;if(ve(O))O.spaceBefore&&v.push(""),Ts(e,v,O.commentBefore,!1),O.comment&&(N=O.comment);else if(ge(O)){const G=ve(O.key)?O.key:null;G&&(G.spaceBefore&&v.push(""),Ts(e,v,G.commentBefore,!1),G.comment&&(m=!0));const Q=ve(O.value)?O.value:null;Q?(Q.comment&&(N=Q.comment),Q.commentBefore&&(m=!0)):O.value==null&&(G!=null&&G.comment)&&(N=G.comment)}N&&(m=!0);let V=Zt(O,h,()=>N=null);F<i.length-1&&(V+=","),N&&(V+=Et(V,n,u(N))),!m&&(v.length>w||V.includes(`
`))&&(m=!0),v.push(V),w=v.length}const{start:k,end:B}=t;if(v.length===0)return k+B;if(!m){const F=v.reduce((O,N)=>O+N.length+2,2);m=e.options.lineWidth>0&&F>e.options.lineWidth}if(m){let F=k;for(const O of v)F+=O?`
${a}${s}${O}`:`
`;return`${F}
${s}${B}`}else return`${k}${l}${v.join(" ")}${l}${B}`}function Ts({indent:i,options:{commentString:e}},t,n,s){if(n&&s&&(n=n.replace(/^\n+/,"")),n){const a=Qe(e(n),i);t.push(a.trimStart())}}function At(i,e){const t=fe(e)?e.value:e;for(const n of i)if(ge(n)&&(n.key===e||n.key===t||fe(n.key)&&n.key.value===t))return n}class xe extends Oa{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(lt,e),this.items=[]}static from(e,t,n){const{keepUndefined:s,replacer:a}=n,l=new this(e),u=(h,m)=>{if(typeof a=="function")m=a.call(t,h,m);else if(Array.isArray(a)&&!a.includes(h))return;(m!==void 0||s)&&l.items.push(er(h,m,n))};if(t instanceof Map)for(const[h,m]of t)u(h,m);else if(t&&typeof t=="object")for(const h of Object.keys(t))u(h,t[h]);return typeof e.sortMapEntries=="function"&&l.items.sort(e.sortMapEntries),l}add(e,t){var l;let n;ge(e)?n=e:!e||typeof e!="object"||!("key"in e)?n=new Ee(e,e==null?void 0:e.value):n=new Ee(e.key,e.value);const s=At(this.items,n.key),a=(l=this.schema)==null?void 0:l.sortMapEntries;if(s){if(!t)throw new Error(`Key ${n.key} already set`);fe(s.value)&&Ba(n.value)?s.value.value=n.value:s.value=n.value}else if(a){const u=this.items.findIndex(h=>a(n,h)<0);u===-1?this.items.push(n):this.items.splice(u,0,n)}else this.items.push(n)}delete(e){const t=At(this.items,e);return t?this.items.splice(this.items.indexOf(t),1).length>0:!1}get(e,t){const n=At(this.items,e),s=n==null?void 0:n.value;return(!t&&fe(s)?s.value:s)??void 0}has(e){return!!At(this.items,e)}set(e,t){this.add(new Ee(e,t),!0)}toJSON(e,t,n){const s=n?new n:t!=null&&t.mapAsMap?new Map:{};t!=null&&t.onCreate&&t.onCreate(s);for(const a of this.items)$a(t,s,a);return s}toString(e,t,n){if(!e)return JSON.stringify(this);for(const s of this.items)if(!ge(s))throw new Error(`Map items must all be pairs; found ${JSON.stringify(s)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),Da(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:n,onComment:t})}}const an={collection:"map",default:!0,nodeClass:xe,tag:"tag:yaml.org,2002:map",resolve(i,e){return sn(i)||e("Expected a mapping for this tag"),i},createNode:(i,e,t)=>xe.from(i,e,t)};class ut extends Oa{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(nn,e),this.items=[]}add(e){this.items.push(e)}delete(e){const t=ds(e);return typeof t!="number"?!1:this.items.splice(t,1).length>0}get(e,t){const n=ds(e);if(typeof n!="number")return;const s=this.items[n];return!t&&fe(s)?s.value:s}has(e){const t=ds(e);return typeof t=="number"&&t<this.items.length}set(e,t){const n=ds(e);if(typeof n!="number")throw new Error(`Expected a valid index, not ${e}.`);const s=this.items[n];fe(s)&&Ba(t)?s.value=t:this.items[n]=t}toJSON(e,t){const n=[];t!=null&&t.onCreate&&t.onCreate(n);let s=0;for(const a of this.items)n.push(Ne(a,String(s++),t));return n}toString(e,t,n){return e?Da(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:n,onComment:t}):JSON.stringify(this)}static from(e,t,n){const{replacer:s}=n,a=new this(e);if(t&&Symbol.iterator in Object(t)){let l=0;for(let u of t){if(typeof s=="function"){const h=t instanceof Set?u:String(l++);u=s.call(t,h,u)}a.items.push(Ln(u,void 0,n))}}return a}}function ds(i){let e=fe(i)?i.value:i;return e&&typeof e=="string"&&(e=Number(e)),typeof e=="number"&&Number.isInteger(e)&&e>=0?e:null}const on={collection:"seq",default:!0,nodeClass:ut,tag:"tag:yaml.org,2002:seq",resolve(i,e){return rn(i)||e("Expected a sequence for this tag"),i},createNode:(i,e,t)=>ut.from(i,e,t)},Os={identify:i=>typeof i=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:i=>i,stringify(i,e,t,n){return e=Object.assign({actualString:!0},e),Mn(i,e,t,n)}},Ms={identify:i=>i==null,createNode:()=>new ne(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new ne(null),stringify:({source:i},e)=>typeof i=="string"&&Ms.test.test(i)?i:e.options.nullStr},tr={identify:i=>typeof i=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:i=>new ne(i[0]==="t"||i[0]==="T"),stringify({source:i,value:e},t){if(i&&tr.test.test(i)){const n=i[0]==="t"||i[0]==="T";if(e===n)return i}return e?t.options.trueStr:t.options.falseStr}};function Ke({format:i,minFractionDigits:e,tag:t,value:n}){if(typeof n=="bigint")return String(n);const s=typeof n=="number"?n:Number(n);if(!isFinite(s))return isNaN(s)?".nan":s<0?"-.inf":".inf";let a=JSON.stringify(n);if(!i&&e&&(!t||t==="tag:yaml.org,2002:float")&&/^\d/.test(a)){let l=a.indexOf(".");l<0&&(l=a.length,a+=".");let u=e-(a.length-l-1);for(;u-- >0;)a+="0"}return a}const Fa={identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:i=>i.slice(-3).toLowerCase()==="nan"?NaN:i[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Ke},Ka={identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:i=>parseFloat(i),stringify(i){const e=Number(i.value);return isFinite(e)?e.toExponential():Ke(i)}},Ra={identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(i){const e=new ne(parseFloat(i)),t=i.indexOf(".");return t!==-1&&i[i.length-1]==="0"&&(e.minFractionDigits=i.length-t-1),e},stringify:Ke},xs=i=>typeof i=="bigint"||Number.isInteger(i),nr=(i,e,t,{intAsBigInt:n})=>n?BigInt(i):parseInt(i.substring(e),t);function ja(i,e,t){const{value:n}=i;return xs(n)&&n>=0?t+n.toString(e):Ke(i)}const qa={identify:i=>xs(i)&&i>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(i,e,t)=>nr(i,2,8,t),stringify:i=>ja(i,8,"0o")},za={identify:xs,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(i,e,t)=>nr(i,0,10,t),stringify:Ke},Ha={identify:i=>xs(i)&&i>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(i,e,t)=>nr(i,2,16,t),stringify:i=>ja(i,16,"0x")},mc=[an,on,Os,Ms,tr,qa,za,Ha,Fa,Ka,Ra];function aa(i){return typeof i=="bigint"||Number.isInteger(i)}const fs=({value:i})=>JSON.stringify(i),gc=[{identify:i=>typeof i=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:i=>i,stringify:fs},{identify:i=>i==null,createNode:()=>new ne(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:fs},{identify:i=>typeof i=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true$|^false$/,resolve:i=>i==="true",stringify:fs},{identify:aa,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(i,e,{intAsBigInt:t})=>t?BigInt(i):parseInt(i,10),stringify:({value:i})=>aa(i)?i.toString():JSON.stringify(i)},{identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:i=>parseFloat(i),stringify:fs}],yc={default:!0,tag:"",test:/^/,resolve(i,e){return e(`Unresolved plain scalar ${JSON.stringify(i)}`),i}},vc=[an,on].concat(gc,yc),sr={identify:i=>i instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(i,e){if(typeof atob=="function"){const t=atob(i.replace(/[\n\r]/g,"")),n=new Uint8Array(t.length);for(let s=0;s<t.length;++s)n[s]=t.charCodeAt(s);return n}else return e("This environment does not support reading binary tags; either Buffer or atob is required"),i},stringify({comment:i,type:e,value:t},n,s,a){if(!t)return"";const l=t;let u;if(typeof btoa=="function"){let h="";for(let m=0;m<l.length;++m)h+=String.fromCharCode(l[m]);u=btoa(h)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(e??(e=ne.BLOCK_LITERAL),e!==ne.QUOTE_DOUBLE){const h=Math.max(n.options.lineWidth-n.indent.length,n.options.minContentWidth),m=Math.ceil(u.length/h),w=new Array(m);for(let v=0,k=0;v<m;++v,k+=h)w[v]=u.substr(k,h);u=w.join(e===ne.BLOCK_LITERAL?`
`:" ")}return Mn({comment:i,type:e,value:u},n,s,a)}};function Ua(i,e){if(rn(i))for(let t=0;t<i.items.length;++t){let n=i.items[t];if(!ge(n)){if(sn(n)){n.items.length>1&&e("Each pair must have its own sequence indicator");const s=n.items[0]||new Ee(new ne(null));if(n.commentBefore&&(s.key.commentBefore=s.key.commentBefore?`${n.commentBefore}
${s.key.commentBefore}`:n.commentBefore),n.comment){const a=s.value??s.key;a.comment=a.comment?`${n.comment}
${a.comment}`:n.comment}n=s}i.items[t]=ge(n)?n:new Ee(n)}}else e("Expected a sequence for this tag");return i}function Va(i,e,t){const{replacer:n}=t,s=new ut(i);s.tag="tag:yaml.org,2002:pairs";let a=0;if(e&&Symbol.iterator in Object(e))for(let l of e){typeof n=="function"&&(l=n.call(e,String(a++),l));let u,h;if(Array.isArray(l))if(l.length===2)u=l[0],h=l[1];else throw new TypeError(`Expected [key, value] tuple: ${l}`);else if(l&&l instanceof Object){const m=Object.keys(l);if(m.length===1)u=m[0],h=l[u];else throw new TypeError(`Expected tuple with one key, not ${m.length} keys`)}else u=l;s.items.push(er(u,h,t))}return s}const ir={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:Ua,createNode:Va};class Wt extends ut{constructor(){super(),this.add=xe.prototype.add.bind(this),this.delete=xe.prototype.delete.bind(this),this.get=xe.prototype.get.bind(this),this.has=xe.prototype.has.bind(this),this.set=xe.prototype.set.bind(this),this.tag=Wt.tag}toJSON(e,t){if(!t)return super.toJSON(e);const n=new Map;t!=null&&t.onCreate&&t.onCreate(n);for(const s of this.items){let a,l;if(ge(s)?(a=Ne(s.key,"",t),l=Ne(s.value,a,t)):a=Ne(s,"",t),n.has(a))throw new Error("Ordered maps must not include duplicate keys");n.set(a,l)}return n}static from(e,t,n){const s=Va(e,t,n),a=new this;return a.items=s.items,a}}Wt.tag="tag:yaml.org,2002:omap";const rr={collection:"seq",identify:i=>i instanceof Map,nodeClass:Wt,default:!1,tag:"tag:yaml.org,2002:omap",resolve(i,e){const t=Ua(i,e),n=[];for(const{key:s}of t.items)fe(s)&&(n.includes(s.value)?e(`Ordered maps must not include duplicate keys: ${s.value}`):n.push(s.value));return Object.assign(new Wt,t)},createNode:(i,e,t)=>Wt.from(i,e,t)};function Ya({value:i,source:e},t){return e&&(i?Ga:Ja).test.test(e)?e:i?t.options.trueStr:t.options.falseStr}const Ga={identify:i=>i===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new ne(!0),stringify:Ya},Ja={identify:i=>i===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/,resolve:()=>new ne(!1),stringify:Ya},bc={identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:i=>i.slice(-3).toLowerCase()==="nan"?NaN:i[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Ke},wc={identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:i=>parseFloat(i.replace(/_/g,"")),stringify(i){const e=Number(i.value);return isFinite(e)?e.toExponential():Ke(i)}},kc={identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(i){const e=new ne(parseFloat(i.replace(/_/g,""))),t=i.indexOf(".");if(t!==-1){const n=i.substring(t+1).replace(/_/g,"");n[n.length-1]==="0"&&(e.minFractionDigits=n.length)}return e},stringify:Ke},xn=i=>typeof i=="bigint"||Number.isInteger(i);function Ps(i,e,t,{intAsBigInt:n}){const s=i[0];if((s==="-"||s==="+")&&(e+=1),i=i.substring(e).replace(/_/g,""),n){switch(t){case 2:i=`0b${i}`;break;case 8:i=`0o${i}`;break;case 16:i=`0x${i}`;break}const l=BigInt(i);return s==="-"?BigInt(-1)*l:l}const a=parseInt(i,t);return s==="-"?-1*a:a}function ar(i,e,t){const{value:n}=i;if(xn(n)){const s=n.toString(e);return n<0?"-"+t+s.substr(1):t+s}return Ke(i)}const Sc={identify:xn,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(i,e,t)=>Ps(i,2,2,t),stringify:i=>ar(i,2,"0b")},Tc={identify:xn,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(i,e,t)=>Ps(i,1,8,t),stringify:i=>ar(i,8,"0")},Ic={identify:xn,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(i,e,t)=>Ps(i,0,10,t),stringify:Ke},_c={identify:xn,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(i,e,t)=>Ps(i,2,16,t),stringify:i=>ar(i,16,"0x")};class Qt extends xe{constructor(e){super(e),this.tag=Qt.tag}add(e){let t;ge(e)?t=e:e&&typeof e=="object"&&"key"in e&&"value"in e&&e.value===null?t=new Ee(e.key,null):t=new Ee(e,null),At(this.items,t.key)||this.items.push(t)}get(e,t){const n=At(this.items,e);return!t&&ge(n)?fe(n.key)?n.key.value:n.key:n}set(e,t){if(typeof t!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof t}`);const n=At(this.items,e);n&&!t?this.items.splice(this.items.indexOf(n),1):!n&&t&&this.items.push(new Ee(e))}toJSON(e,t){return super.toJSON(e,t,Set)}toString(e,t,n){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),t,n);throw new Error("Set items must all have null values")}static from(e,t,n){const{replacer:s}=n,a=new this(e);if(t&&Symbol.iterator in Object(t))for(let l of t)typeof s=="function"&&(l=s.call(t,l,l)),a.items.push(er(l,null,n));return a}}Qt.tag="tag:yaml.org,2002:set";const or={collection:"map",identify:i=>i instanceof Set,nodeClass:Qt,default:!1,tag:"tag:yaml.org,2002:set",createNode:(i,e,t)=>Qt.from(i,e,t),resolve(i,e){if(sn(i)){if(i.hasAllNullValues(!0))return Object.assign(new Qt,i);e("Set items must all have null values")}else e("Expected a mapping for this tag");return i}};function lr(i,e){const t=i[0],n=t==="-"||t==="+"?i.substring(1):i,s=l=>e?BigInt(l):Number(l),a=n.replace(/_/g,"").split(":").reduce((l,u)=>l*s(60)+s(u),s(0));return t==="-"?s(-1)*a:a}function Wa(i){let{value:e}=i,t=l=>l;if(typeof e=="bigint")t=l=>BigInt(l);else if(isNaN(e)||!isFinite(e))return Ke(i);let n="";e<0&&(n="-",e*=t(-1));const s=t(60),a=[e%s];return e<60?a.unshift(0):(e=(e-a[0])/s,a.unshift(e%s),e>=60&&(e=(e-a[0])/s,a.unshift(e))),n+a.map(l=>String(l).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const Qa={identify:i=>typeof i=="bigint"||Number.isInteger(i),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(i,e,{intAsBigInt:t})=>lr(i,t),stringify:Wa},Xa={identify:i=>typeof i=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:i=>lr(i,!1),stringify:Wa},Ns={identify:i=>i instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(i){const e=i.match(Ns.test);if(!e)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,t,n,s,a,l,u]=e.map(Number),h=e[7]?Number((e[7]+"00").substr(1,3)):0;let m=Date.UTC(t,n-1,s,a||0,l||0,u||0,h);const w=e[8];if(w&&w!=="Z"){let v=lr(w,!1);Math.abs(v)<30&&(v*=60),m-=6e4*v}return new Date(m)},stringify:({value:i})=>(i==null?void 0:i.toISOString().replace(/(T00:00:00)?\.000Z$/,""))??""},oa=[an,on,Os,Ms,Ga,Ja,Sc,Tc,Ic,_c,bc,wc,kc,sr,Xe,rr,ir,or,Qa,Xa,Ns],la=new Map([["core",mc],["failsafe",[an,on,Os]],["json",vc],["yaml11",oa],["yaml-1.1",oa]]),ca={binary:sr,bool:tr,float:Ra,floatExp:Ka,floatNaN:Fa,floatTime:Xa,int:za,intHex:Ha,intOct:qa,intTime:Qa,map:an,merge:Xe,null:Ms,omap:rr,pairs:ir,seq:on,set:or,timestamp:Ns},Cc={"tag:yaml.org,2002:binary":sr,"tag:yaml.org,2002:merge":Xe,"tag:yaml.org,2002:omap":rr,"tag:yaml.org,2002:pairs":ir,"tag:yaml.org,2002:set":or,"tag:yaml.org,2002:timestamp":Ns};function Li(i,e,t){const n=la.get(e);if(n&&!i)return t&&!n.includes(Xe)?n.concat(Xe):n.slice();let s=n;if(!s)if(Array.isArray(i))s=[];else{const a=Array.from(la.keys()).filter(l=>l!=="yaml11").map(l=>JSON.stringify(l)).join(", ");throw new Error(`Unknown schema "${e}"; use one of ${a} or define customTags array`)}if(Array.isArray(i))for(const a of i)s=s.concat(a);else typeof i=="function"&&(s=i(s.slice()));return t&&(s=s.concat(Xe)),s.reduce((a,l)=>{const u=typeof l=="string"?ca[l]:l;if(!u){const h=JSON.stringify(l),m=Object.keys(ca).map(w=>JSON.stringify(w)).join(", ");throw new Error(`Unknown custom tag ${h}; use one of ${m}`)}return a.includes(u)||a.push(u),a},[])}const Ec=(i,e)=>i.key<e.key?-1:i.key>e.key?1:0;class $s{constructor({compat:e,customTags:t,merge:n,resolveKnownTags:s,schema:a,sortMapEntries:l,toStringDefaults:u}){this.compat=Array.isArray(e)?Li(e,"compat"):e?Li(null,e):null,this.name=typeof a=="string"&&a||"core",this.knownTags=s?Cc:{},this.tags=Li(t,this.name,n),this.toStringOptions=u??null,Object.defineProperty(this,lt,{value:an}),Object.defineProperty(this,Ue,{value:Os}),Object.defineProperty(this,nn,{value:on}),this.sortMapEntries=typeof l=="function"?l:l===!0?Ec:null}clone(){const e=Object.create($s.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}}function Ac(i,e){var h;const t=[];let n=e.directives===!0;if(e.directives!==!1&&i.directives){const m=i.directives.toString(i);m?(t.push(m),n=!0):i.directives.docStart&&(n=!0)}n&&t.push("---");const s=xa(i,e),{commentString:a}=s.options;if(i.commentBefore){t.length!==1&&t.unshift("");const m=a(i.commentBefore);t.unshift(Qe(m,""))}let l=!1,u=null;if(i.contents){if(ve(i.contents)){if(i.contents.spaceBefore&&n&&t.push(""),i.contents.commentBefore){const v=a(i.contents.commentBefore);t.push(Qe(v,""))}s.forceBlockIndent=!!i.comment,u=i.contents.comment}const m=u?void 0:()=>l=!0;let w=Zt(i.contents,s,()=>u=null,m);u&&(w+=Et(w,"",a(u))),(w[0]==="|"||w[0]===">")&&t[t.length-1]==="---"?t[t.length-1]=`--- ${w}`:t.push(w)}else t.push(Zt(i.contents,s));if((h=i.directives)!=null&&h.docEnd)if(i.comment){const m=a(i.comment);m.includes(`
`)?(t.push("..."),t.push(Qe(m,""))):t.push(`... ${m}`)}else t.push("...");else{let m=i.comment;m&&l&&(m=m.replace(/^\n+/,"")),m&&((!l||u)&&t[t.length-1]!==""&&t.push(""),t.push(Qe(a(m),"")))}return t.join(`
`)+`
`}class ln{constructor(e,t,n){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,$e,{value:ji});let s=null;typeof t=="function"||Array.isArray(t)?s=t:n===void 0&&t&&(n=t,t=void 0);const a=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,stringKeys:!1,uniqueKeys:!0,version:"1.2"},n);this.options=a;let{version:l}=a;n!=null&&n._directives?(this.directives=n._directives.atDocument(),this.directives.yaml.explicit&&(l=this.directives.yaml.version)):this.directives=new Le({version:l}),this.setSchema(l,n),this.contents=e===void 0?null:this.createNode(e,s,n)}clone(){const e=Object.create(ln.prototype,{[$e]:{value:ji}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=ve(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){zt(this.contents)&&this.contents.add(e)}addIn(e,t){zt(this.contents)&&this.contents.addIn(e,t)}createAlias(e,t){if(!e.anchor){const n=Aa(this);e.anchor=!t||n.has(t)?La(t||"a",n):t}return new Es(e.anchor)}createNode(e,t,n){let s;if(typeof t=="function")e=t.call({"":e},"",e),s=t;else if(Array.isArray(t)){const N=G=>typeof G=="number"||G instanceof String||G instanceof Number,V=t.filter(N).map(String);V.length>0&&(t=t.concat(V)),s=t}else n===void 0&&t&&(n=t,t=void 0);const{aliasDuplicateObjects:a,anchorPrefix:l,flow:u,keepUndefined:h,onTagObj:m,tag:w}=n??{},{onAnchor:v,setAnchors:k,sourceObjects:B}=nc(this,l||"a"),F={aliasDuplicateObjects:a??!0,keepUndefined:h??!1,onAnchor:v,onTagObj:m,replacer:s,schema:this.schema,sourceObjects:B},O=Ln(e,w,F);return u&&ye(O)&&(O.flow=!0),k(),O}createPair(e,t,n={}){const s=this.createNode(e,null,n),a=this.createNode(t,null,n);return new Ee(s,a)}delete(e){return zt(this.contents)?this.contents.delete(e):!1}deleteIn(e){return In(e)?this.contents==null?!1:(this.contents=null,!0):zt(this.contents)?this.contents.deleteIn(e):!1}get(e,t){return ye(this.contents)?this.contents.get(e,t):void 0}getIn(e,t){return In(e)?!t&&fe(this.contents)?this.contents.value:this.contents:ye(this.contents)?this.contents.getIn(e,t):void 0}has(e){return ye(this.contents)?this.contents.has(e):!1}hasIn(e){return In(e)?this.contents!==void 0:ye(this.contents)?this.contents.hasIn(e):!1}set(e,t){this.contents==null?this.contents=Ss(this.schema,[e],t):zt(this.contents)&&this.contents.set(e,t)}setIn(e,t){In(e)?this.contents=t:this.contents==null?this.contents=Ss(this.schema,Array.from(e),t):zt(this.contents)&&this.contents.setIn(e,t)}setSchema(e,t={}){typeof e=="number"&&(e=String(e));let n;switch(e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Le({version:"1.1"}),n={resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Le({version:e}),n={resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,n=null;break;default:{const s=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${s}`)}}if(t.schema instanceof Object)this.schema=t.schema;else if(n)this.schema=new $s(Object.assign(n,t));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:e,jsonArg:t,mapAsMap:n,maxAliasCount:s,onAnchor:a,reviver:l}={}){const u={anchors:new Map,doc:this,keep:!e,mapAsMap:n===!0,mapKeyWarned:!1,maxAliasCount:typeof s=="number"?s:100},h=Ne(this.contents,t??"",u);if(typeof a=="function")for(const{count:m,res:w}of u.anchors.values())a(w,m);return typeof l=="function"?Yt(l,{"":h},"",h):h}toJSON(e,t){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:t})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){const t=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${t}`)}return Ac(this,e)}}function zt(i){if(ye(i))return!0;throw new Error("Expected a YAML collection as document contents")}class cr extends Error{constructor(e,t,n,s){super(),this.name=e,this.code=n,this.message=s,this.pos=t}}class Lt extends cr{constructor(e,t,n){super("YAMLParseError",e,t,n)}}class Za extends cr{constructor(e,t,n){super("YAMLWarning",e,t,n)}}const Is=(i,e)=>t=>{if(t.pos[0]===-1)return;t.linePos=t.pos.map(u=>e.linePos(u));const{line:n,col:s}=t.linePos[0];t.message+=` at line ${n}, column ${s}`;let a=s-1,l=i.substring(e.lineStarts[n-1],e.lineStarts[n]).replace(/[\n\r]+$/,"");if(a>=60&&l.length>80){const u=Math.min(a-39,l.length-79);l="…"+l.substring(u),a-=u-1}if(l.length>80&&(l=l.substring(0,79)+"…"),n>1&&/^ *$/.test(l.substring(0,a))){let u=i.substring(e.lineStarts[n-2],e.lineStarts[n-1]);u.length>80&&(u=u.substring(0,79)+`…
`),l=u+l}if(/[^ ]/.test(l)){let u=1;const h=t.linePos[1];h&&h.line===n&&h.col>s&&(u=Math.max(1,Math.min(h.col-s,80-a)));const m=" ".repeat(a)+"^".repeat(u);t.message+=`:

${l}
${m}
`}};function en(i,{flow:e,indicator:t,next:n,offset:s,onError:a,parentIndent:l,startOnNewline:u}){let h=!1,m=u,w=u,v="",k="",B=!1,F=!1,O=null,N=null,V=null,G=null,Q=null,W=null,ee=null;for(const J of i)switch(F&&(J.type!=="space"&&J.type!=="newline"&&J.type!=="comma"&&a(J.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),F=!1),O&&(m&&J.type!=="comment"&&J.type!=="newline"&&a(O,"TAB_AS_INDENT","Tabs are not allowed as indentation"),O=null),J.type){case"space":!e&&(t!=="doc-start"||(n==null?void 0:n.type)!=="flow-collection")&&J.source.includes("	")&&(O=J),w=!0;break;case"comment":{w||a(J,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const be=J.source.substring(1)||" ";v?v+=k+be:v=be,k="",m=!1;break}case"newline":m?v?v+=J.source:(!W||t!=="seq-item-ind")&&(h=!0):k+=J.source,m=!0,B=!0,(N||V)&&(G=J),w=!0;break;case"anchor":N&&a(J,"MULTIPLE_ANCHORS","A node can have at most one anchor"),J.source.endsWith(":")&&a(J.offset+J.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),N=J,ee??(ee=J.offset),m=!1,w=!1,F=!0;break;case"tag":{V&&a(J,"MULTIPLE_TAGS","A node can have at most one tag"),V=J,ee??(ee=J.offset),m=!1,w=!1,F=!0;break}case t:(N||V)&&a(J,"BAD_PROP_ORDER",`Anchors and tags must be after the ${J.source} indicator`),W&&a(J,"UNEXPECTED_TOKEN",`Unexpected ${J.source} in ${e??"collection"}`),W=J,m=t==="seq-item-ind"||t==="explicit-key-ind",w=!1;break;case"comma":if(e){Q&&a(J,"UNEXPECTED_TOKEN",`Unexpected , in ${e}`),Q=J,m=!1,w=!1;break}default:a(J,"UNEXPECTED_TOKEN",`Unexpected ${J.type} token`),m=!1,w=!1}const Z=i[i.length-1],re=Z?Z.offset+Z.source.length:s;return F&&n&&n.type!=="space"&&n.type!=="newline"&&n.type!=="comma"&&(n.type!=="scalar"||n.source!=="")&&a(n.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),O&&(m&&O.indent<=l||(n==null?void 0:n.type)==="block-map"||(n==null?void 0:n.type)==="block-seq")&&a(O,"TAB_AS_INDENT","Tabs are not allowed as indentation"),{comma:Q,found:W,spaceBefore:h,comment:v,hasNewline:B,anchor:N,tag:V,newlineAfterProp:G,end:re,start:ee??re}}function Bn(i){if(!i)return null;switch(i.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(i.source.includes(`
`))return!0;if(i.end){for(const e of i.end)if(e.type==="newline")return!0}return!1;case"flow-collection":for(const e of i.items){for(const t of e.start)if(t.type==="newline")return!0;if(e.sep){for(const t of e.sep)if(t.type==="newline")return!0}if(Bn(e.key)||Bn(e.value))return!0}return!1;default:return!0}}function Ui(i,e,t){if((e==null?void 0:e.type)==="flow-collection"){const n=e.end[0];n.indent===i&&(n.source==="]"||n.source==="}")&&Bn(e)&&t(n,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}function eo(i,e,t){const{uniqueKeys:n}=i.options;if(n===!1)return!1;const s=typeof n=="function"?n:(a,l)=>a===l||fe(a)&&fe(l)&&a.value===l.value;return e.some(a=>s(a.key,t))}const ua="All mapping items must start at the same column";function Lc({composeNode:i,composeEmptyNode:e},t,n,s,a){var w;const l=(a==null?void 0:a.nodeClass)??xe,u=new l(t.schema);t.atRoot&&(t.atRoot=!1);let h=n.offset,m=null;for(const v of n.items){const{start:k,key:B,sep:F,value:O}=v,N=en(k,{indicator:"explicit-key-ind",next:B??(F==null?void 0:F[0]),offset:h,onError:s,parentIndent:n.indent,startOnNewline:!0}),V=!N.found;if(V){if(B&&(B.type==="block-seq"?s(h,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in B&&B.indent!==n.indent&&s(h,"BAD_INDENT",ua)),!N.anchor&&!N.tag&&!F){m=N.end,N.comment&&(u.comment?u.comment+=`
`+N.comment:u.comment=N.comment);continue}(N.newlineAfterProp||Bn(B))&&s(B??k[k.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else((w=N.found)==null?void 0:w.indent)!==n.indent&&s(h,"BAD_INDENT",ua);t.atKey=!0;const G=N.end,Q=B?i(t,B,N,s):e(t,G,k,null,N,s);t.schema.compat&&Ui(n.indent,B,s),t.atKey=!1,eo(t,u.items,Q)&&s(G,"DUPLICATE_KEY","Map keys must be unique");const W=en(F??[],{indicator:"map-value-ind",next:O,offset:Q.range[2],onError:s,parentIndent:n.indent,startOnNewline:!B||B.type==="block-scalar"});if(h=W.end,W.found){V&&((O==null?void 0:O.type)==="block-map"&&!W.hasNewline&&s(h,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),t.options.strict&&N.start<W.found.offset-1024&&s(Q.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const ee=O?i(t,O,W,s):e(t,h,F,null,W,s);t.schema.compat&&Ui(n.indent,O,s),h=ee.range[2];const Z=new Ee(Q,ee);t.options.keepSourceTokens&&(Z.srcToken=v),u.items.push(Z)}else{V&&s(Q.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),W.comment&&(Q.comment?Q.comment+=`
`+W.comment:Q.comment=W.comment);const ee=new Ee(Q);t.options.keepSourceTokens&&(ee.srcToken=v),u.items.push(ee)}}return m&&m<h&&s(m,"IMPOSSIBLE","Map comment with trailing content"),u.range=[n.offset,h,m??h],u}function Bc({composeNode:i,composeEmptyNode:e},t,n,s,a){const l=(a==null?void 0:a.nodeClass)??ut,u=new l(t.schema);t.atRoot&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let h=n.offset,m=null;for(const{start:w,value:v}of n.items){const k=en(w,{indicator:"seq-item-ind",next:v,offset:h,onError:s,parentIndent:n.indent,startOnNewline:!0});if(!k.found)if(k.anchor||k.tag||v)v&&v.type==="block-seq"?s(k.end,"BAD_INDENT","All sequence items must start at the same column"):s(h,"MISSING_CHAR","Sequence item without - indicator");else{m=k.end,k.comment&&(u.comment=k.comment);continue}const B=v?i(t,v,k,s):e(t,k.end,w,null,k,s);t.schema.compat&&Ui(n.indent,v,s),h=B.range[2],u.items.push(B)}return u.range=[n.offset,h,m??h],u}function Pn(i,e,t,n){let s="";if(i){let a=!1,l="";for(const u of i){const{source:h,type:m}=u;switch(m){case"space":a=!0;break;case"comment":{t&&!a&&n(u,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const w=h.substring(1)||" ";s?s+=l+w:s=w,l="";break}case"newline":s&&(l+=h),a=!0;break;default:n(u,"UNEXPECTED_TOKEN",`Unexpected ${m} at node end`)}e+=h.length}}return{comment:s,offset:e}}const Bi="Block collections are not allowed within flow collections",Oi=i=>i&&(i.type==="block-map"||i.type==="block-seq");function Oc({composeNode:i,composeEmptyNode:e},t,n,s,a){const l=n.start.source==="{",u=l?"flow map":"flow sequence",h=(a==null?void 0:a.nodeClass)??(l?xe:ut),m=new h(t.schema);m.flow=!0;const w=t.atRoot;w&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let v=n.offset+n.start.source.length;for(let N=0;N<n.items.length;++N){const V=n.items[N],{start:G,key:Q,sep:W,value:ee}=V,Z=en(G,{flow:u,indicator:"explicit-key-ind",next:Q??(W==null?void 0:W[0]),offset:v,onError:s,parentIndent:n.indent,startOnNewline:!1});if(!Z.found){if(!Z.anchor&&!Z.tag&&!W&&!ee){N===0&&Z.comma?s(Z.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${u}`):N<n.items.length-1&&s(Z.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${u}`),Z.comment&&(m.comment?m.comment+=`
`+Z.comment:m.comment=Z.comment),v=Z.end;continue}!l&&t.options.strict&&Bn(Q)&&s(Q,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if(N===0)Z.comma&&s(Z.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${u}`);else if(Z.comma||s(Z.start,"MISSING_CHAR",`Missing , between ${u} items`),Z.comment){let re="";e:for(const J of G)switch(J.type){case"comma":case"space":break;case"comment":re=J.source.substring(1);break e;default:break e}if(re){let J=m.items[m.items.length-1];ge(J)&&(J=J.value??J.key),J.comment?J.comment+=`
`+re:J.comment=re,Z.comment=Z.comment.substring(re.length+1)}}if(!l&&!W&&!Z.found){const re=ee?i(t,ee,Z,s):e(t,Z.end,W,null,Z,s);m.items.push(re),v=re.range[2],Oi(ee)&&s(re.range,"BLOCK_IN_FLOW",Bi)}else{t.atKey=!0;const re=Z.end,J=Q?i(t,Q,Z,s):e(t,re,G,null,Z,s);Oi(Q)&&s(J.range,"BLOCK_IN_FLOW",Bi),t.atKey=!1;const be=en(W??[],{flow:u,indicator:"map-value-ind",next:ee,offset:J.range[2],onError:s,parentIndent:n.indent,startOnNewline:!1});if(be.found){if(!l&&!Z.found&&t.options.strict){if(W)for(const he of W){if(he===be.found)break;if(he.type==="newline"){s(he,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}Z.start<be.found.offset-1024&&s(be.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else ee&&("source"in ee&&ee.source&&ee.source[0]===":"?s(ee,"MISSING_CHAR",`Missing space after : in ${u}`):s(be.start,"MISSING_CHAR",`Missing , or : between ${u} items`));const De=ee?i(t,ee,be,s):be.found?e(t,be.end,W,null,be,s):null;De?Oi(ee)&&s(De.range,"BLOCK_IN_FLOW",Bi):be.comment&&(J.comment?J.comment+=`
`+be.comment:J.comment=be.comment);const Ye=new Ee(J,De);if(t.options.keepSourceTokens&&(Ye.srcToken=V),l){const he=m;eo(t,he.items,J)&&s(re,"DUPLICATE_KEY","Map keys must be unique"),he.items.push(Ye)}else{const he=new xe(t.schema);he.flow=!0,he.items.push(Ye);const Re=(De??J).range;he.range=[J.range[0],Re[1],Re[2]],m.items.push(he)}v=De?De.range[2]:be.end}}const k=l?"}":"]",[B,...F]=n.end;let O=v;if(B&&B.source===k)O=B.offset+B.source.length;else{const N=u[0].toUpperCase()+u.substring(1),V=w?`${N} must end with a ${k}`:`${N} in block collection must be sufficiently indented and end with a ${k}`;s(v,w?"MISSING_CHAR":"BAD_INDENT",V),B&&B.source.length!==1&&F.unshift(B)}if(F.length>0){const N=Pn(F,O,t.options.strict,s);N.comment&&(m.comment?m.comment+=`
`+N.comment:m.comment=N.comment),m.range=[n.offset,O,N.offset]}else m.range=[n.offset,O,O];return m}function Mi(i,e,t,n,s,a){const l=t.type==="block-map"?Lc(i,e,t,n,a):t.type==="block-seq"?Bc(i,e,t,n,a):Oc(i,e,t,n,a),u=l.constructor;return s==="!"||s===u.tagName?(l.tag=u.tagName,l):(s&&(l.tag=s),l)}function Mc(i,e,t,n,s){var k;const a=n.tag,l=a?e.directives.tagName(a.source,B=>s(a,"TAG_RESOLVE_FAILED",B)):null;if(t.type==="block-seq"){const{anchor:B,newlineAfterProp:F}=n,O=B&&a?B.offset>a.offset?B:a:B??a;O&&(!F||F.offset<O.offset)&&s(O,"MISSING_CHAR","Missing newline after block sequence props")}const u=t.type==="block-map"?"map":t.type==="block-seq"?"seq":t.start.source==="{"?"map":"seq";if(!a||!l||l==="!"||l===xe.tagName&&u==="map"||l===ut.tagName&&u==="seq")return Mi(i,e,t,s,l);let h=e.schema.tags.find(B=>B.tag===l&&B.collection===u);if(!h){const B=e.schema.knownTags[l];if(B&&B.collection===u)e.schema.tags.push(Object.assign({},B,{default:!1})),h=B;else return B?s(a,"BAD_COLLECTION_TYPE",`${B.tag} used for ${u} collection, but expects ${B.collection??"scalar"}`,!0):s(a,"TAG_RESOLVE_FAILED",`Unresolved tag: ${l}`,!0),Mi(i,e,t,s,l)}const m=Mi(i,e,t,s,l,h),w=((k=h.resolve)==null?void 0:k.call(h,m,B=>s(a,"TAG_RESOLVE_FAILED",B),e.options))??m,v=ve(w)?w:new ne(w);return v.range=m.range,v.tag=l,h!=null&&h.format&&(v.format=h.format),v}function to(i,e,t){const n=e.offset,s=xc(e,i.options.strict,t);if(!s)return{value:"",type:null,comment:"",range:[n,n,n]};const a=s.mode===">"?ne.BLOCK_FOLDED:ne.BLOCK_LITERAL,l=e.source?Pc(e.source):[];let u=l.length;for(let O=l.length-1;O>=0;--O){const N=l[O][1];if(N===""||N==="\r")u=O;else break}if(u===0){const O=s.chomp==="+"&&l.length>0?`
`.repeat(Math.max(1,l.length-1)):"";let N=n+s.length;return e.source&&(N+=e.source.length),{value:O,type:a,comment:s.comment,range:[n,N,N]}}let h=e.indent+s.indent,m=e.offset+s.length,w=0;for(let O=0;O<u;++O){const[N,V]=l[O];if(V===""||V==="\r")s.indent===0&&N.length>h&&(h=N.length);else{N.length<h&&t(m+N.length,"MISSING_CHAR","Block scalars with more-indented leading empty lines must use an explicit indentation indicator"),s.indent===0&&(h=N.length),w=O,h===0&&!i.atRoot&&t(m,"BAD_INDENT","Block scalar values in collections must be indented");break}m+=N.length+V.length+1}for(let O=l.length-1;O>=u;--O)l[O][0].length>h&&(u=O+1);let v="",k="",B=!1;for(let O=0;O<w;++O)v+=l[O][0].slice(h)+`
`;for(let O=w;O<u;++O){let[N,V]=l[O];m+=N.length+V.length+1;const G=V[V.length-1]==="\r";if(G&&(V=V.slice(0,-1)),V&&N.length<h){const W=`Block scalar lines must not be less indented than their ${s.indent?"explicit indentation indicator":"first line"}`;t(m-V.length-(G?2:1),"BAD_INDENT",W),N=""}a===ne.BLOCK_LITERAL?(v+=k+N.slice(h)+V,k=`
`):N.length>h||V[0]==="	"?(k===" "?k=`
`:!B&&k===`
`&&(k=`

`),v+=k+N.slice(h)+V,k=`
`,B=!0):V===""?k===`
`?v+=`
`:k=`
`:(v+=k+V,k=" ",B=!1)}switch(s.chomp){case"-":break;case"+":for(let O=u;O<l.length;++O)v+=`
`+l[O][0].slice(h);v[v.length-1]!==`
`&&(v+=`
`);break;default:v+=`
`}const F=n+s.length+e.source.length;return{value:v,type:a,comment:s.comment,range:[n,F,F]}}function xc({offset:i,props:e},t,n){if(e[0].type!=="block-scalar-header")return n(e[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:s}=e[0],a=s[0];let l=0,u="",h=-1;for(let k=1;k<s.length;++k){const B=s[k];if(!u&&(B==="-"||B==="+"))u=B;else{const F=Number(B);!l&&F?l=F:h===-1&&(h=i+k)}}h!==-1&&n(h,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${s}`);let m=!1,w="",v=s.length;for(let k=1;k<e.length;++k){const B=e[k];switch(B.type){case"space":m=!0;case"newline":v+=B.source.length;break;case"comment":t&&!m&&n(B,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),v+=B.source.length,w=B.source.substring(1);break;case"error":n(B,"UNEXPECTED_TOKEN",B.message),v+=B.source.length;break;default:{const F=`Unexpected token in block scalar header: ${B.type}`;n(B,"UNEXPECTED_TOKEN",F);const O=B.source;O&&typeof O=="string"&&(v+=O.length)}}}return{mode:a,indent:l,chomp:u,comment:w,length:v}}function Pc(i){const e=i.split(/\n( *)/),t=e[0],n=t.match(/^( *)/),a=[n!=null&&n[1]?[n[1],t.slice(n[1].length)]:["",t]];for(let l=1;l<e.length;l+=2)a.push([e[l],e[l+1]]);return a}function no(i,e,t){const{offset:n,type:s,source:a,end:l}=i;let u,h;const m=(k,B,F)=>t(n+k,B,F);switch(s){case"scalar":u=ne.PLAIN,h=Nc(a,m);break;case"single-quoted-scalar":u=ne.QUOTE_SINGLE,h=$c(a,m);break;case"double-quoted-scalar":u=ne.QUOTE_DOUBLE,h=Dc(a,m);break;default:return t(i,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${s}`),{value:"",type:null,comment:"",range:[n,n+a.length,n+a.length]}}const w=n+a.length,v=Pn(l,w,e,t);return{value:h,type:u,comment:v.comment,range:[n,w,v.offset]}}function Nc(i,e){let t="";switch(i[0]){case"	":t="a tab character";break;case",":t="flow indicator character ,";break;case"%":t="directive indicator character %";break;case"|":case">":{t=`block scalar indicator ${i[0]}`;break}case"@":case"`":{t=`reserved character ${i[0]}`;break}}return t&&e(0,"BAD_SCALAR_START",`Plain value cannot start with ${t}`),so(i)}function $c(i,e){return(i[i.length-1]!=="'"||i.length===1)&&e(i.length,"MISSING_CHAR","Missing closing 'quote"),so(i.slice(1,-1)).replace(/''/g,"'")}function so(i){let e,t;try{e=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),t=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{e=/(.*?)[ \t]*\r?\n/sy,t=/[ \t]*(.*?)[ \t]*\r?\n/sy}let n=e.exec(i);if(!n)return i;let s=n[1],a=" ",l=e.lastIndex;for(t.lastIndex=l;n=t.exec(i);)n[1]===""?a===`
`?s+=a:a=`
`:(s+=a+n[1],a=" "),l=t.lastIndex;const u=/[ \t]*(.*)/sy;return u.lastIndex=l,n=u.exec(i),s+a+((n==null?void 0:n[1])??"")}function Dc(i,e){let t="";for(let n=1;n<i.length-1;++n){const s=i[n];if(!(s==="\r"&&i[n+1]===`
`))if(s===`
`){const{fold:a,offset:l}=Fc(i,n);t+=a,n=l}else if(s==="\\"){let a=i[++n];const l=Kc[a];if(l)t+=l;else if(a===`
`)for(a=i[n+1];a===" "||a==="	";)a=i[++n+1];else if(a==="\r"&&i[n+1]===`
`)for(a=i[++n+1];a===" "||a==="	";)a=i[++n+1];else if(a==="x"||a==="u"||a==="U"){const u={x:2,u:4,U:8}[a];t+=Rc(i,n+1,u,e),n+=u}else{const u=i.substr(n-1,2);e(n-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${u}`),t+=u}}else if(s===" "||s==="	"){const a=n;let l=i[n+1];for(;l===" "||l==="	";)l=i[++n+1];l!==`
`&&!(l==="\r"&&i[n+2]===`
`)&&(t+=n>a?i.slice(a,n+1):s)}else t+=s}return(i[i.length-1]!=='"'||i.length===1)&&e(i.length,"MISSING_CHAR",'Missing closing "quote'),t}function Fc(i,e){let t="",n=i[e+1];for(;(n===" "||n==="	"||n===`
`||n==="\r")&&!(n==="\r"&&i[e+2]!==`
`);)n===`
`&&(t+=`
`),e+=1,n=i[e+1];return t||(t=" "),{fold:t,offset:e}}const Kc={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function Rc(i,e,t,n){const s=i.substr(e,t),l=s.length===t&&/^[0-9a-fA-F]+$/.test(s)?parseInt(s,16):NaN;if(isNaN(l)){const u=i.substr(e-2,t+2);return n(e-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${u}`),u}return String.fromCodePoint(l)}function io(i,e,t,n){const{value:s,type:a,comment:l,range:u}=e.type==="block-scalar"?to(i,e,n):no(e,i.options.strict,n),h=t?i.directives.tagName(t.source,v=>n(t,"TAG_RESOLVE_FAILED",v)):null;let m;i.options.stringKeys&&i.atKey?m=i.schema[Ue]:h?m=jc(i.schema,s,h,t,n):e.type==="scalar"?m=qc(i,s,e,n):m=i.schema[Ue];let w;try{const v=m.resolve(s,k=>n(t??e,"TAG_RESOLVE_FAILED",k),i.options);w=fe(v)?v:new ne(v)}catch(v){const k=v instanceof Error?v.message:String(v);n(t??e,"TAG_RESOLVE_FAILED",k),w=new ne(s)}return w.range=u,w.source=s,a&&(w.type=a),h&&(w.tag=h),m.format&&(w.format=m.format),l&&(w.comment=l),w}function jc(i,e,t,n,s){var u;if(t==="!")return i[Ue];const a=[];for(const h of i.tags)if(!h.collection&&h.tag===t)if(h.default&&h.test)a.push(h);else return h;for(const h of a)if((u=h.test)!=null&&u.test(e))return h;const l=i.knownTags[t];return l&&!l.collection?(i.tags.push(Object.assign({},l,{default:!1,test:void 0})),l):(s(n,"TAG_RESOLVE_FAILED",`Unresolved tag: ${t}`,t!=="tag:yaml.org,2002:str"),i[Ue])}function qc({atKey:i,directives:e,schema:t},n,s,a){const l=t.tags.find(u=>{var h;return(u.default===!0||i&&u.default==="key")&&((h=u.test)==null?void 0:h.test(n))})||t[Ue];if(t.compat){const u=t.compat.find(h=>{var m;return h.default&&((m=h.test)==null?void 0:m.test(n))})??t[Ue];if(l.tag!==u.tag){const h=e.tagString(l.tag),m=e.tagString(u.tag),w=`Value may be parsed as either ${h} or ${m}`;a(s,"TAG_RESOLVE_FAILED",w,!0)}}return l}function zc(i,e,t){if(e){t??(t=e.length);for(let n=t-1;n>=0;--n){let s=e[n];switch(s.type){case"space":case"comment":case"newline":i-=s.source.length;continue}for(s=e[++n];(s==null?void 0:s.type)==="space";)i+=s.source.length,s=e[++n];break}}return i}const Hc={composeNode:ro,composeEmptyNode:ur};function ro(i,e,t,n){const s=i.atKey,{spaceBefore:a,comment:l,anchor:u,tag:h}=t;let m,w=!0;switch(e.type){case"alias":m=Uc(i,e,n),(u||h)&&n(e,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":m=io(i,e,h,n),u&&(m.anchor=u.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":m=Mc(Hc,i,e,t,n),u&&(m.anchor=u.source.substring(1));break;default:{const v=e.type==="error"?e.message:`Unsupported token (type: ${e.type})`;n(e,"UNEXPECTED_TOKEN",v),m=ur(i,e.offset,void 0,null,t,n),w=!1}}return u&&m.anchor===""&&n(u,"BAD_ALIAS","Anchor cannot be an empty string"),s&&i.options.stringKeys&&(!fe(m)||typeof m.value!="string"||m.tag&&m.tag!=="tag:yaml.org,2002:str")&&n(h??e,"NON_STRING_KEY","With stringKeys, all keys must be strings"),a&&(m.spaceBefore=!0),l&&(e.type==="scalar"&&e.source===""?m.comment=l:m.commentBefore=l),i.options.keepSourceTokens&&w&&(m.srcToken=e),m}function ur(i,e,t,n,{spaceBefore:s,comment:a,anchor:l,tag:u,end:h},m){const w={type:"scalar",offset:zc(e,t,n),indent:-1,source:""},v=io(i,w,u,m);return l&&(v.anchor=l.source.substring(1),v.anchor===""&&m(l,"BAD_ALIAS","Anchor cannot be an empty string")),s&&(v.spaceBefore=!0),a&&(v.comment=a,v.range[2]=h),v}function Uc({options:i},{offset:e,source:t,end:n},s){const a=new Es(t.substring(1));a.source===""&&s(e,"BAD_ALIAS","Alias cannot be an empty string"),a.source.endsWith(":")&&s(e+t.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const l=e+t.length,u=Pn(n,l,i.strict,s);return a.range=[e,l,u.offset],u.comment&&(a.comment=u.comment),a}function Vc(i,e,{offset:t,start:n,value:s,end:a},l){const u=Object.assign({_directives:e},i),h=new ln(void 0,u),m={atKey:!1,atRoot:!0,directives:h.directives,options:h.options,schema:h.schema},w=en(n,{indicator:"doc-start",next:s??(a==null?void 0:a[0]),offset:t,onError:l,parentIndent:0,startOnNewline:!0});w.found&&(h.directives.docStart=!0,s&&(s.type==="block-map"||s.type==="block-seq")&&!w.hasNewline&&l(w.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),h.contents=s?ro(m,s,w,l):ur(m,w.end,n,null,w,l);const v=h.contents.range[2],k=Pn(a,v,!1,l);return k.comment&&(h.comment=k.comment),h.range=[t,v,k.offset],h}function Tn(i){if(typeof i=="number")return[i,i+1];if(Array.isArray(i))return i.length===2?i:[i[0],i[1]];const{offset:e,source:t}=i;return[e,e+(typeof t=="string"?t.length:1)]}function da(i){var s;let e="",t=!1,n=!1;for(let a=0;a<i.length;++a){const l=i[a];switch(l[0]){case"#":e+=(e===""?"":n?`

`:`
`)+(l.substring(1)||" "),t=!0,n=!1;break;case"%":((s=i[a+1])==null?void 0:s[0])!=="#"&&(a+=1),t=!1;break;default:t||(n=!0),t=!1}}return{comment:e,afterEmptyLine:n}}class dr{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(t,n,s,a)=>{const l=Tn(t);a?this.warnings.push(new Za(l,n,s)):this.errors.push(new Lt(l,n,s))},this.directives=new Le({version:e.version||"1.2"}),this.options=e}decorate(e,t){const{comment:n,afterEmptyLine:s}=da(this.prelude);if(n){const a=e.contents;if(t)e.comment=e.comment?`${e.comment}
${n}`:n;else if(s||e.directives.docStart||!a)e.commentBefore=n;else if(ye(a)&&!a.flow&&a.items.length>0){let l=a.items[0];ge(l)&&(l=l.key);const u=l.commentBefore;l.commentBefore=u?`${n}
${u}`:n}else{const l=a.commentBefore;a.commentBefore=l?`${n}
${l}`:n}}t?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:da(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,t=!1,n=-1){for(const s of e)yield*this.next(s);yield*this.end(t,n)}*next(e){switch(e.type){case"directive":this.directives.add(e.source,(t,n,s)=>{const a=Tn(e);a[0]+=t,this.onError(a,"BAD_DIRECTIVE",n,s)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{const t=Vc(this.options,this.directives,e,this.onError);this.atDirectives&&!t.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(t,!1),this.doc&&(yield this.doc),this.doc=t,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{const t=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,n=new Lt(Tn(e),"UNEXPECTED_TOKEN",t);this.atDirectives||!this.doc?this.errors.push(n):this.doc.errors.push(n);break}case"doc-end":{if(!this.doc){const n="Unexpected doc-end without preceding document";this.errors.push(new Lt(Tn(e),"UNEXPECTED_TOKEN",n));break}this.doc.directives.docEnd=!0;const t=Pn(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),t.comment){const n=this.doc.comment;this.doc.comment=n?`${n}
${t.comment}`:t.comment}this.doc.range[2]=t.offset;break}default:this.errors.push(new Lt(Tn(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,t=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){const n=Object.assign({_directives:this.directives},this.options),s=new ln(void 0,n);this.atDirectives&&this.onError(t,"MISSING_CHAR","Missing directives-end indicator line"),s.range=[0,t,t],this.decorate(s,!1),yield s}}}function Yc(i,e=!0,t){if(i){const n=(s,a,l)=>{const u=typeof s=="number"?s:Array.isArray(s)?s[0]:s.offset;if(t)t(u,a,l);else throw new Lt([u,u+1],a,l)};switch(i.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return no(i,e,n);case"block-scalar":return to({options:{strict:e}},i,n)}}return null}function Gc(i,e){const{implicitKey:t=!1,indent:n,inFlow:s=!1,offset:a=-1,type:l="PLAIN"}=e,u=Mn({type:l,value:i},{implicitKey:t,indent:n>0?" ".repeat(n):"",inFlow:s,options:{blockQuote:!0,lineWidth:-1}}),h=e.end??[{type:"newline",offset:-1,indent:n,source:`
`}];switch(u[0]){case"|":case">":{const m=u.indexOf(`
`),w=u.substring(0,m),v=u.substring(m+1)+`
`,k=[{type:"block-scalar-header",offset:a,indent:n,source:w}];return ao(k,h)||k.push({type:"newline",offset:-1,indent:n,source:`
`}),{type:"block-scalar",offset:a,indent:n,props:k,source:v}}case'"':return{type:"double-quoted-scalar",offset:a,indent:n,source:u,end:h};case"'":return{type:"single-quoted-scalar",offset:a,indent:n,source:u,end:h};default:return{type:"scalar",offset:a,indent:n,source:u,end:h}}}function Jc(i,e,t={}){let{afterKey:n=!1,implicitKey:s=!1,inFlow:a=!1,type:l}=t,u="indent"in i?i.indent:null;if(n&&typeof u=="number"&&(u+=2),!l)switch(i.type){case"single-quoted-scalar":l="QUOTE_SINGLE";break;case"double-quoted-scalar":l="QUOTE_DOUBLE";break;case"block-scalar":{const m=i.props[0];if(m.type!=="block-scalar-header")throw new Error("Invalid block scalar header");l=m.source[0]===">"?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:l="PLAIN"}const h=Mn({type:l,value:e},{implicitKey:s||u===null,indent:u!==null&&u>0?" ".repeat(u):"",inFlow:a,options:{blockQuote:!0,lineWidth:-1}});switch(h[0]){case"|":case">":Wc(i,h);break;case'"':xi(i,h,"double-quoted-scalar");break;case"'":xi(i,h,"single-quoted-scalar");break;default:xi(i,h,"scalar")}}function Wc(i,e){const t=e.indexOf(`
`),n=e.substring(0,t),s=e.substring(t+1)+`
`;if(i.type==="block-scalar"){const a=i.props[0];if(a.type!=="block-scalar-header")throw new Error("Invalid block scalar header");a.source=n,i.source=s}else{const{offset:a}=i,l="indent"in i?i.indent:-1,u=[{type:"block-scalar-header",offset:a,indent:l,source:n}];ao(u,"end"in i?i.end:void 0)||u.push({type:"newline",offset:-1,indent:l,source:`
`});for(const h of Object.keys(i))h!=="type"&&h!=="offset"&&delete i[h];Object.assign(i,{type:"block-scalar",indent:l,props:u,source:s})}}function ao(i,e){if(e)for(const t of e)switch(t.type){case"space":case"comment":i.push(t);break;case"newline":return i.push(t),!0}return!1}function xi(i,e,t){switch(i.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":i.type=t,i.source=e;break;case"block-scalar":{const n=i.props.slice(1);let s=e.length;i.props[0].type==="block-scalar-header"&&(s-=i.props[0].source.length);for(const a of n)a.offset+=s;delete i.props,Object.assign(i,{type:t,source:e,end:n});break}case"block-map":case"block-seq":{const s={type:"newline",offset:i.offset+e.length,indent:i.indent,source:`
`};delete i.items,Object.assign(i,{type:t,source:e,end:[s]});break}default:{const n="indent"in i?i.indent:-1,s="end"in i&&Array.isArray(i.end)?i.end.filter(a=>a.type==="space"||a.type==="comment"||a.type==="newline"):[];for(const a of Object.keys(i))a!=="type"&&a!=="offset"&&delete i[a];Object.assign(i,{type:t,indent:n,source:e,end:s})}}}const Qc=i=>"type"in i?_s(i):bs(i);function _s(i){switch(i.type){case"block-scalar":{let e="";for(const t of i.props)e+=_s(t);return e+i.source}case"block-map":case"block-seq":{let e="";for(const t of i.items)e+=bs(t);return e}case"flow-collection":{let e=i.start.source;for(const t of i.items)e+=bs(t);for(const t of i.end)e+=t.source;return e}case"document":{let e=bs(i);if(i.end)for(const t of i.end)e+=t.source;return e}default:{let e=i.source;if("end"in i&&i.end)for(const t of i.end)e+=t.source;return e}}}function bs({start:i,key:e,sep:t,value:n}){let s="";for(const a of i)s+=a.source;if(e&&(s+=_s(e)),t)for(const a of t)s+=a.source;return n&&(s+=_s(n)),s}const Vi=Symbol("break visit"),Xc=Symbol("skip children"),oo=Symbol("remove item");function Bt(i,e){"type"in i&&i.type==="document"&&(i={start:i.start,value:i.value}),lo(Object.freeze([]),i,e)}Bt.BREAK=Vi;Bt.SKIP=Xc;Bt.REMOVE=oo;Bt.itemAtPath=(i,e)=>{let t=i;for(const[n,s]of e){const a=t==null?void 0:t[n];if(a&&"items"in a)t=a.items[s];else return}return t};Bt.parentCollection=(i,e)=>{const t=Bt.itemAtPath(i,e.slice(0,-1)),n=e[e.length-1][0],s=t==null?void 0:t[n];if(s&&"items"in s)return s;throw new Error("Parent collection not found")};function lo(i,e,t){let n=t(e,i);if(typeof n=="symbol")return n;for(const s of["key","value"]){const a=e[s];if(a&&"items"in a){for(let l=0;l<a.items.length;++l){const u=lo(Object.freeze(i.concat([[s,l]])),a.items[l],t);if(typeof u=="number")l=u-1;else{if(u===Vi)return Vi;u===oo&&(a.items.splice(l,1),l-=1)}}typeof n=="function"&&s==="key"&&(n=n(e,i))}}return typeof n=="function"?n(e,i):n}const Ds="\uFEFF",Fs="",Ks="",On="",Zc=i=>!!i&&"items"in i,eu=i=>!!i&&(i.type==="scalar"||i.type==="single-quoted-scalar"||i.type==="double-quoted-scalar"||i.type==="block-scalar");function tu(i){switch(i){case Ds:return"<BOM>";case Fs:return"<DOC>";case Ks:return"<FLOW_END>";case On:return"<SCALAR>";default:return JSON.stringify(i)}}function co(i){switch(i){case Ds:return"byte-order-mark";case Fs:return"doc-mode";case Ks:return"flow-error-end";case On:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(i[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}const nu=Object.freeze(Object.defineProperty({__proto__:null,BOM:Ds,DOCUMENT:Fs,FLOW_END:Ks,SCALAR:On,createScalarToken:Gc,isCollection:Zc,isScalar:eu,prettyToken:tu,resolveAsScalar:Yc,setScalarValue:Jc,stringify:Qc,tokenType:co,visit:Bt},Symbol.toStringTag,{value:"Module"}));function Fe(i){switch(i){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}const fa=new Set("0123456789ABCDEFabcdef"),su=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),hs=new Set(",[]{}"),iu=new Set(` ,[]{}
\r	`),Pi=i=>!i||iu.has(i);class uo{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,t=!1){if(e){if(typeof e!="string")throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null}this.atEnd=!t;let n=this.next??"stream";for(;n&&(t||this.hasChars(1));)n=yield*this.parseNext(n)}atLineEnd(){let e=this.pos,t=this.buffer[e];for(;t===" "||t==="	";)t=this.buffer[++e];return!t||t==="#"||t===`
`?!0:t==="\r"?this.buffer[e+1]===`
`:!1}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let t=this.buffer[e];if(this.indentNext>0){let n=0;for(;t===" ";)t=this.buffer[++n+e];if(t==="\r"){const s=this.buffer[n+e+1];if(s===`
`||!s&&!this.atEnd)return e+n+1}return t===`
`||n>=this.indentNext||!t&&!this.atEnd?e+n:-1}if(t==="-"||t==="."){const n=this.buffer.substr(e,3);if((n==="---"||n==="...")&&Fe(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return(typeof e!="number"||e!==-1&&e<this.pos)&&(e=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=e),e===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[e-1]==="\r"&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(e===null)return this.setNext("stream");if(e[0]===Ds&&(yield*this.pushCount(1),e=e.substring(1)),e[0]==="%"){let t=e.length,n=e.indexOf("#");for(;n!==-1;){const a=e[n-1];if(a===" "||a==="	"){t=n-1;break}else n=e.indexOf("#",n+1)}for(;;){const a=e[t-1];if(a===" "||a==="	")t-=1;else break}const s=(yield*this.pushCount(t))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-s),this.pushNewline(),"stream"}if(this.atLineEnd()){const t=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-t),yield*this.pushNewline(),"stream"}return yield Fs,yield*this.parseLineStart()}*parseLineStart(){const e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if(e==="-"||e==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const t=this.peek(3);if((t==="---"||t==="...")&&Fe(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,t==="---"?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!Fe(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[e,t]=this.peek(2);if(!t&&!this.atEnd)return this.setNext("block-start");if((e==="-"||e==="?"||e===":")&&Fe(t)){const n=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=n,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const e=this.getLine();if(e===null)return this.setNext("doc");let t=yield*this.pushIndicators();switch(e[t]){case"#":yield*this.pushCount(e.length-t);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(Pi),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return t+=yield*this.parseBlockScalarHeader(),t+=yield*this.pushSpaces(!0),yield*this.pushCount(e.length-t),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,t,n=-1;do e=yield*this.pushNewline(),e>0?(t=yield*this.pushSpaces(!1),this.indentValue=n=t):t=0,t+=yield*this.pushSpaces(!0);while(e+t>0);const s=this.getLine();if(s===null)return this.setNext("flow");if((n!==-1&&n<this.indentNext&&s[0]!=="#"||n===0&&(s.startsWith("---")||s.startsWith("..."))&&Fe(s[3]))&&!(n===this.indentNext-1&&this.flowLevel===1&&(s[0]==="]"||s[0]==="}")))return this.flowLevel=0,yield Ks,yield*this.parseLineStart();let a=0;for(;s[a]===",";)a+=yield*this.pushCount(1),a+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(a+=yield*this.pushIndicators(),s[a]){case void 0:return"flow";case"#":return yield*this.pushCount(s.length-a),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(Pi),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const l=this.charAt(1);if(this.flowKey||Fe(l)||l===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const e=this.charAt(0);let t=this.buffer.indexOf(e,this.pos+1);if(e==="'")for(;t!==-1&&this.buffer[t+1]==="'";)t=this.buffer.indexOf("'",t+2);else for(;t!==-1;){let a=0;for(;this.buffer[t-1-a]==="\\";)a+=1;if(a%2===0)break;t=this.buffer.indexOf('"',t+1)}const n=this.buffer.substring(0,t);let s=n.indexOf(`
`,this.pos);if(s!==-1){for(;s!==-1;){const a=this.continueScalar(s+1);if(a===-1)break;s=n.indexOf(`
`,a)}s!==-1&&(t=s-(n[s-1]==="\r"?2:1))}if(t===-1){if(!this.atEnd)return this.setNext("quoted-scalar");t=this.buffer.length}return yield*this.pushToIndex(t+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){const t=this.buffer[++e];if(t==="+")this.blockScalarKeep=!0;else if(t>"0"&&t<="9")this.blockScalarIndent=Number(t)-1;else if(t!=="-")break}return yield*this.pushUntil(t=>Fe(t)||t==="#")}*parseBlockScalar(){let e=this.pos-1,t=0,n;e:for(let a=this.pos;n=this.buffer[a];++a)switch(n){case" ":t+=1;break;case`
`:e=a,t=0;break;case"\r":{const l=this.buffer[a+1];if(!l&&!this.atEnd)return this.setNext("block-scalar");if(l===`
`)break}default:break e}if(!n&&!this.atEnd)return this.setNext("block-scalar");if(t>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=t:this.indentNext=this.blockScalarIndent+(this.indentNext===0?1:this.indentNext);do{const a=this.continueScalar(e+1);if(a===-1)break;e=this.buffer.indexOf(`
`,a)}while(e!==-1);if(e===-1){if(!this.atEnd)return this.setNext("block-scalar");e=this.buffer.length}}let s=e+1;for(n=this.buffer[s];n===" ";)n=this.buffer[++s];if(n==="	"){for(;n==="	"||n===" "||n==="\r"||n===`
`;)n=this.buffer[++s];e=s-1}else if(!this.blockScalarKeep)do{let a=e-1,l=this.buffer[a];l==="\r"&&(l=this.buffer[--a]);const u=a;for(;l===" ";)l=this.buffer[--a];if(l===`
`&&a>=this.pos&&a+1+t>u)e=a;else break}while(!0);return yield On,yield*this.pushToIndex(e+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const e=this.flowLevel>0;let t=this.pos-1,n=this.pos-1,s;for(;s=this.buffer[++n];)if(s===":"){const a=this.buffer[n+1];if(Fe(a)||e&&hs.has(a))break;t=n}else if(Fe(s)){let a=this.buffer[n+1];if(s==="\r"&&(a===`
`?(n+=1,s=`
`,a=this.buffer[n+1]):t=n),a==="#"||e&&hs.has(a))break;if(s===`
`){const l=this.continueScalar(n+1);if(l===-1)break;n=Math.max(n,l-2)}}else{if(e&&hs.has(s))break;t=n}return!s&&!this.atEnd?this.setNext("plain-scalar"):(yield On,yield*this.pushToIndex(t+1,!0),e?"flow":"doc")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,t){const n=this.buffer.slice(this.pos,e);return n?(yield n,this.pos+=n.length,n.length):(t&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(Pi))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const e=this.flowLevel>0,t=this.charAt(1);if(Fe(t)||e&&hs.has(t))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let e=this.pos+2,t=this.buffer[e];for(;!Fe(t)&&t!==">";)t=this.buffer[++e];return yield*this.pushToIndex(t===">"?e+1:e,!1)}else{let e=this.pos+1,t=this.buffer[e];for(;t;)if(su.has(t))t=this.buffer[++e];else if(t==="%"&&fa.has(this.buffer[e+1])&&fa.has(this.buffer[e+2]))t=this.buffer[e+=3];else break;return yield*this.pushToIndex(e,!1)}}*pushNewline(){const e=this.buffer[this.pos];return e===`
`?yield*this.pushCount(1):e==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(e){let t=this.pos-1,n;do n=this.buffer[++t];while(n===" "||e&&n==="	");const s=t-this.pos;return s>0&&(yield this.buffer.substr(this.pos,s),this.pos=t),s}*pushUntil(e){let t=this.pos,n=this.buffer[t];for(;!e(n);)n=this.buffer[++t];return yield*this.pushToIndex(t,!1)}}class fo{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let t=0,n=this.lineStarts.length;for(;t<n;){const a=t+n>>1;this.lineStarts[a]<e?t=a+1:n=a}if(this.lineStarts[t]===e)return{line:t+1,col:1};if(t===0)return{line:0,col:e};const s=this.lineStarts[t-1];return{line:t,col:e-s+1}}}}function ot(i,e){for(let t=0;t<i.length;++t)if(i[t].type===e)return!0;return!1}function ha(i){for(let e=0;e<i.length;++e)switch(i[e].type){case"space":case"comment":case"newline":break;default:return e}return-1}function ho(i){switch(i==null?void 0:i.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function ps(i){switch(i.type){case"document":return i.start;case"block-map":{const e=i.items[i.items.length-1];return e.sep??e.start}case"block-seq":return i.items[i.items.length-1].start;default:return[]}}function Ht(i){var t;if(i.length===0)return[];let e=i.length;e:for(;--e>=0;)switch(i[e].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;((t=i[++e])==null?void 0:t.type)==="space";);return i.splice(e,i.length)}function pa(i){if(i.start.type==="flow-seq-start")for(const e of i.items)e.sep&&!e.value&&!ot(e.start,"explicit-key-ind")&&!ot(e.sep,"map-value-ind")&&(e.key&&(e.value=e.key),delete e.key,ho(e.value)?e.value.end?Array.prototype.push.apply(e.value.end,e.sep):e.value.end=e.sep:Array.prototype.push.apply(e.start,e.sep),delete e.sep)}class fr{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new uo,this.onNewLine=e}*parse(e,t=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(const n of this.lexer.lex(e,t))yield*this.next(n);t||(yield*this.end())}*next(e){if(this.source=e,this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=e.length;return}const t=co(e);if(t)if(t==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=t,yield*this.step(),t){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&e[0]===" "&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{const n=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:n,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const e=this.peek(1);if(this.type==="doc-end"&&(!e||e.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}peek(e){return this.stack[this.stack.length-e]}*pop(e){const t=e??this.stack.pop();if(!t)yield{type:"error",offset:this.offset,source:"",message:"Tried to pop an empty stack"};else if(this.stack.length===0)yield t;else{const n=this.peek(1);switch(t.type==="block-scalar"?t.indent="indent"in n?n.indent:0:t.type==="flow-collection"&&n.type==="document"&&(t.indent=0),t.type==="flow-collection"&&pa(t),n.type){case"document":n.value=t;break;case"block-scalar":n.props.push(t);break;case"block-map":{const s=n.items[n.items.length-1];if(s.value){n.items.push({start:[],key:t,sep:[]}),this.onKeyLine=!0;return}else if(s.sep)s.value=t;else{Object.assign(s,{key:t,sep:[]}),this.onKeyLine=!s.explicitKey;return}break}case"block-seq":{const s=n.items[n.items.length-1];s.value?n.items.push({start:[],value:t}):s.value=t;break}case"flow-collection":{const s=n.items[n.items.length-1];!s||s.value?n.items.push({start:[],key:t,sep:[]}):s.sep?s.value=t:Object.assign(s,{key:t,sep:[]});return}default:yield*this.pop(),yield*this.pop(t)}if((n.type==="document"||n.type==="block-map"||n.type==="block-seq")&&(t.type==="block-map"||t.type==="block-seq")){const s=t.items[t.items.length-1];s&&!s.sep&&!s.value&&s.start.length>0&&ha(s.start)===-1&&(t.indent===0||s.start.every(a=>a.type!=="comment"||a.indent<t.indent))&&(n.type==="document"?n.end=s.start:n.items.push({start:s.start}),t.items.splice(-1,1))}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{const e={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&e.start.push(this.sourceToken),this.stack.push(e);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":{ha(e.start)!==-1?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":e.start.push(this.sourceToken);return}const t=this.startBlockValue(e);t?this.stack.push(t):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if(this.type==="map-value-ind"){const t=ps(this.peek(2)),n=Ht(t);let s;e.end?(s=e.end,s.push(this.sourceToken),delete e.end):s=[this.sourceToken];const a={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:n,key:e,sep:s}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=a}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":e.props.push(this.sourceToken);return;case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){var n;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,t.value){const s="end"in t.value?t.value.end:void 0,a=Array.isArray(s)?s[s.length-1]:void 0;(a==null?void 0:a.type)==="comment"?s==null||s.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else if(t.sep)t.sep.push(this.sourceToken);else{if(this.atIndentedComment(t.start,e.indent)){const s=e.items[e.items.length-2],a=(n=s==null?void 0:s.value)==null?void 0:n.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return}if(this.indent>=e.indent){const s=!this.onKeyLine&&this.indent===e.indent,a=s&&(t.sep||t.explicitKey)&&this.type!=="seq-item-ind";let l=[];if(a&&t.sep&&!t.value){const u=[];for(let h=0;h<t.sep.length;++h){const m=t.sep[h];switch(m.type){case"newline":u.push(h);break;case"space":break;case"comment":m.indent>e.indent&&(u.length=0);break;default:u.length=0}}u.length>=2&&(l=t.sep.splice(u[1]))}switch(this.type){case"anchor":case"tag":a||t.value?(l.push(this.sourceToken),e.items.push({start:l}),this.onKeyLine=!0):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"explicit-key-ind":!t.sep&&!t.explicitKey?(t.start.push(this.sourceToken),t.explicitKey=!0):a||t.value?(l.push(this.sourceToken),e.items.push({start:l,explicitKey:!0})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken],explicitKey:!0}]}),this.onKeyLine=!0;return;case"map-value-ind":if(t.explicitKey)if(t.sep)if(t.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(ot(t.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:l,key:null,sep:[this.sourceToken]}]});else if(ho(t.key)&&!ot(t.sep,"newline")){const u=Ht(t.start),h=t.key,m=t.sep;m.push(this.sourceToken),delete t.key,delete t.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:u,key:h,sep:m}]})}else l.length>0?t.sep=t.sep.concat(l,this.sourceToken):t.sep.push(this.sourceToken);else if(ot(t.start,"newline"))Object.assign(t,{key:null,sep:[this.sourceToken]});else{const u=Ht(t.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:u,key:null,sep:[this.sourceToken]}]})}else t.sep?t.value||a?e.items.push({start:l,key:null,sep:[this.sourceToken]}):ot(t.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const u=this.flowScalar(this.type);a||t.value?(e.items.push({start:l,key:u,sep:[]}),this.onKeyLine=!0):t.sep?this.stack.push(u):(Object.assign(t,{key:u,sep:[]}),this.onKeyLine=!0);return}default:{const u=this.startBlockValue(e);if(u){if(u.type==="block-seq"){if(!t.explicitKey&&t.sep&&!ot(t.sep,"newline")){yield*this.pop({type:"error",offset:this.offset,message:"Unexpected block-seq-ind on same line with key",source:this.source});return}}else s&&e.items.push({start:l});this.stack.push(u);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){var n;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(t.value){const s="end"in t.value?t.value.end:void 0,a=Array.isArray(s)?s[s.length-1]:void 0;(a==null?void 0:a.type)==="comment"?s==null||s.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(t.start,e.indent)){const s=e.items[e.items.length-2],a=(n=s==null?void 0:s.value)==null?void 0:n.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return;case"anchor":case"tag":if(t.value||this.indent<=e.indent)break;t.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==e.indent)break;t.value||ot(t.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return}if(this.indent>e.indent){const s=this.startBlockValue(e);if(s){this.stack.push(s);return}}yield*this.pop(),yield*this.step()}*flowCollection(e){const t=e.items[e.items.length-1];if(this.type==="flow-error-end"){let n;do yield*this.pop(),n=this.peek(1);while(n&&n.type==="flow-collection")}else if(e.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!t||t.sep?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return;case"map-value-ind":!t||t.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!t||t.value?e.items.push({start:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const s=this.flowScalar(this.type);!t||t.value?e.items.push({start:[],key:s,sep:[]}):t.sep?this.stack.push(s):Object.assign(t,{key:s,sep:[]});return}case"flow-map-end":case"flow-seq-end":e.end.push(this.sourceToken);return}const n=this.startBlockValue(e);n?this.stack.push(n):(yield*this.pop(),yield*this.step())}else{const n=this.peek(2);if(n.type==="block-map"&&(this.type==="map-value-ind"&&n.indent===e.indent||this.type==="newline"&&!n.items[n.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&n.type!=="flow-collection"){const s=ps(n),a=Ht(s);pa(e);const l=e.end.splice(1,e.end.length);l.push(this.sourceToken);const u={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:a,key:e,sep:l}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=u}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const t=ps(e),n=Ht(t);return n.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:n,explicitKey:!0}]}}case"map-value-ind":{this.onKeyLine=!0;const t=ps(e),n=Ht(t);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:n,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,t){return this.type!=="comment"||this.indent<=t?!1:e.every(n=>n.type==="newline"||n.type==="space")}*documentEnd(e){this.type!=="doc-mode"&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;case"space":case"comment":default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}}function po(i){const e=i.prettyErrors!==!1;return{lineCounter:i.lineCounter||e&&new fo||null,prettyErrors:e}}function ru(i,e={}){const{lineCounter:t,prettyErrors:n}=po(e),s=new fr(t==null?void 0:t.addNewLine),a=new dr(e),l=Array.from(a.compose(s.parse(i)));if(n&&t)for(const u of l)u.errors.forEach(Is(i,t)),u.warnings.forEach(Is(i,t));return l.length>0?l:Object.assign([],{empty:!0},a.streamInfo())}function mo(i,e={}){const{lineCounter:t,prettyErrors:n}=po(e),s=new fr(t==null?void 0:t.addNewLine),a=new dr(e);let l=null;for(const u of a.compose(s.parse(i),!0,i.length))if(!l)l=u;else if(l.options.logLevel!=="silent"){l.errors.push(new Lt(u.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return n&&t&&(l.errors.forEach(Is(i,t)),l.warnings.forEach(Is(i,t))),l}function au(i,e,t){let n;typeof e=="function"?n=e:t===void 0&&e&&typeof e=="object"&&(t=e);const s=mo(i,t);if(!s)return null;if(s.warnings.forEach(a=>Pa(s.options.logLevel,a)),s.errors.length>0){if(s.options.logLevel!=="silent")throw s.errors[0];s.errors=[]}return s.toJS(Object.assign({reviver:n},t))}function ou(i,e,t){let n=null;if(typeof e=="function"||Array.isArray(e)?n=e:t===void 0&&e&&(t=e),typeof t=="string"&&(t=t.length),typeof t=="number"){const s=Math.round(t);t=s<1?void 0:s>8?{indent:8}:{indent:s}}if(i===void 0){const{keepUndefined:s}=t??e??{};if(!s)return}return Ot(i)&&!n?i.toString(t):new ln(i,n,t).toString(t)}const Ni=Object.freeze(Object.defineProperty({__proto__:null,Alias:Es,CST:nu,Composer:dr,Document:ln,Lexer:uo,LineCounter:fo,Pair:Ee,Parser:fr,Scalar:ne,Schema:$s,YAMLError:cr,YAMLMap:xe,YAMLParseError:Lt,YAMLSeq:ut,YAMLWarning:Za,isAlias:ft,isCollection:ye,isDocument:Ot,isMap:sn,isNode:ve,isPair:ge,isScalar:fe,isSeq:rn,parse:au,parseAllDocuments:ru,parseDocument:mo,stringify:ou,visit:Mt,visitAsync:Cs},Symbol.toStringTag,{value:"Module"})),Ze="uncategorized";async function lu(){try{await $.global_taskLists.get(Ze)||await $.global_taskLists.put({id:Ze,name:"未分类"})}catch(i){console.error("Failed to initialize default task list:",i)}}async function Jt(){try{return await $.global_taskLists.toArray()}catch(i){return console.error("Failed to get all task lists:",i),[]}}async function go(i){const t={id:Ve(),name:i.trim()};return await $.global_taskLists.add(t),t}async function cu(i,e){if(i===Ze)throw new Error("无法重命名默认的“未分类”列表。");const t=e.trim(),n=await $.global_taskLists.where("name").equals(t).first();if(n&&n.id!==i)throw new Error(`名称 "${t}" 已存在。`);await $.global_taskLists.update(i,{name:t})}async function uu(i){if(i===Ze)throw new Error("无法删除默认的“未分类”列表。");await $.transaction("rw",$.global_taskLists,$.task_tasks,async()=>{const e=await $.task_tasks.where("listId").equals(i).primaryKeys();e.length>0&&await $.task_tasks.where("uuid").anyOf(e).modify({listId:Ze}),await $.global_taskLists.delete(i)})}const du=/^::>\s*(?:\[([a-zA-Z0-9_]+)\])?\s*(.*)\n?((?:^[ \t]{4,}.*\n?)*)/gm;class Ct{static parseMarkdownToYaml(e){const t={},n=new Set;let s=e;const a=new RegExp(du);let l;for(;(l=a.exec(e))!==null;){const[u,h,m,w]=l,v=h||m.trim().toLowerCase().replace(/\s+/g,"_");if(n.has(v))return{success:!1,error:`字段名 "${v}" 重复。请确保每个折叠块的字段名唯一。`};if(n.add(v),v==="priority"){const k=m.match(/:\s*(\d+)/);t[v]=k?parseInt(k[1],10):1}else t[v]=w.split(`
`).map(k=>k.substring(4)).join(`
`).trim();s=s.replace(u,"")}return t.details=s.trim(),{success:!0,data:t}}static parseYamlToMarkdown(e){let t=e.details||"";const n=["note","reason"];for(const s of n)if(e[s]&&String(e[s]).trim()){const a=s.charAt(0).toUpperCase()+s.slice(1),l=String(e[s]).split(`
`).map(u=>`    ${u}`).join(`
`);t+=`

::> [${s}]${a}
${l}`}e.priority&&(t+=`

::> [priority]Priority: ${e.priority}`);for(const s in e)if(!["details","note","reason","priority","tags","title","uuid","subject","review"].includes(s)&&e[s]&&String(e[s]).trim()){const a=String(e[s]).split(`
`).map(l=>`    ${l}`).join(`
`);t+=`

::> [${s}]${s}
${a}`}return t.trim()}}class fu{constructor(){this.state={tasks:[],taskLists:[],filters:{listId:"all",tags:[],status:"active",date:null,searchTerm:"",sortBy:"due_date"},currentPage:1,pageSize:10,selectedTaskId:null,selectedTaskIds:new Set,isSidebarVisible:!0,mainViewMode:"editor",markdownContent:"",editorSelection:{start:0,end:0,text:"",hasSelection:!1},previewSelection:{text:"",hasSelection:!1,timestamp:0},isLoading:!0,isTaskModalVisible:!1,taskModalContext:{mode:"create",tempContent:""},isTagModalVisible:!1,isReviewMode:!1,currentReviewTask:null},this.listeners=new Set}subscribe(e,t){const n={callback:e,keys:t?new Set(t):null};return this.listeners.add(n),()=>this.listeners.delete(n)}setState(e){const t={...this.state},n=Object.keys(e).filter(s=>this.state[s]!==e[s]);n.length!==0&&(this.state={...this.state,...e},this.notify(t,this.state,n))}notify(e,t,n){const s=new Set(n);this.listeners.forEach(a=>{(!a.keys||[...a.keys].some(l=>s.has(l)))&&a.callback(t,e)})}getState(){return{...this.state}}getFilteredTasks(){const{tasks:e,filters:t}=this.state,n=new Date,s=new Date(n).setHours(0,0,0,0),a=new Date(n).setHours(23,59,59,999),l=new Date(n);l.setDate(n.getDate()+7);let u=e.filter(h=>{var w;const m=t.searchTerm.toLowerCase();if(m){const v=h.title.toLowerCase().includes(m),k=(h.details||"").toLowerCase().includes(m);if(!v&&!k)return!1}if(t.listId!=="all"&&h.listId!==t.listId||t.tags.length>0&&!t.tags.every(v=>{var k;return(k=h.tags)==null?void 0:k.includes(v)})||t.status==="active"&&!["todo","in_progress"].includes(h.status)||t.status==="completed"&&h.status!=="completed")return!1;if(t.date){const v=(w=h.review)==null?void 0:w.due;if(!v||t.date==="today"&&(v<s||v>a)||t.date==="upcoming"&&(v<s||v>l))return!1}return!0});return u.sort((h,m)=>{var w,v;switch(t.sortBy){case"priority":return(m.priority||1)-(h.priority||1);case"title":return h.title.localeCompare(m.title);case"due_date":default:return(((w=h.review)==null?void 0:w.due)||1/0)-(((v=m.review)==null?void 0:v.due)||1/0)}}),u}getPagedTasks(){const e=this.getFilteredTasks(),t=(this.state.currentPage-1)*this.state.pageSize;return e.slice(t,t+this.state.pageSize)}getTotalPages(){return Math.ceil(this.getFilteredTasks().length/this.state.pageSize)}getDueTasksCount(){const e=Date.now();return this.getFilteredTasks().filter(t=>["todo","in_progress"].includes(t.status)&&t.review&&t.review.due&&t.review.due<=e).length}getStatistics(){const e=this.getFilteredTasks(),{taskLists:t}=this.state,n=new Map(t.map(u=>[u.id,u.name]));n.set(Ze,"未分类");const s={total:e.length,byListName:{},byReason:{},dueToday:0,overdue:0},a=new Date;a.setHours(23,59,59,999);const l=new Date;return l.setHours(0,0,0,0),e.forEach(u=>{const h=n.get(u.listId)||"未分类";s.byListName[h]=(s.byListName[h]||0)+1;const m=u.reason||"未知原因";if(s.byReason[m]=(s.byReason[m]||0)+1,u.review&&u.review.due){const w=new Date(u.review.due);w<l?s.overdue++:w<=a&&s.dueToday++}}),s}setPreviewSelection(e){const t=!!(e&&e.trim().length>0);this.setState({previewSelection:{text:t?e.trim():"",hasSelection:t,timestamp:Date.now()}})}async initialize(){this.setState({isLoading:!0}),await lu();const[e,t]=await Promise.all([sl(),Jt()]);this.setState({tasks:e,taskLists:t,filters:{listId:"all",tags:[],status:"active",date:null,searchTerm:"",sortBy:"due_date"},isLoading:!1})}async createNewTask(){this.state.selectedTaskId==="new"||!await this.promptIfUnsaved()||this.setState({selectedTaskId:"new",markdownContent:`details: 

::> [note]Note
    

::> [reason]Reason
    

::> [priority]Priority: 1`,mainViewMode:"editor",isTaskModalVisible:!0,taskModalContext:{mode:"create",tempContent:""}})}async saveCurrentTask(){const{selectedTaskId:e,markdownContent:t,tasks:n}=this.state;if(!e||e==="new")return{success:!1,reason:"not_selected"};const s=Ct.parseMarkdownToYaml(t);if(!s.success)return alert(`保存失败: ${s.error}`),{success:!1,error:s.error};const l={...n.find(h=>h.uuid===e),...s.data};await _t(l);const u=n.map(h=>h.uuid===e?l:h);return this.setState({tasks:u}),{success:!0}}async commitTask(e,t,n){if(!n){alert("创建失败：必须选择一个任务列表。");return}const{tempContent:s}=this.state.taskModalContext,a=s||this.state.markdownContent,l=Ct.parseMarkdownToYaml(a);if(!l.success){alert(`创建失败: ${l.error}`);return}const u=this._normalizeTask({...l.data,title:e,tags:t},n);await _t(u);const h=[...this.state.tasks,u];this.setState({tasks:h,selectedTaskId:u.uuid,markdownContent:Ct.parseYamlToMarkdown(u),isTaskModalVisible:!1})}async updateTaskStatus(e,t){const n=this.state.tasks.find(l=>l.uuid===e);if(!n||n.status===t)return;const s={...n,status:t};["completed","archived"].includes(t)?s.review=null:!n.review&&["todo","in_progress"].includes(t)&&(s.review={due:Date.now(),interval:0,easeFactor:2.5,state:"new"}),await _t(s);const a=this.state.tasks.map(l=>l.uuid===e?s:l);this.setState({tasks:a})}async setSelectedTask(e){if(this.state.selectedTaskId===e||!await this.promptIfUnsaved())return;const n=this.state.tasks.find(s=>s.uuid===e);this.setState({selectedTaskId:e,markdownContent:n?Ct.parseYamlToMarkdown(n):""})}exportFilteredTasks(){const e=this.getFilteredTasks();if(e.length===0){alert("当前筛选条件下没有可导出的任务。");return}const t=e.map(h=>this._taskToExportable(h)),n=this.state.filters.tags.length>0?this.state.filters.tags.join("_"):"all_tasks",s=Ni.stringify({subject:n,tasks:t}),a=new Blob([s],{type:"text/yaml;charset=utf-8"}),l=URL.createObjectURL(a),u=document.createElement("a");u.href=l,u.download=`tasks-export-${n}.yaml`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(l)}async importTasks(e){try{const t=Ni.parse(e);if(!t||!Array.isArray(t.tasks))throw new Error("YAML格式无效，必须包含 'tasks' 数组。");const n=new Map(this.state.taskLists.map(u=>[u.name,u.id])),s=[];let a=!1;for(const u of t.tasks){let h=Ze;const m=u.listName||u.subject;if(m)if(n.has(m))h=n.get(m);else{const v=await go(m);n.set(v.name,v.id),h=v.id,a=!0}const w=this._normalizeTask(u,h);s.push(w)}if(s.length===0){alert("文件中没有找到可导入的任务。");return}await il([...this.state.tasks,...s]);const l={tasks:[...this.state.tasks,...s]};a&&(l.taskLists=await Jt()),this.setState(l),alert(`成功导入 ${s.length} 个任务！`)}catch(t){console.error("Failed to import from YAML:",t),alert(`导入失败: ${t.message}`)}}async promptIfUnsaved(){const{selectedTaskId:e,markdownContent:t,tasks:n}=this.state;if(!e)return!0;const s=t.trim();let a="";if(e==="new"){if(s.length>0)return confirm("您正在编辑一个新任务，切换将丢失未保存的进度。是否继续？")}else{const l=n.find(u=>u.uuid===e);if(l&&(a=Ct.parseYamlToMarkdown(l).trim(),s!==a))return confirm("当前任务有未保存的更改，切换将丢失这些更改。是否继续？")}return!0}showTagModal(){!this.state.selectedTaskId||this.state.selectedTaskId==="new"||this.setState({isTagModalVisible:!0})}async saveTagsForSelectedTask(e){const{selectedTaskId:t,tasks:n}=this.state,s=n.findIndex(h=>h.uuid===t);if(s===-1)return;const a={...n[s],tags:e};await _t(a);const l=n.map(h=>h.uuid===t?a:h),u=this._buildTaxonomy(l);this.setState({tasks:l,taxonomy:u,isTagModalVisible:!1,markdownContent:this.state.selectedTaskId===t?Ct.parseYamlToMarkdown(a):this.state.markdownContent})}toggleTaskSelection(e){const t=new Set(this.state.selectedTaskIds);t.has(e)?t.delete(e):t.add(e),this.setState({selectedTaskIds:t})}selectAllTasks(){const e=this.getFilteredTasks().map(t=>t.uuid);this.setState({selectedTaskIds:new Set(e)})}deselectAllTasks(){this.setState({selectedTaskIds:new Set})}async renameTask(e,t){if(!t||!t.trim())return;const n=[...this.state.tasks],s=n.findIndex(l=>l.uuid===e);if(s===-1)return;const a={...n[s],title:t.trim()};n[s]=a,this.setState({tasks:n}),await _t(a)}async deleteTasks(e){if(!e||e.length===0||!confirm(`确定要删除选中的 ${e.length} 个任务吗？`))return;await rl(e);const t=this.state.tasks.filter(a=>!e.includes(a.uuid)),n=this._buildTaxonomy(t),s={tasks:t,taxonomy:n,selectedTaskIds:new Set};e.includes(this.state.selectedTaskId)&&(s.selectedTaskId=null,s.markdownContent=""),this.setState(s)}_normalizeTask(e,t){return{uuid:e.uuid||crypto.randomUUID(),title:e.title||"无标题任务",tags:e.tags||[],status:e.status||"todo",listId:t,details:e.details||"",note:e.note||"",reason:e.reason||"",priority:e.priority||1,review:e.review===void 0?{due:Date.now(),interval:0,easeFactor:2.5,state:"new"}:e.review}}_buildTaxonomy(e){const t={};return e.forEach(n=>{var a;const s=n.subject||"未分类";t[s]||(t[s]={tags:new Set,reasons:new Set}),(a=n.tags)==null||a.forEach(l=>t[s].tags.add(l)),n.reason&&t[s].reasons.add(n.reason)}),t}_taskToYAML(e){if(!e)return"";const{uuid:t,title:n,subject:s,review:a,...l}=e;return Ni.stringify(l)}_taskToExportable(e){var h;const{uuid:t,listId:n,review:s,...a}=e,l=(h=this.state.taskLists.find(m=>m.id===n))==null?void 0:h.name,u={...a};return l&&n!==Ze&&(u.listName=l),u}async rateTask(e,t){const n=[...this.state.tasks],s=n.find(a=>a.uuid===e);s&&(s.review={...s.review,...ba(s.review,t)},s.lastReviewed=Date.now(),await _t(s),this.setState({tasks:n}))}async editSelectedTaskTags(){const{selectedTaskId:e,tasks:t}=this.state;if(!e||e==="new"){alert("请先在列表中选择一个已保存的任务。");return}const n=t.find(w=>w.uuid===e);if(!n)return;const s=n.tags?n.tags.join(", "):"",a=prompt("请输入新的标签，用逗号分隔：",s);if(a===null)return;const l=a.trim()===""?[]:a.split(",").map(w=>w.trim()).filter(Boolean),u={...n,tags:l},h=this.state.tasks.map(w=>w.uuid===e?u:w),m=this._buildTaxonomy(h);this.setState({tasks:h,taxonomy:m,markdownContent:Ct.parseYamlToMarkdown(u)}),await _t(u)}setFilters(e){let t={...this.state.filters,...e};"date"in e&&e.date!==null&&(t.status=null),"status"in e&&e.status!==null&&(t.date=null),t.date===null&&t.status===null&&(t.status="active"),this.setState({filters:t,currentPage:1})}setCurrentPage(e){this.setState({currentPage:e})}toggleSidebar(){this.setState({isSidebarVisible:!this.state.isSidebarVisible})}toggleMainViewMode(){this.setState({mainViewMode:this.state.mainViewMode==="editor"?"preview":"editor"})}async startReview(){const e=this.getFilteredTasks().filter(t=>new Date(t.review.due)<=new Date);if(e.length===0){alert("暂无需要待办的任务！");return}this.setState({isReviewMode:!0,reviewQueue:e,reviewIndex:0,currentReviewTask:e[0]})}async rateCurrentTask(e){const{currentReviewTask:t,reviewQueue:n,reviewIndex:s}=this.state;if(!t)return;await this.rateTask(t.uuid,e);const a=s+1;a>=n.length?(this.setState({isReviewMode:!1,currentReviewTask:null,reviewQueue:[],reviewIndex:0}),alert("待办完成！")):this.setState({reviewIndex:a,currentReviewTask:n[a]})}exitReview(){this.setState({isReviewMode:!1,currentReviewTask:null,reviewQueue:[],reviewIndex:0})}}const hu=new fu;class pu{constructor(e){this.store=e,this.dom={dashboard:document.getElementById("task_statsDashboard")},this.unsubscribe=e.subscribe(this.render.bind(this),["tasks","filters","taskLists"])}render(){const e=this.store.getStatistics(),t=e.byListName?Object.entries(e.byListName).sort((a,l)=>l[1]-a[1]).slice(0,3):[],n=e.byReason?Object.entries(e.byReason).sort((a,l)=>l[1]-a[1]).slice(0,3):[],s=a=>!a||a.length===0?"<span>暂无数据</span>":a.map(([l,u])=>`<div class="list-item"><span>${l}</span><span class="list-value">${u}</span></div>`).join("");this.dom.dashboard.innerHTML=`
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-chart-line"></i> 待办状态</div>
                <div class="stats-card-body">
                    <div class="stat-item"><span class="stat-value overdue">${e.overdue}</span><span class="stat-label">已过期</span></div>
                    <div class="stat-item"><span class="stat-value today">${e.dueToday}</span><span class="stat-label">今日到期</span></div>
                    <div class="stat-item"><span class="stat-value">${e.total}</span><span class="stat-label">总数</span></div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-book"></i> 任务分布 (按列表)</div>
                <div class="stats-card-body list-style">${s(t)}</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-diagnoses"></i> 主要原因</div>
                <div class="stats-card-body list-style">${s(n)}</div>
            </div>`}destroy(){this.unsubscribe()}}class mu{constructor(e){this.store=e,this.dom={searchInput:document.getElementById("task_searchInput"),quickFiltersContainer:document.getElementById("task_quickFilters"),sortBySelect:document.getElementById("task_sortBy"),listFilterContainer:document.getElementById("task_list_filter_container"),tagFilterContainer:document.getElementById("task_tag_filter_container")},this.searchDebounceTimer=null,this.unsubscribe=e.subscribe(this.render.bind(this),["filters","taskLists","tasks"]),this.setupEventListeners()}setupEventListeners(){this.dom.searchInput.addEventListener("input",e=>{clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=setTimeout(()=>{this.store.setFilters({searchTerm:e.target.value})},300)}),this.dom.quickFiltersContainer.addEventListener("click",e=>{e.preventDefault();const t=e.target.closest(".quick-filter-item");if(t){const n=t.dataset.filterType,s=t.dataset.filterValue;this.store.getState().filters[n]===s?this.store.setFilters({[n]:null}):this.store.setFilters({[n]:s})}}),this.dom.listFilterContainer.addEventListener("click",e=>{const t=e.target.closest(".tag");t&&this.store.setFilters({listId:t.dataset.id})}),this.dom.tagFilterContainer.addEventListener("click",e=>{const t=e.target.closest(".tag");if(t){const n=t.dataset.id,s=[...this.store.getState().filters.tags],a=s.indexOf(n);a>-1?s.splice(a,1):s.push(n),this.store.setFilters({tags:s})}}),this.dom.sortBySelect.addEventListener("change",e=>{this.store.setFilters({sortBy:e.target.value})})}render(e){const{filters:t,tasks:n,taskLists:s}=e;this.dom.searchInput.value!==t.searchTerm&&(this.dom.searchInput.value=t.searchTerm),this.dom.quickFiltersContainer.querySelectorAll(".quick-filter-item").forEach(m=>{const w=m.dataset.filterType,v=m.dataset.filterValue;m.classList.toggle("active",t[w]===v)}),this.dom.sortBySelect.value=t.sortBy;const a=n.reduce((m,w)=>(m[w.listId]=(m[w.listId]||0)+1,m),{});let l=`<button class="tag ${t.listId==="all"?"active":""}" data-id="all">全部 <span class="tag-count">${n.length}</span></button>`;s.forEach(m=>{l+=`<button class="tag ${t.listId===m.id?"active":""}" data-id="${m.id}">${m.name} <span class="tag-count">${a[m.id]||0}</span></button>`}),this.dom.listFilterContainer.innerHTML=l;const u=[...new Set(n.flatMap(m=>m.tags||[]))].sort(),h=n.flatMap(m=>m.tags||[]).reduce((m,w)=>(m[w]=(m[w]||0)+1,m),{});this.dom.tagFilterContainer.innerHTML=u.map(m=>`
            <button class="tag ${t.tags.includes(m)?"active":""}" data-id="${m}">
                ${m} <span class="tag-count">${h[m]||0}</span>
            </button>
        `).join("")}destroy(){this.unsubscribe()}}class gu{constructor(e){this.store=e,this.dom={container:document.getElementById("task_list")},this.unsubscribe=e.subscribe(this.render.bind(this),["tasks","taskLists","filters","currentPage","selectedTaskId","selectedTaskIds"]),this.setupEventListeners()}setupEventListeners(){this.dom.container.addEventListener("click",e=>{const t=e.target.closest(".task-item");if(!t)return;const n=t.dataset.id;if(!(!n||n==="new")){if(e.target.matches(".task-status-checkbox")){const s=e.target.checked?"completed":"todo";this.store.updateTaskStatus(n,s);return}if(e.target.matches(".edit-btn")){const s=t.querySelector(".item-title").textContent.trim(),a=prompt("输入新的任务名称:",s);a&&this.store.renameTask(n,a);return}if(e.target.matches(".delete-btn")){this.store.deleteTasks([n]);return}this.store.setSelectedTask(n)}})}render(){const{selectedTaskId:e,selectedTaskIds:t,taskLists:n}=this.store.getState(),s=this.store.getPagedTasks(),a=new Map(n.map(u=>[u.id,u.name]));let l="";e==="new"&&(l+=`<li class="session-item task-item active creating" data-id="new">
            <div class="task-item-main">
                <div class="task-item-header">
                    <div class="task-priority-indicator creating"></div>
                    <div class="item-title creating-title">
                        <i class="fas fa-plus-circle"></i>
                        <span>正在创建新任务...</span>
                    </div>
                </div>
                <div class="item-meta">
                    <span class="meta-badge creating">草稿</span>
                </div>
            </div>
        </li>`),s.length>0&&(l+=s.map(u=>{var V;const{className:h,text:m,icon:w,color:v}=this._getDueDateStatus((V=u.review)==null?void 0:V.due),k=t.has(u.uuid),B=u.uuid===e,F=u.status==="completed",O=u.tags&&u.tags.length>0?`<div class="item-tags-container">
                       ${u.tags.slice(0,2).map(G=>{const Q=ol(G);return`<span class="item-tag" style="background-color: ${Q.backgroundColor}; color: ${Q.color};" title="${ce(G)}">${ce(G)}</span>`}).join("")}
                       ${u.tags.length>2?`<span class="item-tag-more" title="还有 ${u.tags.length-2} 个标签">+${u.tags.length-2}</span>`:""}
                   </div>`:"",N=a.get(u.listId)||"未分类";return`
                <li class="list-item session-item task-item ${B?"active":""} ${k?"selected":""} ${F?"completed":""}" data-id="${u.uuid}">
                    <div class="task-item-main">
                        <div class="task-item-header">
                            <input type="checkbox" class="task-status-checkbox" ${F?"checked":""} title="标记为完成/待办">
                            <div class="item-title" title="${ce(u.title)}">
                                ${ce(u.title)}
                            </div>
                        </div>
                        
                        ${O}
                    
                        <div class="item-meta">
                            <span class="meta-badge due-status ${h}" style="color: ${v};" title="到期状态">
                                <i class="${w}"></i>
                                <span>${m}</span>
                            </span>
                            <span class="meta-badge subject" title="任务列表">
                                <i class="fas fa-list-ul"></i>
                                <span>${ce(N)}</span>
                            </span>
                            ${u.priority&&u.priority>1?`<span class="meta-badge priority" title="优先级">
                                <i class="fas fa-flag"></i>
                                <span>P${u.priority}</span>
                            </span>`:""}
                        </div>
                    </div>
                    
                    <div class="task-actions">
                        <button class="action-btn edit-btn" title="重命名任务">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="action-btn delete-btn" title="删除任务">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>`}).join("")),l===""?this.dom.container.innerHTML=`
                <li class="session-item-placeholder">
                    <div class="placeholder-content">
                        <i class="fas fa-inbox"></i>
                        <h3>暂无任务</h3>
                        <p>没有符合当前筛选条件的任务。</p>
                    </div>
                </li>`:this.dom.container.innerHTML=l}_getDueDateStatus(e){if(!e)return{className:"status-new",text:"新任务",icon:"fas fa-star",color:"#6366f1"};const t=Math.ceil((new Date(e).setHours(0,0,0,0)-new Date().setHours(0,0,0,0))/864e5);return t<0?{className:"status-overdue",text:`逾期 ${-t} 天`,icon:"fas fa-exclamation-triangle",color:"#ef4444"}:t===0?{className:"status-today",text:"今日到期",icon:"fas fa-clock",color:"#f59e0b"}:t<=3?{className:"status-soon",text:`${t} 天后`,icon:"fas fa-calendar-day",color:"#f59e0b"}:{className:"status-future",text:`${t} 天后`,icon:"fas fa-calendar",color:"#6b7280"}}destroy(){this.unsubscribe()}}class yu{constructor(e){this.store=e,this.dom={container:document.getElementById("task_previewContainer")},this.unsubscribe=e.subscribe(this.handleStateChange.bind(this),["mainViewMode","markdownContent","selectedTaskId"]),this.setupEventListeners()}setupEventListeners(){this.dom.container.addEventListener("mouseup",this.handleSelection.bind(this)),this.dom.container.addEventListener("click",e=>{const t=e.target.closest(".task-card");if(!t)return;e.target.matches(".show-answer-btn")&&(t.querySelector(".answer-section").classList.remove("hidden"),e.target.classList.add("hidden"));const n=e.target.closest(".review-btn");n&&this.store.rateTask(t.dataset.id,parseInt(n.dataset.rating,10))})}handleSelection(e){if(e.target.closest(".review-btn, .show-answer-btn, a, button"))return;const t=window.getSelection().toString();this.store.setPreviewSelection(t)}handleStateChange(e,t){this.render(e),e.selectedTaskId&&e.selectedTaskId!==t.selectedTaskId&&requestAnimationFrame(()=>{const n=this.dom.container.querySelector(`.task-card[data-id="${e.selectedTaskId}"]`);n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("highlight"),setTimeout(()=>n.classList.remove("highlight"),1500))})}async render(e){if(e.mainViewMode!=="preview")return;const{markdownContent:t}=e;if(!t||!t.trim()){this.dom.container.innerHTML='<div class="empty-preview"><p>没有内容可供预览</p></div>';return}await Cn.render(this.dom.container,t,{})}destroy(){this.unsubscribe()}}class vu{constructor(e){this.store=e,this.dom={editor:document.getElementById("task_yamlEditor")},this.currentSelection={start:0,end:0,text:""},this.unsubscribe=e.subscribe(this.render.bind(this),["markdownContent","selectedTaskId"]),this.setupEventListeners()}setupEventListeners(){this.dom.editor.addEventListener("input",e=>this.store.setState({markdownContent:e.target.value})),this.dom.editor.addEventListener("select",()=>this.updateSelection()),this.dom.editor.addEventListener("keyup",()=>this.updateSelection()),this.dom.editor.addEventListener("mouseup",()=>this.updateSelection()),this.dom.editor.addEventListener("focus",()=>this.updateSelection())}updateSelection(){const e=this.dom.editor.selectionStart,t=this.dom.editor.selectionEnd,n=this.dom.editor.value.substring(e,t);this.store.setState({editorSelection:{start:e,end:t,text:n.trim(),hasSelection:e!==t}})}render({markdownContent:e,selectedTaskId:t}){this.dom.editor.value!==e&&(this.dom.editor.value=e),this.dom.editor.disabled=!t}destroy(){this.unsubscribe()}}class bu{constructor(e){this.store=e,this.dom={container:document.getElementById("task_paginationContainer")},this.unsubscribe=e.subscribe(this.render.bind(this),["tasks","filters","currentPage"]),this.setupEventListeners()}setupEventListeners(){this.dom.container.addEventListener("click",e=>{const t=e.target.closest(".page-btn");if(t&&!t.classList.contains("active")){const n=parseInt(t.dataset.page,10);this.store.setCurrentPage(n)}})}render(){const e=this.store.getTotalPages(),{currentPage:t}=this.store.getState();if(e<=1){this.dom.container.innerHTML="";return}let n="";for(let s=1;s<=e;s++)n+=`
                <button class="page-btn ${s===t?"active":""}" data-page="${s}">
                    ${s}
                </button>
            `;this.dom.container.innerHTML=n}destroy(){this.unsubscribe()}}class wu{constructor(e){this.store=e,this.dom={sidebar:document.querySelector("#task-view .task_session-sidebar"),mainPanel:document.getElementById("task_mainPanel"),toggleSidebarBtn:document.getElementById("task_toggleSessionBtn"),toggleViewBtn:document.getElementById("task_toggleViewBtn"),startReviewBtn:document.getElementById("task_startReviewBtn"),manageTagsBtn:document.getElementById("task_manageTagsBtn"),saveBtn:document.getElementById("task_saveBtn"),exportBtn:document.getElementById("task_exportBtn"),printPreviewBtn:document.getElementById("task_printPreviewBtn"),importBtn:document.getElementById("task_importBtn"),importInput:document.getElementById("task_yamlImportInput"),createTaskBtn:document.getElementById("task_createTaskBtn"),aiBtn:document.getElementById("task_aiBtn"),deleteSelectedBtn:document.getElementById("task_deleteSelectedBtn"),selectAllCheckbox:document.getElementById("task_selectAllCheckbox"),statusSelector:document.getElementById("task_statusSelector"),panelTitle:document.getElementById("task_panelTitle"),reviewCount:document.getElementById("task_reviewCount")},this.unsubscribe=e.subscribe(this.handleStateChange.bind(this),["isSidebarVisible","mainViewMode","selectedTaskId","tasks","filters","selectedTaskIds","editorSelection","previewSelection"]),this.setupEventListeners(),this.updateTagButtonDisplay()}setupEventListeners(){this.dom.toggleSidebarBtn.addEventListener("click",()=>{this.store.toggleSidebar()}),this.dom.toggleViewBtn.addEventListener("click",()=>{this.store.toggleMainViewMode()}),this.dom.startReviewBtn.addEventListener("click",()=>{this.store.startReview()}),this.dom.manageTagsBtn.addEventListener("click",()=>{this.store.showTagModal()}),this.dom.createTaskBtn.addEventListener("click",()=>{this.store.createNewTask()}),this.dom.aiBtn.addEventListener("click",()=>this.handleAiButtonClick()),this.dom.saveBtn.addEventListener("click",async()=>{const e=await this.store.saveCurrentTask();e&&e.success&&(this.dom.saveBtn.innerHTML='<i class="fas fa-check"></i>',setTimeout(()=>this.dom.saveBtn.innerHTML='<i class="fas fa-save"></i>',2e3))}),this.dom.exportBtn.addEventListener("click",()=>{this.store.exportFilteredTasks()}),this.dom.importBtn.addEventListener("click",()=>{this.dom.importInput.click()}),this.dom.importInput.addEventListener("change",async e=>{if(!e.target.files[0])return;const t=await e.target.files[0].text();await this.store.importTasks(t),e.target.value=""}),this.dom.printPreviewBtn.addEventListener("click",()=>{this.handlePrintPreview()}),this.dom.deleteSelectedBtn.addEventListener("click",()=>{const e=Array.from(this.store.getState().selectedTaskIds);this.store.deleteTasks(e)}),this.dom.selectAllCheckbox.addEventListener("change",e=>{e.target.checked?this.store.selectAllTasks():this.store.deselectAllTasks()}),this.dom.statusSelector.addEventListener("change",e=>{const{selectedTaskId:t}=this.store.getState();t&&this.store.updateTaskStatus(t,e.target.value)})}handleAiButtonClick(){const e=this.store.getState(),{editorSelection:t,markdownContent:n}=e;let s="",a="",l=null;if(e.mainViewMode==="editor"?(l=e.editorSelection,a="Editor Selection from Store"):(l=e.previewSelection,a="Preview Selection from Store"),l&&l.hasSelection&&l.text&&(s=l.text,console.log(`✅ [Task ToolbarComponent] Using selection from: ${a}`)),!s&&e.markdownContent&&(s=e.markdownContent.trim(),a="Full Content Fallback",console.log("⚠️ [Task ToolbarComponent] No selection found, using full content as fallback")),!s){alert("没有内容可以发送给 AI。");return}window.appController&&typeof window.appController.showAiPopup=="function"?window.appController.showAiPopup(s):console.error("appController is not available to show AI popup.")}handleStateChange(e,t){const{selectedTaskId:n,selectedTaskIds:s}=e;e.isSidebarVisible!==t.isSidebarVisible&&this.dom.sidebar.classList.toggle("collapsed",!e.isSidebarVisible),e.mainViewMode!==t.mainViewMode&&(this.dom.mainPanel.classList.toggle("preview-mode",e.mainViewMode==="preview"),this.dom.toggleViewBtn.innerHTML=e.mainViewMode==="preview"?'<i class="fas fa-edit"></i> 编辑':'<i class="fas fa-book-open"></i> 预览',this.dom.toggleViewBtn.title=e.mainViewMode==="preview"?"切换到编辑视图":"切换到预览视图");const a=e.tasks.find(h=>h.uuid===e.selectedTaskId);a?(this.dom.statusSelector.style.display="inline-block",this.dom.statusSelector.value=a.status):this.dom.statusSelector.style.display="none",e.mainViewMode==="preview"&&a?this.dom.panelTitle.innerHTML=`<i class="fas fa-eye"></i> ${a.title}`:e.mainViewMode==="preview"?this.dom.panelTitle.innerHTML='<i class="fas fa-eye"></i> 任务预览':e.selectedTaskId==="new"?this.dom.panelTitle.innerHTML='<i class="fas fa-edit"></i> 编辑新任务':a?this.dom.panelTitle.innerHTML=`<i class="fas fa-edit"></i> ${a.title}`:this.dom.panelTitle.innerHTML='<i class="fas fa-code"></i> 任务编辑器';const l=!!a||e.selectedTaskId==="new";this.dom.manageTagsBtn.disabled=!a,a&&a.tags&&a.tags.length>0?(this.dom.manageTagsBtn.innerHTML=`<i class="fas fa-tags"></i> (${a.tags.length})`,this.dom.manageTagsBtn.title=`管理标签 - 当前: ${a.tags.join(", ")}`):a?(this.dom.manageTagsBtn.innerHTML='<i class="fas fa-tags"></i>',this.dom.manageTagsBtn.title="管理标签 - 暂无标签"):(this.dom.manageTagsBtn.innerHTML='<i class="fas fa-tags"></i>',this.dom.manageTagsBtn.title="管理标签"),this.dom.printPreviewBtn.disabled=e.mainViewMode!=="preview",this.dom.saveBtn.disabled=!l,this.dom.reviewCount.textContent=this.store.getDueTasksCount();const u=this.store.getFilteredTasks();if(u.length===0)this.dom.selectAllCheckbox.checked=!1,this.dom.selectAllCheckbox.indeterminate=!1;else{const h=u.filter(m=>s.has(m.uuid)).length;this.dom.selectAllCheckbox.checked=h===u.length,this.dom.selectAllCheckbox.indeterminate=h>0&&h<u.length}this.dom.deleteSelectedBtn.disabled=s.size===0,this.updateTagButtonDisplay()}updateTagButtonDisplay(){const{selectedTaskId:e,tasks:t}=this.store.getState();console.log("Updating tag button display for task:",e);const n=t.find(a=>a.uuid===e);if(console.log("Selected task:",n),!n||e==="new"){this.dom.manageTagsBtn.innerHTML='<i class="fas fa-tags"></i> ',this.dom.manageTagsBtn.title="管理标签",this.dom.manageTagsBtn.disabled=!0;return}const s=n.tags||[];if(console.log("Task tags:",s),s.length>0){const a=s.slice(0,2).join(", "),l=s.length>2?` +${s.length-2}`:"";this.dom.manageTagsBtn.innerHTML=`<i class="fas fa-tags"></i> ${a}${l}`,this.dom.manageTagsBtn.title=`管理标签 - 当前: ${s.join(", ")}`}else this.dom.manageTagsBtn.innerHTML='<i class="fas fa-tags"></i> 添加标签',this.dom.manageTagsBtn.title="管理标签 - 暂无标签";this.dom.manageTagsBtn.disabled=!1}handlePrintPreview(){const e=document.getElementById("task_previewContainer").innerHTML;if(!e)return;const t=window.open("","_blank");t.document.write(`
            <!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>打印预览</title>
            <link rel="stylesheet" href="./styles.css">
            <style>
                body { margin: 20px; background: white; color: black; }
                .task-card .review-actions, .task-card .show-answer-btn { display: none !important; }
                .task-card .answer-section { display: block !important; visibility: visible !important; }
            </style></head><body>
            <div id="task_previewContainer">${e}</div>
            </body></html>
        `),t.document.close(),setTimeout(()=>{t.print(),t.close()},500)}destroy(){this.unsubscribe()}}class ku{constructor(e){this.store=e,this.dom={modal:document.getElementById("task_reviewModal"),content:document.getElementById("task_reviewContent"),ratingButtons:document.querySelectorAll(".task-review-rating-btn")},this.unsubscribe=e.subscribe(this.render.bind(this),["currentReviewTask","isReviewMode","reviewQueue"]),this.setupEventListeners()}setupEventListeners(){this.dom.ratingButtons.forEach(e=>{e.addEventListener("click",t=>{const n=parseInt(t.target.dataset.rating,10);this.store.rateCurrentTask(n)})})}render(e){if(!e.isReviewMode||!e.currentReviewTask){this.dom.modal.style.display="none";return}this.dom.modal.style.display="block",this.renderTask(e.currentReviewTask)}renderTask(e){this.dom.content.innerHTML=`
            <div class="review-task">
                <h3>${e.title}</h3>
                <div class="review-problem">${e.problem}</div>
                \x3C!-- 待办界面的其他元素 -->
            </div>
        `}destroy(){this.unsubscribe()}}async function An(){try{return(await $.global_tags.toArray()).map(e=>e.name).sort((e,t)=>e.localeCompare(t,"zh-CN"))}catch(i){return console.error("Failed to get all tags:",i),[]}}async function ws(i){if(!(!i||Array.isArray(i)&&i.length===0))try{const e=(Array.isArray(i)?i:[i]).filter(Boolean).map(t=>({name:t.trim()}));e.length>0&&await $.global_tags.bulkPut(e)}catch(e){console.error("Failed to add tags:",e)}}async function Su(i){try{const e=await $.task_tasks.where("tags").equals(i).count(),t=await $.agent_agents.where("tags").equals(i).count();if(e>0||t>0){let n=`无法删除标签 "${i}"，因为它仍被`;return e>0&&(n+=` ${e} 个任务`),t>0&&(n+=` ${t} 个角色`),n+=" 使用。",{success:!1,message:n}}return await $.global_tags.delete(i),{success:!0}}catch(e){return console.error(`Failed to delete tag "${i}":`,e),{success:!1,message:`删除失败: ${e.message}`}}}class Tu{constructor(e){this.store=e,this.dom={modal:document.getElementById("task_taskModal"),title:document.getElementById("task_modalTitle"),form:document.getElementById("task_taskForm"),nameInput:document.getElementById("task_modalName"),taskList:document.getElementById("task_modalTaskList"),tagsInput:document.getElementById("task_modalTagsInput"),tagsList:document.getElementById("task_modalTagsList"),tagsSuggestions:document.getElementById("task_modalTagsSuggestions"),confirmBtn:document.getElementById("task_modalConfirmBtn"),cancelBtn:document.getElementById("task_modalCancelBtn"),closeBtn:document.getElementById("task_modalCloseBtn")},this.tags=new Set,this.allTags=[],this.activeSuggestionIndex=-1,this.unsubscribe=e.subscribe(this.handleStateChange.bind(this),["isTaskModalVisible","taskModalContext","taskLists","filters"]),this.setupEventListeners()}setupEventListeners(){this.dom.form.addEventListener("submit",async t=>{t.preventDefault();const n=this.dom.nameInput.value.trim(),s=this.dom.taskList.value,a=this.dom.tagsInput.value.trim();if(a&&this.addTag(a),n&&s){const l=Array.from(this.tags);await ws(l),this.store.commitTask(n,l,s)}else alert("任务名称和所属列表不能为空。")}),this.dom.tagsInput.addEventListener("input",()=>this.handleTagInput()),this.dom.tagsInput.addEventListener("keydown",t=>this.handleTagKeydown(t)),this.dom.tagsInput.addEventListener("focusout",()=>{setTimeout(()=>this.hideSuggestions(),200)}),this.dom.tagsList.addEventListener("click",t=>{if(t.target.classList.contains("remove-tag-btn")){const s=t.target.parentElement.firstChild.textContent.trim();this.removeTag(s)}}),this.dom.tagsSuggestions.addEventListener("click",t=>{const n=t.target.closest("li");n&&(this.addTag(n.textContent),this.dom.tagsInput.value="",this.hideSuggestions())});const e=()=>this.store.setState({isTaskModalVisible:!1});this.dom.cancelBtn.addEventListener("click",e),this.dom.closeBtn.addEventListener("click",e)}addTag(e){e&&!this.tags.has(e)&&(this.tags.add(e),this.updateTagsUI())}removeTag(e){this.tags.delete(e),this.updateTagsUI()}updateTagsUI(){this.dom.tagsList.innerHTML="",[...this.tags].forEach(e=>{const t=document.createElement("li");t.innerHTML=`${ce(e)} <button type="button" class="remove-tag-btn">&times;</button>`,this.dom.tagsList.appendChild(t)}),this.dom.tagsInput.value="",this.handleTagInput()}handleTagInput(){const e=this.dom.tagsInput.value.trim().toLowerCase();if(!e){this.hideSuggestions();return}const t=this.allTags.filter(n=>n.toLowerCase().includes(e)&&!this.tags.has(n));this.renderSuggestions(t)}handleTagKeydown(e){const t=Array.from(this.dom.tagsSuggestions.querySelectorAll("li"));switch(e.key){case"Enter":e.preventDefault(),this.activeSuggestionIndex>-1&&t[this.activeSuggestionIndex]?this.addTag(t[this.activeSuggestionIndex].textContent):this.dom.tagsInput.value.trim()&&this.addTag(this.dom.tagsInput.value.trim()),this.hideSuggestions();break;case"ArrowDown":if(!t.length)return;e.preventDefault(),this.activeSuggestionIndex=(this.activeSuggestionIndex+1)%t.length,this.updateSuggestionHighlight(t);break;case"ArrowUp":if(!t.length)return;e.preventDefault(),this.activeSuggestionIndex=(this.activeSuggestionIndex-1+t.length)%t.length,this.updateSuggestionHighlight(t);break;case"Escape":this.hideSuggestions();break}}renderSuggestions(e){if(!e.length){this.hideSuggestions();return}this.dom.tagsSuggestions.innerHTML=e.map(t=>`<li>${ce(t)}</li>`).join(""),this.dom.tagsSuggestions.style.display="block",this.activeSuggestionIndex=-1}hideSuggestions(){this.dom.tagsSuggestions.style.display="none",this.activeSuggestionIndex=-1}updateSuggestionHighlight(e){e.forEach((t,n)=>{t.classList.toggle("active",n===this.activeSuggestionIndex)})}async handleStateChange(e,t){const{isTaskModalVisible:n,taskModalContext:s,taskLists:a,filters:l}=e;n&&!t.isTaskModalVisible&&(this.allTags=await An(),this.initializeModal(s,a,l)),this.dom.modal.style.display=n?"flex":"none"}initializeModal(e,t,n){this.tags.clear(),this.updateTagsUI(),this.dom.nameInput.value="",this.dom.tagsInput.value="",this.dom.title.textContent="新建任务",this.dom.confirmBtn.textContent="创建任务",this.populateTaskListDropdown(t,n.listId),this.dom.nameInput.focus()}populateTaskListDropdown(e,t){this.dom.taskList.innerHTML="",e.forEach(n=>{const s=document.createElement("option");s.value=n.id,s.textContent=n.name,this.dom.taskList.appendChild(s)}),t&&t!=="all"?this.dom.taskList.value=t:this.dom.taskList.value=Ze}destroy(){this.unsubscribe()}}class Iu{constructor(e){this.store=e,this.dom={modal:document.getElementById("task_tagModal"),input:document.getElementById("task_tagModalInput"),list:document.getElementById("task_tagModalList"),datalist:document.getElementById("task_existingTagsForTagModal"),confirmBtn:document.getElementById("task_tagModalConfirmBtn"),closeBtn:document.getElementById("task_tagModalCloseBtn")},this.tags=new Set,this.unsubscribe=e.subscribe(this.render.bind(this),["isTagModalVisible","selectedTaskId","tasks","taxonomy"]),this.setupEventListeners()}setupEventListeners(){this.dom.confirmBtn.addEventListener("click",()=>{this.store.saveTagsForSelectedTask(Array.from(this.tags))}),this.dom.input.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const t=this.dom.input.value.trim();t&&(this.addTag(t),this.dom.input.value="")}}),this.dom.list.addEventListener("click",e=>{if(e.target.classList.contains("remove-tag-btn")){const n=e.target.parentElement.firstChild.textContent.trim();this.removeTag(n)}}),this.dom.closeBtn.addEventListener("click",()=>this.store.setState({isTagModalVisible:!1}))}addTag(e){this.tags.add(e),this.updateTagsUI()}removeTag(e){this.tags.delete(e),this.updateTagsUI()}updateTagsUI(){this.dom.list.innerHTML="",this.tags.forEach(e=>{const t=document.createElement("li");t.innerHTML=`${e} <button type="button" class="remove-tag-btn">&times;</button>`,this.dom.list.appendChild(t)})}render(e){if(!e.isTagModalVisible){this.dom.modal.style.display="none";return}this.dom.modal.style.display="flex";const t=e.tasks.find(s=>s.uuid===e.selectedTaskId);t?(this.tags=new Set(t.tags||[]),this.updateTagsUI()):(this.tags=new Set,this.updateTagsUI());const n=new Set;Object.values(e.taxonomy).forEach(s=>{s.tags.forEach(a=>n.add(a))}),this.dom.datalist.innerHTML=[...n].map(s=>`<option value="${s}"></option>`).join("")}destroy(){this.unsubscribe()}}class _u{constructor(){this.store=hu,this.components=[]}async initialize(){console.log("Initializing Task Management System (Refactored)..."),this.components=[new pu(this.store),new mu(this.store),new gu(this.store),new yu(this.store),new vu(this.store),new bu(this.store),new wu(this.store),new ku(this.store),new Tu(this.store),new Iu(this.store)],await this.store.initialize(),console.log("Task Management System is ready.")}destroy(){this.components.forEach(e=>e.destroy&&e.destroy()),this.components=[],console.log("TaskApp destroyed.")}}const Cu=new _u,Xt=Object.keys($.tables.reduce((i,e)=>({...i,[e.name]:!0}),{}));async function Eu(){console.log("Starting database export for tables:",Xt);const i={};return await $.transaction("r",Xt,async()=>{for(const e of Xt)if($.table(e)){console.log(`Exporting table: ${e}`);const t=await $.table(e).toArray();i[e]=t}}),console.log("Database export completed."),i}async function Au(i){const e=Object.keys(i);if(e.length===0||!Xt.some(t=>e.includes(t)))throw new Error("导入文件格式无效或不包含任何可识别的数据表。");console.log("Starting database import..."),await $.transaction("rw",Xt,async()=>{for(const t of Xt)i[t]&&(console.log(`Clearing and importing table: ${t}`),await $.table(t).clear(),await $.table(t).bulkAdd(i[t]))}),console.log("Database import completed successfully.")}class Lu{constructor(){this.state={apiConfigs:[],agents:[],allTags:[],taskLists:[],settings:{theme:"light",autoSaveInterval:5},activeItemId:"general",activeItemType:"general",isCreating:!1,isLoading:!1,isSaving:!1},this.listeners=new Set}getState(){return{...this.state}}setState(e){const t={...this.state};!Object.keys(e).some(s=>this.state[s]!==e[s])&&Object.keys(e).length>0||(this.state={...this.state,...e},this.notify(t,this.state))}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e,t){this.listeners.forEach(n=>n(t,e))}async initialize(e){const t=localStorage.getItem("app-theme")||"light";document.documentElement.setAttribute("data-theme",t);const n=await $.global_appState.get("autoSaveInterval"),s=n?n.value:5,[a,l]=await Promise.all([An(),Jt()]);this.setState({apiConfigs:e.apiConfigs||[],agents:e.agents||[],allTags:a,taskLists:l,settings:{theme:t,autoSaveInterval:s}})}selectItem(e,t){this.setState({activeItemId:e,activeItemType:t,isCreating:!1})}startCreatingItem(e){this.setState({activeItemId:null,activeItemType:e,isCreating:!0})}async saveCurrentItem(e){this.setState({isSaving:!0});try{const{activeItemType:t,isCreating:n}=this.state;let s;t==="apiConfig"?n?s=await ul(e):s=await dl(e.id,e):t==="agent"&&(e.tags&&e.tags.length>0&&await ws(e.tags),n?s=await hl(e):s=await Xr(e.id,e)),window.dispatchEvent(new CustomEvent("app:sharedDataUpdated")),s&&this.selectItem(s.id,t)}catch(t){console.error("Save failed:",t),alert(`保存失败: ${t.message}`)}finally{this.setState({isSaving:!1})}}async updateAgentPartial(e,t){try{t.tags&&t.tags.length>0&&await ws(t.tags),await Xr(e,t),window.dispatchEvent(new CustomEvent("app:sharedDataUpdated"))}catch(n){console.error("Partial agent update failed:",n),alert(`标签更新失败: ${n.message}`)}}async deleteItem(e,t){if(confirm("确定要删除此配置吗？")){this.setState({isLoading:!0});try{t==="apiConfig"?await fl(e):t==="agent"&&await pl(e),window.dispatchEvent(new CustomEvent("app:sharedDataUpdated")),this.selectItem("general","general")}catch(n){console.error("Delete failed:",n),alert(`删除失败: ${n.message}`)}finally{this.setState({isLoading:!1})}}}async addTaskList(e){if(!(!e||!e.trim()))try{await go(e);const t=await Jt();this.setState({taskLists:t})}catch(t){console.error("Failed to add task list:",t),alert(`添加失败: ${t.message}`)}}async renameTaskList(e,t){if(!(!t||!t.trim()))try{await cu(e,t);const n=await Jt();this.setState({taskLists:n})}catch(n){console.error("Failed to rename task list:",n),alert(`重命名失败: ${n.message}`)}}async deleteTaskList(e){try{await uu(e);const t=await Jt();this.setState({taskLists:t}),window.dispatchEvent(new CustomEvent("app:sharedDataUpdated"))}catch(t){console.error("Failed to delete task list:",t),alert(`删除失败: ${t.message}`)}}async addTag(e){if(!e||this.state.allTags.includes(e)){alert(`标签 "${e}" 已存在或无效。`);return}await ws(e);const t=await An();this.setState({allTags:t})}async deleteTag(e){const t=await Su(e);if(!t.success){alert(t.message);return}const n=await An();this.setState({allTags:n})}setTheme(e){document.documentElement.setAttribute("data-theme",e||""),localStorage.setItem("app-theme",e),this.setState({settings:{...this.state.settings,theme:e}})}async setAutoSaveInterval(e){const t=parseInt(e,10);!isNaN(t)&&t>=0&&(this.setState({settings:{...this.state.settings,autoSaveInterval:t}}),await ml("autoSaveInterval",t),window.dispatchEvent(new CustomEvent("app:settingChanged",{detail:{key:"autoSaveInterval",value:t}})))}async exportDb(){try{const e=await Eu(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download=`smart-suite-backup-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}catch(e){alert(`导出失败: ${e.message}`)}}async importDb(e){if(e&&confirm("警告！导入将覆盖所有现有数据。确定继续吗？"))try{const t=JSON.parse(await e.text());await Au(t),alert("数据导入成功！应用即将刷新。"),window.location.reload()}catch(t){alert(`导入失败: ${t.message}`)}}}const Bu=new Lu;class Ou{constructor(e){this.store=e,this.element=document.getElementById("settings_navList"),this.setupEventListeners(),this.unsubscribe=e.subscribe(this.handleStateChange.bind(this))}setupEventListeners(){this.element.addEventListener("click",e=>{const t=e.target.closest(".settings-nav-item");if(t){e.preventDefault();const{id:s,type:a}=t.dataset;this.store.selectItem(s,a);return}const n=e.target.closest(".add-item-btn");n&&(e.preventDefault(),this.store.startCreatingItem(n.dataset.type))})}handleStateChange(e,t){(e.apiConfigs!==t.apiConfigs||e.agents!==t.agents||e.taskLists!==t.taskLists||e.activeItemId!==t.activeItemId||e.activeItemType!==t.activeItemType)&&this.render(e)}render(e){if(!this.element)return;this.element.innerHTML="";const t=this._createNavItem({id:"general",type:"general",name:"应用设置"},e),n=this._createNavItem({id:"tags",type:"tags",name:"标签管理"},e),s=this._createNavItem({id:"taskLists",type:"taskLists",name:"任务列表管理"},e);this.element.appendChild(t),this.element.appendChild(n),this.element.appendChild(s);const a=e.apiConfigs.map(u=>({id:u.id,name:u.name,type:"apiConfig"})),l=e.agents.map(u=>({id:u.id,name:u.name,type:"agent"}));this.element.appendChild(this._createNavGroup("API 配置",a,"apiConfig",e)),this.element.appendChild(this._createNavGroup("Agent 配置",l,"agent",e))}_createNavItem(e,t){const n=document.createElement("li");n.className="settings-nav-item",n.dataset.id=e.id,n.dataset.type=e.type,e.id===t.activeItemId&&e.type===t.activeItemType&&n.classList.add("active");let s="fa-cog";return e.type==="apiConfig"?s="fa-key":e.type==="agent"?s="fa-robot":e.type==="tags"?s="fa-tags":e.type==="taskLists"&&(s="fa-list-alt"),n.innerHTML=`<i class="fas ${s}"></i><span>${ce(e.name)}</span>`,n}_createNavGroup(e,t,n,s){const a=document.createDocumentFragment(),l=document.createElement("div");l.className="settings-nav-group",l.innerHTML=`
            <h4 class="settings-nav-group-title">${e}</h4>
            <button class="add-item-btn" data-type="${n}"><i class="fas fa-plus"></i> 添加</button>`;const u=document.createElement("ul");return t.forEach(h=>u.appendChild(this._createNavItem(h,s))),l.appendChild(u),a.appendChild(l),a}destroy(){this.unsubscribe()}}class Mu{constructor(e){this.store=e,this.container=document.querySelector(".settings-detail-panel"),this.templates={general:document.getElementById("settings_generalFormTemplate"),apiConfig:document.getElementById("settings_apiConfigFormTemplate"),agent:document.getElementById("settings_agentFormTemplate"),tags:document.getElementById("settings_tagsFormTemplate"),taskLists:document.getElementById("settings_taskListsFormTemplate")},this.allTags=[],this.currentTags=new Set,this.activeSuggestionIndex=-1,this.setupEventListeners(),this.unsubscribe=e.subscribe(this.handleStateChange.bind(this))}setupEventListeners(){this.container.addEventListener("click",e=>{e.target.closest("#settings_saveBtn")&&this._handleSave(),e.target.closest(".delete-item-btn")&&this._handleDelete(),e.target.closest(".toggle-api-key-visibility")&&this._toggleApiKeyVisibility(e),e.target.closest("#settings_exportDbBtn")&&this.store.exportDb(),e.target.closest("#settings_importDbBtn")&&document.getElementById("settings_importFileInput").click();const t=e.target.closest(".remove-tag-btn");if(t){const u=t.parentElement.firstChild.textContent.trim();this._removeTag(u)}const n=e.target.closest(".autocomplete-suggestions li");n&&(this._addTag(n.textContent),this.container.querySelector(".config-tags-input").value="",this._hideSuggestions());const s=e.target.closest("#settings_allTagsList .delete-tag-btn");if(s){const u=s.dataset.tagName;confirm(`确定要删除标签 "${u}" 吗？此操作不可恢复。`)&&this.store.deleteTag(u)}const a=e.target.closest("#settings_allTaskLists .rename-btn");if(a){const u=a.dataset.id,h=a.dataset.name,m=prompt("输入新的列表名称:",h);m&&m.trim()!==h&&this.store.renameTaskList(u,m)}const l=e.target.closest("#settings_allTaskLists .delete-btn");if(l){const u=l.dataset.id,h=l.dataset.name;confirm(`确定要删除任务列表 "${h}" 吗？
属于此列表的任务将被移至“未分类”。`)&&this.store.deleteTaskList(u)}}),this.container.addEventListener("change",e=>{e.target.matches("#settings_themeSelector")&&this.store.setTheme(e.target.value),e.target.matches("#settings_autosaveInterval")&&this.store.setAutoSaveInterval(e.target.value),e.target.matches("#settings_importFileInput")&&this.store.importDb(e.target.files[0]),e.target.matches(".config-provider")&&this._handleProviderChange(e)}),this.container.addEventListener("submit",e=>{if(e.target.id==="settings_addTagForm"){e.preventDefault();const t=e.target.querySelector("#settings_newTagName");this.store.addTag(t.value.trim()),t.value=""}if(e.target.id==="settings_addTaskListForm"){e.preventDefault();const t=e.target.querySelector("#settings_newListName");this.store.addTaskList(t.value.trim()),t.value=""}}),this.container.addEventListener("input",e=>{e.target.classList.contains("config-tags-input")&&this._handleTagInput(e.target)}),this.container.addEventListener("keydown",e=>{e.target.classList.contains("config-tags-input")&&this._handleTagKeydown(e)}),this.container.addEventListener("focusout",e=>{e.target.classList.contains("config-tags-input")&&setTimeout(()=>this._hideSuggestions(),200)})}async handleStateChange(e,t){const n=await An();JSON.stringify(this.allTags)!==JSON.stringify(n)&&(this.allTags=n),(e.activeItemId!==t.activeItemId||e.activeItemType!==t.activeItemType||e.isCreating!==t.isCreating||e.apiConfigs!==t.apiConfigs||e.agents!==t.agents||e.allTags!==t.allTags||e.taskLists!==t.taskLists)&&this.render(e);const s=document.getElementById("settings_saveBtn");if(s){const a=t.isSaving,l=e.isSaving;a!==l&&(s.disabled=l,s.innerHTML=l?'<i class="fas fa-spinner fa-spin"></i> 保存中...':'<i class="fas fa-save"></i> 保存')}}render(e){const{activeItemId:t,activeItemType:n,isCreating:s}=e;let a=null;n==="general"?a={name:"应用设置"}:n==="tags"?a={name:"标签管理"}:n==="taskLists"?a={name:"任务列表管理"}:n==="apiConfig"?a=s?{name:"新 API 配置"}:e.apiConfigs.find(v=>v.id===t):n==="agent"&&(a=s?{name:"新 Agent"}:e.agents.find(v=>v.id===t));const l=this.container.querySelector("#settings_detailTitle"),u=this.container.querySelector("#settings_detailContent"),h=this.container.querySelector("#settings_saveBtn");if(!a){l.innerHTML="",u.innerHTML='<div class="placeholder-content"><p>请从左侧选择一个项目。</p></div>',h.style.display="none";return}const m=s?"fa-plus-circle":"fa-edit";l.innerHTML=`<i class="fas ${m}"></i> ${s?`创建 ${a.name}`:`编辑: ${ce(a.name)}`}`,h.style.display=["apiConfig","agent"].includes(n)?"inline-flex":"none";const w=this.templates[n];w&&(u.innerHTML="",u.appendChild(w.content.cloneNode(!0)),n==="general"?this._populateGeneralForm(e):n==="tags"?this._populateTagsForm(e):n==="taskLists"?this._populateTaskListsForm(e):n==="apiConfig"?this._populateApiConfigForm(a,s):n==="agent"&&this._populateAgentForm(a,s,e.apiConfigs))}_populateGeneralForm(e){const t=this.container.querySelector('[data-id="general"]');t&&(t.querySelector("#settings_themeSelector").value=e.settings.theme,t.querySelector("#settings_autosaveInterval").value=e.settings.autoSaveInterval)}_populateApiConfigForm(e,t){const n=this.container.querySelector("form");if(!n)return;const s=n.querySelector(".config-provider");s.innerHTML=Object.keys(Wi).map(a=>`<option value="${a}">${a}</option>`).join(""),t?n.querySelector(".delete-item-btn").style.display="none":(n.querySelector(".config-id").value=e.id,n.querySelector(".config-name").value=e.name,s.value=e.provider,n.querySelector(".config-apiUrl").value=e.apiUrl||"",n.querySelector(".config-apiKey").value=e.apiKey||"",n.querySelector(".config-models").value=e.models||"")}_populateTagsForm(e){const t=this.container.querySelector("#settings_allTagsList");t&&(t.innerHTML=e.allTags.map(n=>`
            <div class="tag-item">
                <span>${ce(n)}</span>
                <button class="btn-icon btn-danger delete-tag-btn" data-tag-name="${ce(n)}" title="删除">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join(""))}_populateAgentForm(e,t,n){const s=this.container.querySelector("form");if(!s)return;const a=s.querySelector(".config-model");a.innerHTML='<option value="">-- 请选择模型 --</option>',n.forEach(l=>{l.models&&l.models.split(",").forEach(u=>{const[h,m]=u.split(":").map(w=>w.trim());if(h&&m){const w=`${l.id}:${h}`,v=`${l.name}: ${h} (${m})`;a.add(new Option(v,w))}})}),t?(s.querySelector(".delete-item-btn").style.display="none",s.querySelector(".config-sendHistory").checked=!0,this.currentTags=new Set):(s.querySelector(".config-id").value=e.id,s.querySelector(".config-name").value=e.name,s.querySelector(".config-avatar").value=e.avatar||"",a.value=e.model||"",s.querySelector(".config-systemPrompt").value=e.systemPrompt||"",s.querySelector(".config-hint").value=e.hint||"",s.querySelector(".config-sendHistory").checked=e.sendHistory!==!1,this.currentTags=new Set(e.tags||[])),this._renderCurrentTags()}_populateTaskListsForm(e){const t=this.container.querySelector("#settings_allTaskLists");t&&(t.innerHTML=e.taskLists.map(n=>{const s=n.id==="uncategorized";return`
            <div class="settings-item">
                <i class="fas fa-list-ul settings-item-icon"></i>
                <span class="settings-item-name">${ce(n.name)}</span>
                <div class="settings-item-actions">
                    <button class="btn-icon rename-btn" data-id="${n.id}" data-name="${ce(n.name)}" title="重命名" ${s?"disabled":""}>
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="btn-icon btn-danger delete-btn" data-id="${n.id}" data-name="${ce(n.name)}" title="删除" ${s?"disabled":""}>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `}).join(""))}_triggerAutoSave(){const{activeItemId:e,activeItemType:t}=this.store.getState();t==="agent"&&e&&this.store.updateAgentPartial(e,{tags:Array.from(this.currentTags)})}_addTag(e){!e||this.currentTags.has(e)||(this.currentTags.add(e),this._renderCurrentTags(),this._triggerAutoSave())}_removeTag(e){this.currentTags.delete(e),this._renderCurrentTags(),this._triggerAutoSave()}_renderCurrentTags(){const e=this.container.querySelector(".tags-list");e&&(e.innerHTML=[...this.currentTags].map(t=>`<li>${ce(t)}<button type="button" class="remove-tag-btn">×</button></li>`).join(""))}_handleTagInput(e){const t=e.value.trim().toLowerCase();if(t.length===0){this._hideSuggestions();return}const n=this.allTags.filter(s=>s.toLowerCase().includes(t)&&!this.currentTags.has(s));this._renderSuggestions(n)}_handleTagKeydown(e){const t=this.container.querySelector(".autocomplete-suggestions"),n=t?Array.from(t.querySelectorAll("li")):[];switch(e.key){case"Enter":e.preventDefault();let s=null;this.activeSuggestionIndex>-1&&n[this.activeSuggestionIndex]?s=n[this.activeSuggestionIndex].textContent:e.target.value.trim()&&(s=e.target.value.trim()),s&&this._addTag(s),e.target.value="",this._hideSuggestions();break;case"ArrowDown":if(n.length===0)return;e.preventDefault(),this.activeSuggestionIndex=(this.activeSuggestionIndex+1)%n.length,this._updateSuggestionHighlight();break;case"ArrowUp":if(n.length===0)return;e.preventDefault(),this.activeSuggestionIndex=(this.activeSuggestionIndex-1+n.length)%n.length,this._updateSuggestionHighlight();break;case"Escape":this._hideSuggestions();break}}_renderSuggestions(e){const t=this.container.querySelector(".autocomplete-suggestions");if(t){if(e.length===0){this._hideSuggestions();return}t.innerHTML=e.map(n=>`<li>${ce(n)}</li>`).join(""),t.style.display="block",this.activeSuggestionIndex=-1}}_hideSuggestions(){const e=this.container.querySelector(".autocomplete-suggestions");e&&(e.style.display="none"),this.activeSuggestionIndex=-1}_updateSuggestionHighlight(){const e=this.container.querySelector(".autocomplete-suggestions");if(!e)return;e.querySelectorAll("li").forEach((n,s)=>{n.classList.toggle("active",s===this.activeSuggestionIndex)})}_handleSave(){var s,a;const{activeItemType:e}=this.store.getState(),t=this.container.querySelector("form");if(!t||!e||["general","tags"].includes(e))return;const n={id:(s=t.querySelector(".config-id"))==null?void 0:s.value,name:(a=t.querySelector(".config-name"))==null?void 0:a.value.trim()};e==="apiConfig"?Object.assign(n,{provider:t.querySelector(".config-provider").value,apiUrl:t.querySelector(".config-apiUrl").value.trim(),apiKey:t.querySelector(".config-apiKey").value.trim(),models:t.querySelector(".config-models").value.trim()}):e==="agent"&&Object.assign(n,{avatar:t.querySelector(".config-avatar").value.trim(),model:t.querySelector(".config-model").value,systemPrompt:t.querySelector(".config-systemPrompt").value.trim(),hint:t.querySelector(".config-hint").value.trim(),tags:Array.from(this.currentTags),sendHistory:t.querySelector(".config-sendHistory").checked}),this.store.saveCurrentItem(n)}_handleDelete(){const{activeItemId:e,activeItemType:t}=this.store.getState();e&&t!=="general"&&this.store.deleteItem(e,t)}_toggleApiKeyVisibility(e){const t=e.target.closest(".input-group").querySelector("input");t.type=t.type==="password"?"text":"password"}_handleProviderChange(e){const t=e.target.closest("form");t&&(t.querySelector(".config-apiUrl").value=Fi(e.target.value))}_handleAddTag(e){e.preventDefault();const t=e.target,n=t.value.trim();n&&(t.closest(".tags-input-container").querySelector(".tags-list").insertAdjacentHTML("beforeend",`<li>${ce(n)}<button type="button" class="remove-tag-btn">×</button></li>`),t.value="")}destroy(){this.unsubscribe()}}class xu{constructor(){this.store=Bu,this.components=[],this.isInitialized=!1,this.view=document.getElementById("settings-view"),this.layoutTemplate=document.getElementById("settings_layoutTemplate")}async initialize(e,t){this.view.children.length===0&&(this.view.innerHTML="",this.view.appendChild(this.layoutTemplate.content.cloneNode(!0))),await this.store.initialize(t),this.isInitialized||(this.components=[new Ou(this.store),new Mu(this.store)],this.isInitialized=!0),(e==null?void 0:e.type)==="agent"&&(e==null?void 0:e.action)==="create"?this.store.startCreatingItem("agent"):this.store.getState().activeItemId||this.store.selectItem("general","general");const n=this.store.getState();this.store.notify({},n),console.log("SettingsApp initialized successfully.")}destroy(){this.components.forEach(e=>e.destroy()),this.components=[],this.isInitialized=!1}}const Yi=new xu;class Pu{constructor(e,t){this.agentStore=e,this.switchView=t,this.dom={overlay:document.getElementById("ai-popup-overlay"),closeBtn:document.getElementById("ai-popup-close-btn"),cancelBtn:document.getElementById("ai-popup-cancel-btn"),sendBtn:document.getElementById("ai-popup-send-btn"),agentSelector:document.getElementById("ai-popup-agent-selector"),textarea:document.getElementById("ai-popup-textarea")},this.setupEventListeners()}setupEventListeners(){this.dom.closeBtn.addEventListener("click",()=>this.hide()),this.dom.cancelBtn.addEventListener("click",()=>this.hide()),this.dom.sendBtn.addEventListener("click",()=>this.handleSend()),this.dom.overlay.addEventListener("click",e=>{e.target===this.dom.overlay&&this.hide()})}show(e){this.dom.textarea.value=e,this.populateAgentSelector(),this.dom.overlay.style.display="flex",this.dom.textarea.focus()}hide(){this.dom.overlay.style.display="none",this.dom.textarea.value="",this.dom.agentSelector.innerHTML=""}populateAgentSelector(){const{agents:e}=this.agentStore.getState();this.dom.agentSelector.innerHTML='<option value="">默认 AI (无角色)</option>',e.forEach(t=>{this.dom.agentSelector.innerHTML+=`<option value="${ce(t.id)}">${ce(t.name)}</option>`})}async handleSend(){const e=this.dom.textarea.value.trim(),t=this.dom.agentSelector.value||null;if(!e){alert("内容不能为空！");return}this.hide(),this.switchView("agent"),setTimeout(async()=>{try{await this.agentStore.startConversationFromExternal(e,t)}catch(n){console.error("Failed to start conversation from external source:",n),alert("创建 AI 对话失败，请检查控制台获取更多信息。")}},100)}}const dt={activeView:"anki"},tn={anki:!1,task:!1,agent:!1,settings:!1};let ct=null,$i=null;function Gi(i){const e=dt.activeView;Object.assign(dt,i),i.activeView&&i.activeView!==e&&hr()}async function hr(i=null){console.log("[ViewChange] Switching to view:",dt.activeView),Object.values(Jr).forEach(s=>s.style.display="none"),document.querySelectorAll(".app-nav-btn").forEach(s=>s.classList.remove("active"));const e=dt.activeView||"anki",t=Jr[e],n=document.getElementById(`nav-${e}`);if(tn[e])e==="settings"&&i&&await Yi.initialize(i,ct);else{console.log(`[Lazy Init] Initializing ${e} module...`);try{switch(e){case"anki":await ms.initialize();break;case"agent":await Qi.initialize(ct);break;case"task":await Cu.initialize();break;case"settings":await Yi.initialize(i,ct);break}tn[e]=!0}catch(s){console.error(`Failed to lazy-initialize ${e} view:`,s)}}t&&(t.style.display="flex"),n&&n.classList.add("active")}function Nu(){document.querySelector(".app-nav").addEventListener("click",i=>{const e=i.target.closest(".app-nav-btn");if(!e)return;i.preventDefault();const t=e.dataset.view;t&&t!==dt.activeView&&ll(t)}),window.addEventListener("app:switchView",i=>{const{view:e}=i.detail;e&&e!==dt.activeView&&Gi({activeView:e})}),window.addEventListener("app:navigateTo",i=>{const{view:e,context:t}=i.detail;e&&(Gi({activeView:e}),hr(t))})}function $u(){let i=null;const e=()=>{var s;i&&clearInterval(i);const n=(s=ms.store.getState().settings)==null?void 0:s.autoSaveInterval;n>0&&(i=setInterval(()=>ms.store.saveCurrentSession(),n*60*1e3),console.log(`Auto-save timer set for every ${n} minutes.`))};window.addEventListener("app:settingChanged",n=>{n.detail.key==="autoSaveInterval"&&e()}),window.addEventListener("app:ankiReady",e);const t=()=>{tn.anki&&ms.store.saveCurrentSession(),tn.agent&&Qi.store.persistState()};window.addEventListener("beforeunload",t),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&t()})}function Du(){window.addEventListener("app:sharedDataUpdated",async()=>{console.log("Shared data updated, re-syncing relevant modules..."),ct=await ga(),tn.agent&&await Qi.store.initialize(ct),tn.settings&&await Yi.store.initialize(null,ct)})}function Fu(){window.addEventListener("app:dataImported",async()=>{alert("数据导入成功！应用将刷新以应用更改。"),location.reload()})}async function Ku(){document.body.classList.add("is-loading");try{ct=await ga(),await Ri.initialize(ct),Nu(),$u(),Du(),Fu(),$i=new Pu(Ri,e=>Gi({activeView:e})),window.appController={showAiPopup:e=>{$i?$i.show(e):console.error("AI Popup Component is not initialized.")}};const i=localStorage.getItem("lastActiveView")||"anki";dt.activeView=i,await hr(),console.log("Application initialized successfully.")}catch(i){console.error("Application failed to initialize:",i);const e=document.createElement("div");e.className="error-overlay",e.innerHTML=`<h1>应用启动失败</h1><p>请检查控制台以获取详细信息。</p><pre>${i.stack}</pre>`,document.body.innerHTML="",document.body.appendChild(e)}finally{document.body.classList.remove("is-loading")}}window.addEventListener("beforeunload",()=>{localStorage.setItem("lastActiveView",dt.activeView)});document.addEventListener("DOMContentLoaded",Ku);</script>
  <style rel="stylesheet" crossorigin>:root{--primary-color: #5B66F5;--primary-hover: #4B55E3;--primary-light: #E8EAFF;--primary-dark: #3B41C5;--secondary-color: #6366F1;--secondary-light: #A5A7F3;--accent-color: #06B6D4;--accent-light: #E0F6FF;--success-color: #10B981;--success-light: #D1FAE5;--warning-color: #F59E0B;--warning-light: #FEF3C7;--danger-color: #EF4444;--danger-light: #FEE2E2;--gray-50: #F9FAFB;--gray-100: #F3F4F6;--gray-200: #E5E7EB;--gray-300: #D1D5DB;--gray-400: #9CA3AF;--gray-500: #6B7280;--gray-600: #4B5563;--gray-700: #374151;--gray-800: #1F2937;--gray-900: #111827;--text-primary: #111827;--text-secondary: #4B5563;--text-tertiary: #9CA3AF;--text-on-primary: #FFFFFF;--bg-primary: #FFFFFF;--bg-secondary: #f1f5f9;--bg-tertiary: #F3F4F6;--bg-elevated: #FFFFFF;--content-bg: #f8fafc;--font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;--font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--leading-tight: 1.25;--leading-normal: 1.5;--leading-relaxed: 1.75;--sidebar-width: 56px;--border-color: #E5E7EB;--border-radius: 8px;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .05);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);--transition: all .3s ease;--sidebar-bg: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);--header-bg: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);--panel-header-bg: #4f46e5;--folder-color: #F59E0B;--file-color: #06B6D4;--agent-color-1: #5B66F5;--agent-color-2: #6366F1;--agent-color-3: #06B6D4;--agent-color-4: #8B5CF6;--agent-color-5: #EC4899;--topic-color-1: #F59E0B;--topic-color-2: #10B981;--topic-color-3: #3B82F6;--topic-color-4: #EF4444;--cloze-1d: #FEE2E2;--cloze-2d: #FED7AA;--cloze-3d: #FDE68A;--cloze-5d: #D9F99D;--cloze-7d: #BBF7D0;--cloze-14d: #BFDBFE;--cloze-28d: #E0E7FF;--cloze-28plus: #EDE9FE;--cloze-easy-open: #ECFDF5;--cloze-10m: #DC2626;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .05) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .05) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .05) 0%, transparent 50%)}[data-theme=dark]{--primary-light: rgba(91, 102, 245, .15);--accent-light: rgba(6, 182, 212, .1);--gray-50: #111827;--gray-100: #1F2937;--gray-200: #374151;--gray-300: #4B5563;--gray-400: #6B7280;--gray-500: #9CA3AF;--gray-600: #D1D5DB;--gray-700: #E5E7EB;--gray-800: #F3F4F6;--gray-900: #F9FAFB;--success-light: rgba(16, 185, 129, .15);--warning-light: rgba(245, 158, 11, .15);--danger-light: rgba(239, 68, 68, .15);--bg-primary: #1F2937;--bg-secondary: #111827;--bg-tertiary: #374151;--bg-elevated: #1F2937;--text-primary: #F9FAFB;--text-secondary: #D1D5DB;--text-tertiary: #9CA3AF;--border-color: #374151;--sidebar-bg: linear-gradient(135deg, #111827 0%, #1F2937 100%);--header-bg: linear-gradient(135deg, #374151 0%, #4B5563 100%);--panel-header-bg: #374151;--content-bg: #111827;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .3), 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .3), 0 2px 4px -1px rgba(0, 0, 0, .2);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .3), 0 4px 6px -2px rgba(0, 0, 0, .2);--cloze-1d: #4a1d1d;--cloze-2d: #543a1a;--cloze-3d: #574f20;--cloze-5d: #3a5323;--cloze-7d: #2a503a;--cloze-14d: #2c415e;--cloze-28d: #3c3e5e;--cloze-28plus: #444059;--cloze-easy-open: #224433;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .1) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .1) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .1) 0%, transparent 50%)}[data-theme=large-font]{--text-xs: .86rem;--text-sm: 1rem;--text-base: 1.125rem;--text-lg: 1.265rem;--text-xl: 1.406rem;--text-2xl: 1.687rem;--text-3xl: 2.1rem}[data-theme=larger-font]{--text-xs: .95rem;--text-sm: 1.1rem;--text-base: 1.25rem;--text-lg: 1.4rem;--text-xl: 1.56rem;--text-2xl: 1.875rem;--text-3xl: 2.34rem}*{margin:0;padding:0;box-sizing:border-box}html{height:100%}body{font-family:var(--font-primary);font-size:var(--text-base);line-height:1.5;background:var(--bg-secondary);color:var(--text-primary);display:flex;overflow:hidden;height:100%}.sidebar,.main-content,.content-wrapper,.app-container,.panel,.session-sidebar,.session-list-container,.modal-content,.agent_topics-panel,.agent_history-panel,.settings-nav-panel,.settings-detail-panel,.agent_history-panel .chat-input-area,.stat-item,.placeholder-content{display:flex;flex-direction:column}.btn,.action-btn,.component-header,.panel-header .panel-actions-leading,.panel-header .panel-actions,.panel-title,.session-title,.select-all,.session-item .name,.folder-item,.task-item-header,.agent_topics-panel .header-title-group,.agent_topics-panel .header-actions-group,.agent_history-panel .history-title,.agent_history-panel .history-header-actions,.agent_topics-panel .topic-item,.agent_history-panel .hint-panel-header,.settings-nav-item,.form-checkbox-group label,.tags-list li,.form-checkbox-label,#anki_audioControls .audio-btn{display:flex;align-items:center}.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);flex-shrink:0}.main-content{flex:1;min-width:0}.content-wrapper{flex:1;padding:20px;min-height:0;overflow-y:auto}.main-layout{display:none;gap:20px;flex:1;min-height:0}.main-layout.active{display:flex}.app-container{flex:1;gap:20px;min-width:0;min-height:0;position:relative;display:flex;flex-direction:column}.footer{display:none}.btn,.action-btn{cursor:pointer;text-decoration:none;transition:var(--transition)}.btn{padding:10px 20px;border:none;border-radius:6px;font-weight:600;font-size:1rem;justify-content:center;gap:8px}.action-btn{padding:0;margin:0;border:1px solid transparent;justify-content:center;flex-shrink:0}.component-header{justify-content:space-between;flex-shrink:0}.list-item{border-radius:6px;cursor:pointer;transition:var(--transition);position:relative;border:1px solid var(--border-color);margin-bottom:8px;padding:12px 15px;background:var(--bg-elevated);box-shadow:var(--shadow-sm)}.list-item:hover{background:var(--bg-elevated);box-shadow:var(--shadow-md);transform:translate(3px);border-color:var(--primary-light)}.list-item.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.app-nav{gap:8px;padding:20px 0;border-bottom:1px solid rgba(255,255,255,.1)}.app-nav-btn{background:#ffffff1a;color:#ffffffe6;border-color:#ffffff1a;height:32px;width:32px;margin:0 auto;border-radius:var(--border-radius);font-size:1rem;font-weight:600;overflow:hidden;transition:all .3s cubic-bezier(.4,0,.2,1)}.app-nav-btn:hover{background:#fff3;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #00000026}.app-nav-btn.active{background:#fffffff2;color:var(--primary-dark);border-color:transparent;box-shadow:0 4px 16px #ffffff4d}.app-nav-btn i{font-size:1.1rem;width:20px;text-align:center;flex-shrink:0}.app-nav-btn.active i{color:var(--primary-color)}.panel{background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 3px #0000000d;border-radius:var(--border-radius);overflow:hidden;transition:all .3s ease-in-out}.panel-header{background:var(--panel-header-bg);color:var(--text-on-primary);box-shadow:0 1px 3px #0000001a;padding:0 20px;height:60px;position:relative}.panel-header:after{content:"";position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(to right,transparent,rgba(255,255,255,.2),transparent)}.panel-header .panel-title{flex-grow:1;justify-content:center;text-align:center}.panel-header .panel-actions-leading,.panel-header .panel-actions{flex-shrink:0;gap:8px}.panel-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);gap:8px}.panel-actions{gap:8px}.panel-btn,.session-btn,.agent_topics-panel .topic-action-btn{background:#fff3;color:var(--text-on-primary)}.panel-btn,.session-btn{border-color:#ffffff1a;border-radius:4px}.panel-btn:hover,.session-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.panel-btn{font-size:.9rem;width:40px;height:40px}.panel-btn.active{background-color:#ffffff4d;transform:scale(1.1)}.panel-btn-text{width:auto;padding:0 15px;gap:8px}.panel-content{flex:1;padding:0;overflow:hidden;transition:var(--transition);min-height:0;display:flex;flex-direction:column}.collapse-btn i{transition:transform .3s ease}.panel.collapsed .panel-content{display:none}.panel.collapsed .collapse-btn i{transform:rotate(180deg)}.session-sidebar{width:300px;background:var(--bg-elevated);box-shadow:var(--shadow-md);border:1px solid rgba(0,0,0,.06);border-radius:var(--border-radius);overflow:hidden;transition:var(--transition)}.session-header{background:var(--header-bg);color:var(--text-on-primary);box-shadow:0 2px 8px #4f46e526;padding:15px 20px;gap:12px}.session-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);justify-content:space-between}.session-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}.session-btn{padding:8px;font-size:.85rem;width:36px;height:36px}.session-content{flex:1;padding:15px;overflow-y:auto;min-height:0;background:var(--bg-secondary)}.session-list{list-style:none;margin-top:10px;overflow-y:auto;flex:1}.session-item{padding:12px 15px 12px 30px;border-color:#0000000f;cursor:pointer;transition:background-color .2s ease}.session-item.folder,.session-item.file{padding-left:26px}.session-item.folder{background:#ffd1661a;border-left:4px solid var(--folder-color)}.session-item.file{background:#a1c4fd1a;border-left:4px solid var(--file-color)}.session-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:60px;gap:8px}.session-item .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}.session-item .edit-btn,.session-item .delete-btn,.session-item .move-btn{color:var(--text-tertiary);border-radius:4px;background:#fff9;width:24px;height:24px}.session-item .edit-btn:hover{background:var(--accent-color);color:var(--text-on-primary)}.session-item .delete-btn:hover{background:var(--danger-color);color:var(--text-on-primary)}.session-item .move-btn:hover{background:var(--success-color);color:var(--text-on-primary)}.session-item input[type=text]{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:.95rem;background-color:var(--bg-primary);color:var(--text-primary)}.session-item .subsession-list{list-style:none;padding-left:10px;margin-top:10px;border-left:2px solid var(--border-color)}.session-item .subsession-list-h2{list-style:none;padding-left:15px}.subsession-item{padding:6px 8px;margin-bottom:4px;border-radius:4px;cursor:pointer;transition:background-color .2s ease;display:flex;align-items:center;gap:8px;font-size:var(--text-sm);color:var(--text-secondary)}.subsession-item:hover{background-color:var(--gray-100);color:var(--text-primary)}.subsession-item .heading-level{font-size:.7rem;font-weight:700;padding:2px 6px;border-radius:4px;color:var(--text-on-primary);flex-shrink:0}.subsession-item.h1 .heading-level{background-color:var(--primary-color)}.subsession-item.h2 .heading-level{background-color:var(--secondary-color)}.subsession-item .heading-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.subsession-item.expandable{cursor:pointer}.heading-toggle-icon{width:16px;text-align:center;color:var(--text-tertiary);transition:transform .2s ease-in-out}.subsession-item.expanded .heading-toggle-icon{transform:rotate(90deg)}.subsession-list-h2{list-style:none;padding-left:15px;max-height:0;overflow:hidden;transition:max-height .3s ease-in-out}.subsession-item.expanded+.subsession-list-h2{max-height:1000px}.select-controls{gap:8px;margin-top:10px;padding:8px 0;background:#ffffff1a;border-top:1px solid rgba(255,255,255,.2);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.select-all{gap:5px;color:var(--text-on-primary);font-size:.85rem}.folder-icon,.current-folder i{color:var(--folder-color)}.file-icon{color:var(--file-color)}.current-folder{margin-top:10px;padding:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:inset 0 1px 2px #0000000d;border-radius:4px;font-size:.9rem;color:var(--text-primary);flex-wrap:wrap;gap:4px}.current-folder i{margin-right:5px}.breadcrumb-link{color:var(--primary-color);cursor:pointer;text-decoration:none}.breadcrumb-link:hover{text-decoration:underline}.breadcrumb-separator{margin:0 4px;color:#6c757d}.breadcrumb-current{font-weight:700;color:var(--secondary-color)}.empty-session{text-align:center;padding:28px;color:var(--text-tertiary)}.empty-session i{font-size:2.8rem;margin-bottom:14px;color:var(--gray-300)}.btn-primary,.move-modal-btn.confirm{background-color:var(--primary-color);color:var(--text-on-primary);font-weight:500}.btn-primary:hover{background-color:var(--primary-hover)}.btn-secondary,.move-modal-btn.cancel{background-color:var(--gray-100);color:var(--text-secondary)}.btn-secondary:hover{background-color:var(--gray-200);color:var(--text-primary)}.btn-danger{background-color:var(--danger-color);color:var(--text-on-primary)}.btn-danger:hover{opacity:.85}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-primary)}.form-control{width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:var(--text-base);transition:var(--transition)}.form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.input-group{display:flex}.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}.input-group-btn{padding:0 12px;border:1px solid var(--border-color);border-left:none;background-color:var(--bg-tertiary);border-top-right-radius:6px;border-bottom-right-radius:6px;cursor:pointer}.form-checkbox-group{display:flex;flex-wrap:wrap;gap:10px 20px;padding:5px 0}.form-checkbox-group label{gap:5px;cursor:pointer}.modal-overlay,.move-modal{position:fixed;top:0;left:0;width:100%;height:100%;justify-content:center;transition:var(--transition)}.modal-overlay{background:#0009;z-index:2000;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}.modal-content{background:var(--bg-elevated);box-shadow:0 20px 40px #00000026;border-radius:var(--border-radius);width:90%;max-width:600px;max-height:90vh;animation:slide-in .3s ease-out}.modal-content.large{max-width:900px}.modal-header,.move-modal-header{padding:15px 25px}.modal-header{border-bottom:1px solid var(--border-color);background:var(--bg-secondary)}.modal-header h2{margin:0;font-size:var(--text-xl);color:var(--text-primary)}.modal-close,.move-modal-close{background:none;border:none;cursor:pointer;color:var(--text-tertiary)}.modal-close{font-size:1.8rem}.modal-body{padding:25px;overflow-y:auto}.modal-footer{padding:15px 25px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:10px}.move-modal{background:#00000080;z-index:1000;opacity:0;pointer-events:none}.move-modal.active{opacity:1;pointer-events:all}.move-modal-content{background:var(--bg-elevated);border-radius:var(--border-radius);padding:20px;width:400px;max-width:90%;box-shadow:var(--shadow)}.move-modal-header{margin-bottom:15px}.move-modal-title{font-size:1.2rem;font-weight:600;color:var(--primary-color)}.move-modal-close{font-size:1.5rem}.folder-list{max-height:300px;overflow-y:auto;margin:15px 0;border:1px solid var(--border-color);border-radius:var(--border-radius);padding:10px}.folder-item{margin-bottom:5px;padding:8px 10px;gap:8px;box-shadow:none}.folder-item:hover{background:var(--bg-tertiary);transform:none;box-shadow:none}.folder-item.selected{background:#4361ee1a;border-left:3px solid var(--primary-color)}.move-modal-actions{display:flex;justify-content:flex-end;gap:10px}.move-modal-btn{padding:8px 15px;border-radius:4px;font-weight:500}#anki-view .editor-container,#anki_editorPreviewPanel{flex:1;min-height:0}#anki_editorPreviewPanel.preview-active #anki_editor,#anki_editorPreviewPanel.preview-active #anki_editorToolbar{display:none}#anki_editorPreviewPanel.preview-active #anki_preview{display:block}.editor-container{flex:1;display:flex;min-height:0;position:relative}#anki_editor,#anki_preview,#task_mainPanel #task_yamlEditor,#task_mainPanel #task_previewContainer{position:absolute;top:0;left:0;width:100%;height:100%;margin:0;border:none;box-sizing:border-box;overflow-y:auto}#anki_editor,#task_mainPanel #task_yamlEditor{font-family:var(--font-mono);background-color:var(--bg-primary);color:var(--text-primary);resize:none;z-index:10}#anki_editor{padding:15px;font-size:var(--text-sm);line-height:1.5}#anki_editor:focus{outline:none;box-shadow:0 0 0 3px #4895ef33 inset}#anki_preview{z-index:5;display:none;font-size:var(--text-base);line-height:var(--leading-relaxed);color:var(--text-primary);background-color:var(--bg-elevated)}#anki_preview h1,#anki_preview h2,#anki_preview h3{margin-top:1.1em;margin-bottom:.7em;color:var(--text-primary);font-weight:700}#anki_preview h1{font-size:var(--text-3xl)}#anki_preview h2{font-size:var(--text-2xl)}#anki_preview h3{font-size:var(--text-xl)}#anki_preview p{margin-bottom:.9em}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px 15px;border-bottom:1px solid var(--border-color);background:var(--bg-tertiary);flex-shrink:0}.editor-btn{background:var(--bg-primary);border-color:var(--border-color);box-shadow:var(--shadow-sm);border-radius:6px;width:40px;height:40px;font-size:.9rem;color:var(--text-secondary)}.editor-btn:hover:not(:disabled){background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-color);transform:translateY(-1px);box-shadow:0 4px 8px #5b66f540}.editor-btn:disabled{opacity:.5;cursor:not-allowed}.mode-indicator{position:absolute;bottom:10px;right:10px;display:flex;gap:5px;z-index:20;background:#fffc;padding:5px 8px;border-radius:12px;box-shadow:var(--shadow-sm)}.mode-dot{width:10px;height:10px;border-radius:50%;background-color:var(--border-color)}.mode-dot.active{background-color:var(--primary-color)}.review-btn-group{display:flex;position:relative}.review-btn-group .panel-btn:first-child{border-top-right-radius:0;border-bottom-right-radius:0}.review-btn-group .dropdown-toggle{border-top-left-radius:0;border-bottom-left-radius:0;border-left:1px solid rgba(255,255,255,.3)}.dropdown-menu{position:absolute;top:105%;right:0;background-color:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;padding:8px 0;min-width:180px;border:1px solid var(--border-color)}.dropdown-menu a{display:block;padding:10px 15px;color:var(--text-primary);text-decoration:none;transition:background-color .2s ease;font-size:.9rem}.dropdown-menu a:hover{background-color:var(--gray-100)}.dropdown-menu a i{margin-right:10px;color:var(--primary-color);width:20px;text-align:center}#anki_audioControls{position:fixed;bottom:20px;right:20px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);padding:15px;z-index:1000;display:none}#anki_audioControls .audio-title{margin-bottom:10px;font-weight:600;color:var(--secondary-color)}#anki_audioControls .audio-progress{width:300px;height:6px;background:var(--border-color);border-radius:3px;margin:10px 0;overflow:hidden}#anki_audioControls .audio-progress-bar{height:100%;background:var(--primary-color);width:0%;transition:width .1s linear}#anki_audioControls .audio-buttons{display:flex;justify-content:space-between;gap:5px}#anki_audioControls .audio-btn{background:var(--primary-color);color:var(--text-on-primary);border:none;padding:8px 15px;border-radius:4px;cursor:pointer;gap:5px}.cloze{padding:2px 6px;border-radius:4px;cursor:pointer;position:relative;transition:var(--transition);border:1px dashed rgba(67,97,238,.3);font-weight:700;background:var(--cloze-28plus)}.cloze.hidden .cloze-content{display:none}.cloze.hidden .placeholder{display:inline}.cloze:not(.hidden) .placeholder{display:none}.placeholder,.cloze.cloze-error-duplicate .placeholder{color:var(--primary-color);font-weight:700}.cloze-1d{background:var(--cloze-1d)!important}.cloze-2d{background:var(--cloze-2d)!important}.cloze-3d{background:var(--cloze-3d)!important}.cloze-5d{background:var(--cloze-5d)!important}.cloze-7d{background:var(--cloze-7d)!important}.cloze-14d{background:var(--cloze-14d)!important}.cloze-28d{background:var(--cloze-28d)!important}.cloze-28plus{background:var(--cloze-28plus)!important}.cloze-10m{background-color:var(--cloze-10m)!important;border-color:#f33!important;animation:pulse-alert 1.5s infinite alternate;color:var(--text-on-primary)!important;font-weight:700}.cloze.easy-open{background-color:var(--cloze-easy-open)!important;border:1px dashed #C8E6C9;color:var(--text-primary)!important;font-weight:400;opacity:.9}.cloze.permanent-view{background-color:var(--primary-light)!important;border:1px solid var(--primary-color)!important;font-weight:400!important}.cloze.permanent-view .cloze-actions{display:none!important}.cloze-actions{display:flex;justify-content:space-between;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.08)}.cloze-btn{flex:1;padding:10px 5px;border-radius:20px;border:none;background-color:var(--bg-primary);cursor:pointer;font-size:.9rem;font-weight:600;text-align:center;transition:all .2s ease-in-out;outline:none;justify-content:center;min-height:60px;box-shadow:var(--shadow-sm)}.cloze-btn i{font-size:1.2rem;margin-bottom:5px}.cloze-btn.again{color:#e53935;background-color:#e539351a}.cloze-btn.hard{color:#fb8c00;background-color:#fb8c001a}.cloze-btn.double{color:#43a047;background-color:#43a0471a}.cloze-btn.easy{color:#1e88e5;background-color:#1e88e51a}.cloze-btn.again:hover{background-color:#e53935;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #e539354d}.cloze-btn.hard:hover{background-color:#fb8c00;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #fb8c004d}.cloze-btn.double:hover{background-color:#43a047;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #43a0474d}.cloze-btn.easy:hover{background-color:#1e88e5;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #1e88e54d}.cloze.cloze-nav-active{outline:3px solid var(--accent-color, #06B6D4);box-shadow:0 0 15px #06b6d480;transition:outline .2s ease-in-out,box-shadow .2s ease-in-out}.cloze.cloze-error-duplicate{border:2px solid var(--danger-color, #EF4444)!important;background-color:var(--danger-light, #FEE2E2)!important;animation:pulse-error 1s infinite alternate}.cloze.cloze-error-duplicate .placeholder{color:var(--danger-color, #EF4444)!important}.cloze.highlight-review{box-shadow:0 0 0 3px var(--warning-color);border-radius:4px;transition:box-shadow .3s ease-in-out}#task-view .app-container,#task_mainPanel{flex:1;min-height:0}#task_statsDashboard{display:flex;gap:15px;flex-shrink:0}#task_mainPanel .editor-container{flex:1;position:relative;min-height:0}#task_mainPanel #task_yamlEditor{padding:15px;font-size:1rem;line-height:1.6}#task_mainPanel #task_previewContainer{padding:20px;background-color:var(--bg-secondary);display:none;z-index:5}#task_mainPanel.preview-mode #task_yamlEditor{display:none}#task_mainPanel.preview-mode #task_previewContainer{display:block}#task-view .filter-group,#task-view .tag-list{display:flex;flex-wrap:wrap}#task-view .filter-group{margin-bottom:15px}#task-view .tag-list{gap:8px}#task-view .list-header{font-weight:600;color:var(--text-secondary);padding:10px 0;border-top:1px solid var(--border-color);margin-top:15px}.stats-card{flex:1;background-color:var(--bg-elevated);border-radius:8px;border:1px solid var(--border-color);box-shadow:var(--shadow-sm);overflow:hidden}.stats-card-header{font-size:.9rem;font-weight:600;padding:8px 12px;background-color:var(--bg-tertiary);border-bottom:1px solid var(--border-color);color:var(--text-secondary)}.stats-card-header i{margin-right:8px;color:var(--primary-color)}.stats-card-body{padding:12px;display:flex;justify-content:space-around;align-items:center}.stat-value{font-size:1.5rem;font-weight:700;color:var(--text-primary)}.stat-value.overdue{color:#d90429}.stat-value.today{color:#f77f00}.stat-label{font-size:.8rem;color:var(--text-tertiary)}.list-value{font-weight:600;padding:2px 6px;background-color:var(--bg-tertiary);border-radius:4px}.chart-container{position:relative;height:60vh;width:100%}.task-priority-indicator{width:4px;height:18px;border-radius:2px;flex-shrink:0}.task-priority-indicator.level-1{background:var(--success-color)}.task-priority-indicator.level-2{background:var(--warning-color)}.task-priority-indicator.level-3{background:var(--danger-color)}.item-tags-container{display:flex;flex-wrap:wrap;gap:4px}.item-tag{padding:2px 8px;font-size:var(--text-xs);font-weight:600;border-radius:12px;line-height:1.4;white-space:nowrap;background-color:var(--gray-100);color:var(--text-secondary)}.item-tag-more{padding:2px 6px;font-size:.65rem;background-color:var(--gray-200);color:var(--gray-600);border-radius:10px}.status-overdue,.status-today{font-weight:600}.status-overdue{color:var(--danger-color)}.status-today{color:var(--warning-color)}.status-soon{color:var(--accent-color)}.status-future{color:var(--text-tertiary)}.status-new{color:var(--success-color);font-weight:500}.search-container{position:relative;margin-bottom:15px}.search-container .fa-search{position:absolute;top:50%;left:12px;transform:translateY(-50%);color:var(--text-tertiary)}#task_searchInput{width:100%;padding:10px 12px 10px 35px;border-radius:20px;border:1px solid var(--border-color);background-color:var(--bg-primary);font-size:var(--text-sm);transition:var(--transition)}#task_searchInput:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.quick-filters{display:flex;flex-direction:column;gap:4px;margin-bottom:15px}.quick-filter-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:6px;font-size:var(--text-sm);font-weight:500;color:var(--text-secondary);text-decoration:none;transition:var(--transition)}.quick-filter-item:hover{background-color:var(--gray-100);color:var(--text-primary)}.quick-filter-item.active{background-color:var(--primary-light);color:var(--primary-dark);font-weight:600}.quick-filter-item i.fa-fw{width:1.25em}.collapsible-filters{margin-bottom:10px}#task-view .list-header{font-weight:600;color:var(--text-secondary);padding:10px 4px;border-top:1px solid var(--border-color);margin-top:15px;display:flex;justify-content:space-between;align-items:center}.list-sort-control{font-size:var(--text-xs);border:1px solid transparent;border-radius:4px;padding:4px 6px;background-color:var(--bg-tertiary);cursor:pointer}.list-sort-control:hover{border-color:var(--border-color)}.list-sort-control:focus{outline:none;border-color:var(--primary-color)}.filter-accordion-item{margin-bottom:10px;border-bottom:1px solid var(--border-color)}.filter-accordion-item:last-child{border-bottom:none}.filter-accordion-item summary{font-weight:600;color:var(--text-secondary);cursor:pointer;padding:8px 4px;list-style:none;gap:8px}.filter-accordion-item summary::-webkit-details-marker{display:none}.filter-accordion-item summary:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900;transition:transform .2s ease;width:16px;text-align:center;color:var(--text-tertiary)}.filter-accordion-item[open]>summary:before{transform:rotate(90deg)}.filter-group .tag{background-color:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-secondary);padding:5px 12px;border-radius:20px;font-size:var(--text-sm);cursor:pointer;transition:all .2s ease-in-out;justify-content:space-between;gap:8px;box-shadow:var(--shadow-sm);line-height:1.5}.filter-group .tag:hover{transform:translateY(-2px);box-shadow:var(--shadow);border-color:var(--primary-light)}.filter-group .tag.active{background-color:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-color);font-weight:600;box-shadow:0 4px 12px #5b66f540}.tag-count{font-size:.8em;padding:2px 6px;border-radius:8px;background-color:var(--bg-tertiary);color:var(--text-secondary);margin-left:4px}.filter-group .tag.active .tag-count{background-color:#fff3;color:var(--text-on-primary)}.agent_topics-panel{width:300px;box-shadow:var(--shadow);overflow:hidden;transition:transform .3s ease,width .3s ease,padding .3s ease,border .3s ease}.agent_topics-panel.collapsed{width:0;padding:0;border-width:0;transform:translate(-100%);overflow:hidden}.agent_topics-panel .topics-header,.agent_history-panel .history-header{background:var(--header-bg);color:var(--text-on-primary)}.agent_topics-panel .topics-header{padding:10px 15px;font-size:var(--text-lg);font-weight:600;height:60px}.agent_topics-panel .header-title-group{gap:8px}.agent_topics-panel .header-actions-group{gap:10px}.agent_topics-panel .topic-filter-select,.agent_history-panel .role-selector,.agent_history-panel .history-search{font-size:.9rem}.agent_topics-panel .topic-filter-select,.agent_history-panel .role-selector{padding:6px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.3);background:#ffffff1a;color:var(--text-on-primary);cursor:pointer}.agent_topics-panel .topic-filter-select{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:30px}.agent_topics-panel .topic-action-btn{width:32px;height:32px;border-radius:50%;border:none}.agent_topics-panel .topic-action-btn:hover{background:#fff6;transform:scale(1.1)}.agent_topics-panel .topics-batch-actions{padding:10px 15px;background-color:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;gap:10px;flex-shrink:0}.agent_topics-panel .batch-action-btn{padding:6px 12px;border-radius:6px;border:1px solid var(--border-color);background-color:var(--bg-primary);cursor:pointer}.agent_topics-panel .batch-action-btn.danger{background-color:var(--danger-light);color:var(--danger-color)}.agent_topics-panel .batch-action-btn:disabled,.agent_history-panel .chat-nav-btn:disabled,.editor-btn:disabled{opacity:.5;cursor:not-allowed}.agent_topics-panel .topics-content{flex:1;padding:15px;overflow-y:auto}.agent_topics-panel .topic-list{list-style:none}.agent_topics-panel .topic-item{margin-bottom:10px;background:var(--bg-secondary);gap:10px;box-shadow:none}.agent_topics-panel .topic-item:hover{transform:translate(5px);box-shadow:var(--shadow)}.agent_topics-panel .topic-item.active{border-left-color:var(--primary-color);border-left-width:4px;background-color:var(--primary-light);box-shadow:0 4px 12px #5b66f526;font-weight:600}.agent_topics-panel .topic-icon{width:24px;height:24px;border-radius:50%;justify-content:center;color:var(--text-on-primary);font-size:.8rem;flex-shrink:0}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+1){border-left-color:var(--topic-color-1)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+2){border-left-color:var(--topic-color-2)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+3){border-left-color:var(--topic-color-3)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+4){border-left-color:var(--topic-color-4)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+1) .topic-icon{background:var(--topic-color-1)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+2) .topic-icon{background:var(--topic-color-2)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+3) .topic-icon{background:var(--topic-color-3)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+4) .topic-icon{background:var(--topic-color-4)}.agent_history-panel{flex:1;border:1px solid var(--border-color);position:relative;min-width:0}.agent_history-panel .history-header{padding:15px 20px}.agent_history-panel .history-title{font-size:var(--text-lg);font-weight:600;gap:10px}.agent_history-panel .history-header-actions{gap:10px}.agent_history-panel .history-search{padding:8px 15px;border-radius:20px;border:none;width:250px;background:#ffffffe6;box-shadow:var(--shadow-sm);color:var(--text-primary)}.agent_history-panel .history-search:focus{background:var(--bg-elevated);box-shadow:var(--shadow-md);outline:none}.agent_history-panel .history-content{flex:1;padding:20px;overflow-y:auto;gap:20px;min-height:0;background:var(--bg-secondary)}.agent_history-panel .history-item{padding:15px;border-radius:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000a;border-left:3px solid var(--primary-color)}.agent_history-panel .history-item-header{display:flex;justify-content:space-between;margin-bottom:10px;color:var(--text-tertiary);font-size:.9rem}.agent_history-panel .history-item-content{line-height:1.6}.agent_history-panel .history-item-content img{max-width:100%;border-radius:8px;margin-top:10px}.agent_history-panel .history-item-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}.agent_history-panel .history-action-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;transition:var(--transition)}.agent_history-panel .history-action-btn:hover{background:#4361ee33}.agent_history-panel .chat-input-area{padding:15px 20px;border-top:1px solid var(--border-color);background:linear-gradient(to bottom,transparent,var(--bg-secondary));gap:10px;flex-shrink:0;z-index:5}.agent_history-panel .chat-input-area{padding:15px 20px;border-top:1px solid var(--border-color);background:linear-gradient(to bottom,transparent,var(--bg-secondary));gap:10px;flex-shrink:0}.agent_history-panel .input-controls{display:flex;align-items:flex-end;gap:10px}.agent_history-panel .chat-textarea{flex:1;border:2px solid var(--border-color);padding:10px 15px;font-family:inherit;font-size:var(--text-base);line-height:1.5;resize:vertical;transition:var(--transition);background:var(--bg-primary);color:var(--text-primary);border-radius:var(--border-radius)}.agent_history-panel .chat-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px #5b66f51a}.agent_history-panel .chat-action-btn{width:44px;height:44px;border-radius:50%;border:none;font-size:1.1rem;background:var(--gray-100);color:var(--text-secondary)}.agent_history-panel .chat-action-btn:hover{background:var(--gray-200);transform:translateY(-2px)}.agent_history-panel .chat-action-btn.send{background-color:var(--primary-color);color:var(--text-on-primary)}.agent_history-panel .chat-action-btn.send:hover{background-color:var(--secondary-color)}.agent_history-panel .attachment-preview-container{display:flex;gap:8px;flex-wrap:wrap;max-height:100px;overflow-y:auto}.agent_history-panel .attachment-preview-item{background:var(--bg-tertiary);padding:5px 12px;border-radius:15px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px;color:var(--text-primary);animation:fadeIn .3s ease}.agent_history-panel .attachment-preview-item i{color:var(--primary-color)}.agent_history-panel .remove-attachment-btn{cursor:pointer;font-weight:700;color:var(--text-tertiary);background:none;border:none;font-size:1.2rem;line-height:1;padding:0 2px;transition:var(--transition)}.agent_history-panel .remove-attachment-btn:hover{color:var(--danger-color);transform:scale(1.2)}.agent_history-panel .hint-panel{padding:20px;margin:-5px 0 15px;border-radius:8px;background-color:var(--bg-secondary);border:1px solid var(--border-color);gap:15px;color:var(--text-secondary);opacity:0;animation:fadeIn .5s forwards}.agent_history-panel .hint-panel-header{gap:12px}.agent_history-panel .hint-panel-avatar{width:32px;height:32px;border-radius:50%;background-color:var(--primary-color);color:#fff;justify-content:center;font-weight:700;font-size:16px;flex-shrink:0}.agent_history-panel .hint-panel-title{font-weight:700;color:var(--text-primary)}.agent_history-panel .hint-panel-content{padding-left:44px;font-size:14px;line-height:1.6}#anki_editor,#anki_preview,#task_mainPanel #task_yamlEditor,#task_mainPanel #task_previewContainer{padding:20px}.settings-nav-panel{width:280px;flex-shrink:0;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--border-radius);box-shadow:var(--shadow-sm)}.settings-nav-header{padding:20px;border-bottom:1px solid var(--border-color)}.settings-nav-header h3{font-size:var(--text-xl);color:var(--text-primary)}.settings-nav-list{padding:10px;overflow-y:auto;flex:1}.settings-nav-group{margin-bottom:20px}.settings-nav-group-title{padding:10px;font-size:var(--text-sm);font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}.add-item-btn{width:calc(100% - 20px);margin:0 10px 10px;padding:8px;background:var(--primary-light);color:var(--primary-color);border:1px dashed var(--primary-color);border-radius:6px;cursor:pointer;text-align:center;font-weight:600;transition:var(--transition)}.add-item-btn:hover{background:var(--primary-color);color:var(--text-on-primary);border-style:solid}.settings-nav-item{gap:12px;font-weight:500;color:var(--text-secondary);margin-bottom:4px;box-shadow:none;background-color:transparent;border:none}.settings-nav-item:hover{background-color:var(--bg-secondary);color:var(--text-primary);transform:none;box-shadow:none}.settings-nav-item.active{background-color:var(--primary-color);color:var(--text-on-primary);box-shadow:0 4px 8px #5b66f533}.settings-nav-item i,.settings-nav-item.active i{color:inherit;width:20px;text-align:center}.settings-detail-panel{flex:1;min-width:0;height:100%}#settings_detailContent{flex-grow:1;overflow-y:auto;padding:25px}.placeholder-content{justify-content:center;height:100%;text-align:center}.placeholder-content i{color:var(--gray-300)}.placeholder-content p{margin-top:15px;color:var(--text-tertiary)}.settings-section{margin-bottom:30px;max-width:600px}.settings-section-title{font-size:var(--text-xl);color:var(--text-primary);border-bottom:2px solid var(--primary-light);padding-bottom:10px;margin-bottom:20px;font-weight:600}.settings-detail-footer{margin-top:30px;padding-top:20px;border-top:1px solid var(--border-color)}.tags-input-container{border:1px solid var(--border-color);border-radius:6px;padding:5px;background:var(--bg-primary)}.tags-input-container:focus-within{border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.tags-list{display:flex;flex-wrap:wrap;gap:8px;list-style:none;padding:5px}.tags-list li{background-color:var(--primary-color);color:var(--text-on-primary);padding:6px 12px;border-radius:20px;font-size:var(--text-sm);gap:8px}.remove-tag-btn{background:none;border:none;color:var(--text-on-primary);cursor:pointer;font-size:1.2em;line-height:1;opacity:.7;padding:0}.remove-tag-btn:hover{opacity:1}.config-tags-input{border:none!important;box-shadow:none!important;flex-grow:1;padding:8px 7px!important}.config-tags-input:focus{outline:none}.form-checkbox-label{display:inline-flex;gap:10px;cursor:pointer}.form-checkbox-label input[type=checkbox]{width:1.2em;height:1.2em}.file-input{display:none}.hidden-session{transform:translate(-325px);opacity:0;width:0;overflow:hidden}.session-item-details{margin-bottom:8px;list-style:none}.session-item-details summary{list-style:none;cursor:pointer;outline:none;padding:12px 15px;border-radius:6px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow-sm);transition:var(--transition);position:relative}.session-item-details summary::-webkit-details-marker{display:none}.session-item-details summary:hover{background:var(--bg-elevated);box-shadow:var(--shadow-md);transform:translate(3px)}.session-item-details summary.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item-details summary .name:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900;margin-right:10px;transition:transform .2s ease-in-out;display:inline-block;color:var(--text-tertiary)}.session-item-details[open]>summary .name:before{transform:rotate(90deg)}@keyframes highlight{0%{background:#fff9c4}to{background:linear-gradient(120deg,#a1c4fd,#c2e9fb)}}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes slide-in{0%{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}@keyframes pulse-error{0%{box-shadow:0 0 #ef444466}to{box-shadow:0 0 0 5px #ef444400}}@keyframes pulse-alert{0%{opacity:.7}to{opacity:1}}@media (max-width: 1200px){body{flex-direction:column;height:auto;min-height:100vh}.sidebar{position:relative;width:100%;min-height:auto;flex-direction:row;align-items:center}.app-nav{flex-direction:row;padding:15px;flex:1;justify-content:center;background:#0000001a;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.app-nav-btn{margin:0 4px}.main-content{margin-left:0}.main-layout{flex-direction:column}.session-sidebar,.agent_topics-panel{width:100%;max-width:100%;max-height:40vh}.app-container{min-width:100%}}@media (max-width: 768px){.panel-header{flex-direction:column;align-items:flex-start;gap:10px;height:auto;padding:10px}.panel-header .panel-title{text-align:left}.panel-actions{width:100%;justify-content:space-between;flex-wrap:wrap}.app-nav{flex-wrap:wrap}}#anki_preview>*,#task_previewContainer>*,.agent_history-panel .history-item-content>*{max-width:100%}#anki_preview ul,#anki_preview ol,#task_previewContainer ul,#task_previewContainer ol,.agent_history-panel .history-item-content ul,.agent_history-panel .history-item-content ol{padding-left:2em;margin-left:0}#anki_preview blockquote,#task_previewContainer blockquote,.agent_history-panel .history-item-content blockquote{margin:1em 0;padding:.5em 1.5em;border-left:4px solid var(--border-color);background-color:var(--bg-tertiary);color:var(--text-secondary)}#anki_preview pre,#task_previewContainer pre,.agent_history-panel .history-item-content pre{padding:1em;margin:1em 0;overflow-x:auto;background-color:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--border-radius)}#anki_preview code,#task_previewContainer code,.agent_history-panel .history-item-content code{background:var(--gray-100);color:var(--primary-dark);padding:2px 5px;border-radius:4px;font-family:var(--font-mono);font-size:.9em}#anki_preview pre code,#task_previewContainer pre code,.agent_history-panel .history-item-content pre code{background-color:transparent;padding:0;color:var(--text-primary)}@keyframes blink{50%{opacity:0}}.streaming-cursor{display:inline-block;width:8px;height:1.2em;background-color:var(--text-primary);margin-left:2px;animation:blink 1s step-end infinite;vertical-align:text-bottom}.streaming-initial-loader{color:var(--text-tertiary)}.floating-nav-group{position:absolute;bottom:20px;right:25px;display:flex;flex-direction:column;gap:10px;z-index:100}#agent-view .floating-nav-group{bottom:100px}.floating-nav-btn{width:48px;height:48px;border-radius:50%;background-color:var(--primary-color);color:var(--text-on-primary);border:none;box-shadow:var(--shadow-md);font-size:1.2rem;transition:all .2s ease-in-out}.floating-nav-btn:hover{background-color:var(--primary-hover);transform:scale(1.1);box-shadow:var(--shadow-lg)}.floating-nav-btn:disabled{opacity:.5;cursor:not-allowed;background-color:var(--gray-400);transform:none;box-shadow:var(--shadow-sm)}</style>
</head>

<body>
    <!-- ====================================================== -->
    <!--                  Global Layout: Sidebar                -->
    <!-- ====================================================== -->
    <div class="sidebar">
        <nav class="app-nav">
            <a href="#" class="action-btn app-nav-btn" data-view="anki" id="nav-anki" title="Anki 笔记">
                <i class="fas fa-layer-group"></i>
            </a>
            <a href="#" class="action-btn app-nav-btn active" data-view="task" id="nav-task" title="任务管理">
                <i class="fas fa-book"></i>
            </a>
            <a href="#" class="action-btn app-nav-btn" data-view="agent" id="nav-agent" title="AI角色">
                <i class="fas fa-robot"></i>
            </a>
            <a href="#" class="action-btn app-nav-btn" data-view="settings" id="nav-settings" title="设置">
                <i class="fas fa-cog"></i>
            </a>
        </nav>
    </div>

    <!-- ====================================================== -->
    <!--               Global Layout: Main Content              -->
    <!-- ====================================================== -->
    <div class="main-content">
        <div class="content-wrapper">

            <!-- ====================================================== -->
            <!--                  Anki Notes View                     -->
            <!-- ====================================================== -->
            <div id="anki-view" class="main-layout" style="display: none;">
                <div class="session-sidebar anki_session-sidebar">
                    <div class="session-header">
                        <div class="session-title" id="anki_sessionTitleContainer">
                            <span><i class="fas fa-layer-group"></i> 会话管理</span>
                        </div>
                        <div class="session-controls">
                            <!-- [MODIFIED] Added .action-btn base class -->
                            <button id="anki_newFileBtn" class="action-btn session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                            <button id="anki_newFolderBtn" class="action-btn session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                            <button id="anki_openFileBtn" class="action-btn session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                            <button id="anki_moveSelectedBtn" class="action-btn session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                            <button id="anki_deleteSelectedBtn" class="action-btn session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="select-controls">
                            <label class="select-all"><input type="checkbox" id="anki_selectAllCheckbox"> 全选</label>
                        </div>
                        <div class="current-folder" id="anki_currentFolderContainer"></div>
                    </div>
                    <div class="session-content">
                        <div class="session-list-container">
                            <ul class="session-list" id="anki_sessionList"></ul>
                            <div class="empty-session" id="anki_emptySession">
                                <i class="fas fa-folder-open"></i>
                                <p>没有打开的会话</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-container">
                    <div class="panel editor-preview-panel" id="anki_editorPreviewPanel">
                        <!-- [MODIFIED] Added .component-header for layout -->
                        <div class="panel-header component-header">
                            <div class="panel-actions-leading">
                                <!-- [MODIFIED] Added .action-btn base class -->
                                <button id="anki_toggleSessionBtn" class="action-btn panel-btn" title="显示/隐藏会话栏"><i class="fas fa-bars"></i></button>
                                <button id="anki_toggleEditPreviewBtn" class="action-btn panel-btn panel-btn-text"><i class="fas fa-book-open"></i> Preview</button>
                            </div>
                            <div class="panel-title" id="anki_panelTitle"><i class="fas fa-edit"></i> Anki 编辑器</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="anki_startReviewBtn" class="action-btn panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 待办 (<span id="anki_reviewCount">0</span>)</button>
                                    <button id="anki_reviewOptionsBtn" class="action-btn panel-btn dropdown-toggle"><i class="fas fa-chevron-down"></i></button>
                                    <div id="anki_reviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                        <a href="#" id="anki_customStudyBtn"><i class="fas fa-wrench"></i> 自定义待办...</a>
                                        <a href="#" id="anki_showStatsBtn"><i class="fas fa-chart-line"></i> 统计</a>
                                    </div>
                                </div>
                                <button id="anki_toggleVisibilityClozeBtn" class="action-btn panel-btn" title="全部隐藏"><i class="fas fa-eye-slash"></i></button>
                                <button id="anki_invertClozeBtn" class="action-btn panel-btn" title="反向显示/隐藏"><i class="fas fa-random"></i></button>
                                <button type="button" id="anki_aiBtn" class="action-btn panel-btn" title="AI 助手"><i class="fas fa-magic-wand-sparkles"></i></button>
                                <button id="anki_saveBtn" class="action-btn panel-btn panel-btn-text" title="保存"><i class="fas fa-save"></i></button>
                                <button id="anki_exportFileBtn" class="action-btn panel-btn panel-btn-text" title="导出"><i class="fas fa-download"></i></button>
                                <button id="anki_printPreviewBtn" class="action-btn panel-btn panel-btn-text" title="打印预览内容" disabled><i class="fas fa-print"></i></button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="editor-sub-toolbar" id="anki_editorToolbar">
                                <!-- [MODIFIED] Added .action-btn base class -->
                                <button id="anki_clozeBtn" class="action-btn editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
                                <button id="anki_boldBtn" class="action-btn editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
                                <button id="anki_italicBtn" class="action-btn editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
                                <button id="anki_insertLinebreakBtn" class="action-btn editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
                                <button id="anki_codeBtn" class="action-btn editor-btn" title="代码"><i class="fas fa-code"></i></button>
                                <button id="anki_linkBtn" class="action-btn editor-btn" title="链接"><i class="fas fa-link"></i></button>
                                <button id="anki_audioBtn" class="action-btn editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
                            </div>
                            <div class="editor-container" id="anki_editorContainer">
                                <textarea id="anki_editor" class="editor"></textarea>
                                <div id="anki_preview" tabindex="0"></div>
                            </div>
                            <div class="mode-indicator">
                                <div class="mode-dot active" id="anki_editModeDot" title="编辑模式"></div>
                                <div class="mode-dot" id="anki_previewModeDot" title="预览模式"></div>
                            </div>
                        </div>
					</div>

						                    <!-- [NEW] 新增浮动按钮组 -->
                    <div class="floating-nav-group">
                        <button id="anki_clozeNavUpBtn" class="action-btn floating-nav-btn" title="上一个 Cloze"><i class="fas fa-arrow-up"></i></button>
                        <button id="anki_clozeNavDownBtn" class="action-btn floating-nav-btn" title="下一个 Cloze"><i class="fas fa-arrow-down"></i></button>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                   Task Manager View                    -->
            <!-- ====================================================== -->
            <div id="task-view" class="main-layout">
                <div class="session-sidebar task_session-sidebar">
                    <div class="session-header">
        <div class="session-title"><span><i class="fas fa-book-open"></i> 任务导航</span></div>
                        <div class="session-controls">
                            <!-- [MODIFIED] Added .action-btn base class -->
                            <button id="task_createTaskBtn" class="action-btn session-btn" title="新建任务"><i class="fas fa-plus-circle"></i></button>
							<button id="task_deleteSelectedBtn" class="action-btn session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                        </div>
                      <div class="select-controls">
                          <label class="select-all"><input type="checkbox" id="task_selectAllCheckbox"> 全选</label>
                      </div>
                    </div>
                    <div class="session-content">
                        <!-- 1. Search Box -->
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="task_searchInput" placeholder="搜索或使用#tag">
                        </div>

                        <!-- 2. Quick Filters / Smart Views -->
                        <div class="quick-filters" id="task_quickFilters">
                            <a href="#" class="quick-filter-item" data-filter-type="status" data-filter-value="active"><i class="fas fa-inbox fa-fw"></i> 活动中</a>
                            <a href="#" class="quick-filter-item" data-filter-type="date" data-filter-value="today"><i class="fas fa-calendar-day fa-fw"></i> 今天到期</a>
                            <a href="#" class="quick-filter-item" data-filter-type="date" data-filter-value="upcoming"><i class="fas fa-calendar-week fa-fw"></i> 即将到来</a>
                            <a href="#" class="quick-filter-item" data-filter-type="status" data-filter-value="completed"><i class="fas fa-check-circle fa-fw"></i> 已完成</a>
                        </div>

                        <!-- 3. Collapsible Filters -->
                        <div class="collapsible-filters">
                            <details class="filter-accordion-item" open>
                                <summary>任务列表</summary>
                                <div id="task_list_filter_container" class="filter-group"></div>
                            </details>
                            <details class="filter-accordion-item">
                                <summary>标签</summary>
                                <div id="task_tag_filter_container" class="filter-group"></div>
                            </details>
                        </div>
                        
                        <!-- 4. Task List with Sorting -->
                        <div class="list-header">
                            <span><i class="fas fa-list-ul"></i> 待办列表</span>
                            <select id="task_sortBy" class="list-sort-control" title="排序方式">
                                <option value="due_date">按到期日</option>
                                <option value="priority">按优先级</option>
                                <option value="title">按名称</option>
                            </select>
                        </div>
                        <ul class="session-list" id="task_list"></ul>
                        
                        <!-- 5. Pagination -->
                        <div class="pagination" id="task_paginationContainer"></div>
                    </div>
                </div>

                <div class="app-container">
                    <div id="task_mainPanel" class="panel editor-preview-panel">
                        <!-- [MODIFIED] Added .component-header for layout -->
                        <div class="panel-header component-header">
                            <div class="panel-actions-leading">
                                <!-- [MODIFIED] Added .action-btn base class -->
                                <button id="task_toggleSessionBtn" class="action-btn panel-btn" title="显示/隐藏筛选栏"><i class="fas fa-bars"></i></button>
                                <button id="task_toggleViewBtn" class="action-btn panel-btn panel-btn-text" title="切换到预览视图"><i class="fas fa-book-open"></i> 预览</button>
                                <!-- [NEW] Status dropdown -->
                                <select id="task_statusSelector" class="form-control" title="设置任务状态" style="display: none;">
                                    <option value="todo">待办</option>
                                    <option value="in_progress">进行中</option>
                                    <option value="completed">已完成</option>
                                    <option value="archived">已归档</option>
                                </select>
                            </div>
                            <div class="panel-title" id="task_panelTitle"><i class="fas fa-tasks"></i> 任务管理</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="task_startReviewBtn" class="action-btn panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 待办 (<span id="task_reviewCount">0</span>)</button>
                                </div>
                                <button id="task_importBtn" class="action-btn panel-btn" title="导入YAML"><i class="fas fa-upload"></i></button>
                                <input type="file" id="task_yamlImportInput" accept=".yml,.yaml" style="display: none;">
                                <button type="button" id="task_aiBtn" class="action-btn panel-btn" title="AI 助手"><i class="fas fa-magic-wand-sparkles"></i></button>
                                <button id="task_manageTagsBtn" class="action-btn panel-btn" title="管理标签" disabled><i class="fas fa-tags"></i></button>
                                <button id="task_saveBtn" class="action-btn panel-btn" title="保存并刷新"><i class="fas fa-save"></i></button>
                                <button id="task_exportBtn" class="action-btn panel-btn" title="导出YAML"><i class="fas fa-download"></i></button>
                                <button id="task_printPreviewBtn" class="action-btn panel-btn" title="打印预览内容" disabled><i class="fas fa-print"></i></button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="editor-container">
                                <textarea id="task_yamlEditor"></textarea>
                                <div id="task_previewContainer"></div>
                            </div>
                        </div>
                    </div>
                    <div id="task_statsDashboard" class="stats-dashboard-inline"></div>
                </div>

                <!-- Review Modal for Task View -->
                <div class="modal-overlay" id="task_reviewModal" style="display: none;">
                    <div class="modal-content review-modal">
                        <div class="modal-header">
                            <h2>任务待办</h2>
                            <button class="modal-close" id="task_reviewCloseBtn">×</button>
                        </div>
                        <div class="modal-body" id="task_reviewContent"></div>
                        <div class="modal-footer">
                            <div class="review-rating-buttons">
                                <button class="task-review-rating-btn again" data-rating="0">重做</button>
                                <button class="task-review-rating-btn hard" data-rating="1">困难</button>
                                <button class="task-review-rating-btn good" data-rating="2">犹豫</button>
                                <button class="task-review-rating-btn easy" data-rating="3">简单</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                    AI Agent View                       -->
            <!-- ====================================================== -->
            <div id="agent-view" class="main-layout" style="display: none;">
                <div class="topics-panel agent_topics-panel">
                    <!-- [MODIFIED] Added .component-header for layout -->
                    <div class="topics-header component-header">
                        <div class="header-title-group"><i class="fas fa-book"></i> 聊天</div>
                        <div class="header-actions-group">
                            <select id="agent_topicTagFilter" class="topic-filter-select"></select>
                            <button id="agent_addTopicHeaderBtn" class="action-btn topic-action-btn" title="添加新主题">
                                <i class="fas fa-plus"></i>
                            </button>
                            <!-- [MODIFIED] Added .action-btn base class -->
                            <button id="agent_editTopicBtn" class="action-btn topic-action-btn" title="重命名"><i class="fas fa-pencil-alt"></i></button>
                            <button id="agent_manageTopicsBtn" class="action-btn topic-action-btn" title="管理"><i class="fas fa-tasks"></i></button>
                        </div>
                    </div>
                    <div class="topics-batch-actions" id="agent_topicsBatchActions" style="display: none;">
                        <button id="agent_selectAllTopicsBtn" class="batch-action-btn">全选</button>
                        <button id="agent_deleteSelectedTopicsBtn" class="batch-action-btn danger">删除</button>
                        <button id="agent_cancelTopicSelectionBtn" class="batch-action-btn">取消</button>
                    </div>
                    <div class="topics-content">
                        <ul class="topic-list" id="agent_topicList"></ul>
                    </div>
                </div>

                <div class="history-panel agent_history-panel">
                    <!-- [MODIFIED] Added .component-header for layout -->
                    <div class="history-header component-header">
                        <div class="history-title">
                            <button id="agent_toggleTopicsBtn" class="action-btn panel-btn"><i class="fas fa-bars"></i></button>
                            <i class="fas fa-comments"></i>
                            <span id="agent_historyHeaderTitle">对话记录</span>
                        </div>
                        <div class="history-header-actions">
                            <input type="text" id="agent_historySearch" class="history-search" placeholder="搜索...">
                            <button type="button" id="agent_aiBtn" class="action-btn panel-btn" title="AI 助手">
                                <i class="fas fa-magic-wand-sparkles"></i>
                            </button>
                            <select id="agent_conversationRoleSelector" class="role-selector"></select>
                        </div>
                    </div>
                    <div class="history-content" id="agent_historyContent"></div>
                        <div class="floating-nav-group">
                            <button id="agent_chatNavUp" class="action-btn floating-nav-btn"><i class="fas fa-arrow-up"></i></button>
                            <button id="agent_chatNavDown" class="action-btn floating-nav-btn"><i class="fas fa-arrow-down"></i></button>
                    </div>
                    <div class="chat-input-area" id="agent_chatInputArea">
                        <div class="attachment-preview-container" id="agent_attachmentPreview"></div>
                        <div class="input-controls">
                            <textarea id="agent_chatInput" class="chat-textarea"></textarea>
                            <input type="file" id="agent_attachmentInput" multiple style="display: none;">
                            <!-- [MODIFIED] Added .action-btn base class -->
                            <button id="agent_attachFileBtn" class="action-btn chat-action-btn"><i class="fas fa-paperclip"></i></button>
                            <button id="agent_sendMessageBtn" class="action-btn chat-action-btn send"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                    Settings View                       -->
            <!-- ====================================================== -->
            <div id="settings-view" class="main-layout" style="display: none;">
                <!-- Content dynamically filled by JavaScript -->
            </div>

        </div> <!-- .content-wrapper end -->
    </div> <!-- .main-content end -->

    <!-- ====================================================== -->
    <!--               Global Modals & Templates                -->
    <!-- ====================================================== -->
    
    <!-- [NEW] Global AI Popup -->
    <div id="ai-popup-overlay" class="modal-overlay" style="display: none;">
        <div id="ai-popup-content" class="modal-content">
            <div class="modal-header component-header">
                <h2>AI 助手</h2>
                <button class="modal-close" id="ai-popup-close-btn">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ai-popup-agent-selector">选择 AI 角色:</label>
                    <select id="ai-popup-agent-selector" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label for="ai-popup-textarea">内容 (可编辑):</label>
                    <textarea id="ai-popup-textarea" class="form-control" rows="12"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="ai-popup-cancel-btn">取消</button>
                <button type="button" class="btn btn-primary" id="ai-popup-send-btn">
                    <i class="fas fa-paper-plane"></i> 发送到新会话
                </button>
            </div>
        </div>
    </div>


    <!-- Anki: Audio Player -->
    <div class="audio-controls" id="anki_audioControls">
        <div class="audio-title" id="anki_audioTitle"></div>
        <div class="audio-progress">
            <div class="audio-progress-bar" id="anki_audioProgressBar"></div>
        </div>
        <div class="audio-buttons">
            <button id="anki_playBtn" class="audio-btn"><i class="fas fa-play"></i> 播放</button>
            <button id="anki_pauseBtn" class="audio-btn"><i class="fas fa-pause"></i> 暂停</button>
            <button id="anki_stopBtn" class="audio-btn"><i class="fas fa-stop"></i> 停止</button>
        </div>
    </div>
    <input type="file" id="anki_fileInput" style="display: none;" accept=".md, .txt" multiple>

    <!-- Anki: Move File Modal -->
    <div class="move-modal" id="anki_moveModal">
        <div class="move-modal-content">
            <!-- [MODIFIED] Added .component-header for layout -->
            <div class="move-modal-header component-header">
                <div class="move-modal-title">移动到目录</div>
                <button class="move-modal-close" id="anki_closeMoveModalBtn">×</button>
            </div>
            <p>选择目标目录：</p>
            <div class="folder-list" id="anki_folderList"></div>
            <div class="move-modal-actions">
                <!-- [MODIFIED] Added .btn base class -->
                <button class="btn move-modal-btn cancel" id="anki_cancelMoveBtn">取消</button>
                <button class="btn move-modal-btn confirm" id="anki_confirmMoveBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- Anki: Custom Study Modal -->
    <div class="modal-overlay" id="anki_customStudyModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header component-header">
                <h2>自定义待办</h2>
                <button class="modal-close" id="anki_customStudyCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <form id="anki_customStudyForm">
                    <div class="form-group">
                        <label for="anki_filterByFile">按文件/目录筛选:</label>
                        <select id="anki_filterByFile" name="anki_filterByFile" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>按卡片状态筛选:</label>
                        <div class="form-checkbox-group">
                            <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                            <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                            <label><input type="checkbox" name="cardState" value="review" checked> 待办中</label>
                            <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="anki_filterByLastReview">按最后一次待办时间筛选:</label>
                        <select id="anki_filterByLastReview" name="anki_filterByLastReview" class="form-control">
                            <option value="any">任何时间</option>
                            <option value="last7days">最近7天内</option>
                            <option value="last30days">最近30天内</option>
                            <option value="over30days">超过30天未待办</option>
                            <option value="never">从未待办过 (新卡片)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="anki_maxCards">最大卡片数量:</label>
                        <input type="number" id="anki_maxCards" name="anki_maxCards" class="form-control" value="50" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <!-- [MODIFIED] Added .btn base class -->
                <button type="button" class="btn btn-secondary" id="anki_customStudyCancelBtn">取消</button>
                <button type="submit" class="btn btn-primary" id="anki_startCustomStudyBtn" form="anki_customStudyForm">开始</button>
            </div>
        </div>
    </div>

    <!-- Anki: Statistics Modal -->
    <div class="modal-overlay" id="anki_statsModal" style="display: none;">
        <div class="modal-content large">
            <!-- [MODIFIED] Added .component-header for layout -->
            <div class="modal-header component-header">
                <h2>待办统计</h2><button class="modal-close" id="anki_statsModalCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <p>近30天每日待办卡片数量</p>
                <div class="chart-container">
                    <canvas id="anki_statsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Task: Task Creation Modal -->
    <div class="modal-overlay" id="task_taskModal" style="display: none;">
        <div class="modal-content">
            <!-- [MODIFIED] Added .component-header for layout -->
            <div class="modal-header component-header">
                <h2 id="task_modalTitle">新建任务</h2>
                <button class="modal-close" id="task_modalCloseBtn">×</button>
            </div>
            <div class="modal-body">
            <form id="task_taskForm">
                <div class="form-group">
                    <label for="task_modalName">任务名称</label>
                    <input type="text" id="task_modalName" class="form-control" required placeholder="例如：学习二叉树的先序遍历">
                </div>
            <div class="form-group">
                <label for="task_modalTaskList">所属列表</label>
                <select id="task_modalTaskList" class="form-control" required></select>
            </div>
            <div class="form-group">
                    <label for="task_modalTagsInput">标签 (输入后按回车)</label>
                    <!-- [REFACTORED] for Autocomplete Component -->
                    <div class="autocomplete-container">
                        <div class="tags-input-container">
                            <ul id="task_modalTagsList" class="tags-list"></ul>
                            <input type="text" id="task_modalTagsInput" class="config-tags-input" placeholder="例如：数据结构, 算法">
                        </div>
                        <ul id="task_modalTagsSuggestions" class="autocomplete-suggestions"></ul>
                    </div>
                </div>
            </form>
        </div>
            <div class="modal-footer">
                <!-- [MODIFIED] Added .btn base class -->
                <button type="button" class="btn btn-secondary" id="task_modalCancelBtn">取消</button>
                <button type="submit" class="btn btn-primary" id="task_modalConfirmBtn" form="task_taskForm">创建任务</button>
            </div>
        </div>
    </div>

    <!-- Task: Tag Management Modal -->
    <div class="modal-overlay" id="task_tagModal" style="display: none;">
        <div class="modal-content">
            <!-- [MODIFIED] Added .component-header for layout -->
            <div class="modal-header component-header">
                <h2>管理任务标签</h2>
                <button class="modal-close" id="task_tagModalCloseBtn">×</button>
            </div>
            <div class="modal-body">
            <form id="task_tagForm">
                 <div class="form-group">
                    <label for="task_tagModalInput">添加或移除标签 (输入后按回车)</label>
                    <div class="tags-input-container">
                        <ul id="task_tagModalList" class="tags-list"></ul>
                        <input type="text" id="task_tagModalInput" class="config-tags-input" list="task_existingTagsForTagModal" placeholder="例如：重要, 紧急">
                        <datalist id="task_existingTagsForTagModal"></datalist>
                    </div>
                </div>
            </form>
        </div>
            <div class="modal-footer">
                <!-- [MODIFIED] Added .btn base class -->
                <button type="button" class="btn btn-primary" id="task_tagModalConfirmBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- Settings: Layout Template -->
    <template id="settings_layoutTemplate">
        <div class="settings-nav-panel">
            <div class="settings-nav-header">
                <h3><i class="fas fa-sliders-h"></i> 设置</h3>
            </div>
            <!-- JS will generate <a class="list-item settings-nav-item"> here -->
            <div class="settings-nav-list" id="settings_navList"></div>
        </div>
        <div class="settings-detail-panel">
            <div class="panel" style="height: 100%;">
                <!-- [MODIFIED] Added .component-header for layout -->
                <div class="panel-header component-header">
                    <div id="settings_detailTitle" class="panel-title"></div>
                    <!-- [MODIFIED] Added .action-btn base class -->
                    <div class="panel-actions"><button id="settings_saveBtn" class="action-btn panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button></div>
                </div>
                <div id="settings_detailContent" class="panel-content" style="padding: 25px; overflow-y: auto;">
                    <div class="placeholder-content"><i class="fas fa-cogs fa-3x"></i>
                        <p>从左侧选择一个项目进行配置</p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Settings: General Form Template -->
    <template id="settings_generalFormTemplate">
        <div data-id="general" data-type="general">
            <div class="settings-section">
                <h3 class="settings-section-title">外观与主题</h3>
                <div class="form-group">
                    <label for="settings_themeSelector">选择主题</label>
                    <select id="settings_themeSelector" class="form-control">
                        <option value="">默认 (亮色)</option>
                        <option value="dark">暗黑</option>
                        <option value="large-font">大号字体</option>
                        <option value="larger-font">更大号字体</option>
                    </select>
                </div>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">数据与同步</h3>
                <div class="form-group">
                    <label for="settings_autosaveInterval">自动保存间隔 (分钟)</label>
                    <input type="number" id="settings_autosaveInterval" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label>数据库同步</label>
                    <div style="display: flex; gap: 15px;">
                        <button id="settings_exportDbBtn" class="btn-secondary"><i class="fas fa-download"></i> 导出数据</button>
                        <button id="settings_importDbBtn" class="btn-danger"><i class="fas fa-upload"></i> 导入数据</button>
                    </div>
                    <input type="file" id="settings_importFileInput" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </template>

    <!-- Settings: API Config Form Template -->
    <template id="settings_apiConfigFormTemplate">
        <div data-type="apiConfig">
            <form id="settings_apiConfigFormDynamic" novalidate>
                <input type="hidden" class="config-id">
                <div class="form-group"><label>配置名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>提供商</label><select class="config-provider form-control" required></select></div>
                <div class="form-group"><label>API 地址</label><input type="url" class="config-apiUrl form-control"></div>
                <div class="form-group"><label>API Key</label>
                    <div class="input-group">
                        <input type="password" class="config-apiKey form-control"><button type="button" class="toggle-api-key-visibility input-group-btn"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <div class="form-group"><label>Models (别名:模型名)</label><textarea class="config-models form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此配置</button></div>
            </form>
        </div>
    </template>

    <!-- Settings: Agent Form Template -->
    <template id="settings_agentFormTemplate">
        <div data-type="agent">
            <form id="settings_agentFormDynamic" novalidate>
                <input type="hidden" class="config-id">
                <div class="form-group"><label>角色名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>头像 (2字符)</label><input type="text" class="config-avatar form-control" required maxlength="2"></div>
                <div class="form-group"><label>选择模型</label><select class="config-model form-control" required></select></div>
                <div class="form-group"><label>System Prompt</label><textarea class="config-systemPrompt form-control" rows="8"></textarea></div>
                <div class="form-group"><label>标签</label>
                    <!-- [REFACTORED] for Autocomplete Component -->
                    <div class="autocomplete-container">
                        <div class="tags-input-container">
                            <ul class="tags-list"></ul>
                            <input type="text" class="config-tags-input form-control">
                        </div>
                        <ul class="autocomplete-suggestions"></ul>
                    </div>
                </div>
                <div class="form-group"><label class="form-checkbox-label"><input type="checkbox" class="config-sendHistory"> 发送历史上下文</label></div>
                <div class="form-group"><label>欢迎语 (可选)</label><textarea class="config-hint form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此角色</button></div>
            </form>
        </div>
    </template>

    <!-- [NEW] Settings: Tags Management Template -->
    <template id="settings_tagsFormTemplate">
        <div data-id="tags" data-type="tags">
            <div class="settings-section">
                <h3 class="settings-section-title">添加新标签</h3>
                <form id="settings_addTagForm" style="display: flex; gap: 10px;">
                    <input type="text" id="settings_newTagName" class="form-control" placeholder="例如：编程、生活" required style="flex-grow: 1;">
                    <button type="submit" class="btn btn-primary">添加</button>
                </form>
                <p class="form-help-text">在这里添加的标签，可以在任务管理和AI角色配置中复用。</p>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">所有标签</h3>
                <div id="settings_allTagsList" class="tags-management-list">
                    <!-- Tags will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </template>

    <!-- [NEW] Settings: Task Lists Management Template -->
    <template id="settings_taskListsFormTemplate">
        <div data-id="taskLists" data-type="taskLists">
            <div class="settings-section">
                <h3 class="settings-section-title">添加新任务列表</h3>
                <form id="settings_addTaskListForm" style="display: flex; gap: 10px;">
                    <input type="text" id="settings_newListName" class="form-control" placeholder="例如：工作项目、个人学习" required style="flex-grow: 1;">
                    <button type="submit" class="btn btn-primary">添加</button>
                </form>
                <p class="form-help-text">任务列表用于组织和分类您的任务。</p>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">所有任务列表</h3>
                <div id="settings_allTaskLists" class="settings-item-list">
                    <!-- Task lists will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </template>

</body>

</html>
