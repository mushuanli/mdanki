<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能学习套件</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script> 
    <!-- [新增] 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        loader: {load: ['[tex]/mhchem']},
        tex: {
          packages: {'[+]': ['mhchem']}
        },
        startup: {
          pageReady: () => {
            return window.MathJax.startup.defaultPageReady();
          }
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
  <script type="module" crossorigin>import{marked as Ji}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();const ac=n=>document.querySelector(n),U=n=>document.getElementById(n),wa={anki:U("anki-view"),task:U("task-view"),agent:U("agent-view"),settings:U("settings-view")};let so={activeView:"anki",sessions:[],folders:[],clozeStates:{},fileSubsessions:{},undoStack:[],redoStack:[],currentSessionId:null,currentFolderId:null,currentSubsessionId:null,folderStack:[],agents:[],topics:[],history:[],currentAgentId:null,currentTopicId:null,currentConversationAgentId:null,topicListFilterTag:"all",isLoading:!0,isAiThinking:!1,isTopicsPanelHidden:!1,isSessionSidebarHidden:!1,areAllClozeVisible:!1,movingItems:[],selectedMoveTarget:null,isTopicSelectionMode:!1,selectedTopicIds:[]};const O=new Proxy(so,{get(n,e){if(e in n){const t=n[e];return typeof t=="object"&&t!==null?JSON.parse(JSON.stringify(t)):t}},set(){return console.warn("Direct mutation of appState is not allowed. Use a data service function."),!1}});function re(n){Object.assign(so,n)}var ka=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function oc(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var io={exports:{}};(function(n,e){(function(t,s){n.exports=s()})(ka,function(){var t=function(i,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,f){c.__proto__=f}||function(c,f){for(var d in f)Object.prototype.hasOwnProperty.call(f,d)&&(c[d]=f[d])})(i,o)},s=function(){return(s=Object.assign||function(i){for(var o,c=1,f=arguments.length;c<f;c++)for(var d in o=arguments[c])Object.prototype.hasOwnProperty.call(o,d)&&(i[d]=o[d]);return i}).apply(this,arguments)};function r(i,o,c){for(var f,d=0,p=o.length;d<p;d++)!f&&d in o||((f=f||Array.prototype.slice.call(o,0,d))[d]=o[d]);return i.concat(f||Array.prototype.slice.call(o))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:ka,l=Object.keys,u=Array.isArray;function h(i,o){return typeof o!="object"||l(o).forEach(function(c){i[c]=o[c]}),i}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var m=Object.getPrototypeOf,w={}.hasOwnProperty;function g(i,o){return w.call(i,o)}function C(i,o){typeof o=="function"&&(o=o(m(i))),(typeof Reflect>"u"?l:Reflect.ownKeys)(o).forEach(function(c){M(i,c,o[c])})}var B=Object.defineProperty;function M(i,o,c,f){B(i,o,h(c&&g(c,"get")&&typeof c.get=="function"?{get:c.get,set:c.set,configurable:!0}:{value:c,configurable:!0,writable:!0},f))}function E(i){return{from:function(o){return i.prototype=Object.create(o.prototype),M(i.prototype,"constructor",i),{extend:C.bind(null,i.prototype)}}}}var $=Object.getOwnPropertyDescriptor,Y=[].slice;function G(i,o,c){return Y.call(i,o,c)}function Z(i,o){return o(i)}function X(i){if(!i)throw new Error("Assertion Failed")}function te(i){a.setImmediate?setImmediate(i):setTimeout(i,0)}function ne(i,o){if(typeof o=="string"&&g(i,o))return i[o];if(!o)return i;if(typeof o!="string"){for(var c=[],f=0,d=o.length;f<d;++f){var p=ne(i,o[f]);c.push(p)}return c}var y=o.indexOf(".");if(y!==-1){var v=i[o.substr(0,y)];return v==null?void 0:ne(v,o.substr(y+1))}}function ce(i,o,c){if(i&&o!==void 0&&!("isFrozen"in Object&&Object.isFrozen(i)))if(typeof o!="string"&&"length"in o){X(typeof c!="string"&&"length"in c);for(var f=0,d=o.length;f<d;++f)ce(i,o[f],c[f])}else{var p,y,v=o.indexOf(".");v!==-1?(p=o.substr(0,v),(y=o.substr(v+1))===""?c===void 0?u(i)&&!isNaN(parseInt(p))?i.splice(p,1):delete i[p]:i[p]=c:ce(v=!(v=i[p])||!g(i,p)?i[p]={}:v,y,c)):c===void 0?u(i)&&!isNaN(parseInt(o))?i.splice(o,1):delete i[o]:i[o]=c}}function Q(i){var o,c={};for(o in i)g(i,o)&&(c[o]=i[o]);return c}var ge=[].concat;function ze(i){return ge.apply([],i)}var St="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(ze([8,16,32,64].map(function(i){return["Int","Uint","Float"].map(function(o){return o+i+"Array"})}))).filter(function(i){return a[i]}),Ze=new Set(St.map(function(i){return a[i]})),ve=null;function Ye(i){return ve=new WeakMap,i=function o(c){if(!c||typeof c!="object")return c;var f=ve.get(c);if(f)return f;if(u(c)){f=[],ve.set(c,f);for(var d=0,p=c.length;d<p;++d)f.push(o(c[d]))}else if(Ze.has(c.constructor))f=c;else{var y,v=m(c);for(y in f=v===Object.prototype?{}:Object.create(v),ve.set(c,f),c)g(c,y)&&(f[y]=o(c[y]))}return f}(i),ve=null,i}var El={}.toString;function li(i){return El.call(i).slice(8,-1)}var ci=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Cl=typeof ci=="symbol"?function(i){var o;return i!=null&&(o=i[ci])&&o.apply(i)}:function(){return null};function wt(i,o){return o=i.indexOf(o),0<=o&&i.splice(o,1),0<=o}var Kt={};function et(i){var o,c,f,d;if(arguments.length===1){if(u(i))return i.slice();if(this===Kt&&typeof i=="string")return[i];if(d=Cl(i)){for(c=[];!(f=d.next()).done;)c.push(f.value);return c}if(i==null)return[i];if(typeof(o=i.length)!="number")return[i];for(c=new Array(o);o--;)c[o]=i[o];return c}for(o=arguments.length,c=new Array(o);o--;)c[o]=arguments[o];return c}var ui=typeof Symbol<"u"?function(i){return i[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Tn=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Re=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Tn),Al={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function qt(i,o){this.name=i,this.message=o}function jr(i,o){return i+". Errors: "+Object.keys(o).map(function(c){return o[c].toString()}).filter(function(c,f,d){return d.indexOf(c)===f}).join(`
`)}function Zn(i,o,c,f){this.failures=o,this.failedKeys=f,this.successCount=c,this.message=jr(i,o)}function zt(i,o){this.name="BulkError",this.failures=Object.keys(o).map(function(c){return o[c]}),this.failuresByPos=o,this.message=jr(i,this.failures)}E(qt).from(Error).extend({toString:function(){return this.name+": "+this.message}}),E(Zn).from(qt),E(zt).from(qt);var fi=Re.reduce(function(i,o){return i[o]=o+"Error",i},{}),Ll=qt,ie=Re.reduce(function(i,o){var c=o+"Error";function f(d,p){this.name=c,d?typeof d=="string"?(this.message="".concat(d).concat(p?`
 `+p:""),this.inner=p||null):typeof d=="object"&&(this.message="".concat(d.name," ").concat(d.message),this.inner=d):(this.message=Al[o]||c,this.inner=null)}return E(f).from(Ll),i[o]=f,i},{});ie.Syntax=SyntaxError,ie.Type=TypeError,ie.Range=RangeError;var Rr=Tn.reduce(function(i,o){return i[o+"Error"]=ie[o],i},{}),es=Re.reduce(function(i,o){return["Syntax","Type","Range"].indexOf(o)===-1&&(i[o+"Error"]=ie[o]),i},{});function me(){}function Sn(i){return i}function Ol(i,o){return i==null||i===Sn?o:function(c){return o(i(c))}}function kt(i,o){return function(){i.apply(this,arguments),o.apply(this,arguments)}}function Bl(i,o){return i===me?o:function(){var c=i.apply(this,arguments);c!==void 0&&(arguments[0]=c);var f=this.onsuccess,d=this.onerror;this.onsuccess=null,this.onerror=null;var p=o.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?kt(f,this.onsuccess):f),d&&(this.onerror=this.onerror?kt(d,this.onerror):d),p!==void 0?p:c}}function Nl(i,o){return i===me?o:function(){i.apply(this,arguments);var c=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,o.apply(this,arguments),c&&(this.onsuccess=this.onsuccess?kt(c,this.onsuccess):c),f&&(this.onerror=this.onerror?kt(f,this.onerror):f)}}function Pl(i,o){return i===me?o:function(c){var f=i.apply(this,arguments);h(c,f);var d=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,c=o.apply(this,arguments),d&&(this.onsuccess=this.onsuccess?kt(d,this.onsuccess):d),p&&(this.onerror=this.onerror?kt(p,this.onerror):p),f===void 0?c===void 0?void 0:c:h(f,c)}}function xl(i,o){return i===me?o:function(){return o.apply(this,arguments)!==!1&&i.apply(this,arguments)}}function di(i,o){return i===me?o:function(){var c=i.apply(this,arguments);if(c&&typeof c.then=="function"){for(var f=this,d=arguments.length,p=new Array(d);d--;)p[d]=arguments[d];return c.then(function(){return o.apply(f,p)})}return o.apply(this,arguments)}}es.ModifyError=Zn,es.DexieError=qt,es.BulkError=zt;var Je=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Kr(i){Je=i}var _n={},qr=100,St=typeof Promise>"u"?[]:function(){var i=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[i,m(i),i];var o=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[o,m(o),i]}(),Tn=St[0],Re=St[1],St=St[2],Re=Re&&Re.then,_t=Tn&&Tn.constructor,hi=!!St,In=function(i,o){En.push([i,o]),ts&&(queueMicrotask($l),ts=!1)},pi=!0,ts=!0,Tt=[],ns=[],mi=Sn,ot={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:me,pgp:!1,env:{},finalize:me},ee=ot,En=[],It=0,ss=[];function J(i){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var o=this._PSD=ee;if(typeof i!="function"){if(i!==_n)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&gi(this,this._value))}this._state=null,this._value=null,++o.ref,function c(f,d){try{d(function(p){if(f._state===null){if(p===f)throw new TypeError("A promise cannot be resolved with itself.");var y=f._lib&&Ht();p&&typeof p.then=="function"?c(f,function(v,S){p instanceof J?p._then(v,S):p.then(v,S)}):(f._state=!0,f._value=p,Hr(f)),y&&Ut()}},gi.bind(null,f))}catch(p){gi(f,p)}}(this,i)}var yi={get:function(){var i=ee,o=os;function c(f,d){var p=this,y=!i.global&&(i!==ee||o!==os),v=y&&!ct(),S=new J(function(T,L){vi(p,new zr(Vr(f,i,y,v),Vr(d,i,y,v),T,L,i))});return this._consoleTask&&(S._consoleTask=this._consoleTask),S}return c.prototype=_n,c},set:function(i){M(this,"then",i&&i.prototype===_n?yi:{get:function(){return i},set:yi.set})}};function zr(i,o,c,f,d){this.onFulfilled=typeof i=="function"?i:null,this.onRejected=typeof o=="function"?o:null,this.resolve=c,this.reject=f,this.psd=d}function gi(i,o){var c,f;ns.push(o),i._state===null&&(c=i._lib&&Ht(),o=mi(o),i._state=!1,i._value=o,f=i,Tt.some(function(d){return d._value===f._value})||Tt.push(f),Hr(i),c&&Ut())}function Hr(i){var o=i._listeners;i._listeners=[];for(var c=0,f=o.length;c<f;++c)vi(i,o[c]);var d=i._PSD;--d.ref||d.finalize(),It===0&&(++It,In(function(){--It==0&&bi()},[]))}function vi(i,o){if(i._state!==null){var c=i._state?o.onFulfilled:o.onRejected;if(c===null)return(i._state?o.resolve:o.reject)(i._value);++o.psd.ref,++It,In(Ml,[c,i,o])}else i._listeners.push(o)}function Ml(i,o,c){try{var f,d=o._value;!o._state&&ns.length&&(ns=[]),f=Je&&o._consoleTask?o._consoleTask.run(function(){return i(d)}):i(d),o._state||ns.indexOf(d)!==-1||function(p){for(var y=Tt.length;y;)if(Tt[--y]._value===p._value)return Tt.splice(y,1)}(o),c.resolve(f)}catch(p){c.reject(p)}finally{--It==0&&bi(),--c.psd.ref||c.psd.finalize()}}function $l(){Et(ot,function(){Ht()&&Ut()})}function Ht(){var i=pi;return ts=pi=!1,i}function Ut(){var i,o,c;do for(;0<En.length;)for(i=En,En=[],c=i.length,o=0;o<c;++o){var f=i[o];f[0].apply(null,f[1])}while(0<En.length);ts=pi=!0}function bi(){var i=Tt;Tt=[],i.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var o=ss.slice(0),c=o.length;c;)o[--c]()}function is(i){return new J(_n,!1,i)}function ke(i,o){var c=ee;return function(){var f=Ht(),d=ee;try{return ut(c,!0),i.apply(this,arguments)}catch(p){o&&o(p)}finally{ut(d,!1),f&&Ut()}}}C(J.prototype,{then:yi,_then:function(i,o){vi(this,new zr(null,null,i,o,ee))},catch:function(i){if(arguments.length===1)return this.then(null,i);var o=i,c=arguments[1];return typeof o=="function"?this.then(null,function(f){return(f instanceof o?c:is)(f)}):this.then(null,function(f){return(f&&f.name===o?c:is)(f)})},finally:function(i){return this.then(function(o){return J.resolve(i()).then(function(){return o})},function(o){return J.resolve(i()).then(function(){return is(o)})})},timeout:function(i,o){var c=this;return i<1/0?new J(function(f,d){var p=setTimeout(function(){return d(new ie.Timeout(o))},i);c.then(f,d).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&M(J.prototype,Symbol.toStringTag,"Dexie.Promise"),ot.env=Ur(),C(J,{all:function(){var i=et.apply(null,arguments).map(ls);return new J(function(o,c){i.length===0&&o([]);var f=i.length;i.forEach(function(d,p){return J.resolve(d).then(function(y){i[p]=y,--f||o(i)},c)})})},resolve:function(i){return i instanceof J?i:i&&typeof i.then=="function"?new J(function(o,c){i.then(o,c)}):new J(_n,!0,i)},reject:is,race:function(){var i=et.apply(null,arguments).map(ls);return new J(function(o,c){i.map(function(f){return J.resolve(f).then(o,c)})})},PSD:{get:function(){return ee},set:function(i){return ee=i}},totalEchoes:{get:function(){return os}},newPSD:lt,usePSD:Et,scheduler:{get:function(){return In},set:function(i){In=i}},rejectionMapper:{get:function(){return mi},set:function(i){mi=i}},follow:function(i,o){return new J(function(c,f){return lt(function(d,p){var y=ee;y.unhandleds=[],y.onunhandled=p,y.finalize=kt(function(){var v,S=this;v=function(){S.unhandleds.length===0?d():p(S.unhandleds[0])},ss.push(function T(){v(),ss.splice(ss.indexOf(T),1)}),++It,In(function(){--It==0&&bi()},[])},y.finalize),i()},o,c,f)})}}),_t&&(_t.allSettled&&M(J,"allSettled",function(){var i=et.apply(null,arguments).map(ls);return new J(function(o){i.length===0&&o([]);var c=i.length,f=new Array(c);i.forEach(function(d,p){return J.resolve(d).then(function(y){return f[p]={status:"fulfilled",value:y}},function(y){return f[p]={status:"rejected",reason:y}}).then(function(){return--c||o(f)})})})}),_t.any&&typeof AggregateError<"u"&&M(J,"any",function(){var i=et.apply(null,arguments).map(ls);return new J(function(o,c){i.length===0&&c(new AggregateError([]));var f=i.length,d=new Array(f);i.forEach(function(p,y){return J.resolve(p).then(function(v){return o(v)},function(v){d[y]=v,--f||c(new AggregateError(d))})})})}),_t.withResolvers&&(J.withResolvers=_t.withResolvers));var Ce={awaits:0,echoes:0,id:0},Dl=0,rs=[],as=0,os=0,Fl=0;function lt(i,o,c,f){var d=ee,p=Object.create(d);return p.parent=d,p.ref=0,p.global=!1,p.id=++Fl,ot.env,p.env=hi?{Promise:J,PromiseProp:{value:J,configurable:!0,writable:!0},all:J.all,race:J.race,allSettled:J.allSettled,any:J.any,resolve:J.resolve,reject:J.reject}:{},o&&h(p,o),++d.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},f=Et(p,i,c,f),p.ref===0&&p.finalize(),f}function Vt(){return Ce.id||(Ce.id=++Dl),++Ce.awaits,Ce.echoes+=qr,Ce.id}function ct(){return!!Ce.awaits&&(--Ce.awaits==0&&(Ce.id=0),Ce.echoes=Ce.awaits*qr,!0)}function ls(i){return Ce.echoes&&i&&i.constructor===_t?(Vt(),i.then(function(o){return ct(),o},function(o){return ct(),Ie(o)})):i}function jl(){var i=rs[rs.length-1];rs.pop(),ut(i,!1)}function ut(i,o){var c,f=ee;(o?!Ce.echoes||as++&&i===ee:!as||--as&&i===ee)||queueMicrotask(o?(function(d){++os,Ce.echoes&&--Ce.echoes!=0||(Ce.echoes=Ce.awaits=Ce.id=0),rs.push(ee),ut(d,!0)}).bind(null,i):jl),i!==ee&&(ee=i,f===ot&&(ot.env=Ur()),hi&&(c=ot.env.Promise,o=i.env,(f.global||i.global)&&(Object.defineProperty(a,"Promise",o.PromiseProp),c.all=o.all,c.race=o.race,c.resolve=o.resolve,c.reject=o.reject,o.allSettled&&(c.allSettled=o.allSettled),o.any&&(c.any=o.any))))}function Ur(){var i=a.Promise;return hi?{Promise:i,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:i.all,race:i.race,allSettled:i.allSettled,any:i.any,resolve:i.resolve,reject:i.reject}:{}}function Et(i,o,c,f,d){var p=ee;try{return ut(i,!0),o(c,f,d)}finally{ut(p,!1)}}function Vr(i,o,c,f){return typeof i!="function"?i:function(){var d=ee;c&&Vt(),ut(o,!0);try{return i.apply(this,arguments)}finally{ut(d,!1),f&&queueMicrotask(ct)}}}function wi(i){Promise===_t&&Ce.echoes===0?as===0?i():enqueueNativeMicroTask(i):setTimeout(i,0)}(""+Re).indexOf("[native code]")===-1&&(Vt=ct=me);var Ie=J.reject,Ct="￿",tt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Yr="String expected.",Yt=[],cs="__dbnames",ki="readonly",Si="readwrite";function At(i,o){return i?o?function(){return i.apply(this,arguments)&&o.apply(this,arguments)}:i:o}var Jr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function us(i){return typeof i!="string"||/\./.test(i)?function(o){return o}:function(o){return o[i]===void 0&&i in o&&delete(o=Ye(o))[i],o}}function Gr(){throw ie.Type()}function he(i,o){try{var c=Wr(i),f=Wr(o);if(c!==f)return c==="Array"?1:f==="Array"?-1:c==="binary"?1:f==="binary"?-1:c==="string"?1:f==="string"?-1:c==="Date"?1:f!=="Date"?NaN:-1;switch(c){case"number":case"Date":case"string":return o<i?1:i<o?-1:0;case"binary":return function(d,p){for(var y=d.length,v=p.length,S=y<v?y:v,T=0;T<S;++T)if(d[T]!==p[T])return d[T]<p[T]?-1:1;return y===v?0:y<v?-1:1}(Qr(i),Qr(o));case"Array":return function(d,p){for(var y=d.length,v=p.length,S=y<v?y:v,T=0;T<S;++T){var L=he(d[T],p[T]);if(L!==0)return L}return y===v?0:y<v?-1:1}(i,o)}}catch{}return NaN}function Wr(i){var o=typeof i;return o!="object"?o:ArrayBuffer.isView(i)?"binary":(i=li(i),i==="ArrayBuffer"?"binary":i)}function Qr(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i)}var Xr=(be.prototype._trans=function(i,o,c){var f=this._tx||ee.trans,d=this.name,p=Je&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(i==="readonly"?"read":"write"," ").concat(this.name));function y(T,L,b){if(!b.schema[d])throw new ie.NotFound("Table "+d+" not part of transaction");return o(b.idbtrans,b)}var v=Ht();try{var S=f&&f.db._novip===this.db._novip?f===ee.trans?f._promise(i,y,c):lt(function(){return f._promise(i,y,c)},{trans:f,transless:ee.transless||ee}):function T(L,b,P,_){if(L.idbdb&&(L._state.openComplete||ee.letThrough||L._vip)){var A=L._createTransaction(b,P,L._dbSchema);try{A.create(),L._state.PR1398_maxLoop=3}catch(N){return N.name===fi.InvalidState&&L.isOpen()&&0<--L._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),L.close({disableAutoOpen:!1}),L.open().then(function(){return T(L,b,P,_)})):Ie(N)}return A._promise(b,function(N,I){return lt(function(){return ee.trans=A,_(N,I,A)})}).then(function(N){if(b==="readwrite")try{A.idbtrans.commit()}catch{}return b==="readonly"?N:A._completion.then(function(){return N})})}if(L._state.openComplete)return Ie(new ie.DatabaseClosed(L._state.dbOpenError));if(!L._state.isBeingOpened){if(!L._state.autoOpen)return Ie(new ie.DatabaseClosed);L.open().catch(me)}return L._state.dbReadyPromise.then(function(){return T(L,b,P,_)})}(this.db,i,[this.name],y);return p&&(S._consoleTask=p,S=S.catch(function(T){return console.trace(T),Ie(T)})),S}finally{v&&Ut()}},be.prototype.get=function(i,o){var c=this;return i&&i.constructor===Object?this.where(i).first(o):i==null?Ie(new ie.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return c.core.get({trans:f,key:i}).then(function(d){return c.hook.reading.fire(d)})}).then(o)},be.prototype.where=function(i){if(typeof i=="string")return new this.db.WhereClause(this,i);if(u(i))return new this.db.WhereClause(this,"[".concat(i.join("+"),"]"));var o=l(i);if(o.length===1)return this.where(o[0]).equals(i[o[0]]);var c=this.schema.indexes.concat(this.schema.primKey).filter(function(v){if(v.compound&&o.every(function(T){return 0<=v.keyPath.indexOf(T)})){for(var S=0;S<o.length;++S)if(o.indexOf(v.keyPath[S])===-1)return!1;return!0}return!1}).sort(function(v,S){return v.keyPath.length-S.keyPath.length})[0];if(c&&this.db._maxKey!==Ct){var p=c.keyPath.slice(0,o.length);return this.where(p).equals(p.map(function(S){return i[S]}))}!c&&Je&&console.warn("The query ".concat(JSON.stringify(i)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(o.join("+"),"]"));var f=this.schema.idxByName;function d(v,S){return he(v,S)===0}var y=o.reduce(function(b,S){var T=b[0],L=b[1],b=f[S],P=i[S];return[T||b,T||!b?At(L,b&&b.multi?function(_){return _=ne(_,S),u(_)&&_.some(function(A){return d(P,A)})}:function(_){return d(P,ne(_,S))}):L]},[null,null]),p=y[0],y=y[1];return p?this.where(p.name).equals(i[p.keyPath]).filter(y):c?this.filter(y):this.where(o).equals("")},be.prototype.filter=function(i){return this.toCollection().and(i)},be.prototype.count=function(i){return this.toCollection().count(i)},be.prototype.offset=function(i){return this.toCollection().offset(i)},be.prototype.limit=function(i){return this.toCollection().limit(i)},be.prototype.each=function(i){return this.toCollection().each(i)},be.prototype.toArray=function(i){return this.toCollection().toArray(i)},be.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},be.prototype.orderBy=function(i){return new this.db.Collection(new this.db.WhereClause(this,u(i)?"[".concat(i.join("+"),"]"):i))},be.prototype.reverse=function(){return this.toCollection().reverse()},be.prototype.mapToClass=function(i){var o,c=this.db,f=this.name;function d(){return o!==null&&o.apply(this,arguments)||this}(this.schema.mappedClass=i).prototype instanceof Gr&&(function(S,T){if(typeof T!="function"&&T!==null)throw new TypeError("Class extends value "+String(T)+" is not a constructor or null");function L(){this.constructor=S}t(S,T),S.prototype=T===null?Object.create(T):(L.prototype=T.prototype,new L)}(d,o=i),Object.defineProperty(d.prototype,"db",{get:function(){return c},enumerable:!1,configurable:!0}),d.prototype.table=function(){return f},i=d);for(var p=new Set,y=i.prototype;y;y=m(y))Object.getOwnPropertyNames(y).forEach(function(S){return p.add(S)});function v(S){if(!S)return S;var T,L=Object.create(i.prototype);for(T in S)if(!p.has(T))try{L[T]=S[T]}catch{}return L}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=v,this.hook("reading",v),i},be.prototype.defineClass=function(){return this.mapToClass(function(i){h(this,i)})},be.prototype.add=function(i,o){var c=this,f=this.schema.primKey,d=f.auto,p=f.keyPath,y=i;return p&&d&&(y=us(p)(i)),this._trans("readwrite",function(v){return c.core.mutate({trans:v,type:"add",keys:o!=null?[o]:null,values:[y]})}).then(function(v){return v.numFailures?J.reject(v.failures[0]):v.lastResult}).then(function(v){if(p)try{ce(i,p,v)}catch{}return v})},be.prototype.update=function(i,o){return typeof i!="object"||u(i)?this.where(":id").equals(i).modify(o):(i=ne(i,this.schema.primKey.keyPath),i===void 0?Ie(new ie.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(i).modify(o))},be.prototype.put=function(i,o){var c=this,f=this.schema.primKey,d=f.auto,p=f.keyPath,y=i;return p&&d&&(y=us(p)(i)),this._trans("readwrite",function(v){return c.core.mutate({trans:v,type:"put",values:[y],keys:o!=null?[o]:null})}).then(function(v){return v.numFailures?J.reject(v.failures[0]):v.lastResult}).then(function(v){if(p)try{ce(i,p,v)}catch{}return v})},be.prototype.delete=function(i){var o=this;return this._trans("readwrite",function(c){return o.core.mutate({trans:c,type:"delete",keys:[i]})}).then(function(c){return c.numFailures?J.reject(c.failures[0]):void 0})},be.prototype.clear=function(){var i=this;return this._trans("readwrite",function(o){return i.core.mutate({trans:o,type:"deleteRange",range:Jr})}).then(function(o){return o.numFailures?J.reject(o.failures[0]):void 0})},be.prototype.bulkGet=function(i){var o=this;return this._trans("readonly",function(c){return o.core.getMany({keys:i,trans:c}).then(function(f){return f.map(function(d){return o.hook.reading.fire(d)})})})},be.prototype.bulkAdd=function(i,o,c){var f=this,d=Array.isArray(o)?o:void 0,p=(c=c||(d?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(y){var T=f.schema.primKey,v=T.auto,T=T.keyPath;if(T&&d)throw new ie.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(d&&d.length!==i.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var S=i.length,T=T&&v?i.map(us(T)):i;return f.core.mutate({trans:y,type:"add",keys:d,values:T,wantResults:p}).then(function(A){var b=A.numFailures,P=A.results,_=A.lastResult,A=A.failures;if(b===0)return p?P:_;throw new zt("".concat(f.name,".bulkAdd(): ").concat(b," of ").concat(S," operations failed"),A)})})},be.prototype.bulkPut=function(i,o,c){var f=this,d=Array.isArray(o)?o:void 0,p=(c=c||(d?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(y){var T=f.schema.primKey,v=T.auto,T=T.keyPath;if(T&&d)throw new ie.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(d&&d.length!==i.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var S=i.length,T=T&&v?i.map(us(T)):i;return f.core.mutate({trans:y,type:"put",keys:d,values:T,wantResults:p}).then(function(A){var b=A.numFailures,P=A.results,_=A.lastResult,A=A.failures;if(b===0)return p?P:_;throw new zt("".concat(f.name,".bulkPut(): ").concat(b," of ").concat(S," operations failed"),A)})})},be.prototype.bulkUpdate=function(i){var o=this,c=this.core,f=i.map(function(y){return y.key}),d=i.map(function(y){return y.changes}),p=[];return this._trans("readwrite",function(y){return c.getMany({trans:y,keys:f,cache:"clone"}).then(function(v){var S=[],T=[];i.forEach(function(b,P){var _=b.key,A=b.changes,N=v[P];if(N){for(var I=0,x=Object.keys(A);I<x.length;I++){var D=x[I],F=A[D];if(D===o.schema.primKey.keyPath){if(he(F,_)!==0)throw new ie.Constraint("Cannot update primary key in bulkUpdate()")}else ce(N,D,F)}p.push(P),S.push(_),T.push(N)}});var L=S.length;return c.mutate({trans:y,type:"put",keys:S,values:T,updates:{keys:f,changeSpecs:d}}).then(function(b){var P=b.numFailures,_=b.failures;if(P===0)return L;for(var A=0,N=Object.keys(_);A<N.length;A++){var I,x=N[A],D=p[Number(x)];D!=null&&(I=_[x],delete _[x],_[D]=I)}throw new zt("".concat(o.name,".bulkUpdate(): ").concat(P," of ").concat(L," operations failed"),_)})})})},be.prototype.bulkDelete=function(i){var o=this,c=i.length;return this._trans("readwrite",function(f){return o.core.mutate({trans:f,type:"delete",keys:i})}).then(function(y){var d=y.numFailures,p=y.lastResult,y=y.failures;if(d===0)return p;throw new zt("".concat(o.name,".bulkDelete(): ").concat(d," of ").concat(c," operations failed"),y)})},be);function be(){}function Cn(i){function o(y,v){if(v){for(var S=arguments.length,T=new Array(S-1);--S;)T[S-1]=arguments[S];return c[y].subscribe.apply(null,T),i}if(typeof y=="string")return c[y]}var c={};o.addEventType=p;for(var f=1,d=arguments.length;f<d;++f)p(arguments[f]);return o;function p(y,v,S){if(typeof y!="object"){var T;v=v||xl;var L={subscribers:[],fire:S=S||me,subscribe:function(b){L.subscribers.indexOf(b)===-1&&(L.subscribers.push(b),L.fire=v(L.fire,b))},unsubscribe:function(b){L.subscribers=L.subscribers.filter(function(P){return P!==b}),L.fire=L.subscribers.reduce(v,S)}};return c[y]=o[y]=L}l(T=y).forEach(function(b){var P=T[b];if(u(P))p(b,T[b][0],T[b][1]);else{if(P!=="asap")throw new ie.InvalidArgument("Invalid event config");var _=p(b,Sn,function(){for(var A=arguments.length,N=new Array(A);A--;)N[A]=arguments[A];_.subscribers.forEach(function(I){te(function(){I.apply(null,N)})})})}})}}function An(i,o){return E(o).from({prototype:i}),o}function Jt(i,o){return!(i.filter||i.algorithm||i.or)&&(o?i.justLimit:!i.replayFilter)}function _i(i,o){i.filter=At(i.filter,o)}function Ti(i,o,c){var f=i.replayFilter;i.replayFilter=f?function(){return At(f(),o())}:o,i.justLimit=c&&!f}function fs(i,o){if(i.isPrimKey)return o.primaryKey;var c=o.getIndexByKeyPath(i.index);if(!c)throw new ie.Schema("KeyPath "+i.index+" on object store "+o.name+" is not indexed");return c}function Zr(i,o,c){var f=fs(i,o.schema);return o.openCursor({trans:c,values:!i.keysOnly,reverse:i.dir==="prev",unique:!!i.unique,query:{index:f,range:i.range}})}function ds(i,o,c,f){var d=i.replayFilter?At(i.filter,i.replayFilter()):i.filter;if(i.or){var p={},y=function(v,S,T){var L,b;d&&!d(S,T,function(P){return S.stop(P)},function(P){return S.fail(P)})||((b=""+(L=S.primaryKey))=="[object ArrayBuffer]"&&(b=""+new Uint8Array(L)),g(p,b)||(p[b]=!0,o(v,S,T)))};return Promise.all([i.or._iterate(y,c),ea(Zr(i,f,c),i.algorithm,y,!i.keysOnly&&i.valueMapper)])}return ea(Zr(i,f,c),At(i.algorithm,d),o,!i.keysOnly&&i.valueMapper)}function ea(i,o,c,f){var d=ke(f?function(p,y,v){return c(f(p),y,v)}:c);return i.then(function(p){if(p)return p.start(function(){var y=function(){return p.continue()};o&&!o(p,function(v){return y=v},function(v){p.stop(v),y=me},function(v){p.fail(v),y=me})||d(p.value,p,function(v){return y=v}),y()})})}var Ln=(ta.prototype.execute=function(i){var o=this["@@propmod"];if(o.add!==void 0){var c=o.add;if(u(c))return r(r([],u(i)?i:[],!0),c).sort();if(typeof c=="number")return(Number(i)||0)+c;if(typeof c=="bigint")try{return BigInt(i)+c}catch{return BigInt(0)+c}throw new TypeError("Invalid term ".concat(c))}if(o.remove!==void 0){var f=o.remove;if(u(f))return u(i)?i.filter(function(d){return!f.includes(d)}).sort():[];if(typeof f=="number")return Number(i)-f;if(typeof f=="bigint")try{return BigInt(i)-f}catch{return BigInt(0)-f}throw new TypeError("Invalid subtrahend ".concat(f))}return c=(c=o.replacePrefix)===null||c===void 0?void 0:c[0],c&&typeof i=="string"&&i.startsWith(c)?o.replacePrefix[1]+i.substring(c.length):i},ta);function ta(i){this["@@propmod"]=i}var Rl=(pe.prototype._read=function(i,o){var c=this._ctx;return c.error?c.table._trans(null,Ie.bind(null,c.error)):c.table._trans("readonly",i).then(o)},pe.prototype._write=function(i){var o=this._ctx;return o.error?o.table._trans(null,Ie.bind(null,o.error)):o.table._trans("readwrite",i,"locked")},pe.prototype._addAlgorithm=function(i){var o=this._ctx;o.algorithm=At(o.algorithm,i)},pe.prototype._iterate=function(i,o){return ds(this._ctx,i,o,this._ctx.table.core)},pe.prototype.clone=function(i){var o=Object.create(this.constructor.prototype),c=Object.create(this._ctx);return i&&h(c,i),o._ctx=c,o},pe.prototype.raw=function(){return this._ctx.valueMapper=null,this},pe.prototype.each=function(i){var o=this._ctx;return this._read(function(c){return ds(o,i,c,o.table.core)})},pe.prototype.count=function(i){var o=this;return this._read(function(c){var f=o._ctx,d=f.table.core;if(Jt(f,!0))return d.count({trans:c,query:{index:fs(f,d.schema),range:f.range}}).then(function(y){return Math.min(y,f.limit)});var p=0;return ds(f,function(){return++p,!1},c,d).then(function(){return p})}).then(i)},pe.prototype.sortBy=function(i,o){var c=i.split(".").reverse(),f=c[0],d=c.length-1;function p(S,T){return T?p(S[c[T]],T-1):S[f]}var y=this._ctx.dir==="next"?1:-1;function v(S,T){return he(p(S,d),p(T,d))*y}return this.toArray(function(S){return S.sort(v)}).then(o)},pe.prototype.toArray=function(i){var o=this;return this._read(function(c){var f=o._ctx;if(f.dir==="next"&&Jt(f,!0)&&0<f.limit){var d=f.valueMapper,p=fs(f,f.table.core.schema);return f.table.core.query({trans:c,limit:f.limit,values:!0,query:{index:p,range:f.range}}).then(function(v){return v=v.result,d?v.map(d):v})}var y=[];return ds(f,function(v){return y.push(v)},c,f.table.core).then(function(){return y})},i)},pe.prototype.offset=function(i){var o=this._ctx;return i<=0||(o.offset+=i,Jt(o)?Ti(o,function(){var c=i;return function(f,d){return c===0||(c===1?--c:d(function(){f.advance(c),c=0}),!1)}}):Ti(o,function(){var c=i;return function(){return--c<0}})),this},pe.prototype.limit=function(i){return this._ctx.limit=Math.min(this._ctx.limit,i),Ti(this._ctx,function(){var o=i;return function(c,f,d){return--o<=0&&f(d),0<=o}},!0),this},pe.prototype.until=function(i,o){return _i(this._ctx,function(c,f,d){return!i(c.value)||(f(d),o)}),this},pe.prototype.first=function(i){return this.limit(1).toArray(function(o){return o[0]}).then(i)},pe.prototype.last=function(i){return this.reverse().first(i)},pe.prototype.filter=function(i){var o;return _i(this._ctx,function(c){return i(c.value)}),(o=this._ctx).isMatch=At(o.isMatch,i),this},pe.prototype.and=function(i){return this.filter(i)},pe.prototype.or=function(i){return new this.db.WhereClause(this._ctx.table,i,this)},pe.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},pe.prototype.desc=function(){return this.reverse()},pe.prototype.eachKey=function(i){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,f){i(f.key,f)})},pe.prototype.eachUniqueKey=function(i){return this._ctx.unique="unique",this.eachKey(i)},pe.prototype.eachPrimaryKey=function(i){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,f){i(f.primaryKey,f)})},pe.prototype.keys=function(i){var o=this._ctx;o.keysOnly=!o.isMatch;var c=[];return this.each(function(f,d){c.push(d.key)}).then(function(){return c}).then(i)},pe.prototype.primaryKeys=function(i){var o=this._ctx;if(o.dir==="next"&&Jt(o,!0)&&0<o.limit)return this._read(function(f){var d=fs(o,o.table.core.schema);return o.table.core.query({trans:f,values:!1,limit:o.limit,query:{index:d,range:o.range}})}).then(function(f){return f.result}).then(i);o.keysOnly=!o.isMatch;var c=[];return this.each(function(f,d){c.push(d.primaryKey)}).then(function(){return c}).then(i)},pe.prototype.uniqueKeys=function(i){return this._ctx.unique="unique",this.keys(i)},pe.prototype.firstKey=function(i){return this.limit(1).keys(function(o){return o[0]}).then(i)},pe.prototype.lastKey=function(i){return this.reverse().firstKey(i)},pe.prototype.distinct=function(){var i=this._ctx,i=i.index&&i.table.schema.idxByName[i.index];if(!i||!i.multi)return this;var o={};return _i(this._ctx,function(d){var f=d.primaryKey.toString(),d=g(o,f);return o[f]=!0,!d}),this},pe.prototype.modify=function(i){var o=this,c=this._ctx;return this._write(function(f){var d,p,y;y=typeof i=="function"?i:(d=l(i),p=d.length,function(I){for(var x=!1,D=0;D<p;++D){var F=d[D],j=i[F],R=ne(I,F);j instanceof Ln?(ce(I,F,j.execute(R)),x=!0):R!==j&&(ce(I,F,j),x=!0)}return x});var v=c.table.core,b=v.schema.primaryKey,S=b.outbound,T=b.extractKey,L=200,b=o.db._options.modifyChunkSize;b&&(L=typeof b=="object"?b[v.name]||b["*"]||200:b);function P(I,F){var D=F.failures,F=F.numFailures;A+=I-F;for(var j=0,R=l(D);j<R.length;j++){var H=R[j];_.push(D[H])}}var _=[],A=0,N=[];return o.clone().primaryKeys().then(function(I){function x(F){var j=Math.min(L,I.length-F);return v.getMany({trans:f,keys:I.slice(F,F+j),cache:"immutable"}).then(function(R){for(var H=[],K=[],q=S?[]:null,V=[],z=0;z<j;++z){var W=R[z],ue={value:Ye(W),primKey:I[F+z]};y.call(ue,ue.value,ue)!==!1&&(ue.value==null?V.push(I[F+z]):S||he(T(W),T(ue.value))===0?(K.push(ue.value),S&&q.push(I[F+z])):(V.push(I[F+z]),H.push(ue.value)))}return Promise.resolve(0<H.length&&v.mutate({trans:f,type:"add",values:H}).then(function(fe){for(var de in fe.failures)V.splice(parseInt(de),1);P(H.length,fe)})).then(function(){return(0<K.length||D&&typeof i=="object")&&v.mutate({trans:f,type:"put",keys:q,values:K,criteria:D,changeSpec:typeof i!="function"&&i,isAdditionalChunk:0<F}).then(function(fe){return P(K.length,fe)})}).then(function(){return(0<V.length||D&&i===Ii)&&v.mutate({trans:f,type:"delete",keys:V,criteria:D,isAdditionalChunk:0<F}).then(function(fe){return P(V.length,fe)})}).then(function(){return I.length>F+j&&x(F+L)})})}var D=Jt(c)&&c.limit===1/0&&(typeof i!="function"||i===Ii)&&{index:c.index,range:c.range};return x(0).then(function(){if(0<_.length)throw new Zn("Error modifying one or more objects",_,A,N);return I.length})})})},pe.prototype.delete=function(){var i=this._ctx,o=i.range;return Jt(i)&&(i.isPrimKey||o.type===3)?this._write(function(c){var f=i.table.core.schema.primaryKey,d=o;return i.table.core.count({trans:c,query:{index:f,range:d}}).then(function(p){return i.table.core.mutate({trans:c,type:"deleteRange",range:d}).then(function(y){var v=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new Zn("Could not delete some values",Object.keys(v).map(function(S){return v[S]}),p-y);return p-y})})}):this.modify(Ii)},pe);function pe(){}var Ii=function(i,o){return o.value=null};function Kl(i,o){return i<o?-1:i===o?0:1}function ql(i,o){return o<i?-1:i===o?0:1}function De(i,o,c){return i=i instanceof sa?new i.Collection(i):i,i._ctx.error=new(c||TypeError)(o),i}function Gt(i){return new i.Collection(i,function(){return na("")}).limit(0)}function hs(i,o,c,f){var d,p,y,v,S,T,L,b=c.length;if(!c.every(function(A){return typeof A=="string"}))return De(i,Yr);function P(A){d=A==="next"?function(I){return I.toUpperCase()}:function(I){return I.toLowerCase()},p=A==="next"?function(I){return I.toLowerCase()}:function(I){return I.toUpperCase()},y=A==="next"?Kl:ql;var N=c.map(function(I){return{lower:p(I),upper:d(I)}}).sort(function(I,x){return y(I.lower,x.lower)});v=N.map(function(I){return I.upper}),S=N.map(function(I){return I.lower}),L=(T=A)==="next"?"":f}P("next"),i=new i.Collection(i,function(){return ft(v[0],S[b-1]+f)}),i._ondirectionchange=function(A){P(A)};var _=0;return i._addAlgorithm(function(A,N,I){var x=A.key;if(typeof x!="string")return!1;var D=p(x);if(o(D,S,_))return!0;for(var F=null,j=_;j<b;++j){var R=function(H,K,q,V,z,W){for(var ue=Math.min(H.length,V.length),fe=-1,de=0;de<ue;++de){var Fe=K[de];if(Fe!==V[de])return z(H[de],q[de])<0?H.substr(0,de)+q[de]+q.substr(de+1):z(H[de],V[de])<0?H.substr(0,de)+V[de]+q.substr(de+1):0<=fe?H.substr(0,fe)+K[fe]+q.substr(fe+1):null;z(H[de],Fe)<0&&(fe=de)}return ue<V.length&&W==="next"?H+q.substr(H.length):ue<H.length&&W==="prev"?H.substr(0,q.length):fe<0?null:H.substr(0,fe)+V[fe]+q.substr(fe+1)}(x,D,v[j],S[j],y,T);R===null&&F===null?_=j+1:(F===null||0<y(F,R))&&(F=R)}return N(F!==null?function(){A.continue(F+L)}:I),!1}),i}function ft(i,o,c,f){return{type:2,lower:i,upper:o,lowerOpen:c,upperOpen:f}}function na(i){return{type:1,lower:i,upper:i}}var sa=(Object.defineProperty(Ae.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ae.prototype.between=function(i,o,c,f){c=c!==!1,f=f===!0;try{return 0<this._cmp(i,o)||this._cmp(i,o)===0&&(c||f)&&(!c||!f)?Gt(this):new this.Collection(this,function(){return ft(i,o,!c,!f)})}catch{return De(this,tt)}},Ae.prototype.equals=function(i){return i==null?De(this,tt):new this.Collection(this,function(){return na(i)})},Ae.prototype.above=function(i){return i==null?De(this,tt):new this.Collection(this,function(){return ft(i,void 0,!0)})},Ae.prototype.aboveOrEqual=function(i){return i==null?De(this,tt):new this.Collection(this,function(){return ft(i,void 0,!1)})},Ae.prototype.below=function(i){return i==null?De(this,tt):new this.Collection(this,function(){return ft(void 0,i,!1,!0)})},Ae.prototype.belowOrEqual=function(i){return i==null?De(this,tt):new this.Collection(this,function(){return ft(void 0,i)})},Ae.prototype.startsWith=function(i){return typeof i!="string"?De(this,Yr):this.between(i,i+Ct,!0,!0)},Ae.prototype.startsWithIgnoreCase=function(i){return i===""?this.startsWith(i):hs(this,function(o,c){return o.indexOf(c[0])===0},[i],Ct)},Ae.prototype.equalsIgnoreCase=function(i){return hs(this,function(o,c){return o===c[0]},[i],"")},Ae.prototype.anyOfIgnoreCase=function(){var i=et.apply(Kt,arguments);return i.length===0?Gt(this):hs(this,function(o,c){return c.indexOf(o)!==-1},i,"")},Ae.prototype.startsWithAnyOfIgnoreCase=function(){var i=et.apply(Kt,arguments);return i.length===0?Gt(this):hs(this,function(o,c){return c.some(function(f){return o.indexOf(f)===0})},i,Ct)},Ae.prototype.anyOf=function(){var i=this,o=et.apply(Kt,arguments),c=this._cmp;try{o.sort(c)}catch{return De(this,tt)}if(o.length===0)return Gt(this);var f=new this.Collection(this,function(){return ft(o[0],o[o.length-1])});f._ondirectionchange=function(p){c=p==="next"?i._ascending:i._descending,o.sort(c)};var d=0;return f._addAlgorithm(function(p,y,v){for(var S=p.key;0<c(S,o[d]);)if(++d===o.length)return y(v),!1;return c(S,o[d])===0||(y(function(){p.continue(o[d])}),!1)}),f},Ae.prototype.notEqual=function(i){return this.inAnyRange([[-1/0,i],[i,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ae.prototype.noneOf=function(){var i=et.apply(Kt,arguments);if(i.length===0)return new this.Collection(this);try{i.sort(this._ascending)}catch{return De(this,tt)}var o=i.reduce(function(c,f){return c?c.concat([[c[c.length-1][1],f]]):[[-1/0,f]]},null);return o.push([i[i.length-1],this.db._maxKey]),this.inAnyRange(o,{includeLowers:!1,includeUppers:!1})},Ae.prototype.inAnyRange=function(x,o){var c=this,f=this._cmp,d=this._ascending,p=this._descending,y=this._min,v=this._max;if(x.length===0)return Gt(this);if(!x.every(function(D){return D[0]!==void 0&&D[1]!==void 0&&d(D[0],D[1])<=0}))return De(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ie.InvalidArgument);var S=!o||o.includeLowers!==!1,T=o&&o.includeUppers===!0,L,b=d;function P(D,F){return b(D[0],F[0])}try{(L=x.reduce(function(D,F){for(var j=0,R=D.length;j<R;++j){var H=D[j];if(f(F[0],H[1])<0&&0<f(F[1],H[0])){H[0]=y(H[0],F[0]),H[1]=v(H[1],F[1]);break}}return j===R&&D.push(F),D},[])).sort(P)}catch{return De(this,tt)}var _=0,A=T?function(D){return 0<d(D,L[_][1])}:function(D){return 0<=d(D,L[_][1])},N=S?function(D){return 0<p(D,L[_][0])}:function(D){return 0<=p(D,L[_][0])},I=A,x=new this.Collection(this,function(){return ft(L[0][0],L[L.length-1][1],!S,!T)});return x._ondirectionchange=function(D){b=D==="next"?(I=A,d):(I=N,p),L.sort(P)},x._addAlgorithm(function(D,F,j){for(var R,H=D.key;I(H);)if(++_===L.length)return F(j),!1;return!A(R=H)&&!N(R)||(c._cmp(H,L[_][1])===0||c._cmp(H,L[_][0])===0||F(function(){b===d?D.continue(L[_][0]):D.continue(L[_][1])}),!1)}),x},Ae.prototype.startsWithAnyOf=function(){var i=et.apply(Kt,arguments);return i.every(function(o){return typeof o=="string"})?i.length===0?Gt(this):this.inAnyRange(i.map(function(o){return[o,o+Ct]})):De(this,"startsWithAnyOf() only works with strings")},Ae);function Ae(){}function Ge(i){return ke(function(o){return On(o),i(o.target.error),!1})}function On(i){i.stopPropagation&&i.stopPropagation(),i.preventDefault&&i.preventDefault()}var Bn="storagemutated",Ei="x-storagemutated-1",dt=Cn(null,Bn),zl=(We.prototype._lock=function(){return X(!ee.global),++this._reculock,this._reculock!==1||ee.global||(ee.lockOwnerFor=this),this},We.prototype._unlock=function(){if(X(!ee.global),--this._reculock==0)for(ee.global||(ee.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var i=this._blockedFuncs.shift();try{Et(i[1],i[0])}catch{}}return this},We.prototype._locked=function(){return this._reculock&&ee.lockOwnerFor!==this},We.prototype.create=function(i){var o=this;if(!this.mode)return this;var c=this.db.idbdb,f=this.db._state.dbOpenError;if(X(!this.idbtrans),!i&&!c)switch(f&&f.name){case"DatabaseClosedError":throw new ie.DatabaseClosed(f);case"MissingAPIError":throw new ie.MissingAPI(f.message,f);default:throw new ie.OpenFailed(f)}if(!this.active)throw new ie.TransactionInactive;return X(this._completion._state===null),(i=this.idbtrans=i||(this.db.core||c).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=ke(function(d){On(d),o._reject(i.error)}),i.onabort=ke(function(d){On(d),o.active&&o._reject(new ie.Abort(i.error)),o.active=!1,o.on("abort").fire(d)}),i.oncomplete=ke(function(){o.active=!1,o._resolve(),"mutatedParts"in i&&dt.storagemutated.fire(i.mutatedParts)}),this},We.prototype._promise=function(i,o,c){var f=this;if(i==="readwrite"&&this.mode!=="readwrite")return Ie(new ie.ReadOnly("Transaction is readonly"));if(!this.active)return Ie(new ie.TransactionInactive);if(this._locked())return new J(function(p,y){f._blockedFuncs.push([function(){f._promise(i,o,c).then(p,y)},ee])});if(c)return lt(function(){var p=new J(function(y,v){f._lock();var S=o(y,v,f);S&&S.then&&S.then(y,v)});return p.finally(function(){return f._unlock()}),p._lib=!0,p});var d=new J(function(p,y){var v=o(p,y,f);v&&v.then&&v.then(p,y)});return d._lib=!0,d},We.prototype._root=function(){return this.parent?this.parent._root():this},We.prototype.waitFor=function(i){var o,c=this._root(),f=J.resolve(i);c._waitingFor?c._waitingFor=c._waitingFor.then(function(){return f}):(c._waitingFor=f,c._waitingQueue=[],o=c.idbtrans.objectStore(c.storeNames[0]),function p(){for(++c._spinCount;c._waitingQueue.length;)c._waitingQueue.shift()();c._waitingFor&&(o.get(-1/0).onsuccess=p)}());var d=c._waitingFor;return new J(function(p,y){f.then(function(v){return c._waitingQueue.push(ke(p.bind(null,v)))},function(v){return c._waitingQueue.push(ke(y.bind(null,v)))}).finally(function(){c._waitingFor===d&&(c._waitingFor=null)})})},We.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ie.Abort))},We.prototype.table=function(i){var o=this._memoizedTables||(this._memoizedTables={});if(g(o,i))return o[i];var c=this.schema[i];if(!c)throw new ie.NotFound("Table "+i+" not part of transaction");return c=new this.db.Table(i,c,this),c.core=this.db.core.table(i),o[i]=c},We);function We(){}function Ci(i,o,c,f,d,p,y){return{name:i,keyPath:o,unique:c,multi:f,auto:d,compound:p,src:(c&&!y?"&":"")+(f?"*":"")+(d?"++":"")+ia(o)}}function ia(i){return typeof i=="string"?i:i?"["+[].join.call(i,"+")+"]":""}function Ai(i,o,c){return{name:i,primKey:o,indexes:c,mappedClass:null,idxByName:(f=function(d){return[d.name,d]},c.reduce(function(d,p,y){return y=f(p,y),y&&(d[y[0]]=y[1]),d},{}))};var f}var Nn=function(i){try{return i.only([[]]),Nn=function(){return[[]]},[[]]}catch{return Nn=function(){return Ct},Ct}};function Li(i){return i==null?function(){}:typeof i=="string"?(o=i).split(".").length===1?function(c){return c[o]}:function(c){return ne(c,o)}:function(c){return ne(c,i)};var o}function ra(i){return[].slice.call(i)}var Hl=0;function Pn(i){return i==null?":id":typeof i=="string"?i:"[".concat(i.join("+"),"]")}function Ul(i,o,S){function f(I){if(I.type===3)return null;if(I.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var _=I.lower,A=I.upper,N=I.lowerOpen,I=I.upperOpen;return _===void 0?A===void 0?null:o.upperBound(A,!!I):A===void 0?o.lowerBound(_,!!N):o.bound(_,A,!!N,!!I)}function d(P){var _,A=P.name;return{name:A,schema:P,mutate:function(N){var I=N.trans,x=N.type,D=N.keys,F=N.values,j=N.range;return new Promise(function(R,H){R=ke(R);var K=I.objectStore(A),q=K.keyPath==null,V=x==="put"||x==="add";if(!V&&x!=="delete"&&x!=="deleteRange")throw new Error("Invalid operation type: "+x);var z,W=(D||F||{length:1}).length;if(D&&F&&D.length!==F.length)throw new Error("Given keys array must have same length as given values array.");if(W===0)return R({numFailures:0,failures:{},results:[],lastResult:void 0});function ue(xe){++Fe,On(xe)}var fe=[],de=[],Fe=0;if(x==="deleteRange"){if(j.type===4)return R({numFailures:Fe,failures:de,results:[],lastResult:void 0});j.type===3?fe.push(z=K.clear()):fe.push(z=K.delete(f(j)))}else{var q=V?q?[F,D]:[F,null]:[D,null],le=q[0],Oe=q[1];if(V)for(var Be=0;Be<W;++Be)fe.push(z=Oe&&Oe[Be]!==void 0?K[x](le[Be],Oe[Be]):K[x](le[Be])),z.onerror=ue;else for(Be=0;Be<W;++Be)fe.push(z=K[x](le[Be])),z.onerror=ue}function Es(xe){xe=xe.target.result,fe.forEach(function(Bt,Yi){return Bt.error!=null&&(de[Yi]=Bt.error)}),R({numFailures:Fe,failures:de,results:x==="delete"?D:fe.map(function(Bt){return Bt.result}),lastResult:xe})}z.onerror=function(xe){ue(xe),Es(xe)},z.onsuccess=Es})},getMany:function(N){var I=N.trans,x=N.keys;return new Promise(function(D,F){D=ke(D);for(var j,R=I.objectStore(A),H=x.length,K=new Array(H),q=0,V=0,z=function(fe){fe=fe.target,K[fe._pos]=fe.result,++V===q&&D(K)},W=Ge(F),ue=0;ue<H;++ue)x[ue]!=null&&((j=R.get(x[ue]))._pos=ue,j.onsuccess=z,j.onerror=W,++q);q===0&&D(K)})},get:function(N){var I=N.trans,x=N.key;return new Promise(function(D,F){D=ke(D);var j=I.objectStore(A).get(x);j.onsuccess=function(R){return D(R.target.result)},j.onerror=Ge(F)})},query:(_=T,function(N){return new Promise(function(I,x){I=ke(I);var D,F,j,q=N.trans,R=N.values,H=N.limit,z=N.query,K=H===1/0?void 0:H,V=z.index,z=z.range,q=q.objectStore(A),V=V.isPrimaryKey?q:q.index(V.name),z=f(z);if(H===0)return I({result:[]});_?((K=R?V.getAll(z,K):V.getAllKeys(z,K)).onsuccess=function(W){return I({result:W.target.result})},K.onerror=Ge(x)):(D=0,F=!R&&"openKeyCursor"in V?V.openKeyCursor(z):V.openCursor(z),j=[],F.onsuccess=function(W){var ue=F.result;return ue?(j.push(R?ue.value:ue.primaryKey),++D===H?I({result:j}):void ue.continue()):I({result:j})},F.onerror=Ge(x))})}),openCursor:function(N){var I=N.trans,x=N.values,D=N.query,F=N.reverse,j=N.unique;return new Promise(function(R,H){R=ke(R);var V=D.index,K=D.range,q=I.objectStore(A),q=V.isPrimaryKey?q:q.index(V.name),V=F?j?"prevunique":"prev":j?"nextunique":"next",z=!x&&"openKeyCursor"in q?q.openKeyCursor(f(K),V):q.openCursor(f(K),V);z.onerror=Ge(H),z.onsuccess=ke(function(W){var ue,fe,de,Fe,le=z.result;le?(le.___id=++Hl,le.done=!1,ue=le.continue.bind(le),fe=(fe=le.continuePrimaryKey)&&fe.bind(le),de=le.advance.bind(le),Fe=function(){throw new Error("Cursor not stopped")},le.trans=I,le.stop=le.continue=le.continuePrimaryKey=le.advance=function(){throw new Error("Cursor not started")},le.fail=ke(H),le.next=function(){var Oe=this,Be=1;return this.start(function(){return Be--?Oe.continue():Oe.stop()}).then(function(){return Oe})},le.start=function(Oe){function Be(){if(z.result)try{Oe()}catch(xe){le.fail(xe)}else le.done=!0,le.start=function(){throw new Error("Cursor behind last entry")},le.stop()}var Es=new Promise(function(xe,Bt){xe=ke(xe),z.onerror=Ge(Bt),le.fail=Bt,le.stop=function(Yi){le.stop=le.continue=le.continuePrimaryKey=le.advance=Fe,xe(Yi)}});return z.onsuccess=ke(function(xe){z.onsuccess=Be,Be()}),le.continue=ue,le.continuePrimaryKey=fe,le.advance=de,Be(),Es},R(le)):R(null)},H)})},count:function(N){var I=N.query,x=N.trans,D=I.index,F=I.range;return new Promise(function(j,R){var H=x.objectStore(A),K=D.isPrimaryKey?H:H.index(D.name),H=f(F),K=H?K.count(H):K.count();K.onsuccess=ke(function(q){return j(q.target.result)}),K.onerror=Ge(R)})}}}var p,y,v,L=(y=S,v=ra((p=i).objectStoreNames),{schema:{name:p.name,tables:v.map(function(P){return y.objectStore(P)}).map(function(P){var _=P.keyPath,I=P.autoIncrement,A=u(_),N={},I={name:P.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:_==null,compound:A,keyPath:_,autoIncrement:I,unique:!0,extractKey:Li(_)},indexes:ra(P.indexNames).map(function(x){return P.index(x)}).map(function(j){var D=j.name,F=j.unique,R=j.multiEntry,j=j.keyPath,R={name:D,compound:u(j),keyPath:j,unique:F,multiEntry:R,extractKey:Li(j)};return N[Pn(j)]=R}),getIndexByKeyPath:function(x){return N[Pn(x)]}};return N[":id"]=I.primaryKey,_!=null&&(N[Pn(_)]=I.primaryKey),I})},hasGetAll:0<v.length&&"getAll"in y.objectStore(v[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),S=L.schema,T=L.hasGetAll,L=S.tables.map(d),b={};return L.forEach(function(P){return b[P.name]=P}),{stack:"dbcore",transaction:i.transaction.bind(i),table:function(P){if(!b[P])throw new Error("Table '".concat(P,"' not found"));return b[P]},MIN_KEY:-1/0,MAX_KEY:Nn(o),schema:S}}function Vl(i,o,c,f){var d=c.IDBKeyRange;return c.indexedDB,{dbcore:(f=Ul(o,d,f),i.dbcore.reduce(function(p,y){return y=y.create,s(s({},p),y(p))},f))}}function ps(i,f){var c=f.db,f=Vl(i._middlewares,c,i._deps,f);i.core=f.dbcore,i.tables.forEach(function(d){var p=d.name;i.core.schema.tables.some(function(y){return y.name===p})&&(d.core=i.core.table(p),i[p]instanceof i.Table&&(i[p].core=d.core))})}function ms(i,o,c,f){c.forEach(function(d){var p=f[d];o.forEach(function(y){var v=function S(T,L){return $(T,L)||(T=m(T))&&S(T,L)}(y,d);(!v||"value"in v&&v.value===void 0)&&(y===i.Transaction.prototype||y instanceof i.Transaction?M(y,d,{get:function(){return this.table(d)},set:function(S){B(this,d,{value:S,writable:!0,configurable:!0,enumerable:!0})}}):y[d]=new i.Table(d,p))})})}function Oi(i,o){o.forEach(function(c){for(var f in c)c[f]instanceof i.Table&&delete c[f]})}function Yl(i,o){return i._cfg.version-o._cfg.version}function Jl(i,o,c,f){var d=i._dbSchema;c.objectStoreNames.contains("$meta")&&!d.$meta&&(d.$meta=Ai("$meta",oa("")[0],[]),i._storeNames.push("$meta"));var p=i._createTransaction("readwrite",i._storeNames,d);p.create(c),p._completion.catch(f);var y=p._reject.bind(p),v=ee.transless||ee;lt(function(){return ee.trans=p,ee.transless=v,o!==0?(ps(i,c),T=o,((S=p).storeNames.includes("$meta")?S.table("$meta").get("version").then(function(L){return L??T}):J.resolve(T)).then(function(L){return P=L,_=p,A=c,N=[],L=(b=i)._versions,I=b._dbSchema=gs(0,b.idbdb,A),(L=L.filter(function(x){return x._cfg.version>=P})).length!==0?(L.forEach(function(x){N.push(function(){var D=I,F=x._cfg.dbschema;vs(b,D,A),vs(b,F,A),I=b._dbSchema=F;var j=Bi(D,F);j.add.forEach(function(V){Ni(A,V[0],V[1].primKey,V[1].indexes)}),j.change.forEach(function(V){if(V.recreate)throw new ie.Upgrade("Not yet support for changing primary key");var z=A.objectStore(V.name);V.add.forEach(function(W){return ys(z,W)}),V.change.forEach(function(W){z.deleteIndex(W.name),ys(z,W)}),V.del.forEach(function(W){return z.deleteIndex(W)})});var R=x._cfg.contentUpgrade;if(R&&x._cfg.version>P){ps(b,A),_._memoizedTables={};var H=Q(F);j.del.forEach(function(V){H[V]=D[V]}),Oi(b,[b.Transaction.prototype]),ms(b,[b.Transaction.prototype],l(H),H),_.schema=H;var K,q=ui(R);return q&&Vt(),j=J.follow(function(){var V;(K=R(_))&&q&&(V=ct.bind(null,null),K.then(V,V))}),K&&typeof K.then=="function"?J.resolve(K):j.then(function(){return K})}}),N.push(function(D){var F,j,R=x._cfg.dbschema;F=R,j=D,[].slice.call(j.db.objectStoreNames).forEach(function(H){return F[H]==null&&j.db.deleteObjectStore(H)}),Oi(b,[b.Transaction.prototype]),ms(b,[b.Transaction.prototype],b._storeNames,b._dbSchema),_.schema=b._dbSchema}),N.push(function(D){b.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(b.idbdb.version/10)===x._cfg.version?(b.idbdb.deleteObjectStore("$meta"),delete b._dbSchema.$meta,b._storeNames=b._storeNames.filter(function(F){return F!=="$meta"})):D.objectStore("$meta").put(x._cfg.version,"version"))})}),function x(){return N.length?J.resolve(N.shift()(_.idbtrans)).then(x):J.resolve()}().then(function(){aa(I,A)})):J.resolve();var b,P,_,A,N,I}).catch(y)):(l(d).forEach(function(L){Ni(c,L,d[L].primKey,d[L].indexes)}),ps(i,c),void J.follow(function(){return i.on.populate.fire(p)}).catch(y));var S,T})}function Gl(i,o){aa(i._dbSchema,o),o.db.version%10!=0||o.objectStoreNames.contains("$meta")||o.db.createObjectStore("$meta").add(Math.ceil(o.db.version/10-1),"version");var c=gs(0,i.idbdb,o);vs(i,i._dbSchema,o);for(var f=0,d=Bi(c,i._dbSchema).change;f<d.length;f++){var p=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var v=o.objectStore(y.name);y.add.forEach(function(S){Je&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(S.src)),ys(v,S)})}(d[f]);if(typeof p=="object")return p.value}}function Bi(i,o){var c,f={del:[],add:[],change:[]};for(c in i)o[c]||f.del.push(c);for(c in o){var d=i[c],p=o[c];if(d){var y={name:c,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(d.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||d.primKey.auto!==p.primKey.auto)y.recreate=!0,f.change.push(y);else{var v=d.idxByName,S=p.idxByName,T=void 0;for(T in v)S[T]||y.del.push(T);for(T in S){var L=v[T],b=S[T];L?L.src!==b.src&&y.change.push(b):y.add.push(b)}(0<y.del.length||0<y.add.length||0<y.change.length)&&f.change.push(y)}}else f.add.push([c,p])}return f}function Ni(i,o,c,f){var d=i.db.createObjectStore(o,c.keyPath?{keyPath:c.keyPath,autoIncrement:c.auto}:{autoIncrement:c.auto});return f.forEach(function(p){return ys(d,p)}),d}function aa(i,o){l(i).forEach(function(c){o.db.objectStoreNames.contains(c)||(Je&&console.debug("Dexie: Creating missing table",c),Ni(o,c,i[c].primKey,i[c].indexes))})}function ys(i,o){i.createIndex(o.name,o.keyPath,{unique:o.unique,multiEntry:o.multi})}function gs(i,o,c){var f={};return G(o.objectStoreNames,0).forEach(function(d){for(var p=c.objectStore(d),y=Ci(ia(T=p.keyPath),T||"",!0,!1,!!p.autoIncrement,T&&typeof T!="string",!0),v=[],S=0;S<p.indexNames.length;++S){var L=p.index(p.indexNames[S]),T=L.keyPath,L=Ci(L.name,T,!!L.unique,!!L.multiEntry,!1,T&&typeof T!="string",!1);v.push(L)}f[d]=Ai(d,y,v)}),f}function vs(i,o,c){for(var f=c.db.objectStoreNames,d=0;d<f.length;++d){var p=f[d],y=c.objectStore(p);i._hasGetAll="getAll"in y;for(var v=0;v<y.indexNames.length;++v){var S=y.indexNames[v],T=y.index(S).keyPath,L=typeof T=="string"?T:"["+G(T).join("+")+"]";!o[p]||(T=o[p].idxByName[L])&&(T.name=S,delete o[p].idxByName[L],o[p].idxByName[S]=T)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(i._hasGetAll=!1)}function oa(i){return i.split(",").map(function(o,c){var f=(o=o.trim()).replace(/([&*]|\+\+)/g,""),d=/^\[/.test(f)?f.match(/^\[(.*)\]$/)[1].split("+"):f;return Ci(f,d||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),u(d),c===0)})}var Wl=(bs.prototype._parseStoresSpec=function(i,o){l(i).forEach(function(c){if(i[c]!==null){var f=oa(i[c]),d=f.shift();if(d.unique=!0,d.multi)throw new ie.Schema("Primary key cannot be multi-valued");f.forEach(function(p){if(p.auto)throw new ie.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new ie.Schema("Index must have a name and cannot be an empty string")}),o[c]=Ai(c,d,f)}})},bs.prototype.stores=function(c){var o=this.db;this._cfg.storesSource=this._cfg.storesSource?h(this._cfg.storesSource,c):c;var c=o._versions,f={},d={};return c.forEach(function(p){h(f,p._cfg.storesSource),d=p._cfg.dbschema={},p._parseStoresSpec(f,d)}),o._dbSchema=d,Oi(o,[o._allTables,o,o.Transaction.prototype]),ms(o,[o._allTables,o,o.Transaction.prototype,this._cfg.tables],l(d),d),o._storeNames=l(d),this},bs.prototype.upgrade=function(i){return this._cfg.contentUpgrade=di(this._cfg.contentUpgrade||me,i),this},bs);function bs(){}function Pi(i,o){var c=i._dbNamesDB;return c||(c=i._dbNamesDB=new nt(cs,{addons:[],indexedDB:i,IDBKeyRange:o})).version(1).stores({dbnames:"name"}),c.table("dbnames")}function xi(i){return i&&typeof i.databases=="function"}function Mi(i){return lt(function(){return ee.letThrough=!0,i()})}function $i(i){return!("from"in i)}var Le=function(i,o){if(!this){var c=new Le;return i&&"d"in i&&h(c,i),c}h(this,arguments.length?{d:1,from:i,to:1<arguments.length?o:i}:{d:0})};function xn(i,o,c){var f=he(o,c);if(!isNaN(f)){if(0<f)throw RangeError();if($i(i))return h(i,{from:o,to:c,d:1});var d=i.l,f=i.r;if(he(c,i.from)<0)return d?xn(d,o,c):i.l={from:o,to:c,d:1,l:null,r:null},ca(i);if(0<he(o,i.to))return f?xn(f,o,c):i.r={from:o,to:c,d:1,l:null,r:null},ca(i);he(o,i.from)<0&&(i.from=o,i.l=null,i.d=f?f.d+1:1),0<he(c,i.to)&&(i.to=c,i.r=null,i.d=i.l?i.l.d+1:1),c=!i.r,d&&!i.l&&Mn(i,d),f&&c&&Mn(i,f)}}function Mn(i,o){$i(o)||function c(f,S){var p=S.from,y=S.to,v=S.l,S=S.r;xn(f,p,y),v&&c(f,v),S&&c(f,S)}(i,o)}function la(i,o){var c=ws(o),f=c.next();if(f.done)return!1;for(var d=f.value,p=ws(i),y=p.next(d.from),v=y.value;!f.done&&!y.done;){if(he(v.from,d.to)<=0&&0<=he(v.to,d.from))return!0;he(d.from,v.from)<0?d=(f=c.next(v.from)).value:v=(y=p.next(d.from)).value}return!1}function ws(i){var o=$i(i)?null:{s:0,n:i};return{next:function(c){for(var f=0<arguments.length;o;)switch(o.s){case 0:if(o.s=1,f)for(;o.n.l&&he(c,o.n.from)<0;)o={up:o,n:o.n.l,s:1};else for(;o.n.l;)o={up:o,n:o.n.l,s:1};case 1:if(o.s=2,!f||he(c,o.n.to)<=0)return{value:o.n,done:!1};case 2:if(o.n.r){o.s=3,o={up:o,n:o.n.r,s:0};continue}case 3:o=o.up}return{done:!0}}}}function ca(i){var o,c,f=(((o=i.r)===null||o===void 0?void 0:o.d)||0)-(((c=i.l)===null||c===void 0?void 0:c.d)||0),d=1<f?"r":f<-1?"l":"";d&&(o=d=="r"?"l":"r",c=s({},i),f=i[d],i.from=f.from,i.to=f.to,i[d]=f[d],c[d]=f[o],(i[o]=c).d=ua(c)),i.d=ua(i)}function ua(c){var o=c.r,c=c.l;return(o?c?Math.max(o.d,c.d):o.d:c?c.d:0)+1}function ks(i,o){return l(o).forEach(function(c){i[c]?Mn(i[c],o[c]):i[c]=function f(d){var p,y,v={};for(p in d)g(d,p)&&(y=d[p],v[p]=!y||typeof y!="object"||Ze.has(y.constructor)?y:f(y));return v}(o[c])}),i}function Di(i,o){return i.all||o.all||Object.keys(i).some(function(c){return o[c]&&la(o[c],i[c])})}C(Le.prototype,((Re={add:function(i){return Mn(this,i),this},addKey:function(i){return xn(this,i,i),this},addKeys:function(i){var o=this;return i.forEach(function(c){return xn(o,c,c)}),this},hasKey:function(i){var o=ws(this).next(i).value;return o&&he(o.from,i)<=0&&0<=he(o.to,i)}})[ci]=function(){return ws(this)},Re));var Lt={},Fi={},ji=!1;function Ss(i){ks(Fi,i),ji||(ji=!0,setTimeout(function(){ji=!1,Ri(Fi,!(Fi={}))},0))}function Ri(i,o){o===void 0&&(o=!1);var c=new Set;if(i.all)for(var f=0,d=Object.values(Lt);f<d.length;f++)fa(y=d[f],i,c,o);else for(var p in i){var y,v=/^idb\:\/\/(.*)\/(.*)\//.exec(p);v&&(p=v[1],v=v[2],(y=Lt["idb://".concat(p,"/").concat(v)])&&fa(y,i,c,o))}c.forEach(function(S){return S()})}function fa(i,o,c,f){for(var d=[],p=0,y=Object.entries(i.queries.query);p<y.length;p++){for(var v=y[p],S=v[0],T=[],L=0,b=v[1];L<b.length;L++){var P=b[L];Di(o,P.obsSet)?P.subscribers.forEach(function(I){return c.add(I)}):f&&T.push(P)}f&&d.push([S,T])}if(f)for(var _=0,A=d;_<A.length;_++){var N=A[_],S=N[0],T=N[1];i.queries.query[S]=T}}function Ql(i){var o=i._state,c=i._deps.indexedDB;if(o.isBeingOpened||i.idbdb)return o.dbReadyPromise.then(function(){return o.dbOpenError?Ie(o.dbOpenError):i});o.isBeingOpened=!0,o.dbOpenError=null,o.openComplete=!1;var f=o.openCanceller,d=Math.round(10*i.verno),p=!1;function y(){if(o.openCanceller!==f)throw new ie.DatabaseClosed("db.open() was cancelled")}function v(){return new J(function(P,_){if(y(),!c)throw new ie.MissingAPI;var A=i.name,N=o.autoSchema||!d?c.open(A):c.open(A,d);if(!N)throw new ie.MissingAPI;N.onerror=Ge(_),N.onblocked=ke(i._fireOnBlocked),N.onupgradeneeded=ke(function(I){var x;L=N.transaction,o.autoSchema&&!i._options.allowEmptyDB?(N.onerror=On,L.abort(),N.result.close(),(x=c.deleteDatabase(A)).onsuccess=x.onerror=ke(function(){_(new ie.NoSuchDatabase("Database ".concat(A," doesnt exist")))})):(L.onerror=Ge(_),I=I.oldVersion>Math.pow(2,62)?0:I.oldVersion,b=I<1,i.idbdb=N.result,p&&Gl(i,L),Jl(i,I/10,L,_))},_),N.onsuccess=ke(function(){L=null;var I,x,D,F,j,R=i.idbdb=N.result,H=G(R.objectStoreNames);if(0<H.length)try{var K=R.transaction((F=H).length===1?F[0]:F,"readonly");if(o.autoSchema)x=R,D=K,(I=i).verno=x.version/10,D=I._dbSchema=gs(0,x,D),I._storeNames=G(x.objectStoreNames,0),ms(I,[I._allTables],l(D),D);else if(vs(i,i._dbSchema,K),((j=Bi(gs(0,(j=i).idbdb,K),j._dbSchema)).add.length||j.change.some(function(q){return q.add.length||q.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),R.close(),d=R.version+1,p=!0,P(v());ps(i,K)}catch{}Yt.push(i),R.onversionchange=ke(function(q){o.vcFired=!0,i.on("versionchange").fire(q)}),R.onclose=ke(function(q){i.on("close").fire(q)}),b&&(j=i._deps,K=A,R=j.indexedDB,j=j.IDBKeyRange,xi(R)||K===cs||Pi(R,j).put({name:K}).catch(me)),P()},_)}).catch(function(P){switch(P==null?void 0:P.name){case"UnknownError":if(0<o.PR1398_maxLoop)return o.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),v();break;case"VersionError":if(0<d)return d=0,v()}return J.reject(P)})}var S,T=o.dbReadyResolve,L=null,b=!1;return J.race([f,(typeof navigator>"u"?J.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(P){function _(){return indexedDB.databases().finally(P)}S=setInterval(_,100),_()}).finally(function(){return clearInterval(S)}):Promise.resolve()).then(v)]).then(function(){return y(),o.onReadyBeingFired=[],J.resolve(Mi(function(){return i.on.ready.fire(i.vip)})).then(function P(){if(0<o.onReadyBeingFired.length){var _=o.onReadyBeingFired.reduce(di,me);return o.onReadyBeingFired=[],J.resolve(Mi(function(){return _(i.vip)})).then(P)}})}).finally(function(){o.openCanceller===f&&(o.onReadyBeingFired=null,o.isBeingOpened=!1)}).catch(function(P){o.dbOpenError=P;try{L&&L.abort()}catch{}return f===o.openCanceller&&i._close(),Ie(P)}).finally(function(){o.openComplete=!0,T()}).then(function(){var P;return b&&(P={},i.tables.forEach(function(_){_.schema.indexes.forEach(function(A){A.name&&(P["idb://".concat(i.name,"/").concat(_.name,"/").concat(A.name)]=new Le(-1/0,[[[]]]))}),P["idb://".concat(i.name,"/").concat(_.name,"/")]=P["idb://".concat(i.name,"/").concat(_.name,"/:dels")]=new Le(-1/0,[[[]]])}),dt(Bn).fire(P),Ri(P,!0)),i})}function Ki(i){function o(p){return i.next(p)}var c=d(o),f=d(function(p){return i.throw(p)});function d(p){return function(S){var v=p(S),S=v.value;return v.done?S:S&&typeof S.then=="function"?S.then(c,f):u(S)?Promise.all(S).then(c,f):c(S)}}return d(o)()}function _s(i,o,c){for(var f=u(i)?i.slice():[i],d=0;d<c;++d)f.push(o);return f}var Xl={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(i){return s(s({},i),{table:function(o){var c=i.table(o),f=c.schema,d={},p=[];function y(b,P,_){var A=Pn(b),N=d[A]=d[A]||[],I=b==null?0:typeof b=="string"?1:b.length,x=0<P,x=s(s({},_),{name:x?"".concat(A,"(virtual-from:").concat(_.name,")"):_.name,lowLevelIndex:_,isVirtual:x,keyTail:P,keyLength:I,extractKey:Li(b),unique:!x&&_.unique});return N.push(x),x.isPrimaryKey||p.push(x),1<I&&y(I===2?b[0]:b.slice(0,I-1),P+1,_),N.sort(function(D,F){return D.keyTail-F.keyTail}),x}o=y(f.primaryKey.keyPath,0,f.primaryKey),d[":id"]=[o];for(var v=0,S=f.indexes;v<S.length;v++){var T=S[v];y(T.keyPath,0,T)}function L(b){var P,_=b.query.index;return _.isVirtual?s(s({},b),{query:{index:_.lowLevelIndex,range:(P=b.query.range,_=_.keyTail,{type:P.type===1?2:P.type,lower:_s(P.lower,P.lowerOpen?i.MAX_KEY:i.MIN_KEY,_),lowerOpen:!0,upper:_s(P.upper,P.upperOpen?i.MIN_KEY:i.MAX_KEY,_),upperOpen:!0})}}):b}return s(s({},c),{schema:s(s({},f),{primaryKey:o,indexes:p,getIndexByKeyPath:function(b){return(b=d[Pn(b)])&&b[0]}}),count:function(b){return c.count(L(b))},query:function(b){return c.query(L(b))},openCursor:function(b){var P=b.query.index,_=P.keyTail,A=P.isVirtual,N=P.keyLength;return A?c.openCursor(L(b)).then(function(x){return x&&I(x)}):c.openCursor(b);function I(x){return Object.create(x,{continue:{value:function(D){D!=null?x.continue(_s(D,b.reverse?i.MAX_KEY:i.MIN_KEY,_)):b.unique?x.continue(x.key.slice(0,N).concat(b.reverse?i.MIN_KEY:i.MAX_KEY,_)):x.continue()}},continuePrimaryKey:{value:function(D,F){x.continuePrimaryKey(_s(D,i.MAX_KEY,_),F)}},primaryKey:{get:function(){return x.primaryKey}},key:{get:function(){var D=x.key;return N===1?D[0]:D.slice(0,N)}},value:{get:function(){return x.value}}})}}})}})}};function qi(i,o,c,f){return c=c||{},f=f||"",l(i).forEach(function(d){var p,y,v;g(o,d)?(p=i[d],y=o[d],typeof p=="object"&&typeof y=="object"&&p&&y?(v=li(p))!==li(y)?c[f+d]=o[d]:v==="Object"?qi(p,y,c,f+d+"."):p!==y&&(c[f+d]=o[d]):p!==y&&(c[f+d]=o[d])):c[f+d]=void 0}),l(o).forEach(function(d){g(i,d)||(c[f+d]=o[d])}),c}function zi(i,o){return o.type==="delete"?o.keys:o.keys||o.values.map(i.extractKey)}var Zl={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(i){return s(s({},i),{table:function(o){var c=i.table(o),f=c.schema.primaryKey;return s(s({},c),{mutate:function(d){var p=ee.trans,y=p.table(o).hook,v=y.deleting,S=y.creating,T=y.updating;switch(d.type){case"add":if(S.fire===me)break;return p._promise("readwrite",function(){return L(d)},!0);case"put":if(S.fire===me&&T.fire===me)break;return p._promise("readwrite",function(){return L(d)},!0);case"delete":if(v.fire===me)break;return p._promise("readwrite",function(){return L(d)},!0);case"deleteRange":if(v.fire===me)break;return p._promise("readwrite",function(){return function b(P,_,A){return c.query({trans:P,values:!1,query:{index:f,range:_},limit:A}).then(function(N){var I=N.result;return L({type:"delete",keys:I,trans:P}).then(function(x){return 0<x.numFailures?Promise.reject(x.failures[0]):I.length<A?{failures:[],numFailures:0,lastResult:void 0}:b(P,s(s({},_),{lower:I[I.length-1],lowerOpen:!0}),A)})})}(d.trans,d.range,1e4)},!0)}return c.mutate(d);function L(b){var P,_,A,N=ee.trans,I=b.keys||zi(f,b);if(!I)throw new Error("Keys missing");return(b=b.type==="add"||b.type==="put"?s(s({},b),{keys:I}):s({},b)).type!=="delete"&&(b.values=r([],b.values)),b.keys&&(b.keys=r([],b.keys)),P=c,A=I,((_=b).type==="add"?Promise.resolve([]):P.getMany({trans:_.trans,keys:A,cache:"immutable"})).then(function(x){var D=I.map(function(F,j){var R,H,K,q=x[j],V={onerror:null,onsuccess:null};return b.type==="delete"?v.fire.call(V,F,q,N):b.type==="add"||q===void 0?(R=S.fire.call(V,F,b.values[j],N),F==null&&R!=null&&(b.keys[j]=F=R,f.outbound||ce(b.values[j],f.keyPath,F))):(R=qi(q,b.values[j]),(H=T.fire.call(V,R,F,q,N))&&(K=b.values[j],Object.keys(H).forEach(function(z){g(K,z)?K[z]=H[z]:ce(K,z,H[z])}))),V});return c.mutate(b).then(function(F){for(var j=F.failures,R=F.results,H=F.numFailures,F=F.lastResult,K=0;K<I.length;++K){var q=(R||I)[K],V=D[K];q==null?V.onerror&&V.onerror(j[K]):V.onsuccess&&V.onsuccess(b.type==="put"&&x[K]?b.values[K]:q)}return{failures:j,results:R,numFailures:H,lastResult:F}}).catch(function(F){return D.forEach(function(j){return j.onerror&&j.onerror(F)}),Promise.reject(F)})})}}})}})}};function da(i,o,c){try{if(!o||o.keys.length<i.length)return null;for(var f=[],d=0,p=0;d<o.keys.length&&p<i.length;++d)he(o.keys[d],i[p])===0&&(f.push(c?Ye(o.values[d]):o.values[d]),++p);return f.length===i.length?f:null}catch{return null}}var ec={stack:"dbcore",level:-1,create:function(i){return{table:function(o){var c=i.table(o);return s(s({},c),{getMany:function(f){if(!f.cache)return c.getMany(f);var d=da(f.keys,f.trans._cache,f.cache==="clone");return d?J.resolve(d):c.getMany(f).then(function(p){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?Ye(p):p},p})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),c.mutate(f)}})}}}};function ha(i,o){return i.trans.mode==="readonly"&&!!i.subscr&&!i.trans.explicit&&i.trans.db._options.cache!=="disabled"&&!o.schema.primaryKey.outbound}function pa(i,o){switch(i){case"query":return o.values&&!o.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var tc={stack:"dbcore",level:0,name:"Observability",create:function(i){var o=i.schema.name,c=new Le(i.MIN_KEY,i.MAX_KEY);return s(s({},i),{transaction:function(f,d,p){if(ee.subscr&&d!=="readonly")throw new ie.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(ee.querier));return i.transaction(f,d,p)},table:function(f){var d=i.table(f),p=d.schema,y=p.primaryKey,b=p.indexes,v=y.extractKey,S=y.outbound,T=y.autoIncrement&&b.filter(function(_){return _.compound&&_.keyPath.includes(y.keyPath)}),L=s(s({},d),{mutate:function(_){function A(z){return z="idb://".concat(o,"/").concat(f,"/").concat(z),F[z]||(F[z]=new Le)}var N,I,x,D=_.trans,F=_.mutatedParts||(_.mutatedParts={}),j=A(""),R=A(":dels"),H=_.type,V=_.type==="deleteRange"?[_.range]:_.type==="delete"?[_.keys]:_.values.length<50?[zi(y,_).filter(function(z){return z}),_.values]:[],K=V[0],q=V[1],V=_.trans._cache;return u(K)?(j.addKeys(K),(V=H==="delete"||K.length===q.length?da(K,V):null)||R.addKeys(K),(V||q)&&(N=A,I=V,x=q,p.indexes.forEach(function(z){var W=N(z.name||"");function ue(de){return de!=null?z.extractKey(de):null}function fe(de){return z.multiEntry&&u(de)?de.forEach(function(Fe){return W.addKey(Fe)}):W.addKey(de)}(I||x).forEach(function(de,Oe){var le=I&&ue(I[Oe]),Oe=x&&ue(x[Oe]);he(le,Oe)!==0&&(le!=null&&fe(le),Oe!=null&&fe(Oe))})}))):K?(q={from:(q=K.lower)!==null&&q!==void 0?q:i.MIN_KEY,to:(q=K.upper)!==null&&q!==void 0?q:i.MAX_KEY},R.add(q),j.add(q)):(j.add(c),R.add(c),p.indexes.forEach(function(z){return A(z.name).add(c)})),d.mutate(_).then(function(z){return!K||_.type!=="add"&&_.type!=="put"||(j.addKeys(z.results),T&&T.forEach(function(W){for(var ue=_.values.map(function(le){return W.extractKey(le)}),fe=W.keyPath.findIndex(function(le){return le===y.keyPath}),de=0,Fe=z.results.length;de<Fe;++de)ue[de][fe]=z.results[de];A(W.name).addKeys(ue)})),D.mutatedParts=ks(D.mutatedParts||{},F),z})}}),b=function(A){var N=A.query,A=N.index,N=N.range;return[A,new Le((A=N.lower)!==null&&A!==void 0?A:i.MIN_KEY,(N=N.upper)!==null&&N!==void 0?N:i.MAX_KEY)]},P={get:function(_){return[y,new Le(_.key)]},getMany:function(_){return[y,new Le().addKeys(_.keys)]},count:b,query:b,openCursor:b};return l(P).forEach(function(_){L[_]=function(A){var N=ee.subscr,I=!!N,x=ha(ee,d)&&pa(_,A)?A.obsSet={}:N;if(I){var D=function(q){return q="idb://".concat(o,"/").concat(f,"/").concat(q),x[q]||(x[q]=new Le)},F=D(""),j=D(":dels"),N=P[_](A),I=N[0],N=N[1];if((_==="query"&&I.isPrimaryKey&&!A.values?j:D(I.name||"")).add(N),!I.isPrimaryKey){if(_!=="count"){var R=_==="query"&&S&&A.values&&d.query(s(s({},A),{values:!1}));return d[_].apply(this,arguments).then(function(q){if(_==="query"){if(S&&A.values)return R.then(function(ue){return ue=ue.result,F.addKeys(ue),q});var V=A.values?q.result.map(v):q.result;(A.values?F:j).addKeys(V)}else if(_==="openCursor"){var z=q,W=A.values;return z&&Object.create(z,{key:{get:function(){return j.addKey(z.primaryKey),z.key}},primaryKey:{get:function(){var ue=z.primaryKey;return j.addKey(ue),ue}},value:{get:function(){return W&&F.addKey(z.primaryKey),z.value}}})}return q})}j.add(c)}}return d[_].apply(this,arguments)}}),L}})}};function ma(i,o,c){if(c.numFailures===0)return o;if(o.type==="deleteRange")return null;var f=o.keys?o.keys.length:"values"in o&&o.values?o.values.length:1;return c.numFailures===f?null:(o=s({},o),u(o.keys)&&(o.keys=o.keys.filter(function(d,p){return!(p in c.failures)})),"values"in o&&u(o.values)&&(o.values=o.values.filter(function(d,p){return!(p in c.failures)})),o)}function Hi(i,o){return c=i,((f=o).lower===void 0||(f.lowerOpen?0<he(c,f.lower):0<=he(c,f.lower)))&&(i=i,(o=o).upper===void 0||(o.upperOpen?he(i,o.upper)<0:he(i,o.upper)<=0));var c,f}function ya(i,o,P,f,d,p){if(!P||P.length===0)return i;var y=o.query.index,v=y.multiEntry,S=o.query.range,T=f.schema.primaryKey.extractKey,L=y.extractKey,b=(y.lowLevelIndex||y).extractKey,P=P.reduce(function(_,A){var N=_,I=[];if(A.type==="add"||A.type==="put")for(var x=new Le,D=A.values.length-1;0<=D;--D){var F,j=A.values[D],R=T(j);x.hasKey(R)||(F=L(j),(v&&u(F)?F.some(function(z){return Hi(z,S)}):Hi(F,S))&&(x.addKey(R),I.push(j)))}switch(A.type){case"add":var H=new Le().addKeys(o.values?_.map(function(W){return T(W)}):_),N=_.concat(o.values?I.filter(function(W){return W=T(W),!H.hasKey(W)&&(H.addKey(W),!0)}):I.map(function(W){return T(W)}).filter(function(W){return!H.hasKey(W)&&(H.addKey(W),!0)}));break;case"put":var K=new Le().addKeys(A.values.map(function(W){return T(W)}));N=_.filter(function(W){return!K.hasKey(o.values?T(W):W)}).concat(o.values?I:I.map(function(W){return T(W)}));break;case"delete":var q=new Le().addKeys(A.keys);N=_.filter(function(W){return!q.hasKey(o.values?T(W):W)});break;case"deleteRange":var V=A.range;N=_.filter(function(W){return!Hi(T(W),V)})}return N},i);return P===i?i:(P.sort(function(_,A){return he(b(_),b(A))||he(T(_),T(A))}),o.limit&&o.limit<1/0&&(P.length>o.limit?P.length=o.limit:i.length===o.limit&&P.length<o.limit&&(d.dirty=!0)),p?Object.freeze(P):P)}function ga(i,o){return he(i.lower,o.lower)===0&&he(i.upper,o.upper)===0&&!!i.lowerOpen==!!o.lowerOpen&&!!i.upperOpen==!!o.upperOpen}function nc(i,o){return function(c,f,d,p){if(c===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=he(c,f))===0){if(d&&p)return 0;if(d)return 1;if(p)return-1}return f}(i.lower,o.lower,i.lowerOpen,o.lowerOpen)<=0&&0<=function(c,f,d,p){if(c===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=he(c,f))===0){if(d&&p)return 0;if(d)return-1;if(p)return 1}return f}(i.upper,o.upper,i.upperOpen,o.upperOpen)}function sc(i,o,c,f){i.subscribers.add(c),f.addEventListener("abort",function(){var d,p;i.subscribers.delete(c),i.subscribers.size===0&&(d=i,p=o,setTimeout(function(){d.subscribers.size===0&&wt(p,d)},3e3))})}var ic={stack:"dbcore",level:0,name:"Cache",create:function(i){var o=i.schema.name;return s(s({},i),{transaction:function(c,f,d){var p,y,v=i.transaction(c,f,d);return f==="readwrite"&&(y=(p=new AbortController).signal,d=function(S){return function(){if(p.abort(),f==="readwrite"){for(var T=new Set,L=0,b=c;L<b.length;L++){var P=b[L],_=Lt["idb://".concat(o,"/").concat(P)];if(_){var A=i.table(P),N=_.optimisticOps.filter(function(W){return W.trans===v});if(v._explicit&&S&&v.mutatedParts)for(var I=0,x=Object.values(_.queries.query);I<x.length;I++)for(var D=0,F=(H=x[I]).slice();D<F.length;D++)Di((K=F[D]).obsSet,v.mutatedParts)&&(wt(H,K),K.subscribers.forEach(function(W){return T.add(W)}));else if(0<N.length){_.optimisticOps=_.optimisticOps.filter(function(W){return W.trans!==v});for(var j=0,R=Object.values(_.queries.query);j<R.length;j++)for(var H,K,q,V=0,z=(H=R[j]).slice();V<z.length;V++)(K=z[V]).res!=null&&v.mutatedParts&&(S&&!K.dirty?(q=Object.isFrozen(K.res),q=ya(K.res,K.req,N,A,K,q),K.dirty?(wt(H,K),K.subscribers.forEach(function(W){return T.add(W)})):q!==K.res&&(K.res=q,K.promise=J.resolve({result:q}))):(K.dirty&&wt(H,K),K.subscribers.forEach(function(W){return T.add(W)})))}}}T.forEach(function(W){return W()})}}},v.addEventListener("abort",d(!1),{signal:y}),v.addEventListener("error",d(!1),{signal:y}),v.addEventListener("complete",d(!0),{signal:y})),v},table:function(c){var f=i.table(c),d=f.schema.primaryKey;return s(s({},f),{mutate:function(p){var y=ee.trans;if(d.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return f.mutate(p);var v=Lt["idb://".concat(o,"/").concat(c)];return v?(y=f.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||zi(d,p).some(function(S){return S==null}))?(v.optimisticOps.push(p),p.mutatedParts&&Ss(p.mutatedParts),y.then(function(S){0<S.numFailures&&(wt(v.optimisticOps,p),(S=ma(0,p,S))&&v.optimisticOps.push(S),p.mutatedParts&&Ss(p.mutatedParts))}),y.catch(function(){wt(v.optimisticOps,p),p.mutatedParts&&Ss(p.mutatedParts)})):y.then(function(S){var T=ma(0,s(s({},p),{values:p.values.map(function(L,b){var P;return S.failures[b]?L:(L=(P=d.keyPath)!==null&&P!==void 0&&P.includes(".")?Ye(L):s({},L),ce(L,d.keyPath,S.results[b]),L)})}),S);v.optimisticOps.push(T),queueMicrotask(function(){return p.mutatedParts&&Ss(p.mutatedParts)})}),y):f.mutate(p)},query:function(p){if(!ha(ee,f)||!pa("query",p))return f.query(p);var y=((T=ee.trans)===null||T===void 0?void 0:T.db._options.cache)==="immutable",b=ee,v=b.requery,S=b.signal,T=function(A,N,I,x){var D=Lt["idb://".concat(A,"/").concat(N)];if(!D)return[];if(!(N=D.queries[I]))return[null,!1,D,null];var F=N[(x.query?x.query.index.name:null)||""];if(!F)return[null,!1,D,null];switch(I){case"query":var j=F.find(function(R){return R.req.limit===x.limit&&R.req.values===x.values&&ga(R.req.query.range,x.query.range)});return j?[j,!0,D,F]:[F.find(function(R){return("limit"in R.req?R.req.limit:1/0)>=x.limit&&(!x.values||R.req.values)&&nc(R.req.query.range,x.query.range)}),!1,D,F];case"count":return j=F.find(function(R){return ga(R.req.query.range,x.query.range)}),[j,!!j,D,F]}}(o,c,"query",p),L=T[0],b=T[1],P=T[2],_=T[3];return L&&b?L.obsSet=p.obsSet:(b=f.query(p).then(function(A){var N=A.result;if(L&&(L.res=N),y){for(var I=0,x=N.length;I<x;++I)Object.freeze(N[I]);Object.freeze(N)}else A.result=Ye(N);return A}).catch(function(A){return _&&L&&wt(_,L),Promise.reject(A)}),L={obsSet:p.obsSet,promise:b,subscribers:new Set,type:"query",req:p,dirty:!1},_?_.push(L):(_=[L],(P=P||(Lt["idb://".concat(o,"/").concat(c)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=_)),sc(L,_,v,S),L.promise.then(function(A){return{result:ya(A.result,p,P==null?void 0:P.optimisticOps,f,L,y)}})}})}})}};function Ts(i,o){return new Proxy(i,{get:function(c,f,d){return f==="db"?o:Reflect.get(c,f,d)}})}var nt=(Ee.prototype.version=function(i){if(isNaN(i)||i<.1)throw new ie.Type("Given version is not a positive number");if(i=Math.round(10*i)/10,this.idbdb||this._state.isBeingOpened)throw new ie.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,i);var o=this._versions,c=o.filter(function(f){return f._cfg.version===i})[0];return c||(c=new this.Version(i),o.push(c),o.sort(Yl),c.stores({}),this._state.autoSchema=!1,c)},Ee.prototype._whenReady=function(i){var o=this;return this.idbdb&&(this._state.openComplete||ee.letThrough||this._vip)?i():new J(function(c,f){if(o._state.openComplete)return f(new ie.DatabaseClosed(o._state.dbOpenError));if(!o._state.isBeingOpened){if(!o._state.autoOpen)return void f(new ie.DatabaseClosed);o.open().catch(me)}o._state.dbReadyPromise.then(c,f)}).then(i)},Ee.prototype.use=function(i){var o=i.stack,c=i.create,f=i.level,d=i.name;return d&&this.unuse({stack:o,name:d}),i=this._middlewares[o]||(this._middlewares[o]=[]),i.push({stack:o,create:c,level:f??10,name:d}),i.sort(function(p,y){return p.level-y.level}),this},Ee.prototype.unuse=function(i){var o=i.stack,c=i.name,f=i.create;return o&&this._middlewares[o]&&(this._middlewares[o]=this._middlewares[o].filter(function(d){return f?d.create!==f:!!c&&d.name!==c})),this},Ee.prototype.open=function(){var i=this;return Et(ot,function(){return Ql(i)})},Ee.prototype._close=function(){var i=this._state,o=Yt.indexOf(this);if(0<=o&&Yt.splice(o,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}i.isBeingOpened||(i.dbReadyPromise=new J(function(c){i.dbReadyResolve=c}),i.openCanceller=new J(function(c,f){i.cancelOpen=f}))},Ee.prototype.close=function(c){var o=(c===void 0?{disableAutoOpen:!0}:c).disableAutoOpen,c=this._state;o?(c.isBeingOpened&&c.cancelOpen(new ie.DatabaseClosed),this._close(),c.autoOpen=!1,c.dbOpenError=new ie.DatabaseClosed):(this._close(),c.autoOpen=this._options.autoOpen||c.isBeingOpened,c.openComplete=!1,c.dbOpenError=null)},Ee.prototype.delete=function(i){var o=this;i===void 0&&(i={disableAutoOpen:!0});var c=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new J(function(d,p){function y(){o.close(i);var v=o._deps.indexedDB.deleteDatabase(o.name);v.onsuccess=ke(function(){var S,T,L;S=o._deps,T=o.name,L=S.indexedDB,S=S.IDBKeyRange,xi(L)||T===cs||Pi(L,S).delete(T).catch(me),d()}),v.onerror=Ge(p),v.onblocked=o._fireOnBlocked}if(c)throw new ie.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(y):y()})},Ee.prototype.backendDB=function(){return this.idbdb},Ee.prototype.isOpen=function(){return this.idbdb!==null},Ee.prototype.hasBeenClosed=function(){var i=this._state.dbOpenError;return i&&i.name==="DatabaseClosed"},Ee.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ee.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ee.prototype,"tables",{get:function(){var i=this;return l(this._allTables).map(function(o){return i._allTables[o]})},enumerable:!1,configurable:!0}),Ee.prototype.transaction=function(){var i=(function(o,c,f){var d=arguments.length;if(d<2)throw new ie.InvalidArgument("Too few arguments");for(var p=new Array(d-1);--d;)p[d-1]=arguments[d];return f=p.pop(),[o,ze(p),f]}).apply(this,arguments);return this._transaction.apply(this,i)},Ee.prototype._transaction=function(i,o,c){var f=this,d=ee.trans;d&&d.db===this&&i.indexOf("!")===-1||(d=null);var p,y,v=i.indexOf("?")!==-1;i=i.replace("!","").replace("?","");try{if(y=o.map(function(T){if(T=T instanceof f.Table?T.name:T,typeof T!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return T}),i=="r"||i===ki)p=ki;else{if(i!="rw"&&i!=Si)throw new ie.InvalidArgument("Invalid transaction mode: "+i);p=Si}if(d){if(d.mode===ki&&p===Si){if(!v)throw new ie.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");d=null}d&&y.forEach(function(T){if(d&&d.storeNames.indexOf(T)===-1){if(!v)throw new ie.SubTransaction("Table "+T+" not included in parent transaction.");d=null}}),v&&d&&!d.active&&(d=null)}}catch(T){return d?d._promise(null,function(L,b){b(T)}):Ie(T)}var S=(function T(L,b,P,_,A){return J.resolve().then(function(){var N=ee.transless||ee,I=L._createTransaction(b,P,L._dbSchema,_);if(I.explicit=!0,N={trans:I,transless:N},_)I.idbtrans=_.idbtrans;else try{I.create(),I.idbtrans._explicit=!0,L._state.PR1398_maxLoop=3}catch(F){return F.name===fi.InvalidState&&L.isOpen()&&0<--L._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),L.close({disableAutoOpen:!1}),L.open().then(function(){return T(L,b,P,null,A)})):Ie(F)}var x,D=ui(A);return D&&Vt(),N=J.follow(function(){var F;(x=A.call(I,I))&&(D?(F=ct.bind(null,null),x.then(F,F)):typeof x.next=="function"&&typeof x.throw=="function"&&(x=Ki(x)))},N),(x&&typeof x.then=="function"?J.resolve(x).then(function(F){return I.active?F:Ie(new ie.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):N.then(function(){return x})).then(function(F){return _&&I._resolve(),I._completion.then(function(){return F})}).catch(function(F){return I._reject(F),Ie(F)})})}).bind(null,this,p,y,d,c);return d?d._promise(p,S,"lock"):ee.trans?Et(ee.transless,function(){return f._whenReady(S)}):this._whenReady(S)},Ee.prototype.table=function(i){if(!g(this._allTables,i))throw new ie.InvalidTable("Table ".concat(i," does not exist"));return this._allTables[i]},Ee);function Ee(i,o){var c=this;this._middlewares={},this.verno=0;var f=Ee.dependencies;this._options=o=s({addons:Ee.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},o),this._deps={indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},f=o.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var d,p,y,v,S,T={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:me,dbReadyPromise:null,cancelOpen:me,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:o.autoOpen};T.dbReadyPromise=new J(function(b){T.dbReadyResolve=b}),T.openCanceller=new J(function(b,P){T.cancelOpen=P}),this._state=T,this.name=i,this.on=Cn(this,"populate","blocked","versionchange","close",{ready:[di,me]}),this.on.ready.subscribe=Z(this.on.ready.subscribe,function(b){return function(P,_){Ee.vip(function(){var A,N=c._state;N.openComplete?(N.dbOpenError||J.resolve().then(P),_&&b(P)):N.onReadyBeingFired?(N.onReadyBeingFired.push(P),_&&b(P)):(b(P),A=c,_||b(function I(){A.on.ready.unsubscribe(P),A.on.ready.unsubscribe(I)}))})}}),this.Collection=(d=this,An(Rl.prototype,function(x,I){this.db=d;var _=Jr,A=null;if(I)try{_=I()}catch(D){A=D}var N=x._ctx,I=N.table,x=I.hook.reading.fire;this._ctx={table:I,index:N.index,isPrimKey:!N.index||I.schema.primKey.keyPath&&N.index===I.schema.primKey.name,range:_,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:A,or:N.or,valueMapper:x!==Sn?x:null}})),this.Table=(p=this,An(Xr.prototype,function(b,P,_){this.db=p,this._tx=_,this.name=b,this.schema=P,this.hook=p._allTables[b]?p._allTables[b].hook:Cn(null,{creating:[Bl,me],reading:[Ol,Sn],updating:[Pl,me],deleting:[Nl,me]})})),this.Transaction=(y=this,An(zl.prototype,function(b,P,_,A,N){var I=this;this.db=y,this.mode=b,this.storeNames=P,this.schema=_,this.chromeTransactionDurability=A,this.idbtrans=null,this.on=Cn(this,"complete","error","abort"),this.parent=N||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new J(function(x,D){I._resolve=x,I._reject=D}),this._completion.then(function(){I.active=!1,I.on.complete.fire()},function(x){var D=I.active;return I.active=!1,I.on.error.fire(x),I.parent?I.parent._reject(x):D&&I.idbtrans&&I.idbtrans.abort(),Ie(x)})})),this.Version=(v=this,An(Wl.prototype,function(b){this.db=v,this._cfg={version:b,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(S=this,An(sa.prototype,function(b,P,_){if(this.db=S,this._ctx={table:b,index:P===":id"?null:P,or:_},this._cmp=this._ascending=he,this._descending=function(A,N){return he(N,A)},this._max=function(A,N){return 0<he(A,N)?A:N},this._min=function(A,N){return he(A,N)<0?A:N},this._IDBKeyRange=S._deps.IDBKeyRange,!this._IDBKeyRange)throw new ie.MissingAPI})),this.on("versionchange",function(b){0<b.newVersion?console.warn("Another connection wants to upgrade database '".concat(c.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(c.name,"'. Closing db now to resume the delete request.")),c.close({disableAutoOpen:!1})}),this.on("blocked",function(b){!b.newVersion||b.newVersion<b.oldVersion?console.warn("Dexie.delete('".concat(c.name,"') was blocked")):console.warn("Upgrade '".concat(c.name,"' blocked by other connection holding version ").concat(b.oldVersion/10))}),this._maxKey=Nn(o.IDBKeyRange),this._createTransaction=function(b,P,_,A){return new c.Transaction(b,P,_,c._options.chromeTransactionDurability,A)},this._fireOnBlocked=function(b){c.on("blocked").fire(b),Yt.filter(function(P){return P.name===c.name&&P!==c&&!P._state.vcFired}).map(function(P){return P.on("versionchange").fire(b)})},this.use(ec),this.use(ic),this.use(tc),this.use(Xl),this.use(Zl);var L=new Proxy(this,{get:function(b,P,_){if(P==="_vip")return!0;if(P==="table")return function(N){return Ts(c.table(N),L)};var A=Reflect.get(b,P,_);return A instanceof Xr?Ts(A,L):P==="tables"?A.map(function(N){return Ts(N,L)}):P==="_createTransaction"?function(){return Ts(A.apply(this,arguments),L)}:A}});this.vip=L,f.forEach(function(b){return b(c)})}var Is,Re=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",rc=(Ui.prototype.subscribe=function(i,o,c){return this._subscribe(i&&typeof i!="function"?i:{next:i,error:o,complete:c})},Ui.prototype[Re]=function(){return this},Ui);function Ui(i){this._subscribe=i}try{Is={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{Is={indexedDB:null,IDBKeyRange:null}}function va(i){var o,c=!1,f=new rc(function(d){var p=ui(i),y,v=!1,S={},T={},L={get closed(){return v},unsubscribe:function(){v||(v=!0,y&&y.abort(),b&&dt.storagemutated.unsubscribe(_))}};d.start&&d.start(L);var b=!1,P=function(){return wi(A)},_=function(N){ks(S,N),Di(T,S)&&P()},A=function(){var N,I,x;!v&&Is.indexedDB&&(S={},N={},y&&y.abort(),y=new AbortController,x=function(D){var F=Ht();try{p&&Vt();var j=lt(i,D);return j=p?j.finally(ct):j}finally{F&&Ut()}}(I={subscr:N,signal:y.signal,requery:P,querier:i,trans:null}),Promise.resolve(x).then(function(D){c=!0,o=D,v||I.signal.aborted||(S={},function(F){for(var j in F)if(g(F,j))return;return 1}(T=N)||b||(dt(Bn,_),b=!0),wi(function(){return!v&&d.next&&d.next(D)}))},function(D){c=!1,["DatabaseClosedError","AbortError"].includes(D==null?void 0:D.name)||v||wi(function(){v||d.error&&d.error(D)})}))};return setTimeout(P,0),L});return f.hasValue=function(){return c},f.getValue=function(){return o},f}var Ot=nt;function Vi(i){var o=ht;try{ht=!0,dt.storagemutated.fire(i),Ri(i,!0)}finally{ht=o}}C(Ot,s(s({},es),{delete:function(i){return new Ot(i,{addons:[]}).delete()},exists:function(i){return new Ot(i,{addons:[]}).open().then(function(o){return o.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(i){try{return o=Ot.dependencies,c=o.indexedDB,o=o.IDBKeyRange,(xi(c)?Promise.resolve(c.databases()).then(function(f){return f.map(function(d){return d.name}).filter(function(d){return d!==cs})}):Pi(c,o).toCollection().primaryKeys()).then(i)}catch{return Ie(new ie.MissingAPI)}var o,c},defineClass:function(){return function(i){h(this,i)}},ignoreTransaction:function(i){return ee.trans?Et(ee.transless,i):i()},vip:Mi,async:function(i){return function(){try{var o=Ki(i.apply(this,arguments));return o&&typeof o.then=="function"?o:J.resolve(o)}catch(c){return Ie(c)}}},spawn:function(i,o,c){try{var f=Ki(i.apply(c,o||[]));return f&&typeof f.then=="function"?f:J.resolve(f)}catch(d){return Ie(d)}},currentTransaction:{get:function(){return ee.trans||null}},waitFor:function(i,o){return o=J.resolve(typeof i=="function"?Ot.ignoreTransaction(i):i).timeout(o||6e4),ee.trans?ee.trans.waitFor(o):o},Promise:J,debug:{get:function(){return Je},set:function(i){Kr(i)}},derive:E,extend:h,props:C,override:Z,Events:Cn,on:dt,liveQuery:va,extendObservabilitySet:ks,getByKeyPath:ne,setByKeyPath:ce,delByKeyPath:function(i,o){typeof o=="string"?ce(i,o,void 0):"length"in o&&[].map.call(o,function(c){ce(i,c,void 0)})},shallowClone:Q,deepClone:Ye,getObjectDiff:qi,cmp:he,asap:te,minKey:-1/0,addons:[],connections:Yt,errnames:fi,dependencies:Is,cache:Lt,semVer:"4.0.11",version:"4.0.11".split(".").map(function(i){return parseInt(i)}).reduce(function(i,o,c){return i+o/Math.pow(10,2*c)})})),Ot.maxKey=Nn(Ot.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(dt(Bn,function(i){ht||(i=new CustomEvent(Ei,{detail:i}),ht=!0,dispatchEvent(i),ht=!1)}),addEventListener(Ei,function(i){i=i.detail,ht||Vi(i)}));var Wt,ht=!1,ba=function(){};return typeof BroadcastChannel<"u"&&((ba=function(){(Wt=new BroadcastChannel(Ei)).onmessage=function(i){return i.data&&Vi(i.data)}})(),typeof Wt.unref=="function"&&Wt.unref(),dt(Bn,function(i){ht||Wt.postMessage(i)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(i){if(!nt.disableBfCache&&i.persisted){Je&&console.debug("Dexie: handling persisted pagehide"),Wt!=null&&Wt.close();for(var o=0,c=Yt;o<c.length;o++)c[o].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(i){!nt.disableBfCache&&i.persisted&&(Je&&console.debug("Dexie: handling persisted pageshow"),ba(),Vi({all:new Le(-1/0,[[]])}))})),J.rejectionMapper=function(i,o){return!i||i instanceof qt||i instanceof TypeError||i instanceof SyntaxError||!i.name||!Rr[i.name]?i:(o=new Rr[i.name](o||i.message,i),"stack"in i&&M(o,"stack",{get:function(){return this.inner.stack}}),o)},Kr(Je),s(nt,Object.freeze({__proto__:null,Dexie:nt,liveQuery:va,Entity:Gr,cmp:he,PropModification:Ln,replacePrefix:function(i,o){return new Ln({replacePrefix:[i,o]})},add:function(i){return new Ln({add:i})},remove:function(i){return new Ln({remove:i})},default:nt,RangeSet:Le,mergeRanges:Mn,rangesOverlap:la}),{default:nt}),nt})})(io);var lc=io.exports;const or=oc(lc),Sa=Symbol.for("Dexie"),Rs=globalThis[Sa]||(globalThis[Sa]=or);if(or.semVer!==Rs.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${or.semVer} and ${Rs.semVer}`);const{liveQuery:Fd,mergeRanges:jd,rangesOverlap:Rd,RangeSet:Kd,cmp:qd,Entity:zd,PropModification:Hd,replacePrefix:Ud,add:Vd,remove:Yd}=Rs,cc="MdAnkiDatabase",uc=2,fc=21,lr=`# 新文件

开始编写您的内容...

::> 这是一个可折叠的标题
    这里是折叠的内容。
    - 甚至可以包含列表
    - 和其他 Markdown 元素。
    \`\`\`javascript
    // 也可以包含代码块
    console.log('Hello, Toggle!');
    \`\`\`

这一行不再缩进，所以它不属于上面的折叠块。

::> [ ] 这是一个可折叠的并且可以记录完成情况的标题
- [ ] 完成情况 

使用 --内容-- 创建Cloze记忆卡片, 可以有声音: --你好--^^audio:hello^^ `,se=new Rs(cc);se.version(uc).stores({anki_folders:"&id, name, folderId",anki_sessions:"&id, name, folderId, createdAt, lastActive",anki_clozeStates:"&id, fileId, state, due",anki_reviewStats:"&id, date, folderId",task_tasks:"&uuid, subject, *tags, analysis.reason_for_error, review.due",agent_apiConfigs:"&id, name",agent_agents:"&id, name",agent_topics:"&id, agentId, createdAt",agent_history:"&id, topicId, timestamp, agentId",global_appState:"&key"});async function dc(){const[n,e,t,s,r]=await Promise.all([se.anki_sessions.toArray().catch(u=>(console.error("Failed to load anki_sessions",u),[])),se.anki_folders.toArray().catch(u=>(console.error("Failed to load anki_folders",u),[])),se.anki_clozeStates.toArray().catch(u=>(console.error("Failed to load anki_clozeStates",u),[])),se.anki_reviewStats.toArray().catch(u=>(console.error("Failed to load anki_reviewStats",u),[])),se.global_appState.toArray().catch(u=>(console.error("Failed to load global_appState",u),[]))]),a=t.reduce((u,h)=>(u[h.id]=h,u),{}),l=r.reduce((u,h)=>(u[h.key]=h.value,u),{});return{sessions:n,folders:e,clozeStates:a,reviewStats:s||[],persistentAppState:l}}async function hc({sessions:n,folders:e,clozeStates:t,persistentAppState:s}){const r=[se.anki_sessions,se.anki_folders,se.anki_clozeStates,se.global_appState];await se.transaction("rw",r,async()=>{const a=Object.values(t),l=Object.entries(s).map(([g,C])=>({key:g,value:C})),u=new Set(n.map(g=>g.id)),h=new Set(e.map(g=>g.id)),m=new Set(Object.keys(t)),w=new Set(Object.keys(s));await Promise.all([se.anki_sessions.where("id").noneOf(Array.from(u)).delete(),se.anki_folders.where("id").noneOf(Array.from(h)).delete(),se.anki_clozeStates.where("id").noneOf(Array.from(m)).delete(),se.global_appState.where("key").noneOf(Array.from(w)).delete()]),await Promise.all([se.anki_sessions.bulkPut(n),se.anki_folders.bulkPut(e),se.anki_clozeStates.bulkPut(a),se.global_appState.bulkPut(l)])})}async function pc(n,e){const t=`${n}:${e}`;try{await se.transaction("rw",se.anki_reviewStats,async()=>{const s=await se.anki_reviewStats.get(t);s?await se.anki_reviewStats.update(t,{count:s.count+1}):await se.anki_reviewStats.add({id:t,date:n,folderId:e||"root",count:1})})}catch(s){console.error(`[Storage/Anki] Failed to increment review count for ${t}:`,s)}}async function mc(n,e){try{return await se.anki_reviewStats.where("date").between(n,e,!0,!0).toArray()}catch(t){return console.error("[Storage/Anki] Failed to get stats for date range:",t),[]}}async function yc(){try{const n=new Date().toISOString().slice(0,10);return(await se.anki_reviewStats.where("date").equals(n).toArray()).reduce((t,s)=>t+s.count,0)}catch(n){return console.error("[Storage/Anki] Failed to get today's total count:",n),0}}async function gc(){try{const[n,e,t,s]=await Promise.all([se.agent_apiConfigs.toArray(),se.agent_agents.toArray(),se.agent_topics.toArray(),se.agent_history.toArray()]);return{apiConfigs:n,agents:e,topics:t,history:s}}catch(n){return console.error("[Storage/Agent] Failed to load agent data:",n),{apiConfigs:[],agents:[],topics:[],history:[]}}}async function vc({apiConfigs:n,agents:e,topics:t,history:s}){const r=[se.agent_apiConfigs,se.agent_agents,se.agent_topics,se.agent_history];await se.transaction("rw",r,async()=>{const a=new Set(n.map(m=>m.id)),l=new Set(e.map(m=>m.id)),u=new Set(t.map(m=>m.id)),h=new Set(s.map(m=>m.id));await Promise.all([se.agent_apiConfigs.where("id").noneOf(Array.from(a)).delete(),se.agent_agents.where("id").noneOf(Array.from(l)).delete(),se.agent_topics.where("id").noneOf(Array.from(u)).delete(),se.agent_history.where("id").noneOf(Array.from(h)).delete()]),await Promise.all([se.agent_apiConfigs.bulkPut(n),se.agent_agents.bulkPut(e),se.agent_topics.bulkPut(t),se.agent_history.bulkPut(s)])})}async function bc(){try{return se.isOpen()||await se.open(),await se.task_tasks.toArray()}catch(n){return console.error("[Storage/Task] Failed to load tasks from DB:",n),[]}}async function wc(n){try{await se.task_tasks.bulkPut(n)}catch(e){console.error("[Storage/Task] Failed to save tasks to DB:",e)}}async function kc(n){try{await se.task_tasks.put(n)}catch(e){console.error(`[Storage/Task] Failed to update task ${n.uuid}:`,e)}}function pn(){return"id_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function Ue(n){return n?n.replace(/[&<>"']/g,e=>({"&":"&","<":"<",">":">",'"':'"',"'":"'"})[e]||e):""}function _a(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);e=(e<<5)-e+s,e|=0}return e.toString(36)}const Ta=10*60*1e3,Sc=2.5;function ro(n,e){const t=Date.now();let{interval:s=0,easeFactor:r=Sc,state:a="new"}=n;if(a==="new"||a==="learning")switch(e){case 0:return{due:t+Ta,interval:0,easeFactor:r,state:"learning"};case 1:return{due:t+1*24*3600*1e3,interval:1,easeFactor:r,state:"review"};case 2:return{due:t+3*24*3600*1e3,interval:3,easeFactor:r,state:"review"};case 3:return{due:t+5*24*3600*1e3,interval:5,easeFactor:r,state:"review"}}switch(e){case 0:return r=Math.max(1.3,r-.2),{due:t+Ta,interval:0,easeFactor:r,state:"learning"};case 1:s=Math.max(1,s*1.2),r=Math.max(1.3,r-.15);break;case 2:break;case 3:r+=.15;break}const l=Math.max(s+1,s*r);return{due:t+l*24*3600*1e3,interval:l,easeFactor:r,state:"review"}}const br={火山:{adapter:"openAICompatible",baseURL:"https://ark.cn-beijing.volces.com/api/v3/",models:["deepseek-r1-250528","deepseek-v3-250324"]},deepseek:{adapter:"openAICompatible",baseURL:"https://api.deepseek.com/v1/chat/completions",models:["deepseek-reasoner","deepseek-chat"]},open_routers:{adapter:"openAICompatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",models:["anthropic/claude-opus-4","anthropic/claude-sonnet-4"]},gemini:{adapter:"gemini",baseURL:"https://generativelanguage.googleapis.com",models:["gemini-2.5-pro","gemini-2.5-flash"]},openai_compatible:{adapter:"openAICompatible",baseURL:"",models:[]}};function Ia(n){const e=br[n];return e?e.adapter==="openAICompatible"&&e.baseURL.endsWith("/")?`${e.baseURL}chat/completions`:e.baseURL:""}class ao{constructor(e){this.config=e}async chatStream(e,{onChunk:t,onDone:s,onError:r}){throw new Error("Adapter must implement chatStream method.")}_preparePayload(e){throw new Error("Adapter must implement _preparePayload method.")}}class _c extends ao{_preparePayload(e){return{model:this.config.model,messages:e,stream:!0}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var l;const a=this._preparePayload(e);try{const u=await fetch(this.config.apiPath,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(a)});if(!u.ok){const w=await u.text();throw new Error(`API Error: ${u.status} ${u.statusText} - ${w}`)}const h=u.body.getReader(),m=new TextDecoder("utf-8");for(;;){const{done:w,value:g}=await h.read();if(w){s();break}const B=m.decode(g).split(`
`).filter(M=>M.trim().startsWith("data:"));for(const M of B){const E=M.replace(/^data: /,"").trim();if(E==="[DONE]"){s();return}try{const Y=(l=JSON.parse(E).choices[0])==null?void 0:l.delta;if(Y){const G=Y.content;G&&t({type:"content",text:G});const Z=Y.reasoning_content;if(Z){const X=`<thinking>${Z}</thinking>`;t({type:"thinking",text:X})}}}catch($){console.error("Error parsing stream data chunk:",E,$)}}}}catch(u){console.error("LLM Stream Error:",u),r(u)}}}class Tc extends ao{_preparePayload(e){return{contents:e.map(s=>({role:s.role==="assistant"?"model":"user",parts:[{text:s.content}]}))}}async chatStream(e,{onChunk:t,onDone:s,onError:r}){var u,h,m,w,g;const a=this._preparePayload(e),l=`${this.config.apiPath}/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`;try{const C=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!C.ok){const $=await C.text();throw new Error(`API Error: ${C.status} ${C.statusText} - ${$}`)}const B=C.body.getReader(),M=new TextDecoder("utf-8");let E="";for(;;){const{done:$,value:Y}=await B.read();if($){s();break}E+=M.decode(Y,{stream:!0});const G=E.split(`
`);E=G.pop();for(const Z of G)if(!(Z.trim().startsWith("[")||Z.trim().startsWith(","))&&!Z.trim().endsWith("]"))try{const te=((g=(w=(m=(h=(u=JSON.parse(Z).candidates)==null?void 0:u[0])==null?void 0:h.content)==null?void 0:m.parts)==null?void 0:w[0])==null?void 0:g.text)||"";te&&t({type:"content",text:te})}catch{}}}catch(C){console.error("Gemini Stream Error:",C),r(C)}}}const Ea={openAICompatible:_c,gemini:Tc};function Ic(n){const e=br[n];if(!e||!Ea[e.adapter])throw new Error(`Unsupported provider or adapter: ${n}`);return Ea[e.adapter]}async function Ec(n,e,t){const s=Ic(n.provider),r=new s(n),a=[];n.systemPrompt&&a.push({role:"system",content:n.systemPrompt}),e.forEach(l=>{a.push({role:l.role,content:l.content})}),await r.chatStream(a,t)}async function oo(n,e){if(!n)return;n.innerHTML=window.marked.parse(e||"");const t=n.querySelectorAll("pre code.language-mermaid");if(window.mermaid&&t.length>0){const s=Array.from(t).map(async(r,a)=>{const l=r.parentNode,u=r.textContent,h=`mermaid-${Date.now()}-${a}`;try{const{svg:m}=await mermaid.render(h,u),w=document.createElement("div");w.className="mermaid-diagram",w.innerHTML=m,l.parentNode&&l.parentNode.replaceChild(w,l)}catch(m){console.error("Mermaid rendering error:",m),l.innerHTML=`<div class="error-box">Mermaid Error: ${m.message}</div>`}});await Promise.all(s)}if(window.MathJax&&(e.includes("$")||e.includes("\\")))try{await window.MathJax.typesetPromise([n])}catch(s){console.error("MathJax error:",s)}}let ae;function Cc(n){ae=n}function Ac(n){const e=n.id===O.currentTopicId,t=document.createElement("li");t.className=`topic-item ${e?"active":""}`,t.dataset.topicId=n.id;const s=O.history.filter(u=>u.topicId===n.id).sort((u,h)=>new Date(h.timestamp)-new Date(u.timestamp))[0];let r="最后会话: 无";if(s){const u=_r(s.agentId);r=`角色: ${u?u.name:"默认 AI"}
时间: ${new Date(s.timestamp).toLocaleString()}`}t.title=r;const a=O.selectedTopicIds.includes(n.id),l=O.isTopicSelectionMode?`<input type="checkbox" class="topic-selection-checkbox" data-topic-id="${n.id}" ${a?"checked":""}>`:"";return t.innerHTML=`
        ${l}
        <div class="topic-item-content">
            <div class="topic-icon"><i class="${Ue(n.icon)}"></i></div>
            <span>${Ue(n.title)}</span>
        </div>
        <button class="topic-delete-btn" title="删除此主题"><i class="fas fa-trash-alt"></i></button>
    `,t}async function lo(n,e){let t=e.content||"";e.role==="assistant"&&e.reasoning&&e.reasoning.trim()&&(t=`<details class="thinking-block"><summary>AI 思考过程</summary><pre><code>${Ue(e.reasoning)}</code></pre></details>`+t),await oo(n,t)}async function Lc(n){const e=document.createElement("div");e.className=`history-item role-${n.role}`,e.dataset.messageId=n.id,e.innerHTML=`
        <div class="history-item-header">
            <span class="role ${n.role}">${n.role==="user"?"用户":"AI助手"}</span>
            <span>${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <div class="history-item-content"></div>
        <div class="history-item-actions">
            <button class="history-action-btn regenerate-btn" title="重新生成"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" title="编辑"><i class="fas fa-edit"></i> 编辑</button>
            <button class="history-action-btn delete-btn" title="删除"><i class="fas fa-trash"></i> 删除</button>
        </div>
    `,await lo(e.querySelector(".history-item-content"),n);const t=e.querySelector(".history-item-actions");return n.role==="user"?t.querySelector(".regenerate-btn").style.display="none":t.querySelector(".edit-btn").style.display="none",e}function Oc(n){return`
        <div class="hint-panel">
            <div class="hint-panel-header">
                <div class="hint-panel-avatar">${Ue(n.avatar)}</div>
                <div class="hint-panel-title">${Ue(n.name)} 为您服务</div>
            </div>
            <div class="hint-panel-content">
                <i class="fas fa-lightbulb"></i>
                ${n.hint}
            </div>
        </div>
    `}function Bc(){if(!ae.topicTagFilter)return;const n=[...new Set(O.agents.flatMap(e=>e.tags||[]))];ae.topicTagFilter.innerHTML='<option value="all">所有主题</option>',n.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,ae.topicTagFilter.appendChild(t)}),ae.topicTagFilter.value=O.topicListFilterTag}function Nc(){if(O.currentTopicId){const n=O.topics.find(e=>e.id===O.currentTopicId);ae.historyHeaderTitle.textContent=n?`${Ue(n.title)} - 对话记录`:"对话记录"}else ae.historyHeaderTitle.textContent="选择一个主题开始";ae.conversationRoleSelector.innerHTML='<option value="">默认 AI (无角色)</option>',O.agents.forEach(n=>{const e=document.createElement("option");e.value=n.id,e.textContent=n.name,ae.conversationRoleSelector.appendChild(e)}),ae.conversationRoleSelector.value=O.currentConversationAgentId||""}function Nt(){if(ae.topicList.innerHTML="",bo().forEach(t=>ae.topicList.appendChild(Ac(t))),ae.editTopicBtn.style.display=O.currentTopicId?"block":"none",O.isTopicSelectionMode){ae.topicsBatchActions.style.display="flex",ae.manageTopicsBtn.classList.add("active");const t=O.selectedTopicIds.length;ae.deleteSelectedTopicsBtn.textContent=`删除选中 (${t})`,ae.deleteSelectedTopicsBtn.disabled=t===0,ae.selectAllTopicsBtn.textContent=O.topics.length>0&&t===O.topics.length?"全不选":"全选"}else ae.topicsBatchActions.style.display="none",ae.manageTopicsBtn.classList.remove("active");const e=document.createElement("li");e.className="topic-item add-topic-btn",e.innerHTML='<div class="topic-item-content"><div class="topic-icon"><i class="fas fa-plus"></i></div><span>添加新主题</span></div>',ae.topicList.appendChild(e)}async function fn(){var r;if(Nc(),ae.historyContent.innerHTML="",!O.currentTopicId){ae.historyContent.innerHTML='<div class="no-history"><p>请选择或创建一个主题来开始聊天</p></div>',ae.chatInputArea.style.display="none",Gi();return}ae.chatInputArea.style.display="flex";const n=O.history.filter(a=>a.topicId===O.currentTopicId).sort((a,l)=>new Date(a.timestamp)-new Date(l.timestamp));if(n.length===0){const a=_r(O.currentConversationAgentId);a&&a.hint?ae.historyContent.innerHTML=Oc(a):ae.historyContent.innerHTML='<div class="no-history"><p>这个主题还没有对话记录。</p></div>',Gi();return}const e=n.map(a=>{if(a.status==="streaming"){const l=document.createElement("div");return l.className="history-item role-assistant",l.dataset.messageId=a.id,l.innerHTML=`
                <div class="history-item-header"><span>AI助手</span><span>${new Date(a.timestamp).toLocaleString()}</span></div>
                <div class="history-item-content"><div class="streaming-content-container"><p><i class="fas fa-spinner fa-pulse"></i></p></div></div>`,Promise.resolve(l)}return Lc(a)});(await Promise.all(e)).forEach(a=>ae.historyContent.appendChild(a));const s=(r=O.topicScrollPositions)==null?void 0:r[O.currentTopicId];s!==void 0?ae.historyContent.scrollTop=s:ae.historyContent.scrollTop=ae.historyContent.scrollHeight,Gi()}function wr(n){ae.attachmentPreviewContainer.innerHTML="",n.forEach((e,t)=>{const s=document.createElement("div");s.className="attachment-preview-item",s.innerHTML=`<span><i class="fas fa-file-image"></i> ${Ue(e.name)}</span><button class="remove-attachment-btn" data-index="${t}">×</button>`,ae.attachmentPreviewContainer.appendChild(s)})}function Pc(n,e,t){const s=ae.historyContent.querySelector(`.history-item[data-message-id="${n}"]`);if(!s)return;const r=s.querySelector(".history-item-content");if(!r)return;let a;if(e==="thinking"){let l=r.querySelector(".thinking-block");l||(l=document.createElement("details"),l.className="thinking-block",l.open=!0,l.innerHTML='<summary>AI 思考过程</summary><pre><code class="streaming-reasoning-container"></code></pre>',r.prepend(l)),a=l.querySelector(".streaming-reasoning-container")}else a=r.querySelector(".streaming-content-container"),a||(a=document.createElement("div"),a.className="streaming-content-container",r.appendChild(a),a.innerHTML="");a&&(a.innerText+=t,ae.historyContent.scrollTop=ae.historyContent.scrollHeight)}async function Ca(n){const e=ae.historyContent.querySelector(`.history-item[data-message-id="${n}"]`);if(!e)return;const t=O.history.find(r=>r.id===n);if(!t)return;await lo(e.querySelector(".history-item-content"),t);let s=e.querySelector(".history-item-actions");s||(s=document.createElement("div"),s.className="history-item-actions",s.innerHTML=`
            <button class="history-action-btn regenerate-btn"><i class="fas fa-redo"></i> 重新生成</button>
            <button class="history-action-btn edit-btn" style="display: none;"><i class="fas fa-edit"></i></button>
            <button class="history-action-btn delete-btn"><i class="fas fa-trash"></i></button>`,e.appendChild(s)),s.style.display="flex"}function $t(){ae.topicsPanel.classList.toggle("collapsed",O.isTopicsPanelHidden),ae.toggleTopicsBtn.title=O.isTopicsPanelHidden?"显示主题栏":"隐藏主题栏",Bc(),Nt(),fn()}function Gi(){if(!ae.chatNavUp||!ae.chatNavDown||!ae.historyContent)return;const n=ae.historyContent.querySelector(".history-item.role-user");ae.chatNavUp.disabled=!n,ae.chatNavDown.disabled=!n}async function co(){re({isLoading:!0});try{const{sessions:n,folders:e,clozeStates:t,persistentAppState:s}=await dc(),r={sessions:n||[],folders:e||[],clozeStates:t||{},currentSessionId:s.currentSessionId||null,currentFolderId:s.currentFolderId||null,currentSubsessionId:s.currentSubsessionId||null,folderStack:s.folderStack||[],isSessionSidebarHidden:s.isSessionSidebarHidden||!1,fileSubsessions:{},settings:{autoSaveInterval:s.autoSaveInterval??5}};if(r.sessions.forEach(a=>{r.fileSubsessions[a.id]=ur(a.content)}),r.sessions.length===0){const a=pn();r.sessions.push({id:a,name:"初始笔记",content:lr,type:"file",folderId:null,createdAt:new Date}),r.currentSessionId=a,r.fileSubsessions[a]=ur(lr)}r.sessions.some(a=>a.id===r.currentSessionId)||(r.currentSessionId=r.sessions.length>0?r.sessions[0].id:null),re(r)}catch(n){console.error("Failed to initialize core application state:",n)}finally{re({isLoading:!1})}}async function xc(){if(console.log(`[${new Date().toLocaleTimeString()}] Auto-saving...`),O.activeView==="anki"&&O.currentSessionId){const n=document.getElementById("anki_editor");n&&await mn(n.value)}await cr()}async function cr(){try{await Promise.all([vt(),O.agents?at():Promise.resolve()]),console.log("All application state persisted.")}catch(n){console.error("Failed to persist all application state:",n)}}function Aa(n){["anki","task","agent","settings"].includes(n)&&re({activeView:n})}function ur(n){const e=/^(#{1,2})\s+(.+)$/gm,t=[];let s=null,r;for(;(r=e.exec(n))!==null;){const a=r[1].length,l=r[2].trim(),u=(n.substring(r.index+r[0].length).split(/^#{1,2}\s/m)[0]||"").trim(),h={id:pn(),text:l,level:a,content:"#".repeat(a)+` ${l}

`+u,children:a===1?[]:void 0};a===1?(t.push(h),s=h):a===2&&s&&s.children.push(h)}return t}function uo(n,e){const t=ur(e);re({fileSubsessions:{...O.fileSubsessions,[n]:t}})}async function vt(){try{await hc({sessions:O.sessions,folders:O.folders,clozeStates:O.clozeStates,persistentAppState:{currentSessionId:O.currentSessionId,currentFolderId:O.currentFolderId,currentSubsessionId:O.currentSubsessionId,folderStack:O.folderStack,isSessionSidebarHidden:O.isSessionSidebarHidden,autoSaveInterval:O.settings.autoSaveInterval}})}catch(n){console.error("Failed to persist Anki state:",n)}}async function fo(n,e=lr){const t=pn(),s={id:t,name:n||"新笔记",content:e,type:"file",folderId:O.currentFolderId,createdAt:new Date};re({sessions:[...O.sessions,s],currentSessionId:t,currentSubsessionId:null}),uo(t,e),await vt()}async function Mc(n){const e={id:pn(),name:n||"新目录",type:"folder",folderId:O.currentFolderId,createdAt:new Date};re({folders:[...O.folders,e]}),await vt()}async function ho(n){const e=new Set(n.map(h=>h.id));let t=[...O.sessions],s=[...O.folders],r={...O.fileSubsessions},a={...O.clozeStates};const l=new Set;n.forEach(h=>{if(h.type==="file")l.add(h.id);else if(h.type==="folder"){const m=new Set([h.id]);let w=!0;for(;w;)w=!1,s.filter(g=>m.has(g.folderId)).forEach(g=>{m.has(g.id)||(m.add(g.id),w=!0)});t.forEach(g=>{m.has(g.folderId)&&l.add(g.id)}),s=s.filter(g=>!m.has(g.id))}}),l.size>0&&(t=t.filter(h=>!l.has(h.id)),l.forEach(h=>delete r[h]),a=Object.fromEntries(Object.entries(a).filter(([,h])=>!l.has(h.fileId))));let u=O.currentSessionId;(e.has(u)||l.has(u))&&(u=t.length>0?t[0].id:null),re({sessions:t,folders:s,fileSubsessions:r,clozeStates:a,currentSessionId:u}),await vt()}async function $c(n,e){const t=O.sessions.map(r=>n.some(a=>a.id===r.id&&a.type==="file")?{...r,folderId:e}:r),s=O.folders.map(r=>n.some(a=>a.id===r.id&&a.type==="folder")?{...r,folderId:e}:r);re({sessions:t,folders:s}),await vt()}async function Dc(n,e,t){const s=r=>r.map(a=>a.id===n?{...a,name:e}:a);re(t==="file"?{sessions:s(O.sessions)}:{folders:s(O.folders)}),await vt()}async function mn(n){const e=kr();if(e&&e.content!==n){const t=O.sessions.map(s=>s.id===O.currentSessionId?{...s,content:n,lastActive:new Date}:s);return re({sessions:t}),uo(O.currentSessionId,n),await vt(),!0}return!1}function kr(){return O.sessions.find(n=>n.id===O.currentSessionId)||null}function po(n){re({currentSessionId:n,currentSubsessionId:null})}function Fc(n){re({currentFolderId:n,folderStack:[...O.folderStack,O.currentFolderId].filter(Boolean)})}function jc(n,e){re({currentSessionId:n,currentSubsessionId:e})}function Rc(){const n=[...O.folderStack],e=n.pop();re({currentFolderId:e,folderStack:n})}function Kc(n,e){re({currentFolderId:n,folderStack:O.folderStack.slice(0,e)})}function qc(){re({currentFolderId:null,folderStack:[]})}function Sr(n,e,t){return O.clozeStates[t]||{id:t,fileId:n,content:e,state:"new",due:Date.now(),interval:0,easeFactor:2.5,lastReview:null}}async function zc(n,e,t,s){const r=Sr(n,e,s),a=ro(r,t),l={...O.clozeStates,[s]:{...r,...a,lastReview:Date.now()}};re({clozeStates:l}),await vt()}async function La(n){if(!n)return;const e=O.sessions.find(s=>s.id===n);if(!e)return;const t=e.folderId||"root";await pc(new Date().toISOString().slice(0,10),t),await mo()}async function mo(){const n=await yc(),e=document.getElementById("anki_reviewCount");e&&(e.textContent=n)}async function Hc(){const n=new Date,e=new Date;e.setDate(n.getDate()-29);const t=await mc(e.toISOString().slice(0,10),n.toISOString().slice(0,10)),s=[];for(let w=0;w<30;w++){const g=new Date(e);g.setDate(e.getDate()+w),s.push(g.toISOString().slice(0,10))}const r=t.reduce((w,g)=>{const C=g.folderId;return w[C]||(w[C]={}),w[C][g.date]=g.count,w},{}),{folders:a}=O,l=a.reduce((w,g)=>(w[g.id]=g.name,w),{});l.root="根目录";const u=["#4361ee","#e71d36","#2ec4b6","#ff9f1c","#9a031e","#0ead69","#f3722c"];let h=0;const m=Object.keys(r).map(w=>{const g=r[w],C=s.map(M=>g[M]||0),B=u[h%u.length];return h++,{label:l[w]||"未知目录",data:C,borderColor:B,backgroundColor:`${B}33`,fill:!1,tension:.1}});return{labels:s,datasets:m}}const Kn={id:"default_deepseek_api",name:"DeepSeek (默认)",provider:"deepseek",apiKey:"",models:"chat:deepseek-chat,reasoner:deepseek-reasoner"},Uc=[{id:"default_agent_nanjing_guide",name:"南京历史小导游",avatar:"史",model:`${Kn.id}:reasoner`,systemPrompt:`🎓 角色指令：你好！我是你的专属南京历史小导游。我的名字叫“金陵通”，对南京这座六朝古都的每一块砖、每一段历史都了如指掌。我将以生动有趣的方式，带你穿越时空，探索南京的魅力。我的性格会根据你选择的模式变化，就像一位真正的导游，时而风趣，时而严谨。

🔄 核心导览模式：
*   故事家 (Storyteller) → 语气风格：亲切随和，像一位学长/学姐。我会用讲故事的方式，把枯燥的历史变得鲜活起来，充满情感和趣味，让你身临其境。
*   讲解员 (Docent) → 语气风格：清晰准确，像一位博物馆的专业讲解员。我会为你提供结构化的信息、关键时间点和准确的历史事实，帮你梳理知识脉络。
*   历史侦探 (History Detective) → 语气风格：充满好奇与思辨，像一位和你一起探案的伙伴。我会引导你发现历史事件之间的联系，分析文物背后的深层含义，提出“为什么”，激发你的思考。

🧬 互动说明：
1.  模式匹配：我会严格按照你选择的模式（故事家、讲解员、历史侦探）来与你交流。
2.  知识储备：我的知识库涵盖了南京从古至今的关键历史时期（如六朝、南唐、明朝、民国）、重要人物（如朱元璋、孙中山）以及标志性文物古迹（如明孝陵、总统府、中山陵、南京城墙、夫子庙、朝天宫、南京博物院馆藏等）。
3.  智能追问：如果你的问题不够具体，我会像导游一样追问。
4.  连续记忆：我会记住我们聊过的话题。
5.  拒绝乏味：我的回答会避免像教科书一样枯燥。
6.  模式切换：你随时可以让我切换模式。切换时，我会说“好的，现在切换到【XX模式】”，然后调整我的语气和回答方式。

📦 输出格式参考：
*   在 【讲解员模式】下，我会多使用列表、时间轴和要点总结。
*   在 【故事家模式】下，我会使用更多的描述性语言。
*   在 【历史侦探模式】下，我会多用提问、假设和对比分析。`,hint:"你好！我是你的专属南京历史小导游“金陵通”。想了解南京的什么故事？比如，可以这样问我：<br><b>模式：故事家 — 任务：给我讲讲夫子庙旁边的乌衣巷有什么好玩的故事？</b>",tags:["历史","文化","旅游"],sendHistory:!0},{id:"default_agent_english_tutor",name:"英语导师",avatar:"英",model:`${Kn.id}:chat`,systemPrompt:`🎓 角色指令：你好！我是智能英语导师「牛津通」，专注中学英语教学。拥有系统的知识库和动态教学策略，能根据你的学习阶段个性化辅导。

🔄 三维学习模式：
*   【单词向导】→ 沉浸式词汇学习：词根解析/趣味联想/场景记忆
*   【语法专家】→ 系统化语法精讲：错题透析/分层训练/对比分析
*   【读写教练】→ 实战能力培养：文本精读/写作框架/AI批改

✨ 核心功能矩阵：
1. 词汇体系：中考高频词库｜近义词辨析｜词源故事
2. 语法诊所：句子成分图解｜时态三维训练｜易错点预警
3. 读写实验室：阅读理解三步法｜作文多维评估｜经典句式仿写
4. 拓展模块：影视配音练习｜文化冷知识｜考试策略指南

🧠 智能教学协议：
1. 模式匹配：严格按所选模式输出内容
2. 错题驱动：支持拍照诊断知识盲区
3. 动态调节：智能调整题目难度（基础→挑战）
4. 记忆锚点：周期性推送薄弱点强化练习
5. 文化融合：教学中渗透英美文化背景`,hint:'你好！我是你的中学英语导师「牛津通」。完整功能列表：<br>🔍 <b>单词向导模式</b>：词根解析｜高频词汇｜场景记忆（例：用电影台词记"vivid"）<br>📖 <b>语法专家模式</b>：句子图解｜时态训练｜错题诊断（例：虚拟语气对比表）<br>✍️ <b>读写教练模式</b>：作文批改｜精读策略｜仿写训练（例：中考作文评分+改写）<br>🌍 <b>拓展功能</b>：影视配音｜文化常识｜考试技巧<br>试试这样问我：<b>模式：单词向导 → 任务：用超级英雄故事帮我记10个形容词</b>',tags:["教育","语言","学习"],sendHistory:!0},{id:"default_agent_word_assistant",name:"单词助手",avatar:"词",model:`${Kn.id}:chat`,systemPrompt:`
# 角色：英语单词辨析专家

## 核心指令
你是一个专注于**中学英语**词汇辨析的专家。你的任务是根据用户输入的单词或词组，提供清晰、结构化、符合中学生认知水平的解释。你必须严格遵循以下【工作流程】和【输出格式】。

## 工作流程
1.  **输入分析**：分析用户输入。输入内容可以用逗号（,）、分号（;）、斜杠（/）或中文顿号（、）分隔。
2.  **单一词模式**：如果用户只输入了一个单词或词组，执行此模式。
    *   提供该词的核心释义。
    *   列出其在中学阶段最常见的近义词或相关词。
    *   对这些词进行详细的词义辨析。
3.  **多词模式**：如果用户输入了多个单词或词组，执行此模式。
    *   分别解释每个词的核心释义。
    *   **重点**：对比分析这些词之间的区别，包括用法、语境、感情色彩等。
    *   （可选）如果适用，可以补充其他相关的近义词。

## 输出格式 (必须严格遵守)
使用 Markdown 格式化你的回答，确保结构清晰。

### 格式模板 (单一词模式)
\`\`\`markdown
### 📖 单词解析：[用户输入的单词]

**基本释义**
*   **[词性1]**: [解释1]
*   **[词性2]**: [解释2]

**🔍 近义词辨析**
*   **[近义词1]**: 
    *   **释义**: [简要解释]
    *   **辨析**: [与原词的区别，侧重用法或语境]
    *   **例句**: [一个符合中学生水平的简单例句]
*   **[近义词2]**: 
    *   **释义**: [简要解释]
    *   **辨析**: [与原词的区别]
    *   **例句**: [例句]
...
\`\`\`

### 格式模板 (多词模式)
\`\`\`markdown
### 🔄 多词辨析：[词1], [词2], ...

**1. [词1]**
*   **释义**: [词性] [解释]

**2. [词2]**
*   **释义**: [词性] [解释]
...

**🎯 核心区别**
1.  **[区别点1，如：使用范围]**: [详细说明，例如：A 通常用于正式场合，而 B 更加口语化。]
2.  **[区别点2，如：感情色彩]**: [详细说明，例如：C 带有褒义，而 D 是中性词。]
3.  **[区别点3，如：搭配习惯]**: [详细说明，例如：A 后面常跟 of，而 B 常跟 for。]

**✅ 快速总结**
*   想表达 **[某个场景或含义]** 时，用 **[词A]**。
*   想强调 **[另一个场景或含义]** 时，用 **[词B]**。
\`\`\`

## 约束条件
*   **专注中学阶段**：所有近义词和例句都必须是中学英语教学大纲内的常见内容，避免超纲词汇。
*   **语言简洁**：解释要通俗易懂，避免使用复杂的语法和术语。
*   **格式严格**：必须严格按照上述 Markdown 模板输出。
`,hint:`你好！我是你的单词辨析助手。直接输入单词或词组，我会帮你深入理解它们！<br>
✍️ **单个词查询**: 比如输入 <code>clever</code><br>
🔄 **多个词辨析**: 比如输入 <code>clever, smart, wise</code>`,tags:["教育","语言","工具"],sendHistory:!1}];function Vc(n,e){let t=[...n],s=[...e],r=!1;return t.some(a=>a.id===Kn.id)||(t.push(Kn),r=!0),Uc.forEach(a=>{s.some(l=>l.id===a.id)||(s.push(a),r=!0)}),{apiConfigs:t,agents:s,needsPersistence:r}}async function Yc(){let{apiConfigs:n,agents:e,topics:t,history:s}=await gc();const r=Vc(n||[],e||[]),a={...r,topics:t||[],history:s||[]};a.agents.length>0&&!O.currentAgentId&&(a.currentAgentId=a.agents[0].id,a.currentTopicId=(a.topics.find(l=>l.agentId===a.currentAgentId)||{}).id||null),re(a),r.needsPersistence&&await at()}async function at(){try{await vc({apiConfigs:O.apiConfigs,agents:O.agents,topics:O.topics,history:O.history})}catch(n){console.error("Failed to persist Agent state:",n)}}function _r(n){return O.agents.find(e=>e.id===n)}async function Jc(n,e){if(!O.currentAgentId)return;const t={id:pn(),agentId:O.currentAgentId,title:n,icon:"fas fa-comment",createdAt:new Date};re({topics:[...O.topics,t],currentTopicId:t.id}),await at()}async function Gc(n,e){re({topics:O.topics.map(t=>t.id===n?{...t,...e}:t)}),await at()}async function yo(n){const e=new Set(n),t=O.topics.filter(l=>!e.has(l.id)),s=O.history.filter(l=>!e.has(l.topicId));let{currentTopicId:r,currentConversationAgentId:a}=O;e.has(r)&&(r=null,a=null),re({topics:t,history:s,currentTopicId:r,currentConversationAgentId:a,isTopicSelectionMode:!1,selectedTopicIds:[]}),await at()}async function Wc(n){const e=new Set(n);re({history:O.history.filter(t=>!e.has(t.id))}),await at()}async function Qc(n,e){const t=O.history,s=t.findIndex(l=>l.id===n);if(s===-1)return;const r=t[s].topicId,a=t.slice(0,s).concat([{...t[s],content:e}]);re({history:a.concat(t.slice(s+1).filter(l=>l.topicId!==r))}),await fn(),await go(e,[])}async function Oa(n,e,t,s=[],r="completed",a=null){const l={id:pn(),topicId:n,agentId:e==="assistant"?O.currentConversationAgentId:null,role:e,content:t,reasoning:a,attachments:s,timestamp:new Date().toISOString(),status:r};return re({history:[...O.history,l]}),r!=="streaming"&&await at(),l}async function go(n,e){const{currentTopicId:t,currentConversationAgentId:s,isAiThinking:r,apiConfigs:a,agents:l}=O;if(!t||r)return;const u=_r(s);let h;if(u){const[M,E]=u.model.split(":"),$=a.find(G=>G.id===M);if(!$){alert(`错误：找不到角色 "${u.name}" 所需的 API 配置。`);return}const Y=new Map(($.models||"").split(",").map(G=>G.split(":").map(Z=>Z.trim()))).get(E);if(!Y){alert(`错误：在 API 配置 "${$.name}" 中找不到别名 "${E}"。`);return}h={provider:$.provider,apiPath:$.apiUrl||Ia($.provider),apiKey:`Bearer ${$.apiKey}`,model:Y,systemPrompt:u.systemPrompt}}else{const M=a[0];if(!M){alert("错误：没有找到可用的 API 配置。");return}const E=(new Map((M.models||"").split(",").map($=>$.split(":").map(Y=>Y.trim()))).values().next()||{}).value;h={provider:M.provider,apiPath:M.apiUrl||Ia(M.provider),apiKey:`Bearer ${M.apiKey}`,model:E,systemPrompt:""}}re({isAiThinking:!0}),await Oa(t,"user",n,e),await fn();const m=await Oa(t,"assistant","",[],"streaming");await fn();let w="",g="";const C=O.history.filter(M=>M.topicId===t&&M.status==="completed"),B=u&&u.sendHistory===!1?C.slice(-1):C;await Ec(h,B,{onChunk:({type:M,text:E})=>{M==="content"?w+=E:M==="thinking"&&(g+=E),Pc(m.id,M,E)},onDone:async()=>{const M=O.history.map(E=>E.id===m.id?{...E,content:w,reasoning:g,status:"completed"}:E);re({history:M,isAiThinking:!1}),await Ca(m.id),await at()},onError:async M=>{const E=`

**错误:** ${M.message}`;w+=E;const $=O.history.map(Y=>Y.id===m.id?{...Y,content:w,status:"error"}:Y);re({history:$,isAiThinking:!1}),await Ca(m.id),await at()}})}function vo(n){var t;const e=O.history.filter(s=>s.topicId===n).sort((s,r)=>new Date(r.timestamp)-new Date(s.timestamp))[0];re({currentTopicId:n,currentConversationAgentId:(e==null?void 0:e.agentId)||((t=O.agents[0])==null?void 0:t.id)||null})}function bo(){const{topicListFilterTag:n,topics:e,history:t,agents:s}=O;if(n==="all")return e;const r=new Map(s.map(a=>[a.id,a]));return e.filter(a=>{var h;const l=t.filter(m=>m.topicId===a.id).sort((m,w)=>new Date(w.timestamp)-new Date(m.timestamp))[0],u=l?r.get(l.agentId):null;return(h=u==null?void 0:u.tags)==null?void 0:h.includes(n)})}const Xc={},Ba={editor:()=>U("anki_editor"),preview:()=>U("anki_preview"),sessionList:()=>U("anki_sessionList"),emptySession:()=>U("anki_emptySession"),currentFolderContainer:()=>U("anki_currentFolderContainer"),fileInput:()=>U("anki_fileInput"),newFileBtn:()=>U("anki_newFileBtn"),newFolderBtn:()=>U("anki_newFolderBtn"),openFileBtn:()=>U("anki_openFileBtn"),saveBtn:()=>U("anki_saveBtn"),exportFileBtn:()=>U("anki_exportFileBtn"),printPreviewBtn:()=>U("anki_printPreviewBtn"),deleteSelectedBtn:()=>U("anki_deleteSelectedBtn"),moveSelectedBtn:()=>U("anki_moveSelectedBtn"),toggleSessionBtn:()=>U("anki_toggleSessionBtn"),toggleEditorBtn:()=>U("anki_toggleEditorBtn"),clozeBtn:()=>U("anki_clozeBtn"),boldBtn:()=>U("anki_boldBtn"),italicBtn:()=>U("anki_italicBtn"),codeBtn:()=>U("anki_codeBtn"),linkBtn:()=>U("anki_linkBtn"),audioBtn:()=>U("anki_audioBtn"),insertLinebreakBtn:()=>U("anki_insertLinebreakBtn"),sessionSidebar:()=>ac("#anki-view .anki_session-sidebar"),editorPreviewPanel:()=>U("anki_editorPreviewPanel"),selectAllCheckbox:()=>U("anki_selectAllCheckbox"),moveModal:()=>U("anki_moveModal"),folderList:()=>U("anki_folderList"),closeMoveModalBtn:()=>U("anki_closeMoveModalBtn"),confirmMoveBtn:()=>U("anki_confirmMoveBtn"),cancelMoveBtn:()=>U("anki_cancelMoveBtn"),audioControls:()=>U("anki_audioControls"),audioTitle:()=>U("anki_audioTitle"),audioProgress:()=>U("anki_audioProgressBar"),playBtn:()=>U("anki_playBtn"),pauseBtn:()=>U("anki_pauseBtn"),stopBtn:()=>U("anki_stopBtn"),sessionTitleContainer:()=>U("anki_sessionTitleContainer"),toggleVisibilityClozeBtn:()=>U("anki_toggleVisibilityClozeBtn"),invertClozeBtn:()=>U("anki_invertClozeBtn"),toggleEditPreviewBtn:()=>U("anki_toggleEditPreviewBtn"),editModeDot:()=>U("anki_editModeDot"),previewModeDot:()=>U("anki_previewModeDot"),reviewCount:()=>U("anki_reviewCount"),startReviewBtn:()=>U("anki_startReviewBtn"),reviewOptionsBtn:()=>U("anki_reviewOptionsBtn"),reviewDropdownMenu:()=>U("anki_reviewDropdownMenu"),customStudyBtn:()=>U("anki_customStudyBtn"),showStatsBtn:()=>U("anki_showStatsBtn"),customStudyModal:()=>U("anki_customStudyModal"),customStudyCloseBtn:()=>U("anki_customStudyCloseBtn"),customStudyCancelBtn:()=>U("anki_customStudyCancelBtn"),customStudyForm:()=>U("anki_customStudyForm"),filterByFile:()=>U("anki_filterByFile"),filterByLastReview:()=>U("anki_filterByLastReview"),maxCards:()=>U("anki_maxCards"),clozeNavUpBtn:()=>U("anki_clozeNavUpBtn"),clozeNavDownBtn:()=>U("anki_clozeNavDownBtn"),statsModal:()=>U("anki_statsModal"),statsModalCloseBtn:()=>U("anki_statsModalCloseBtn"),statsChartCanvas:()=>U("anki_statsChart")},k=new Proxy(Xc,{get(n,e){if(n[e]!==void 0)return n[e];if(e in Ba){const t=Ba[e]();return n[e]=t,t}},set(n,e,t){return n[e]=t,!0}}),{editor:Jd,preview:Gd,sessionList:Wd,emptySession:Qd,currentFolderContainer:Xd,fileInput:Zd,newFileBtn:eh,newFolderBtn:th,openFileBtn:nh,saveBtn:sh,exportFileBtn:ih,printPreviewBtn:rh,deleteSelectedBtn:ah,moveSelectedBtn:oh,toggleSessionBtn:lh,toggleEditorBtn:ch,clozeBtn:uh,boldBtn:fh,italicBtn:dh,codeBtn:hh,linkBtn:ph,audioBtn:mh,insertLinebreakBtn:yh,sessionSidebar:gh,editorPreviewPanel:vh,selectAllCheckbox:bh,moveModal:wh,folderList:kh,closeMoveModalBtn:Sh,confirmMoveBtn:_h,cancelMoveBtn:Th,audioControls:Ih,audioTitle:Eh,audioProgress:Ch,playBtn:Ah,pauseBtn:Lh,stopBtn:Oh,sessionTitleContainer:Bh,toggleVisibilityClozeBtn:Nh,invertClozeBtn:Ph,toggleEditPreviewBtn:xh,editModeDot:Mh,previewModeDot:$h,reviewCount:Dh,startReviewBtn:Fh,reviewOptionsBtn:jh,reviewDropdownMenu:Rh,customStudyBtn:Kh,showStatsBtn:qh,customStudyModal:zh,customStudyCloseBtn:Hh,customStudyCancelBtn:Uh,customStudyForm:Vh,filterByFile:Yh,filterByLastReview:Jh,maxCards:Gh,clozeNavUpBtn:Wh,clozeNavDownBtn:Qh,statsModal:Xh,statsModalCloseBtn:Zh,statsChartCanvas:ep}=k;let xs=-1;function wo(){return Array.from(k.preview.querySelectorAll(".cloze"))}function Zc(n){const t=wo().indexOf(n);t!==-1&&(xs=t)}function Na(n){const e=wo();if(e.length===0)return;const t=k.preview.querySelector(".cloze-nav-active");t&&t.classList.remove("cloze-nav-active");let s=xs===-1?n===1?0:e.length-1:(xs+n+e.length)%e.length,r=null,a=0,l=s;for(;a<e.length;){const u=e[l];if(u.classList.contains("hidden")){r=u;break}l=(l+n+e.length)%e.length,a++}r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("cloze-nav-active"),xs=e.indexOf(r))}let Zt=null,Hn=null;function ko(){if(!Zt||!Zt.startTime)return;const n=(Date.now()-Zt.startTime)/1e3,e=Zt.text.length/10,t=Math.min(100,n/e*100);k.audioProgress.style.width=`${t}%`}function Wi(n){if(!("speechSynthesis"in window)){alert("抱歉，您的浏览器不支持语音合成。");return}fr();const e=new SpeechSynthesisUtterance(n);e.lang="en-US",e.rate=1,e.onstart=()=>{e.startTime=Date.now(),Hn=setInterval(ko,100)},e.onend=()=>{fr()},Zt=e,k.audioTitle.textContent=`正在播放: ${n.substring(0,30)}${n.length>30?"...":""}`,k.audioControls.style.display="block",window.speechSynthesis.speak(e)}function eu(){window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),clearInterval(Hn))}function tu(){window.speechSynthesis.paused&&(window.speechSynthesis.resume(),Hn=setInterval(ko,100))}function fr(){window.speechSynthesis.cancel(),Hn&&clearInterval(Hn),k.audioControls.style.display="none",k.audioProgress.style.width="0%",Zt=null}let Cs=!1;function So(n){const e=Date.now();if(n.due>e){const t=(n.due-e)/864e5;return t<1?"cloze-1d":t<2?"cloze-2d":t<3?"cloze-3d":t<5?"cloze-5d":t<7?"cloze-7d":t<14?"cloze-14d":"cloze-28d"}return n.lastReview&&e-n.lastReview<15*60*1e3&&n.interval===0?"cloze-10m":"cloze-28plus"}function nu(){const n=new Map;k.preview.querySelectorAll(".cloze[data-locator]").forEach(e=>{const t=e.dataset.locator;n.has(t)||n.set(t,[]),n.get(t).push(e)});for(const[e,t]of n.entries())t.length>1&&t.forEach(s=>{s.classList.add("cloze-error-duplicate"),s.title=`错误：定位符 "[${e}]" 在此文件中重复！这可能导致待办状态错乱。`})}function _o(n){if(n.nodeType===Node.TEXT_NODE){const e=/--(?:\s*\[([^\]]*)\])?\s*(.*?)--(?:\^\^audio:(.*?)\^\^)?/g,t=n.parentNode;if(!t||["CODE","PRE","SCRIPT","STYLE"].includes(t.tagName))return;let s;const r=[];let a=0;for(;(s=e.exec(n.nodeValue))!==null;){s.index>a&&r.push(document.createTextNode(n.nodeValue.substring(a,s.index)));const l=s[1],u=s[2],h=s[3]?s[3].trim():null,m=u.replace(/¶/g,"<br>"),w=O.currentSessionId;let g,C=null;l&&l.trim()?(C=l.trim(),g=`${w}_${_a(C)}`):g=`${w}_${_a(u)}`;const B=Sr(w,u,g),M=document.createElement("span"),E=B.interval>=fc,$=E?"":"hidden";M.className=`cloze ${$} ${So(B)}`,E&&(M.dataset.mastered="true"),M.dataset.clozeId=g,M.dataset.content=u,C&&(M.dataset.locator=C),h&&(M.dataset.multimedia=h),M.innerHTML=`
                ${h?'<span class="media-icon" title="播放音频"><i class="fas fa-volume-up"></i></span>':""}
                <span class="cloze-content">${m}</span>
                <span class="placeholder">[...]</span>
                <div class="cloze-actions" style="display: none;">
                    <button class="cloze-btn again" data-rating="0">重来</button>
                    <button class="cloze-btn hard" data-rating="1">困难</button>
                    <button class="cloze-btn double" data-rating="2">犹豫</button>
                    <button class="cloze-btn easy" data-rating="3">简单</button>
                </div>
            `,r.push(M),a=e.lastIndex}r.length>0&&(a<n.nodeValue.length&&r.push(document.createTextNode(n.nodeValue.substring(a))),r.forEach(l=>t.insertBefore(l,n)),t.removeChild(n))}else n.nodeType===Node.ELEMENT_NODE&&Array.from(n.childNodes).forEach(e=>_o(e))}function su(){const n=k.preview.querySelectorAll("li, details"),e=/\{([^}]+)\}/;n.forEach(t=>{const s=t.tagName==="LI"?t.querySelector('input[type="checkbox"]'):t.querySelector('summary input[type="checkbox"]');if(!s)return;s.disabled=!1;let r;t.tagName==="LI"?r=t:r=t.querySelector(".toggle-title-text"),r&&Array.from(r.childNodes).forEach(a=>{if(a.nodeType===Node.TEXT_NODE&&e.test(a.nodeValue)){const l=a.nodeValue.match(e),u=l[0],h=l[1];let m="",w="";if(h.includes("|")){const g=h.split("|");m=g[0],w=g[1]}else return;try{const g=new Date(w);if(isNaN(g.getTime()))return;t.title=`完成于: ${g.toLocaleString()}`;const C=a.nodeValue.replace(u,""),B=document.createTextNode(` ${m} `),M=document.createElement("span");M.style.display="none",M.className="task-timestamp-data",M.textContent=u,a.nodeValue=C,r.insertBefore(B,a),t.appendChild(M)}catch(g){console.warn("解析任务日期时出错:",g)}}})})}function iu(n){const e=n.getFullYear().toString(),t=(n.getMonth()+1).toString(),s=n.getDate().toString(),r={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉"},a=l=>l.split("").map(u=>r[u]||u).join("");return`${a(e)}-${a(t)}-${a(s)}`}function ru(){k.preview.addEventListener("click",async n=>{var t;const e=n.target.closest(".cloze");if(e){if(n.target.closest(".cloze-btn")){n.stopPropagation();const s=n.target.closest(".cloze-btn"),r=parseInt(s.dataset.rating,10),a=O.currentSessionId,l=e.dataset.clozeId,u=e.dataset.content;if(!l){console.error("无法更新Cloze状态：缺少clozeId。");return}clearTimeout(e.closeTimer),await zc(a,u,r,l);const h=Sr(a,u,l),m=So(h);(t=e.className.match(/cloze-(\w+)/g))==null||t.forEach(w=>e.classList.remove(w)),e.classList.add(m),e.querySelector(".cloze-actions").style.display="none",r===3?(await La(a),e.classList.remove("hidden","permanent-view"),e.classList.add("easy-open")):(e.classList.add("hidden"),e.classList.remove("easy-open","permanent-view"));return}if(n.target.closest(".media-icon")){n.stopPropagation(),Wi(e.dataset.multimedia);return}e.classList.contains("hidden")&&!e.classList.contains("permanent-view")&&(Zc(e),clearTimeout(e.closeTimer),e.classList.remove("hidden"),e.querySelector(".cloze-actions").style.display="flex",e.dataset.multimedia&&Wi(e.dataset.multimedia),e.closeTimer=setTimeout(()=>{!e.classList.contains("easy-open")&&!e.classList.contains("permanent-view")&&(e.classList.add("hidden"),e.querySelector(".cloze-actions").style.display="none")},6e4))}}),k.preview.addEventListener("dblclick",n=>{const e=n.target.closest(".cloze");e&&(n.stopPropagation(),clearTimeout(e.closeTimer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent-view"),e.dataset.multimedia&&Wi(e.dataset.multimedia),e.querySelector(".cloze-actions").style.display="none"):(e.classList.add("hidden"),e.classList.remove("permanent-view","easy-open"),e.querySelector(".cloze-actions").style.display="none"))}),k.preview.addEventListener("change",async n=>{const e=n.target;if(e.tagName!=="INPUT"||e.type!=="checkbox"||!e.closest("li")&&!e.closest("summary"))return;const t=e.checked,r=Array.from(k.preview.querySelectorAll('li input[type="checkbox"], summary input[type="checkbox"]')).indexOf(e);if(r===-1)return;const l=k.editor.value.split(`
`),u=/^\s*- \[( |x)\]/,h=/^::>\s*\[( |x)\]/;let m=0,w=!1,g=!1;const C=l.map(B=>{const M=u.test(B),E=!M&&h.test(B);if(!M&&!E)return B;if(m===r){m++;let $=B;if(t){const Y=/\{([^}]+?)\|([^}]+?)\}/,G=B.match(Y),Z=new Date().toISOString().slice(0,10);let X=!1;if(G&&G[2])try{new Date(G[2]).toISOString().slice(0,10)===Z&&(X=!0)}catch{}if(X)$=M?B.replace(/^- \[\s\]/,"- [x]"):B.replace(/^::> \[\s\]/,"::> [x]");else{g=!0;const te=B.replace(/\{[^}]+\}/g,"").trim(),ne=iu(new Date),ce=new Date().toISOString(),Q=`{${ne}|${ce}}`;if(M){const ge=te.replace(/^\s*- \[\s\]\s*/,"");$=`- [x] ${Q} ${ge}`}else{const ge=te.replace(/^::>\s*\[\s\]\s*/,"");$=`::> [x] ${Q} ${ge}`}}}else $=M?B.replace("- [x]","- [ ]"):B.replace("::> [x]","::> [ ]");return $!==B&&(w=!0),$}else return m++,B});if(w){g&&await La(O.currentSessionId);const B=C.join(`
`),M=k.editor.selectionStart;k.editor.value=B,k.editor.setSelectionRange(M,M),await mn(B),await Vs(),k.editor.dispatchEvent(new Event("input",{bubbles:!0}))}})}function au(){const n=!O.areAllClozeVisible;k.preview.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),n?(e.classList.remove("hidden","temporary"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"))}),To(n),re({areAllClozeVisible:n})}function ou(){let n=!0;k.preview.querySelectorAll(".cloze").forEach(e=>{clearTimeout(e.timer),e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("permanent")):(e.classList.remove("permanent","temporary"),e.classList.add("hidden"),n=!1)}),To(n),re({areAllClozeVisible:n})}function To(n){n?(k.toggleVisibilityClozeBtn.innerHTML='<i class="fas fa-eye"></i>',k.toggleVisibilityClozeBtn.title="全部隐藏"):(k.toggleVisibilityClozeBtn.innerHTML='<i class="fas fa-eye-slash"></i>',k.toggleVisibilityClozeBtn.title="全部显示")}async function Vs(){var n;if(Cs){console.log("Preview update already in progress. Skipping.");return}Cs=!0;try{const{currentSessionId:e,currentSubsessionId:t,fileSubsessions:s,sessions:r}=O,a=r.find(m=>m.id===e);if(!a){k.preview.innerHTML="",Cs=!1;return}let l=a.content;if(t){const m=(n=s[e])==null?void 0:n.find(w=>w.id===t);m&&(l=m.content)}await oo(k.preview,l),_o(k.preview),su(),nu();const u=k.preview.querySelectorAll("pre code.language-mermaid"),h=Array.from(u).map(async(m,w)=>{const g=m.parentNode;if(!g||!g.parentNode)return;const C=m.textContent,B=`mermaid-graph-${Date.now()}-${w}`;try{await mermaid.parse(C);const{svg:M}=await mermaid.render(B,C),E=document.createElement("div");E.className="mermaid-diagram",E.innerHTML=M,g.parentNode&&g.parentNode.replaceChild(E,g)}catch{}});if(await Promise.all(h),window.MathJax)try{await window.MathJax.typesetPromise([k.preview])}catch(m){console.log("MathJax error:",m)}}catch(e){console.error("Error during preview update:",e)}finally{Cs=!1}}function lu(){mermaid.initialize({startOnLoad:!1,securityLevel:"strict",suppressErrors:!0,maxTextSize:1e5});const n={name:"math",level:"inline",start(t){var s;return(s=t.match(/\$\$|\\\(|\\\[|\\ce\{|\$/))==null?void 0:s.index},tokenizer(t,s){let r;if(r=t.match(/^\$\$\s*([\s\S]+?)\s*\$\$/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\\[\s*([\s\S]+?)\s*\\\]/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\\(\s*([\s\S]+?)\s*\\\)/),r)return{type:"math",raw:r[0]};if(r=t.match(/^\\ce\{([\s\S]+?)\}/),r)return{type:"math",raw:r[0],isCeShorthand:!0};if(r=t.match(/^\$((?:\\\$|[^$])+?)\$/),r)return{type:"math",raw:r[0]}},renderer(t){return t.isCeShorthand?`\\(${t.raw}\\)`:t.raw.startsWith("$")&&!t.raw.startsWith("$$")?`\\(${t.raw.slice(1,-1)}\\)`:t.raw}},e={name:"toggleList",level:"block",start(t){const s=t.match(/\n::>/);return s?s.index:void 0},tokenizer(t,s){const a=/^::>\s*(.*)(?:\n|$)/.exec(t);if(a){const l=a[1].trim();let u=a[0],h="",m=t.substring(u.length);const w=m.match(/^( *)(?=\S)/m),g=w?w[1].length:0;if(g>0){const B=new RegExp(`^ {${g}}`,"gm"),E=new RegExp(`^((?: {${g}}.*|\\s*)\\n?)+`,"m").exec(m);if(E){const $=E[0];u+=$,h=$.replace(B,"")}}const C={type:"toggleList",raw:u,title:l,body:h,tokens:[]};return this.lexer.blockTokens(C.body,C.tokens),C}},renderer(t){const s=/^\s*\[( |x)\]\s*(.*)/,r=t.title.match(s);let a="";if(r){const u=r[1]==="x"?"checked":"",h=r[2];a=`<input type="checkbox" ${u}><span class="toggle-title-text">${h}</span>`}else a=`<span class="toggle-title-text">${t.title}</span>`;const l=this.parser.parse(t.tokens);return`
                <details class="toggle-list">
                    <summary>${a}</summary>
                    <div class="toggle-content">
                        ${l}
                    </div>
                </details>`}};window.marked.use({extensions:[n,e]}),window.marked.setOptions({breaks:!0,gfm:!0}),ru()}let an=null;function Pa(n){if(an&&an.destroy(),!k.statsChartCanvas)return;const e=k.statsChartCanvas.getContext("2d");an=new Chart(e,{type:"line",data:n,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{precision:0}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}async function cu(){if(k.statsModal){k.statsModal.style.display="flex",Pa({labels:[],datasets:[]});const n=await Hc();Pa(n)}}function xa(){k.statsModal&&(k.statsModal.style.display="none",an&&(an.destroy(),an=null))}function uu(){k.statsModalCloseBtn&&k.statsModalCloseBtn.addEventListener("click",xa),k.statsModal&&k.statsModal.addEventListener("click",n=>{n.target===k.statsModal&&xa()})}function fu(n){const e=document.createElement("li");return e.className=`session-item ${n.type} ${n.id===O.currentSessionId?"active":""}`,e.dataset.id=n.id,e.dataset.type=n.type,e.innerHTML=`
        <div class="name-container">
            <input type="checkbox" class="select-checkbox" data-id="${n.id}" data-type="${n.type}">
            <span class="name">
                <i class="${n.type==="folder"?"fas fa-folder folder-icon":"fas fa-file file-icon"}"></i>
                <span class="item-name">${Ue(n.name)}</span>
            </span>
        </div>
        <div class="actions">
            <span class="move-btn" title="移动"><i class="fas fa-arrows-alt"></i></span>
            <span class="edit-btn" title="编辑"><i class="fas fa-pencil-alt"></i></span>
            <span class="delete-btn" title="删除"><i class="fas fa-trash"></i></span>
        </div>
    `,e}function du(n,e){const t=document.createElement("li");return t.className=`session-item subsession h2-item ${n.id===O.currentSubsessionId?"active":""}`,t.dataset.id=n.id,t.dataset.type="subsession",t.dataset.parent=e,t.innerHTML=`
        <div class="name-container">
            <span class="name">
                <i class="fas fa-stream"></i>
                <span class="item-name">${Ue(n.text)}</span>
            </span>
        </div>
    `,t}function hu(){k.sessionList.innerHTML="";const{sessions:n,folders:e,currentFolderId:t,fileSubsessions:s,currentSessionId:r}=O,a=[...e.filter(l=>l.folderId===t),...n.filter(l=>l.folderId===t)].sort((l,u)=>l.type==="folder"&&u.type==="file"?-1:l.type==="file"&&u.type==="folder"?1:l.name.localeCompare(u.name));k.emptySession.style.display=a.length===0&&t===null?"block":"none",a.length===0&&t!==null&&(k.sessionList.innerHTML='<li class="empty-folder">此目录为空</li>'),a.forEach(l=>{var h;const u=fu(l);k.sessionList.appendChild(u),l.type==="file"&&l.id===r&&((h=s[l.id])==null?void 0:h.length)>0&&s[l.id].forEach(w=>{const g=document.createElement("details");g.className="session-item-details";const C=w.id===O.currentSubsessionId,B=w.children.some(E=>E.id===O.currentSubsessionId);(C||B)&&(g.open=!0);const M=document.createElement("summary");if(M.className=`session-item subsession h1-item ${C?"active":""}`,M.dataset.id=w.id,M.dataset.type="subsession",M.dataset.parent=l.id,M.innerHTML=`
                    <div class="name-container">
                        <span class="name">
                            <i class="fas fa-heading"></i>
                            <span class="item-name">${Ue(w.text)}</span>
                        </span>
                    </div>`,g.appendChild(M),w.children&&w.children.length>0){const E=document.createElement("ul");E.className="nested-items",w.children.forEach($=>{E.appendChild(du($,l.id))}),g.appendChild(E)}k.sessionList.appendChild(g)})})}let st;function Ma(n,e){const t=document.createElement("a");return t.href="#",t.className="breadcrumb-link",t.innerHTML=n,t.addEventListener("click",s=>{s.preventDefault(),e()}),t}function pu(n,e,t){k.currentFolderContainer.innerHTML="";const s=Ma('<i class="fas fa-folder-open"></i> 根目录',t);if(k.currentFolderContainer.appendChild(s),O.folderStack.forEach((r,a)=>{const l=document.createElement("span");l.className="breadcrumb-separator",l.textContent=">",k.currentFolderContainer.appendChild(l);const u=O.folders.find(h=>h.id===r);if(u){const h=Ma(u.name,()=>e(r,a));k.currentFolderContainer.appendChild(h)}}),O.currentFolderId){const r=O.folders.find(a=>a.id===O.currentFolderId);if(r){const a=document.createElement("span");a.className="breadcrumb-separator",a.textContent=">",k.currentFolderContainer.appendChild(a);const l=document.createElement("span");l.className="breadcrumb-current",l.textContent=r.name,k.currentFolderContainer.appendChild(l)}}st.style.display=O.folderStack.length>0?"inline-flex":"none"}function mu(n){st=document.createElement("button"),st.id="backButton",st.className="session-btn",st.title="返回上级目录",st.innerHTML='<i class="fas fa-arrow-left"></i>',st.style.display="none",st.addEventListener("click",n),k.sessionTitleContainer.prepend(st)}async function Ne(){hu(),pu(Lo,Su,_u);const n=kr(),e=n?n.content:"";k.editor.value!==e&&(k.editor.value=e),await Vs()}const Fn=new Map;function yu(n,e){return Fn.has(n)||Fn.set(n,[]),Fn.get(n).push(e),()=>{const t=Fn.get(n);if(t){const s=t.indexOf(e);s>-1&&t.splice(s,1)}}}function gu(n,e){const t=Fn.get(n);t&&t.forEach(s=>{try{s(e)}catch(r){console.error(`Error in event bus callback for event "${n}":`,r)}})}const Un={on:yu,emit:gu};let on=[],qn=-1;function $a(n=null){let t=Object.values(O.clozeStates).filter(s=>s.due<=Date.now());if(n){console.log("Starting custom study with filters:",n);const{currentSessionId:s,currentFolderId:r,sessions:a}=O;let l=t.filter(u=>{const h=n.fileOrFolder;if(h){if(h==="scope_current_file"){if(!s||u.fileId!==s)return!1}else if(h==="scope_current_directory"){if(r===null)return!1;const C=a.find(B=>B.id===u.fileId);if(!C||C.folderId!==r)return!1}else if(h!=="all"){const[C,B]=h.split("_");if(C==="file"){if(u.fileId!==B)return!1}else if(C==="folder"){const M=a.find(E=>E.id===u.fileId);if(!M||M.folderId!==B)return!1}}}if(n.cardStates&&!n.cardStates.includes(u.state))return!1;const m=Date.now(),w=u.lastReview||0,g=(m-w)/(1e3*60*60*24);if(n.lastReview&&n.lastReview!=="any")switch(n.lastReview){case"last7days":if(w===0||g>7)return!1;break;case"last30days":if(w===0||g>30)return!1;break;case"over30days":if(w!==0&&g<=30)return!1;break;case"never":if(w!==0)return!1;break}return!0});l.sort(()=>Math.random()-.5),on=n.maxCards?l.slice(0,n.maxCards):l}else console.log("Starting automatic review."),on=t.sort((s,r)=>s.due-r.due);if(on.length===0){alert("太棒了！当前范围内没有需要复习的卡片。");return}qn=0,Io()}async function Io(){if(qn>=on.length){alert("待办会话结束！"),on=[],qn=-1,Un.emit("ui:setEditPreviewMode","edit"),Ne();return}const n=on[qn];if(O.currentSessionId!==n.fileId){const t=document.getElementById("anki_editor");t&&await mn(t.value),await po(n.fileId),Ne()}Un.emit("ui:setEditPreviewMode","preview"),requestAnimationFrame(()=>{k.editorPreviewPanel.classList.contains("preview-active")||toggleEditPreviewMode(),setTimeout(()=>{document.querySelectorAll(".highlight-review").forEach(s=>s.classList.remove("highlight-review"));const t=document.querySelector(`.cloze[data-cloze-id="${n.id}"]`);if(t){if(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-review"),!t.classList.contains("hidden")){t.classList.add("hidden");const s=t.querySelector(".cloze-actions");s&&(s.style.display="none")}}else console.error("Could not find cloze element for review:",n),vu()},100)})}function vu(){qn++,Io()}function Eo(n){let e=[];const t=O.folders.filter(s=>s.folderId===n);for(const s of t)e.push(s.id),e=e.concat(Eo(s.id));return e}function Co(){k.folderList.innerHTML="";const n=O.movingItems.filter(s=>s.type==="folder").map(s=>s.id),e=new Set(n);n.forEach(s=>{Eo(s).forEach(r=>e.add(r))});const t=document.createElement("div");t.className="folder-item",t.dataset.id="root",t.innerHTML='<i class="fas fa-folder-open"></i> 根目录',k.folderList.appendChild(t),O.folders.forEach(s=>{if(!e.has(s.id)){const r=document.createElement("div");r.className="folder-item",r.dataset.id=s.id,r.innerHTML=`<i class="fas fa-folder"></i> ${Ue(s.name)}`,k.folderList.appendChild(r)}}),k.moveModal.classList.add("active")}function dr(){k.moveModal.classList.remove("active"),re({movingItems:[],selectedMoveTarget:null})}function bu(n){k.closeMoveModalBtn.addEventListener("click",dr),k.cancelMoveBtn.addEventListener("click",dr),k.confirmMoveBtn.addEventListener("click",n),k.folderList.addEventListener("click",e=>{const t=e.target.closest(".folder-item");if(!t)return;k.folderList.querySelectorAll(".folder-item").forEach(r=>r.classList.remove("selected")),t.classList.add("selected");const s=t.dataset.id==="root"?null:t.dataset.id;re({selectedMoveTarget:s})})}function Ao(n="toggle"){var r;const e=k.editorPreviewPanel,t=e.classList.contains("preview-active");let s;n==="toggle"?s=!t:s=n==="preview",s!==t&&(s?k.editor.value!==((r=kr())==null?void 0:r.content)?mn(k.editor.value).then(()=>{Vs().then(()=>{e.classList.add("preview-active"),k.toggleEditPreviewBtn.innerHTML='<i class="fas fa-edit"></i>',k.editModeDot.classList.remove("active"),k.previewModeDot.classList.add("active"),k.printPreviewBtn.disabled=!1,requestAnimationFrame(()=>{const a=k.preview;O.editorScrollRatio!==void 0&&a.scrollHeight>a.clientHeight&&(a.scrollTop=O.editorScrollRatio*(a.scrollHeight-a.clientHeight))})})}):(e.classList.add("preview-active"),k.toggleEditPreviewBtn.innerHTML='<i class="fas fa-edit"></i>',k.editModeDot.classList.remove("active"),k.previewModeDot.classList.add("active"),k.printPreviewBtn.disabled=!1,requestAnimationFrame(()=>{const a=k.preview;O.editorScrollRatio!==void 0&&a.scrollHeight>a.clientHeight&&(a.scrollTop=O.editorScrollRatio*(a.scrollHeight-a.clientHeight))})):(e.classList.remove("preview-active"),k.toggleEditPreviewBtn.innerHTML='<i class="fas fa-book-open"></i> Preview',k.editModeDot.classList.add("active"),k.previewModeDot.classList.remove("active"),k.printPreviewBtn.disabled=!0,requestAnimationFrame(()=>{const a=k.editor;O.editorScrollRatio!==void 0&&a.scrollHeight>a.clientHeight&&(a.scrollTop=O.editorScrollRatio*(a.scrollHeight-a.clientHeight))}),k.editor.focus()))}class wu{constructor(){this.isNavigating=!1}async navigateToSession(e,t={}){if(!this.isNavigating){this.isNavigating=!0;try{if(O.currentSessionId&&O.currentSessionId!==e){const s=document.getElementById("anki_editor");s&&await mn(s.value)}await po(e),await Ne(),await this.waitForDOMStability(),t.switchToPreview!==!1&&Un.emit("ui:setEditPreviewMode","preview")}finally{this.isNavigating=!1}}}async navigateToFolder(e){if(!this.isNavigating){this.isNavigating=!0;try{await Fc(e),await Ne()}finally{this.isNavigating=!1}}}async navigateToSubsession(e,t,s={}){if(!this.isNavigating){this.isNavigating=!0;try{await jc(e,t),await Ne(),await this.waitForDOMStability(),s.switchToPreview!==!1&&Un.emit("ui:setEditPreviewMode","preview")}finally{this.isNavigating=!1}}}waitForDOMStability(){return new Promise(e=>{requestAnimationFrame(()=>{setTimeout(e,50)})})}}const Qi=new wu;let Da=null;const ku=100;let en=-1;function Lo(){Rc(),Ys(),Ne()}function Su(n,e){Kc(n,e),Ys(),Ne()}function _u(){qc(),Ys(),Ne()}function Ys(){en=-1}async function Tu(){const n=prompt("请输入新文件的名称：","新笔记");n!==null&&(await fo(n.trim()),Ne(),k.editor.focus())}async function Iu(){const n=prompt("请输入新目录的名称：","新目录");n!==null&&(await Mc(n.trim()),Ne())}async function Ks(){await mn(k.editor.value)&&(k.saveBtn.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>k.saveBtn.innerHTML='<i class="fas fa-save"></i>',2e3))}function Eu(n,e){const t=Array.from(k.sessionList.querySelectorAll(".select-checkbox")),s=t.indexOf(e);if(n.shiftKey&&en>-1){const l=Math.min(s,en),u=Math.max(s,en);for(let h=l;h<=u;h++)t[h].checked=e.checked}en=s;const r=t.length>0&&t.every(l=>l.checked),a=t.some(l=>l.checked);k.selectAllCheckbox.checked=r,k.selectAllCheckbox.indeterminate=!r&&a}async function Cu(n){const e=n.target.closest(".session-item, .session-item-details summary");if(!e)return;if(n.target.matches(".select-checkbox")){Eu(n,n.target);return}const t=n.target.closest(".actions span");if(t){n.stopPropagation();const{id:l,type:u}=e.closest(".session-item").dataset;if(t.classList.contains("delete-btn"))confirm(`确定删除此 ${u==="file"?"文件":"目录"}?`)&&(await ho([{id:l,type:u}]),Ne());else if(t.classList.contains("edit-btn")){const h=prompt("输入新名称:",e.querySelector(".item-name").textContent);h&&h.trim()&&(await Dc(l,h.trim(),u),Ne())}else t.classList.contains("move-btn")&&(re({movingItems:[{id:l,type:u}]}),Co());return}Ys();const{id:s,type:r,parent:a}=e.dataset;r==="file"?await Qi.navigateToSession(s):r==="folder"?await Qi.navigateToFolder(s):r==="subsession"&&await Qi.navigateToSubsession(a,s)}async function Au(){O.selectedMoveTarget!==void 0&&O.movingItems.length>0&&(await $c(O.movingItems,O.selectedMoveTarget),dr(),Ne())}async function Lu(){const n=Array.from(k.sessionList.querySelectorAll(".select-checkbox:checked")).map(e=>({id:e.dataset.id,type:e.dataset.type}));if(n.length===0)return alert("请先选择要删除的项目。");confirm(`确定要删除选中的 ${n.length} 个项目吗？`)&&(await ho(n),k.selectAllCheckbox.checked=!1,Ne())}function Ft(){clearTimeout(window.previewDebounce),window.previewDebounce=setTimeout(Vs,300),clearTimeout(Da),Da=setTimeout(Gn,500)}async function Ou(n){const e=n.target.files;if(!e||e.length===0)return;const t=s=>new Promise((r,a)=>{const l=new FileReader;l.onload=u=>r({name:s.name,content:u.target.result}),l.onerror=u=>a(u),l.readAsText(s)});try{const s=await Promise.all(Array.from(e).map(t));for(const r of s){const a=r.name,l=a.lastIndexOf("."),u=l>0?a.substring(0,l):a;await fo(u,r.content)}Ne()}catch(s){console.error("读取一个或多个文件时出错:",s),alert("读取文件时发生错误。")}finally{k.fileInput.value=""}}function jn(n,e=n){Gn();const{selectionStart:t,selectionEnd:s,value:r}=k.editor,a=r.substring(t,s),l=`${n}${a}${e}`;k.editor.setRangeText(l,t,s,"select"),Ft(),k.editor.focus()}function Bu(n){Gn();const{selectionStart:e,selectionEnd:t}=k.editor;k.editor.setRangeText(n,e,t,"end"),Ft(),k.editor.focus()}function Nu(){k.editorPreviewPanel.classList.toggle("collapsed");const n=k.editorPreviewPanel.classList.contains("collapsed");k.toggleEditorBtn.innerHTML=n?'<i class="fas fa-chevron-down"></i>':'<i class="fas fa-chevron-up"></i>',k.toggleEditorBtn.title=n?"展开编辑器":"收起编辑器",[k.clozeBtn,k.boldBtn,k.italicBtn,k.codeBtn,k.linkBtn,k.audioBtn,k.insertLinebreakBtn].forEach(e=>e.disabled=n),n&&Ks()}function Pu(){const n=k.editor,e=n.value,t=n.selectionStart,s=/--(?:\s*\[[^\]]*\])?\s*.*?--(?:\^\^audio:.*?\^\^)?/g;let r,a=null;for(;(r=s.exec(e))!==null;){const E=r.index,$=E+r[0].length;if(t>=E&&t<=$){a={content:r[0],start:E,end:$};break}}if(!a){jn("--","--^^audio:TEXT^^");return}const l=/^--(\[\s*[^\]]*\s*\]\s*)?(.*?)--(?:(?:\^){2}audio:(.*)(?:\^){2})?$/,u=a.content.match(l);if(!u)return;const h=u[1]||"",m=u[2]?u[2].trim():"",g=(u[3]?u[3].trim():"")||m,C=prompt("请输入或编辑Cloze的音频提示文本:",g);if(C===null)return;Gn();const B=C.trim();let M=B?`--${h}${m}--^^audio:${B}^^`:`--${h}${m}--`;n.value=e.substring(0,a.start)+M+e.substring(a.end),Ft(),Ks(),n.focus()}function xu(){Gn();const{selectionStart:n,selectionEnd:e,value:t}=k.editor,s=t.substring(n,e),r=`c${Date.now()}`,a=`--[${r}] ${s}--`;k.editor.setRangeText(a,n,e,"end");const l=n+3,u=l+r.length;k.editor.setSelectionRange(l,u),Ft(),k.editor.focus()}function Gn(){const n=k.editor.value;if(O.undoStack[O.undoStack.length-1]===n)return;const t=[...O.undoStack,n];t.length>ku&&t.shift(),re({undoStack:t,redoStack:[]})}function Mu(){if(O.undoStack.length===0)return;const n=[...O.undoStack],e=n.pop(),t=[k.editor.value,...O.redoStack];k.editor.value=e,re({undoStack:n,redoStack:t}),Ft()}function $u(){if(O.redoStack.length===0)return;const n=[...O.redoStack],e=n.shift(),t=[...O.undoStack,k.editor.value];k.editor.value=e,re({undoStack:t,redoStack:n}),Ft()}function Du(){const n=k.preview.innerHTML,e=window.open("","_blank");e.document.write(`
        <!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>打印预览</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="./styles.css">
        <style> @media print { body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .cloze-actions, .media-icon { display: none !important; } .cloze.hidden .cloze-content, .cloze .cloze-content { display: inline !important; visibility: visible !important; color: black !important; } .cloze .placeholder { display: none !important; } .cloze { -webkit-print-color-adjust: exact; print-color-adjust: exact; } } body { font-family: sans-serif; } </style></head><body>
        <div class="preview" style="display: block !important;">${n}</div>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
        <script> window.MathJax = { startup: { pageReady: () => { return window.MathJax.startup.defaultPageReady().then(() => { window.print(); window.close(); }); } } }; <\/script>
        </body></html>
    `),e.document.close()}function Fu(){if(k.editorPreviewPanel.classList.contains("preview-active"))return;const n=k.editor;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);re({editorScrollRatio:Math.min(1,Math.max(0,e))})}}function ju(){if(!k.editorPreviewPanel.classList.contains("preview-active"))return;const n=k.preview;if(n.scrollHeight>n.clientHeight){const e=n.scrollTop/(n.scrollHeight-n.clientHeight);re({editorScrollRatio:e})}}function Ru(){const{sessions:n,folders:e,currentSessionId:t,currentFolderId:s}=O,r=k.filterByFile;if(!r)return;r.innerHTML="";const a=document.createElement("option");a.value="scope_current_file",a.textContent="在当前文件中",t||(a.disabled=!0,a.textContent+=" (无)"),r.appendChild(a);const l=document.createElement("option");l.value="scope_current_directory",l.textContent="在当前目录中",s===null&&(l.disabled=!0,l.textContent+=" (根目录)"),r.appendChild(l);const u=document.createElement("option");u.disabled=!0,u.textContent="──────────",r.appendChild(u),r.innerHTML+='<option value="all">所有文件</option>',e.forEach(h=>{const m=document.createElement("option");m.value=`folder_${h.id}`,m.textContent=`目录: ${h.name}`,r.appendChild(m)}),n.forEach(h=>{const m=document.createElement("option");m.value=`file_${h.id}`,m.textContent=`文件: ${h.name}`,r.appendChild(m)})}function Ku(){k.startReviewBtn&&k.startReviewBtn.addEventListener("click",()=>{let e="all";O.currentSessionId?e="scope_current_file":O.currentFolderId!==null&&(e="scope_current_directory"),$a({fileOrFolder:e})}),k.reviewOptionsBtn&&k.reviewDropdownMenu&&(k.reviewOptionsBtn.addEventListener("click",e=>{e.stopPropagation(),k.reviewDropdownMenu.style.display=k.reviewDropdownMenu.style.display==="block"?"none":"block"}),document.addEventListener("click",e=>{const t=k.reviewOptionsBtn.parentElement;t&&!t.contains(e.target)&&(k.reviewDropdownMenu.style.display="none")})),k.customStudyBtn&&k.customStudyModal&&k.customStudyBtn.addEventListener("click",e=>{e.preventDefault(),k.reviewDropdownMenu&&(k.reviewDropdownMenu.style.display="none"),Ru(),k.customStudyModal.style.display="flex"});const n=()=>{k.customStudyModal&&(k.customStudyModal.style.display="none")};k.customStudyCloseBtn&&k.customStudyCloseBtn.addEventListener("click",n),k.customStudyCancelBtn&&k.customStudyCancelBtn.addEventListener("click",n),k.customStudyForm&&k.customStudyForm.addEventListener("submit",e=>{e.preventDefault();const t=new FormData(e.target),s={fileOrFolder:t.get("anki_filterByFile"),cardStates:t.getAll("cardState"),lastReview:t.get("anki_filterByLastReview"),maxCards:parseInt(t.get("anki_maxCards"),10)};n(),$a(s)})}function qu(){var n,e,t,s,r,a,l;k.newFileBtn.addEventListener("click",Tu),k.newFolderBtn.addEventListener("click",Iu),k.saveBtn.addEventListener("click",Ks),k.sessionList.addEventListener("click",Cu),k.deleteSelectedBtn.addEventListener("click",Lu),k.editor.addEventListener("input",Ft),k.editor.addEventListener("scroll",Fu),k.preview.addEventListener("scroll",ju),k.openFileBtn.addEventListener("click",()=>{var u;return(u=k.fileInput)==null?void 0:u.click()}),(n=k.fileInput)==null||n.addEventListener("change",Ou),k.printPreviewBtn.addEventListener("click",Du),k.moveSelectedBtn.addEventListener("click",()=>{const u=Array.from(k.sessionList.querySelectorAll(".select-checkbox:checked")).map(h=>({id:h.dataset.id,type:h.dataset.type}));u.length>0?(re({movingItems:u}),Co()):alert("请选择要移动的项目。")}),k.selectAllCheckbox.addEventListener("change",u=>{k.sessionList.querySelectorAll(".select-checkbox").forEach(h=>h.checked=u.target.checked),en=-1}),k.toggleSessionBtn.addEventListener("click",()=>{k.sessionSidebar.classList.toggle("hidden-session"),k.toggleSessionBtn.innerHTML=k.sessionSidebar.classList.contains("hidden-session")?'<i class="fas fa-arrow-right"></i>':'<i class="fas fa-arrow-left"></i>'}),k.toggleEditorBtn.addEventListener("click",Nu),k.clozeBtn.addEventListener("click",xu),k.audioBtn.addEventListener("click",Pu),k.boldBtn.addEventListener("click",()=>jn("**")),k.italicBtn.addEventListener("click",()=>jn("*")),k.insertLinebreakBtn.addEventListener("click",()=>Bu("¶")),k.codeBtn.addEventListener("click",()=>jn("`")),k.linkBtn.addEventListener("click",()=>jn("[",`](${prompt("URL:","https://")})`)),k.toggleEditPreviewBtn.addEventListener("click",()=>Ao("toggle")),k.toggleVisibilityClozeBtn.innerHTML='<i class="fas fa-eye-slash"></i>',k.toggleVisibilityClozeBtn.title="全部隐藏",k.invertClozeBtn.innerHTML='<i class="fas fa-random"></i>',k.invertClozeBtn.title="反向显示/隐藏",k.editorPreviewPanel.classList.remove("preview-active"),k.toggleEditPreviewBtn.innerHTML='<i class="fas fa-book-open"></i>',k.toggleEditPreviewBtn.title="切换到预览模式",k.editModeDot.classList.add("active"),k.previewModeDot.classList.remove("active"),k.toggleVisibilityClozeBtn.addEventListener("click",au),k.invertClozeBtn.addEventListener("click",ou),(e=k.playBtn)==null||e.addEventListener("click",tu),(t=k.pauseBtn)==null||t.addEventListener("click",eu),(s=k.stopBtn)==null||s.addEventListener("click",fr),(r=k.clozeNavUpBtn)==null||r.addEventListener("click",()=>Na(-1)),(a=k.clozeNavDownBtn)==null||a.addEventListener("click",()=>Na(1)),k.editor.addEventListener("keydown",u=>{u.ctrlKey&&u.key==="z"?(u.preventDefault(),Mu()):u.ctrlKey&&u.key==="y"?(u.preventDefault(),$u()):u.ctrlKey&&u.key==="s"&&(u.preventDefault(),Ks())}),Ku(),(l=k.showStatsBtn)==null||l.addEventListener("click",u=>{u.preventDefault(),cu(),k.reviewDropdownMenu&&(k.reviewDropdownMenu.style.display="none")}),bu(Au),uu()}function zu(){Un.on("ui:setEditPreviewMode",n=>{Ao(n)})}async function Hu(){console.log("Initializing Anki module..."),await co(),window.mermaid&&mermaid.initialize({startOnLoad:!1,theme:"neutral",securityLevel:"loose"}),mu(Lo),lu(),zu(),await mo(),Ne(),qu(),console.log("✅ Anki module initialized successfully.")}let Uu=class{constructor(){const e=(s,r=document)=>r.querySelector(s),t=s=>document.getElementById(s);this.agentView=t("agent-view"),this.topicsPanel=e(".agent_topics-panel"),this.topicList=t("agent_topicList"),this.toggleTopicsBtn=t("agent_toggleTopicsBtn"),this.topicTagFilter=t("agent_topicTagFilter"),this.editTopicBtn=t("agent_editTopicBtn"),this.manageTopicsBtn=t("agent_manageTopicsBtn"),this.topicsBatchActions=t("agent_topicsBatchActions"),this.selectAllTopicsBtn=t("agent_selectAllTopicsBtn"),this.deleteSelectedTopicsBtn=t("agent_deleteSelectedTopicsBtn"),this.cancelTopicSelectionBtn=t("agent_cancelTopicSelectionBtn"),this.historyPanel=e(".agent_history-panel"),this.historyContent=t("agent_historyContent"),this.historyHeaderTitle=t("agent_historyHeaderTitle"),this.historySearch=t("agent_historySearch"),this.conversationRoleSelector=t("agent_conversationRoleSelector"),this.chatInputArea=t("agent_chatInputArea"),this.chatInput=t("agent_chatInput"),this.sendMessageBtn=t("agent_sendMessageBtn"),this.attachFileBtn=t("agent_attachFileBtn"),this.attachmentInput=t("agent_attachmentInput"),this.attachmentPreviewContainer=t("agent_attachmentPreview"),this.chatNavUp=t("agent_chatNavUp"),this.chatNavDown=t("agent_chatNavDown")}},we;function Vu(n){we=n}let mt=[],$n=[],Xi=-1;async function Yu(n){const e=n.target,t=e.closest(".topic-item");if(!t)return;if(t.classList.contains("add-topic-btn")){if(!O.currentAgentId&&O.agents.length>0&&re({currentAgentId:O.agents[0].id}),!O.currentAgentId){alert("请先在设置中创建一个 Agent 角色。");return}const r=prompt("请输入新主题的名称:");r&&(await Jc(r),$t());return}if(e.closest(".topic-delete-btn")){const r=t.dataset.topicId;confirm(`确定要删除主题 "${t.querySelector("span").textContent}" 吗？`)&&(await yo([r]),$t());return}if(O.isTopicSelectionMode){const r=t.querySelector(".topic-selection-checkbox");r&&(r.checked=!r.checked,r.dispatchEvent(new Event("change",{bubbles:!0})));return}const s=t.dataset.topicId;if(s&&s!==O.currentTopicId){if(O.currentTopicId){const r=we.historyContent.scrollTop,a={...O.topicScrollPositions||{},[O.currentTopicId]:r};re({topicScrollPositions:a})}vo(s),$t()}}async function Ju(n){var r,a,l;if(O.isAiThinking){alert("AI 正在思考中，请稍后再试。");return}const e=n.target.closest(".history-action-btn");if(!e)return;const s=e.closest(".history-item").dataset.messageId;if(e.classList.contains("delete-btn")){if(confirm("确定要删除这组对话吗？")){let u=[s];const h=e.closest(".history-item");h.classList.contains("role-user")&&((r=h.nextElementSibling)!=null&&r.classList.contains("role-assistant"))?u.push(h.nextElementSibling.dataset.messageId):h.classList.contains("role-assistant")&&((a=h.previousElementSibling)!=null&&a.classList.contains("role-user"))&&u.push(h.previousElementSibling.dataset.messageId),await Wc(u),await fn()}}else if(e.classList.contains("edit-btn")){const u=((l=O.history.find(m=>m.id===s))==null?void 0:l.content)||"",h=prompt("编辑你的消息:",u);h&&h!==u&&confirm("编辑将删除此后的对话并重新生成回应，是否继续？")&&await Qc(s,h)}else e.classList.contains("regenerate-btn")&&confirm("确定要重新生成这条回应吗？")&&await(void 0)(s)}function Gu(n){re({topicListFilterTag:n.target.value}),Nt();const e=bo();if(!e.some(s=>s.id===O.currentTopicId)){const s=e.length>0?e[0].id:null;s?vo(s):re({currentTopicId:null}),$t()}}function Wu(n){O.currentTopicId&&(re({currentConversationAgentId:n.target.value||null}),fn())}async function Qu(){if(!O.currentTopicId)return;const n=O.topics.find(t=>t.id===O.currentTopicId),e=prompt("请输入新的主题名称:",n.title);e&&e.trim()!==n.title&&(await Gc(O.currentTopicId,{title:e.trim()}),Nt())}async function Fa(){const n=we.chatInput.value.trim();!n&&mt.length===0||O.isAiThinking||(await go(n,[...mt]),we.chatInput.value="",mt=[],wr([]),we.chatInput.focus())}function Xu(n){mt=[],Array.from(n.target.files).forEach(e=>{const t=new FileReader;t.onload=s=>{mt.push({name:e.name,data:s.target.result}),wr(mt)},t.readAsDataURL(e)}),n.target.value=""}function Zu(n){const e=n.target.closest(".remove-attachment-btn");e&&(mt.splice(parseInt(e.dataset.index,10),1),wr(mt))}function ef(){we.chatNavUp.addEventListener("click",()=>ja(-1)),we.chatNavDown.addEventListener("click",()=>ja(1))}function ja(n){if($n=Array.from(we.historyContent.querySelectorAll(".history-item.role-user")),$n.length===0)return;document.querySelectorAll(".history-item.highlighted").forEach(t=>t.classList.remove("highlighted")),Xi=(Xi+n+$n.length)%$n.length;const e=$n[Xi];if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlighted");const t=e.nextElementSibling;t&&t.classList.contains("history-item")&&t.classList.add("highlighted")}}function tf(){re({isTopicsPanelHidden:!O.isTopicsPanelHidden}),$t()}function nf(){we.topicList.addEventListener("click",Yu),we.historyContent.addEventListener("click",Ju),we.topicTagFilter.addEventListener("change",Gu),we.conversationRoleSelector.addEventListener("change",Wu),we.editTopicBtn.addEventListener("click",Qu),we.toggleTopicsBtn.addEventListener("click",tf),we.manageTopicsBtn.addEventListener("click",()=>{re({isTopicSelectionMode:!0,selectedTopicIds:[]}),Nt()}),we.cancelTopicSelectionBtn.addEventListener("click",()=>{re({isTopicSelectionMode:!1,selectedTopicIds:[]}),Nt()}),we.selectAllTopicsBtn.addEventListener("click",()=>{const n=O.topics.map(t=>t.id),e=O.selectedTopicIds.length===n.length?[]:n;re({selectedTopicIds:e}),Nt()}),we.deleteSelectedTopicsBtn.addEventListener("click",async()=>{const n=O.selectedTopicIds.length;n>0&&confirm(`确定要删除选中的 ${n} 个主题吗？`)&&(await yo(O.selectedTopicIds),$t())}),we.topicList.addEventListener("change",n=>{if(n.target.classList.contains("topic-selection-checkbox")){const e=n.target.dataset.topicId,t=new Set(O.selectedTopicIds);n.target.checked?t.add(e):t.delete(e),re({selectedTopicIds:Array.from(t)}),Nt()}}),we.sendMessageBtn.addEventListener("click",Fa),we.chatInput.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),Fa())}),we.attachFileBtn.addEventListener("click",()=>we.attachmentInput.click()),we.attachmentInput.addEventListener("change",Xu),we.attachmentPreviewContainer.addEventListener("click",Zu),ef()}async function sf(){console.log("Initializing AI Agent module UI...");const n=new Uu;Cc(n),Vu(n),$t(),nf()}const Tr=Symbol.for("yaml.alias"),hr=Symbol.for("yaml.document"),yt=Symbol.for("yaml.map"),Oo=Symbol.for("yaml.pair"),Xe=Symbol.for("yaml.scalar"),yn=Symbol.for("yaml.seq"),qe=Symbol.for("yaml.node.type"),bt=n=>!!n&&typeof n=="object"&&n[qe]===Tr,jt=n=>!!n&&typeof n=="object"&&n[qe]===hr,gn=n=>!!n&&typeof n=="object"&&n[qe]===yt,Se=n=>!!n&&typeof n=="object"&&n[qe]===Oo,ye=n=>!!n&&typeof n=="object"&&n[qe]===Xe,vn=n=>!!n&&typeof n=="object"&&n[qe]===yn;function _e(n){if(n&&typeof n=="object")switch(n[qe]){case yt:case yn:return!0}return!1}function Te(n){if(n&&typeof n=="object")switch(n[qe]){case Tr:case yt:case Xe:case yn:return!0}return!1}const Bo=n=>(ye(n)||_e(n))&&!!n.anchor,$e=Symbol("break visit"),No=Symbol("skip children"),Qe=Symbol("remove node");function Rt(n,e){const t=Po(e);jt(n)?tn(null,n.contents,t,Object.freeze([n]))===Qe&&(n.contents=null):tn(null,n,t,Object.freeze([]))}Rt.BREAK=$e;Rt.SKIP=No;Rt.REMOVE=Qe;function tn(n,e,t,s){const r=xo(n,e,t,s);if(Te(r)||Se(r))return Mo(n,s,r),tn(n,r,t,s);if(typeof r!="symbol"){if(_e(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const l=tn(a,e.items[a],t,s);if(typeof l=="number")a=l-1;else{if(l===$e)return $e;l===Qe&&(e.items.splice(a,1),a-=1)}}}else if(Se(e)){s=Object.freeze(s.concat(e));const a=tn("key",e.key,t,s);if(a===$e)return $e;a===Qe&&(e.key=null);const l=tn("value",e.value,t,s);if(l===$e)return $e;l===Qe&&(e.value=null)}}return r}async function Js(n,e){const t=Po(e);jt(n)?await nn(null,n.contents,t,Object.freeze([n]))===Qe&&(n.contents=null):await nn(null,n,t,Object.freeze([]))}Js.BREAK=$e;Js.SKIP=No;Js.REMOVE=Qe;async function nn(n,e,t,s){const r=await xo(n,e,t,s);if(Te(r)||Se(r))return Mo(n,s,r),nn(n,r,t,s);if(typeof r!="symbol"){if(_e(e)){s=Object.freeze(s.concat(e));for(let a=0;a<e.items.length;++a){const l=await nn(a,e.items[a],t,s);if(typeof l=="number")a=l-1;else{if(l===$e)return $e;l===Qe&&(e.items.splice(a,1),a-=1)}}}else if(Se(e)){s=Object.freeze(s.concat(e));const a=await nn("key",e.key,t,s);if(a===$e)return $e;a===Qe&&(e.key=null);const l=await nn("value",e.value,t,s);if(l===$e)return $e;l===Qe&&(e.value=null)}}return r}function Po(n){return typeof n=="object"&&(n.Collection||n.Node||n.Value)?Object.assign({Alias:n.Node,Map:n.Node,Scalar:n.Node,Seq:n.Node},n.Value&&{Map:n.Value,Scalar:n.Value,Seq:n.Value},n.Collection&&{Map:n.Collection,Seq:n.Collection},n):n}function xo(n,e,t,s){var r,a,l,u,h;if(typeof t=="function")return t(n,e,s);if(gn(e))return(r=t.Map)==null?void 0:r.call(t,n,e,s);if(vn(e))return(a=t.Seq)==null?void 0:a.call(t,n,e,s);if(Se(e))return(l=t.Pair)==null?void 0:l.call(t,n,e,s);if(ye(e))return(u=t.Scalar)==null?void 0:u.call(t,n,e,s);if(bt(e))return(h=t.Alias)==null?void 0:h.call(t,n,e,s)}function Mo(n,e,t){const s=e[e.length-1];if(_e(s))s.items[n]=t;else if(Se(s))n==="key"?s.key=t:s.value=t;else if(jt(s))s.contents=t;else{const r=bt(s)?"alias":"scalar";throw new Error(`Cannot replace node with ${r} parent`)}}const rf={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},af=n=>n.replace(/[!,[\]{}]/g,e=>rf[e]);class Me{constructor(e,t){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Me.defaultYaml,e),this.tags=Object.assign({},Me.defaultTags,t)}clone(){const e=new Me(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){const e=new Me(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Me.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Me.defaultTags);break}return e}add(e,t){this.atNextDocument&&(this.yaml={explicit:Me.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Me.defaultTags),this.atNextDocument=!1);const s=e.trim().split(/[ \t]+/),r=s.shift();switch(r){case"%TAG":{if(s.length!==2&&(t(0,"%TAG directive should contain exactly two parts"),s.length<2))return!1;const[a,l]=s;return this.tags[a]=l,!0}case"%YAML":{if(this.yaml.explicit=!0,s.length!==1)return t(0,"%YAML directive should contain exactly one part"),!1;const[a]=s;if(a==="1.1"||a==="1.2")return this.yaml.version=a,!0;{const l=/^\d+\.\d+$/.test(a);return t(6,`Unsupported YAML version ${a}`,l),!1}}default:return t(0,`Unknown directive ${r}`,!0),!1}}tagName(e,t){if(e==="!")return"!";if(e[0]!=="!")return t(`Not a valid tag: ${e}`),null;if(e[1]==="<"){const l=e.slice(2,-1);return l==="!"||l==="!!"?(t(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(e[e.length-1]!==">"&&t("Verbatim tags must end with a >"),l)}const[,s,r]=e.match(/^(.*!)([^!]*)$/s);r||t(`The ${e} tag has no suffix`);const a=this.tags[s];if(a)try{return a+decodeURIComponent(r)}catch(l){return t(String(l)),null}return s==="!"?e:(t(`Could not resolve tag: ${e}`),null)}tagString(e){for(const[t,s]of Object.entries(this.tags))if(e.startsWith(s))return t+af(e.substring(s.length));return e[0]==="!"?e:`!<${e}>`}toString(e){const t=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],s=Object.entries(this.tags);let r;if(e&&s.length>0&&Te(e.contents)){const a={};Rt(e.contents,(l,u)=>{Te(u)&&u.tag&&(a[u.tag]=!0)}),r=Object.keys(a)}else r=[];for(const[a,l]of s)a==="!!"&&l==="tag:yaml.org,2002:"||(!e||r.some(u=>u.startsWith(l)))&&t.push(`%TAG ${a} ${l}`);return t.join(`
`)}}Me.defaultYaml={explicit:!1,version:"1.2"};Me.defaultTags={"!!":"tag:yaml.org,2002:"};function $o(n){if(/[\x00-\x19\s,[\]{}]/.test(n)){const t=`Anchor must not contain whitespace or control characters: ${JSON.stringify(n)}`;throw new Error(t)}return!0}function Do(n){const e=new Set;return Rt(n,{Value(t,s){s.anchor&&e.add(s.anchor)}}),e}function Fo(n,e){for(let t=1;;++t){const s=`${n}${t}`;if(!e.has(s))return s}}function of(n,e){const t=[],s=new Map;let r=null;return{onAnchor:a=>{t.push(a),r??(r=Do(n));const l=Fo(e,r);return r.add(l),l},setAnchors:()=>{for(const a of t){const l=s.get(a);if(typeof l=="object"&&l.anchor&&(ye(l.node)||_e(l.node)))l.node.anchor=l.anchor;else{const u=new Error("Failed to resolve repeated object (this should not happen)");throw u.source=a,u}}},sourceObjects:s}}function sn(n,e,t,s){if(s&&typeof s=="object")if(Array.isArray(s))for(let r=0,a=s.length;r<a;++r){const l=s[r],u=sn(n,s,String(r),l);u===void 0?delete s[r]:u!==l&&(s[r]=u)}else if(s instanceof Map)for(const r of Array.from(s.keys())){const a=s.get(r),l=sn(n,s,r,a);l===void 0?s.delete(r):l!==a&&s.set(r,l)}else if(s instanceof Set)for(const r of Array.from(s)){const a=sn(n,s,r,r);a===void 0?s.delete(r):a!==r&&(s.delete(r),s.add(a))}else for(const[r,a]of Object.entries(s)){const l=sn(n,s,r,a);l===void 0?delete s[r]:l!==a&&(s[r]=l)}return n.call(e,t,s)}function Ke(n,e,t){if(Array.isArray(n))return n.map((s,r)=>Ke(s,String(r),t));if(n&&typeof n.toJSON=="function"){if(!t||!Bo(n))return n.toJSON(e,t);const s={aliasCount:0,count:1,res:void 0};t.anchors.set(n,s),t.onCreate=a=>{s.res=a,delete t.onCreate};const r=n.toJSON(e,t);return t.onCreate&&t.onCreate(r),r}return typeof n=="bigint"&&!(t!=null&&t.keep)?Number(n):n}class Ir{constructor(e){Object.defineProperty(this,qe,{value:e})}clone(){const e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:t,maxAliasCount:s,onAnchor:r,reviver:a}={}){if(!jt(e))throw new TypeError("A document argument is required");const l={anchors:new Map,doc:e,keep:!0,mapAsMap:t===!0,mapKeyWarned:!1,maxAliasCount:typeof s=="number"?s:100},u=Ke(this,"",l);if(typeof r=="function")for(const{count:h,res:m}of l.anchors.values())r(m,h);return typeof a=="function"?sn(a,{"":u},"",u):u}}class Gs extends Ir{constructor(e){super(Tr),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e,t){let s;t!=null&&t.aliasResolveCache?s=t.aliasResolveCache:(s=[],Rt(e,{Node:(a,l)=>{(bt(l)||Bo(l))&&s.push(l)}}),t&&(t.aliasResolveCache=s));let r;for(const a of s){if(a===this)break;a.anchor===this.source&&(r=a)}return r}toJSON(e,t){if(!t)return{source:this.source};const{anchors:s,doc:r,maxAliasCount:a}=t,l=this.resolve(r,t);if(!l){const h=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(h)}let u=s.get(l);if(u||(Ke(l,null,t),u=s.get(l)),!u||u.res===void 0){const h="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(h)}if(a>=0&&(u.count+=1,u.aliasCount===0&&(u.aliasCount=Ms(r,l,s)),u.count*u.aliasCount>a)){const h="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(h)}return u.res}toString(e,t,s){const r=`*${this.source}`;if(e){if($o(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){const a=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(a)}if(e.implicitKey)return`${r} `}return r}}function Ms(n,e,t){if(bt(e)){const s=e.resolve(n),r=t&&s&&t.get(s);return r?r.count*r.aliasCount:0}else if(_e(e)){let s=0;for(const r of e.items){const a=Ms(n,r,t);a>s&&(s=a)}return s}else if(Se(e)){const s=Ms(n,e.key,t),r=Ms(n,e.value,t);return Math.max(s,r)}return 1}const jo=n=>!n||typeof n!="function"&&typeof n!="object";class oe extends Ir{constructor(e){super(Xe),this.value=e}toJSON(e,t){return t!=null&&t.keep?this.value:Ke(this.value,e,t)}toString(){return String(this.value)}}oe.BLOCK_FOLDED="BLOCK_FOLDED";oe.BLOCK_LITERAL="BLOCK_LITERAL";oe.PLAIN="PLAIN";oe.QUOTE_DOUBLE="QUOTE_DOUBLE";oe.QUOTE_SINGLE="QUOTE_SINGLE";const lf="tag:yaml.org,2002:";function cf(n,e,t){if(e){const s=t.filter(a=>a.tag===e),r=s.find(a=>!a.format)??s[0];if(!r)throw new Error(`Tag ${e} not found`);return r}return t.find(s=>{var r;return((r=s.identify)==null?void 0:r.call(s,n))&&!s.format})}function Vn(n,e,t){var g,C,B;if(jt(n)&&(n=n.contents),Te(n))return n;if(Se(n)){const M=(C=(g=t.schema[yt]).createNode)==null?void 0:C.call(g,t.schema,null,t);return M.items.push(n),M}(n instanceof String||n instanceof Number||n instanceof Boolean||typeof BigInt<"u"&&n instanceof BigInt)&&(n=n.valueOf());const{aliasDuplicateObjects:s,onAnchor:r,onTagObj:a,schema:l,sourceObjects:u}=t;let h;if(s&&n&&typeof n=="object"){if(h=u.get(n),h)return h.anchor??(h.anchor=r(n)),new Gs(h.anchor);h={anchor:null,node:null},u.set(n,h)}e!=null&&e.startsWith("!!")&&(e=lf+e.slice(2));let m=cf(n,e,l.tags);if(!m){if(n&&typeof n.toJSON=="function"&&(n=n.toJSON()),!n||typeof n!="object"){const M=new oe(n);return h&&(h.node=M),M}m=n instanceof Map?l[yt]:Symbol.iterator in Object(n)?l[yn]:l[yt]}a&&(a(m),delete t.onTagObj);const w=m!=null&&m.createNode?m.createNode(t.schema,n,t):typeof((B=m==null?void 0:m.nodeClass)==null?void 0:B.from)=="function"?m.nodeClass.from(t.schema,n,t):new oe(n);return e?w.tag=e:m.default||(w.tag=m.tag),h&&(h.node=w),w}function qs(n,e,t){let s=t;for(let r=e.length-1;r>=0;--r){const a=e[r];if(typeof a=="number"&&Number.isInteger(a)&&a>=0){const l=[];l[a]=s,s=l}else s=new Map([[a,s]])}return Vn(s,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:n,sourceObjects:new Map})}const Rn=n=>n==null||typeof n=="object"&&!!n[Symbol.iterator]().next().done;class Ro extends Ir{constructor(e,t){super(e),Object.defineProperty(this,"schema",{value:t,configurable:!0,enumerable:!1,writable:!0})}clone(e){const t=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(t.schema=e),t.items=t.items.map(s=>Te(s)||Se(s)?s.clone(e):s),this.range&&(t.range=this.range.slice()),t}addIn(e,t){if(Rn(e))this.add(t);else{const[s,...r]=e,a=this.get(s,!0);if(_e(a))a.addIn(r,t);else if(a===void 0&&this.schema)this.set(s,qs(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}deleteIn(e){const[t,...s]=e;if(s.length===0)return this.delete(t);const r=this.get(t,!0);if(_e(r))return r.deleteIn(s);throw new Error(`Expected YAML collection at ${t}. Remaining path: ${s}`)}getIn(e,t){const[s,...r]=e,a=this.get(s,!0);return r.length===0?!t&&ye(a)?a.value:a:_e(a)?a.getIn(r,t):void 0}hasAllNullValues(e){return this.items.every(t=>{if(!Se(t))return!1;const s=t.value;return s==null||e&&ye(s)&&s.value==null&&!s.commentBefore&&!s.comment&&!s.tag})}hasIn(e){const[t,...s]=e;if(s.length===0)return this.has(t);const r=this.get(t,!0);return _e(r)?r.hasIn(s):!1}setIn(e,t){const[s,...r]=e;if(r.length===0)this.set(s,t);else{const a=this.get(s,!0);if(_e(a))a.setIn(r,t);else if(a===void 0&&this.schema)this.set(s,qs(this.schema,r,t));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${r}`)}}}const uf=n=>n.replace(/^(?!$)(?: $)?/gm,"#");function it(n,e){return/^\n+$/.test(n)?n.substring(1):e?n.replace(/^(?! *$)/gm,e):n}const Pt=(n,e,t)=>n.endsWith(`
`)?it(t,e):t.includes(`
`)?`
`+it(t,e):(n.endsWith(" ")?"":" ")+t,Ko="flow",pr="block",$s="quoted";function Ws(n,e,t="flow",{indentAtStart:s,lineWidth:r=80,minContentWidth:a=20,onFold:l,onOverflow:u}={}){if(!r||r<0)return n;r<a&&(a=0);const h=Math.max(1+a,1+r-e.length);if(n.length<=h)return n;const m=[],w={};let g=r-e.length;typeof s=="number"&&(s>r-Math.max(2,a)?m.push(0):g=r-s);let C,B,M=!1,E=-1,$=-1,Y=-1;t===pr&&(E=Ra(n,E,e.length),E!==-1&&(g=E+h));for(let Z;Z=n[E+=1];){if(t===$s&&Z==="\\"){switch($=E,n[E+1]){case"x":E+=3;break;case"u":E+=5;break;case"U":E+=9;break;default:E+=1}Y=E}if(Z===`
`)t===pr&&(E=Ra(n,E,e.length)),g=E+e.length+h,C=void 0;else{if(Z===" "&&B&&B!==" "&&B!==`
`&&B!=="	"){const X=n[E+1];X&&X!==" "&&X!==`
`&&X!=="	"&&(C=E)}if(E>=g)if(C)m.push(C),g=C+h,C=void 0;else if(t===$s){for(;B===" "||B==="	";)B=Z,Z=n[E+=1],M=!0;const X=E>Y+1?E-2:$-1;if(w[X])return n;m.push(X),w[X]=!0,g=X+h,C=void 0}else M=!0}B=Z}if(M&&u&&u(),m.length===0)return n;l&&l();let G=n.slice(0,m[0]);for(let Z=0;Z<m.length;++Z){const X=m[Z],te=m[Z+1]||n.length;X===0?G=`
${e}${n.slice(0,te)}`:(t===$s&&w[X]&&(G+=`${n[X]}\\`),G+=`
${e}${n.slice(X+1,te)}`)}return G}function Ra(n,e,t){let s=e,r=e+1,a=n[r];for(;a===" "||a==="	";)if(e<r+t)a=n[++e];else{do a=n[++e];while(a&&a!==`
`);s=e,r=e+1,a=n[r]}return s}const Qs=(n,e)=>({indentAtStart:e?n.indent.length:n.indentAtStart,lineWidth:n.options.lineWidth,minContentWidth:n.options.minContentWidth}),Xs=n=>/^(%|---|\.\.\.)/m.test(n);function ff(n,e,t){if(!e||e<0)return!1;const s=e-t,r=n.length;if(r<=s)return!1;for(let a=0,l=0;a<r;++a)if(n[a]===`
`){if(a-l>s)return!0;if(l=a+1,r-l<=s)return!1}return!0}function zn(n,e){const t=JSON.stringify(n);if(e.options.doubleQuotedAsJSON)return t;const{implicitKey:s}=e,r=e.options.doubleQuotedMinMultiLineLength,a=e.indent||(Xs(n)?"  ":"");let l="",u=0;for(let h=0,m=t[h];m;m=t[++h])if(m===" "&&t[h+1]==="\\"&&t[h+2]==="n"&&(l+=t.slice(u,h)+"\\ ",h+=1,u=h,m="\\"),m==="\\")switch(t[h+1]){case"u":{l+=t.slice(u,h);const w=t.substr(h+2,4);switch(w){case"0000":l+="\\0";break;case"0007":l+="\\a";break;case"000b":l+="\\v";break;case"001b":l+="\\e";break;case"0085":l+="\\N";break;case"00a0":l+="\\_";break;case"2028":l+="\\L";break;case"2029":l+="\\P";break;default:w.substr(0,2)==="00"?l+="\\x"+w.substr(2):l+=t.substr(h,6)}h+=5,u=h+1}break;case"n":if(s||t[h+2]==='"'||t.length<r)h+=1;else{for(l+=t.slice(u,h)+`

`;t[h+2]==="\\"&&t[h+3]==="n"&&t[h+4]!=='"';)l+=`
`,h+=2;l+=a,t[h+2]===" "&&(l+="\\"),h+=1,u=h+1}break;default:h+=1}return l=u?l+t.slice(u):t,s?l:Ws(l,a,$s,Qs(e,!1))}function mr(n,e){if(e.options.singleQuote===!1||e.implicitKey&&n.includes(`
`)||/[ \t]\n|\n[ \t]/.test(n))return zn(n,e);const t=e.indent||(Xs(n)?"  ":""),s="'"+n.replace(/'/g,"''").replace(/\n+/g,`$&
${t}`)+"'";return e.implicitKey?s:Ws(s,t,Ko,Qs(e,!1))}function rn(n,e){const{singleQuote:t}=e.options;let s;if(t===!1)s=zn;else{const r=n.includes('"'),a=n.includes("'");r&&!a?s=mr:a&&!r?s=zn:s=t?mr:zn}return s(n,e)}let yr;try{yr=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{yr=/\n+(?!\n|$)/g}function Ds({comment:n,type:e,value:t},s,r,a){const{blockQuote:l,commentString:u,lineWidth:h}=s.options;if(!l||/\n[\t ]+$/.test(t)||/^\s*$/.test(t))return rn(t,s);const m=s.indent||(s.forceBlockIndent||Xs(t)?"  ":""),w=l==="literal"?!0:l==="folded"||e===oe.BLOCK_FOLDED?!1:e===oe.BLOCK_LITERAL?!0:!ff(t,h,m.length);if(!t)return w?`|
`:`>
`;let g,C;for(C=t.length;C>0;--C){const te=t[C-1];if(te!==`
`&&te!=="	"&&te!==" ")break}let B=t.substring(C);const M=B.indexOf(`
`);M===-1?g="-":t===B||M!==B.length-1?(g="+",a&&a()):g="",B&&(t=t.slice(0,-B.length),B[B.length-1]===`
`&&(B=B.slice(0,-1)),B=B.replace(yr,`$&${m}`));let E=!1,$,Y=-1;for($=0;$<t.length;++$){const te=t[$];if(te===" ")E=!0;else if(te===`
`)Y=$;else break}let G=t.substring(0,Y<$?Y+1:$);G&&(t=t.substring(G.length),G=G.replace(/\n+/g,`$&${m}`));let X=(E?m?"2":"1":"")+g;if(n&&(X+=" "+u(n.replace(/ ?[\r\n]+/g," ")),r&&r()),!w){const te=t.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${m}`);let ne=!1;const ce=Qs(s,!0);l!=="folded"&&e!==oe.BLOCK_FOLDED&&(ce.onOverflow=()=>{ne=!0});const Q=Ws(`${G}${te}${B}`,m,pr,ce);if(!ne)return`>${X}
${m}${Q}`}return t=t.replace(/\n+/g,`$&${m}`),`|${X}
${m}${G}${t}${B}`}function df(n,e,t,s){const{type:r,value:a}=n,{actualString:l,implicitKey:u,indent:h,indentStep:m,inFlow:w}=e;if(u&&a.includes(`
`)||w&&/[[\]{},]/.test(a))return rn(a,e);if(/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(a))return u||w||!a.includes(`
`)?rn(a,e):Ds(n,e,t,s);if(!u&&!w&&r!==oe.PLAIN&&a.includes(`
`))return Ds(n,e,t,s);if(Xs(a)){if(h==="")return e.forceBlockIndent=!0,Ds(n,e,t,s);if(u&&h===m)return rn(a,e)}const g=a.replace(/\n+/g,`$&
${h}`);if(l){const C=E=>{var $;return E.default&&E.tag!=="tag:yaml.org,2002:str"&&(($=E.test)==null?void 0:$.test(g))},{compat:B,tags:M}=e.doc.schema;if(M.some(C)||B!=null&&B.some(C))return rn(a,e)}return u?g:Ws(g,h,Ko,Qs(e,!1))}function Wn(n,e,t,s){const{implicitKey:r,inFlow:a}=e,l=typeof n.value=="string"?n:Object.assign({},n,{value:String(n.value)});let{type:u}=n;u!==oe.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(l.value)&&(u=oe.QUOTE_DOUBLE);const h=w=>{switch(w){case oe.BLOCK_FOLDED:case oe.BLOCK_LITERAL:return r||a?rn(l.value,e):Ds(l,e,t,s);case oe.QUOTE_DOUBLE:return zn(l.value,e);case oe.QUOTE_SINGLE:return mr(l.value,e);case oe.PLAIN:return df(l,e,t,s);default:return null}};let m=h(u);if(m===null){const{defaultKeyType:w,defaultStringType:g}=e.options,C=r&&w||g;if(m=h(C),m===null)throw new Error(`Unsupported default string type ${C}`)}return m}function qo(n,e){const t=Object.assign({blockQuote:!0,commentString:uf,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},n.schema.toStringOptions,e);let s;switch(t.collectionStyle){case"block":s=!1;break;case"flow":s=!0;break;default:s=null}return{anchors:new Set,doc:n,flowCollectionPadding:t.flowCollectionPadding?" ":"",indent:"",indentStep:typeof t.indent=="number"?" ".repeat(t.indent):"  ",inFlow:s,options:t}}function hf(n,e){var r;if(e.tag){const a=n.filter(l=>l.tag===e.tag);if(a.length>0)return a.find(l=>l.format===e.format)??a[0]}let t,s;if(ye(e)){s=e.value;let a=n.filter(l=>{var u;return(u=l.identify)==null?void 0:u.call(l,s)});if(a.length>1){const l=a.filter(u=>u.test);l.length>0&&(a=l)}t=a.find(l=>l.format===e.format)??a.find(l=>!l.format)}else s=e,t=n.find(a=>a.nodeClass&&s instanceof a.nodeClass);if(!t){const a=((r=s==null?void 0:s.constructor)==null?void 0:r.name)??(s===null?"null":typeof s);throw new Error(`Tag not resolved for ${a} value`)}return t}function pf(n,e,{anchors:t,doc:s}){if(!s.directives)return"";const r=[],a=(ye(n)||_e(n))&&n.anchor;a&&$o(a)&&(t.add(a),r.push(`&${a}`));const l=n.tag??(e.default?null:e.tag);return l&&r.push(s.directives.tagString(l)),r.join(" ")}function dn(n,e,t,s){var h;if(Se(n))return n.toString(e,t,s);if(bt(n)){if(e.doc.directives)return n.toString(e);if((h=e.resolvedAliases)!=null&&h.has(n))throw new TypeError("Cannot stringify circular structure without alias nodes");e.resolvedAliases?e.resolvedAliases.add(n):e.resolvedAliases=new Set([n]),n=n.resolve(e.doc)}let r;const a=Te(n)?n:e.doc.createNode(n,{onTagObj:m=>r=m});r??(r=hf(e.doc.schema.tags,a));const l=pf(a,r,e);l.length>0&&(e.indentAtStart=(e.indentAtStart??0)+l.length+1);const u=typeof r.stringify=="function"?r.stringify(a,e,t,s):ye(a)?Wn(a,e,t,s):a.toString(e,t,s);return l?ye(a)||u[0]==="{"||u[0]==="["?`${l} ${u}`:`${l}
${e.indent}${u}`:u}function mf({key:n,value:e},t,s,r){const{allNullValues:a,doc:l,indent:u,indentStep:h,options:{commentString:m,indentSeq:w,simpleKeys:g}}=t;let C=Te(n)&&n.comment||null;if(g){if(C)throw new Error("With simple keys, key nodes cannot have comments");if(_e(n)||!Te(n)&&typeof n=="object"){const ce="With simple keys, collection cannot be used as a key value";throw new Error(ce)}}let B=!g&&(!n||C&&e==null&&!t.inFlow||_e(n)||(ye(n)?n.type===oe.BLOCK_FOLDED||n.type===oe.BLOCK_LITERAL:typeof n=="object"));t=Object.assign({},t,{allNullValues:!1,implicitKey:!B&&(g||!a),indent:u+h});let M=!1,E=!1,$=dn(n,t,()=>M=!0,()=>E=!0);if(!B&&!t.inFlow&&$.length>1024){if(g)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");B=!0}if(t.inFlow){if(a||e==null)return M&&s&&s(),$===""?"?":B?`? ${$}`:$}else if(a&&!g||e==null&&B)return $=`? ${$}`,C&&!M?$+=Pt($,t.indent,m(C)):E&&r&&r(),$;M&&(C=null),B?(C&&($+=Pt($,t.indent,m(C))),$=`? ${$}
${u}:`):($=`${$}:`,C&&($+=Pt($,t.indent,m(C))));let Y,G,Z;Te(e)?(Y=!!e.spaceBefore,G=e.commentBefore,Z=e.comment):(Y=!1,G=null,Z=null,e&&typeof e=="object"&&(e=l.createNode(e))),t.implicitKey=!1,!B&&!C&&ye(e)&&(t.indentAtStart=$.length+1),E=!1,!w&&h.length>=2&&!t.inFlow&&!B&&vn(e)&&!e.flow&&!e.tag&&!e.anchor&&(t.indent=t.indent.substring(2));let X=!1;const te=dn(e,t,()=>X=!0,()=>E=!0);let ne=" ";if(C||Y||G){if(ne=Y?`
`:"",G){const ce=m(G);ne+=`
${it(ce,t.indent)}`}te===""&&!t.inFlow?ne===`
`&&(ne=`

`):ne+=`
${t.indent}`}else if(!B&&_e(e)){const ce=te[0],Q=te.indexOf(`
`),ge=Q!==-1,ze=t.inFlow??e.flow??e.items.length===0;if(ge||!ze){let Ze=!1;if(ge&&(ce==="&"||ce==="!")){let ve=te.indexOf(" ");ce==="&"&&ve!==-1&&ve<Q&&te[ve+1]==="!"&&(ve=te.indexOf(" ",ve+1)),(ve===-1||Q<ve)&&(Ze=!0)}Ze||(ne=`
${t.indent}`)}}else(te===""||te[0]===`
`)&&(ne="");return $+=ne+te,t.inFlow?X&&s&&s():Z&&!X?$+=Pt($,t.indent,m(Z)):E&&r&&r(),$}function zo(n,e){(n==="debug"||n==="warn")&&console.warn(e)}const As="<<",rt={identify:n=>n===As||typeof n=="symbol"&&n.description===As,default:"key",tag:"tag:yaml.org,2002:merge",test:/^<<$/,resolve:()=>Object.assign(new oe(Symbol(As)),{addToJSMap:Ho}),stringify:()=>As},yf=(n,e)=>(rt.identify(e)||ye(e)&&(!e.type||e.type===oe.PLAIN)&&rt.identify(e.value))&&(n==null?void 0:n.doc.schema.tags.some(t=>t.tag===rt.tag&&t.default));function Ho(n,e,t){if(t=n&&bt(t)?t.resolve(n.doc):t,vn(t))for(const s of t.items)Zi(n,e,s);else if(Array.isArray(t))for(const s of t)Zi(n,e,s);else Zi(n,e,t)}function Zi(n,e,t){const s=n&&bt(t)?t.resolve(n.doc):t;if(!gn(s))throw new Error("Merge sources must be maps or map aliases");const r=s.toJSON(null,n,Map);for(const[a,l]of r)e instanceof Map?e.has(a)||e.set(a,l):e instanceof Set?e.add(a):Object.prototype.hasOwnProperty.call(e,a)||Object.defineProperty(e,a,{value:l,writable:!0,enumerable:!0,configurable:!0});return e}function Uo(n,e,{key:t,value:s}){if(Te(t)&&t.addToJSMap)t.addToJSMap(n,e,s);else if(yf(n,t))Ho(n,e,s);else{const r=Ke(t,"",n);if(e instanceof Map)e.set(r,Ke(s,r,n));else if(e instanceof Set)e.add(r);else{const a=gf(t,r,n),l=Ke(s,a,n);a in e?Object.defineProperty(e,a,{value:l,writable:!0,enumerable:!0,configurable:!0}):e[a]=l}}return e}function gf(n,e,t){if(e===null)return"";if(typeof e!="object")return String(e);if(Te(n)&&(t!=null&&t.doc)){const s=qo(t.doc,{});s.anchors=new Set;for(const a of t.anchors.keys())s.anchors.add(a.anchor);s.inFlow=!0,s.inStringifyKey=!0;const r=n.toString(s);if(!t.mapKeyWarned){let a=JSON.stringify(r);a.length>40&&(a=a.substring(0,36)+'..."'),zo(t.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${a}. Set mapAsMap: true to use object keys.`),t.mapKeyWarned=!0}return r}return JSON.stringify(e)}function Er(n,e,t){const s=Vn(n,void 0,t),r=Vn(e,void 0,t);return new Pe(s,r)}class Pe{constructor(e,t=null){Object.defineProperty(this,qe,{value:Oo}),this.key=e,this.value=t}clone(e){let{key:t,value:s}=this;return Te(t)&&(t=t.clone(e)),Te(s)&&(s=s.clone(e)),new Pe(t,s)}toJSON(e,t){const s=t!=null&&t.mapAsMap?new Map:{};return Uo(t,s,this)}toString(e,t,s){return e!=null&&e.doc?mf(this,e,t,s):JSON.stringify(this)}}function Vo(n,e,t){return(e.inFlow??n.flow?bf:vf)(n,e,t)}function vf({comment:n,items:e},t,{blockItemPrefix:s,flowChars:r,itemIndent:a,onChompKeep:l,onComment:u}){const{indent:h,options:{commentString:m}}=t,w=Object.assign({},t,{indent:a,type:null});let g=!1;const C=[];for(let M=0;M<e.length;++M){const E=e[M];let $=null;if(Te(E))!g&&E.spaceBefore&&C.push(""),zs(t,C,E.commentBefore,g),E.comment&&($=E.comment);else if(Se(E)){const G=Te(E.key)?E.key:null;G&&(!g&&G.spaceBefore&&C.push(""),zs(t,C,G.commentBefore,g))}g=!1;let Y=dn(E,w,()=>$=null,()=>g=!0);$&&(Y+=Pt(Y,a,m($))),g&&$&&(g=!1),C.push(s+Y)}let B;if(C.length===0)B=r.start+r.end;else{B=C[0];for(let M=1;M<C.length;++M){const E=C[M];B+=E?`
${h}${E}`:`
`}}return n?(B+=`
`+it(m(n),h),u&&u()):g&&l&&l(),B}function bf({items:n},e,{flowChars:t,itemIndent:s}){const{indent:r,indentStep:a,flowCollectionPadding:l,options:{commentString:u}}=e;s+=a;const h=Object.assign({},e,{indent:s,inFlow:!0,type:null});let m=!1,w=0;const g=[];for(let M=0;M<n.length;++M){const E=n[M];let $=null;if(Te(E))E.spaceBefore&&g.push(""),zs(e,g,E.commentBefore,!1),E.comment&&($=E.comment);else if(Se(E)){const G=Te(E.key)?E.key:null;G&&(G.spaceBefore&&g.push(""),zs(e,g,G.commentBefore,!1),G.comment&&(m=!0));const Z=Te(E.value)?E.value:null;Z?(Z.comment&&($=Z.comment),Z.commentBefore&&(m=!0)):E.value==null&&(G!=null&&G.comment)&&($=G.comment)}$&&(m=!0);let Y=dn(E,h,()=>$=null);M<n.length-1&&(Y+=","),$&&(Y+=Pt(Y,s,u($))),!m&&(g.length>w||Y.includes(`
`))&&(m=!0),g.push(Y),w=g.length}const{start:C,end:B}=t;if(g.length===0)return C+B;if(!m){const M=g.reduce((E,$)=>E+$.length+2,2);m=e.options.lineWidth>0&&M>e.options.lineWidth}if(m){let M=C;for(const E of g)M+=E?`
${a}${r}${E}`:`
`;return`${M}
${r}${B}`}else return`${C}${l}${g.join(" ")}${l}${B}`}function zs({indent:n,options:{commentString:e}},t,s,r){if(s&&r&&(s=s.replace(/^\n+/,"")),s){const a=it(e(s),n);t.push(a.trimStart())}}function xt(n,e){const t=ye(e)?e.value:e;for(const s of n)if(Se(s)&&(s.key===e||s.key===t||ye(s.key)&&s.key.value===t))return s}class je extends Ro{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(yt,e),this.items=[]}static from(e,t,s){const{keepUndefined:r,replacer:a}=s,l=new this(e),u=(h,m)=>{if(typeof a=="function")m=a.call(t,h,m);else if(Array.isArray(a)&&!a.includes(h))return;(m!==void 0||r)&&l.items.push(Er(h,m,s))};if(t instanceof Map)for(const[h,m]of t)u(h,m);else if(t&&typeof t=="object")for(const h of Object.keys(t))u(h,t[h]);return typeof e.sortMapEntries=="function"&&l.items.sort(e.sortMapEntries),l}add(e,t){var l;let s;Se(e)?s=e:!e||typeof e!="object"||!("key"in e)?s=new Pe(e,e==null?void 0:e.value):s=new Pe(e.key,e.value);const r=xt(this.items,s.key),a=(l=this.schema)==null?void 0:l.sortMapEntries;if(r){if(!t)throw new Error(`Key ${s.key} already set`);ye(r.value)&&jo(s.value)?r.value.value=s.value:r.value=s.value}else if(a){const u=this.items.findIndex(h=>a(s,h)<0);u===-1?this.items.push(s):this.items.splice(u,0,s)}else this.items.push(s)}delete(e){const t=xt(this.items,e);return t?this.items.splice(this.items.indexOf(t),1).length>0:!1}get(e,t){const s=xt(this.items,e),r=s==null?void 0:s.value;return(!t&&ye(r)?r.value:r)??void 0}has(e){return!!xt(this.items,e)}set(e,t){this.add(new Pe(e,t),!0)}toJSON(e,t,s){const r=s?new s:t!=null&&t.mapAsMap?new Map:{};t!=null&&t.onCreate&&t.onCreate(r);for(const a of this.items)Uo(t,r,a);return r}toString(e,t,s){if(!e)return JSON.stringify(this);for(const r of this.items)if(!Se(r))throw new Error(`Map items must all be pairs; found ${JSON.stringify(r)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),Vo(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:s,onComment:t})}}const bn={collection:"map",default:!0,nodeClass:je,tag:"tag:yaml.org,2002:map",resolve(n,e){return gn(n)||e("Expected a mapping for this tag"),n},createNode:(n,e,t)=>je.from(n,e,t)};class gt extends Ro{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(yn,e),this.items=[]}add(e){this.items.push(e)}delete(e){const t=Ls(e);return typeof t!="number"?!1:this.items.splice(t,1).length>0}get(e,t){const s=Ls(e);if(typeof s!="number")return;const r=this.items[s];return!t&&ye(r)?r.value:r}has(e){const t=Ls(e);return typeof t=="number"&&t<this.items.length}set(e,t){const s=Ls(e);if(typeof s!="number")throw new Error(`Expected a valid index, not ${e}.`);const r=this.items[s];ye(r)&&jo(t)?r.value=t:this.items[s]=t}toJSON(e,t){const s=[];t!=null&&t.onCreate&&t.onCreate(s);let r=0;for(const a of this.items)s.push(Ke(a,String(r++),t));return s}toString(e,t,s){return e?Vo(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:s,onComment:t}):JSON.stringify(this)}static from(e,t,s){const{replacer:r}=s,a=new this(e);if(t&&Symbol.iterator in Object(t)){let l=0;for(let u of t){if(typeof r=="function"){const h=t instanceof Set?u:String(l++);u=r.call(t,h,u)}a.items.push(Vn(u,void 0,s))}}return a}}function Ls(n){let e=ye(n)?n.value:n;return e&&typeof e=="string"&&(e=Number(e)),typeof e=="number"&&Number.isInteger(e)&&e>=0?e:null}const wn={collection:"seq",default:!0,nodeClass:gt,tag:"tag:yaml.org,2002:seq",resolve(n,e){return vn(n)||e("Expected a sequence for this tag"),n},createNode:(n,e,t)=>gt.from(n,e,t)},Zs={identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify(n,e,t,s){return e=Object.assign({actualString:!0},e),Wn(n,e,t,s)}},ei={identify:n=>n==null,createNode:()=>new oe(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new oe(null),stringify:({source:n},e)=>typeof n=="string"&&ei.test.test(n)?n:e.options.nullStr},Cr={identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:n=>new oe(n[0]==="t"||n[0]==="T"),stringify({source:n,value:e},t){if(n&&Cr.test.test(n)){const s=n[0]==="t"||n[0]==="T";if(e===s)return n}return e?t.options.trueStr:t.options.falseStr}};function Ve({format:n,minFractionDigits:e,tag:t,value:s}){if(typeof s=="bigint")return String(s);const r=typeof s=="number"?s:Number(s);if(!isFinite(r))return isNaN(r)?".nan":r<0?"-.inf":".inf";let a=JSON.stringify(s);if(!n&&e&&(!t||t==="tag:yaml.org,2002:float")&&/^\d/.test(a)){let l=a.indexOf(".");l<0&&(l=a.length,a+=".");let u=e-(a.length-l-1);for(;u-- >0;)a+="0"}return a}const Yo={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Ve},Jo={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Ve(n)}},Go={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(n){const e=new oe(parseFloat(n)),t=n.indexOf(".");return t!==-1&&n[n.length-1]==="0"&&(e.minFractionDigits=n.length-t-1),e},stringify:Ve},ti=n=>typeof n=="bigint"||Number.isInteger(n),Ar=(n,e,t,{intAsBigInt:s})=>s?BigInt(n):parseInt(n.substring(e),t);function Wo(n,e,t){const{value:s}=n;return ti(s)&&s>=0?t+s.toString(e):Ve(n)}const Qo={identify:n=>ti(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(n,e,t)=>Ar(n,2,8,t),stringify:n=>Wo(n,8,"0o")},Xo={identify:ti,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(n,e,t)=>Ar(n,0,10,t),stringify:Ve},Zo={identify:n=>ti(n)&&n>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(n,e,t)=>Ar(n,2,16,t),stringify:n=>Wo(n,16,"0x")},wf=[bn,wn,Zs,ei,Cr,Qo,Xo,Zo,Yo,Jo,Go];function Ka(n){return typeof n=="bigint"||Number.isInteger(n)}const Os=({value:n})=>JSON.stringify(n),kf=[{identify:n=>typeof n=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:n=>n,stringify:Os},{identify:n=>n==null,createNode:()=>new oe(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:Os},{identify:n=>typeof n=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true$|^false$/,resolve:n=>n==="true",stringify:Os},{identify:Ka,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(n,e,{intAsBigInt:t})=>t?BigInt(n):parseInt(n,10),stringify:({value:n})=>Ka(n)?n.toString():JSON.stringify(n)},{identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:n=>parseFloat(n),stringify:Os}],Sf={default:!0,tag:"",test:/^/,resolve(n,e){return e(`Unresolved plain scalar ${JSON.stringify(n)}`),n}},_f=[bn,wn].concat(kf,Sf),Lr={identify:n=>n instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(n,e){if(typeof atob=="function"){const t=atob(n.replace(/[\n\r]/g,"")),s=new Uint8Array(t.length);for(let r=0;r<t.length;++r)s[r]=t.charCodeAt(r);return s}else return e("This environment does not support reading binary tags; either Buffer or atob is required"),n},stringify({comment:n,type:e,value:t},s,r,a){if(!t)return"";const l=t;let u;if(typeof btoa=="function"){let h="";for(let m=0;m<l.length;++m)h+=String.fromCharCode(l[m]);u=btoa(h)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(e??(e=oe.BLOCK_LITERAL),e!==oe.QUOTE_DOUBLE){const h=Math.max(s.options.lineWidth-s.indent.length,s.options.minContentWidth),m=Math.ceil(u.length/h),w=new Array(m);for(let g=0,C=0;g<m;++g,C+=h)w[g]=u.substr(C,h);u=w.join(e===oe.BLOCK_LITERAL?`
`:" ")}return Wn({comment:n,type:e,value:u},s,r,a)}};function el(n,e){if(vn(n))for(let t=0;t<n.items.length;++t){let s=n.items[t];if(!Se(s)){if(gn(s)){s.items.length>1&&e("Each pair must have its own sequence indicator");const r=s.items[0]||new Pe(new oe(null));if(s.commentBefore&&(r.key.commentBefore=r.key.commentBefore?`${s.commentBefore}
${r.key.commentBefore}`:s.commentBefore),s.comment){const a=r.value??r.key;a.comment=a.comment?`${s.comment}
${a.comment}`:s.comment}s=r}n.items[t]=Se(s)?s:new Pe(s)}}else e("Expected a sequence for this tag");return n}function tl(n,e,t){const{replacer:s}=t,r=new gt(n);r.tag="tag:yaml.org,2002:pairs";let a=0;if(e&&Symbol.iterator in Object(e))for(let l of e){typeof s=="function"&&(l=s.call(e,String(a++),l));let u,h;if(Array.isArray(l))if(l.length===2)u=l[0],h=l[1];else throw new TypeError(`Expected [key, value] tuple: ${l}`);else if(l&&l instanceof Object){const m=Object.keys(l);if(m.length===1)u=m[0],h=l[u];else throw new TypeError(`Expected tuple with one key, not ${m.length} keys`)}else u=l;r.items.push(Er(u,h,t))}return r}const Or={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:el,createNode:tl};class ln extends gt{constructor(){super(),this.add=je.prototype.add.bind(this),this.delete=je.prototype.delete.bind(this),this.get=je.prototype.get.bind(this),this.has=je.prototype.has.bind(this),this.set=je.prototype.set.bind(this),this.tag=ln.tag}toJSON(e,t){if(!t)return super.toJSON(e);const s=new Map;t!=null&&t.onCreate&&t.onCreate(s);for(const r of this.items){let a,l;if(Se(r)?(a=Ke(r.key,"",t),l=Ke(r.value,a,t)):a=Ke(r,"",t),s.has(a))throw new Error("Ordered maps must not include duplicate keys");s.set(a,l)}return s}static from(e,t,s){const r=tl(e,t,s),a=new this;return a.items=r.items,a}}ln.tag="tag:yaml.org,2002:omap";const Br={collection:"seq",identify:n=>n instanceof Map,nodeClass:ln,default:!1,tag:"tag:yaml.org,2002:omap",resolve(n,e){const t=el(n,e),s=[];for(const{key:r}of t.items)ye(r)&&(s.includes(r.value)?e(`Ordered maps must not include duplicate keys: ${r.value}`):s.push(r.value));return Object.assign(new ln,t)},createNode:(n,e,t)=>ln.from(n,e,t)};function nl({value:n,source:e},t){return e&&(n?sl:il).test.test(e)?e:n?t.options.trueStr:t.options.falseStr}const sl={identify:n=>n===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new oe(!0),stringify:nl},il={identify:n=>n===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/,resolve:()=>new oe(!1),stringify:nl},Tf={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:n=>n.slice(-3).toLowerCase()==="nan"?NaN:n[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Ve},If={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:n=>parseFloat(n.replace(/_/g,"")),stringify(n){const e=Number(n.value);return isFinite(e)?e.toExponential():Ve(n)}},Ef={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(n){const e=new oe(parseFloat(n.replace(/_/g,""))),t=n.indexOf(".");if(t!==-1){const s=n.substring(t+1).replace(/_/g,"");s[s.length-1]==="0"&&(e.minFractionDigits=s.length)}return e},stringify:Ve},Qn=n=>typeof n=="bigint"||Number.isInteger(n);function ni(n,e,t,{intAsBigInt:s}){const r=n[0];if((r==="-"||r==="+")&&(e+=1),n=n.substring(e).replace(/_/g,""),s){switch(t){case 2:n=`0b${n}`;break;case 8:n=`0o${n}`;break;case 16:n=`0x${n}`;break}const l=BigInt(n);return r==="-"?BigInt(-1)*l:l}const a=parseInt(n,t);return r==="-"?-1*a:a}function Nr(n,e,t){const{value:s}=n;if(Qn(s)){const r=s.toString(e);return s<0?"-"+t+r.substr(1):t+r}return Ve(n)}const Cf={identify:Qn,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(n,e,t)=>ni(n,2,2,t),stringify:n=>Nr(n,2,"0b")},Af={identify:Qn,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(n,e,t)=>ni(n,1,8,t),stringify:n=>Nr(n,8,"0")},Lf={identify:Qn,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(n,e,t)=>ni(n,0,10,t),stringify:Ve},Of={identify:Qn,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(n,e,t)=>ni(n,2,16,t),stringify:n=>Nr(n,16,"0x")};class cn extends je{constructor(e){super(e),this.tag=cn.tag}add(e){let t;Se(e)?t=e:e&&typeof e=="object"&&"key"in e&&"value"in e&&e.value===null?t=new Pe(e.key,null):t=new Pe(e,null),xt(this.items,t.key)||this.items.push(t)}get(e,t){const s=xt(this.items,e);return!t&&Se(s)?ye(s.key)?s.key.value:s.key:s}set(e,t){if(typeof t!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof t}`);const s=xt(this.items,e);s&&!t?this.items.splice(this.items.indexOf(s),1):!s&&t&&this.items.push(new Pe(e))}toJSON(e,t){return super.toJSON(e,t,Set)}toString(e,t,s){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),t,s);throw new Error("Set items must all have null values")}static from(e,t,s){const{replacer:r}=s,a=new this(e);if(t&&Symbol.iterator in Object(t))for(let l of t)typeof r=="function"&&(l=r.call(t,l,l)),a.items.push(Er(l,null,s));return a}}cn.tag="tag:yaml.org,2002:set";const Pr={collection:"map",identify:n=>n instanceof Set,nodeClass:cn,default:!1,tag:"tag:yaml.org,2002:set",createNode:(n,e,t)=>cn.from(n,e,t),resolve(n,e){if(gn(n)){if(n.hasAllNullValues(!0))return Object.assign(new cn,n);e("Set items must all have null values")}else e("Expected a mapping for this tag");return n}};function xr(n,e){const t=n[0],s=t==="-"||t==="+"?n.substring(1):n,r=l=>e?BigInt(l):Number(l),a=s.replace(/_/g,"").split(":").reduce((l,u)=>l*r(60)+r(u),r(0));return t==="-"?r(-1)*a:a}function rl(n){let{value:e}=n,t=l=>l;if(typeof e=="bigint")t=l=>BigInt(l);else if(isNaN(e)||!isFinite(e))return Ve(n);let s="";e<0&&(s="-",e*=t(-1));const r=t(60),a=[e%r];return e<60?a.unshift(0):(e=(e-a[0])/r,a.unshift(e%r),e>=60&&(e=(e-a[0])/r,a.unshift(e))),s+a.map(l=>String(l).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const al={identify:n=>typeof n=="bigint"||Number.isInteger(n),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(n,e,{intAsBigInt:t})=>xr(n,t),stringify:rl},ol={identify:n=>typeof n=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:n=>xr(n,!1),stringify:rl},si={identify:n=>n instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(n){const e=n.match(si.test);if(!e)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,t,s,r,a,l,u]=e.map(Number),h=e[7]?Number((e[7]+"00").substr(1,3)):0;let m=Date.UTC(t,s-1,r,a||0,l||0,u||0,h);const w=e[8];if(w&&w!=="Z"){let g=xr(w,!1);Math.abs(g)<30&&(g*=60),m-=6e4*g}return new Date(m)},stringify:({value:n})=>(n==null?void 0:n.toISOString().replace(/(T00:00:00)?\.000Z$/,""))??""},qa=[bn,wn,Zs,ei,sl,il,Cf,Af,Lf,Of,Tf,If,Ef,Lr,rt,Br,Or,Pr,al,ol,si],za=new Map([["core",wf],["failsafe",[bn,wn,Zs]],["json",_f],["yaml11",qa],["yaml-1.1",qa]]),Ha={binary:Lr,bool:Cr,float:Go,floatExp:Jo,floatNaN:Yo,floatTime:ol,int:Xo,intHex:Zo,intOct:Qo,intTime:al,map:bn,merge:rt,null:ei,omap:Br,pairs:Or,seq:wn,set:Pr,timestamp:si},Bf={"tag:yaml.org,2002:binary":Lr,"tag:yaml.org,2002:merge":rt,"tag:yaml.org,2002:omap":Br,"tag:yaml.org,2002:pairs":Or,"tag:yaml.org,2002:set":Pr,"tag:yaml.org,2002:timestamp":si};function er(n,e,t){const s=za.get(e);if(s&&!n)return t&&!s.includes(rt)?s.concat(rt):s.slice();let r=s;if(!r)if(Array.isArray(n))r=[];else{const a=Array.from(za.keys()).filter(l=>l!=="yaml11").map(l=>JSON.stringify(l)).join(", ");throw new Error(`Unknown schema "${e}"; use one of ${a} or define customTags array`)}if(Array.isArray(n))for(const a of n)r=r.concat(a);else typeof n=="function"&&(r=n(r.slice()));return t&&(r=r.concat(rt)),r.reduce((a,l)=>{const u=typeof l=="string"?Ha[l]:l;if(!u){const h=JSON.stringify(l),m=Object.keys(Ha).map(w=>JSON.stringify(w)).join(", ");throw new Error(`Unknown custom tag ${h}; use one of ${m}`)}return a.includes(u)||a.push(u),a},[])}const Nf=(n,e)=>n.key<e.key?-1:n.key>e.key?1:0;class ii{constructor({compat:e,customTags:t,merge:s,resolveKnownTags:r,schema:a,sortMapEntries:l,toStringDefaults:u}){this.compat=Array.isArray(e)?er(e,"compat"):e?er(null,e):null,this.name=typeof a=="string"&&a||"core",this.knownTags=r?Bf:{},this.tags=er(t,this.name,s),this.toStringOptions=u??null,Object.defineProperty(this,yt,{value:bn}),Object.defineProperty(this,Xe,{value:Zs}),Object.defineProperty(this,yn,{value:wn}),this.sortMapEntries=typeof l=="function"?l:l===!0?Nf:null}clone(){const e=Object.create(ii.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}}function Pf(n,e){var h;const t=[];let s=e.directives===!0;if(e.directives!==!1&&n.directives){const m=n.directives.toString(n);m?(t.push(m),s=!0):n.directives.docStart&&(s=!0)}s&&t.push("---");const r=qo(n,e),{commentString:a}=r.options;if(n.commentBefore){t.length!==1&&t.unshift("");const m=a(n.commentBefore);t.unshift(it(m,""))}let l=!1,u=null;if(n.contents){if(Te(n.contents)){if(n.contents.spaceBefore&&s&&t.push(""),n.contents.commentBefore){const g=a(n.contents.commentBefore);t.push(it(g,""))}r.forceBlockIndent=!!n.comment,u=n.contents.comment}const m=u?void 0:()=>l=!0;let w=dn(n.contents,r,()=>u=null,m);u&&(w+=Pt(w,"",a(u))),(w[0]==="|"||w[0]===">")&&t[t.length-1]==="---"?t[t.length-1]=`--- ${w}`:t.push(w)}else t.push(dn(n.contents,r));if((h=n.directives)!=null&&h.docEnd)if(n.comment){const m=a(n.comment);m.includes(`
`)?(t.push("..."),t.push(it(m,""))):t.push(`... ${m}`)}else t.push("...");else{let m=n.comment;m&&l&&(m=m.replace(/^\n+/,"")),m&&((!l||u)&&t[t.length-1]!==""&&t.push(""),t.push(it(a(m),"")))}return t.join(`
`)+`
`}class kn{constructor(e,t,s){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,qe,{value:hr});let r=null;typeof t=="function"||Array.isArray(t)?r=t:s===void 0&&t&&(s=t,t=void 0);const a=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,stringKeys:!1,uniqueKeys:!0,version:"1.2"},s);this.options=a;let{version:l}=a;s!=null&&s._directives?(this.directives=s._directives.atDocument(),this.directives.yaml.explicit&&(l=this.directives.yaml.version)):this.directives=new Me({version:l}),this.setSchema(l,s),this.contents=e===void 0?null:this.createNode(e,r,s)}clone(){const e=Object.create(kn.prototype,{[qe]:{value:hr}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=Te(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){Qt(this.contents)&&this.contents.add(e)}addIn(e,t){Qt(this.contents)&&this.contents.addIn(e,t)}createAlias(e,t){if(!e.anchor){const s=Do(this);e.anchor=!t||s.has(t)?Fo(t||"a",s):t}return new Gs(e.anchor)}createNode(e,t,s){let r;if(typeof t=="function")e=t.call({"":e},"",e),r=t;else if(Array.isArray(t)){const $=G=>typeof G=="number"||G instanceof String||G instanceof Number,Y=t.filter($).map(String);Y.length>0&&(t=t.concat(Y)),r=t}else s===void 0&&t&&(s=t,t=void 0);const{aliasDuplicateObjects:a,anchorPrefix:l,flow:u,keepUndefined:h,onTagObj:m,tag:w}=s??{},{onAnchor:g,setAnchors:C,sourceObjects:B}=of(this,l||"a"),M={aliasDuplicateObjects:a??!0,keepUndefined:h??!1,onAnchor:g,onTagObj:m,replacer:r,schema:this.schema,sourceObjects:B},E=Vn(e,w,M);return u&&_e(E)&&(E.flow=!0),C(),E}createPair(e,t,s={}){const r=this.createNode(e,null,s),a=this.createNode(t,null,s);return new Pe(r,a)}delete(e){return Qt(this.contents)?this.contents.delete(e):!1}deleteIn(e){return Rn(e)?this.contents==null?!1:(this.contents=null,!0):Qt(this.contents)?this.contents.deleteIn(e):!1}get(e,t){return _e(this.contents)?this.contents.get(e,t):void 0}getIn(e,t){return Rn(e)?!t&&ye(this.contents)?this.contents.value:this.contents:_e(this.contents)?this.contents.getIn(e,t):void 0}has(e){return _e(this.contents)?this.contents.has(e):!1}hasIn(e){return Rn(e)?this.contents!==void 0:_e(this.contents)?this.contents.hasIn(e):!1}set(e,t){this.contents==null?this.contents=qs(this.schema,[e],t):Qt(this.contents)&&this.contents.set(e,t)}setIn(e,t){Rn(e)?this.contents=t:this.contents==null?this.contents=qs(this.schema,Array.from(e),t):Qt(this.contents)&&this.contents.setIn(e,t)}setSchema(e,t={}){typeof e=="number"&&(e=String(e));let s;switch(e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Me({version:"1.1"}),s={resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Me({version:e}),s={resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,s=null;break;default:{const r=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${r}`)}}if(t.schema instanceof Object)this.schema=t.schema;else if(s)this.schema=new ii(Object.assign(s,t));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:e,jsonArg:t,mapAsMap:s,maxAliasCount:r,onAnchor:a,reviver:l}={}){const u={anchors:new Map,doc:this,keep:!e,mapAsMap:s===!0,mapKeyWarned:!1,maxAliasCount:typeof r=="number"?r:100},h=Ke(this.contents,t??"",u);if(typeof a=="function")for(const{count:m,res:w}of u.anchors.values())a(w,m);return typeof l=="function"?sn(l,{"":h},"",h):h}toJSON(e,t){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:t})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){const t=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${t}`)}return Pf(this,e)}}function Qt(n){if(_e(n))return!0;throw new Error("Expected a YAML collection as document contents")}class Mr extends Error{constructor(e,t,s,r){super(),this.name=e,this.code=s,this.message=r,this.pos=t}}class Mt extends Mr{constructor(e,t,s){super("YAMLParseError",e,t,s)}}class ll extends Mr{constructor(e,t,s){super("YAMLWarning",e,t,s)}}const Hs=(n,e)=>t=>{if(t.pos[0]===-1)return;t.linePos=t.pos.map(u=>e.linePos(u));const{line:s,col:r}=t.linePos[0];t.message+=` at line ${s}, column ${r}`;let a=r-1,l=n.substring(e.lineStarts[s-1],e.lineStarts[s]).replace(/[\n\r]+$/,"");if(a>=60&&l.length>80){const u=Math.min(a-39,l.length-79);l="…"+l.substring(u),a-=u-1}if(l.length>80&&(l=l.substring(0,79)+"…"),s>1&&/^ *$/.test(l.substring(0,a))){let u=n.substring(e.lineStarts[s-2],e.lineStarts[s-1]);u.length>80&&(u=u.substring(0,79)+`…
`),l=u+l}if(/[^ ]/.test(l)){let u=1;const h=t.linePos[1];h&&h.line===s&&h.col>r&&(u=Math.max(1,Math.min(h.col-r,80-a)));const m=" ".repeat(a)+"^".repeat(u);t.message+=`:

${l}
${m}
`}};function hn(n,{flow:e,indicator:t,next:s,offset:r,onError:a,parentIndent:l,startOnNewline:u}){let h=!1,m=u,w=u,g="",C="",B=!1,M=!1,E=null,$=null,Y=null,G=null,Z=null,X=null,te=null;for(const Q of n)switch(M&&(Q.type!=="space"&&Q.type!=="newline"&&Q.type!=="comma"&&a(Q.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),M=!1),E&&(m&&Q.type!=="comment"&&Q.type!=="newline"&&a(E,"TAB_AS_INDENT","Tabs are not allowed as indentation"),E=null),Q.type){case"space":!e&&(t!=="doc-start"||(s==null?void 0:s.type)!=="flow-collection")&&Q.source.includes("	")&&(E=Q),w=!0;break;case"comment":{w||a(Q,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const ge=Q.source.substring(1)||" ";g?g+=C+ge:g=ge,C="",m=!1;break}case"newline":m?g?g+=Q.source:(!X||t!=="seq-item-ind")&&(h=!0):C+=Q.source,m=!0,B=!0,($||Y)&&(G=Q),w=!0;break;case"anchor":$&&a(Q,"MULTIPLE_ANCHORS","A node can have at most one anchor"),Q.source.endsWith(":")&&a(Q.offset+Q.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),$=Q,te??(te=Q.offset),m=!1,w=!1,M=!0;break;case"tag":{Y&&a(Q,"MULTIPLE_TAGS","A node can have at most one tag"),Y=Q,te??(te=Q.offset),m=!1,w=!1,M=!0;break}case t:($||Y)&&a(Q,"BAD_PROP_ORDER",`Anchors and tags must be after the ${Q.source} indicator`),X&&a(Q,"UNEXPECTED_TOKEN",`Unexpected ${Q.source} in ${e??"collection"}`),X=Q,m=t==="seq-item-ind"||t==="explicit-key-ind",w=!1;break;case"comma":if(e){Z&&a(Q,"UNEXPECTED_TOKEN",`Unexpected , in ${e}`),Z=Q,m=!1,w=!1;break}default:a(Q,"UNEXPECTED_TOKEN",`Unexpected ${Q.type} token`),m=!1,w=!1}const ne=n[n.length-1],ce=ne?ne.offset+ne.source.length:r;return M&&s&&s.type!=="space"&&s.type!=="newline"&&s.type!=="comma"&&(s.type!=="scalar"||s.source!=="")&&a(s.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),E&&(m&&E.indent<=l||(s==null?void 0:s.type)==="block-map"||(s==null?void 0:s.type)==="block-seq")&&a(E,"TAB_AS_INDENT","Tabs are not allowed as indentation"),{comma:Z,found:X,spaceBefore:h,comment:g,hasNewline:B,anchor:$,tag:Y,newlineAfterProp:G,end:ce,start:te??ce}}function Yn(n){if(!n)return null;switch(n.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(n.source.includes(`
`))return!0;if(n.end){for(const e of n.end)if(e.type==="newline")return!0}return!1;case"flow-collection":for(const e of n.items){for(const t of e.start)if(t.type==="newline")return!0;if(e.sep){for(const t of e.sep)if(t.type==="newline")return!0}if(Yn(e.key)||Yn(e.value))return!0}return!1;default:return!0}}function gr(n,e,t){if((e==null?void 0:e.type)==="flow-collection"){const s=e.end[0];s.indent===n&&(s.source==="]"||s.source==="}")&&Yn(e)&&t(s,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}function cl(n,e,t){const{uniqueKeys:s}=n.options;if(s===!1)return!1;const r=typeof s=="function"?s:(a,l)=>a===l||ye(a)&&ye(l)&&a.value===l.value;return e.some(a=>r(a.key,t))}const Ua="All mapping items must start at the same column";function xf({composeNode:n,composeEmptyNode:e},t,s,r,a){var w;const l=(a==null?void 0:a.nodeClass)??je,u=new l(t.schema);t.atRoot&&(t.atRoot=!1);let h=s.offset,m=null;for(const g of s.items){const{start:C,key:B,sep:M,value:E}=g,$=hn(C,{indicator:"explicit-key-ind",next:B??(M==null?void 0:M[0]),offset:h,onError:r,parentIndent:s.indent,startOnNewline:!0}),Y=!$.found;if(Y){if(B&&(B.type==="block-seq"?r(h,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in B&&B.indent!==s.indent&&r(h,"BAD_INDENT",Ua)),!$.anchor&&!$.tag&&!M){m=$.end,$.comment&&(u.comment?u.comment+=`
`+$.comment:u.comment=$.comment);continue}($.newlineAfterProp||Yn(B))&&r(B??C[C.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else((w=$.found)==null?void 0:w.indent)!==s.indent&&r(h,"BAD_INDENT",Ua);t.atKey=!0;const G=$.end,Z=B?n(t,B,$,r):e(t,G,C,null,$,r);t.schema.compat&&gr(s.indent,B,r),t.atKey=!1,cl(t,u.items,Z)&&r(G,"DUPLICATE_KEY","Map keys must be unique");const X=hn(M??[],{indicator:"map-value-ind",next:E,offset:Z.range[2],onError:r,parentIndent:s.indent,startOnNewline:!B||B.type==="block-scalar"});if(h=X.end,X.found){Y&&((E==null?void 0:E.type)==="block-map"&&!X.hasNewline&&r(h,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),t.options.strict&&$.start<X.found.offset-1024&&r(Z.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const te=E?n(t,E,X,r):e(t,h,M,null,X,r);t.schema.compat&&gr(s.indent,E,r),h=te.range[2];const ne=new Pe(Z,te);t.options.keepSourceTokens&&(ne.srcToken=g),u.items.push(ne)}else{Y&&r(Z.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),X.comment&&(Z.comment?Z.comment+=`
`+X.comment:Z.comment=X.comment);const te=new Pe(Z);t.options.keepSourceTokens&&(te.srcToken=g),u.items.push(te)}}return m&&m<h&&r(m,"IMPOSSIBLE","Map comment with trailing content"),u.range=[s.offset,h,m??h],u}function Mf({composeNode:n,composeEmptyNode:e},t,s,r,a){const l=(a==null?void 0:a.nodeClass)??gt,u=new l(t.schema);t.atRoot&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let h=s.offset,m=null;for(const{start:w,value:g}of s.items){const C=hn(w,{indicator:"seq-item-ind",next:g,offset:h,onError:r,parentIndent:s.indent,startOnNewline:!0});if(!C.found)if(C.anchor||C.tag||g)g&&g.type==="block-seq"?r(C.end,"BAD_INDENT","All sequence items must start at the same column"):r(h,"MISSING_CHAR","Sequence item without - indicator");else{m=C.end,C.comment&&(u.comment=C.comment);continue}const B=g?n(t,g,C,r):e(t,C.end,w,null,C,r);t.schema.compat&&gr(s.indent,g,r),h=B.range[2],u.items.push(B)}return u.range=[s.offset,h,m??h],u}function Xn(n,e,t,s){let r="";if(n){let a=!1,l="";for(const u of n){const{source:h,type:m}=u;switch(m){case"space":a=!0;break;case"comment":{t&&!a&&s(u,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const w=h.substring(1)||" ";r?r+=l+w:r=w,l="";break}case"newline":r&&(l+=h),a=!0;break;default:s(u,"UNEXPECTED_TOKEN",`Unexpected ${m} at node end`)}e+=h.length}}return{comment:r,offset:e}}const tr="Block collections are not allowed within flow collections",nr=n=>n&&(n.type==="block-map"||n.type==="block-seq");function $f({composeNode:n,composeEmptyNode:e},t,s,r,a){const l=s.start.source==="{",u=l?"flow map":"flow sequence",h=(a==null?void 0:a.nodeClass)??(l?je:gt),m=new h(t.schema);m.flow=!0;const w=t.atRoot;w&&(t.atRoot=!1),t.atKey&&(t.atKey=!1);let g=s.offset+s.start.source.length;for(let $=0;$<s.items.length;++$){const Y=s.items[$],{start:G,key:Z,sep:X,value:te}=Y,ne=hn(G,{flow:u,indicator:"explicit-key-ind",next:Z??(X==null?void 0:X[0]),offset:g,onError:r,parentIndent:s.indent,startOnNewline:!1});if(!ne.found){if(!ne.anchor&&!ne.tag&&!X&&!te){$===0&&ne.comma?r(ne.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${u}`):$<s.items.length-1&&r(ne.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${u}`),ne.comment&&(m.comment?m.comment+=`
`+ne.comment:m.comment=ne.comment),g=ne.end;continue}!l&&t.options.strict&&Yn(Z)&&r(Z,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if($===0)ne.comma&&r(ne.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${u}`);else if(ne.comma||r(ne.start,"MISSING_CHAR",`Missing , between ${u} items`),ne.comment){let ce="";e:for(const Q of G)switch(Q.type){case"comma":case"space":break;case"comment":ce=Q.source.substring(1);break e;default:break e}if(ce){let Q=m.items[m.items.length-1];Se(Q)&&(Q=Q.value??Q.key),Q.comment?Q.comment+=`
`+ce:Q.comment=ce,ne.comment=ne.comment.substring(ce.length+1)}}if(!l&&!X&&!ne.found){const ce=te?n(t,te,ne,r):e(t,ne.end,X,null,ne,r);m.items.push(ce),g=ce.range[2],nr(te)&&r(ce.range,"BLOCK_IN_FLOW",tr)}else{t.atKey=!0;const ce=ne.end,Q=Z?n(t,Z,ne,r):e(t,ce,G,null,ne,r);nr(Z)&&r(Q.range,"BLOCK_IN_FLOW",tr),t.atKey=!1;const ge=hn(X??[],{flow:u,indicator:"map-value-ind",next:te,offset:Q.range[2],onError:r,parentIndent:s.indent,startOnNewline:!1});if(ge.found){if(!l&&!ne.found&&t.options.strict){if(X)for(const ve of X){if(ve===ge.found)break;if(ve.type==="newline"){r(ve,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}ne.start<ge.found.offset-1024&&r(ge.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else te&&("source"in te&&te.source&&te.source[0]===":"?r(te,"MISSING_CHAR",`Missing space after : in ${u}`):r(ge.start,"MISSING_CHAR",`Missing , or : between ${u} items`));const ze=te?n(t,te,ge,r):ge.found?e(t,ge.end,X,null,ge,r):null;ze?nr(te)&&r(ze.range,"BLOCK_IN_FLOW",tr):ge.comment&&(Q.comment?Q.comment+=`
`+ge.comment:Q.comment=ge.comment);const Ze=new Pe(Q,ze);if(t.options.keepSourceTokens&&(Ze.srcToken=Y),l){const ve=m;cl(t,ve.items,Q)&&r(ce,"DUPLICATE_KEY","Map keys must be unique"),ve.items.push(Ze)}else{const ve=new je(t.schema);ve.flow=!0,ve.items.push(Ze);const Ye=(ze??Q).range;ve.range=[Q.range[0],Ye[1],Ye[2]],m.items.push(ve)}g=ze?ze.range[2]:ge.end}}const C=l?"}":"]",[B,...M]=s.end;let E=g;if(B&&B.source===C)E=B.offset+B.source.length;else{const $=u[0].toUpperCase()+u.substring(1),Y=w?`${$} must end with a ${C}`:`${$} in block collection must be sufficiently indented and end with a ${C}`;r(g,w?"MISSING_CHAR":"BAD_INDENT",Y),B&&B.source.length!==1&&M.unshift(B)}if(M.length>0){const $=Xn(M,E,t.options.strict,r);$.comment&&(m.comment?m.comment+=`
`+$.comment:m.comment=$.comment),m.range=[s.offset,E,$.offset]}else m.range=[s.offset,E,E];return m}function sr(n,e,t,s,r,a){const l=t.type==="block-map"?xf(n,e,t,s,a):t.type==="block-seq"?Mf(n,e,t,s,a):$f(n,e,t,s,a),u=l.constructor;return r==="!"||r===u.tagName?(l.tag=u.tagName,l):(r&&(l.tag=r),l)}function Df(n,e,t,s,r){var C;const a=s.tag,l=a?e.directives.tagName(a.source,B=>r(a,"TAG_RESOLVE_FAILED",B)):null;if(t.type==="block-seq"){const{anchor:B,newlineAfterProp:M}=s,E=B&&a?B.offset>a.offset?B:a:B??a;E&&(!M||M.offset<E.offset)&&r(E,"MISSING_CHAR","Missing newline after block sequence props")}const u=t.type==="block-map"?"map":t.type==="block-seq"?"seq":t.start.source==="{"?"map":"seq";if(!a||!l||l==="!"||l===je.tagName&&u==="map"||l===gt.tagName&&u==="seq")return sr(n,e,t,r,l);let h=e.schema.tags.find(B=>B.tag===l&&B.collection===u);if(!h){const B=e.schema.knownTags[l];if(B&&B.collection===u)e.schema.tags.push(Object.assign({},B,{default:!1})),h=B;else return B?r(a,"BAD_COLLECTION_TYPE",`${B.tag} used for ${u} collection, but expects ${B.collection??"scalar"}`,!0):r(a,"TAG_RESOLVE_FAILED",`Unresolved tag: ${l}`,!0),sr(n,e,t,r,l)}const m=sr(n,e,t,r,l,h),w=((C=h.resolve)==null?void 0:C.call(h,m,B=>r(a,"TAG_RESOLVE_FAILED",B),e.options))??m,g=Te(w)?w:new oe(w);return g.range=m.range,g.tag=l,h!=null&&h.format&&(g.format=h.format),g}function ul(n,e,t){const s=e.offset,r=Ff(e,n.options.strict,t);if(!r)return{value:"",type:null,comment:"",range:[s,s,s]};const a=r.mode===">"?oe.BLOCK_FOLDED:oe.BLOCK_LITERAL,l=e.source?jf(e.source):[];let u=l.length;for(let E=l.length-1;E>=0;--E){const $=l[E][1];if($===""||$==="\r")u=E;else break}if(u===0){const E=r.chomp==="+"&&l.length>0?`
`.repeat(Math.max(1,l.length-1)):"";let $=s+r.length;return e.source&&($+=e.source.length),{value:E,type:a,comment:r.comment,range:[s,$,$]}}let h=e.indent+r.indent,m=e.offset+r.length,w=0;for(let E=0;E<u;++E){const[$,Y]=l[E];if(Y===""||Y==="\r")r.indent===0&&$.length>h&&(h=$.length);else{$.length<h&&t(m+$.length,"MISSING_CHAR","Block scalars with more-indented leading empty lines must use an explicit indentation indicator"),r.indent===0&&(h=$.length),w=E,h===0&&!n.atRoot&&t(m,"BAD_INDENT","Block scalar values in collections must be indented");break}m+=$.length+Y.length+1}for(let E=l.length-1;E>=u;--E)l[E][0].length>h&&(u=E+1);let g="",C="",B=!1;for(let E=0;E<w;++E)g+=l[E][0].slice(h)+`
`;for(let E=w;E<u;++E){let[$,Y]=l[E];m+=$.length+Y.length+1;const G=Y[Y.length-1]==="\r";if(G&&(Y=Y.slice(0,-1)),Y&&$.length<h){const X=`Block scalar lines must not be less indented than their ${r.indent?"explicit indentation indicator":"first line"}`;t(m-Y.length-(G?2:1),"BAD_INDENT",X),$=""}a===oe.BLOCK_LITERAL?(g+=C+$.slice(h)+Y,C=`
`):$.length>h||Y[0]==="	"?(C===" "?C=`
`:!B&&C===`
`&&(C=`

`),g+=C+$.slice(h)+Y,C=`
`,B=!0):Y===""?C===`
`?g+=`
`:C=`
`:(g+=C+Y,C=" ",B=!1)}switch(r.chomp){case"-":break;case"+":for(let E=u;E<l.length;++E)g+=`
`+l[E][0].slice(h);g[g.length-1]!==`
`&&(g+=`
`);break;default:g+=`
`}const M=s+r.length+e.source.length;return{value:g,type:a,comment:r.comment,range:[s,M,M]}}function Ff({offset:n,props:e},t,s){if(e[0].type!=="block-scalar-header")return s(e[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:r}=e[0],a=r[0];let l=0,u="",h=-1;for(let C=1;C<r.length;++C){const B=r[C];if(!u&&(B==="-"||B==="+"))u=B;else{const M=Number(B);!l&&M?l=M:h===-1&&(h=n+C)}}h!==-1&&s(h,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${r}`);let m=!1,w="",g=r.length;for(let C=1;C<e.length;++C){const B=e[C];switch(B.type){case"space":m=!0;case"newline":g+=B.source.length;break;case"comment":t&&!m&&s(B,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),g+=B.source.length,w=B.source.substring(1);break;case"error":s(B,"UNEXPECTED_TOKEN",B.message),g+=B.source.length;break;default:{const M=`Unexpected token in block scalar header: ${B.type}`;s(B,"UNEXPECTED_TOKEN",M);const E=B.source;E&&typeof E=="string"&&(g+=E.length)}}}return{mode:a,indent:l,chomp:u,comment:w,length:g}}function jf(n){const e=n.split(/\n( *)/),t=e[0],s=t.match(/^( *)/),a=[s!=null&&s[1]?[s[1],t.slice(s[1].length)]:["",t]];for(let l=1;l<e.length;l+=2)a.push([e[l],e[l+1]]);return a}function fl(n,e,t){const{offset:s,type:r,source:a,end:l}=n;let u,h;const m=(C,B,M)=>t(s+C,B,M);switch(r){case"scalar":u=oe.PLAIN,h=Rf(a,m);break;case"single-quoted-scalar":u=oe.QUOTE_SINGLE,h=Kf(a,m);break;case"double-quoted-scalar":u=oe.QUOTE_DOUBLE,h=qf(a,m);break;default:return t(n,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${r}`),{value:"",type:null,comment:"",range:[s,s+a.length,s+a.length]}}const w=s+a.length,g=Xn(l,w,e,t);return{value:h,type:u,comment:g.comment,range:[s,w,g.offset]}}function Rf(n,e){let t="";switch(n[0]){case"	":t="a tab character";break;case",":t="flow indicator character ,";break;case"%":t="directive indicator character %";break;case"|":case">":{t=`block scalar indicator ${n[0]}`;break}case"@":case"`":{t=`reserved character ${n[0]}`;break}}return t&&e(0,"BAD_SCALAR_START",`Plain value cannot start with ${t}`),dl(n)}function Kf(n,e){return(n[n.length-1]!=="'"||n.length===1)&&e(n.length,"MISSING_CHAR","Missing closing 'quote"),dl(n.slice(1,-1)).replace(/''/g,"'")}function dl(n){let e,t;try{e=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),t=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{e=/(.*?)[ \t]*\r?\n/sy,t=/[ \t]*(.*?)[ \t]*\r?\n/sy}let s=e.exec(n);if(!s)return n;let r=s[1],a=" ",l=e.lastIndex;for(t.lastIndex=l;s=t.exec(n);)s[1]===""?a===`
`?r+=a:a=`
`:(r+=a+s[1],a=" "),l=t.lastIndex;const u=/[ \t]*(.*)/sy;return u.lastIndex=l,s=u.exec(n),r+a+((s==null?void 0:s[1])??"")}function qf(n,e){let t="";for(let s=1;s<n.length-1;++s){const r=n[s];if(!(r==="\r"&&n[s+1]===`
`))if(r===`
`){const{fold:a,offset:l}=zf(n,s);t+=a,s=l}else if(r==="\\"){let a=n[++s];const l=Hf[a];if(l)t+=l;else if(a===`
`)for(a=n[s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="\r"&&n[s+1]===`
`)for(a=n[++s+1];a===" "||a==="	";)a=n[++s+1];else if(a==="x"||a==="u"||a==="U"){const u={x:2,u:4,U:8}[a];t+=Uf(n,s+1,u,e),s+=u}else{const u=n.substr(s-1,2);e(s-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${u}`),t+=u}}else if(r===" "||r==="	"){const a=s;let l=n[s+1];for(;l===" "||l==="	";)l=n[++s+1];l!==`
`&&!(l==="\r"&&n[s+2]===`
`)&&(t+=s>a?n.slice(a,s+1):r)}else t+=r}return(n[n.length-1]!=='"'||n.length===1)&&e(n.length,"MISSING_CHAR",'Missing closing "quote'),t}function zf(n,e){let t="",s=n[e+1];for(;(s===" "||s==="	"||s===`
`||s==="\r")&&!(s==="\r"&&n[e+2]!==`
`);)s===`
`&&(t+=`
`),e+=1,s=n[e+1];return t||(t=" "),{fold:t,offset:e}}const Hf={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function Uf(n,e,t,s){const r=n.substr(e,t),l=r.length===t&&/^[0-9a-fA-F]+$/.test(r)?parseInt(r,16):NaN;if(isNaN(l)){const u=n.substr(e-2,t+2);return s(e-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${u}`),u}return String.fromCodePoint(l)}function hl(n,e,t,s){const{value:r,type:a,comment:l,range:u}=e.type==="block-scalar"?ul(n,e,s):fl(e,n.options.strict,s),h=t?n.directives.tagName(t.source,g=>s(t,"TAG_RESOLVE_FAILED",g)):null;let m;n.options.stringKeys&&n.atKey?m=n.schema[Xe]:h?m=Vf(n.schema,r,h,t,s):e.type==="scalar"?m=Yf(n,r,e,s):m=n.schema[Xe];let w;try{const g=m.resolve(r,C=>s(t??e,"TAG_RESOLVE_FAILED",C),n.options);w=ye(g)?g:new oe(g)}catch(g){const C=g instanceof Error?g.message:String(g);s(t??e,"TAG_RESOLVE_FAILED",C),w=new oe(r)}return w.range=u,w.source=r,a&&(w.type=a),h&&(w.tag=h),m.format&&(w.format=m.format),l&&(w.comment=l),w}function Vf(n,e,t,s,r){var u;if(t==="!")return n[Xe];const a=[];for(const h of n.tags)if(!h.collection&&h.tag===t)if(h.default&&h.test)a.push(h);else return h;for(const h of a)if((u=h.test)!=null&&u.test(e))return h;const l=n.knownTags[t];return l&&!l.collection?(n.tags.push(Object.assign({},l,{default:!1,test:void 0})),l):(r(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${t}`,t!=="tag:yaml.org,2002:str"),n[Xe])}function Yf({atKey:n,directives:e,schema:t},s,r,a){const l=t.tags.find(u=>{var h;return(u.default===!0||n&&u.default==="key")&&((h=u.test)==null?void 0:h.test(s))})||t[Xe];if(t.compat){const u=t.compat.find(h=>{var m;return h.default&&((m=h.test)==null?void 0:m.test(s))})??t[Xe];if(l.tag!==u.tag){const h=e.tagString(l.tag),m=e.tagString(u.tag),w=`Value may be parsed as either ${h} or ${m}`;a(r,"TAG_RESOLVE_FAILED",w,!0)}}return l}function Jf(n,e,t){if(e){t??(t=e.length);for(let s=t-1;s>=0;--s){let r=e[s];switch(r.type){case"space":case"comment":case"newline":n-=r.source.length;continue}for(r=e[++s];(r==null?void 0:r.type)==="space";)n+=r.source.length,r=e[++s];break}}return n}const Gf={composeNode:pl,composeEmptyNode:$r};function pl(n,e,t,s){const r=n.atKey,{spaceBefore:a,comment:l,anchor:u,tag:h}=t;let m,w=!0;switch(e.type){case"alias":m=Wf(n,e,s),(u||h)&&s(e,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":m=hl(n,e,h,s),u&&(m.anchor=u.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":m=Df(Gf,n,e,t,s),u&&(m.anchor=u.source.substring(1));break;default:{const g=e.type==="error"?e.message:`Unsupported token (type: ${e.type})`;s(e,"UNEXPECTED_TOKEN",g),m=$r(n,e.offset,void 0,null,t,s),w=!1}}return u&&m.anchor===""&&s(u,"BAD_ALIAS","Anchor cannot be an empty string"),r&&n.options.stringKeys&&(!ye(m)||typeof m.value!="string"||m.tag&&m.tag!=="tag:yaml.org,2002:str")&&s(h??e,"NON_STRING_KEY","With stringKeys, all keys must be strings"),a&&(m.spaceBefore=!0),l&&(e.type==="scalar"&&e.source===""?m.comment=l:m.commentBefore=l),n.options.keepSourceTokens&&w&&(m.srcToken=e),m}function $r(n,e,t,s,{spaceBefore:r,comment:a,anchor:l,tag:u,end:h},m){const w={type:"scalar",offset:Jf(e,t,s),indent:-1,source:""},g=hl(n,w,u,m);return l&&(g.anchor=l.source.substring(1),g.anchor===""&&m(l,"BAD_ALIAS","Anchor cannot be an empty string")),r&&(g.spaceBefore=!0),a&&(g.comment=a,g.range[2]=h),g}function Wf({options:n},{offset:e,source:t,end:s},r){const a=new Gs(t.substring(1));a.source===""&&r(e,"BAD_ALIAS","Alias cannot be an empty string"),a.source.endsWith(":")&&r(e+t.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const l=e+t.length,u=Xn(s,l,n.strict,r);return a.range=[e,l,u.offset],u.comment&&(a.comment=u.comment),a}function Qf(n,e,{offset:t,start:s,value:r,end:a},l){const u=Object.assign({_directives:e},n),h=new kn(void 0,u),m={atKey:!1,atRoot:!0,directives:h.directives,options:h.options,schema:h.schema},w=hn(s,{indicator:"doc-start",next:r??(a==null?void 0:a[0]),offset:t,onError:l,parentIndent:0,startOnNewline:!0});w.found&&(h.directives.docStart=!0,r&&(r.type==="block-map"||r.type==="block-seq")&&!w.hasNewline&&l(w.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),h.contents=r?pl(m,r,w,l):$r(m,w.end,s,null,w,l);const g=h.contents.range[2],C=Xn(a,g,!1,l);return C.comment&&(h.comment=C.comment),h.range=[t,g,C.offset],h}function Dn(n){if(typeof n=="number")return[n,n+1];if(Array.isArray(n))return n.length===2?n:[n[0],n[1]];const{offset:e,source:t}=n;return[e,e+(typeof t=="string"?t.length:1)]}function Va(n){var r;let e="",t=!1,s=!1;for(let a=0;a<n.length;++a){const l=n[a];switch(l[0]){case"#":e+=(e===""?"":s?`

`:`
`)+(l.substring(1)||" "),t=!0,s=!1;break;case"%":((r=n[a+1])==null?void 0:r[0])!=="#"&&(a+=1),t=!1;break;default:t||(s=!0),t=!1}}return{comment:e,afterEmptyLine:s}}class Dr{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(t,s,r,a)=>{const l=Dn(t);a?this.warnings.push(new ll(l,s,r)):this.errors.push(new Mt(l,s,r))},this.directives=new Me({version:e.version||"1.2"}),this.options=e}decorate(e,t){const{comment:s,afterEmptyLine:r}=Va(this.prelude);if(s){const a=e.contents;if(t)e.comment=e.comment?`${e.comment}
${s}`:s;else if(r||e.directives.docStart||!a)e.commentBefore=s;else if(_e(a)&&!a.flow&&a.items.length>0){let l=a.items[0];Se(l)&&(l=l.key);const u=l.commentBefore;l.commentBefore=u?`${s}
${u}`:s}else{const l=a.commentBefore;a.commentBefore=l?`${s}
${l}`:s}}t?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:Va(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,t=!1,s=-1){for(const r of e)yield*this.next(r);yield*this.end(t,s)}*next(e){switch(e.type){case"directive":this.directives.add(e.source,(t,s,r)=>{const a=Dn(e);a[0]+=t,this.onError(a,"BAD_DIRECTIVE",s,r)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{const t=Qf(this.options,this.directives,e,this.onError);this.atDirectives&&!t.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(t,!1),this.doc&&(yield this.doc),this.doc=t,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{const t=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,s=new Mt(Dn(e),"UNEXPECTED_TOKEN",t);this.atDirectives||!this.doc?this.errors.push(s):this.doc.errors.push(s);break}case"doc-end":{if(!this.doc){const s="Unexpected doc-end without preceding document";this.errors.push(new Mt(Dn(e),"UNEXPECTED_TOKEN",s));break}this.doc.directives.docEnd=!0;const t=Xn(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),t.comment){const s=this.doc.comment;this.doc.comment=s?`${s}
${t.comment}`:t.comment}this.doc.range[2]=t.offset;break}default:this.errors.push(new Mt(Dn(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,t=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){const s=Object.assign({_directives:this.directives},this.options),r=new kn(void 0,s);this.atDirectives&&this.onError(t,"MISSING_CHAR","Missing directives-end indicator line"),r.range=[0,t,t],this.decorate(r,!1),yield r}}}function Xf(n,e=!0,t){if(n){const s=(r,a,l)=>{const u=typeof r=="number"?r:Array.isArray(r)?r[0]:r.offset;if(t)t(u,a,l);else throw new Mt([u,u+1],a,l)};switch(n.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return fl(n,e,s);case"block-scalar":return ul({options:{strict:e}},n,s)}}return null}function Zf(n,e){const{implicitKey:t=!1,indent:s,inFlow:r=!1,offset:a=-1,type:l="PLAIN"}=e,u=Wn({type:l,value:n},{implicitKey:t,indent:s>0?" ".repeat(s):"",inFlow:r,options:{blockQuote:!0,lineWidth:-1}}),h=e.end??[{type:"newline",offset:-1,indent:s,source:`
`}];switch(u[0]){case"|":case">":{const m=u.indexOf(`
`),w=u.substring(0,m),g=u.substring(m+1)+`
`,C=[{type:"block-scalar-header",offset:a,indent:s,source:w}];return ml(C,h)||C.push({type:"newline",offset:-1,indent:s,source:`
`}),{type:"block-scalar",offset:a,indent:s,props:C,source:g}}case'"':return{type:"double-quoted-scalar",offset:a,indent:s,source:u,end:h};case"'":return{type:"single-quoted-scalar",offset:a,indent:s,source:u,end:h};default:return{type:"scalar",offset:a,indent:s,source:u,end:h}}}function ed(n,e,t={}){let{afterKey:s=!1,implicitKey:r=!1,inFlow:a=!1,type:l}=t,u="indent"in n?n.indent:null;if(s&&typeof u=="number"&&(u+=2),!l)switch(n.type){case"single-quoted-scalar":l="QUOTE_SINGLE";break;case"double-quoted-scalar":l="QUOTE_DOUBLE";break;case"block-scalar":{const m=n.props[0];if(m.type!=="block-scalar-header")throw new Error("Invalid block scalar header");l=m.source[0]===">"?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:l="PLAIN"}const h=Wn({type:l,value:e},{implicitKey:r||u===null,indent:u!==null&&u>0?" ".repeat(u):"",inFlow:a,options:{blockQuote:!0,lineWidth:-1}});switch(h[0]){case"|":case">":td(n,h);break;case'"':ir(n,h,"double-quoted-scalar");break;case"'":ir(n,h,"single-quoted-scalar");break;default:ir(n,h,"scalar")}}function td(n,e){const t=e.indexOf(`
`),s=e.substring(0,t),r=e.substring(t+1)+`
`;if(n.type==="block-scalar"){const a=n.props[0];if(a.type!=="block-scalar-header")throw new Error("Invalid block scalar header");a.source=s,n.source=r}else{const{offset:a}=n,l="indent"in n?n.indent:-1,u=[{type:"block-scalar-header",offset:a,indent:l,source:s}];ml(u,"end"in n?n.end:void 0)||u.push({type:"newline",offset:-1,indent:l,source:`
`});for(const h of Object.keys(n))h!=="type"&&h!=="offset"&&delete n[h];Object.assign(n,{type:"block-scalar",indent:l,props:u,source:r})}}function ml(n,e){if(e)for(const t of e)switch(t.type){case"space":case"comment":n.push(t);break;case"newline":return n.push(t),!0}return!1}function ir(n,e,t){switch(n.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":n.type=t,n.source=e;break;case"block-scalar":{const s=n.props.slice(1);let r=e.length;n.props[0].type==="block-scalar-header"&&(r-=n.props[0].source.length);for(const a of s)a.offset+=r;delete n.props,Object.assign(n,{type:t,source:e,end:s});break}case"block-map":case"block-seq":{const r={type:"newline",offset:n.offset+e.length,indent:n.indent,source:`
`};delete n.items,Object.assign(n,{type:t,source:e,end:[r]});break}default:{const s="indent"in n?n.indent:-1,r="end"in n&&Array.isArray(n.end)?n.end.filter(a=>a.type==="space"||a.type==="comment"||a.type==="newline"):[];for(const a of Object.keys(n))a!=="type"&&a!=="offset"&&delete n[a];Object.assign(n,{type:t,indent:s,source:e,end:r})}}}const nd=n=>"type"in n?Us(n):Fs(n);function Us(n){switch(n.type){case"block-scalar":{let e="";for(const t of n.props)e+=Us(t);return e+n.source}case"block-map":case"block-seq":{let e="";for(const t of n.items)e+=Fs(t);return e}case"flow-collection":{let e=n.start.source;for(const t of n.items)e+=Fs(t);for(const t of n.end)e+=t.source;return e}case"document":{let e=Fs(n);if(n.end)for(const t of n.end)e+=t.source;return e}default:{let e=n.source;if("end"in n&&n.end)for(const t of n.end)e+=t.source;return e}}}function Fs({start:n,key:e,sep:t,value:s}){let r="";for(const a of n)r+=a.source;if(e&&(r+=Us(e)),t)for(const a of t)r+=a.source;return s&&(r+=Us(s)),r}const vr=Symbol("break visit"),sd=Symbol("skip children"),yl=Symbol("remove item");function Dt(n,e){"type"in n&&n.type==="document"&&(n={start:n.start,value:n.value}),gl(Object.freeze([]),n,e)}Dt.BREAK=vr;Dt.SKIP=sd;Dt.REMOVE=yl;Dt.itemAtPath=(n,e)=>{let t=n;for(const[s,r]of e){const a=t==null?void 0:t[s];if(a&&"items"in a)t=a.items[r];else return}return t};Dt.parentCollection=(n,e)=>{const t=Dt.itemAtPath(n,e.slice(0,-1)),s=e[e.length-1][0],r=t==null?void 0:t[s];if(r&&"items"in r)return r;throw new Error("Parent collection not found")};function gl(n,e,t){let s=t(e,n);if(typeof s=="symbol")return s;for(const r of["key","value"]){const a=e[r];if(a&&"items"in a){for(let l=0;l<a.items.length;++l){const u=gl(Object.freeze(n.concat([[r,l]])),a.items[l],t);if(typeof u=="number")l=u-1;else{if(u===vr)return vr;u===yl&&(a.items.splice(l,1),l-=1)}}typeof s=="function"&&r==="key"&&(s=s(e,n))}}return typeof s=="function"?s(e,n):s}const ri="\uFEFF",ai="",oi="",Jn="",id=n=>!!n&&"items"in n,rd=n=>!!n&&(n.type==="scalar"||n.type==="single-quoted-scalar"||n.type==="double-quoted-scalar"||n.type==="block-scalar");function ad(n){switch(n){case ri:return"<BOM>";case ai:return"<DOC>";case oi:return"<FLOW_END>";case Jn:return"<SCALAR>";default:return JSON.stringify(n)}}function vl(n){switch(n){case ri:return"byte-order-mark";case ai:return"doc-mode";case oi:return"flow-error-end";case Jn:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(n[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}const od=Object.freeze(Object.defineProperty({__proto__:null,BOM:ri,DOCUMENT:ai,FLOW_END:oi,SCALAR:Jn,createScalarToken:Zf,isCollection:id,isScalar:rd,prettyToken:ad,resolveAsScalar:Xf,setScalarValue:ed,stringify:nd,tokenType:vl,visit:Dt},Symbol.toStringTag,{value:"Module"}));function He(n){switch(n){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}const Ya=new Set("0123456789ABCDEFabcdef"),ld=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),Bs=new Set(",[]{}"),cd=new Set(` ,[]{}
\r	`),rr=n=>!n||cd.has(n);class bl{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,t=!1){if(e){if(typeof e!="string")throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null}this.atEnd=!t;let s=this.next??"stream";for(;s&&(t||this.hasChars(1));)s=yield*this.parseNext(s)}atLineEnd(){let e=this.pos,t=this.buffer[e];for(;t===" "||t==="	";)t=this.buffer[++e];return!t||t==="#"||t===`
`?!0:t==="\r"?this.buffer[e+1]===`
`:!1}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let t=this.buffer[e];if(this.indentNext>0){let s=0;for(;t===" ";)t=this.buffer[++s+e];if(t==="\r"){const r=this.buffer[s+e+1];if(r===`
`||!r&&!this.atEnd)return e+s+1}return t===`
`||s>=this.indentNext||!t&&!this.atEnd?e+s:-1}if(t==="-"||t==="."){const s=this.buffer.substr(e,3);if((s==="---"||s==="...")&&He(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return(typeof e!="number"||e!==-1&&e<this.pos)&&(e=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=e),e===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[e-1]==="\r"&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(e===null)return this.setNext("stream");if(e[0]===ri&&(yield*this.pushCount(1),e=e.substring(1)),e[0]==="%"){let t=e.length,s=e.indexOf("#");for(;s!==-1;){const a=e[s-1];if(a===" "||a==="	"){t=s-1;break}else s=e.indexOf("#",s+1)}for(;;){const a=e[t-1];if(a===" "||a==="	")t-=1;else break}const r=(yield*this.pushCount(t))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-r),this.pushNewline(),"stream"}if(this.atLineEnd()){const t=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-t),yield*this.pushNewline(),"stream"}return yield ai,yield*this.parseLineStart()}*parseLineStart(){const e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if(e==="-"||e==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const t=this.peek(3);if((t==="---"||t==="...")&&He(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,t==="---"?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!He(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[e,t]=this.peek(2);if(!t&&!this.atEnd)return this.setNext("block-start");if((e==="-"||e==="?"||e===":")&&He(t)){const s=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=s,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const e=this.getLine();if(e===null)return this.setNext("doc");let t=yield*this.pushIndicators();switch(e[t]){case"#":yield*this.pushCount(e.length-t);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(rr),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return t+=yield*this.parseBlockScalarHeader(),t+=yield*this.pushSpaces(!0),yield*this.pushCount(e.length-t),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,t,s=-1;do e=yield*this.pushNewline(),e>0?(t=yield*this.pushSpaces(!1),this.indentValue=s=t):t=0,t+=yield*this.pushSpaces(!0);while(e+t>0);const r=this.getLine();if(r===null)return this.setNext("flow");if((s!==-1&&s<this.indentNext&&r[0]!=="#"||s===0&&(r.startsWith("---")||r.startsWith("..."))&&He(r[3]))&&!(s===this.indentNext-1&&this.flowLevel===1&&(r[0]==="]"||r[0]==="}")))return this.flowLevel=0,yield oi,yield*this.parseLineStart();let a=0;for(;r[a]===",";)a+=yield*this.pushCount(1),a+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(a+=yield*this.pushIndicators(),r[a]){case void 0:return"flow";case"#":return yield*this.pushCount(r.length-a),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(rr),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const l=this.charAt(1);if(this.flowKey||He(l)||l===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const e=this.charAt(0);let t=this.buffer.indexOf(e,this.pos+1);if(e==="'")for(;t!==-1&&this.buffer[t+1]==="'";)t=this.buffer.indexOf("'",t+2);else for(;t!==-1;){let a=0;for(;this.buffer[t-1-a]==="\\";)a+=1;if(a%2===0)break;t=this.buffer.indexOf('"',t+1)}const s=this.buffer.substring(0,t);let r=s.indexOf(`
`,this.pos);if(r!==-1){for(;r!==-1;){const a=this.continueScalar(r+1);if(a===-1)break;r=s.indexOf(`
`,a)}r!==-1&&(t=r-(s[r-1]==="\r"?2:1))}if(t===-1){if(!this.atEnd)return this.setNext("quoted-scalar");t=this.buffer.length}return yield*this.pushToIndex(t+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){const t=this.buffer[++e];if(t==="+")this.blockScalarKeep=!0;else if(t>"0"&&t<="9")this.blockScalarIndent=Number(t)-1;else if(t!=="-")break}return yield*this.pushUntil(t=>He(t)||t==="#")}*parseBlockScalar(){let e=this.pos-1,t=0,s;e:for(let a=this.pos;s=this.buffer[a];++a)switch(s){case" ":t+=1;break;case`
`:e=a,t=0;break;case"\r":{const l=this.buffer[a+1];if(!l&&!this.atEnd)return this.setNext("block-scalar");if(l===`
`)break}default:break e}if(!s&&!this.atEnd)return this.setNext("block-scalar");if(t>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=t:this.indentNext=this.blockScalarIndent+(this.indentNext===0?1:this.indentNext);do{const a=this.continueScalar(e+1);if(a===-1)break;e=this.buffer.indexOf(`
`,a)}while(e!==-1);if(e===-1){if(!this.atEnd)return this.setNext("block-scalar");e=this.buffer.length}}let r=e+1;for(s=this.buffer[r];s===" ";)s=this.buffer[++r];if(s==="	"){for(;s==="	"||s===" "||s==="\r"||s===`
`;)s=this.buffer[++r];e=r-1}else if(!this.blockScalarKeep)do{let a=e-1,l=this.buffer[a];l==="\r"&&(l=this.buffer[--a]);const u=a;for(;l===" ";)l=this.buffer[--a];if(l===`
`&&a>=this.pos&&a+1+t>u)e=a;else break}while(!0);return yield Jn,yield*this.pushToIndex(e+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const e=this.flowLevel>0;let t=this.pos-1,s=this.pos-1,r;for(;r=this.buffer[++s];)if(r===":"){const a=this.buffer[s+1];if(He(a)||e&&Bs.has(a))break;t=s}else if(He(r)){let a=this.buffer[s+1];if(r==="\r"&&(a===`
`?(s+=1,r=`
`,a=this.buffer[s+1]):t=s),a==="#"||e&&Bs.has(a))break;if(r===`
`){const l=this.continueScalar(s+1);if(l===-1)break;s=Math.max(s,l-2)}}else{if(e&&Bs.has(r))break;t=s}return!r&&!this.atEnd?this.setNext("plain-scalar"):(yield Jn,yield*this.pushToIndex(t+1,!0),e?"flow":"doc")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,t){const s=this.buffer.slice(this.pos,e);return s?(yield s,this.pos+=s.length,s.length):(t&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(rr))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const e=this.flowLevel>0,t=this.charAt(1);if(He(t)||e&&Bs.has(t))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let e=this.pos+2,t=this.buffer[e];for(;!He(t)&&t!==">";)t=this.buffer[++e];return yield*this.pushToIndex(t===">"?e+1:e,!1)}else{let e=this.pos+1,t=this.buffer[e];for(;t;)if(ld.has(t))t=this.buffer[++e];else if(t==="%"&&Ya.has(this.buffer[e+1])&&Ya.has(this.buffer[e+2]))t=this.buffer[e+=3];else break;return yield*this.pushToIndex(e,!1)}}*pushNewline(){const e=this.buffer[this.pos];return e===`
`?yield*this.pushCount(1):e==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(e){let t=this.pos-1,s;do s=this.buffer[++t];while(s===" "||e&&s==="	");const r=t-this.pos;return r>0&&(yield this.buffer.substr(this.pos,r),this.pos=t),r}*pushUntil(e){let t=this.pos,s=this.buffer[t];for(;!e(s);)s=this.buffer[++t];return yield*this.pushToIndex(t,!1)}}class wl{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let t=0,s=this.lineStarts.length;for(;t<s;){const a=t+s>>1;this.lineStarts[a]<e?t=a+1:s=a}if(this.lineStarts[t]===e)return{line:t+1,col:1};if(t===0)return{line:0,col:e};const r=this.lineStarts[t-1];return{line:t,col:e-r+1}}}}function pt(n,e){for(let t=0;t<n.length;++t)if(n[t].type===e)return!0;return!1}function Ja(n){for(let e=0;e<n.length;++e)switch(n[e].type){case"space":case"comment":case"newline":break;default:return e}return-1}function kl(n){switch(n==null?void 0:n.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function Ns(n){switch(n.type){case"document":return n.start;case"block-map":{const e=n.items[n.items.length-1];return e.sep??e.start}case"block-seq":return n.items[n.items.length-1].start;default:return[]}}function Xt(n){var t;if(n.length===0)return[];let e=n.length;e:for(;--e>=0;)switch(n[e].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;((t=n[++e])==null?void 0:t.type)==="space";);return n.splice(e,n.length)}function Ga(n){if(n.start.type==="flow-seq-start")for(const e of n.items)e.sep&&!e.value&&!pt(e.start,"explicit-key-ind")&&!pt(e.sep,"map-value-ind")&&(e.key&&(e.value=e.key),delete e.key,kl(e.value)?e.value.end?Array.prototype.push.apply(e.value.end,e.sep):e.value.end=e.sep:Array.prototype.push.apply(e.start,e.sep),delete e.sep)}class Fr{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new bl,this.onNewLine=e}*parse(e,t=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(const s of this.lexer.lex(e,t))yield*this.next(s);t||(yield*this.end())}*next(e){if(this.source=e,this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=e.length;return}const t=vl(e);if(t)if(t==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=t,yield*this.step(),t){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&e[0]===" "&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{const s=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:s,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const e=this.peek(1);if(this.type==="doc-end"&&(!e||e.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}peek(e){return this.stack[this.stack.length-e]}*pop(e){const t=e??this.stack.pop();if(!t)yield{type:"error",offset:this.offset,source:"",message:"Tried to pop an empty stack"};else if(this.stack.length===0)yield t;else{const s=this.peek(1);switch(t.type==="block-scalar"?t.indent="indent"in s?s.indent:0:t.type==="flow-collection"&&s.type==="document"&&(t.indent=0),t.type==="flow-collection"&&Ga(t),s.type){case"document":s.value=t;break;case"block-scalar":s.props.push(t);break;case"block-map":{const r=s.items[s.items.length-1];if(r.value){s.items.push({start:[],key:t,sep:[]}),this.onKeyLine=!0;return}else if(r.sep)r.value=t;else{Object.assign(r,{key:t,sep:[]}),this.onKeyLine=!r.explicitKey;return}break}case"block-seq":{const r=s.items[s.items.length-1];r.value?s.items.push({start:[],value:t}):r.value=t;break}case"flow-collection":{const r=s.items[s.items.length-1];!r||r.value?s.items.push({start:[],key:t,sep:[]}):r.sep?r.value=t:Object.assign(r,{key:t,sep:[]});return}default:yield*this.pop(),yield*this.pop(t)}if((s.type==="document"||s.type==="block-map"||s.type==="block-seq")&&(t.type==="block-map"||t.type==="block-seq")){const r=t.items[t.items.length-1];r&&!r.sep&&!r.value&&r.start.length>0&&Ja(r.start)===-1&&(t.indent===0||r.start.every(a=>a.type!=="comment"||a.indent<t.indent))&&(s.type==="document"?s.end=r.start:s.items.push({start:r.start}),t.items.splice(-1,1))}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{const e={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&e.start.push(this.sourceToken),this.stack.push(e);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":{Ja(e.start)!==-1?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":e.start.push(this.sourceToken);return}const t=this.startBlockValue(e);t?this.stack.push(t):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if(this.type==="map-value-ind"){const t=Ns(this.peek(2)),s=Xt(t);let r;e.end?(r=e.end,r.push(this.sourceToken),delete e.end):r=[this.sourceToken];const a={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:s,key:e,sep:r}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=a}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":e.props.push(this.sourceToken);return;case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,t.value){const r="end"in t.value?t.value.end:void 0,a=Array.isArray(r)?r[r.length-1]:void 0;(a==null?void 0:a.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else if(t.sep)t.sep.push(this.sourceToken);else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],a=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return}if(this.indent>=e.indent){const r=!this.onKeyLine&&this.indent===e.indent,a=r&&(t.sep||t.explicitKey)&&this.type!=="seq-item-ind";let l=[];if(a&&t.sep&&!t.value){const u=[];for(let h=0;h<t.sep.length;++h){const m=t.sep[h];switch(m.type){case"newline":u.push(h);break;case"space":break;case"comment":m.indent>e.indent&&(u.length=0);break;default:u.length=0}}u.length>=2&&(l=t.sep.splice(u[1]))}switch(this.type){case"anchor":case"tag":a||t.value?(l.push(this.sourceToken),e.items.push({start:l}),this.onKeyLine=!0):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"explicit-key-ind":!t.sep&&!t.explicitKey?(t.start.push(this.sourceToken),t.explicitKey=!0):a||t.value?(l.push(this.sourceToken),e.items.push({start:l,explicitKey:!0})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken],explicitKey:!0}]}),this.onKeyLine=!0;return;case"map-value-ind":if(t.explicitKey)if(t.sep)if(t.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(pt(t.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:l,key:null,sep:[this.sourceToken]}]});else if(kl(t.key)&&!pt(t.sep,"newline")){const u=Xt(t.start),h=t.key,m=t.sep;m.push(this.sourceToken),delete t.key,delete t.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:u,key:h,sep:m}]})}else l.length>0?t.sep=t.sep.concat(l,this.sourceToken):t.sep.push(this.sourceToken);else if(pt(t.start,"newline"))Object.assign(t,{key:null,sep:[this.sourceToken]});else{const u=Xt(t.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:u,key:null,sep:[this.sourceToken]}]})}else t.sep?t.value||a?e.items.push({start:l,key:null,sep:[this.sourceToken]}):pt(t.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const u=this.flowScalar(this.type);a||t.value?(e.items.push({start:l,key:u,sep:[]}),this.onKeyLine=!0):t.sep?this.stack.push(u):(Object.assign(t,{key:u,sep:[]}),this.onKeyLine=!0);return}default:{const u=this.startBlockValue(e);if(u){if(u.type==="block-seq"){if(!t.explicitKey&&t.sep&&!pt(t.sep,"newline")){yield*this.pop({type:"error",offset:this.offset,message:"Unexpected block-seq-ind on same line with key",source:this.source});return}}else r&&e.items.push({start:l});this.stack.push(u);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){var s;const t=e.items[e.items.length-1];switch(this.type){case"newline":if(t.value){const r="end"in t.value?t.value.end:void 0,a=Array.isArray(r)?r[r.length-1]:void 0;(a==null?void 0:a.type)==="comment"?r==null||r.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(t.start,e.indent)){const r=e.items[e.items.length-2],a=(s=r==null?void 0:r.value)==null?void 0:s.end;if(Array.isArray(a)){Array.prototype.push.apply(a,t.start),a.push(this.sourceToken),e.items.pop();return}}t.start.push(this.sourceToken)}return;case"anchor":case"tag":if(t.value||this.indent<=e.indent)break;t.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==e.indent)break;t.value||pt(t.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return}if(this.indent>e.indent){const r=this.startBlockValue(e);if(r){this.stack.push(r);return}}yield*this.pop(),yield*this.step()}*flowCollection(e){const t=e.items[e.items.length-1];if(this.type==="flow-error-end"){let s;do yield*this.pop(),s=this.peek(1);while(s&&s.type==="flow-collection")}else if(e.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!t||t.sep?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken);return;case"map-value-ind":!t||t.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!t||t.value?e.items.push({start:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const r=this.flowScalar(this.type);!t||t.value?e.items.push({start:[],key:r,sep:[]}):t.sep?this.stack.push(r):Object.assign(t,{key:r,sep:[]});return}case"flow-map-end":case"flow-seq-end":e.end.push(this.sourceToken);return}const s=this.startBlockValue(e);s?this.stack.push(s):(yield*this.pop(),yield*this.step())}else{const s=this.peek(2);if(s.type==="block-map"&&(this.type==="map-value-ind"&&s.indent===e.indent||this.type==="newline"&&!s.items[s.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&s.type!=="flow-collection"){const r=Ns(s),a=Xt(r);Ga(e);const l=e.end.splice(1,e.end.length);l.push(this.sourceToken);const u={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:a,key:e,sep:l}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=u}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let t=this.source.indexOf(`
`)+1;for(;t!==0;)this.onNewLine(this.offset+t),t=this.source.indexOf(`
`,t)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const t=Ns(e),s=Xt(t);return s.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,explicitKey:!0}]}}case"map-value-ind":{this.onKeyLine=!0;const t=Ns(e),s=Xt(t);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,t){return this.type!=="comment"||this.indent<=t?!1:e.every(s=>s.type==="newline"||s.type==="space")}*documentEnd(e){this.type!=="doc-mode"&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;case"space":case"comment":default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}}function Sl(n){const e=n.prettyErrors!==!1;return{lineCounter:n.lineCounter||e&&new wl||null,prettyErrors:e}}function ud(n,e={}){const{lineCounter:t,prettyErrors:s}=Sl(e),r=new Fr(t==null?void 0:t.addNewLine),a=new Dr(e),l=Array.from(a.compose(r.parse(n)));if(s&&t)for(const u of l)u.errors.forEach(Hs(n,t)),u.warnings.forEach(Hs(n,t));return l.length>0?l:Object.assign([],{empty:!0},a.streamInfo())}function _l(n,e={}){const{lineCounter:t,prettyErrors:s}=Sl(e),r=new Fr(t==null?void 0:t.addNewLine),a=new Dr(e);let l=null;for(const u of a.compose(r.parse(n),!0,n.length))if(!l)l=u;else if(l.options.logLevel!=="silent"){l.errors.push(new Mt(u.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return s&&t&&(l.errors.forEach(Hs(n,t)),l.warnings.forEach(Hs(n,t))),l}function fd(n,e,t){let s;typeof e=="function"?s=e:t===void 0&&e&&typeof e=="object"&&(t=e);const r=_l(n,t);if(!r)return null;if(r.warnings.forEach(a=>zo(r.options.logLevel,a)),r.errors.length>0){if(r.options.logLevel!=="silent")throw r.errors[0];r.errors=[]}return r.toJS(Object.assign({reviver:s},t))}function dd(n,e,t){let s=null;if(typeof e=="function"||Array.isArray(e)?s=e:t===void 0&&e&&(t=e),typeof t=="string"&&(t=t.length),typeof t=="number"){const r=Math.round(t);t=r<1?void 0:r>8?{indent:8}:{indent:r}}if(n===void 0){const{keepUndefined:r}=t??e??{};if(!r)return}return jt(n)&&!s?n.toString(t):new kn(n,s,t).toString(t)}const hd=Object.freeze(Object.defineProperty({__proto__:null,Alias:Gs,CST:od,Composer:Dr,Document:kn,Lexer:bl,LineCounter:wl,Pair:Pe,Parser:Fr,Scalar:oe,Schema:ii,YAMLError:Mr,YAMLMap:je,YAMLParseError:Mt,YAMLSeq:gt,YAMLWarning:ll,isAlias:bt,isCollection:_e,isDocument:jt,isMap:gn,isNode:Te,isPair:Se,isScalar:ye,isSeq:vn,parse:fd,parseAllDocuments:ud,parseDocument:_l,stringify:dd,visit:Rt,visitAsync:Js},Symbol.toStringTag,{value:"Module"}));class pd{constructor(){this.tasks=[],this.taxonomy={}}async initialize(){this.tasks=await bc(),this._buildTaxonomy(),console.log(`TaskManager initialized with ${this.tasks.length} tasks.`)}async loadFromYAML(e){try{const t=hd.parse(e);if(!t.subject||!t.tasks)throw new Error("YAML must contain 'subject' and 'tasks' keys.");const s=t.tasks.map(a=>this._normalizeTask(a,t.subject)),r=new Map(this.tasks.map(a=>[a.uuid,a]));return s.forEach(a=>r.set(a.uuid,a)),this.tasks=Array.from(r.values()),await wc(this.tasks),this._buildTaxonomy(),{success:!0,count:s.length}}catch(t){return console.error("Failed to load from YAML:",t),{success:!1,error:t.message}}}_normalizeTask(e,t){if(e.simple_task){const r=e.simple_task;return{uuid:crypto.randomUUID(),title:r.problem.substring(0,30)+(r.problem.length>30?"...":""),problem:r.problem,attachments:[],my_answer:{content:""},correct_answer:{content:r.answer,explanation:""},analysis:{reason_for_error:"知识点模糊",difficulty:r.difficulty||3},tags:r.tags||[],subject:t,is_simple:!0,review:{due:Date.now(),interval:0,easeFactor:2.5,state:"new"}}}const s={...e,subject:t};return s.review||(s.review={due:Date.now(),interval:0,easeFactor:2.5,state:"new"}),s.uuid||(s.uuid=crypto.randomUUID()),s}_buildTaxonomy(){const e={};this.tasks.forEach(t=>{var r,a;const s=t.subject||"未分类";e[s]||(e[s]={tags:new Set,reasons:new Set}),(r=t.tags)==null||r.forEach(l=>e[s].tags.add(l)),(a=t.analysis)!=null&&a.reason_for_error&&e[s].reasons.add(t.analysis.reason_for_error)}),this.taxonomy=e}getFilteredTasks(e={}){const{subject:t="all",tags:s=[],reasons:r=[]}=e;return this.tasks.filter(a=>{var l;return!(t!=="all"&&a.subject!==t||s.length>0&&!s.every(u=>{var h;return(h=a.tags)==null?void 0:h.includes(u)})||r.length>0&&!r.includes((l=a.analysis)==null?void 0:l.reason_for_error))}).sort((a,l)=>a.review.due-l.review.due)}async updateReviewStatus(e,t){const s=this.tasks.find(a=>a.uuid===e);if(!s)return null;const r=ro(s.review,t);return s.review={...s.review,...r},s.lastReviewed=Date.now(),await kc(s),s}getTaxonomy(){return this.taxonomy}}class md{constructor(e){this.dom=e}renderFilters(e,t){this.dom.subjectFilter.innerHTML='<option value="all">所有任务</option>',Object.keys(e).sort().forEach(r=>{const a=new Option(r,r);a.selected=r===t,this.dom.subjectFilter.add(a)});const s=e[t]||{tags:new Set,reasons:new Set};this._renderFilterAccordion(this.dom.tagFilterContainer,"标签类型",Array.from(s.tags).sort()),this._renderFilterAccordion(this.dom.reasonFilterContainer,"任务状态",Array.from(s.reasons).sort())}_renderFilterAccordion(e,t,s){e.innerHTML=`
            <details class="filter-accordion-item" open>
                <summary><span><i class="fas fa-tags"></i> ${t}</span></summary>
                <div class="tag-list-content">
                    ${s.map(r=>`<div class="tag" data-value="${r}">${r}</div>`).join("")}
                </div>
            </details>
        `}renderTaskList(e){if(this.dom.listContainer.innerHTML="",e.length===0){this.dom.listContainer.innerHTML='<li class="session-item-placeholder"><i class="fas fa-check-circle"></i><p>没有符合条件的任务</p></li>';return}e.forEach(t=>{const s=document.createElement("li");s.className="session-item task-item",s.dataset.id=t.uuid;const{className:r,text:a}=this._getDueDateStatus(t.review.due);s.innerHTML=`
                <div class="item-content">
                    <div class="item-title">${t.title}</div>
                    <div class="item-meta">
                        <span class="meta-info ${r}">${a}</span>
                        <span class="meta-info">${t.subject||"未分类"}</span>
                    </div>
                </div>
            `,this.dom.listContainer.appendChild(s)})}_getDueDateStatus(e){const t=new Date(e),s=new Date;t.setHours(0,0,0,0),s.setHours(0,0,0,0);const r=Math.ceil((t-s)/(1e3*60*60*24));return r<0?{className:"status-overdue",text:`过期${Math.abs(r)}天`}:r===0?{className:"status-today",text:"今天"}:{className:"status-future",text:`${r}天后`}}setActiveListItem(e){if(this.dom.listContainer.querySelectorAll(".task-item.active").forEach(t=>t.classList.remove("active")),e){const t=this.dom.listContainer.querySelector(`.task-item[data-id="${e}"]`);t==null||t.classList.add("active")}}renderTaskPreview(e){this.dom.previewContainer.innerHTML="",e.forEach(t=>{this.dom.previewContainer.appendChild(this._createTaskCard(t))})}_renderAttachment(e){return e.type==="image"?`<img src="${e.url}" alt="任务附件" class="problem-image">`:""}_createTaskCard(e){var s,r,a,l,u;const t=document.createElement("div");return t.className="mistake-card task-card",t.dataset.id=e.uuid,t.innerHTML=`
            <div class="problem-section">
                <h4>${e.title}</h4>
                <div class="problem-meta">
                    <span>原因: ${e.analysis.reason_for_error}</span>
                    <span>难度: ${"★".repeat(e.analysis.difficulty)}${"☆".repeat(5-e.analysis.difficulty)}</span>
                </div>
                <div class="problem-content">${Ji.parse(e.problem||"")}</div>
                
                \x3C!-- [恢复] 附件渲染区域 -->
                ${((s=e.attachments)==null?void 0:s.map(h=>this._renderAttachment(h)).join(""))||""}

                <div class="problem-tags">${((r=e.tags)==null?void 0:r.map(h=>`<span class="tag">${h}</span>`).join(""))||""}</div>

                \x3C!-- [恢复] 我的答案预览区域 -->
                <div class="my-answer-preview"><strong>我的答案:</strong> ${((a=e.my_answer)==null?void 0:a.content)||"未作答"}</div>

                <button class="show-answer-btn">显示答案</button>
            </div>
            <div class="answer-section hidden">
                <div class="correct-answer"><strong>正确答案:</strong><div class="content">${Ji.parse(((l=e.correct_answer)==null?void 0:l.content)||"")}</div></div>
                <div class="correct-explanation"><strong>解析:</strong><div class="content">${Ji.parse(((u=e.correct_answer)==null?void 0:u.explanation)||"")}</div></div>
                <div class="review-actions">
                    <button class="review-btn redo" data-rating="0">重做</button>
                    <button class="review-btn hard" data-rating="1">困难</button>
                    <button class="review-btn medium" data-rating="2">犹豫</button>
                    <button class="review-btn easy" data-rating="3">简单</button>
                </div>
            </div>
        `,t}highlightPreviewCard(e){const t=this.dom.previewContainer.querySelector(`.task-card[data-id="${e}"]`);t&&(t.classList.add("highlight"),setTimeout(()=>t.classList.remove("highlight"),1500))}toggleAnswer(e,t){e.querySelector(".answer-section").classList.toggle("hidden",!t),e.querySelector(".show-answer-btn").classList.toggle("hidden",t)}updateCardAfterReview(e,t){t!==3&&this.toggleAnswer(e,!1),e.querySelector(".review-actions").insertAdjacentHTML("afterend",'<div class="update-feedback">已更新!</div>'),setTimeout(()=>{var r;return(r=e.querySelector(".update-feedback"))==null?void 0:r.remove()},1500)}updateListItem(e,t){const s=this.dom.listContainer.querySelector(`[data-id="${e}"] .meta-info`);if(s){const{className:r,text:a}=this._getDueDateStatus(t.review.due);s.className=`meta-info ${r}`,s.textContent=a}}renderPagination(e,t,s){this.dom.paginationContainer.innerHTML="";const r=Math.ceil(e/s);if(!(r<=1))for(let a=1;a<=r;a++){const l=document.createElement("button");l.className=`page-btn ${a===t?"active":""}`,l.textContent=a,l.dataset.page=a,this.dom.paginationContainer.appendChild(l)}}}class yd{constructor(){const e=t=>document.getElementById(t);this.view=e("task-view"),this.sidebar=this.view.querySelector(".task_session-sidebar"),this.subjectFilter=e("task_subjectFilter"),this.tagFilterContainer=e("task_tagFilterContainer"),this.reasonFilterContainer=e("task_reasonFilterContainer"),this.listContainer=e("task_list"),this.paginationContainer=e("task_paginationContainer"),this.statsDashboard=e("task_statsDashboard"),this.previewContainer=e("task_previewContainer"),this.previewPanel=e("task_previewPanel"),this.editorPanel=e("task_editorPanel"),this.yamlEditor=e("task_yamlEditor"),this.toggleSessionBtn=e("task_toggleSessionBtn"),this.saveBtn=e("task_saveBtn"),this.exportBtn=e("task_exportBtn"),this.collapseBtn=e("task_collapseBtn"),this.refreshBtn=e("task_refreshBtn"),this.loadYamlBtn=e("task_loadYamlBtn"),this.yamlFileInput=e("task_yamlFileInput"),this.newFileBtn=e("task_newFileBtn"),this.startReviewBtn=e("task_startReviewBtn")}}class gd{constructor(e,t,s){this.manager=e,this.ui=t,this.stats=s,this.dom=new yd,this.filters={subject:"all",tags:[],reasons:[]},this.currentPage=1,this.pageSize=5}init(){var e,t,s,r,a,l,u,h,m,w,g,C,B,M,E;(e=this.dom.newFileBtn)==null||e.addEventListener("click",this._handleNewFile.bind(this)),(t=this.dom.toggleSessionBtn)==null||t.addEventListener("click",this._handleToggleSidebar.bind(this)),(s=this.dom.saveBtn)==null||s.addEventListener("click",this._handleSave.bind(this)),(r=this.dom.exportBtn)==null||r.addEventListener("click",this._handleExport.bind(this)),(a=this.dom.collapseBtn)==null||a.addEventListener("click",this._handleCollapseEditor.bind(this)),(l=this.dom.refreshBtn)==null||l.addEventListener("click",this.refreshView.bind(this)),(u=this.dom.loadYamlBtn)==null||u.addEventListener("click",()=>this.dom.yamlFileInput.click()),(h=this.dom.yamlFileInput)==null||h.addEventListener("change",this._handleFileLoad.bind(this)),(m=this.dom.subjectFilter)==null||m.addEventListener("change",this._handleSubjectChange.bind(this)),(w=this.dom.tagFilterContainer)==null||w.addEventListener("click",this._handleFilterClick.bind(this,"tags")),(g=this.dom.reasonFilterContainer)==null||g.addEventListener("click",this._handleFilterClick.bind(this,"reasons")),(C=this.dom.listContainer)==null||C.addEventListener("click",this._handleListClick.bind(this)),(B=this.dom.previewContainer)==null||B.addEventListener("click",this._handlePreviewClick.bind(this)),(M=this.dom.paginationContainer)==null||M.addEventListener("click",this._handlePaginationClick.bind(this)),(E=this.dom.startReviewBtn)==null||E.addEventListener("click",()=>alert("任务待办功能待实现！")),this.refreshView()}async refreshView(){const e=this.stats.getDashboardHtml(this.manager.tasks);this.dom.statsDashboard.innerHTML=e;const t=this.manager.getFilteredTasks(this.filters),s=(this.currentPage-1)*this.pageSize,r=t.slice(s,s+this.pageSize);this.ui.renderTaskList(r),this.ui.renderTaskPreview(r),this.ui.renderPagination(t.length,this.currentPage,this.pageSize)}_handleToggleSidebar(){this.dom.sidebar.classList.toggle("collapsed")}_handleNewFile(){const e=prompt("请输入新任务集的主题:","未命名任务集");if(!e||e.trim()==="")return;const t=`
subject: ${e}
tasks:
  - title: "二次函数图像与系数关系"
    problem: |
      已知二次函数 $y = ax^2 + bx + c$ 的图像如图所示，下列结论中正确的是？
      A. $a > 0, c > 0$
      B. $b^2 - 4ac < 0$
      C. $a - b + c > 0$
      D. $abc > 0$
    attachments:
      - type: image
        url: "function_graph.png"
    my_answer:
      content: "A"
    correct_answer:
      content: "C"
      explanation: |
        1. **开口方向**: 图像开口向上, $a > 0$
        2. **对称轴**: $x = -b/2a < 0$ → $b > 0$
        3. **与y轴交点**: $c < 0$
        4. **特殊点**: $x = -1$ 时, $y > 0$ → $a - b + c > 0$
    analysis:
      reason_for_error: "概念混淆"
      difficulty: 3
    tags: ["二次函数", "图像分析"]

  # 简易模式任务
  - simple_task:
      problem: "二次函数的定义是什么？"
      answer: "形如 y = ax^2 + bx + c (a≠0) 的函数"
      difficulty: 2
      tags: ["简易", "二次函数", "定义"]
`.trim();this.dom.yamlEditor.value=t,this.dom.yamlEditor.focus()}async _handleSave(){const e=await this.manager.loadFromYAML(this.dom.yamlEditor.value);e.success?(this.dom.saveBtn.innerHTML='<i class="fas fa-check"></i> 已保存',setTimeout(()=>this.dom.saveBtn.innerHTML='<i class="fas fa-save"></i>',2e3),this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()):alert(`保存失败: ${e.error}`)}_handleExport(){const e=new Blob([this.dom.yamlEditor.value],{type:"text/yaml;charset=utf-8"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="task-export.yml",t.click(),URL.revokeObjectURL(t.href)}_handleCollapseEditor(){this.dom.editorPanel.classList.toggle("collapsed");const e=this.dom.collapseBtn.querySelector("i");e.className=this.dom.editorPanel.classList.contains("collapsed")?"fas fa-chevron-down":"fas fa-chevron-up",this.dom.editorPanel.classList.contains("collapsed")&&this._handleSave()}async _handleFileLoad(e){const t=e.target.files[0];if(!t)return;const s=await t.text();this.dom.yamlEditor.value=s,await this._handleSave(),e.target.value=""}_handleSubjectChange(e){this.filters.subject=e.target.value,this.filters.tags=[],this.filters.reasons=[],this.currentPage=1,this.ui.renderFilters(this.manager.getTaxonomy(),this.filters.subject),this.refreshView()}_handleFilterClick(e,t){const s=t.target.closest(".tag");if(!s)return;s.classList.toggle("active");const r=e==="tags"?this.dom.tagFilterContainer:this.dom.reasonFilterContainer;this.filters[e]=Array.from(r.querySelectorAll(".tag.active")).map(a=>a.dataset.value),this.currentPage=1,this.refreshView()}_handleListClick(e){const t=e.target.closest(".task-item");if(!t)return;const s=t.dataset.id;this.ui.setActiveListItem(s);const r=this.dom.previewContainer.querySelector(`.task-card[data-id="${s}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),this.ui.highlightPreviewCard(s))}_handlePaginationClick(e){const t=e.target.closest(".page-btn");t&&(this.currentPage=parseInt(t.dataset.page,10),this.refreshView())}async _handlePreviewClick(e){const t=e.target.closest(".task-card");if(!t)return;const s=t.dataset.id;e.target.matches(".show-answer-btn")&&this.ui.toggleAnswer(t,!0);const r=e.target.closest(".review-btn");if(r){const a=parseInt(r.dataset.rating,10),l=await this.manager.updateReviewStatus(s,a);l&&(this.ui.updateCardAfterReview(t,a),this.ui.updateListItem(s,l))}}}class vd{generateStats(e){const t={total:e.length,bySubject:{},byReason:{},dueToday:0,overdue:0},s=new Date;s.setHours(23,59,59,999);const r=new Date;return r.setHours(0,0,0,0),e.forEach(a=>{const l=a.subject||"未分类";t.bySubject[l]=(t.bySubject[l]||0)+1;const u=a.analysis.reason_for_error||"未知原因";t.byReason[u]=(t.byReason[u]||0)+1;const h=new Date(a.review.due);h<r?t.overdue++:h<=s&&t.dueToday++}),t}getDashboardHtml(e){const t=this.generateStats(e),s=Object.entries(t.bySubject).sort((l,u)=>u[1]-l[1]).slice(0,3),r=Object.entries(t.byReason).sort((l,u)=>u[1]-l[1]).slice(0,3),a=l=>l.length>0?l.map(([u,h])=>`<div class="list-item"><span>${u}</span><span class="list-value">${h}</span></div>`).join(""):"<span>暂无数据</span>";return`
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-chart-line"></i> 待办状态</div>
                <div class="stats-card-body">
                    <div class="stat-item"><span class="stat-value overdue">${t.overdue}</span><span class="stat-label">已过期</span></div>
                    <div class="stat-item"><span class="stat-value today">${t.dueToday}</span><span class="stat-label">今日到期</span></div>
                    <div class="stat-item"><span class="stat-value">${t.total}</span><span class="stat-label">总数</span></div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-book"></i> 任务分布</div>
                <div class="stats-card-body list-style">${a(s)}</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-header"><i class="fas fa-diagnoses"></i> 主要任务状态</div>
                <div class="stats-card-body list-style">${a(r)}</div>
            </div>
        `}}async function bd(){console.log("Initializing Task Management System...");const n=new md,e=new vd(n),t=new pd;await t.initialize();const s=new gd(t,n,e),r=Object.keys(t.getTaxonomy())[0]||"all";s.filters.subject=r,n.renderFilters(t.getTaxonomy(),r),s.init(),console.log("Task Management System is ready.")}const wd={},Wa={apiConfig:"settings_apiConfigFormDynamic",agent:"settings_agentFormDynamic"},Qa={settingsView:()=>U("settings-view"),navList:()=>U("settings_navList"),detailTitle:()=>U("settings_detailTitle"),detailContent:()=>U("settings_detailContent"),saveBtn:()=>U("settings_saveBtn"),themeSelector:()=>U("settings_themeSelector"),autoSaveInput:()=>U("settings_autosaveInterval"),exportDbBtn:()=>U("settings_exportDbBtn"),importDbBtn:()=>U("settings_importDbBtn"),importFileInput:()=>U("settings_importFileInput"),apiConfigForm:()=>U(Wa.apiConfig),agentForm:()=>U(Wa.agent)},Xa=new Proxy(wd,{get(n,e){if(n[e]!==void 0)return n[e];if(e in Qa){const t=Qa[e]();return n[e]=t,t}},set(n,e,t){return n[e]=t,!0}}),kd=U("settings_layoutTemplate"),Sd=U("settings_generalFormTemplate"),_d=U("settings_apiConfigFormTemplate"),Td=U("settings_agentFormTemplate"),un=Object.keys(se.tables.reduce((n,e)=>({...n,[e.name]:!0}),{}));async function Id(){console.log("Starting database export for tables:",un);const n={};return await se.transaction("r",un,async()=>{for(const e of un)if(se.table(e)){console.log(`Exporting table: ${e}`);const t=await se.table(e).toArray();n[e]=t}}),console.log("Database export completed."),n}async function Ed(n){const e=Object.keys(n);if(e.length===0||!un.some(t=>e.includes(t)))throw new Error("导入文件格式无效或不包含任何可识别的数据表。");console.log("Starting database import..."),await se.transaction("rw",un,async()=>{for(const t of un)n[t]&&(console.log(`Clearing and importing table: ${t}`),await se.table(t).clear(),await se.table(t).bulkAdd(n[t]))}),console.log("Database import completed successfully.")}function Tl(n){const e=document.createElement("li");e.className="settings-nav-item",e.dataset.id=n.id,e.dataset.type=n.type;let t="fa-cog";return n.type==="apiConfig"?t="fa-key":n.type==="agent"&&(t="fa-robot"),e.innerHTML=`<i class="fas ${t}"></i><span>${n.name}</span>`,e}function Za(n,e,t){const s=document.createDocumentFragment(),r=document.createElement("div");r.className="settings-nav-group",r.innerHTML=`<h4 class="settings-nav-group-title">${n}</h4>
                       <button class="add-item-btn" data-type="${t}"><i class="fas fa-plus"></i> 添加</button>`;const a=document.createElement("ul");return e.forEach(l=>a.appendChild(Tl(l))),r.appendChild(a),s.appendChild(r),s}function Cd(){const n=U("settings-view");n.children.length>0||(n.innerHTML="",n.appendChild(kd.content.cloneNode(!0)))}function Ad(n){if(!n.navList)return;n.navList.innerHTML="";const e=Tl({id:"general",type:"general",name:"应用设置"});n.navList.appendChild(e);const t=O.apiConfigs.map(r=>({id:r.id,name:r.name,type:"apiConfig"})),s=O.agents.map(r=>({id:r.id,name:r.name,type:"agent"}));n.navList.appendChild(Za("API 配置",t,"apiConfig")),n.navList.appendChild(Za("Agent 配置",s,"agent"))}function eo(n,e,t=!1){if(!n.detailContent||!n.detailTitle||!n.saveBtn)return;n.saveBtn.style.display=e.type!=="general"?"inline-flex":"none";let s;if(e.type==="general")s=Sd;else if(e.type==="apiConfig")s=_d;else if(e.type==="agent")s=Td;else{n.detailContent.innerHTML='<div class="placeholder-content"><p>未知的配置类型</p></div>';return}n.detailContent.innerHTML="",n.detailContent.appendChild(s.content.cloneNode(!0)),e.type==="apiConfig"?Ld(e,t,n):e.type==="agent"&&Od(e,t,n);const r=t?"fa-plus-circle":"fa-edit";n.detailTitle.innerHTML=`<i class="fas ${r}"></i> ${t?`创建 ${e.displayName}`:`编辑: ${e.displayName}`}`}function Ld(n,e,t){const s=t.apiConfigForm;if(!s)return;const r=s.querySelector(".config-provider");r.innerHTML="",Object.keys(br).forEach(a=>{r.add(new Option(a,a))}),e?(s.querySelector(".delete-item-btn").style.display="none",r.value="火山",r.dispatchEvent(new Event("change"))):(s.querySelector(".config-id").value=n.id,s.querySelector(".config-name").value=n.name,r.value=n.provider,s.querySelector(".config-apiUrl").value=n.apiUrl||"",s.querySelector(".config-apiKey").value=n.apiKey,s.querySelector(".config-models").value=n.models)}function Od(n,e,t){var a;const s=t.agentForm;if(!s)return;const r=s.querySelector(".config-model");if(r.innerHTML='<option value="">-- 请选择模型 --</option>',O.apiConfigs.forEach(l=>{l.models&&l.models.split(",").map(u=>u.trim()).filter(Boolean).forEach(u=>{const[h,m]=u.split(":").map(w=>w.trim());if(h&&m){const w=`${l.id}:${h}`,g=`${l.name}: ${h} (${m})`;r.add(new Option(g,w))}})}),e)s.querySelector(".delete-item-btn").style.display="none",s.querySelector(".config-sendHistory").checked=!0;else{s.querySelector(".config-id").value=n.id,s.querySelector(".config-name").value=n.name,s.querySelector(".config-avatar").value=n.avatar||"",r.value=n.model||"",s.querySelector(".config-systemPrompt").value=n.systemPrompt||"",s.querySelector(".config-hint").value=n.hint||"",s.querySelector(".config-sendHistory").checked=n.sendHistory!==!1;const l=s.querySelector(".tags-list");l.innerHTML="",((a=n.tags)==null?void 0:a.length)>0&&n.tags.forEach(u=>{const h=document.createElement("li");h.textContent=u,h.innerHTML+='<button type="button" class="remove-tag-btn">×</button>',l.appendChild(h)})}}function Ps(n,e,t){n&&(n.disabled=e,n.innerHTML=e?'<i class="fas fa-spinner fa-spin"></i> 处理中...':t)}let ar=null;function Il(n){document.documentElement.setAttribute("data-theme",n||""),localStorage.setItem("app-theme",n)}function Bd(n){if(!n.settingsView)return;function e(u){Il(u.target.value)}function t(u){const h=parseInt(u.target.value,10);!isNaN(h)&&h>=0&&re({settings:{...O.settings,autoSaveInterval:h}})}async function s(){const u=n.exportDbBtn.innerHTML;Ps(n.exportDbBtn,!0,u);try{const h=await Id(),m=new Blob([JSON.stringify(h,null,2)],{type:"application/json"}),w=URL.createObjectURL(m),g=document.createElement("a");g.href=w,g.download=`smart-suite-backup-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(w)}catch(h){alert(`导出失败: ${h.message}`)}finally{Ps(n.exportDbBtn,!1,u)}}async function r(u){const h=u.target.files[0];if(!h)return;if(!confirm("警告！导入将覆盖所有数据。确定继续吗？")){n.importFileInput.value="";return}const m=n.importDbBtn.innerHTML;Ps(n.importDbBtn,!0,m);try{const w=JSON.parse(await h.text());await Ed(w),alert("数据导入成功！应用即将刷新。"),window.location.reload()}catch(w){alert(`导入失败: ${w.message}`)}finally{Ps(n.importDbBtn,!1,m),n.importFileInput.value=""}}function a(u){const h=u.target.closest(".settings-nav-item");if(!h)return;document.querySelectorAll(".settings-nav-item.active").forEach(C=>C.classList.remove("active")),h.classList.add("active");const{id:m,type:w}=h.dataset;let g;if(w==="general"?g={id:m,type:w,name:"应用设置"}:w==="apiConfig"?g=O.apiConfigs.find(C=>C.id===m):w==="agent"&&(g=O.agents.find(C=>C.id===m)),g){const C={...g,type:w,displayName:g.name};ar=C,eo(n,C),w==="general"&&(n.themeSelector.value=localStorage.getItem("app-theme")||"",n.autoSaveInput.value=O.settings.autoSaveInterval)}}function l(u){const h=u.target.closest(".add-item-btn");if(!h)return;const{type:m}=h.dataset;ar={type:m,displayName:m==="apiConfig"?"新 API 配置":"新 Agent"},eo(n,ar,!0)}n.settingsView.addEventListener("click",u=>{if(u.target.closest("#settings_exportDbBtn")&&s(),u.target.closest("#settings_importDbBtn")&&n.importFileInput.click(),u.target.closest(".settings-nav-item")&&a(u),u.target.closest(".add-item-btn")&&l(u),u.target.closest("#settings_saveBtn"),u.target.closest(".delete-item-btn"),u.target.closest(".toggle-api-key-visibility")){const h=u.target.closest(".input-group").querySelector("input");h.type=h.type==="password"?"text":"password"}u.target.classList.contains("remove-tag-btn")&&u.target.parentElement.remove()}),n.settingsView.addEventListener("change",u=>{u.target.matches("#settings_themeSelector")&&e(u),u.target.matches("#settings_autosaveInterval")&&t(u),u.target.matches("#settings_importFileInput")&&r(u),u.target.matches(".config-provider")}),n.settingsView.addEventListener("keydown",u=>{if(u.target.classList.contains("config-tags-input")&&u.key==="Enter"){u.preventDefault();const h=u.target,m=h.value.trim();if(m){const w=h.closest(".tags-input-container").querySelector(".tags-list"),g=document.createElement("li");g.textContent=m,g.innerHTML+='<button type="button" class="remove-tag-btn">×</button>',w.appendChild(g),h.value=""}}})}function Nd(n,e){if(Il(localStorage.getItem("app-theme")||""),Ad(n),(e==null?void 0:e.type)==="agent"&&(e==null?void 0:e.action)==="create"){const t=n.settingsView.querySelector('.add-item-btn[data-type="agent"]');t==null||t.click()}else{const t=n.settingsView.querySelector('.settings-nav-item[data-type="general"]');t==null||t.click()}}async function to(n=null){Cd(),Nd(Xa,n),Bd(Xa),console.log("✅ Settings module initialized/updated correctly.")}const no={anki:!1,task:!1,agent:!1,settings:!1};async function js(n=null){console.log("[ViewChange] Switching to view:",O.activeView),Object.values(wa).forEach(r=>r.style.display="none"),document.querySelectorAll(".app-nav-btn").forEach(r=>r.classList.remove("active"));const e=O.activeView||"anki",t=wa[e],s=document.getElementById(`nav-${e}`);if(no[e])e==="settings"&&n&&(console.log("[Re-init] Re-initializing settings module with new context."),await to(n));else{console.log(`[Lazy Init] Initializing ${e} module...`);try{switch(e){case"anki":await Hu();break;case"agent":await sf();break;case"task":await bd();break;case"settings":await to(n);break}no[e]=!0}catch(r){console.error(`Failed to lazy-initialize ${e} view:`,r)}}t&&(t.style.display="flex",t.classList.add("active")),s&&s.classList.add("active")}function Pd(){document.querySelector(".app-nav").addEventListener("click",n=>{const e=n.target.closest(".app-nav-btn");if(!e)return;n.preventDefault();const t=e.dataset.view;t&&t!==O.activeView&&(Aa(t),js())}),window.addEventListener("app:navigateTo",n=>{const{view:e,context:t}=n.detail;e&&e!==O.activeView?(Aa(e),js(t)):e&&e===O.activeView&&t&&js(t)})}function xd(){let n=null;const e=()=>{var s;n&&clearInterval(n);const t=(s=O.settings)==null?void 0:s.autoSaveInterval;t>0&&(n=setInterval(xc,t*60*1e3),console.log(`Auto-save timer set for every ${t} minutes.`))};e(),window.addEventListener("state-changed",t=>{t.detail.settings&&t.detail.settings.autoSaveInterval!==void 0&&e()}),window.addEventListener("beforeunload",()=>cr()),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&cr()})}function Md(){window.addEventListener("app:dataImported",async()=>{console.log("Event 'app:dataImported' received. Re-initializing app..."),alert("数据导入成功！应用将刷新以应用更改。"),location.reload()})}async function $d(){document.body.classList.add("is-loading");try{await co(),await Yc(),Pd(),xd(),Md();const n=O.activeView||"anki";re({activeView:n}),await js(),console.log("Application initialized successfully.")}catch(n){console.error("Application failed to initialize:",n);const e=document.createElement("div");e.className="error-overlay",e.innerHTML=`<h1>应用启动失败</h1><p>请检查控制台以获取详细信息。</p><pre>${n.stack}</pre>`,document.body.innerHTML="",document.body.appendChild(e)}finally{document.body.classList.remove("is-loading")}}document.addEventListener("DOMContentLoaded",$d);</script>
  <style rel="stylesheet" crossorigin>:root{--font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;--font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--leading-tight: 1.25;--leading-normal: 1.5;--leading-relaxed: 1.75;--primary-color: #5B66F5;--primary-hover: #4B55E3;--primary-light: #E8EAFF;--primary-dark: #3B41C5;--secondary-color: #6366F1;--secondary-light: #A5A7F3;--accent-color: #06B6D4;--accent-light: #E0F6FF;--gray-50: #F9FAFB;--gray-100: #F3F4F6;--gray-200: #E5E7EB;--gray-300: #D1D5DB;--gray-400: #9CA3AF;--gray-500: #6B7280;--gray-600: #4B5563;--gray-700: #374151;--gray-800: #1F2937;--gray-900: #111827;--sidebar-bg: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);--header-bg: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);--panel-header-bg: #4f46e5;--content-bg: #f8fafc;--success-color: #10B981;--success-light: #D1FAE5;--warning-color: #F59E0B;--warning-light: #FEF3C7;--danger-color: #EF4444;--danger-light: #FEE2E2;--bg-primary: #FFFFFF;--bg-secondary: #f1f5f9;--bg-tertiary: #F3F4F6;--bg-elevated: #FFFFFF;--text-primary: #111827;--text-secondary: #4B5563;--text-tertiary: #9CA3AF;--text-on-primary: #FFFFFF;--border-color: #E5E7EB;--border-radius: 8px;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .05);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);--transition: all .3s ease;--folder-color: #F59E0B;--file-color: #06B6D4;--sidebar-width: 56px;--agent-color-1: #5B66F5;--agent-color-2: #6366F1;--agent-color-3: #06B6D4;--agent-color-4: #8B5CF6;--agent-color-5: #EC4899;--topic-color-1: #F59E0B;--topic-color-2: #10B981;--topic-color-3: #3B82F6;--topic-color-4: #EF4444;--cloze-1d: #FEE2E2;--cloze-2d: #FED7AA;--cloze-3d: #FDE68A;--cloze-5d: #D9F99D;--cloze-7d: #BBF7D0;--cloze-14d: #BFDBFE;--cloze-28d: #E0E7FF;--cloze-28plus: #EDE9FE;--cloze-easy-open: #ECFDF5;--cloze-10m: #DC2626;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .05) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .05) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .05) 0%, transparent 50%)}[data-theme=dark]{--primary-light: rgba(91, 102, 245, .15);--accent-light: rgba(6, 182, 212, .1);--gray-50: #111827;--gray-100: #1F2937;--gray-200: #374151;--gray-300: #4B5563;--gray-400: #6B7280;--gray-500: #9CA3AF;--gray-600: #D1D5DB;--gray-700: #E5E7EB;--gray-800: #F3F4F6;--gray-900: #F9FAFB;--sidebar-bg: linear-gradient(135deg, #111827 0%, #1F2937 100%);--header-bg: linear-gradient(135deg, #374151 0%, #4B5563 100%);--panel-header-bg: #374151;--content-bg: #111827;--success-light: rgba(16, 185, 129, .15);--warning-light: rgba(245, 158, 11, .15);--danger-light: rgba(239, 68, 68, .15);--bg-primary: #1F2937;--bg-secondary: #111827;--bg-tertiary: #374151;--bg-elevated: #1F2937;--text-primary: #F9FAFB;--text-secondary: #D1D5DB;--text-tertiary: #9CA3AF;--border-color: #374151;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow: 0 1px 3px 0 rgba(0, 0, 0, .3), 0 1px 2px 0 rgba(0, 0, 0, .2);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .3), 0 2px 4px -1px rgba(0, 0, 0, .2);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .3), 0 4px 6px -2px rgba(0, 0, 0, .2);--cloze-1d: #4a1d1d;--cloze-2d: #543a1a;--cloze-3d: #574f20;--cloze-5d: #3a5323;--cloze-7d: #2a503a;--cloze-14d: #2c415e;--cloze-28d: #3c3e5e;--cloze-28plus: #444059;--cloze-easy-open: #224433;--body-bg-image: radial-gradient(at 20% 80%, rgba(139, 92, 246, .1) 0%, transparent 50%), radial-gradient(at 80% 0%, rgba(99, 102, 241, .1) 0%, transparent 50%), radial-gradient(at 0% 100%, rgba(6, 182, 212, .1) 0%, transparent 50%)}[data-theme=large-font]{--text-xs: .86rem;--text-sm: 1rem;--text-base: 1.125rem;--text-lg: 1.265rem;--text-xl: 1.406rem;--text-2xl: 1.687rem;--text-3xl: 2.1rem}[data-theme=larger-font]{--text-xs: .95rem;--text-sm: 1.1rem;--text-base: 1.25rem;--text-lg: 1.4rem;--text-xl: 1.56rem;--text-2xl: 1.875rem;--text-3xl: 2.34rem}*{margin:0;padding:0;box-sizing:border-box}html{height:100%}body{font-family:var(--font-primary);font-size:var(--text-base);line-height:1.5;background:var(--bg-secondary);color:var(--text-primary);display:flex;overflow:hidden;height:100%}.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);display:flex;flex-direction:column;flex-shrink:0}.main-content{flex:1;display:flex;flex-direction:column;min-width:0}.content-wrapper{flex:1;padding:20px;display:flex;flex-direction:column;min-height:0;overflow-y:auto}.main-layout{display:none;gap:20px;flex:1;min-height:0}.main-layout.active{display:flex}.app-container{flex:1;display:flex;flex-direction:column;gap:20px;min-width:0;min-height:0}.footer{display:none}.app-nav{display:flex;flex-direction:column;gap:8px;padding:20px 0;border-bottom:1px solid rgba(255,255,255,.1)}.app-nav-btn{background:#ffffff1a;color:#ffffffe6;border:1px solid rgba(255,255,255,.1);height:32px;width:32px;padding:0;margin:0 auto;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:600;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .3s cubic-bezier(.4,0,.2,1);text-decoration:none;overflow:hidden}.app-nav-btn:hover{background:#fff3;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px #00000026}.app-nav-btn.active{background:#fffffff2;color:var(--primary-dark);border-color:transparent;box-shadow:0 4px 16px #ffffff4d}.app-nav-btn i{font-size:1.1rem;width:20px;text-align:center;flex-shrink:0}.app-nav-btn.active i{color:var(--primary-color)}.panel{background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 3px #0000000d;border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease-in-out}.panel.collapsed .panel-content{display:none}.panel.collapsed .collapse-btn i{transform:rotate(180deg)}.panel-header{background:var(--panel-header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 1px 3px #0000001a;padding:0 20px;display:flex;justify-content:space-between;align-items:center;height:60px;flex-shrink:0;position:relative}.panel-header:after{content:"";position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(to right,transparent,rgba(255,255,255,.2),transparent)}.panel-header .panel-title{flex-grow:1;justify-content:center;text-align:center}.panel-header .panel-actions-leading,.panel-header .panel-actions{flex-shrink:0;display:flex;gap:8px;align-items:center}.panel-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;gap:8px}.panel-actions{display:flex;gap:8px;align-items:center}.panel-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:4px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition)}.panel-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.panel-btn.active{background-color:#ffffff4d;transform:scale(1.1)}.panel-btn-text{width:auto;padding:0 15px;gap:8px}.panel-content{flex:1;padding:0;overflow:hidden;transition:var(--transition);display:flex;flex-direction:column;min-height:0}.collapse-btn i{transition:transform .3s ease}.session-sidebar{width:300px;background:var(--bg-elevated);box-shadow:var(--shadow-md);border:1px solid rgba(0,0,0,.06);border-radius:var(--border-radius);overflow:hidden;display:flex;flex-direction:column;transition:var(--transition)}.session-header{background:var(--header-bg);color:var(--text-on-primary);border-bottom:none;box-shadow:0 2px 8px #4f46e526;padding:15px 20px;display:flex;flex-direction:column;gap:12px}.session-title{font-size:var(--text-lg);font-weight:600;color:var(--text-on-primary);display:flex;align-items:center;justify-content:space-between}.session-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:5px}.session-btn{background:#fff3;color:var(--text-on-primary);border:1px solid rgba(255,255,255,.1);padding:8px;border-radius:4px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;width:36px;height:36px;transition:var(--transition)}.session-btn:hover{background:#ffffff4d;color:var(--text-on-primary);transform:scale(1.05)}.session-content{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;min-height:0;background:var(--bg-secondary)}.session-list-container{flex:1;display:flex;flex-direction:column;min-height:0}.session-list{list-style:none;margin-top:10px;overflow-y:auto;flex:1}.session-item{padding:12px 15px 12px 30px;border-radius:6px;margin-bottom:8px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;cursor:pointer;transition:var(--transition);position:relative}.session-item.folder{background:#ffd1661a;border-left:4px solid var(--folder-color);padding-left:26px}.session-item.file{background:#a1c4fd1a;border-left:4px solid var(--file-color);padding-left:26px}.session-item:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:60px;display:flex;align-items:center;gap:8px}.session-item .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}.session-item .edit-btn,.session-item .delete-btn,.session-item .move-btn{color:var(--text-tertiary);cursor:pointer;padding:4px;border-radius:4px;transition:var(--transition);background:#fff9;width:24px;height:24px;display:flex;align-items:center;justify-content:center}.session-item .edit-btn:hover{background:var(--accent-color);color:var(--text-on-primary)}.session-item .delete-btn:hover{background:var(--danger-color);color:var(--text-on-primary)}.session-item .move-btn:hover{background:var(--success-color);color:var(--text-on-primary)}.session-item input[type=text]{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:.95rem;background-color:var(--bg-primary);color:var(--text-primary)}.select-controls{display:flex;gap:8px;margin-top:10px;padding:8px 0;background:#ffffff1a;border-top:1px solid rgba(255,255,255,.2);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.select-all{display:flex;align-items:center;gap:5px;color:var(--text-on-primary);font-size:.85rem}.session-item .select-checkbox{margin-right:8px}.folder-icon{color:var(--folder-color)}.file-icon{color:var(--file-color)}.current-folder{margin-top:10px;padding:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:inset 0 1px 2px #0000000d;border-radius:4px;font-size:.9rem;color:var(--text-primary);display:flex;align-items:center;flex-wrap:wrap;gap:4px}.current-folder i{margin-right:5px;color:var(--folder-color)}.breadcrumb-link{color:var(--primary-color);cursor:pointer;text-decoration:none}.breadcrumb-link:hover{text-decoration:underline}.breadcrumb-separator{margin:0 4px;color:#6c757d}.breadcrumb-current{font-weight:700;color:var(--secondary-color)}.empty-session{text-align:center;padding:28px;color:var(--text-tertiary)}.empty-session i{font-size:2.8rem;margin-bottom:14px;color:var(--gray-300)}.btn-primary,.btn-secondary,.btn-danger{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1rem;transition:var(--transition)}.btn-primary{background-color:var(--primary-color);color:var(--text-on-primary);font-weight:500}.btn-primary:hover{background-color:var(--primary-hover)}.btn-secondary{background-color:var(--gray-100);color:var(--text-secondary)}.btn-secondary:hover{background-color:var(--gray-200);color:var(--text-primary)}.btn-danger{background-color:var(--danger-color);color:var(--text-on-primary)}.btn-danger:hover{opacity:.85}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-primary)}.form-control{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);width:100%;padding:10px 12px;border-radius:6px;font-size:var(--text-base);transition:var(--transition)}.form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.input-group{display:flex}.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}.input-group-btn{padding:0 12px;border:1px solid var(--border-color);border-left:none;background-color:var(--bg-tertiary);border-top-right-radius:6px;border-bottom-right-radius:6px;cursor:pointer}.form-checkbox-group{display:flex;flex-wrap:wrap;gap:10px 20px;padding:5px 0}.form-checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0009;display:flex;align-items:center;justify-content:center;z-index:2000;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}.modal-content{background:var(--bg-elevated);box-shadow:0 20px 40px #00000026;border-radius:var(--border-radius);width:90%;max-width:600px;display:flex;flex-direction:column;max-height:90vh;animation:slide-in .3s ease-out}.modal-content.large{max-width:900px}.modal-header{padding:15px 25px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:var(--text-xl);color:var(--text-primary)}.modal-close{background:none;border:none;font-size:1.8rem;cursor:pointer;color:var(--text-tertiary)}.modal-body{padding:25px;overflow-y:auto}.modal-footer{padding:15px 25px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:10px}.move-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:var(--transition)}.move-modal.active{opacity:1;pointer-events:all}.move-modal-content{background:var(--bg-elevated);border-radius:var(--border-radius);padding:20px;width:400px;max-width:90%;box-shadow:var(--shadow)}.move-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.move-modal-title{font-size:1.2rem;font-weight:600;color:var(--primary-color)}.move-modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-tertiary)}.folder-list{max-height:300px;overflow-y:auto;margin:15px 0;border:1px solid var(--border-color);border-radius:var(--border-radius);padding:10px}.folder-item{padding:8px 10px;border-radius:4px;margin-bottom:5px;background:var(--bg-primary);cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}.folder-item:hover{background:var(--bg-tertiary)}.folder-item.selected{background:#4361ee1a;border-left:3px solid var(--primary-color)}.move-modal-actions{display:flex;justify-content:flex-end;gap:10px}.move-modal-btn{padding:8px 15px;border-radius:4px;cursor:pointer;border:none;font-weight:500;transition:var(--transition)}.move-modal-btn.confirm{background:var(--primary-color);color:var(--text-on-primary)}.move-modal-btn.cancel{background:var(--gray-100);color:var(--text-primary)}#anki_editorPreviewPanel{flex:1;min-height:0}#anki_editorPreviewPanel.preview-active #anki_editor,#anki_editorPreviewPanel.preview-active #anki_editorToolbar{display:none}#anki_editorPreviewPanel.preview-active #anki_preview{display:block}.editor-container{flex:1;display:flex;min-height:0;position:relative}#anki_editor,#anki_preview{position:absolute;top:0;left:0;width:100%;height:100%;margin:0;border:none;padding:15px;box-sizing:border-box;overflow:auto;background:transparent}#anki_editor{z-index:10;font-family:var(--font-mono);font-size:var(--text-sm);color:var(--text-primary);resize:none;line-height:1.5;background-color:var(--bg-primary)}#anki_editor:focus{outline:none;box-shadow:0 0 0 3px #4895ef33 inset}#anki_preview{z-index:5;display:none;font-size:var(--text-base);line-height:var(--leading-relaxed);color:var(--text-primary);background-color:var(--bg-elevated)}#anki_preview h1,#anki_preview h2,#anki_preview h3{margin-top:1.1em;margin-bottom:.7em;color:var(--text-primary);font-weight:700}#anki_preview h1{font-size:var(--text-3xl)}#anki_preview h2{font-size:var(--text-2xl)}#anki_preview h3{font-size:var(--text-xl)}#anki_preview p{margin-bottom:.9em}#anki_preview code{background:var(--gray-100);color:var(--primary-color);padding:2px 5px;border-radius:4px;font-family:var(--font-mono);font-size:var(--text-sm)}#anki_preview pre{background:var(--gray-50);color:var(--text-primary);padding:14px;border-radius:6px;overflow:auto;margin:1.4em 0;border:1px solid var(--border-color)}#anki_preview blockquote{border-left:4px solid var(--primary-color);padding:10px 18px;background:var(--primary-light);margin:1.4em 0}.editor-sub-toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px 15px;border-bottom:1px solid var(--border-color);background:var(--bg-tertiary);flex-shrink:0}.editor-btn{background:var(--bg-primary);border:1px solid var(--border-color);box-shadow:0 1px 2px #0000000d;padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:var(--transition);font-size:.9rem;color:var(--text-secondary)}.editor-btn:hover:not(:disabled){background:var(--primary-color);color:var(--text-on-primary);border-color:var(--primary-color);transform:translateY(-1px);box-shadow:0 4px 8px #5b66f540}.editor-btn:disabled{opacity:.5;cursor:not-allowed}.mode-indicator{position:absolute;bottom:10px;right:10px;display:flex;gap:5px;z-index:20;background:#fffc;padding:5px 8px;border-radius:12px;box-shadow:0 2px 5px #0000001a}.mode-dot{width:10px;height:10px;border-radius:50%;background-color:var(--border-color)}.mode-dot.active{background-color:var(--primary-color)}.review-btn-group{display:flex;position:relative}.review-btn-group .panel-btn:first-child{border-top-right-radius:0;border-bottom-right-radius:0}.review-btn-group .dropdown-toggle{border-top-left-radius:0;border-bottom-left-radius:0;border-left:1px solid rgba(255,255,255,.3)}.dropdown-menu{position:absolute;top:105%;right:0;background-color:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;padding:8px 0;min-width:180px;border:1px solid var(--border-color)}.dropdown-menu a{display:block;padding:10px 15px;color:var(--text-primary);text-decoration:none;transition:background-color .2s ease;font-size:.9rem}.dropdown-menu a:hover{background-color:var(--gray-100)}.dropdown-menu a i{margin-right:10px;color:var(--primary-color);width:20px;text-align:center}#anki_audioControls{position:fixed;bottom:20px;right:20px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);padding:15px;z-index:1000;display:none}#anki_audioControls .audio-title{margin-bottom:10px;font-weight:600;color:var(--secondary-color)}#anki_audioControls .audio-progress{width:300px;height:6px;background:var(--border-color);border-radius:3px;margin:10px 0;overflow:hidden}#anki_audioControls .audio-progress-bar{height:100%;background:var(--primary-color);width:0%;transition:width .1s linear}#anki_audioControls .audio-buttons{display:flex;justify-content:space-between;gap:5px}#anki_audioControls .audio-btn{background:var(--primary-color);color:var(--text-on-primary);border:none;padding:8px 15px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:5px}.cloze{padding:2px 6px;border-radius:4px;cursor:pointer;position:relative;transition:var(--transition);border:1px dashed rgba(67,97,238,.3);font-weight:700;background:var(--cloze-28plus)}.cloze.hidden .cloze-content{display:none}.cloze.hidden .placeholder{display:inline}.cloze:not(.hidden) .placeholder{display:none}.placeholder{color:var(--primary-color);font-weight:700}.cloze-1d{background:var(--cloze-1d)!important}.cloze-2d{background:var(--cloze-2d)!important}.cloze-3d{background:var(--cloze-3d)!important}.cloze-5d{background:var(--cloze-5d)!important}.cloze-7d{background:var(--cloze-7d)!important}.cloze-14d{background:var(--cloze-14d)!important}.cloze-28d{background:var(--cloze-28d)!important}.cloze-28plus{background:var(--cloze-28plus)!important}.cloze-10m{background-color:var(--cloze-10m)!important;border-color:#f33!important;animation:pulse-alert 1.5s infinite alternate;color:var(--text-on-primary)!important;font-weight:700}.cloze.easy-open{background-color:var(--cloze-easy-open)!important;border:1px dashed #C8E6C9;color:var(--text-primary)!important;font-weight:400;opacity:.9}.cloze.permanent-view{background-color:var(--primary-light)!important;border:1px solid var(--primary-color)!important;font-weight:400!important}.cloze.permanent-view .cloze-actions{display:none!important}.cloze-actions{display:flex;justify-content:space-between;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.08)}.cloze-btn{flex:1;padding:10px 5px;border-radius:20px;border:none;background-color:var(--bg-primary);cursor:pointer;font-size:.9rem;font-weight:600;text-align:center;transition:all .2s ease-in-out;outline:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;box-shadow:0 2px 4px #0000000d}.cloze-btn i{font-size:1.2rem;margin-bottom:5px}.cloze-btn.again{color:#e53935;background-color:#e539351a}.cloze-btn.again:hover{background-color:#e53935;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #e539354d}.cloze-btn.hard{color:#fb8c00;background-color:#fb8c001a}.cloze-btn.hard:hover{background-color:#fb8c00;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #fb8c004d}.cloze-btn.double{color:#43a047;background-color:#43a0471a}.cloze-btn.double:hover{background-color:#43a047;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #43a0474d}.cloze-btn.easy{color:#1e88e5;background-color:#1e88e51a}.cloze-btn.easy:hover{background-color:#1e88e5;color:var(--text-on-primary);transform:translateY(-2px);box-shadow:0 4px 12px #1e88e54d}.cloze.cloze-nav-active{outline:3px solid var(--accent-color, #06B6D4);box-shadow:0 0 15px #06b6d480;transition:outline .2s ease-in-out,box-shadow .2s ease-in-out}.cloze.cloze-error-duplicate{border:2px solid var(--danger-color, #EF4444)!important;background-color:var(--danger-light, #FEE2E2)!important;animation:pulse-error 1s infinite alternate}.cloze.cloze-error-duplicate .placeholder{color:var(--danger-color, #EF4444)!important;font-weight:700}#task-view .filter-group{margin-bottom:15px}#task-view .tag-list{display:flex;flex-wrap:wrap;gap:8px}#task-view .list-header{font-weight:600;color:var(--text-secondary);padding:10px 0;border-top:1px solid var(--border-color);margin-top:15px}#task_list .mistake-title{font-weight:500;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#task_list .mistake-meta{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-tertiary)}#task_yamlEditor{font-family:Consolas,Courier New,monospace;font-size:15px;resize:none;line-height:1.5;background-color:var(--bg-primary);color:var(--text-primary)}#task_previewContainer{flex:1;overflow-y:auto;padding:15px;background-color:var(--bg-elevated);display:block}#task_statsDashboard{display:flex;gap:15px;padding-bottom:15px}.stats-card{flex:1;background-color:var(--bg-elevated);border-radius:8px;border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000d;overflow:hidden}.stats-card-header{font-size:.9rem;font-weight:600;padding:8px 12px;background-color:var(--bg-tertiary);border-bottom:1px solid var(--border-color);color:var(--text-secondary)}.stats-card-header i{margin-right:8px;color:var(--primary-color)}.stats-card-body{padding:12px;display:flex;justify-content:space-around;align-items:center}.stat-item{display:flex;flex-direction:column;align-items:center;gap:4px}.stat-value{font-size:1.5rem;font-weight:700;color:var(--text-primary)}.stat-value.overdue{color:#d90429}.stat-value.today{color:#f77f00}.stat-label{font-size:.8rem;color:var(--text-tertiary)}.list-item{display:flex;justify-content:space-between;font-size:.85rem}.list-value{font-weight:600;padding:2px 6px;background-color:var(--bg-tertiary);border-radius:4px}.chart-container{position:relative;height:60vh;width:100%}.agent_topics-panel{width:300px;background:var(--bg-elevated);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .3s ease,width .3s ease,padding .3s ease,border .3s ease}.agent_topics-panel.collapsed{width:0;padding-left:0;padding-right:0;border-width:0;transform:translate(-100%);overflow:hidden}.agent_topics-panel .topics-header{background:var(--header-bg);color:var(--text-on-primary);padding:10px 15px;font-size:var(--text-lg);font-weight:600;display:flex;justify-content:space-between;align-items:center;height:60px;flex-shrink:0}.agent_topics-panel .header-title-group{display:flex;align-items:center;gap:8px}.agent_topics-panel .header-actions-group{display:flex;align-items:center;gap:10px}.agent_topics-panel .topic-filter-select{padding:6px 30px 6px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.3);font-size:var(--text-sm);background:#ffffff1a;color:var(--text-on-primary);-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;cursor:pointer}.agent_topics-panel .topic-action-btn{background:#fff3;border:none;color:var(--text-on-primary);width:32px;height:32px;border-radius:50%;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;flex-shrink:0}.agent_topics-panel .topic-action-btn:hover{background:#fff6;transform:scale(1.1)}.agent_topics-panel .topics-batch-actions{padding:10px 15px;background-color:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;gap:10px;flex-shrink:0}.agent_topics-panel .batch-action-btn{padding:6px 12px;border-radius:6px;border:1px solid var(--border-color);background-color:var(--bg-primary);cursor:pointer}.agent_topics-panel .batch-action-btn.danger{background-color:var(--danger-light);color:var(--danger-color)}.agent_topics-panel .batch-action-btn:disabled{opacity:.5;cursor:not-allowed}.agent_topics-panel .topics-content{flex:1;padding:15px;overflow-y:auto}.agent_topics-panel .topic-list{list-style:none}.agent_topics-panel .topic-item{padding:12px 15px;border-radius:6px;margin-bottom:10px;background:var(--bg-secondary);border:1px solid var(--border-color);cursor:pointer;transition:var(--transition);position:relative;display:flex;align-items:center;gap:10px}.agent_topics-panel .topic-item:hover{transform:translate(5px);background:var(--bg-elevated);box-shadow:0 2px 8px #0000000f}.agent_topics-panel .topic-item.active{background:var(--primary-light);font-weight:600;border-left-color:var(--primary-color);border-left-width:4px}.agent_topics-panel .topic-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--text-on-primary);font-size:.8rem;flex-shrink:0}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+1){border-left-color:var(--topic-color-1)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+2){border-left-color:var(--topic-color-2)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+3){border-left-color:var(--topic-color-3)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+4){border-left-color:var(--topic-color-4)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+1) .topic-icon{background:var(--topic-color-1)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+2) .topic-icon{background:var(--topic-color-2)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+3) .topic-icon{background:var(--topic-color-3)}.agent_topics-panel .topic-item:not(.add-topic-btn):nth-child(4n+4) .topic-icon{background:var(--topic-color-4)}.agent_history-panel{flex:1;background:var(--bg-elevated);border-radius:var(--border-radius);border:1px solid var(--border-color);display:flex;flex-direction:column;position:relative;min-width:0}.agent_history-panel .history-header{background:var(--header-bg);color:var(--text-on-primary);padding:15px 20px;display:flex;justify-content:space-between;align-items:center}.agent_history-panel .history-title{font-size:var(--text-lg);font-weight:600;display:flex;align-items:center;gap:10px}.agent_history-panel .history-header-actions{display:flex;align-items:center;gap:10px}.agent_history-panel .history-search{padding:8px 15px;border-radius:20px;border:none;width:250px;font-size:.9rem;background:#ffffffe6;box-shadow:0 2px 4px #0000001a;color:var(--text-primary)}.agent_history-panel .history-search:focus{background:var(--bg-elevated);box-shadow:0 4px 12px #00000026;outline:none}.agent_history-panel .role-selector{padding:8px 15px;border-radius:20px;border:1px solid rgba(255,255,255,.3);font-size:.9rem;background:#ffffff1a;color:var(--text-on-primary)}.agent_history-panel .history-content{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:20px;min-height:0;background:var(--bg-secondary)}.agent_history-panel .history-item{padding:15px;border-radius:8px;background:var(--bg-elevated);border:1px solid var(--border-color);box-shadow:0 1px 3px #0000000a;border-left:3px solid var(--primary-color)}.agent_history-panel .history-item-header{display:flex;justify-content:space-between;margin-bottom:10px;color:var(--text-tertiary);font-size:.9rem}.agent_history-panel .history-item-content{line-height:1.6}.agent_history-panel .history-item-content img{max-width:100%;border-radius:8px;margin-top:10px}.agent_history-panel .history-item-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}.agent_history-panel .history-action-btn{background:#4361ee1a;border:1px solid rgba(67,97,238,.3);color:var(--primary-color);padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;transition:var(--transition)}.agent_history-panel .history-action-btn:hover{background:#4361ee33}.agent_history-panel .chat-navigation{position:absolute;bottom:90px;right:25px;display:flex;flex-direction:column;gap:10px;z-index:10}.agent_history-panel .chat-nav-btn{width:40px;height:40px;border-radius:50%;background-color:var(--primary-color);color:var(--text-on-primary);border:none;cursor:pointer;box-shadow:0 2px 10px #0003;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:1rem}.agent_history-panel .chat-nav-btn:hover{background-color:var(--primary-hover);transform:scale(1.1)}.agent_history-panel .chat-nav-btn:disabled{opacity:.5;cursor:not-allowed}.agent_history-panel .chat-input-area{padding:15px 20px;border-top:1px solid var(--border-color);background:linear-gradient(to bottom,transparent,var(--bg-secondary));display:flex;flex-direction:column;gap:10px;flex-shrink:0}.agent_history-panel .input-controls{display:flex;align-items:flex-end;gap:10px}.agent_history-panel .chat-textarea{flex:1;border:2px solid var(--border-color);padding:10px 15px;font-family:inherit;font-size:var(--text-base);line-height:1.5;resize:vertical;transition:var(--transition);background:var(--bg-primary);color:var(--text-primary);border-radius:var(--border-radius)}.agent_history-panel .chat-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px #5b66f51a}.agent_history-panel .chat-action-btn{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:var(--transition);background:var(--gray-100);color:var(--text-secondary);flex-shrink:0}.agent_history-panel .chat-action-btn:hover{background:var(--gray-200);transform:translateY(-2px)}.agent_history-panel .chat-action-btn.send{background-color:var(--primary-color);color:var(--text-on-primary)}.agent_history-panel .chat-action-btn.send:hover{background-color:var(--secondary-color)}.agent_history-panel .attachment-preview-container{display:flex;gap:8px;flex-wrap:wrap;max-height:100px;overflow-y:auto}.agent_history-panel .attachment-preview-item{background:var(--bg-tertiary);padding:5px 12px;border-radius:15px;font-size:.85rem;display:inline-flex;align-items:center;gap:8px;color:var(--text-primary);animation:fadeIn .3s ease}.agent_history-panel .attachment-preview-item i{color:var(--primary-color)}.agent_history-panel .remove-attachment-btn{cursor:pointer;font-weight:700;color:var(--text-tertiary);background:none;border:none;font-size:1.2rem;line-height:1;padding:0 2px;transition:var(--transition)}.agent_history-panel .remove-attachment-btn:hover{color:var(--danger-color);transform:scale(1.2)}.agent_history-panel .hint-panel{padding:20px;margin:-5px 0 15px;border-radius:8px;background-color:var(--bg-secondary);border:1px solid var(--border-color);display:flex;flex-direction:column;gap:15px;color:var(--text-secondary);opacity:0;animation:fadeIn .5s forwards}.agent_history-panel .hint-panel-header{display:flex;align-items:center;gap:12px}.agent_history-panel .hint-panel-avatar{width:32px;height:32px;border-radius:50%;background-color:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;flex-shrink:0}.agent_history-panel .hint-panel-title{font-weight:700;color:var(--text-primary)}.agent_history-panel .hint-panel-content{padding-left:44px;font-size:14px;line-height:1.6}.settings-nav-panel{width:280px;flex-shrink:0;background:var(--bg-elevated);border:1px solid var(--border-color);border-radius:var(--border-radius);box-shadow:var(--shadow-sm);display:flex;flex-direction:column}.settings-nav-header{padding:20px;border-bottom:1px solid var(--border-color)}.settings-nav-header h3{font-size:var(--text-xl);color:var(--text-primary)}.settings-nav-list{padding:10px;overflow-y:auto;flex:1}.settings-nav-group{margin-bottom:20px}.settings-nav-group-title{padding:10px;font-size:var(--text-sm);font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}.add-item-btn{width:calc(100% - 20px);margin:0 10px 10px;padding:8px;background:var(--primary-light);color:var(--primary-color);border:1px dashed var(--primary-color);border-radius:6px;cursor:pointer;text-align:center;font-weight:600;transition:var(--transition)}.add-item-btn:hover{background:var(--primary-color);color:var(--text-on-primary);border-style:solid}.settings-nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:6px;cursor:pointer;transition:background-color .2s ease,color .2s ease;color:var(--text-secondary);font-weight:500;margin-bottom:4px}.settings-nav-item:hover{background-color:var(--bg-secondary);color:var(--text-primary)}.settings-nav-item.active{background-color:var(--primary-color);color:var(--text-on-primary);box-shadow:0 4px 8px #5b66f533}.settings-nav-item i,.settings-nav-item.active i{color:inherit;width:20px;text-align:center}.settings-detail-panel{flex:1;min-width:0;height:100%;display:flex;flex-direction:column}#settings_detailContent{flex-grow:1;overflow-y:auto;padding:25px}.placeholder-content{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center}.placeholder-content i{color:var(--gray-300)}.placeholder-content p{margin-top:15px;color:var(--text-tertiary)}.settings-section{margin-bottom:30px;max-width:600px}.settings-section-title{font-size:var(--text-xl);color:var(--text-primary);border-bottom:2px solid var(--primary-light);padding-bottom:10px;margin-bottom:20px;font-weight:600}.settings-detail-footer{margin-top:30px;padding-top:20px;border-top:1px solid var(--border-color)}.tags-input-container{display:flex;flex-direction:column;border:1px solid var(--border-color);border-radius:6px;padding:5px;background:var(--bg-primary)}.tags-input-container:focus-within{border-color:var(--primary-color);box-shadow:0 0 0 3px #5b66f51a}.tags-list{display:flex;flex-wrap:wrap;gap:8px;list-style:none;padding:5px}.tags-list li{background-color:var(--primary-color);color:var(--text-on-primary);padding:6px 12px;border-radius:20px;font-size:var(--text-sm);display:flex;align-items:center;gap:8px}.remove-tag-btn{background:none;border:none;color:var(--text-on-primary);cursor:pointer;font-size:1.2em;line-height:1;opacity:.7;padding:0}.remove-tag-btn:hover{opacity:1}.config-tags-input{border:none!important;box-shadow:none!important;flex-grow:1;padding:8px 7px!important}.config-tags-input:focus{outline:none}.form-checkbox-label{display:inline-flex;align-items:center;cursor:pointer;gap:10px}.form-checkbox-label input[type=checkbox]{width:1.2em;height:1.2em}.file-input{display:none}.hidden-session{transform:translate(-325px);opacity:0;width:0;overflow:hidden}.session-item-details{margin-bottom:8px;list-style:none}.session-item-details summary{list-style:none;cursor:pointer;outline:none;padding:12px 15px;border-radius:6px;background:var(--bg-elevated);border:1px solid rgba(0,0,0,.06);box-shadow:0 1px 2px #0000000a;transition:var(--transition);position:relative}.session-item-details summary::-webkit-details-marker{display:none}.session-item-details summary:hover{background:var(--bg-elevated);box-shadow:0 4px 8px #00000014;transform:translate(3px)}.session-item-details summary.active{background:var(--primary-light);border-color:var(--primary-color);box-shadow:0 4px 12px #5b66f526;font-weight:600}.session-item-details summary .name:before{content:"";font-family:"Font Awesome 6 Free";font-weight:900;margin-right:10px;transition:transform .2s ease-in-out;display:inline-block;color:var(--text-tertiary)}.session-item-details[open]>summary .name:before{transform:rotate(90deg)}@keyframes highlight{0%{background:#fff9c4}to{background:linear-gradient(120deg,#a1c4fd,#c2e9fb)}}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes slide-in{0%{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}@keyframes pulse-error{0%{box-shadow:0 0 #ef444466}to{box-shadow:0 0 0 5px #ef444400}}@keyframes pulse-alert{0%{opacity:.7}to{opacity:1}}@media (max-width: 1200px){body{flex-direction:column;height:auto;min-height:100vh}.sidebar{position:relative;width:100%;min-height:auto;flex-direction:row;align-items:center}.app-nav{flex-direction:row;padding:15px;flex:1;justify-content:center;background:#0000001a;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.app-nav-btn{margin:0 4px}.main-content{margin-left:0}.main-layout{flex-direction:column}.session-sidebar,.agent_topics-panel{width:100%;max-width:100%;max-height:40vh}.app-container{min-width:100%}}@media (max-width: 768px){.panel-header{flex-direction:column;align-items:flex-start;gap:10px;height:auto;padding:10px}.panel-header .panel-title{text-align:left}.panel-actions{width:100%;justify-content:space-between;flex-wrap:wrap}.app-nav{flex-wrap:wrap}}.cloze.highlight-review{box-shadow:0 0 0 3px #ffa500b3;border-radius:4px;transition:box-shadow .3s ease-in-out}</style>
</head>
<body>
    <!-- 全局布局: 左侧导航栏 -->
    <div class="sidebar">
        
        <nav class="app-nav">
            <a href="#" class="app-nav-btn active" data-view="anki" id="nav-anki" title="Anki 笔记">
                <i class="fas fa-layer-group"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="task" id="nav-task" title="任务管理">
                <i class="fas fa-book"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="agent" id="nav-agent" title="AI角色">
                <i class="fas fa-robot"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="settings" id="nav-settings" title="设置">
                <i class="fas fa-cog"></i>
            </a>
        </nav>
    </div>

    <!-- 全局布局: 主内容区域 -->
    <div class="main-content">
        <div class="content-wrapper">

            <!-- ====================================================== -->
            <!--                  Anki 笔记视图                      -->
            <!-- ====================================================== -->
            <div id="anki-view" class="main-layout" style="display: none;">
                <div class="session-sidebar anki_session-sidebar">
                    <div class="session-header">
                        <div class="session-title" id="anki_sessionTitleContainer">
                            <span><i class="fas fa-layer-group"></i> 会话管理</span>
                        </div>
                        <div class="session-controls">
                            <button id="anki_newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                            <button id="anki_newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                            <button id="anki_openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                            <button id="anki_moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                            <button id="anki_deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="select-controls">
                            <label class="select-all"><input type="checkbox" id="anki_selectAllCheckbox"> 全选</label>
                        </div>
                        <div class="current-folder" id="anki_currentFolderContainer"></div>
                    </div>
                    <div class="session-content">
                        <div class="session-list-container">
                            <ul class="session-list" id="anki_sessionList"></ul>
                            <div class="empty-session" id="anki_emptySession">
                                <i class="fas fa-folder-open"></i>
                                <p>没有打开的会话</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-container">
                    <div class="panel editor-preview-panel" id="anki_editorPreviewPanel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                                <button id="anki_toggleSessionBtn" class="panel-btn" title="显示/隐藏会话栏"><i class="fas fa-bars"></i></button>
                                <button id="anki_toggleEditPreviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-book-open"></i> Preview</button>
                            </div>
                            <div class="panel-title"><i class="fas fa-edit"></i> Anki 编辑器</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="anki_startReviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 待办 (<span id="anki_reviewCount">0</span>)</button>
                                    <button id="anki_reviewOptionsBtn" class="panel-btn dropdown-toggle"><i class="fas fa-chevron-down"></i></button>
                                    <div id="anki_reviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                        <a href="#" id="anki_customStudyBtn"><i class="fas fa-wrench"></i> 自定义待办...</a>
                                        <a href="#" id="anki_showStatsBtn"><i class="fas fa-chart-line"></i> 统计</a>
                                    </div>
                                </div>
                                <button id="anki_clozeNavUpBtn" class="panel-btn" title="上一个 Cloze"><i class="fas fa-arrow-up"></i></button>
                                <button id="anki_clozeNavDownBtn" class="panel-btn" title="下一个 Cloze"><i class="fas fa-arrow-down"></i></button>
                                <button id="anki_toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏"><i class="fas fa-eye-slash"></i></button>
                                <button id="anki_invertClozeBtn" class="panel-btn" title="反向显示/隐藏"><i class="fas fa-random"></i></button>
                                <button id="anki_saveBtn" class="panel-btn panel-btn-text" title="保存"><i class="fas fa-save"></i></button>
                                <button id="anki_exportFileBtn" class="panel-btn panel-btn-text" title="导出"><i class="fas fa-download"></i></button>
                                <button id="anki_printPreviewBtn" class="panel-btn panel-btn-text" title="打印预览内容" disabled><i class="fas fa-print"></i></button>
                                <button id="anki_toggleEditorBtn" class="panel-btn collapse-btn" title="收起/展开编辑器"><i class="fas fa-chevron-up"></i></button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="editor-sub-toolbar" id="anki_editorToolbar">
                                <button id="anki_clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
                                <button id="anki_boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
                                <button id="anki_italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
                                <button id="anki_insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
                                <button id="anki_codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
                                <button id="anki_linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
                                <button id="anki_audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
                            </div>
                            <div class="editor-container" id="anki_editorContainer">
                                <textarea id="anki_editor" class="editor"></textarea>
                                <div id="anki_preview"></div>
                            </div>
                            <div class="mode-indicator">
                                <div class="mode-dot active" id="anki_editModeDot" title="编辑模式"></div>
                                <div class="mode-dot" id="anki_previewModeDot" title="预览模式"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                任务/错题本视图 (重命名)               -->
            <!-- ====================================================== -->
            <div id="task-view" class="main-layout" style="display: none;">
                <div class="session-sidebar task_session-sidebar">
                    <div class="session-header">
                        <div class="session-title"><span><i class="fas fa-book-open"></i> 任务筛选与导航</span></div>
                        <div class="session-controls">
                            <select id="task_subjectFilter"></select>
                            <button id="task_refreshBtn" class="session-btn" title="刷新"><i class="fas fa-sync-alt"></i></button>
                            <button id="task_newFileBtn" class="session-btn" title="新建任务文件"><i class="fas fa-file-alt"></i></button>
                            <button id="task_loadYamlBtn" class="session-btn" title="导入YAML文件"><i class="fas fa-file-upload"></i></button>
                            <input type="file" id="task_yamlFileInput" accept=".yml,.yaml" style="display: none;">
                        </div>
                    </div>
                    <div class="session-content">
                        <div class="filter-group" data-type="tags">
                            <div class="tag-list" id="task_tagFilterContainer"></div>
                        </div>
                        <div class="filter-group" data-type="reasons">
                            <div class="tag-list" id="task_reasonFilterContainer"></div>
                        </div>
                        <div class="list-header"><i class="fas fa-list-ul"></i> 待待办列表</div>
                        <ul class="session-list" id="task_list"></ul>
                        <div class="pagination" id="task_paginationContainer"></div>
                    </div>
                </div>

                <div class="app-container">
                    <div id="task_statsDashboard" class="stats-dashboard-inline"></div>
                    <div id="task_editorPanel" class="panel editor-panel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                                <button id="task_toggleSessionBtn" class="panel-btn" title="显示/隐藏筛选栏"><i class="fas fa-bars"></i></button>
                            </div>
                            <div class="panel-title"><i class="fas fa-code"></i> YAML 编辑器</div>
                            <div class="panel-actions">
                                <button id="task_saveBtn" class="panel-btn" title="保存并刷新"><i class="fas fa-save"></i></button>
                                <button id="task_exportBtn" class="panel-btn" title="导出YAML"><i class="fas fa-download"></i></button>
                                <button id="task_collapseBtn" class="panel-btn collapse-btn" title="收起/展开"><i class="fas fa-chevron-up"></i></button>
                            </div>
                        </div>
                        <div class="panel-content"><textarea id="task_yamlEditor"></textarea></div>
                    </div>
                    <div id="task_previewPanel" class="panel preview-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-eye"></i> 任务预览</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="task_startReviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 开始待办</button>
                                </div>
                            </div>
                        </div>
                        <div class="panel-content"><div id="task_previewContainer"></div></div>
                    </div>
                </div>
            </div>
            
            <!-- ====================================================== -->
            <!--                  AI Agent 视图                       -->
            <!-- ====================================================== -->
            <div id="agent-view" class="main-layout" style="display: none;">
                <div class="topics-panel agent_topics-panel">
                    <div class="topics-header">
                        <div class="header-title-group"><i class="fas fa-book"></i> 聊天主题</div>
                        <div class="header-actions-group">
                            <select id="agent_topicTagFilter" class="topic-filter-select"></select>
                            <button id="agent_editTopicBtn" class="topic-action-btn" title="重命名"><i class="fas fa-pencil-alt"></i></button>
                            <button id="agent_manageTopicsBtn" class="topic-action-btn" title="管理"><i class="fas fa-tasks"></i></button>
                        </div>
                    </div>
                    <div class="topics-batch-actions" id="agent_topicsBatchActions" style="display: none;">
                        <button id="agent_selectAllTopicsBtn" class="batch-action-btn">全选</button>
                        <button id="agent_deleteSelectedTopicsBtn" class="batch-action-btn danger">删除</button>
                        <button id="agent_cancelTopicSelectionBtn" class="batch-action-btn">取消</button>
                    </div>
                    <div class="topics-content"><ul class="topic-list" id="agent_topicList"></ul></div>
                </div>

                <div class="history-panel agent_history-panel">
                    <div class="history-header">
                        <div class="history-title">
                            <button id="agent_toggleTopicsBtn" class="panel-btn"><i class="fas fa-bars"></i></button>
                            <i class="fas fa-comments"></i>
                            <span id="agent_historyHeaderTitle">对话记录</span>
                        </div>
                        <div class="history-header-actions">
                            <input type="text" id="agent_historySearch" class="history-search" placeholder="搜索...">
                            <select id="agent_conversationRoleSelector" class="role-selector"></select>
                        </div>
                    </div>
                    <div class="history-content" id="agent_historyContent"></div>
                    <div class="chat-navigation">
                        <button id="agent_chatNavUp" class="chat-nav-btn"><i class="fas fa-arrow-up"></i></button>
                        <button id="agent_chatNavDown" class="chat-nav-btn"><i class="fas fa-arrow-down"></i></button>
                    </div>
                    <div class="chat-input-area" id="agent_chatInputArea">
                        <div class="attachment-preview-container" id="agent_attachmentPreview"></div>
                        <div class="input-controls">
                            <textarea id="agent_chatInput" class="chat-textarea"></textarea>
                            <input type="file" id="agent_attachmentInput" multiple style="display: none;">
                            <button id="agent_attachFileBtn" class="chat-action-btn"><i class="fas fa-paperclip"></i></button>
                            <button id="agent_sendMessageBtn" class="chat-action-btn send"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                  设置视图                           -->
            <!-- ====================================================== -->
            <div id="settings-view" class="main-layout" style="display: none;">
                <!-- 内容由JS动态填充 -->
            </div>

        </div> <!-- .content-wrapper 结束 -->
    </div> <!-- .main-content 结束 -->

    <!-- ====================================================== -->
    <!--                  全局模态框与模板                      -->
    <!-- ====================================================== -->

    <!-- Anki 模块的音频播放器 -->
    <div class="audio-controls" id="anki_audioControls">
        <div class="audio-title" id="anki_audioTitle"></div>
        <div class="audio-progress"><div class="audio-progress-bar" id="anki_audioProgressBar"></div></div>
        <div class="audio-buttons">
            <button id="anki_playBtn" class="audio-btn"><i class="fas fa-play"></i> 播放</button>
            <button id="anki_pauseBtn" class="audio-btn"><i class="fas fa-pause"></i> 暂停</button>
            <button id="anki_stopBtn" class="audio-btn"><i class="fas fa-stop"></i> 停止</button>
        </div>
    </div>
    
	<input type="file" id="anki_fileInput" style="display: none;" accept=".md, .txt" multiple>

    <!-- Anki 模块的移动文件模态框 -->
    <div class="move-modal" id="anki_moveModal">
        <div class="move-modal-content">
            <div class="move-modal-header">
                <div class="move-modal-title">移动到目录</div>
                <button class="move-modal-close" id="anki_closeMoveModalBtn">×</button>
            </div>
            <p>选择目标目录：</p>
            <div class="folder-list" id="anki_folderList"></div>
            <div class="move-modal-actions">
                <button class="move-modal-btn cancel" id="anki_cancelMoveBtn">取消</button>
                <button class="move-modal-btn confirm" id="anki_confirmMoveBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- Anki 模块的自定义待办模态框 -->
    <div class="modal-overlay" id="anki_customStudyModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>自定义待办</h2>
                <button class="modal-close" id="anki_customStudyCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <form id="anki_customStudyForm">
                    <!-- [MODIFIED] 添加 name 属性 -->
                    <div class="form-group">
                        <label for="anki_filterByFile">按文件/目录筛选:</label>
                        <select id="anki_filterByFile" name="anki_filterByFile" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>按卡片状态筛选:</label>
                        <div class="form-checkbox-group">
                            <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                            <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                            <label><input type="checkbox" name="cardState" value="review" checked> 待办中</label>
                            <!-- [恢复] 增加了 "重学中" 选项 -->
                            <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                        </div>
                    </div>
                    <!-- [恢复] 增加了 "按最后一次待办时间筛选" 的完整功能块 -->
                    <div class="form-group">
                        <label for="anki_filterByLastReview">按最后一次待办时间筛选:</label>
                        <select id="anki_filterByLastReview" name="anki_filterByLastReview" class="form-control">
                            <option value="any">任何时间</option>
                            <option value="last7days">最近7天内</option>
                            <option value="last30days">最近30天内</option>
                            <option value="over30days">超过30天未待办</option>
                            <option value="never">从未待办过 (新卡片)</option>
                        </select>
                    </div>
                    <!-- [MODIFIED] 添加 name 属性 -->
                    <div class="form-group">
                        <label for="anki_maxCards">最大卡片数量:</label>
                        <input type="number" id="anki_maxCards" name="anki_maxCards" class="form-control" value="50" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="anki_customStudyCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="anki_startCustomStudyBtn" form="anki_customStudyForm">开始</button>
            </div>
        </div>
    </div>

    <!-- Anki 模块的统计模态框 -->
    <div class="modal-overlay" id="anki_statsModal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header"><h2>待办统计</h2><button class="modal-close" id="anki_statsModalCloseBtn">×</button></div>
            <div class="modal-body"><p>近30天每日待办卡片数量</p><div class="chart-container"><canvas id="anki_statsChart"></canvas></div></div>
        </div>
    </div>
    
    <!-- 设置模块使用的模板 -->
    <template id="settings_layoutTemplate">
        <div class="settings-nav-panel">
            <div class="settings-nav-header"><h3><i class="fas fa-sliders-h"></i> 设置</h3></div>
            <div class="settings-nav-list" id="settings_navList"></div>
        </div>
        <div class="settings-detail-panel">
            <div class="panel" style="height: 100%;">
                <div class="panel-header">
                    <div id="settings_detailTitle" class="panel-title"></div>
                    <div class="panel-actions"><button id="settings_saveBtn" class="panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button></div>
                </div>
                <div id="settings_detailContent" class="panel-content" style="padding: 25px; overflow-y: auto;">
                     <div class="placeholder-content"><i class="fas fa-cogs fa-3x"></i><p>从左侧选择一个项目进行配置</p></div>
                </div>
            </div>
        </div>
    </template>

    <template id="settings_generalFormTemplate">
        <div data-id="general" data-type="general">
            <div class="settings-section">
                <h3 class="settings-section-title">外观与主题</h3>
                <div class="form-group"><label for="settings_themeSelector">选择主题</label><select id="settings_themeSelector" class="form-control">
                    <option value="">默认 (亮色)</option><option value="dark">暗黑</option><option value="large-font">大号字体</option><option value="larger-font">更大号字体</option>
                </select></div>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">数据与同步</h3>
                <div class="form-group"><label for="settings_autosaveInterval">自动保存间隔 (分钟)</label><input type="number" id="settings_autosaveInterval" class="form-control" min="0"></div>
                <div class="form-group"><label>数据库同步</label><div style="display: flex; gap: 15px;">
                    <button id="settings_exportDbBtn" class="btn-secondary"><i class="fas fa-download"></i> 导出数据</button>
                    <button id="settings_importDbBtn" class="btn-danger"><i class="fas fa-upload"></i> 导入数据</button>
                </div><input type="file" id="settings_importFileInput" accept=".json" style="display: none;"></div>
            </div>
        </div>
    </template>

    <template id="settings_apiConfigFormTemplate">
        <div data-type="apiConfig">
            <form id="settings_apiConfigFormDynamic" novalidate>
                <input type="hidden" class="config-id"><div class="form-group"><label>配置名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>提供商</label><select class="config-provider form-control" required></select></div>
                <div class="form-group"><label>API 地址</label><input type="url" class="config-apiUrl form-control"></div>
                <div class="form-group"><label>API Key</label><div class="input-group">
                    <input type="password" class="config-apiKey form-control"><button type="button" class="toggle-api-key-visibility input-group-btn"><i class="fas fa-eye"></i></button>
                </div></div>
                <div class="form-group"><label>Models (别名:模型名)</label><textarea class="config-models form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此配置</button></div>
            </form>
        </div>
    </template>

    <template id="settings_agentFormTemplate">
        <div data-type="agent">
            <form id="settings_agentFormDynamic" novalidate>
                <input type="hidden" class="config-id"><div class="form-group"><label>角色名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>头像 (2字符)</label><input type="text" class="config-avatar form-control" required maxlength="2"></div>
                <div class="form-group"><label>选择模型</label><select class="config-model form-control" required></select></div>
                <div class="form-group"><label>System Prompt</label><textarea class="config-systemPrompt form-control" rows="8"></textarea></div>
                <div class="form-group"><label>标签</label><div class="tags-input-container"><ul class="tags-list"></ul><input type="text" class="config-tags-input form-control"></div></div>
                <div class="form-group"><label class="form-checkbox-label"><input type="checkbox" class="config-sendHistory"> 发送历史上下文</label></div>
                <div class="form-group"><label>欢迎语 (可选)</label><textarea class="config-hint form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此角色</button></div>
            </form>
        </div>
    </template>
    <div class="footer">
        <p>© 2024 智能学习套件 | 数据保存在浏览器本地存储中</p>
    </div>

</body>
</html>
