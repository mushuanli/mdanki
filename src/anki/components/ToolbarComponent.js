// src/anki/components/ToolbarComponent.js

export class ToolbarComponent {
    constructor(store) {
        this.store = store;
        this.dom = {
            // ‰∏ªÂ∑•ÂÖ∑Ê†è
            toggleSessionBtn: document.getElementById('anki_toggleSessionBtn'),
            toggleEditPreviewBtn: document.getElementById('anki_toggleEditPreviewBtn'),
            saveBtn: document.getElementById('anki_saveBtn'),
            startReviewBtn: document.getElementById('anki_startReviewBtn'),
            reviewCount: document.getElementById('anki_reviewCount'),
            customStudyBtn: document.getElementById('anki_customStudyBtn'),
            showStatsBtn: document.getElementById('anki_showStatsBtn'),
            clozeNavUpBtn: document.getElementById('anki_clozeNavUpBtn'),
            clozeNavDownBtn: document.getElementById('anki_clozeNavDownBtn'),
            toggleVisibilityClozeBtn: document.getElementById('anki_toggleVisibilityClozeBtn'),
            invertClozeBtn: document.getElementById('anki_invertClozeBtn'),
            
            // [NEW] Add AI button reference
            aiBtn: document.getElementById('anki_aiBtn'),
            
            exportFileBtn: document.getElementById('anki_exportFileBtn'),
            printPreviewBtn: document.getElementById('anki_printPreviewBtn'),
            
            // ÁºñËæëÂô®Â≠êÂ∑•ÂÖ∑Ê†è
            editorToolbar: document.getElementById('anki_editorToolbar'), // <--- 1. Ê∑ªÂä†Ëøô‰∏ÄË°å
            clozeBtn: document.getElementById('anki_clozeBtn'),
            boldBtn: document.getElementById('anki_boldBtn'),
            italicBtn: document.getElementById('anki_italicBtn'),
            codeBtn: document.getElementById('anki_codeBtn'),
            linkBtn: document.getElementById('anki_linkBtn'),
            audioBtn: document.getElementById('anki_audioBtn'),
            insertLinebreakBtn: document.getElementById('anki_insertLinebreakBtn'),

            // [NEW] Ê∑ªÂä†ÂØπÊ®°ÂºèÊåáÁ§∫Âô®ÁÇπÁöÑÂºïÁî®
            editModeDot: document.getElementById('anki_editModeDot'),
            previewModeDot: document.getElementById('anki_previewModeDot'),
        };
        
        // ËÆ¢ÈòÖÊâÄÊúâ‰∏éÂ∑•ÂÖ∑Ê†èÊåâÈíÆÁä∂ÊÄÅÁõ∏ÂÖ≥ÁöÑ state
        this.unsubscribe = store.subscribe(
            this.handleStateChange.bind(this),
        ['viewMode', 'isSaving', 'isSidebarVisible', 'reviewCount', 'areAllClozesVisible', 'currentSessionId', 'sessions'] // Ê∑ªÂä†Ëøô‰∏§‰∏™
        );
        this.setupEventListeners();
    }

    setupEventListeners() {
        // [ADDED] Ê∑ªÂä†ÂÖ®Â±ÄÂø´Êç∑ÈîÆÁõëÂê¨
        this.handleGlobalKeyDown = this.handleGlobalKeyDown.bind(this);
        document.addEventListener('keydown', this.handleGlobalKeyDown);

        // ‰∏ªÂ∑•ÂÖ∑Ê†è‰∫ã‰ª∂
        this.dom.toggleSessionBtn.addEventListener('click', () => this.store.toggleSidebar());
        this.dom.toggleEditPreviewBtn.addEventListener('click', () => this.store.setViewMode(this.store.getState().viewMode === 'edit' ? 'preview' : 'edit'));
        this.dom.saveBtn.addEventListener('click', () => this.store.saveCurrentSession());
        this.dom.startReviewBtn.addEventListener('click', () => this.store.startReviewSession());
        this.dom.customStudyBtn.addEventListener('click', (e) => { e.preventDefault(); this.store.showCustomStudyModal(); });
        this.dom.showStatsBtn.addEventListener('click', (e) => { e.preventDefault(); this.store.showStatsModal(); });
        this.dom.clozeNavUpBtn.addEventListener('click', () => this.store.navigateToCloze(-1));
        this.dom.clozeNavDownBtn.addEventListener('click', () => this.store.navigateToCloze(1));
        this.dom.toggleVisibilityClozeBtn.addEventListener('click', () => this.store.toggleAllClozesVisibility());
        this.dom.invertClozeBtn.addEventListener('click', () => this.store.invertAllClozesVisibility());

        // ++++++++++++++++ ÁÆÄÂåñ AI ÊåâÈíÆ‰∫ã‰ª∂Â§ÑÁêÜ ++++++++++++++++
        // ÁßªÈô§ mousedown ‰∫ã‰ª∂ÔºåÂõ†‰∏∫ÈÄâÂå∫Â∑≤ÁªèÂú® EditorComponent ‰∏≠ÂÆûÊó∂‰øùÂ≠ò‰∫Ü
        this.dom.aiBtn.addEventListener('click', (e) => this.handleAiButtonClick(e));

        this.dom.exportFileBtn.addEventListener('click', () => this.handleExportFile());
        this.dom.printPreviewBtn.addEventListener('click', () => this.handlePrintPreview());

        // ÁºñËæëÂô®Â≠êÂ∑•ÂÖ∑Ê†è‰∫ã‰ª∂
        const editorEl = document.getElementById('anki_editor');
        const getSelection = () => ({ selectionStart: editorEl.selectionStart, selectionEnd: editorEl.selectionEnd });

        this.dom.clozeBtn.addEventListener('click', () => this.store.insertCloze(getSelection()));
        this.dom.boldBtn.addEventListener('click', () => this.store.wrapEditorSelection({ prefix: '**', ...getSelection() }));
        this.dom.italicBtn.addEventListener('click', () => this.store.wrapEditorSelection({ prefix: '*', ...getSelection() }));
        this.dom.codeBtn.addEventListener('click', () => this.store.wrapEditorSelection({ prefix: '`', ...getSelection() }));
        this.dom.insertLinebreakBtn.addEventListener('click', () => this.store.wrapEditorSelection({ prefix: '¬∂', suffix: '', ...getSelection() }));
        this.dom.linkBtn.addEventListener('click', () => this.store.wrapEditorSelection({ prefix: '[', suffix: `](${prompt('URL:', 'https://')})`, ...getSelection() }));
        this.dom.audioBtn.addEventListener('click', () => this.store.insertAudioPrompt(getSelection()));
    }

    /**
     * [ADDED] Â§ÑÁêÜÂÖ®Â±ÄÈîÆÁõòÂø´Êç∑ÈîÆÔºåÂ∞§ÂÖ∂ÊòØ Ctrl+I ÂàõÂª∫ Cloze„ÄÇ
     * @param {KeyboardEvent} e 
     */
    handleGlobalKeyDown(e) {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'i') {
            const state = this.store.getState();
            
            // Á°Æ‰øùÂè™Âú®ÁºñËæëÊ®°Âºè‰∏ãÔºå‰∏îÁÑ¶ÁÇπÂú®ÁºñËæëÂô®‰∏äÊó∂ÊâçÂ§ÑÁêÜ
            if (state.viewMode === 'edit' && document.activeElement.id === 'anki_editor') {
                e.preventDefault(); 
                const editorEl = document.getElementById('anki_editor');
                const { selectionStart, selectionEnd } = editorEl;

                if (selectionStart !== selectionEnd) {
                    this.store.createOrUpdateClozeFromSelection({ selectionStart, selectionEnd });
                }
            }
        }
    }

    // ++++++++++++++++ ‰øÆÊîπ AI ÊåâÈíÆÁÇπÂáªÂ§ÑÁêÜÈÄªËæëÔºàÂÖ≥ÈîÆ‰øÆÂ§çÔºâ ++++++++++++++++
    handleAiButtonClick(e) {
        console.log('ü§ñ [ToolbarComponent] AI button clicked');
        e.preventDefault();
        
        let content = '';
        let source = '';
        const state = this.store.getState();
        let selection = null;

        // [ÈáçÊûÑ] Á≠ñÁï•1ÔºöÊ†πÊçÆËßÜÂõæÊ®°ÂºèÔºå‰ªé store Ëé∑ÂèñÂØπÂ∫îÁöÑÈÄâÂå∫‰ø°ÊÅØ
        if (state.viewMode === 'edit') {
            selection = state.editorSelection;
            source = 'Editor Selection from Store';
        } else { // viewMode === 'preview'
            selection = state.previewSelection;
            source = 'Preview Selection from Store';
        }

        if (selection && selection.hasSelection) {
            content = selection.text;
            console.log(`‚úÖ [ToolbarComponent] Using selection from: ${source}`);
        }

        // Á≠ñÁï•2Ôºö‰ΩøÁî®Êï¥‰∏™ÁºñËæëÂô®ÂÜÖÂÆπ‰Ωú‰∏∫ÂêéÂ§á
        if (!content) {
            content = state.editorContent.trim();
            source = 'Full Content Fallback';
            console.log('‚ö†Ô∏è [ToolbarComponent] No selection found, using full content as fallback');
        }

        console.log('ü§ñ [ToolbarComponent] Final content decision:', {
            source,
            contentLength: content.length,
            contentPreview: content.substring(0, 100) + (content.length > 100 ? '...' : '')
        });

        if (!content) {
            console.warn('ü§ñ [ToolbarComponent] No content to send to AI');
            alert("Ê≤°ÊúâÂÜÖÂÆπÂèØ‰ª•ÂèëÈÄÅÁªô AI„ÄÇËØ∑ÂÖàÈÄâÊã©ÊñáÊú¨ÊàñÁ°Æ‰øùÁºñËæëÂô®‰∏≠ÊúâÂÜÖÂÆπ„ÄÇ");
            return;
        }

        // Call the global controller to show the popup
        if (window.appController && typeof window.appController.showAiPopup === 'function') {
            console.log('ü§ñ [ToolbarComponent] Calling appController.showAiPopup with content from:', source);
            window.appController.showAiPopup(content);
        } else {
            console.error("ü§ñ [ToolbarComponent] appController is not available to show AI popup.");
        }
    }


    handleExportFile() {
        const state = this.store.getState();
        if (!state.currentSessionId) {
            alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ËøõË°åÂØºÂá∫„ÄÇ");
            return;
        }

        const currentSession = state.sessions.find(s => s.id === state.currentSessionId);
        if (!currentSession) return;

        const content = state.editorContent;
        const filename = `${currentSession.name}.md`;
        
        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    
    // +++ Êñ∞Â¢ûÔºöÊâìÂç∞È¢ÑËßàÂ§ÑÁêÜÂáΩÊï∞ (ÈÄªËæë‰ªéÊóß‰ª£Á†ÅËøÅÁßª)
    handlePrintPreview() {
        const previewContent = this.store.getState().previewContent;
        if (!previewContent) return;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>ÊâìÂç∞È¢ÑËßà</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <link rel="stylesheet" href="./styles.css">
            <style> 
                @media print { 
                    body { margin: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; } 
                    .cloze-actions, .media-icon { display: none !important; } 
                    .cloze.hidden .cloze-content, .cloze .cloze-content { display: inline !important; visibility: visible !important; color: black !important; } 
                    .cloze .placeholder { display: none !important; } 
                    .cloze { -webkit-print-color-adjust: exact; print-color-adjust: exact; border-bottom: 1px dotted #ccc; } 
                    .cloze.hidden { background-color: #f0f0f0 !important; }
                } 
                body { font-family: sans-serif; } 
                .preview { display: block !important; padding: 20px; }
            </style></head><body>
            <div class="preview">${previewContent}</div>
            <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
            <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
            <script> 
                window.MathJax = { 
                    startup: { 
                        pageReady: () => { 
                            return window.MathJax.startup.defaultPageReady().then(() => { 
                                setTimeout(() => { // Á≠âÂæÖÊ∏≤ÊüìÁ®≥ÂÆö
                                    window.print(); 
                                    window.close(); 
                                }, 500);
                            }); 
                        } 
                    } 
                }; 
            </script>
            </body></html>
        `);
        printWindow.document.close();
    }


    handleStateChange(newState, oldState) { // ‰øÆÂ§çÔºöÊ∑ªÂä† oldState ÂèÇÊï∞
        // Êõ¥Êñ∞ËßÜÂõæÂàáÊç¢ÊåâÈíÆ
        const icon = '<i class="fas fa-book-open"></i>';
        this.dom.toggleEditPreviewBtn.innerHTML = `${icon} ${newState.viewMode === 'edit' ? 'Preview' : 'Edit'}`;

        // +++ 2. Ê∑ªÂä†‰ª•‰∏ãÈÄªËæëÊù•ÊéßÂà∂Â≠êÂ∑•ÂÖ∑Ê†è +++
        if (this.dom.editorToolbar) {
            this.dom.editorToolbar.style.display = newState.viewMode === 'edit' ? 'flex' : 'none';
        }
        // +++++++++++++++++++++++++++++++++++++++

        // Êõ¥Êñ∞‰øùÂ≠òÊåâÈíÆÁä∂ÊÄÅ
        this.dom.saveBtn.disabled = newState.isSaving;
        this.dom.saveBtn.innerHTML = newState.isSaving 
            ? '<i class="fas fa-spinner fa-spin"></i> Saving...' 
            : '<i class="fas fa-save"></i> Save';
        
        // +++ Êñ∞Â¢ûÔºöÊ†πÊçÆËßÜÂõæÊ®°ÂºèÊõ¥Êñ∞ÊâìÂç∞ÊåâÈíÆÁöÑÁ¶ÅÁî®Áä∂ÊÄÅ
        this.dom.printPreviewBtn.disabled = newState.viewMode !== 'preview';

        // Êõ¥Êñ∞ÂæÖÂäûËÆ°Êï∞
        this.dom.reviewCount.textContent = newState.reviewCount;
        
        // Êõ¥Êñ∞‚ÄúÂÖ®ÈÉ®ÊòæÁ§∫/ÈöêËóè‚ÄùÊåâÈíÆÁöÑÂõæÊ†áÂíåÊ†áÈ¢ò
        if (newState.areAllClozesVisible) {
            this.dom.toggleVisibilityClozeBtn.innerHTML = '<i class="fas fa-eye"></i>';
            this.dom.toggleVisibilityClozeBtn.title = 'ÂÖ®ÈÉ®ÈöêËóè';
        } else {
            this.dom.toggleVisibilityClozeBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            this.dom.toggleVisibilityClozeBtn.title = 'ÂÖ®ÈÉ®ÊòæÁ§∫';
        }

        // Êõ¥Êñ∞‰æßËæπÊ†èÊòæÁ§∫Áä∂ÊÄÅ
        document.querySelector('.anki_session-sidebar').classList.toggle('hidden-session', !newState.isSidebarVisible);
        
        // ‰øÆÂ§çÔºöÊ≠£Á°ÆÊ£ÄÊü• oldState
        if (oldState && (newState.currentSessionId !== oldState.currentSessionId || 
            newState.sessions !== oldState.sessions)) {
            this.updatePanelTitle(newState);
        } else if (!oldState) {
            // ÂàùÂßãÂåñÊó∂Ê≤°Êúâ oldStateÔºåÁõ¥Êé•Êõ¥Êñ∞
            this.updatePanelTitle(newState);
        }

        // [NEW] Ê∑ªÂä†Êõ¥Êñ∞Ê®°ÂºèÊåáÁ§∫Âô®ÁöÑÈÄªËæë
        if (this.dom.editModeDot && this.dom.previewModeDot) {
            // ‰ΩøÁî® classList.toggle ÁöÑÁ¨¨‰∫å‰∏™ÂèÇÊï∞ (boolean) Êù•Á≤æÁ°ÆÊéßÂà∂Á±ªÁöÑÊ∑ªÂä†ÊàñÁßªÈô§
            this.dom.editModeDot.classList.toggle('active', newState.viewMode === 'edit');
            this.dom.previewModeDot.classList.toggle('active', newState.viewMode === 'preview');
        }

    }

// Êñ∞Â¢ûÊñπÊ≥ï
updatePanelTitle(state) {
    const panelTitle = document.getElementById('anki_panelTitle');
    if (!panelTitle) return;

    if (state.currentSessionId && state.sessions) {
        const session = state.sessions.find(s => s.id === state.currentSessionId);
        if (session) {
            panelTitle.innerHTML = `<i class="fas fa-edit"></i> ${session.name}`;
            return;
        }
    }
    panelTitle.innerHTML = '<i class="fas fa-edit"></i> Anki ÁºñËæëÂô®';
}

    destroy() {
        this.unsubscribe();
        // [ADDED] Âú®ÁªÑ‰ª∂ÈîÄÊØÅÊó∂ÁßªÈô§ÂÖ®Â±ÄÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÊ≥ÑÊºè
        document.removeEventListener('keydown', this.handleGlobalKeyDown);
    }
}