<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能学习套件</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script> 
    <!-- [新增] 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        loader: {load: ['[tex]/mhchem']},
        tex: {
          packages: {'[+]': ['mhchem']}
        },
        startup: {
          pageReady: () => {
            return window.MathJax.startup.defaultPageReady();
          }
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <!-- 全局布局: 左侧导航栏 -->
    <div class="sidebar">
        
        <nav class="app-nav">
            <a href="#" class="app-nav-btn active" data-view="anki" id="nav-anki" title="Anki 笔记">
                <i class="fas fa-layer-group"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="task" id="nav-task" title="任务管理">
                <i class="fas fa-book"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="agent" id="nav-agent" title="AI角色">
                <i class="fas fa-robot"></i>
            </a>
            <a href="#" class="app-nav-btn" data-view="settings" id="nav-settings" title="设置">
                <i class="fas fa-cog"></i>
            </a>
        </nav>
    </div>

    <!-- 全局布局: 主内容区域 -->
    <div class="main-content">
        <div class="content-wrapper">

            <!-- ====================================================== -->
            <!--                  Anki 笔记视图                      -->
            <!-- ====================================================== -->
            <div id="anki-view" class="main-layout" style="display: none;">
                <div class="session-sidebar anki_session-sidebar">
                    <div class="session-header">
                        <div class="session-title" id="anki_sessionTitleContainer">
                            <span><i class="fas fa-layer-group"></i> 会话管理</span>
                        </div>
                        <div class="session-controls">
                            <button id="anki_newFileBtn" class="session-btn" title="新建文件"><i class="fas fa-file"></i></button>
                            <button id="anki_newFolderBtn" class="session-btn" title="新建目录"><i class="fas fa-folder-plus"></i></button>
                            <button id="anki_openFileBtn" class="session-btn" title="打开文件"><i class="fas fa-folder-open"></i></button>
                            <button id="anki_moveSelectedBtn" class="session-btn" title="移动选中"><i class="fas fa-people-arrows"></i></button>
                            <button id="anki_deleteSelectedBtn" class="session-btn" title="删除选中"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="select-controls">
                            <label class="select-all"><input type="checkbox" id="anki_selectAllCheckbox"> 全选</label>
                        </div>
                        <div class="current-folder" id="anki_currentFolderContainer"></div>
                    </div>
                    <div class="session-content">
                        <div class="session-list-container">
                            <ul class="session-list" id="anki_sessionList"></ul>
                            <div class="empty-session" id="anki_emptySession">
                                <i class="fas fa-folder-open"></i>
                                <p>没有打开的会话</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-container">
                    <div class="panel editor-preview-panel" id="anki_editorPreviewPanel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                                <button id="anki_toggleSessionBtn" class="panel-btn" title="显示/隐藏会话栏"><i class="fas fa-bars"></i></button>
                                <button id="anki_toggleEditPreviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-book-open"></i> Preview</button>
                            </div>
                            <div class="panel-title"><i class="fas fa-edit"></i> Anki 编辑器</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="anki_startReviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 待办 (<span id="anki_reviewCount">0</span>)</button>
                                    <button id="anki_reviewOptionsBtn" class="panel-btn dropdown-toggle"><i class="fas fa-chevron-down"></i></button>
                                    <div id="anki_reviewDropdownMenu" class="dropdown-menu" style="display: none;">
                                        <a href="#" id="anki_customStudyBtn"><i class="fas fa-wrench"></i> 自定义待办...</a>
                                        <a href="#" id="anki_showStatsBtn"><i class="fas fa-chart-line"></i> 统计</a>
                                    </div>
                                </div>
                                <button id="anki_clozeNavUpBtn" class="panel-btn" title="上一个 Cloze"><i class="fas fa-arrow-up"></i></button>
                                <button id="anki_clozeNavDownBtn" class="panel-btn" title="下一个 Cloze"><i class="fas fa-arrow-down"></i></button>
                                <button id="anki_toggleVisibilityClozeBtn" class="panel-btn" title="全部隐藏"><i class="fas fa-eye-slash"></i></button>
                                <button id="anki_invertClozeBtn" class="panel-btn" title="反向显示/隐藏"><i class="fas fa-random"></i></button>
                                <button id="anki_saveBtn" class="panel-btn panel-btn-text" title="保存"><i class="fas fa-save"></i></button>
                                <button id="anki_exportFileBtn" class="panel-btn panel-btn-text" title="导出"><i class="fas fa-download"></i></button>
                                <button id="anki_printPreviewBtn" class="panel-btn panel-btn-text" title="打印预览内容" disabled><i class="fas fa-print"></i></button>
                                <button id="anki_toggleEditorBtn" class="panel-btn collapse-btn" title="收起/展开编辑器"><i class="fas fa-chevron-up"></i></button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="editor-sub-toolbar" id="anki_editorToolbar">
                                <button id="anki_clozeBtn" class="editor-btn" title="转换为Cloze"><i class="fas fa-square"></i></button>
                                <button id="anki_boldBtn" class="editor-btn" title="加粗"><i class="fas fa-bold"></i></button>
                                <button id="anki_italicBtn" class="editor-btn" title="斜体"><i class="fas fa-italic"></i></button>
                                <button id="anki_insertLinebreakBtn" class="editor-btn" title="插入换行符(¶)"><i class="fas fa-paragraph"></i></button>
                                <button id="anki_codeBtn" class="editor-btn" title="代码"><i class="fas fa-code"></i></button>
                                <button id="anki_linkBtn" class="editor-btn" title="链接"><i class="fas fa-link"></i></button>
                                <button id="anki_audioBtn" class="editor-btn" title="编辑声音"><i class="fas fa-music"></i></button>
                            </div>
                            <div class="editor-container" id="anki_editorContainer">
                                <textarea id="anki_editor" class="editor"></textarea>
                                <div id="anki_preview"></div>
                            </div>
                            <div class="mode-indicator">
                                <div class="mode-dot active" id="anki_editModeDot" title="编辑模式"></div>
                                <div class="mode-dot" id="anki_previewModeDot" title="预览模式"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                任务/错题本视图 (重命名)               -->
            <!-- ====================================================== -->
            <div id="task-view" class="main-layout" style="display: none;">
                <div class="session-sidebar task_session-sidebar">
                    <div class="session-header">
                        <div class="session-title"><span><i class="fas fa-book-open"></i> 任务筛选与导航</span></div>
                        <div class="session-controls">
                            <select id="task_subjectFilter"></select>
                            <button id="task_refreshBtn" class="session-btn" title="刷新"><i class="fas fa-sync-alt"></i></button>
                            <button id="task_newFileBtn" class="session-btn" title="新建任务文件"><i class="fas fa-file-alt"></i></button>
                            <button id="task_loadYamlBtn" class="session-btn" title="导入YAML文件"><i class="fas fa-file-upload"></i></button>
                            <input type="file" id="task_yamlFileInput" accept=".yml,.yaml" style="display: none;">
                        </div>
                    </div>
                    <div class="session-content">
                        <div class="filter-group" data-type="tags">
                            <div class="tag-list" id="task_tagFilterContainer"></div>
                        </div>
                        <div class="filter-group" data-type="reasons">
                            <div class="tag-list" id="task_reasonFilterContainer"></div>
                        </div>
                        <div class="list-header"><i class="fas fa-list-ul"></i> 待待办列表</div>
                        <ul class="session-list" id="task_list"></ul>
                        <div class="pagination" id="task_paginationContainer"></div>
                    </div>
                </div>

                <div class="app-container">
                    <div id="task_statsDashboard" class="stats-dashboard-inline"></div>
                    <div id="task_editorPanel" class="panel editor-panel">
                        <div class="panel-header">
                            <div class="panel-actions-leading">
                                <button id="task_toggleSessionBtn" class="panel-btn" title="显示/隐藏筛选栏"><i class="fas fa-bars"></i></button>
                            </div>
                            <div class="panel-title"><i class="fas fa-code"></i> YAML 编辑器</div>
                            <div class="panel-actions">
                                <button id="task_saveBtn" class="panel-btn" title="保存并刷新"><i class="fas fa-save"></i></button>
                                <button id="task_exportBtn" class="panel-btn" title="导出YAML"><i class="fas fa-download"></i></button>
                                <button id="task_collapseBtn" class="panel-btn collapse-btn" title="收起/展开"><i class="fas fa-chevron-up"></i></button>
                            </div>
                        </div>
                        <div class="panel-content"><textarea id="task_yamlEditor"></textarea></div>
                    </div>
                    <div id="task_previewPanel" class="panel preview-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-eye"></i> 任务预览</div>
                            <div class="panel-actions">
                                <div class="review-btn-group">
                                    <button id="task_startReviewBtn" class="panel-btn panel-btn-text"><i class="fas fa-play-circle"></i> 开始待办</button>
                                </div>
                            </div>
                        </div>
                        <div class="panel-content"><div id="task_previewContainer"></div></div>
                    </div>
                </div>
            </div>
            
            <!-- ====================================================== -->
            <!--                  AI Agent 视图                       -->
            <!-- ====================================================== -->
            <div id="agent-view" class="main-layout" style="display: none;">
                <div class="topics-panel agent_topics-panel">
                    <div class="topics-header">
                        <div class="header-title-group"><i class="fas fa-book"></i> 聊天主题</div>
                        <div class="header-actions-group">
                            <select id="agent_topicTagFilter" class="topic-filter-select"></select>
                            <button id="agent_editTopicBtn" class="topic-action-btn" title="重命名"><i class="fas fa-pencil-alt"></i></button>
                            <button id="agent_manageTopicsBtn" class="topic-action-btn" title="管理"><i class="fas fa-tasks"></i></button>
                        </div>
                    </div>
                    <div class="topics-batch-actions" id="agent_topicsBatchActions" style="display: none;">
                        <button id="agent_selectAllTopicsBtn" class="batch-action-btn">全选</button>
                        <button id="agent_deleteSelectedTopicsBtn" class="batch-action-btn danger">删除</button>
                        <button id="agent_cancelTopicSelectionBtn" class="batch-action-btn">取消</button>
                    </div>
                    <div class="topics-content"><ul class="topic-list" id="agent_topicList"></ul></div>
                </div>

                <div class="history-panel agent_history-panel">
                    <div class="history-header">
                        <div class="history-title">
                            <button id="agent_toggleTopicsBtn" class="panel-btn"><i class="fas fa-bars"></i></button>
                            <i class="fas fa-comments"></i>
                            <span id="agent_historyHeaderTitle">对话记录</span>
                        </div>
                        <div class="history-header-actions">
                            <input type="text" id="agent_historySearch" class="history-search" placeholder="搜索...">
                            <select id="agent_conversationRoleSelector" class="role-selector"></select>
                        </div>
                    </div>
                    <div class="history-content" id="agent_historyContent"></div>
                    <div class="chat-navigation">
                        <button id="agent_chatNavUp" class="chat-nav-btn"><i class="fas fa-arrow-up"></i></button>
                        <button id="agent_chatNavDown" class="chat-nav-btn"><i class="fas fa-arrow-down"></i></button>
                    </div>
                    <div class="chat-input-area" id="agent_chatInputArea">
                        <div class="attachment-preview-container" id="agent_attachmentPreview"></div>
                        <div class="input-controls">
                            <textarea id="agent_chatInput" class="chat-textarea"></textarea>
                            <input type="file" id="agent_attachmentInput" multiple style="display: none;">
                            <button id="agent_attachFileBtn" class="chat-action-btn"><i class="fas fa-paperclip"></i></button>
                            <button id="agent_sendMessageBtn" class="chat-action-btn send"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!--                  设置视图                           -->
            <!-- ====================================================== -->
            <div id="settings-view" class="main-layout" style="display: none;">
                <!-- 内容由JS动态填充 -->
            </div>

        </div> <!-- .content-wrapper 结束 -->
    </div> <!-- .main-content 结束 -->

    <!-- ====================================================== -->
    <!--                  全局模态框与模板                      -->
    <!-- ====================================================== -->

    <!-- Anki 模块的音频播放器 -->
    <div class="audio-controls" id="anki_audioControls">
        <div class="audio-title" id="anki_audioTitle"></div>
        <div class="audio-progress"><div class="audio-progress-bar" id="anki_audioProgressBar"></div></div>
        <div class="audio-buttons">
            <button id="anki_playBtn" class="audio-btn"><i class="fas fa-play"></i> 播放</button>
            <button id="anki_pauseBtn" class="audio-btn"><i class="fas fa-pause"></i> 暂停</button>
            <button id="anki_stopBtn" class="audio-btn"><i class="fas fa-stop"></i> 停止</button>
        </div>
    </div>
    
	<input type="file" id="anki_fileInput" style="display: none;" accept=".md, .txt" multiple>

    <!-- Anki 模块的移动文件模态框 -->
    <div class="move-modal" id="anki_moveModal">
        <div class="move-modal-content">
            <div class="move-modal-header">
                <div class="move-modal-title">移动到目录</div>
                <button class="move-modal-close" id="anki_closeMoveModalBtn">×</button>
            </div>
            <p>选择目标目录：</p>
            <div class="folder-list" id="anki_folderList"></div>
            <div class="move-modal-actions">
                <button class="move-modal-btn cancel" id="anki_cancelMoveBtn">取消</button>
                <button class="move-modal-btn confirm" id="anki_confirmMoveBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- Anki 模块的自定义待办模态框 -->
    <div class="modal-overlay" id="anki_customStudyModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>自定义待办</h2>
                <button class="modal-close" id="anki_customStudyCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <form id="anki_customStudyForm">
                    <!-- [MODIFIED] 添加 name 属性 -->
                    <div class="form-group">
                        <label for="anki_filterByFile">按文件/目录筛选:</label>
                        <select id="anki_filterByFile" name="anki_filterByFile" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>按卡片状态筛选:</label>
                        <div class="form-checkbox-group">
                            <label><input type="checkbox" name="cardState" value="new" checked> 新卡片</label>
                            <label><input type="checkbox" name="cardState" value="learning" checked> 学习中</label>
                            <label><input type="checkbox" name="cardState" value="review" checked> 待办中</label>
                            <!-- [恢复] 增加了 "重学中" 选项 -->
                            <label><input type="checkbox" name="cardState" value="relearning" checked> 重学中</label>
                        </div>
                    </div>
                    <!-- [恢复] 增加了 "按最后一次待办时间筛选" 的完整功能块 -->
                    <div class="form-group">
                        <label for="anki_filterByLastReview">按最后一次待办时间筛选:</label>
                        <select id="anki_filterByLastReview" name="anki_filterByLastReview" class="form-control">
                            <option value="any">任何时间</option>
                            <option value="last7days">最近7天内</option>
                            <option value="last30days">最近30天内</option>
                            <option value="over30days">超过30天未待办</option>
                            <option value="never">从未待办过 (新卡片)</option>
                        </select>
                    </div>
                    <!-- [MODIFIED] 添加 name 属性 -->
                    <div class="form-group">
                        <label for="anki_maxCards">最大卡片数量:</label>
                        <input type="number" id="anki_maxCards" name="anki_maxCards" class="form-control" value="50" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="anki_customStudyCancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="anki_startCustomStudyBtn" form="anki_customStudyForm">开始</button>
            </div>
        </div>
    </div>

    <!-- Anki 模块的统计模态框 -->
    <div class="modal-overlay" id="anki_statsModal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header"><h2>待办统计</h2><button class="modal-close" id="anki_statsModalCloseBtn">×</button></div>
            <div class="modal-body"><p>近30天每日待办卡片数量</p><div class="chart-container"><canvas id="anki_statsChart"></canvas></div></div>
        </div>
    </div>
    
    <!-- 设置模块使用的模板 -->
    <template id="settings_layoutTemplate">
        <div class="settings-nav-panel">
            <div class="settings-nav-header"><h3><i class="fas fa-sliders-h"></i> 设置</h3></div>
            <div class="settings-nav-list" id="settings_navList"></div>
        </div>
        <div class="settings-detail-panel">
            <div class="panel" style="height: 100%;">
                <div class="panel-header">
                    <div id="settings_detailTitle" class="panel-title"></div>
                    <div class="panel-actions"><button id="settings_saveBtn" class="panel-btn panel-btn-text" style="display: none;"><i class="fas fa-save"></i> 保存</button></div>
                </div>
                <div id="settings_detailContent" class="panel-content" style="padding: 25px; overflow-y: auto;">
                     <div class="placeholder-content"><i class="fas fa-cogs fa-3x"></i><p>从左侧选择一个项目进行配置</p></div>
                </div>
            </div>
        </div>
    </template>

    <template id="settings_generalFormTemplate">
        <div data-id="general" data-type="general">
            <div class="settings-section">
                <h3 class="settings-section-title">外观与主题</h3>
                <div class="form-group"><label for="settings_themeSelector">选择主题</label><select id="settings_themeSelector" class="form-control">
                    <option value="">默认 (亮色)</option><option value="dark">暗黑</option><option value="large-font">大号字体</option><option value="larger-font">更大号字体</option>
                </select></div>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">数据与同步</h3>
                <div class="form-group"><label for="settings_autosaveInterval">自动保存间隔 (分钟)</label><input type="number" id="settings_autosaveInterval" class="form-control" min="0"></div>
                <div class="form-group"><label>数据库同步</label><div style="display: flex; gap: 15px;">
                    <button id="settings_exportDbBtn" class="btn-secondary"><i class="fas fa-download"></i> 导出数据</button>
                    <button id="settings_importDbBtn" class="btn-danger"><i class="fas fa-upload"></i> 导入数据</button>
                </div><input type="file" id="settings_importFileInput" accept=".json" style="display: none;"></div>
            </div>
        </div>
    </template>

    <template id="settings_apiConfigFormTemplate">
        <div data-type="apiConfig">
            <form id="settings_apiConfigFormDynamic" novalidate>
                <input type="hidden" class="config-id"><div class="form-group"><label>配置名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>提供商</label><select class="config-provider form-control" required></select></div>
                <div class="form-group"><label>API 地址</label><input type="url" class="config-apiUrl form-control"></div>
                <div class="form-group"><label>API Key</label><div class="input-group">
                    <input type="password" class="config-apiKey form-control"><button type="button" class="toggle-api-key-visibility input-group-btn"><i class="fas fa-eye"></i></button>
                </div></div>
                <div class="form-group"><label>Models (别名:模型名)</label><textarea class="config-models form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此配置</button></div>
            </form>
        </div>
    </template>

    <template id="settings_agentFormTemplate">
        <div data-type="agent">
            <form id="settings_agentFormDynamic" novalidate>
                <input type="hidden" class="config-id"><div class="form-group"><label>角色名称</label><input type="text" class="config-name form-control" required></div>
                <div class="form-group"><label>头像 (2字符)</label><input type="text" class="config-avatar form-control" required maxlength="2"></div>
                <div class="form-group"><label>选择模型</label><select class="config-model form-control" required></select></div>
                <div class="form-group"><label>System Prompt</label><textarea class="config-systemPrompt form-control" rows="8"></textarea></div>
                <div class="form-group"><label>标签</label><div class="tags-input-container"><ul class="tags-list"></ul><input type="text" class="config-tags-input form-control"></div></div>
                <div class="form-group"><label class="form-checkbox-label"><input type="checkbox" class="config-sendHistory"> 发送历史上下文</label></div>
                <div class="form-group"><label>欢迎语 (可选)</label><textarea class="config-hint form-control" rows="3"></textarea></div>
                <div class="settings-detail-footer"><button type="button" class="btn-danger delete-item-btn">删除此角色</button></div>
            </form>
        </div>
    </template>
    <div class="footer">
        <p>© 2024 智能学习套件 | 数据保存在浏览器本地存储中</p>
    </div>

    <script type="module" src="./main.js"></script>
</body>
</html>
